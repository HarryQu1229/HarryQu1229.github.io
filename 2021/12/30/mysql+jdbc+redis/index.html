<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Mysql + JDBC + Redis | Harry Blog</title><meta name="keywords" content="fundamental,databases,mysql,jdbc,redis"><meta name="author" content="Harry Qu"><meta name="copyright" content="Harry Qu"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="# MySQL # 简介 # 数据库 数据库：DataBase，简称 DB，存储和管理数据的仓库 数据库的优势：  可以持久化存储数据 方便存储和管理数据 使用了统一的方式操作数据库 SQL  数据库、数据表、数据的关系介绍：   数据库  用于存储和管理数据的仓库 一个库中可以包含多个数据表    数据表  数据库最重要的组成部分之一 由纵向的列和横向的行组成（类似 excel 表格） 可以指定">
<meta property="og:type" content="article">
<meta property="og:title" content="Mysql + JDBC + Redis">
<meta property="og:url" content="https://harryqu1229.github.io/2021/12/30/mysql+jdbc+redis/index.html">
<meta property="og:site_name" content="Harry Blog">
<meta property="og:description" content="# MySQL # 简介 # 数据库 数据库：DataBase，简称 DB，存储和管理数据的仓库 数据库的优势：  可以持久化存储数据 方便存储和管理数据 使用了统一的方式操作数据库 SQL  数据库、数据表、数据的关系介绍：   数据库  用于存储和管理数据的仓库 一个库中可以包含多个数据表    数据表  数据库最重要的组成部分之一 由纵向的列和横向的行组成（类似 excel 表格） 可以指定">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://harryqu1229.github.io/img/default-covers/statue.jpg">
<meta property="article:published_time" content="2021-12-29T11:00:00.000Z">
<meta property="article:modified_time" content="2022-06-12T01:12:26.094Z">
<meta property="article:author" content="Harry Qu">
<meta property="article:tag" content="jdbc">
<meta property="article:tag" content="fundamental">
<meta property="article:tag" content="databases">
<meta property="article:tag" content="mysql">
<meta property="article:tag" content="redis">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://harryqu1229.github.io/img/default-covers/statue.jpg"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://harryqu1229.github.io/2021/12/30/mysql+jdbc+redis/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: undefined,
  noticeOutdate: {"limitDay":100,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"prismjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"Traditional Chinese Activated Manually","cht_to_chs":"Simplified Chinese Activated Manually","day_to_night":"Dark Mode Activated Manually","night_to_day":"Light Mode Activated Manually","bgLight":"#C78550","bgDark":"#c08eaf","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Mysql + JDBC + Redis',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-06-12 13:12:26'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><style type="text/css">.aplayer.aplayer-fixed.aplayer-narrow .aplayer-body{left:-66px!important}.aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover{left:0!important}</style><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-footer-beautify@1.0.0/lib/runtime.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.css" media="print" onload="this.media='all'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">Loading...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/avatar.jpeg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">158</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">84</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">57</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-graduation-cap"></i><span> Journey</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> Hobbies</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/Music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/Photos/"><i class="fa-fw fas fa-images"></i><span> Photos</span></a></li><li><a class="site-page child" href="/Movies/"><i class="fa-fw fas fa-video"></i><span> Movies</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Links</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://d1.awsstatic.com/asset-repository/products/amazon-rds/1024px-MySQL.ff87215b43fd7292af172e2a5d9b844217262571.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Harry Blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-graduation-cap"></i><span> Journey</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> Hobbies</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/Music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/Photos/"><i class="fa-fw fas fa-images"></i><span> Photos</span></a></li><li><a class="site-page child" href="/Movies/"><i class="fa-fw fas fa-video"></i><span> Movies</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Links</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Mysql + JDBC + Redis</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2021-12-29T11:00:00.000Z" title="Created 2021-12-30 00:00:00">2021-12-30</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2022-06-12T01:12:26.094Z" title="Updated 2022-06-12 13:12:26">2022-06-12</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Backend/">Backend</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Backend/databases/">databases</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word count:</span><span class="word-count">91.9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading time:</span><span>313min</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Mysql + JDBC + Redis"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id=""><a class="markdownIt-Anchor" href="#">#</a> <a href="#mysql"></a>MySQL</h1>
<h2 id="-2"><a class="markdownIt-Anchor" href="#-2">#</a> <a href="#%E7%AE%80%E4%BB%8B"></a>简介</h2>
<h3 id="-3"><a class="markdownIt-Anchor" href="#-3">#</a> <a href="#%E6%95%B0%E6%8D%AE%E5%BA%93"></a>数据库</h3>
<p>数据库：DataBase，简称 DB，存储和管理数据的仓库</p>
<p>数据库的优势：</p>
<ul>
<li>可以持久化存储数据</li>
<li>方便存储和管理数据</li>
<li>使用了统一的方式操作数据库 SQL</li>
</ul>
<p>数据库、数据表、数据的关系介绍：</p>
<ul>
<li>
<p>数据库</p>
<ul>
<li>用于存储和管理数据的仓库</li>
<li>一个库中可以包含多个数据表</li>
</ul>
</li>
<li>
<p>数据表</p>
<ul>
<li>数据库最重要的组成部分之一</li>
<li>由纵向的列和横向的行组成（类似 excel 表格）</li>
<li>可以指定列名、数据类型、约束等</li>
<li>一个表中可以存储多条数据</li>
</ul>
</li>
<li>
<p>数据：想要永久化存储的数据</p>
</li>
</ul>
<p>参考视频：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1zJ411M7TB">https://www.bilibili.com/video/BV1zJ411M7TB</a></p>
<p>参考文章：<a target="_blank" rel="noopener" href="https://time.geekbang.org/column/intro/139">https://time.geekbang.org/column/intro/139</a></p>
<p>参考书籍：<a target="_blank" rel="noopener" href="https://book.douban.com/subject/35231266/">https://book.douban.com/subject/35231266/</a></p>
<hr>
<h3 id="-4"><a class="markdownIt-Anchor" href="#-4">#</a> <a href="#mysql-1"></a>MySQL</h3>
<p>MySQL 数据库是一个最流行的关系型数据库管理系统之一</p>
<p>关系型数据库是将数据保存在不同的数据表中，而且表与表之间可以有关联关系，提高了灵活性。</p>
<p>缺点：数据存储在磁盘中，导致读写性能差，而且数据关系复杂，扩展性差</p>
<p>MySQL 所使用的 SQL 语句是用于访问数据库最常用的标准化语言。</p>
<p>MySQL 配置：</p>
<ul>
<li>
<p>MySQL 安装：<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/ba48f1e386f0">https://www.jianshu.com/p/ba48f1e386f0</a></p>
</li>
<li>
<p>MySQL 配置：</p>
<ul>
<li>
<p>修改 MySQL 默认字符集：安装 MySQL 之后第一件事就是修改字符集编码</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">vim <span class="token operator">/</span>etc<span class="token operator">/</span>mysql<span class="token operator">/</span>my<span class="token punctuation">.</span>cnf

添加如下内容：
<span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>
<span class="token keyword">character</span><span class="token operator">-</span><span class="token keyword">set</span><span class="token operator">-</span>server<span class="token operator">=</span>utf8
collation<span class="token operator">-</span>server<span class="token operator">=</span>utf8_general_ci

<span class="token punctuation">[</span>client<span class="token punctuation">]</span>
<span class="token keyword">default</span><span class="token operator">-</span><span class="token keyword">character</span><span class="token operator">-</span><span class="token keyword">set</span><span class="token operator">=</span>utf8<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>启动 MySQL 服务：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">systemctl start/restart mysql<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>登录 MySQL：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">mysql -u root -p  敲回车，输入密码
初始密码查看：cat /var/log/mysqld.log
在root@localhost:   后面的就是初始密码<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>查看默认字符集命令：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SHOW</span> VARIABLES <span class="token operator">LIKE</span> <span class="token string">'char%'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>修改 MySQL 登录密码：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">set</span> <span class="token keyword">global</span> validate_password_policy<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">set</span> <span class="token keyword">global</span> validate_password_length<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
  
<span class="token keyword">set</span> password<span class="token operator">=</span>password<span class="token punctuation">(</span><span class="token string">'密码'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>授予远程连接权限（MySQL 内输入）：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 授权</span>
<span class="token keyword">grant</span> <span class="token keyword">all</span> <span class="token keyword">privileges</span> <span class="token keyword">on</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">to</span> <span class="token string">'root'</span> <span class="token variable">@'%'</span> identified <span class="token keyword">by</span> <span class="token string">'密码'</span><span class="token punctuation">;</span>
<span class="token comment">-- 刷新</span>
flush <span class="token keyword">privileges</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
</li>
<li>
<p>修改 MySQL 绑定 IP：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token builtin class-name">cd</span> /etc/mysql/mysql.conf.d
<span class="token function">sudo</span> <span class="token function">chmod</span> <span class="token number">666</span> mysqld.cnf 
<span class="token function">vim</span> mysqld.cnf 
<span class="token comment">#bind-address = 127.0.0.1注释该行</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>关闭 Linux 防火墙</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">systemctl stop firewalld.service
放行3306端口<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
</ul>
<hr>
<h3 id="-5"><a class="markdownIt-Anchor" href="#-5">#</a> <a href="#%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7"></a>常用工具</h3>
<h4 id="-6"><a class="markdownIt-Anchor" href="#-6">#</a> <a href="#mysql-2"></a>mysql</h4>
<p>mysql 不是指 mysql 服务，而是指 mysql 的客户端工具</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">mysql <span class="token punctuation">[</span>options<span class="token punctuation">]</span> <span class="token punctuation">[</span>database<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>-u --user=name：指定用户名</li>
<li>-p --password [=name]：指定密码</li>
<li>-h --host=name：指定服务器 IP 或域名</li>
<li>-P --port=#：指定连接端口</li>
<li>-e --execute=name：执行 SQL 语句并退出，在控制台执行 SQL 语句，而不用连接到数据库执行</li>
</ul>
<p>示例：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">mysql -h <span class="token number">127.0</span>.0.1 -P <span class="token number">3306</span> -u root -p
mysql -uroot -p2143 db01 -e <span class="token string">"select * from tb_book"</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<hr>
<h4 id="-7"><a class="markdownIt-Anchor" href="#-7">#</a> <a href="#admin"></a>admin</h4>
<p>mysqladmin 是一个执行管理操作的客户端程序，用来检查服务器的配置和当前状态、创建并删除数据库等</p>
<p>通过  <code>mysqladmin --help</code>  指令查看帮助文档</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">mysqladmin -uroot -p2143 create <span class="token string">'test01'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<hr>
<h4 id="-8"><a class="markdownIt-Anchor" href="#-8">#</a> <a href="#binlog"></a>binlog</h4>
<p>服务器生成的日志文件以二进制格式保存，如果需要检查这些文本，就要使用 mysqlbinlog 日志管理工具</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">mysqlbinlog <span class="token punctuation">[</span>options<span class="token punctuation">]</span>  log-files1 log-files2 <span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>
<p>-d --database=name：指定数据库名称，只列出指定的数据库相关操作</p>
</li>
<li>
<p>-o --offset=#：忽略掉日志中的前 n 行命令。</p>
</li>
<li>
<p>-r --result-file=name：将输出的文本格式日志输出到指定文件。</p>
</li>
<li>
<p>-s --short-form：显示简单格式， 省略掉一些信息。</p>
</li>
<li>
<p>–start-datatime=date1 --stop-datetime=date2：指定日期间隔内的所有日志。</p>
</li>
<li>
<p>–start-position=pos1 --stop-position=pos2：指定位置间隔内的所有日志。</p>
</li>
</ul>
<hr>
<h4 id="-9"><a class="markdownIt-Anchor" href="#-9">#</a> <a href="#dump"></a>dump</h4>
<h5 id="-10"><a class="markdownIt-Anchor" href="#-10">#</a> <a href="#%E5%91%BD%E4%BB%A4%E4%BB%8B%E7%BB%8D"></a>命令介绍</h5>
<p>mysqldump 客户端工具用来备份数据库或在不同数据库之间进行数据迁移，备份内容包含创建表，及插入表的 SQL 语句</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">mysqldump <span class="token punctuation">[</span>options<span class="token punctuation">]</span> db_name <span class="token punctuation">[</span>tables<span class="token punctuation">]</span>
mysqldump <span class="token punctuation">[</span>options<span class="token punctuation">]</span> --database/-B db1 <span class="token punctuation">[</span>db2 db3<span class="token punctuation">..</span>.<span class="token punctuation">]</span>
mysqldump <span class="token punctuation">[</span>options<span class="token punctuation">]</span> --all-databases/-A<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>连接选项：</p>
<ul>
<li>-u --user=name：指定用户名</li>
<li>-p --password [=name]：指定密码</li>
<li>-h --host=name：指定服务器 IP 或域名</li>
<li>-P --port=#：指定连接端口</li>
</ul>
<p>输出内容选项：</p>
<ul>
<li>–add-drop-database：在每个数据库创建语句前加上 Drop database 语句</li>
<li>–add-drop-table：在每个表创建语句前加上 Drop table 语句，默认开启；不开启 (–skip-add-drop-table)</li>
<li>-n --no-create-db：不包含数据库的创建语句</li>
<li>-t --no-create-info：不包含数据表的创建语句</li>
<li>-d --no-data：不包含数据</li>
<li>-T, --tab=name：自动生成两个文件：一个.sql 文件，创建表结构的语句；一个.txt 文件，数据文件，相当于 select into outfile</li>
</ul>
<p>示例：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">mysqldump -uroot -p2143 db01 tb_book --add-drop-database --add-drop-table <span class="token operator">></span> a
mysqldump -uroot -p2143 -T /tmp <span class="token builtin class-name">test</span> city<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<hr>
<h5 id="-11"><a class="markdownIt-Anchor" href="#-11">#</a> <a href="#%E6%95%B0%E6%8D%AE%E5%A4%87%E4%BB%BD"></a>数据备份</h5>
<p>命令行方式：</p>
<ul>
<li>
<p>备份命令：mysqldump -u root -p 数据库名称 &gt; 文件保存路径</p>
</li>
<li>
<p>恢复</p>
<ol>
<li>登录 MySQL 数据库： <code>mysql -u root p</code></li>
<li>删除已经备份的数据库</li>
<li>重新创建与备份数据库名称相同的数据库</li>
<li>使用该数据库</li>
<li>导入文件执行： <code>source 备份文件全路径</code></li>
</ol>
</li>
</ul>
<p>图形化界面：</p>
<ul>
<li>
<p>备份</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f2545352539422542452545352542442541322545352538432539362545372539352538432545392539442541322545352541342538372545342542422542442e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/56c4abc1d416daa28b6b9c0eb694ef969ed10e852bbaa4694701521df634a155/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f2545352539422542452545352542442541322545352538432539362545372539352538432545392539442541322545352541342538372545342542422542442e706e67">https://camo.githubusercontent.com/56c4abc1d416daa28b6b9c0eb694ef969ed10e852bbaa4694701521df634a155/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f2545352539422542452545352542442541322545352538432539362545372539352538432545392539442541322545352541342538372545342542422542442e706e67</a>)</p>
</li>
<li>
<p>恢复</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/d9535e84a78b6fbeebd6b99bf52ef1182b891ecfc2cfe3a0c10ff7ec047b0032/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f2545352539422542452545352542442541322545352538432539362545372539352538432545392539442541322545362538312541322545352541342538442e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/d9535e84a78b6fbeebd6b99bf52ef1182b891ecfc2cfe3a0c10ff7ec047b0032/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f2545352539422542452545352542442541322545352538432539362545372539352538432545392539442541322545362538312541322545352541342538442e706e67">https://camo.githubusercontent.com/d9535e84a78b6fbeebd6b99bf52ef1182b891ecfc2cfe3a0c10ff7ec047b0032/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f2545352539422542452545352542442541322545352538432539362545372539352538432545392539442541322545362538312541322545352541342538442e706e67</a>)</p>
</li>
</ul>
<hr>
<h4 id="-12"><a class="markdownIt-Anchor" href="#-12">#</a> <a href="#import"></a>import</h4>
<p>mysqlimport 是客户端数据导入工具，用来导入 mysqldump 加 -T 参数后导出的文本文件</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">mysqlimport <span class="token punctuation">[</span>options<span class="token punctuation">]</span>  db_name  textfile1  <span class="token punctuation">[</span>textfile2<span class="token punctuation">..</span>.<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>示例：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">mysqlimport -uroot -p2143 <span class="token builtin class-name">test</span> /tmp/city.txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>导入 sql 文件，可以使用 MySQL 中的 source 指令 :</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">source 文件全路径<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<hr>
<h4 id="-13"><a class="markdownIt-Anchor" href="#-13">#</a> <a href="#show"></a>show</h4>
<p>mysqlshow 客户端对象查找工具，用来很快地查找存在哪些数据库、数据库中的表、表中的列或者索引</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">mysqlshow <span class="token punctuation">[</span>options<span class="token punctuation">]</span> <span class="token punctuation">[</span>db_name <span class="token punctuation">[</span>table_name <span class="token punctuation">[</span>col_name<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>
<p>–count：显示数据库及表的统计信息（数据库，表 均可以不指定）</p>
</li>
<li>
<p>-i：显示指定数据库或者指定表的状态信息</p>
</li>
</ul>
<p>示例：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token comment">#查询每个数据库的表的数量及表中记录的数量</span>
mysqlshow -uroot -p1234 --count
<span class="token comment">#查询test库中每个表中的字段书，及行数</span>
mysqlshow -uroot -p1234 <span class="token builtin class-name">test</span> --count
<span class="token comment">#查询test库中book表的详细情况</span>
mysqlshow -uroot -p1234 <span class="token builtin class-name">test</span> book --count<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<h2 id="-14"><a class="markdownIt-Anchor" href="#-14">#</a> <a href="#%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84"></a>体系结构</h2>
<h3 id="-15"><a class="markdownIt-Anchor" href="#-15">#</a> <a href="#%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84"></a>整体架构</h3>
<p>体系结构详解：</p>
<ul>
<li>
<p>第一层：网络连接层</p>
<ul>
<li>一些客户端和链接服务，包含本地 socket 通信和大多数基于客户端 / 服务端工具实现的 TCP/IP 通信，主要完成一些类似于连接处理、授权认证、及相关的安全方案</li>
<li>在该层上引入了连接池 Connection Pool 的概念，管理缓冲用户连接，线程处理等需要缓存的需求</li>
<li>在该层上实现基于 SSL 的安全链接，服务器也会为安全接入的每个客户端验证它所具有的操作权限</li>
</ul>
</li>
<li>
<p>第二层：核心服务层</p>
<ul>
<li>查询缓存、分析器、优化器、执行器等，涵盖 MySQL 的大多数核心服务功能，所有的内置函数（日期、数学、加密函数等）
<ul>
<li>Management Serveices &amp; Utilities：系统管理和控制工具，备份、安全、复制、集群等</li>
<li>SQL Interface：接受用户的 SQL 命令，并且返回用户需要查询的结果</li>
<li>Parser：SQL 语句分析器</li>
<li>Optimizer：查询优化器</li>
<li>Caches &amp; Buffers：查询缓存，服务器会查询内部的缓存，如果缓存空间足够大，可以在大量读操作的环境中提升系统性能</li>
</ul>
</li>
<li>所有<strong>跨存储引擎的功能</strong>在这一层实现，如存储过程、触发器、视图等</li>
<li>在该层服务器会解析查询并创建相应的内部解析树，并对其完成相应的优化如确定表的查询顺序，是否利用索引等， 最后生成相应的执行操作</li>
<li>MySQL 中服务器层不管理事务，<strong>事务是由存储引擎实现的</strong></li>
</ul>
</li>
<li>
<p>第三层：存储引擎层</p>
<ul>
<li>Pluggable Storage Engines：存储引擎接口，MySQL 区别于其他数据库的重要特点就是其存储引擎的架构模式是插件式的（存储引擎是基于表的，而不是数据库）</li>
<li>存储引擎<strong>真正的负责了 MySQL 中数据的存储和提取</strong>，服务器通过 API 和存储引擎进行通信</li>
<li>不同的存储引擎具有不同的功能，共用一个 Server 层，可以根据开发的需要，来选取合适的存储引擎</li>
</ul>
</li>
<li>
<p>第四层：系统文件层</p>
<ul>
<li>数据存储层，主要是将数据存储在文件系统之上，并完成与存储引擎的交互</li>
<li>File System：文件系统，保存配置文件、数据文件、日志文件、错误文件、二进制文件等</li>
</ul>
</li>
</ul>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d2545342542442539332545372542332542422545372542422539332545362539452538342e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/93aabda30ab5b39590708fd4ccd7aeaa27077808ac631d2a439dfa74bbb4bd66/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d2545342542442539332545372542332542422545372542422539332545362539452538342e706e67">https://camo.githubusercontent.com/93aabda30ab5b39590708fd4ccd7aeaa27077808ac631d2a439dfa74bbb4bd66/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d2545342542442539332545372542332542422545372542422539332545362539452538342e706e67</a>)</p>
<hr>
<h3 id="-16"><a class="markdownIt-Anchor" href="#-16">#</a> <a href="#%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"></a>执行流程</h3>
<h4 id="-17"><a class="markdownIt-Anchor" href="#-17">#</a> <a href="#%E8%BF%9E%E6%8E%A5%E5%99%A8"></a>连接器</h4>
<h5 id="-18"><a class="markdownIt-Anchor" href="#-18">#</a> <a href="#%E8%BF%9E%E6%8E%A5%E5%8E%9F%E7%90%86"></a>连接原理</h5>
<p>池化技术：对于访问数据库来说，建立连接的代价是比较昂贵的，因为每个连接对应一个用来交互的线程，频繁的创建关闭连接比较耗费资源，有必要建立数据库连接池，以提高访问的性能</p>
<p>连接建立 TCP 以后需要做<strong>权限验证</strong>，验证成功后可以进行执行 SQL。如果这时管理员账号对这个用户的权限做了修改，也不会影响已经存在连接的权限，只有再新建的连接才会使用新的权限设置</p>
<p>客户端如果长时间没有操作，连接器就会自动断开，时间是由参数 wait_timeout 控制的，默认值是 8 小时。如果在连接被断开之后，客户端再次发送请求的话，就会收到一个错误提醒： <code>Lost connection to MySQL server during query</code></p>
<p>数据库里面，长连接是指连接成功后，如果客户端持续有请求，则一直使用同一个连接；短连接则是指每次执行完很少的几次查询就断开连接，下次查询再重新建立一个。为了减少连接的创建，推荐使用长连接，但是过多的长连接会造成 OOM，解决方案：</p>
<ul>
<li>定期断开长连接，使用一段时间，或者程序里面判断执行过一个占用内存的大查询后，断开连接，之后要查询再重连。</li>
<li>MySQL 5.7 版本，可以在每次执行一个比较大的操作后，通过执行 mysql_reset_connection 来重新初始化连接资源，这个过程不需要重连和重新做权限验证，但是会将连接恢复到刚刚创建完时的状态</li>
</ul>
<p>MySQL 服务器可以同时和多个客户端进行交互，所以要保证每个连接会话的隔离性（事务机制部分详解）</p>
<p>整体的执行流程：</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d53514ce79a84e689a7e8a18ce6b581e7a88b2e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/3747177b905b62af7150caab01520f81e579e64dadcb16f9246b8dc9fdbef48f/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d53514ce79a84e689a7e8a18ce6b581e7a88b2e706e67">https://camo.githubusercontent.com/3747177b905b62af7150caab01520f81e579e64dadcb16f9246b8dc9fdbef48f/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d53514ce79a84e689a7e8a18ce6b581e7a88b2e706e67</a>)</p>
<hr>
<h5 id="-19"><a class="markdownIt-Anchor" href="#-19">#</a> <a href="#%E8%BF%9E%E6%8E%A5%E7%8A%B6%E6%80%81"></a>连接状态</h5>
<p>首先连接到数据库上，这时连接器发挥作用，连接完成后如果没有后续的动作，这个连接就处于空闲状态，通过指令查看连接状态</p>
<p>SHOW PROCESSLIST：查看当前 MySQL 在进行的线程，可以实时地查看 SQL 的执行情况，其中的 Command 列显示为 Sleep 的这一行，就表示现在系统里面有一个空闲连接</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d53484f575f50524f434553534c4953542545352539312542442545342542422541342e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/9236b257f069041a811b373ee2911c91e7495c02d407a80d966f7ae4c2d5cb6b/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d53484f575f50524f434553534c4953542545352539312542442545342542422541342e706e67">https://camo.githubusercontent.com/9236b257f069041a811b373ee2911c91e7495c02d407a80d966f7ae4c2d5cb6b/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d53484f575f50524f434553534c4953542545352539312542442545342542422541342e706e67</a>)</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>ID</td>
<td>用户登录 mysql 时系统分配的 connection_id，可以使用函数 connection_id () 查看</td>
</tr>
<tr>
<td>User</td>
<td>显示当前用户，如果不是 root，这个命令就只显示用户权限范围的 sql 语句</td>
</tr>
<tr>
<td>Host</td>
<td>显示这个语句是从哪个 ip 的哪个端口上发的，可以用来跟踪出现问题语句的用户</td>
</tr>
<tr>
<td>db</td>
<td>显示这个进程目前连接的是哪个数据库</td>
</tr>
<tr>
<td>Command</td>
<td>显示当前连接的执行的命令，一般取值为休眠 Sleep、查询 Query、连接 Connect 等</td>
</tr>
<tr>
<td>Time</td>
<td>显示这个状态持续的时间，单位是秒</td>
</tr>
<tr>
<td>State</td>
<td>显示使用当前连接的 sql 语句的状态，以查询为例，需要经过 copying to tmp table、sorting result、sending data 等状态才可以完成</td>
</tr>
<tr>
<td>Info</td>
<td>显示执行的 sql 语句，是判断问题语句的一个重要依据</td>
</tr>
</tbody>
</table>
<hr>
<h4 id="-20"><a class="markdownIt-Anchor" href="#-20">#</a> <a href="#%E6%9F%A5%E8%AF%A2%E7%BC%93%E5%AD%98"></a>查询缓存</h4>
<h5 id="-21"><a class="markdownIt-Anchor" href="#-21">#</a> <a href="#%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"></a>工作流程</h5>
<p>当执行完全相同的 SQL 语句的时候，服务器就会直接从缓存中读取结果，当数据被修改，之前的缓存会失效，修改比较频繁的表不适合做查询缓存</p>
<p>查询过程：</p>
<ol>
<li>客户端发送一条查询给服务器</li>
<li>服务器先会检查查询缓存，如果命中了缓存，则立即返回存储在缓存中的结果（一般是 K-V 键值对），否则进入下一阶段</li>
<li>分析器进行 SQL 分析，再由优化器生成对应的执行计划</li>
<li>MySQL 根据优化器生成的执行计划，调用存储引擎的 API 来执行查询</li>
<li>将结果返回给客户端</li>
</ol>
<p>大多数情况下不建议使用查询缓存，因为查询缓存往往弊大于利</p>
<ul>
<li>查询缓存的<strong>失效非常频繁</strong>，只要有对一个表的更新，这个表上所有的查询缓存都会被清空。因此很可能费力地把结果存起来，还没使用就被一个更新全清空了，对于更新压力大的数据库来说，查询缓存的命中率会非常低</li>
<li>除非业务就是有一张静态表，很长时间才会更新一次，比如一个系统配置表，那这张表上的查询才适合使用查询缓存</li>
</ul>
<hr>
<h5 id="-22"><a class="markdownIt-Anchor" href="#-22">#</a> <a href="#%E7%BC%93%E5%AD%98%E9%85%8D%E7%BD%AE"></a>缓存配置</h5>
<ol>
<li>
<p>查看当前的 MySQL 数据库是否支持查询缓存：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SHOW</span> VARIABLES <span class="token operator">LIKE</span> <span class="token string">'have_query_cache'</span><span class="token punctuation">;</span>	<span class="token comment">-- YES</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>查看当前 MySQL 是否开启了查询缓存：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SHOW</span> VARIABLES <span class="token operator">LIKE</span> <span class="token string">'query_cache_type'</span><span class="token punctuation">;</span>	<span class="token comment">-- OFF</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>参数说明：</p>
<ul>
<li>
<p>OFF 或 0：查询缓存功能关闭</p>
</li>
<li>
<p>ON 或 1：查询缓存功能打开，查询结果符合缓存条件即会缓存，否则不予缓存；可以显式指定 SQL_NO_CACHE 不予缓存</p>
</li>
<li>
<p>DEMAND 或 2：查询缓存功能按需进行，显式指定 SQL_CACHE 的 SELECT 语句才缓存，其它不予缓存</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> SQL_CACHE id<span class="token punctuation">,</span> name <span class="token keyword">FROM</span> customer<span class="token punctuation">;</span> <span class="token comment">-- SQL_CACHE:查询结果可缓存</span>
<span class="token keyword">SELECT</span> SQL_NO_CACHE id<span class="token punctuation">,</span> name <span class="token keyword">FROM</span> customer<span class="token punctuation">;</span><span class="token comment">-- SQL_NO_CACHE:不使用查询缓存</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
</ul>
</li>
<li>
<p>查看查询缓存的占用大小：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SHOW</span> VARIABLES <span class="token operator">LIKE</span> <span class="token string">'query_cache_size'</span><span class="token punctuation">;</span><span class="token comment">-- 单位是字节 1048576 / 1024 = 1024 = 1KB</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>查看查询缓存的状态变量：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SHOW</span> <span class="token keyword">STATUS</span> <span class="token operator">LIKE</span> <span class="token string">'Qcache%'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2de69fa5e8afa2e7bc93e5ad98e79a84e78ab6e68081e58f98e9878f2e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/a17e82de4632590203801b4cf25b6fbce6e4db049b3832fe09dd37330b892ddb/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2de69fa5e8afa2e7bc93e5ad98e79a84e78ab6e68081e58f98e9878f2e706e67">https://camo.githubusercontent.com/a17e82de4632590203801b4cf25b6fbce6e4db049b3832fe09dd37330b892ddb/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2de69fa5e8afa2e7bc93e5ad98e79a84e78ab6e68081e58f98e9878f2e706e67</a>)</p>
<table>
<thead>
<tr>
<th>数</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>cache_free_blocks</td>
<td>查询缓存中的可用内存块数</td>
</tr>
<tr>
<td>cache_free_memory</td>
<td>查询缓存的可用内存量</td>
</tr>
<tr>
<td>cache_hits</td>
<td>查询缓存命中数</td>
</tr>
<tr>
<td>cache_inserts</td>
<td>添加到查询缓存的查询数</td>
</tr>
<tr>
<td>cache_lowmen_prunes</td>
<td>由于内存不足而从查询缓存中删除的查询数</td>
</tr>
<tr>
<td>cache_not_cached</td>
<td>非缓存查询的数量（由于 query_cache_type 设置而无法缓存或未缓存）</td>
</tr>
<tr>
<td>cache_queries_in_cache</td>
<td>查询缓存中注册的查询数</td>
</tr>
<tr>
<td>cache_total_blocks</td>
<td>查询缓存中的块总数</td>
</tr>
</tbody>
</table>
</li>
<li>
<p>配置 my.cnf：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">sudo</span> <span class="token function">chmod</span> <span class="token number">666</span> /etc/mysql/my.cnf
<span class="token function">vim</span> my.cnf
<span class="token comment"># mysqld中配置缓存</span>
<span class="token assign-left variable">query_cache_type</span><span class="token operator">=</span><span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>重启服务既可生效，执行 SQL 语句进行验证 ，执行一条比较耗时的 SQL 语句，然后再多执行几次，查看后面几次的执行时间；获取通过查看查询缓存的缓存命中数，来判定是否走查询缓存</p>
</li>
</ol>
<hr>
<h5 id="-23"><a class="markdownIt-Anchor" href="#-23">#</a> <a href="#%E7%BC%93%E5%AD%98%E5%A4%B1%E6%95%88"></a>缓存失效</h5>
<p>查询缓存失效的情况：</p>
<ul>
<li>
<p>SQL 语句不一致的情况，要想命中查询缓存，查询的 SQL 语句必须一致</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> tb_item<span class="token punctuation">;</span>
<span class="token keyword">Select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> tb_item<span class="token punctuation">;</span>	<span class="token comment">-- 不走缓存，首字母不一致</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li>
<p>当查询语句中有一些不确定查询时，则不会缓存，比如：now ()、current_date ()、curdate ()、curtime ()、rand ()、uuid ()、user ()、database ()</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tb_item <span class="token keyword">WHERE</span> updatetime <span class="token operator">&lt;</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">LIMIT</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> <span class="token keyword">USER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> <span class="token keyword">DATABASE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>不使用任何表查询语句：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token string">'A'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>查询 mysql、information_schema、performance_schema 等系统表时，不走查询缓存：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> information_schema<span class="token punctuation">.</span>engines<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>在跨存储引擎的存储过程、触发器或存储函数的主体内执行的查询，缓存失效</p>
</li>
<li>
<p>如果表更改，则使用该表的所有高速缓存查询都将变为无效并从高速缓存中删除，包括使用 MERGE 映射到已更改表的表的查询，比如：INSERT、UPDATE、DELETE、ALTER TABLE、DROP TABLE、DROP DATABASE</p>
</li>
</ul>
<hr>
<h4 id="-24"><a class="markdownIt-Anchor" href="#-24">#</a> <a href="#%E5%88%86%E6%9E%90%E5%99%A8"></a>分析器</h4>
<p>没有命中查询缓存，就开始了 SQL 的真正执行，分析器会对 SQL 语句做解析</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> t <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>先做<strong>词法分析</strong>，输入的是由多个字符串和空格组成的一条 SQL 语句，MySQL 需要识别出里面的字符串分别是什么，代表什么。从输入的 select 这个关键字识别出来这是一个查询语句；把字符串 t 识别成 表名 t，把字符串 id 识别成列 id</li>
<li>然后做<strong>语法分析</strong>，根据词法分析的结果，语法分析器会根据语法规则，判断你输入的这个 SQL 语句是否满足 MySQL 语法。如果你的语句不对，就会收到  <code>You have an error in your SQL syntax</code>  的错误提醒</li>
</ul>
<hr>
<h4 id="-25"><a class="markdownIt-Anchor" href="#-25">#</a> <a href="#%E4%BC%98%E5%8C%96%E5%99%A8"></a>优化器</h4>
<h5 id="-26"><a class="markdownIt-Anchor" href="#-26">#</a> <a href="#%E6%88%90%E6%9C%AC%E5%88%86%E6%9E%90"></a>成本分析</h5>
<p>优化器是在表里面有多个索引的时候，决定使用哪个索引；或者在一个语句有多表关联（join）的时候，决定各个表的连接顺序。</p>
<ul>
<li>根据搜索条件找出所有可能的使用的索引</li>
<li>成本分析，执行成本由 I/O 成本和 CPU 成本组成，计算全表扫描和使用不同索引执行 SQL 的代价</li>
<li>找到一个最优的执行方案，用最小的代价去执行语句</li>
</ul>
<p>在数据库里面，扫描行数是影响执行代价的因素之一，扫描的行数越少意味着访问磁盘的次数越少，消耗的 CPU 资源越少，优化器还会结合是否使用临时表、是否排序等因素进行综合判断</p>
<hr>
<h5 id="-27"><a class="markdownIt-Anchor" href="#-27">#</a> <a href="#%E7%BB%9F%E8%AE%A1%E6%95%B0%E6%8D%AE"></a>统计数据</h5>
<p>MySQL 中保存着两种统计数据：</p>
<ul>
<li>innodb_table_stats 存储了表的统计数据，每一条记录对应着一个表的统计数据</li>
<li>innodb_index_stats 存储了索引的统计数据，每一条记录对应着一个索引的一个统计项的数据</li>
</ul>
<p>MySQL 在真正执行语句之前，并不能精确地知道满足条件的记录有多少条，只能根据统计信息来估算记录，统计信息就是索引的区分度，一个索引上不同的值的个数（比如性别只能是男女，就是 2 ），称之为基数（cardinality），基数越大说明区分度越好</p>
<p>通过<strong>采样统计</strong>来获取基数，InnoDB 默认会选择 N 个数据页，统计这些页面上的不同值得到一个平均值，然后乘以这个索引的页面数，就得到了这个索引的基数</p>
<p>在 MySQL 中，有两种存储统计数据的方式，可以通过设置参数  <code>innodb_stats_persistent</code>  的值来选择：</p>
<ul>
<li>ON：表示统计信息会持久化存储（默认），采样页数 N 默认为 20，可以通过  <code>innodb_stats_persistent_sample_pages</code>  指定，页数越多统计的数据越准确，但消耗的资源更大</li>
<li>设置为 off 时，表示统计信息只存储在内存，采样页数 N 默认为 8，也可以通过系统变量设置（不推荐，每次重新计算浪费资源）</li>
</ul>
<p>数据表是会持续更新的，两种更新方式：</p>
<ul>
<li>设置  <code>innodb_stats_auto_recalc</code>  为 1，当发生变动的记录数量超过表大小的 10% 时，自动触发重新计算，不过是<strong>异步进行</strong></li>
<li>调用  <code>ANALYZE TABLE t</code>  手动更新统计信息，只对信息做重新统计（不是重建表），没有修改数据，这个过程中加了 MDL 读锁并且是同步进行，所以会暂时阻塞系统</li>
</ul>
<p>EXPLAIN 执行计划在优化器阶段生成，如果 explain 的结果预估的 rows 值跟实际情况差距比较大，可以执行 analyze 命令重新修正信息</p>
<hr>
<h5 id="-28"><a class="markdownIt-Anchor" href="#-28">#</a> <a href="#%E9%94%99%E9%80%89%E7%B4%A2%E5%BC%95"></a>错选索引</h5>
<p>采样统计本身是估算数据，或者 SQL 语句中的字段选择有问题时，可能导致 MySQL 没有选择正确的执行索引</p>
<p>解决方法：</p>
<ul>
<li>
<p>采用 force index 强行选择一个索引</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">user</span> <span class="token keyword">FORCE</span> <span class="token keyword">INDEX</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token keyword">WHERE</span> NAME<span class="token operator">=</span><span class="token string">'seazean'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>可以考虑修改 SQL 语句，引导 MySQL 使用期望的索引</p>
</li>
<li>
<p>新建一个更合适的索引，来提供给优化器做选择，或删掉误用的索引</p>
</li>
</ul>
<hr>
<h4 id="-29"><a class="markdownIt-Anchor" href="#-29">#</a> <a href="#%E6%89%A7%E8%A1%8C%E5%99%A8"></a>执行器</h4>
<p>开始执行的时候，要先判断一下当前连接对表有没有执行查询的权限，如果没有就会返回没有权限的错误，在工程实现上，如果命中查询缓存，会在查询缓存返回结果的时候，做权限验证。如果有权限，就打开表继续执行，执行器就会根据表的引擎定义，去使用这个引擎提供的接口</p>
<hr>
<h3 id="-30"><a class="markdownIt-Anchor" href="#-30">#</a> <a href="#%E6%95%B0%E6%8D%AE%E7%A9%BA%E9%97%B4"></a>数据空间</h3>
<h4 id="-31"><a class="markdownIt-Anchor" href="#-31">#</a> <a href="#%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8"></a>数据存储</h4>
<p>系统表空间是用来放系统信息的，比如数据字典什么的，对应的磁盘文件是 ibdata，数据表空间是一个个的表数据文件，对应的磁盘文件就是表名.ibd</p>
<p>表数据既可以存在共享表空间里，也可以是单独的文件，这个行为是由参数 innodb_file_per_table 控制的：</p>
<ul>
<li>OFF：表示表的数据放在系统共享表空间，也就是跟数据字典放在一起</li>
<li>ON ：表示每个 InnoDB 表数据存储在一个以 .ibd 为后缀的文件中（默认）</li>
</ul>
<p>一个表单独存储为一个文件更容易管理，在不需要这个表时通过 drop table 命令，系统就会直接删除这个文件；如果是放在共享表空间中，即使表删掉了，空间也是不会回收的</p>
<hr>
<h4 id="-32"><a class="markdownIt-Anchor" href="#-32">#</a> <a href="#%E6%95%B0%E6%8D%AE%E5%88%A0%E9%99%A4"></a>数据删除</h4>
<p>MySQL 的数据删除就是移除掉某个记录后，该位置就被标记为可复用，如果有符合范围条件的数据可以插入到这里。符合范围条件的意思是假设删除记录 R4，之后要再插入一个 ID 在 300 和 600 之间的记录时，就会复用这个位置</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2de588a0e999a4e695b0e68dae2e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/758c9d721c174c3f8d97d9dc8ab40e46152c276381dc41c923d749d929ac9a8e/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2de588a0e999a4e695b0e68dae2e706e67">https://camo.githubusercontent.com/758c9d721c174c3f8d97d9dc8ab40e46152c276381dc41c923d749d929ac9a8e/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2de588a0e999a4e695b0e68dae2e706e67</a>)</p>
<p>InnoDB 的数据是按页存储的如果删掉了一个数据页上的所有记录，整个数据页就可以被复用了，如果相邻的两个数据页利用率都很小，系统就会把这两个页上的数据合到其中一个页上，另外一个数据页就被标记为可复用</p>
<p>删除命令其实只是把记录的位置，或者<strong>数据页标记为了可复用，但磁盘文件的大小是不会变的</strong>，这些可以复用还没有被使用的空间，看起来就像是空洞，造成数据库的稀疏，因此需要进行紧凑处理</p>
<hr>
<h4 id="-33"><a class="markdownIt-Anchor" href="#-33">#</a> <a href="#%E9%87%8D%E5%BB%BA%E6%95%B0%E6%8D%AE"></a>重建数据</h4>
<p>重建表就是按照主键 ID 递增的顺序，把数据一行一行地从旧表中读出来再插入到新表中，重建表时 MySQL 会自动完成转存数据、交换表名、删除旧表的操作，重建命令：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> A <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>工作流程：新建临时表 tmp_table B（在 Server 层创建的），把表 A 中的数据导入到表 B 中，操作完成后用表 B 替换表 A，完成重建</p>
<p>重建表的步骤需要 DDL 不是 Online 的，因为在导入数据的过程有新的数据要写入到表 A 的话，就会造成数据丢失</p>
<p>MySQL 5.6 版本开始引入的 Online DDL，重建表的命令默认执行此步骤：</p>
<ul>
<li>建立一个临时文件 tmp_file（InnoDB 创建），扫描表 A 主键的所有数据页</li>
<li>用数据页中表 A 的记录生成 B+ 树，存储到临时文件中</li>
<li>生成临时文件的过程中，将所有对 A 的操作记录在一个日志文件（row log）中，对应的是图中 state2 的状态</li>
<li>临时文件生成后，将日志文件中的操作应用到临时文件，得到一个逻辑数据上与表 A 相同的数据文件，对应的就是图中 state3</li>
<li>用临时文件替换表 A 的数据文件</li>
</ul>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/d3cfaee5749059e784dfd893ca0ed69a55bcd8f395d5e09445552c2ef2146aef/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2de9878de5bbbae8a1a82e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/d3cfaee5749059e784dfd893ca0ed69a55bcd8f395d5e09445552c2ef2146aef/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2de9878de5bbbae8a1a82e706e67">https://camo.githubusercontent.com/d3cfaee5749059e784dfd893ca0ed69a55bcd8f395d5e09445552c2ef2146aef/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2de9878de5bbbae8a1a82e706e67</a>)</p>
<p>Online DDL 操作会先获取 MDL 写锁，再退化成 MDL 读锁。但 MDL 写锁持有时间比较短，所以可以称为 Online； 而 MDL 读锁，不阻止数据增删查改，但会阻止其它线程修改表结构</p>
<p>问题：重建表可以收缩表空间，但是执行指令后整体占用空间增大</p>
<p>原因：在重建表后 InnoDB 不会把整张表占满，每个页留了 1/16 给后续的更新使用。表在未整理之前页已经占用 15/16 以上，收缩之后需要保持数据占用空间在 15/16，所以文件占用空间更大才能保持</p>
<p>注意：临时文件也要占用空间，如果空间不足会重建失败</p>
<hr>
<h4 id="-34"><a class="markdownIt-Anchor" href="#-34">#</a> <a href="#inplace"></a>inplace</h4>
<p>DDL 中的临时表 tmp_table 是在 Server 层创建的，Online DDL 中的临时文件 tmp_file 是 InnoDB 在内部创建出来的，整个 DDL 过程都在 InnoDB 内部完成，对于 Server 层来说，没有把数据挪动到临时表，是一个原地操作，这就是 inplace</p>
<p>两者的关系：</p>
<ul>
<li>DDL 过程如果是 Online 的，就一定是 inplace 的</li>
<li>inplace 的 DDL，有可能不是 Online 的，截止到 MySQL 8.0，全文索引（FULLTEXT）和空间索引 (SPATIAL) 属于这种情况</li>
</ul>
<p>== 本节知识是抄录自《MySQL 实战 45 讲》，作者目前没有更深的理解，暂时记录，后续有了新的认知后会更新知识 ==</p>
<p>参考文章：<a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/72388">https://time.geekbang.org/column/article/72388</a></p>
<hr>
<h2 id="-35"><a class="markdownIt-Anchor" href="#-35">#</a> <a href="#%E5%8D%95%E8%A1%A8%E6%93%8D%E4%BD%9C"></a>单表操作</h2>
<h3 id="-36"><a class="markdownIt-Anchor" href="#-36">#</a> <a href="#sql"></a>SQL</h3>
<ul>
<li>
<p>SQL</p>
<ul>
<li>Structured Query Language：结构化查询语言</li>
<li>定义了操作所有关系型数据库的规则，每种数据库操作的方式可能会存在不一样的地方，称为 “方言”</li>
</ul>
</li>
<li>
<p>SQL 通用语法</p>
<ul>
<li>SQL 语句可以单行或多行书写，以<strong>分号结尾</strong>。</li>
<li>可使用空格和缩进来增强语句的可读性。</li>
<li>MySQL 数据库的 SQL 语句不区分大小写，<strong>关键字建议使用大写</strong>。</li>
<li>数据库的注释：
<ul>
<li>单行注释：-- 注释内容 #注释内容 (mysql 特有)</li>
<li>多行注释：/* 注释内容 */</li>
</ul>
</li>
</ul>
</li>
<li>
<p>SQL 分类</p>
<ul>
<li>
<p>DDL（Data Definition Language）数据定义语言</p>
<ul>
<li>用来定义数据库对象：数据库，表，列等。关键字：create、drop,、alter 等</li>
</ul>
</li>
<li>
<p>DML（Data Manipulation Language）数据操作语言</p>
<ul>
<li>用来对数据库中表的数据进行增删改。关键字：insert、delete、update 等</li>
</ul>
</li>
<li>
<p>DQL（Data Query Language）数据查询语言</p>
<ul>
<li>用来查询数据库中表的记录 (数据)。关键字：select、where 等</li>
</ul>
</li>
<li>
<p>DCL（Data Control Language）数据控制语言</p>
<ul>
<li>用来定义数据库的访问权限和安全级别，及创建用户。关键字：grant， revoke 等</li>
</ul>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d53514c2545352538382538362545372542312542422e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/7225c2210bc00b75e6fc761d72ea06ef08552c5fe9344479d60927ff66487b57/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d53514c2545352538382538362545372542312542422e706e67">https://camo.githubusercontent.com/7225c2210bc00b75e6fc761d72ea06ef08552c5fe9344479d60927ff66487b57/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d53514c2545352538382538362545372542312542422e706e67</a>)</p>
</li>
</ul>
</li>
</ul>
<hr>
<h3 id="-37"><a class="markdownIt-Anchor" href="#-37">#</a> <a href="#ddl"></a>DDL</h3>
<h4 id="-38"><a class="markdownIt-Anchor" href="#-38">#</a> <a href="#%E6%95%B0%E6%8D%AE%E5%BA%93-1"></a>数据库</h4>
<ul>
<li>
<p>R (Retrieve)：查询</p>
<ul>
<li>
<p>查询所有数据库：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SHOW</span> <span class="token keyword">DATABASES</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>查询某个数据库的创建语句</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SHOW</span> <span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> 数据库名称<span class="token punctuation">;</span>  <span class="token comment">-- 标准语法</span>

<span class="token keyword">SHOW</span> <span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> mysql<span class="token punctuation">;</span>     <span class="token comment">-- 查看mysql数据库的创建格式</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
</li>
<li>
<p>C (Create)：创建</p>
<ul>
<li>
<p>创建数据库</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> 数据库名称<span class="token punctuation">;</span><span class="token comment">-- 标准语法</span>

<span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> db1<span class="token punctuation">;</span>     <span class="token comment">-- 创建db1数据库</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>创建数据库（判断，如果不存在则创建）</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> 数据库名称<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>创建数据库，并指定字符集</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> 数据库名称 <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> 字符集名称<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>例如：创建 db4 数据库、如果不存在则创建，指定字符集为 gbk</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 创建db4数据库、如果不存在则创建，指定字符集为gbk</span>
<span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> db4 <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> gbk<span class="token punctuation">;</span>

<span class="token comment">-- 查看db4数据库的字符集</span>
<span class="token keyword">SHOW</span> <span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> db4<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
</li>
<li>
<p>U (Update)：修改</p>
<ul>
<li>
<p>修改数据库的字符集</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">DATABASE</span> 数据库名称 <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> 字符集名称<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>常用字符集：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">--查询所有支持的字符集</span>
<span class="token keyword">SHOW</span> <span class="token keyword">CHARSET</span><span class="token punctuation">;</span>
<span class="token comment">--查看所有支持的校对规则</span>
<span class="token keyword">SHOW</span> COLLATION<span class="token punctuation">;</span>

<span class="token comment">-- 字符集: utf8,latinI,GBK,,GBK是utf8的子集</span>
<span class="token comment">-- 校对规则: ci 大小定不敏感，cs或bin大小写敏感</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
</li>
<li>
<p>D (Delete)：删除</p>
<ul>
<li>
<p>删除数据库：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">DATABASE</span> 数据库名称<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>删除数据库 (判断，如果存在则删除)：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">DATABASE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> 数据库名称<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
</li>
<li>
<p>使用数据库：</p>
<ul>
<li>
<p>查询当前正在使用的数据库名称</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token keyword">DATABASE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>使用数据库</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">USE</span> 数据库名称； <span class="token comment">-- 标准语法</span>
<span class="token keyword">USE</span> db4<span class="token punctuation">;</span>	   <span class="token comment">-- 使用db4数据库</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
</ul>
</li>
</ul>
<hr>
<h4 id="-39"><a class="markdownIt-Anchor" href="#-39">#</a> <a href="#%E6%95%B0%E6%8D%AE%E8%A1%A8"></a>数据表</h4>
<ul>
<li>
<p>R (Retrieve)：查询</p>
<ul>
<li>
<p>查询数据库中所有的数据表</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">USE</span> mysql<span class="token punctuation">;</span><span class="token comment">-- 使用mysql数据库</span>

<span class="token keyword">SHOW</span> <span class="token keyword">TABLES</span><span class="token punctuation">;</span><span class="token comment">-- 查询库中所有的表</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>查询表结构</p>
</li>
</ul>
<p>DESC 表名；</p>
<pre class="line-numbers language-none"><code class="language-none">- 查询表字符集

&#96;&#96;&#96;mysql
SHOW TABLE STATUS FROM 库名 LIKE &#39;表名&#39;;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>C (Create)：创建</p>
<ul>
<li>
<p>创建数据表</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> 表名<span class="token punctuation">(</span>
    列名<span class="token number">1</span> 数据类型<span class="token number">1</span><span class="token punctuation">,</span>
    列名<span class="token number">2</span> 数据类型<span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    列名n 数据类型n
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 注意：最后一列，不需要加逗号</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>复制表</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> 表名 <span class="token operator">LIKE</span> 被复制的表名<span class="token punctuation">;</span>  <span class="token comment">-- 标准语法</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> product2 <span class="token operator">LIKE</span> product<span class="token punctuation">;</span> <span class="token comment">-- 复制product表到product2表</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>数据类型</p>
<table>
<thead>
<tr>
<th></th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td>整数类型</td>
</tr>
<tr>
<td>LE</td>
<td>小数类型</td>
</tr>
<tr>
<td></td>
<td>日期，只包含年月日：yyyy-MM-dd</td>
</tr>
<tr>
<td>TIME</td>
<td>日期，包含年月日时分秒：yyyy-MM-dd HH:mm:ss</td>
</tr>
<tr>
<td>STAMP</td>
<td>时间戳类型，包含年月日时分秒：yyyy-MM-dd HH:mm:ss</td>
</tr>
<tr>
<td>这个字段赋值或赋值为 NULL，则默认使用当前的系统时间</td>
<td></td>
</tr>
<tr>
<td></td>
<td>字符串，定长类型</td>
</tr>
<tr>
<td>HAR</td>
<td>字符串，<strong>变长类型</strong></td>
</tr>
<tr>
<td>varchar (20) 代表姓名最大 20 个字符：zhangsan 8 个字符，张三 2 个字符</td>
<td></td>
</tr>
</tbody>
</table>
<p><code>INT(n)</code> ：n 代表位数</p>
<ul>
<li>3：int（9）显示结果为 000000010</li>
<li>3：int（3）显示结果为 010</li>
</ul>
<p><code>varchar(n)</code> ：n 表示的是字符数</p>
</li>
<li>
<p>例如：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 使用db3数据库</span>
<span class="token keyword">USE</span> db3<span class="token punctuation">;</span>

<span class="token comment">-- 创建一个product商品表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> product<span class="token punctuation">(</span>
	id <span class="token keyword">INT</span><span class="token punctuation">,</span>				<span class="token comment">-- 商品编号</span>
	NAME <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span>	<span class="token comment">-- 商品名称</span>
	price <span class="token keyword">DOUBLE</span><span class="token punctuation">,</span>		<span class="token comment">-- 商品价格</span>
	stock <span class="token keyword">INT</span><span class="token punctuation">,</span>			<span class="token comment">-- 商品库存</span>
	insert_time <span class="token keyword">DATE</span>    <span class="token comment">-- 上架时间</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
</li>
<li>
<p>U (Update)：修改</p>
<ul>
<li>
<p>修改表名</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> 表名 <span class="token keyword">RENAME</span> <span class="token keyword">TO</span> 新的表名<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>修改表的字符集</p>
</li>
</ul>
<p>ALTER TABLE 表名 CHARACTER SET 字符集名称；</p>
<pre class="line-numbers language-none"><code class="language-none">- 添加一列

&#96;&#96;&#96;mysql
ALTER TABLE 表名 ADD 列名 数据类型;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>
<p>修改列数据类型</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> 表名 <span class="token keyword">MODIFY</span> 列名 新数据类型<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>修改列名称和数据类型</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> 表名 CHANGE 列名 新列名 新数据类型<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>删除列</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> 表名 <span class="token keyword">DROP</span> 列名<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
</li>
<li>
<p>D (Delete)：删除</p>
<ul>
<li>
<p>删除数据表</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> 表名<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>删除数据表 (判断，如果存在则删除)</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> 表名<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
</li>
</ul>
<hr>
<h3 id="-40"><a class="markdownIt-Anchor" href="#-40">#</a> <a href="#dml"></a>DML</h3>
<h4 id="-41"><a class="markdownIt-Anchor" href="#-41">#</a> <a href="#insert"></a>INSERT</h4>
<ul>
<li>
<p>新增表数据</p>
<ul>
<li>
<p>新增格式 1：给指定列添加数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> 表名<span class="token punctuation">(</span>列名<span class="token number">1</span><span class="token punctuation">,</span>列名<span class="token number">2.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>值<span class="token number">1</span><span class="token punctuation">,</span>值<span class="token number">2.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>新增格式 2：默认给全部列添加数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> 表名 <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>值<span class="token number">1</span><span class="token punctuation">,</span>值<span class="token number">2</span><span class="token punctuation">,</span>值<span class="token number">3</span><span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>新增格式 3：批量添加数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 给指定列批量添加数据</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> 表名<span class="token punctuation">(</span>列名<span class="token number">1</span><span class="token punctuation">,</span>列名<span class="token number">2</span><span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>值<span class="token number">1</span><span class="token punctuation">,</span>值<span class="token number">2</span><span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>值<span class="token number">1</span><span class="token punctuation">,</span>值<span class="token number">2</span><span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>

<span class="token comment">-- 默认给所有列批量添加数据 </span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> 表名 <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>值<span class="token number">1</span><span class="token punctuation">,</span>值<span class="token number">2</span><span class="token punctuation">,</span>值<span class="token number">3</span><span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>值<span class="token number">1</span><span class="token punctuation">,</span>值<span class="token number">2</span><span class="token punctuation">,</span>值<span class="token number">3</span><span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
</li>
<li>
<p>字符串拼接</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">CONCAT<span class="token punctuation">(</span>string1<span class="token punctuation">,</span>string2<span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>注意事项</p>
<ul>
<li>列名和值的数量以及数据类型要对应</li>
<li>除了数字类型，其他数据类型的数据都需要加引号 (单引双引都可以，推荐单引)</li>
</ul>
</li>
</ul>
<hr>
<h4 id="-42"><a class="markdownIt-Anchor" href="#-42">#</a> <a href="#update"></a>UPDATE</h4>
<ul>
<li>
<p>修改表数据语法</p>
<ul>
<li>
<p>标准语法</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">UPDATE</span> 表名 <span class="token keyword">SET</span> 列名<span class="token number">1</span> <span class="token operator">=</span> 值<span class="token number">1</span><span class="token punctuation">,</span>列名<span class="token number">2</span> <span class="token operator">=</span> 值<span class="token number">2</span><span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">[</span><span class="token keyword">where</span> 条件<span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>修改电视的价格为 1800、库存为 36</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">UPDATE</span> product <span class="token keyword">SET</span> price<span class="token operator">=</span><span class="token number">1800</span><span class="token punctuation">,</span>stock<span class="token operator">=</span><span class="token number">36</span> <span class="token keyword">WHERE</span> NAME<span class="token operator">=</span><span class="token string">'电视'</span><span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> product<span class="token punctuation">;</span><span class="token comment">-- 查看所有商品信息</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
</ul>
</li>
<li>
<p>注意事项</p>
<ul>
<li>修改语句中必须加条件</li>
<li>如果不加条件，则将所有数据都修改</li>
</ul>
</li>
</ul>
<hr>
<h4 id="-43"><a class="markdownIt-Anchor" href="#-43">#</a> <a href="#delete"></a>DELETE</h4>
<ul>
<li>
<p>删除表数据语法</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DELETE</span> <span class="token keyword">FROM</span> 表名 <span class="token punctuation">[</span><span class="token keyword">WHERE</span> 条件<span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>注意事项</p>
<ul>
<li>删除语句中必须加条件</li>
<li>如果不加条件，则将所有数据删除</li>
</ul>
</li>
</ul>
<hr>
<h3 id="-44"><a class="markdownIt-Anchor" href="#-44">#</a> <a href="#dql"></a>DQL</h3>
<h4 id="-45"><a class="markdownIt-Anchor" href="#-45">#</a> <a href="#%E6%9F%A5%E8%AF%A2%E8%AF%AD%E6%B3%95"></a>查询语法</h4>
<p>数据库查询遵循条件在前的原则</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token keyword">DISTINCT</span>
	<span class="token operator">&lt;</span><span class="token keyword">select</span> list<span class="token operator">></span>
<span class="token keyword">FROM</span>
	<span class="token operator">&lt;</span>left_table<span class="token operator">></span> <span class="token operator">&lt;</span>join_type<span class="token operator">></span>
<span class="token keyword">JOIN</span>
	<span class="token operator">&lt;</span>right_table<span class="token operator">></span> <span class="token keyword">ON</span> <span class="token operator">&lt;</span>join_condition<span class="token operator">></span>	<span class="token comment">-- 连接查询在多表查询部分详解</span>
<span class="token keyword">WHERE</span>
	<span class="token operator">&lt;</span>where_condition<span class="token operator">></span>
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span>
	<span class="token operator">&lt;</span>group_by_list<span class="token operator">></span>
<span class="token keyword">HAVING</span>
	<span class="token operator">&lt;</span>having_condition<span class="token operator">></span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span>
	<span class="token operator">&lt;</span>order_by_condition<span class="token operator">></span>
<span class="token keyword">LIMIT</span>
	<span class="token operator">&lt;</span>limit_params<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>执行顺序：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">FROM</span>	<span class="token operator">&lt;</span>left_table<span class="token operator">></span>

<span class="token keyword">ON</span> 		<span class="token operator">&lt;</span>join_condition<span class="token operator">></span>

<span class="token operator">&lt;</span>join_type<span class="token operator">></span>		<span class="token keyword">JOIN</span>	<span class="token operator">&lt;</span>right_table<span class="token operator">></span>

<span class="token keyword">WHERE</span>		<span class="token operator">&lt;</span>where_condition<span class="token operator">></span>

<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> 	<span class="token operator">&lt;</span>group_by_list<span class="token operator">></span>

<span class="token keyword">HAVING</span>		<span class="token operator">&lt;</span>having_condition<span class="token operator">></span>

<span class="token keyword">SELECT</span> <span class="token keyword">DISTINCT</span>		<span class="token operator">&lt;</span><span class="token keyword">select</span> list<span class="token operator">></span>

<span class="token keyword">ORDER</span> <span class="token keyword">BY</span>	<span class="token operator">&lt;</span>order_by_condition<span class="token operator">></span>

<span class="token keyword">LIMIT</span>		<span class="token operator">&lt;</span>limit_params<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<h4 id="-46"><a class="markdownIt-Anchor" href="#-46">#</a> <a href="#%E6%9F%A5%E8%AF%A2%E5%85%A8%E9%83%A8"></a>查询全部</h4>
<ul>
<li>
<p>查询全部的表数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 标准语法</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> 表名<span class="token punctuation">;</span>

<span class="token comment">-- 查询product表所有数据(常用)</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> product<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>查询指定字段的表数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> 列名<span class="token number">1</span><span class="token punctuation">,</span>列名<span class="token number">2</span><span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">FROM</span> 表名<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p><strong>去除重复查询</strong>：只有值全部重复的才可以去除，需要创建临时表辅助查询</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token keyword">DISTINCT</span> 列名<span class="token number">1</span><span class="token punctuation">,</span>列名<span class="token number">2</span><span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">FROM</span> 表名<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>计算列的值（四则运算）</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> 列名<span class="token number">1</span> 运算符<span class="token punctuation">(</span><span class="token operator">+</span> <span class="token operator">-</span> <span class="token operator">*</span> <span class="token operator">/</span><span class="token punctuation">)</span> 列名<span class="token number">2</span> <span class="token keyword">FROM</span> 表名<span class="token punctuation">;</span>

<span class="token comment">/*如果某一列值为null，可以进行替换
	ifnull(表达式1,表达式2)
	表达式1：想替换的列
	表达式2：想替换的值*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>例如：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 查询商品名称和库存，库存数量在原有基础上加10</span>
<span class="token keyword">SELECT</span> NAME<span class="token punctuation">,</span>stock<span class="token operator">+</span><span class="token number">10</span> <span class="token keyword">FROM</span> product<span class="token punctuation">;</span>

<span class="token comment">-- 查询商品名称和库存，库存数量在原有基础上加10。进行null值判断</span>
<span class="token keyword">SELECT</span> NAME<span class="token punctuation">,</span>IFNULL<span class="token punctuation">(</span>stock<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">10</span> <span class="token keyword">FROM</span> product<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p><strong>起别名</strong></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> 列名<span class="token number">1</span><span class="token punctuation">,</span>列名<span class="token number">2</span><span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">AS</span> 别名 <span class="token keyword">FROM</span> 表名<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>例如：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 查询商品名称和库存，库存数量在原有基础上加10。进行null值判断，起别名为getSum,AS可以省略。</span>
<span class="token keyword">SELECT</span> NAME<span class="token punctuation">,</span>IFNULL<span class="token punctuation">(</span>stock<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">10</span> <span class="token keyword">AS</span> getsum <span class="token keyword">FROM</span> product<span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> NAME<span class="token punctuation">,</span>IFNULL<span class="token punctuation">(</span>stock<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">10</span> getsum <span class="token keyword">FROM</span> product<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<hr>
<h4 id="-47"><a class="markdownIt-Anchor" href="#-47">#</a> <a href="#%E6%9D%A1%E4%BB%B6%E6%9F%A5%E8%AF%A2"></a>条件查询</h4>
<ul>
<li>
<p>条件查询语法</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> 列名 <span class="token keyword">FROM</span> 表名 <span class="token keyword">WHERE</span> 条件<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>条件分类</p>
<table>
<thead>
<tr>
<th>号</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td>&gt;</td>
<td>大于</td>
</tr>
<tr>
<td></td>
<td>小于</td>
</tr>
<tr>
<td>&gt;=</td>
<td>大于等于</td>
</tr>
<tr>
<td>=</td>
<td>小于等于</td>
</tr>
<tr>
<td>=</td>
<td>等于</td>
</tr>
<tr>
<td>&gt; 或！=</td>
<td>不等于</td>
</tr>
<tr>
<td>ETWEEN … AND …</td>
<td>在某个范围之内 (都包含)</td>
</tr>
<tr>
<td>N(…)</td>
<td>多选一</td>
</tr>
<tr>
<td>IKE</td>
<td><strong>模糊查询</strong>：_单个任意字符、% 任意个字符、[] 匹配集合内的字符</td>
</tr>
</tbody>
</table>
<p>|  <code>LIKE '[^AB]%'</code>  ：不以 A 和 B 开头的任意文本 |                                                              |<br>
| IS NULL                                      | 是 NULL                                                       |<br>
| IS NOT NULL                                  | 不是 NULL                                                     |<br>
| AND 或 &amp;&amp;                                    | 并且                                                         |<br>
| OR 或                                        |                                                              |<br>
| NOT 或！| 非，不是                                                     |<br>
| UNION                                        | 对两个结果集进行<strong>并集操作并进行去重，同时进行默认规则的排序</strong> |<br>
| UNION ALL                                    | 对两个结果集进行并集操作不进行去重，不进行排序               |</p>
</li>
<li>
<p>例如：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 查询库存大于20的商品信息</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> product <span class="token keyword">WHERE</span> stock <span class="token operator">></span> <span class="token number">20</span><span class="token punctuation">;</span>

<span class="token comment">-- 查询品牌为华为的商品信息</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> product <span class="token keyword">WHERE</span> brand<span class="token operator">=</span><span class="token string">'华为'</span><span class="token punctuation">;</span>

<span class="token comment">-- 查询金额在4000 ~ 6000之间的商品信息</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> product <span class="token keyword">WHERE</span> price <span class="token operator">>=</span> <span class="token number">4000</span> <span class="token operator">AND</span> price <span class="token operator">&lt;=</span> <span class="token number">6000</span><span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> product <span class="token keyword">WHERE</span> price <span class="token operator">BETWEEN</span> <span class="token number">4000</span> <span class="token operator">AND</span> <span class="token number">6000</span><span class="token punctuation">;</span>

<span class="token comment">-- 查询库存为14、30、23的商品信息</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> product <span class="token keyword">WHERE</span> stock<span class="token operator">=</span><span class="token number">14</span> <span class="token operator">OR</span> stock<span class="token operator">=</span><span class="token number">30</span> <span class="token operator">OR</span> stock<span class="token operator">=</span><span class="token number">23</span><span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> product <span class="token keyword">WHERE</span> stock <span class="token operator">IN</span><span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">23</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 查询库存为null的商品信息</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> product <span class="token keyword">WHERE</span> stock <span class="token operator">IS</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>
<span class="token comment">-- 查询库存不为null的商品信息</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> product <span class="token keyword">WHERE</span> stock <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>

<span class="token comment">-- 查询名称以'小米'为开头的商品信息</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> product <span class="token keyword">WHERE</span> NAME <span class="token operator">LIKE</span> <span class="token string">'小米%'</span><span class="token punctuation">;</span>

<span class="token comment">-- 查询名称第二个字是'为'的商品信息</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> product <span class="token keyword">WHERE</span> NAME <span class="token operator">LIKE</span> <span class="token string">'_为%'</span><span class="token punctuation">;</span>

<span class="token comment">-- 查询名称为四个字符的商品信息 4个下划线</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> product <span class="token keyword">WHERE</span> NAME <span class="token operator">LIKE</span> <span class="token string">'____'</span><span class="token punctuation">;</span>

<span class="token comment">-- 查询名称中包含电脑的商品信息</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> product <span class="token keyword">WHERE</span> NAME <span class="token operator">LIKE</span> <span class="token string">'%电脑%'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/43d67744a9a069386c4be09b3125796a226c75bac377f3eaea0504e9d19e4918/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d44514ce695b0e68daee58786e5a4872e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/43d67744a9a069386c4be09b3125796a226c75bac377f3eaea0504e9d19e4918/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d44514ce695b0e68daee58786e5a4872e706e67">https://camo.githubusercontent.com/43d67744a9a069386c4be09b3125796a226c75bac377f3eaea0504e9d19e4918/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d44514ce695b0e68daee58786e5a4872e706e67</a>)</p>
</li>
</ul>
<hr>
<h4 id="-48"><a class="markdownIt-Anchor" href="#-48">#</a> <a href="#%E5%87%BD%E6%95%B0%E6%9F%A5%E8%AF%A2"></a>函数查询</h4>
<h5 id="-49"><a class="markdownIt-Anchor" href="#-49">#</a> <a href="#%E8%81%9A%E5%90%88%E5%87%BD%E6%95%B0"></a>聚合函数</h5>
<p>聚合函数：将一列数据作为一个整体，进行纵向的计算</p>
<ul>
<li>
<p>聚合函数语法</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> 函数名<span class="token punctuation">(</span>列名<span class="token punctuation">)</span> <span class="token keyword">FROM</span> 表名 <span class="token punctuation">[</span><span class="token keyword">WHERE</span> 条件<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>聚合函数分类</p>
<table>
<thead>
<tr>
<th>数名</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td>OUNT (列名)</td>
<td>统计数量（一般选用不为 null 的列）</td>
</tr>
<tr>
<td>AX (列名)</td>
<td>最大值</td>
</tr>
<tr>
<td>IN (列名)</td>
<td>最小值</td>
</tr>
<tr>
<td>UM (列名)</td>
<td>求和</td>
</tr>
<tr>
<td>VG (列名)</td>
<td>平均值（会忽略 null 行）</td>
</tr>
</tbody>
</table>
</li>
<li>
<p>例如</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 计算product表中总记录条数 7</span>
<span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> product<span class="token punctuation">;</span>

<span class="token comment">-- 获取最高价格</span>
<span class="token keyword">SELECT</span> <span class="token function">MAX</span><span class="token punctuation">(</span>price<span class="token punctuation">)</span> <span class="token keyword">FROM</span> product<span class="token punctuation">;</span>
<span class="token comment">-- 获取最高价格的商品名称</span>
<span class="token keyword">SELECT</span> NAME<span class="token punctuation">,</span>price <span class="token keyword">FROM</span> product <span class="token keyword">WHERE</span> price <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token function">MAX</span><span class="token punctuation">(</span>price<span class="token punctuation">)</span> <span class="token keyword">FROM</span> product<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 获取最低库存</span>
<span class="token keyword">SELECT</span> <span class="token function">MIN</span><span class="token punctuation">(</span>stock<span class="token punctuation">)</span> <span class="token keyword">FROM</span> product<span class="token punctuation">;</span>
<span class="token comment">-- 获取最低库存的商品名称</span>
<span class="token keyword">SELECT</span> NAME<span class="token punctuation">,</span>stock <span class="token keyword">FROM</span> product <span class="token keyword">WHERE</span> stock <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token function">MIN</span><span class="token punctuation">(</span>stock<span class="token punctuation">)</span> <span class="token keyword">FROM</span> product<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 获取总库存数量</span>
<span class="token keyword">SELECT</span> <span class="token function">SUM</span><span class="token punctuation">(</span>stock<span class="token punctuation">)</span> <span class="token keyword">FROM</span> product<span class="token punctuation">;</span>
<span class="token comment">-- 获取品牌为小米的平均商品价格</span>
<span class="token keyword">SELECT</span> <span class="token function">AVG</span><span class="token punctuation">(</span>price<span class="token punctuation">)</span> <span class="token keyword">FROM</span> product <span class="token keyword">WHERE</span> brand<span class="token operator">=</span><span class="token string">'小米'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<hr>
<h5 id="-50"><a class="markdownIt-Anchor" href="#-50">#</a> <a href="#%E6%96%87%E6%9C%AC%E5%87%BD%E6%95%B0"></a>文本函数</h5>
<p>CONCAT ()：用于连接两个字段</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> CONCAT<span class="token punctuation">(</span>TRIM<span class="token punctuation">(</span>col1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'('</span><span class="token punctuation">,</span> TRIM<span class="token punctuation">(</span>col2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">')'</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> concat_col <span class="token keyword">FROM</span> mytable
<span class="token comment">-- 许多数据库会使用空格把一个值填充为列宽，连接的结果出现一些不必要的空格，使用TRIM()可以去除首尾空格</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<table>
<thead>
<tr>
<th>函数名称</th>
<th>作 用</th>
</tr>
</thead>
<tbody>
<tr>
<td>LENGTH</td>
<td>计算字符串长度函数，返回字符串的字节长度</td>
</tr>
<tr>
<td>CONCAT</td>
<td>合并字符串函数，返回结果为连接参数产生的字符串，参数可以使一个或多个</td>
</tr>
<tr>
<td>INSERT</td>
<td>替换字符串函数</td>
</tr>
<tr>
<td>LOWER</td>
<td>将字符串中的字母转换为小写</td>
</tr>
<tr>
<td>UPPER</td>
<td>将字符串中的字母转换为大写</td>
</tr>
<tr>
<td>LEFT</td>
<td>从左侧字截取符串，返回字符串左边的若干个字符</td>
</tr>
<tr>
<td>RIGHT</td>
<td>从右侧字截取符串，返回字符串右边的若干个字符</td>
</tr>
<tr>
<td>TRIM</td>
<td>删除字符串左右两侧的空格</td>
</tr>
<tr>
<td>REPLACE</td>
<td>字符串替换函数，返回替换后的新字符串</td>
</tr>
<tr>
<td>SUBSTRING</td>
<td>截取字符串，返回从指定位置开始的指定长度的字符换</td>
</tr>
<tr>
<td>REVERSE</td>
<td>字符串反转（逆序）函数，返回与原始字符串顺序相反的字符串</td>
</tr>
</tbody>
</table>
<hr>
<h5 id="-51"><a class="markdownIt-Anchor" href="#-51">#</a> <a href="#%E6%95%B0%E5%AD%97%E5%87%BD%E6%95%B0"></a>数字函数</h5>
<table>
<thead>
<tr>
<th>函数名称</th>
<th>作 用</th>
</tr>
</thead>
<tbody>
<tr>
<td>ABS</td>
<td>求绝对值</td>
</tr>
<tr>
<td>SQRT</td>
<td>求二次方根</td>
</tr>
<tr>
<td>MOD</td>
<td>求余数</td>
</tr>
<tr>
<td>CEIL 和 CEILING</td>
<td>两个函数功能相同，都是返回不小于参数的最小整数，即向上取整</td>
</tr>
<tr>
<td>FLOOR</td>
<td>向下取整，返回值转化为一个 BIGINT</td>
</tr>
<tr>
<td>RAND</td>
<td>生成一个 0~1 之间的随机数，传入整数参数是，用来产生重复序列</td>
</tr>
<tr>
<td>ROUND</td>
<td>对所传参数进行四舍五入</td>
</tr>
<tr>
<td>SIGN</td>
<td>返回参数的符号</td>
</tr>
<tr>
<td>POW 和 POWER</td>
<td>两个函数的功能相同，都是所传参数的次方的结果值</td>
</tr>
<tr>
<td>SIN</td>
<td>求正弦值</td>
</tr>
<tr>
<td>ASIN</td>
<td>求反正弦值，与函数 SIN 互为反函数</td>
</tr>
<tr>
<td>COS</td>
<td>求余弦值</td>
</tr>
<tr>
<td>ACOS</td>
<td>求反余弦值，与函数 COS 互为反函数</td>
</tr>
<tr>
<td>TAN</td>
<td>求正切值</td>
</tr>
<tr>
<td>ATAN</td>
<td>求反正切值，与函数 TAN 互为反函数</td>
</tr>
<tr>
<td>COT</td>
<td>求余切值</td>
</tr>
</tbody>
</table>
<hr>
<h5 id="-52"><a class="markdownIt-Anchor" href="#-52">#</a> <a href="#%E6%97%A5%E6%9C%9F%E5%87%BD%E6%95%B0"></a>日期函数</h5>
<table>
<thead>
<tr>
<th>函数名称</th>
<th>作 用</th>
</tr>
</thead>
<tbody>
<tr>
<td>CURDATE 和 CURRENT_DATE</td>
<td>两个函数作用相同，返回当前系统的日期值</td>
</tr>
<tr>
<td>CURTIME 和 CURRENT_TIME</td>
<td>两个函数作用相同，返回当前系统的时间值</td>
</tr>
<tr>
<td>NOW 和 SYSDATE</td>
<td>两个函数作用相同，返回当前系统的日期和时间值</td>
</tr>
<tr>
<td>MONTH</td>
<td>获取指定日期中的月份</td>
</tr>
<tr>
<td>MONTHNAME</td>
<td>获取指定日期中的月份英文名称</td>
</tr>
<tr>
<td>DAYNAME</td>
<td>获取指定曰期对应的星期几的英文名称</td>
</tr>
<tr>
<td>DAYOFWEEK</td>
<td>获取指定日期对应的一周的索引位置值</td>
</tr>
<tr>
<td>WEEK</td>
<td>获取指定日期是一年中的第几周，返回值的范围是否为 0〜52 或 1〜53</td>
</tr>
<tr>
<td>DAYOFYEAR</td>
<td>获取指定曰期是一年中的第几天，返回值范围是 1~366</td>
</tr>
<tr>
<td>DAYOFMONTH</td>
<td>获取指定日期是一个月中是第几天，返回值范围是 1~31</td>
</tr>
<tr>
<td>YEAR</td>
<td>获取年份，返回值范围是 1970〜2069</td>
</tr>
<tr>
<td>TIME_TO_SEC</td>
<td>将时间参数转换为秒数</td>
</tr>
<tr>
<td>SEC_TO_TIME</td>
<td>将秒数转换为时间，与 TIME_TO_SEC 互为反函数</td>
</tr>
<tr>
<td>DATE_ADD 和 ADDDATE</td>
<td>两个函数功能相同，都是向日期添加指定的时间间隔</td>
</tr>
<tr>
<td>DATE_SUB 和 SUBDATE</td>
<td>两个函数功能相同，都是向日期减去指定的时间间隔</td>
</tr>
<tr>
<td>ADDTIME</td>
<td>时间加法运算，在原始时间上添加指定的时间</td>
</tr>
<tr>
<td>SUBTIME</td>
<td>时间减法运算，在原始时间上减去指定的时间</td>
</tr>
<tr>
<td>DATEDIFF</td>
<td>获取两个日期之间间隔，返回参数 1 减去参数 2 的值</td>
</tr>
<tr>
<td>DATE_FORMAT</td>
<td>格式化指定的日期，根据参数返回指定格式的值</td>
</tr>
<tr>
<td>WEEKDAY</td>
<td>获取指定日期在一周内的对应的工作日索引</td>
</tr>
</tbody>
</table>
<hr>
<h4 id="-53"><a class="markdownIt-Anchor" href="#-53">#</a> <a href="#%E6%AD%A3%E5%88%99%E6%9F%A5%E8%AF%A2"></a>正则查询</h4>
<p>正则表达式（Regular Expression）是指一个用来描述或者匹配一系列符合某个句法规则的字符串的单个字符串</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> emp <span class="token keyword">WHERE</span> name <span class="token operator">REGEXP</span> <span class="token string">'^T'</span><span class="token punctuation">;</span>	<span class="token comment">-- 匹配以T开头的name值</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> emp <span class="token keyword">WHERE</span> name <span class="token operator">REGEXP</span> <span class="token string">'2$'</span><span class="token punctuation">;</span>	<span class="token comment">-- 匹配以2结尾的name值</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> emp <span class="token keyword">WHERE</span> name <span class="token operator">REGEXP</span> <span class="token string">'[uvw]'</span><span class="token punctuation">;</span><span class="token comment">-- 匹配包含 uvw 的name值</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<table>
<thead>
<tr>
<th>符号</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>^</td>
<td>在字符串开始处进行匹配</td>
</tr>
<tr>
<td>$</td>
<td>在字符串末尾处进行匹配</td>
</tr>
<tr>
<td>.</td>
<td>匹配任意单个字符，包括换行符</td>
</tr>
<tr>
<td>[…]</td>
<td>匹配出括号内的任意字符</td>
</tr>
<tr>
<td>[^…]</td>
<td>匹配不出括号内的任意字符</td>
</tr>
<tr>
<td>a*</td>
<td>匹配零个或者多个 a (包括空串)</td>
</tr>
<tr>
<td>a+</td>
<td>匹配一个或者多个 a (不包括空串)</td>
</tr>
<tr>
<td>a?</td>
<td>匹配零个或者一个 a</td>
</tr>
<tr>
<td>a1</td>
<td>a2</td>
</tr>
<tr>
<td>a(m)</td>
<td>匹配 m 个 a</td>
</tr>
<tr>
<td>a(m,)</td>
<td>至少匹配 m 个 a</td>
</tr>
<tr>
<td>a(m,n)</td>
<td>匹配 m 个 a 到 n 个 a</td>
</tr>
<tr>
<td>a(,n)</td>
<td>匹配 0 到 n 个 a</td>
</tr>
<tr>
<td>(…)</td>
<td>将模式元素组成单一元素</td>
</tr>
</tbody>
</table>
<hr>
<h4 id="-54"><a class="markdownIt-Anchor" href="#-54">#</a> <a href="#%E6%8E%92%E5%BA%8F%E6%9F%A5%E8%AF%A2"></a>排序查询</h4>
<ul>
<li>
<p>排序查询语法</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> 列名 <span class="token keyword">FROM</span> 表名 <span class="token punctuation">[</span><span class="token keyword">WHERE</span> 条件<span class="token punctuation">]</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> 列名<span class="token number">1</span> 排序方式<span class="token number">1</span><span class="token punctuation">,</span>列名<span class="token number">2</span> 排序方式<span class="token number">2</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>排序方式</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ASC</span>:升序
<span class="token keyword">DESC</span>:降序<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>注意：多个排序条件，当前边的条件值一样时，才会判断第二条件</p>
</li>
<li>
<p>例如</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 按照库存升序排序</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> product <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> stock <span class="token keyword">ASC</span><span class="token punctuation">;</span>

<span class="token comment">-- 查询名称中包含手机的商品信息。按照金额降序排序</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> product <span class="token keyword">WHERE</span> NAME <span class="token operator">LIKE</span> <span class="token string">'%手机%'</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> price <span class="token keyword">DESC</span><span class="token punctuation">;</span>

<span class="token comment">-- 按照金额升序排序，如果金额相同，按照库存降序排列</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> product <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> price <span class="token keyword">ASC</span><span class="token punctuation">,</span>stock <span class="token keyword">DESC</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<hr>
<h4 id="-55"><a class="markdownIt-Anchor" href="#-55">#</a> <a href="#%E5%88%86%E7%BB%84%E6%9F%A5%E8%AF%A2"></a>分组查询</h4>
<p>分组查询会进行去重</p>
<ul>
<li>
<p>分组查询语法</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> 列名 <span class="token keyword">FROM</span> 表名 <span class="token punctuation">[</span><span class="token keyword">WHERE</span> 条件<span class="token punctuation">]</span> <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> 分组列名 <span class="token punctuation">[</span><span class="token keyword">HAVING</span> 分组后条件过滤<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> 排序列名 排序方式<span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>WHERE 过滤行，HAVING 过滤分组，行过滤应当先于分组过滤</p>
<p>分组规定：</p>
<ul>
<li>GROUP BY 子句出现在 WHERE 子句之后，ORDER BY 子句之前</li>
<li>NULL 的行会单独分为一组</li>
<li>大多数 SQL 实现不支持 GROUP BY 列具有可变长度的数据类型</li>
</ul>
</li>
<li>
<p>例如</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 按照品牌分组，获取每组商品的总金额</span>
<span class="token keyword">SELECT</span> brand<span class="token punctuation">,</span><span class="token function">SUM</span><span class="token punctuation">(</span>price<span class="token punctuation">)</span> <span class="token keyword">FROM</span> product <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> brand<span class="token punctuation">;</span>

<span class="token comment">-- 对金额大于4000元的商品，按照品牌分组,获取每组商品的总金额</span>
<span class="token keyword">SELECT</span> brand<span class="token punctuation">,</span><span class="token function">SUM</span><span class="token punctuation">(</span>price<span class="token punctuation">)</span> <span class="token keyword">FROM</span> product <span class="token keyword">WHERE</span> price <span class="token operator">></span> <span class="token number">4000</span> <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> brand<span class="token punctuation">;</span>

<span class="token comment">-- 对金额大于4000元的商品，按照品牌分组，获取每组商品的总金额，只显示总金额大于7000元的</span>
<span class="token keyword">SELECT</span> brand<span class="token punctuation">,</span><span class="token function">SUM</span><span class="token punctuation">(</span>price<span class="token punctuation">)</span> <span class="token keyword">AS</span> getSum <span class="token keyword">FROM</span> product <span class="token keyword">WHERE</span> price <span class="token operator">></span> <span class="token number">4000</span> <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> brand <span class="token keyword">HAVING</span> getSum <span class="token operator">></span> <span class="token number">7000</span><span class="token punctuation">;</span>

<span class="token comment">-- 对金额大于4000元的商品，按照品牌分组，获取每组商品的总金额，只显示总金额大于7000元的、并按照总金额的降序排列</span>
<span class="token keyword">SELECT</span> brand<span class="token punctuation">,</span><span class="token function">SUM</span><span class="token punctuation">(</span>price<span class="token punctuation">)</span> <span class="token keyword">AS</span> getSum <span class="token keyword">FROM</span> product <span class="token keyword">WHERE</span> price <span class="token operator">></span> <span class="token number">4000</span> <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> brand <span class="token keyword">HAVING</span> getSum <span class="token operator">></span> <span class="token number">7000</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> getSum <span class="token keyword">DESC</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<hr>
<h4 id="-56"><a class="markdownIt-Anchor" href="#-56">#</a> <a href="#%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2"></a>分页查询</h4>
<ul>
<li>
<p>分页查询语法</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> 列名 <span class="token keyword">FROM</span> 表名 <span class="token punctuation">[</span><span class="token keyword">WHERE</span> 条件<span class="token punctuation">]</span> <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> 分组列名 <span class="token punctuation">[</span><span class="token keyword">HAVING</span> 分组后条件过滤<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> 排序列名 排序方式<span class="token punctuation">]</span> <span class="token keyword">LIMIT</span> 开始索引<span class="token punctuation">,</span>查询条数<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>公式：开始索引 = (当前页码 - 1) * 每页显示的条数</p>
</li>
<li>
<p>例如</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> product <span class="token keyword">LIMIT</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">;</span>  <span class="token comment">-- 第一页 开始索引=(1-1) * 2</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> product <span class="token keyword">LIMIT</span> <span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">;</span>  <span class="token comment">-- 第二页 开始索引=(2-1) * 2</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> product <span class="token keyword">LIMIT</span> <span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">;</span>  <span class="token comment">-- 第三页 开始索引=(3-1) * 2</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> product <span class="token keyword">LIMIT</span> <span class="token number">6</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">;</span>  <span class="token comment">-- 第四页 开始索引=(4-1) * 2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d44514c2545352538382538362545392541312542352545362539462541352545382541462541322545352539422542452545382541372541332e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/cf6ef1aa5e60eadf457832a0780856584bff3547d4a8ab0b791244bed5d72534/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d44514c2545352538382538362545392541312542352545362539462541352545382541462541322545352539422542452545382541372541332e706e67">https://camo.githubusercontent.com/cf6ef1aa5e60eadf457832a0780856584bff3547d4a8ab0b791244bed5d72534/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d44514c2545352538382538362545392541312542352545362539462541352545382541462541322545352539422542452545382541372541332e706e67</a>)</p>
</li>
</ul>
<hr>
<h2 id="-57"><a class="markdownIt-Anchor" href="#-57">#</a> <a href="#%E5%A4%9A%E8%A1%A8%E6%93%8D%E4%BD%9C"></a>多表操作</h2>
<h3 id="-58"><a class="markdownIt-Anchor" href="#-58">#</a> <a href="#%E7%BA%A6%E6%9D%9F%E5%88%86%E7%B1%BB"></a>约束分类</h3>
<h4 id="-59"><a class="markdownIt-Anchor" href="#-59">#</a> <a href="#%E7%BA%A6%E6%9D%9F%E4%BB%8B%E7%BB%8D"></a>约束介绍</h4>
<p>约束：对表中的数据进行限定，保证数据的正确性、有效性、完整性！</p>
<p>约束的分类：</p>
<table>
<thead>
<tr>
<th>约束</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>PRIMARY KEY</td>
<td>主键约束</td>
</tr>
<tr>
<td>PRIMARY KEY AUTO_INCREMENT</td>
<td>主键、自动增长</td>
</tr>
<tr>
<td>UNIQUE</td>
<td>唯一约束</td>
</tr>
<tr>
<td>NOT NULL</td>
<td>非空约束</td>
</tr>
<tr>
<td>FOREIGN KEY</td>
<td>外键约束</td>
</tr>
<tr>
<td>FOREIGN KEY ON UPDATE CASCADE</td>
<td>外键级联更新</td>
</tr>
<tr>
<td>FOREIGN KEY ON DELETE CASCADE</td>
<td>外键级联删除</td>
</tr>
</tbody>
</table>
<hr>
<h4 id="-60"><a class="markdownIt-Anchor" href="#-60">#</a> <a href="#%E4%B8%BB%E9%94%AE%E7%BA%A6%E6%9D%9F"></a>主键约束</h4>
<ul>
<li>
<p>主键约束特点：</p>
<ul>
<li>主键约束默认包含<strong>非空和唯一</strong>两个功能</li>
<li>一张表只能有一个主键</li>
<li>主键一般用于表中数据的唯一标识</li>
</ul>
</li>
<li>
<p>建表时添加主键约束</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> 表名<span class="token punctuation">(</span>
	列名 数据类型 <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
    列名 数据类型<span class="token punctuation">,</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>删除主键约束</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> 表名 <span class="token keyword">DROP</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>建表后单独添加主键约束</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> 表名 <span class="token keyword">MODIFY</span> 列名 数据类型 <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>例如</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 创建student表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> student<span class="token punctuation">(</span>
	id <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span>  <span class="token comment">-- 给id添加主键约束</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 添加数据</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> student <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 主键默认唯一，添加重复数据，会报错</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> student <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 主键默认非空，不能添加null的数据</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> student <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<hr>
<h4 id="-61"><a class="markdownIt-Anchor" href="#-61">#</a> <a href="#%E4%B8%BB%E9%94%AE%E8%87%AA%E5%A2%9E"></a>主键自增</h4>
<p>主键自增约束可以为空，并自动增长。删除某条数据不影响自增的下一个数值，依然按照前一个值自增。</p>
<ul>
<li>
<p>建表时添加主键自增约束</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> 表名<span class="token punctuation">(</span>
	列名 数据类型 <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
    列名 数据类型<span class="token punctuation">,</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>删除主键自增约束</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> 表名 <span class="token keyword">MODIFY</span> 列名 数据类型<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>建表后单独添加主键自增约束</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> 表名 <span class="token keyword">MODIFY</span> 列名 数据类型 <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>例如</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 创建student2表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> student2<span class="token punctuation">(</span>
	id <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span>    <span class="token comment">-- 给id添加主键自增约束</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 添加数据</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> student2 <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 添加null值，会自动增长</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> student2 <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">-- 3，4</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<hr>
<h4 id="-62"><a class="markdownIt-Anchor" href="#-62">#</a> <a href="#%E5%94%AF%E4%B8%80%E7%BA%A6%E6%9D%9F"></a>唯一约束</h4>
<p>唯一约束：约束不能有重复的数据</p>
<ul>
<li>
<p>建表时添加唯一约束</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> 表名<span class="token punctuation">(</span>
	列名 数据类型 <span class="token keyword">UNIQUE</span><span class="token punctuation">,</span>
    列名 数据类型<span class="token punctuation">,</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>删除唯一约束</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> 表名 <span class="token keyword">DROP</span> <span class="token keyword">INDEX</span> 列名<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>建表后单独添加唯一约束</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> 表名 <span class="token keyword">MODIFY</span> 列名 数据类型 <span class="token keyword">UNIQUE</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<hr>
<h4 id="-63"><a class="markdownIt-Anchor" href="#-63">#</a> <a href="#%E9%9D%9E%E7%A9%BA%E7%BA%A6%E6%9D%9F"></a>非空约束</h4>
<ul>
<li>
<p>建表时添加非空约束</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> 表名<span class="token punctuation">(</span>
	列名 数据类型 <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    列名 数据类型<span class="token punctuation">,</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>删除非空约束</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> 表名 <span class="token keyword">MODIFY</span> 列名 数据类型<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>建表后单独添加非空约束</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> 表名 <span class="token keyword">MODIFY</span> 列名 数据类型 <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<hr>
<h4 id="-64"><a class="markdownIt-Anchor" href="#-64">#</a> <a href="#%E5%A4%96%E9%94%AE%E7%BA%A6%E6%9D%9F"></a>外键约束</h4>
<p>外键约束：让表和表之间产生关系，从而保证数据的准确性！</p>
<ul>
<li>
<p>建表时添加外键约束</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> 表名<span class="token punctuation">(</span>
	列名 数据类型 约束<span class="token punctuation">,</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">CONSTRAINT</span> 外键名 <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>本表外键列名<span class="token punctuation">)</span> <span class="token keyword">REFERENCES</span> 主表名<span class="token punctuation">(</span>主表主键列名<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>删除外键约束</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> 表名 <span class="token keyword">DROP</span> <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> 外键名<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>建表后单独添加外键约束</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> 表名 <span class="token keyword">ADD</span> <span class="token keyword">CONSTRAINT</span> 外键名 <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>本表外键列名<span class="token punctuation">)</span> <span class="token keyword">REFERENCES</span> 主表名<span class="token punctuation">(</span>主表主键列名<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>例如</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 创建user用户表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">USER</span><span class="token punctuation">(</span>
	id <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>    <span class="token comment">-- id</span>
	name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span>             <span class="token comment">-- 姓名</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 添加用户数据</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token keyword">USER</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'张三'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'李四'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'王五'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 创建orderlist订单表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> orderlist<span class="token punctuation">(</span>
	id <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>    <span class="token comment">-- id</span>
	number <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>          <span class="token comment">-- 订单编号</span>
	uid <span class="token keyword">INT</span><span class="token punctuation">,</span>                              <span class="token comment">-- 订单所属用户</span>
	<span class="token keyword">CONSTRAINT</span> ou_fk1 <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>uid<span class="token punctuation">)</span> <span class="token keyword">REFERENCES</span> <span class="token keyword">USER</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>   <span class="token comment">-- 添加外键约束</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 添加订单数据</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> orderlist <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'hm001'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'hm002'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'hm003'</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'hm004'</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'hm005'</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'hm006'</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 添加一个订单，但是没有所属用户。无法添加</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> orderlist <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'hm007'</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 删除王五这个用户，但是订单表中王五还有很多个订单呢。无法删除</span>
<span class="token keyword">DELETE</span> <span class="token keyword">FROM</span> <span class="token keyword">USER</span> <span class="token keyword">WHERE</span> NAME<span class="token operator">=</span><span class="token string">'王五'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<hr>
<h4 id="-65"><a class="markdownIt-Anchor" href="#-65">#</a> <a href="#%E5%A4%96%E9%94%AE%E7%BA%A7%E8%81%94"></a>外键级联</h4>
<p>级联操作：当把主表中的数据进行删除或更新时，从表中有关联的数据的相应操作，包括 RESTRICT、CASCADE、SET NULL 和 NO ACTION</p>
<ul>
<li>
<p>RESTRICT 和 NO ACTION 相同， 是指限制在子表有关联记录的情况下， 父表不能更新</p>
</li>
<li>
<p>CASCADE 表示父表在更新或者删除时，更新或者删除子表对应的记录</p>
</li>
<li>
<p>SET NULL 则表示父表在更新或者删除的时候，子表的对应字段被 SET NULL</p>
</li>
</ul>
<p>级联操作：</p>
<ul>
<li>
<p>添加级联更新</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> 表名 <span class="token keyword">ADD</span> <span class="token keyword">CONSTRAINT</span> 外键名 <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>本表外键列名<span class="token punctuation">)</span> <span class="token keyword">REFERENCES</span> 主表名<span class="token punctuation">(</span>主表主键列名<span class="token punctuation">)</span> <span class="token keyword">ON</span> <span class="token keyword">UPDATE</span> <span class="token punctuation">[</span><span class="token keyword">CASCADE</span> <span class="token operator">|</span> <span class="token keyword">RESTRICT</span> <span class="token operator">|</span> <span class="token keyword">SET</span> <span class="token boolean">NULL</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>添加级联删除</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> 表名 <span class="token keyword">ADD</span> <span class="token keyword">CONSTRAINT</span> 外键名 <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>本表外键列名<span class="token punctuation">)</span> <span class="token keyword">REFERENCES</span> 主表名<span class="token punctuation">(</span>主表主键列名<span class="token punctuation">)</span> <span class="token keyword">ON</span> <span class="token keyword">DELETE</span> <span class="token keyword">CASCADE</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>同时添加级联更新和级联删除</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> 表名 <span class="token keyword">ADD</span> <span class="token keyword">CONSTRAINT</span> 外键名 <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>本表外键列名<span class="token punctuation">)</span> <span class="token keyword">REFERENCES</span> 主表名<span class="token punctuation">(</span>主表主键列名<span class="token punctuation">)</span> <span class="token keyword">ON</span> <span class="token keyword">UPDATE</span> <span class="token keyword">CASCADE</span> <span class="token keyword">ON</span> <span class="token keyword">DELETE</span> <span class="token keyword">CASCADE</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<hr>
<h3 id="-66"><a class="markdownIt-Anchor" href="#-66">#</a> <a href="#%E5%A4%9A%E8%A1%A8%E8%AE%BE%E8%AE%A1"></a>多表设计</h3>
<h4 id="-67"><a class="markdownIt-Anchor" href="#-67">#</a> <a href="#%E4%B8%80%E5%AF%B9%E4%B8%80"></a>一对一</h4>
<p>多表：有多张数据表，而表与表之间有一定的关联关系，通过外键约束实现，分为一对一、一对多、多对多三类</p>
<p>举例：人和身份证</p>
<p>实现原则：在任意一个表建立外键，去关联另外一个表的主键</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 创建person表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> person<span class="token punctuation">(</span>
	id <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>	<span class="token comment">-- 主键id</span>
	NAME <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>                        <span class="token comment">-- 姓名</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 添加数据</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> person <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'张三'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'李四'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 创建card表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> card<span class="token punctuation">(</span>
	id <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>	<span class="token comment">-- 主键id</span>
	number <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">UNIQUE</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>	<span class="token comment">-- 身份证号</span>
	pid <span class="token keyword">INT</span> <span class="token keyword">UNIQUE</span><span class="token punctuation">,</span>                         <span class="token comment">-- 外键列</span>
	<span class="token keyword">CONSTRAINT</span> cp_fk1 <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>pid<span class="token punctuation">)</span> <span class="token keyword">REFERENCES</span> person<span class="token punctuation">(</span>id<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 添加数据</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> card <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'12345'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'56789'</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f2545352541342539412545382541312541382545382541452542452545382541452541312545342542382538302545352541462542392545342542382538302e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/e3f5ba75fa4719b9b92b686ef1ac0dc200cd1f589530e492490e99c3e64c044a/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f2545352541342539412545382541312541382545382541452542452545382541452541312545342542382538302545352541462542392545342542382538302e706e67">https://camo.githubusercontent.com/e3f5ba75fa4719b9b92b686ef1ac0dc200cd1f589530e492490e99c3e64c044a/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f2545352541342539412545382541312541382545382541452542452545382541452541312545342542382538302545352541462542392545342542382538302e706e67</a>)</p>
<hr>
<h4 id="-68"><a class="markdownIt-Anchor" href="#-68">#</a> <a href="#%E4%B8%80%E5%AF%B9%E5%A4%9A"></a>一对多</h4>
<p>举例：用户和订单、商品分类和商品</p>
<p>实现原则：在多的一方，建立外键约束，来关联一的一方主键</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 创建user表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">USER</span><span class="token punctuation">(</span>
	id <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>	<span class="token comment">-- 主键id</span>
	NAME <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>                        <span class="token comment">-- 姓名</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 添加数据</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token keyword">USER</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'张三'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'李四'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 创建orderlist表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> orderlist<span class="token punctuation">(</span>
	id <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>	<span class="token comment">-- 主键id</span>
	number <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                     <span class="token comment">-- 订单编号</span>
	uid <span class="token keyword">INT</span><span class="token punctuation">,</span>				<span class="token comment">-- 外键列</span>
	<span class="token keyword">CONSTRAINT</span> ou_fk1 <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>uid<span class="token punctuation">)</span> <span class="token keyword">REFERENCES</span> <span class="token keyword">USER</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 添加数据</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> orderlist <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'hm001'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'hm002'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'hm003'</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'hm004'</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/b3bf33066a1e911e5e21eb2553a0bf9804bf1d2f01b08474faba5c3c5f62da20/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f2545352541342539412545382541312541382545382541452542452545382541452541312545342542382538302545352541462542392545352541342539412e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/b3bf33066a1e911e5e21eb2553a0bf9804bf1d2f01b08474faba5c3c5f62da20/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f2545352541342539412545382541312541382545382541452542452545382541452541312545342542382538302545352541462542392545352541342539412e706e67">https://camo.githubusercontent.com/b3bf33066a1e911e5e21eb2553a0bf9804bf1d2f01b08474faba5c3c5f62da20/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f2545352541342539412545382541312541382545382541452542452545382541452541312545342542382538302545352541462542392545352541342539412e706e67</a>)</p>
<hr>
<h4 id="-69"><a class="markdownIt-Anchor" href="#-69">#</a> <a href="#%E5%A4%9A%E5%AF%B9%E5%A4%9A"></a>多对多</h4>
<p>举例：学生和课程。一个学生可以选择多个课程，一个课程也可以被多个学生选择</p>
<p>实现原则：借助第三张表中间表，中间表至少包含两个列，这两个列作为中间表的外键，分别关联两张表的主键</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 创建student表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> student<span class="token punctuation">(</span>
	id <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>	<span class="token comment">-- 主键id</span>
	NAME <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>			<span class="token comment">-- 学生姓名</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 添加数据</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> student <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'张三'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'李四'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 创建course表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> course<span class="token punctuation">(</span>
	id <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>	<span class="token comment">-- 主键id</span>
	NAME <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>			<span class="token comment">-- 课程名称</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 添加数据</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> course <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'语文'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'数学'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 创建中间表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> stu_course<span class="token punctuation">(</span>
	id <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>	<span class="token comment">-- 主键id</span>
	sid <span class="token keyword">INT</span><span class="token punctuation">,</span>  <span class="token comment">-- 用于和student表中的id进行外键关联</span>
	cid <span class="token keyword">INT</span><span class="token punctuation">,</span>  <span class="token comment">-- 用于和course表中的id进行外键关联</span>
	<span class="token keyword">CONSTRAINT</span> sc_fk1 <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>sid<span class="token punctuation">)</span> <span class="token keyword">REFERENCES</span> student<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">-- 添加外键约束</span>
	<span class="token keyword">CONSTRAINT</span> sc_fk2 <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>cid<span class="token punctuation">)</span> <span class="token keyword">REFERENCES</span> course<span class="token punctuation">(</span>id<span class="token punctuation">)</span>   <span class="token comment">-- 添加外键约束</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 添加数据</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> stu_course <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f2545352541342539412545382541312541382545382541452542452545382541452541312545352541342539412545352541462542392545352541342539412e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/fb2325f258bde0b3f711fb5edad3f2393f2d141eb4d39e9ef102909f875384f7/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f2545352541342539412545382541312541382545382541452542452545382541452541312545352541342539412545352541462542392545352541342539412e706e67">https://camo.githubusercontent.com/fb2325f258bde0b3f711fb5edad3f2393f2d141eb4d39e9ef102909f875384f7/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f2545352541342539412545382541312541382545382541452542452545382541452541312545352541342539412545352541462542392545352541342539412e706e67</a>)</p>
<hr>
<h3 id="-70"><a class="markdownIt-Anchor" href="#-70">#</a> <a href="#%E8%BF%9E%E6%8E%A5%E6%9F%A5%E8%AF%A2"></a>连接查询</h3>
<h4 id="-71"><a class="markdownIt-Anchor" href="#-71">#</a> <a href="#%E8%BF%9E%E6%8E%A5%E5%8E%9F%E7%90%86-1"></a>连接原理</h4>
<p>连接查询的是两张表有交集的部分数据，如果结果集中的每条记录都是两个表相互匹配的组合，则称这样的结果集为笛卡尔积</p>
<p>查询原理：两张表分为驱动表和被驱动表，首先查询驱动表得到数据集，然后根据数据集中的每一条记录再分别到被驱动表中查找匹配，所以驱动表只需要访问一次，被驱动表要访问多次</p>
<p>MySQL 将查询驱动表后得到的记录成为驱动表的扇出，连接查询的成本：单次访问驱动表的成本 + 扇出值 * 单次访问被驱动表的成本，优化器会选择成本最小的表连接顺序（确定谁是驱动表，谁是被驱动表）生成执行计划，进行连接查询，优化方式：</p>
<ul>
<li>减少驱动表的扇出</li>
<li>降低访问被驱动表的成本</li>
</ul>
<p>MySQL 提出了一种<strong>空间换时间</strong>的优化方式，基于块的循环连接，执行连接查询前申请一块固定大小的内存作为连接缓冲区 Join Buffer，先把若干条驱动表中的扇出暂存在缓冲区，每一条被驱动表中的记录一次性的与 Buffer 中多条记录进行匹配（可能是一对多），因为是在内存中完成，所以速度快，并且降低了 I/O 成本。</p>
<p>Join Buffer 可以通过参数  <code>join_buffer_size</code>  进行配置，默认大小是 256 KB</p>
<p>在成本分析时，对于很多张表的连接查询，连接顺序有非常多，MySQL 如果挨着进行遍历计算成本，会消耗很多资源</p>
<ul>
<li>
<p>提前结束某种连接顺序的成本评估：维护一个全局变量记录当前成本最小的连接方式，如果一种顺序只计算了一部分就已经超过了最小成本，可以提前结束计算</p>
</li>
<li>
<p>系统变量 optimizer_search_depth：如果连接表的个数小于该变量，就继续穷举分析每一种连接数量，反之只对数量与 depth 值相同的表进行分析，该值越大成本分析的越精确</p>
</li>
<li>
<p>系统变量 optimizer_prune_level：控制启发式规则的启用，这些规则就是根据以往经验指定的，不满足规则的连接顺序不分析成本</p>
</li>
</ul>
<hr>
<h4 id="-72"><a class="markdownIt-Anchor" href="#-72">#</a> <a href="#%E5%86%85%E5%A4%96%E8%BF%9E%E6%8E%A5"></a>内外连接</h4>
<h5 id="-73"><a class="markdownIt-Anchor" href="#-73">#</a> <a href="#%E5%86%85%E8%BF%9E%E6%8E%A5"></a>内连接</h5>
<p>内连接查询，若驱动表中的记录在被驱动表中找不到匹配的记录时，则该记录不会加到最后的结果集</p>
<ul>
<li>
<p>显式内连接</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> 列名 <span class="token keyword">FROM</span> 表名<span class="token number">1</span> <span class="token punctuation">[</span><span class="token keyword">INNER</span><span class="token punctuation">]</span> <span class="token keyword">JOIN</span> 表名<span class="token number">2</span> <span class="token keyword">ON</span> 条件<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>隐式内连接</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> 列名 <span class="token keyword">FROM</span> 表名<span class="token number">1</span><span class="token punctuation">,</span>表名<span class="token number">2</span> <span class="token keyword">WHERE</span> 条件<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<p>内连接中 WHERE 子句和 ON 子句是等价的</p>
<hr>
<h5 id="-74"><a class="markdownIt-Anchor" href="#-74">#</a> <a href="#%E5%A4%96%E8%BF%9E%E6%8E%A5"></a>外连接</h5>
<p>外连接查询，若驱动表中的记录在被驱动表中找不到匹配的记录时，则该记录也会加到最后的结果集，只是对于被驱动表中<strong>不匹配过滤条件</strong>的记录，各个字段使用 NULL 填充</p>
<p>应用实例：查学生成绩，也想查出缺考的人的成绩</p>
<p>（内连接快还是外连接快？）</p>
<ul>
<li>
<p>左外连接：选择左侧的表为驱动表，查询左表的全部数据，和左右两张表有交集部分的数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> 列名 <span class="token keyword">FROM</span> 表名<span class="token number">1</span> <span class="token keyword">LEFT</span> <span class="token punctuation">[</span><span class="token keyword">OUTER</span><span class="token punctuation">]</span> <span class="token keyword">JOIN</span> 表名<span class="token number">2</span> <span class="token keyword">ON</span> 条件<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>右外连接：选择右侧的表为驱动表，查询右表的全部数据，和左右两张表有交集部分的数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> 列名 <span class="token keyword">FROM</span> 表名<span class="token number">1</span> <span class="token keyword">RIGHT</span> <span class="token punctuation">[</span><span class="token keyword">OUTER</span><span class="token punctuation">]</span> <span class="token keyword">JOIN</span> 表名<span class="token number">2</span> <span class="token keyword">ON</span> 条件<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/c05cd6b9ab1ca9c52b1eb67676bdbcdbfccf5885e9d4a05ada958952513fe1fb/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d4a4f494e2545362539462541352545382541462541322545352539422542452e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/c05cd6b9ab1ca9c52b1eb67676bdbcdbfccf5885e9d4a05ada958952513fe1fb/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d4a4f494e2545362539462541352545382541462541322545352539422542452e706e67">https://camo.githubusercontent.com/c05cd6b9ab1ca9c52b1eb67676bdbcdbfccf5885e9d4a05ada958952513fe1fb/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d4a4f494e2545362539462541352545382541462541322545352539422542452e706e67</a>)</p>
<hr>
<h4 id="-75"><a class="markdownIt-Anchor" href="#-75">#</a> <a href="#%E5%85%B3%E8%81%94%E6%9F%A5%E8%AF%A2"></a>关联查询</h4>
<p>自关联查询：同一张表中有数据关联，可以多次查询这同一个表</p>
<ul>
<li>
<p>数据准备</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 创建员工表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> employee<span class="token punctuation">(</span>
	id <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>	<span class="token comment">-- 员工编号</span>
	NAME <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>					<span class="token comment">-- 员工姓名</span>
	mgr <span class="token keyword">INT</span><span class="token punctuation">,</span>							<span class="token comment">-- 上级编号</span>
	salary <span class="token keyword">DOUBLE</span>						<span class="token comment">-- 员工工资</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 添加数据</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> employee <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">1001</span><span class="token punctuation">,</span><span class="token string">'孙悟空'</span><span class="token punctuation">,</span><span class="token number">1005</span><span class="token punctuation">,</span><span class="token number">9000.00</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">1002</span><span class="token punctuation">,</span><span class="token string">'猪八戒'</span><span class="token punctuation">,</span><span class="token number">1005</span><span class="token punctuation">,</span><span class="token number">8000.00</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">1003</span><span class="token punctuation">,</span><span class="token string">'沙和尚'</span><span class="token punctuation">,</span><span class="token number">1005</span><span class="token punctuation">,</span><span class="token number">8500.00</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">1004</span><span class="token punctuation">,</span><span class="token string">'小白龙'</span><span class="token punctuation">,</span><span class="token number">1005</span><span class="token punctuation">,</span><span class="token number">7900.00</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">1005</span><span class="token punctuation">,</span><span class="token string">'唐僧'</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token number">15000.00</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">1006</span><span class="token punctuation">,</span><span class="token string">'武松'</span><span class="token punctuation">,</span><span class="token number">1009</span><span class="token punctuation">,</span><span class="token number">7600.00</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">1007</span><span class="token punctuation">,</span><span class="token string">'李逵'</span><span class="token punctuation">,</span><span class="token number">1009</span><span class="token punctuation">,</span><span class="token number">7400.00</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">1008</span><span class="token punctuation">,</span><span class="token string">'林冲'</span><span class="token punctuation">,</span><span class="token number">1009</span><span class="token punctuation">,</span><span class="token number">8100.00</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">1009</span><span class="token punctuation">,</span><span class="token string">'宋江'</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token number">16000.00</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/55f44398508352c5a523f173657774e5f0681d8910ab8a71688ca35bb0b4edd2/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f2545382538372541412545352538352542332545382538312539342545362539462541352545382541462541322545362539352542302545362538442541452545352538372538362545352541342538372e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/55f44398508352c5a523f173657774e5f0681d8910ab8a71688ca35bb0b4edd2/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f2545382538372541412545352538352542332545382538312539342545362539462541352545382541462541322545362539352542302545362538442541452545352538372538362545352541342538372e706e67">https://camo.githubusercontent.com/55f44398508352c5a523f173657774e5f0681d8910ab8a71688ca35bb0b4edd2/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f2545382538372541412545352538352542332545382538312539342545362539462541352545382541462541322545362539352542302545362538442541452545352538372538362545352541342538372e706e67</a>)</p>
</li>
<li>
<p>数据查询</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 查询所有员工的姓名及其直接上级的姓名，没有上级的员工也需要查询</span>
<span class="token comment">/*
分析
	员工信息 employee表
	条件：employee.mgr = employee.id
	查询左表的全部数据，和左右两张表有交集部分数据，左外连接
*/</span>
<span class="token keyword">SELECT</span>
	e1<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
	e1<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
	e1<span class="token punctuation">.</span>mgr<span class="token punctuation">,</span>
	e2<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
	e2<span class="token punctuation">.</span>name
<span class="token keyword">FROM</span>
	employee e1
<span class="token keyword">LEFT</span> <span class="token keyword">OUTER</span> <span class="token keyword">JOIN</span>
	employee e2
<span class="token keyword">ON</span>
	e1<span class="token punctuation">.</span>mgr <span class="token operator">=</span> e2<span class="token punctuation">.</span>id<span class="token punctuation">;</span>	<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>查询结果</p>
<pre class="line-numbers language-none"><code class="language-none">id		name	mgr	   id	  name
1001	孙悟空	  1005	1005	唐僧
1002	猪八戒	  1005	1005	唐僧
1003	沙和尚	  1005	1005	唐僧
1004	小白龙	  1005	1005	唐僧
1005	唐僧	   NULL	 NULL	 NULL
1006	武松	   1009	 1009	 宋江
1007	李逵	   1009	 1009	 宋江
1008	林冲	   1009	 1009	 宋江
1009	宋江	   NULL	 NULL	 NULL
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<hr>
<h3 id="-76"><a class="markdownIt-Anchor" href="#-76">#</a> <a href="#%E5%B5%8C%E5%A5%97%E6%9F%A5%E8%AF%A2"></a>嵌套查询</h3>
<h4 id="-77"><a class="markdownIt-Anchor" href="#-77">#</a> <a href="#%E6%9F%A5%E8%AF%A2%E5%88%86%E7%B1%BB"></a>查询分类</h4>
<p>查询语句中嵌套了查询语句，<strong>将嵌套查询称为子查询</strong>，FROM 子句后面的子查询的结果集称为派生表</p>
<p>根据结果分类：</p>
<ul>
<li>
<p>结果是单行单列：可以将查询的结果作为另一条语句的查询条件，使用运算符判断</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> 列名 <span class="token keyword">FROM</span> 表名 <span class="token keyword">WHERE</span> 列名<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> 列名<span class="token operator">/</span>聚合函数<span class="token punctuation">(</span>列名<span class="token punctuation">)</span> <span class="token keyword">FROM</span> 表名 <span class="token punctuation">[</span><span class="token keyword">WHERE</span> 条件<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>结果是多行单列：可以作为条件，使用运算符 IN 或 NOT IN 进行判断</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> 列名 <span class="token keyword">FROM</span> 表名 <span class="token keyword">WHERE</span> 列名 <span class="token punctuation">[</span><span class="token operator">NOT</span><span class="token punctuation">]</span> <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> 列名 <span class="token keyword">FROM</span> 表名 <span class="token punctuation">[</span><span class="token keyword">WHERE</span> 条件<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>结果是多行多列：查询的结果可以作为一张虚拟表参与查询</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> 列名 <span class="token keyword">FROM</span> 表名 <span class="token punctuation">[</span>别名<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> 列名 <span class="token keyword">FROM</span> 表名 <span class="token punctuation">[</span><span class="token keyword">WHERE</span> 条件<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>别名<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token keyword">WHERE</span> 条件<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">-- 查询订单表orderlist中id大于4的订单信息和所属用户USER信息</span>
<span class="token keyword">SELECT</span> 
	<span class="token operator">*</span> 
<span class="token keyword">FROM</span> 
	<span class="token keyword">USER</span> u<span class="token punctuation">,</span>
	<span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> orderlist <span class="token keyword">WHERE</span> id<span class="token operator">></span><span class="token number">4</span><span class="token punctuation">)</span> o 
<span class="token keyword">WHERE</span> 
	u<span class="token punctuation">.</span>id<span class="token operator">=</span>o<span class="token punctuation">.</span>uid<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<p>相关性分类：</p>
<ul>
<li>不相关子查询：子查询不依赖外层查询的值，可以单独运行出结果</li>
<li>相关子查询：子查询的执行需要依赖外层查询的值</li>
</ul>
<hr>
<h4 id="-78"><a class="markdownIt-Anchor" href="#-78">#</a> <a href="#%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96"></a>查询优化</h4>
<p>不相关子查询的结果集会被写入一个临时表，并且在写入时<strong>去重</strong>，该过程称为<strong>物化</strong>，存储结果集的临时表称为物化表。</p>
<p>系统变量 tmp_table_size 或者 max_heap_table_size 为表的最值</p>
<ul>
<li>小于系统变量时，内存中可以保存，会为建立基于内存的 MEMORY 存储引擎的临时表，并建立哈希索引</li>
<li>大于任意一个系统变量时，物化表会使用基于磁盘的存储引擎来保存结果集中的记录，索引类型为 B+ 树</li>
</ul>
<p>物化后，嵌套查询就相当于外层查询的表和物化表进行内连接查询，然后经过优化器选择成本最小的表连接顺序执行查询</p>
<p>将子查询物化会产生建立临时表的成本，但是将子查询转化为连接查询可以充分发挥优化器的作用，所以引入：半连接</p>
<ul>
<li>t1 和 t2 表进行半连接，对于 t1 表中的某条记录，只需要关心在 s2 表中是否存在，而不需要关心有多少条记录与之匹配，最终结果集只保留 t1 的记录</li>
<li>半连接只是执行子查询的一种方式，MySQL 并没有提供面向用户的半连接语法</li>
</ul>
<p>参考书籍：<a target="_blank" rel="noopener" href="https://book.douban.com/subject/35231266/">https://book.douban.com/subject/35231266/</a></p>
<hr>
<h3 id="-79"><a class="markdownIt-Anchor" href="#-79">#</a> <a href="#%E6%9F%A5%E8%AF%A2%E7%BB%83%E4%B9%A0"></a>查询练习</h3>
<p>数据准备：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 创建db4数据库</span>
<span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> db4<span class="token punctuation">;</span>
<span class="token comment">-- 使用db4数据库</span>
<span class="token keyword">USE</span> db4<span class="token punctuation">;</span>

<span class="token comment">-- 创建user表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">USER</span><span class="token punctuation">(</span>
	id <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>	<span class="token comment">-- 用户id</span>
	NAME <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>					<span class="token comment">-- 用户姓名</span>
	age <span class="token keyword">INT</span>                             <span class="token comment">-- 用户年龄</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 订单表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> orderlist<span class="token punctuation">(</span>
	id <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>	<span class="token comment">-- 订单id</span>
	number <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span>					<span class="token comment">-- 订单编号</span>
	uid <span class="token keyword">INT</span><span class="token punctuation">,</span>   							<span class="token comment">-- 外键字段</span>
	<span class="token keyword">CONSTRAINT</span> ou_fk1 <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>uid<span class="token punctuation">)</span> <span class="token keyword">REFERENCES</span> <span class="token keyword">USER</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 商品分类表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> category<span class="token punctuation">(</span>
	id <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>  <span class="token comment">-- 商品分类id</span>
	NAME <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>                    <span class="token comment">-- 商品分类名称</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 商品表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> product<span class="token punctuation">(</span>
	id <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>   <span class="token comment">-- 商品id</span>
	NAME <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                    <span class="token comment">-- 商品名称</span>
	cid <span class="token keyword">INT</span><span class="token punctuation">,</span> <span class="token comment">-- 外键字段</span>
	<span class="token keyword">CONSTRAINT</span> cp_fk1 <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>cid<span class="token punctuation">)</span> <span class="token keyword">REFERENCES</span> category<span class="token punctuation">(</span>id<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 中间表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> us_pro<span class="token punctuation">(</span>
	upid <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>  <span class="token comment">-- 中间表id</span>
	uid <span class="token keyword">INT</span><span class="token punctuation">,</span> 							  <span class="token comment">-- 外键字段。需要和用户表的主键产生关联</span>
	pid <span class="token keyword">INT</span><span class="token punctuation">,</span>							  <span class="token comment">-- 外键字段。需要和商品表的主键产生关联</span>
	<span class="token keyword">CONSTRAINT</span> up_fk1 <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>uid<span class="token punctuation">)</span> <span class="token keyword">REFERENCES</span> <span class="token keyword">USER</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token keyword">CONSTRAINT</span> up_fk2 <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>pid<span class="token punctuation">)</span> <span class="token keyword">REFERENCES</span> product<span class="token punctuation">(</span>id<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f2545352541342539412545382541312541382545372542422538332545342542392541302545362539452542362545362539452538342545382541452542452545382541452541312e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/886f8785ba3a15563e0f5861e18e0eef501c8659322bba189da09654064b8780/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f2545352541342539412545382541312541382545372542422538332545342542392541302545362539452542362545362539452538342545382541452542452545382541452541312e706e67">https://camo.githubusercontent.com/886f8785ba3a15563e0f5861e18e0eef501c8659322bba189da09654064b8780/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f2545352541342539412545382541312541382545372542422538332545342542392541302545362539452542362545362539452538342545382541452542452545382541452541312e706e67</a>)</p>
<p><strong>数据查询：</strong></p>
<ol>
<li>
<p>查询用户的编号、姓名、年龄、订单编号。 分析： 数据：用户的编号、姓名、年龄在 user 表，订单编号在 orderlist 表 条件：<a target="_blank" rel="noopener" href="http://user.id">user.id</a> = orderlist.uid</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span>
	u<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span>
	o<span class="token punctuation">.</span>number
<span class="token keyword">FROM</span>
	<span class="token keyword">USER</span> u<span class="token punctuation">,</span>
	orderlist o
<span class="token keyword">WHERE</span>
	u<span class="token punctuation">.</span>id <span class="token operator">=</span> o<span class="token punctuation">.</span>uid<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>查询所有的用户，显示用户的编号、姓名、年龄、订单编号。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span>
	u<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span>
	o<span class="token punctuation">.</span>number
<span class="token keyword">FROM</span>
	<span class="token keyword">USER</span> u
<span class="token keyword">LEFT</span> <span class="token keyword">OUTER</span> <span class="token keyword">JOIN</span>
	orderlist o
<span class="token keyword">ON</span>
	u<span class="token punctuation">.</span>id <span class="token operator">=</span> o<span class="token punctuation">.</span>uid<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>查询用户年龄大于 23 岁的信息，显示用户的编号、姓名、年龄、订单编号。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span>
	u<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span>
	o<span class="token punctuation">.</span>number
<span class="token keyword">FROM</span>
	<span class="token keyword">USER</span> u<span class="token punctuation">,</span>
	orderlist o
<span class="token keyword">WHERE</span>
	u<span class="token punctuation">.</span>id <span class="token operator">=</span> o<span class="token punctuation">.</span>uid
	<span class="token operator">AND</span>
	u<span class="token punctuation">.</span>age <span class="token operator">></span> <span class="token number">23</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span>
	u<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span>
	o<span class="token punctuation">.</span>number
<span class="token keyword">FROM</span>
	<span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">USER</span> <span class="token keyword">WHERE</span> age <span class="token operator">></span> <span class="token number">23</span><span class="token punctuation">)</span> u<span class="token punctuation">,</span><span class="token comment">-- 嵌套查询</span>
	orderlist o
<span class="token keyword">WHERE</span>
	u<span class="token punctuation">.</span>id <span class="token operator">=</span> o<span class="token punctuation">.</span>uid<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>查询张三和李四用户的信息，显示用户的编号、姓名、年龄、订单编号。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span>
	u<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span>
	o<span class="token punctuation">.</span>number
<span class="token keyword">FROM</span>
	<span class="token keyword">USER</span> u<span class="token punctuation">,</span>
	orderlist o
<span class="token keyword">WHERE</span>
	u<span class="token punctuation">.</span>id<span class="token operator">=</span>o<span class="token punctuation">.</span>uid
	<span class="token operator">AND</span>
	u<span class="token punctuation">.</span>name <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'张三'</span><span class="token punctuation">,</span><span class="token string">'李四'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>查询所有的用户和该用户能查看的所有的商品，显示用户的编号、姓名、年龄、商品名称。 数据：用户的编号、姓名、年龄在 user 表，商品名称在 product 表，中间表 us_pro 条件：us_pro.uid = <a target="_blank" rel="noopener" href="http://user.id">user.id</a> AND us_pro.pid = <a target="_blank" rel="noopener" href="http://product.id">product.id</a></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span>
	u<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
	u<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
	u<span class="token punctuation">.</span>age<span class="token punctuation">,</span>
	p<span class="token punctuation">.</span>name
<span class="token keyword">FROM</span>
	<span class="token keyword">USER</span> u<span class="token punctuation">,</span>
	product p<span class="token punctuation">,</span>
	us_pro up
<span class="token keyword">WHERE</span>
	up<span class="token punctuation">.</span>uid <span class="token operator">=</span> u<span class="token punctuation">.</span>id
	<span class="token operator">AND</span>
	up<span class="token punctuation">.</span>pid<span class="token operator">=</span>p<span class="token punctuation">.</span>id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>查询张三和李四这两个用户可以看到的商品，显示用户的编号、姓名、年龄、商品名称。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span>
	u<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
	u<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
	u<span class="token punctuation">.</span>age<span class="token punctuation">,</span>
	p<span class="token punctuation">.</span>name
<span class="token keyword">FROM</span>
	<span class="token keyword">USER</span> u<span class="token punctuation">,</span>
	product p<span class="token punctuation">,</span>
	us_pro up
<span class="token keyword">WHERE</span>
	up<span class="token punctuation">.</span>uid<span class="token operator">=</span>u<span class="token punctuation">.</span>id
	<span class="token operator">AND</span>
	up<span class="token punctuation">.</span>pid<span class="token operator">=</span>p<span class="token punctuation">.</span>id
	<span class="token operator">AND</span>
	u<span class="token punctuation">.</span>name <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'张三'</span><span class="token punctuation">,</span><span class="token string">'李四'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ol>
<hr>
<h2 id="-80"><a class="markdownIt-Anchor" href="#-80">#</a> <a href="#%E5%AD%98%E5%82%A8%E7%BB%93%E6%9E%84"></a>存储结构</h2>
<h3 id="-81"><a class="markdownIt-Anchor" href="#-81">#</a> <a href="#%E8%A7%86%E5%9B%BE"></a>视图</h3>
<h4 id="-82"><a class="markdownIt-Anchor" href="#-82">#</a> <a href="#%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D"></a>基本介绍</h4>
<p>视图概念：视图是一种虚拟存在的数据表，这个虚拟的表并不在数据库中实际存在</p>
<p>本质：将一条 SELECT 查询语句的结果封装到了一个虚拟表中，所以在创建视图的时候，工作重心要放在这条 SELECT 查询语句上</p>
<p>作用：将一些比较复杂的查询语句的结果，封装到一个虚拟表中，再有相同查询需求时，直接查询该虚拟表</p>
<p>优点：</p>
<ul>
<li>
<p>简单：使用视图的用户不需要关心表的结构、关联条件和筛选条件，因为虚拟表中已经是过滤好的结果集</p>
</li>
<li>
<p>安全：使用视图的用户只能访问查询的结果集，对表的权限管理并不能限制到某个行某个列</p>
</li>
<li>
<p>数据独立，一旦视图的结构确定，可以屏蔽表结构变化对用户的影响，源表增加列对视图没有影响；源表修改列名，则可以通过修改视图来解决，不会造成对访问者的影响</p>
</li>
</ul>
<hr>
<h4 id="-83"><a class="markdownIt-Anchor" href="#-83">#</a> <a href="#%E8%A7%86%E5%9B%BE%E5%88%9B%E5%BB%BA"></a>视图创建</h4>
<ul>
<li>
<p>创建视图</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token punctuation">[</span><span class="token operator">OR</span> <span class="token keyword">REPLACE</span><span class="token punctuation">]</span> 
<span class="token keyword">VIEW</span> 视图名称 <span class="token punctuation">[</span><span class="token punctuation">(</span>列名列表<span class="token punctuation">)</span><span class="token punctuation">]</span> 
<span class="token keyword">AS</span> 查询语句
<span class="token punctuation">[</span><span class="token keyword">WITH</span> <span class="token punctuation">[</span><span class="token keyword">CASCADED</span> <span class="token operator">|</span> <span class="token keyword">LOCAL</span><span class="token punctuation">]</span> <span class="token keyword">CHECK</span> <span class="token keyword">OPTION</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>WITH [CASCADED | LOCAL] CHECK OPTION</code>  决定了是否允许更新数据使记录不再满足视图的条件：</p>
<ul>
<li>LOCAL：只要满足本视图的条件就可以更新</li>
<li>CASCADED：必须满足所有针对该视图的所有视图的条件才可以更新， 默认值</li>
</ul>
</li>
<li>
<p>例如</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 数据准备 city</span>
id	NAME	cid
<span class="token number">1</span>	深圳	 	<span class="token number">1</span>
<span class="token number">2</span>	上海		<span class="token number">1</span>
<span class="token number">3</span>	纽约		<span class="token number">2</span>
<span class="token number">4</span>	莫斯科	    <span class="token number">3</span>

<span class="token comment">-- 数据准备 country</span>
id	NAME
<span class="token number">1</span>	中国
<span class="token number">2</span>	美国
<span class="token number">3</span>	俄罗斯

<span class="token comment">-- 创建city_country视图，保存城市和国家的信息(使用指定列名)</span>
<span class="token keyword">CREATE</span> 
<span class="token keyword">VIEW</span> 
	city_country <span class="token punctuation">(</span>city_id<span class="token punctuation">,</span>city_name<span class="token punctuation">,</span>country_name<span class="token punctuation">)</span>
<span class="token keyword">AS</span>
    <span class="token keyword">SELECT</span>
        c1<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
        c1<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
        c2<span class="token punctuation">.</span>name
    <span class="token keyword">FROM</span>
        city c1<span class="token punctuation">,</span>
        country c2
    <span class="token keyword">WHERE</span>
        c1<span class="token punctuation">.</span>cid<span class="token operator">=</span>c2<span class="token punctuation">.</span>id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<hr>
<h4 id="-84"><a class="markdownIt-Anchor" href="#-84">#</a> <a href="#%E8%A7%86%E5%9B%BE%E6%9F%A5%E8%AF%A2"></a>视图查询</h4>
<ul>
<li>
<p>查询所有数据表，视图也会查询出来</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SHOW</span> <span class="token keyword">TABLES</span><span class="token punctuation">;</span>
<span class="token keyword">SHOW</span> <span class="token keyword">TABLE</span> <span class="token keyword">STATUS</span> <span class="token punctuation">[</span>\G<span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li>
<p>查询视图</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> 视图名称<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>查询某个视图创建</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SHOW</span> <span class="token keyword">CREATE</span> <span class="token keyword">VIEW</span> 视图名称<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<hr>
<h4 id="-85"><a class="markdownIt-Anchor" href="#-85">#</a> <a href="#%E8%A7%86%E5%9B%BE%E4%BF%AE%E6%94%B9"></a>视图修改</h4>
<p>视图表数据修改，会<strong>自动修改源表中的数据</strong>，因为更新的是视图中的基表中的数据</p>
<ul>
<li>
<p>修改视图表中的数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">UPDATE</span> 视图名称 <span class="token keyword">SET</span> 列名 <span class="token operator">=</span> 值 <span class="token keyword">WHERE</span> 条件<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>修改视图的结构</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token punctuation">[</span><span class="token keyword">ALGORITHM</span> <span class="token operator">=</span> &#123;<span class="token keyword">UNDEFINED</span> <span class="token operator">|</span> <span class="token keyword">MERGE</span> <span class="token operator">|</span> <span class="token keyword">TEMPTABLE</span>&#125;<span class="token punctuation">]</span>
<span class="token keyword">VIEW</span> 视图名称 <span class="token punctuation">[</span><span class="token punctuation">(</span>列名列表<span class="token punctuation">)</span><span class="token punctuation">]</span> 
<span class="token keyword">AS</span> 查询语句
<span class="token punctuation">[</span><span class="token keyword">WITH</span> <span class="token punctuation">[</span><span class="token keyword">CASCADED</span> <span class="token operator">|</span> <span class="token keyword">LOCAL</span><span class="token punctuation">]</span> <span class="token keyword">CHECK</span> <span class="token keyword">OPTION</span><span class="token punctuation">]</span>

<span class="token comment">-- 将视图中的country_name修改为name</span>
<span class="token keyword">ALTER</span> 
<span class="token keyword">VIEW</span> 
	city_country <span class="token punctuation">(</span>city_id<span class="token punctuation">,</span>city_name<span class="token punctuation">,</span>name<span class="token punctuation">)</span> 
<span class="token keyword">AS</span>
    <span class="token keyword">SELECT</span>
        c1<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
        c1<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
        c2<span class="token punctuation">.</span>name
    <span class="token keyword">FROM</span>
        city c1<span class="token punctuation">,</span>
        country c2
    <span class="token keyword">WHERE</span>
        c1<span class="token punctuation">.</span>cid<span class="token operator">=</span>c2<span class="token punctuation">.</span>id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<hr>
<h4 id="-86"><a class="markdownIt-Anchor" href="#-86">#</a> <a href="#%E8%A7%86%E5%9B%BE%E5%88%A0%E9%99%A4"></a>视图删除</h4>
<ul>
<li>
<p>删除视图</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">VIEW</span> 视图名称<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>如果存在则删除</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">VIEW</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> 视图名称<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<hr>
<h3 id="-87"><a class="markdownIt-Anchor" href="#-87">#</a> <a href="#%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B"></a>存储过程</h3>
<h4 id="-88"><a class="markdownIt-Anchor" href="#-88">#</a> <a href="#%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D-1"></a>基本介绍</h4>
<p>存储过程和函数：存储过程和函数是事先经过编译并存储在数据库中的一段 SQL 语句的集合</p>
<p>存储过程和函数的好处：</p>
<ul>
<li>提高代码的复用性</li>
<li>减少数据在数据库和应用服务器之间的传输，提高传输效率</li>
<li>减少代码层面的业务处理</li>
<li><strong>一次编译永久有效</strong></li>
</ul>
<p>存储过程和函数的区别：</p>
<ul>
<li>存储函数必须有返回值</li>
<li>存储过程可以没有返回值</li>
</ul>
<hr>
<h4 id="-89"><a class="markdownIt-Anchor" href="#-89">#</a> <a href="#%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C"></a>基本操作</h4>
<p>DELIMITER：</p>
<ul>
<li>
<p>DELIMITER 关键字用来声明 sql 语句的分隔符，告诉 MySQL 该段命令已经结束</p>
</li>
<li>
<p>MySQL 语句默认的分隔符是分号，但是有时需要一条功能 sql 语句中包含分号，但是并不作为结束标识，这时使用 DELIMITER 来指定分隔符：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DELIMITER</span> 分隔符<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<p>存储过程的创建调用查看和删除：</p>
<ul>
<li>
<p>创建存储过程</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 修改分隔符为$</span>
<span class="token keyword">DELIMITER</span> $

<span class="token comment">-- 标准语法</span>
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> 存储过程名称<span class="token punctuation">(</span>参数<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
	<span class="token keyword">sql</span>语句<span class="token punctuation">;</span>
<span class="token keyword">END</span>$

<span class="token comment">-- 修改分隔符为分号</span>
<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>调用存储过程</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CALL</span> 存储过程名称<span class="token punctuation">(</span>实际参数<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>查看存储过程</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> mysql<span class="token punctuation">.</span><span class="token keyword">proc</span> <span class="token keyword">WHERE</span> db<span class="token operator">=</span><span class="token string">'数据库名称'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>删除存储过程</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">PROCEDURE</span> <span class="token punctuation">[</span><span class="token keyword">IF</span> <span class="token keyword">EXISTS</span><span class="token punctuation">]</span> 存储过程名称<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<p>练习：</p>
<ul>
<li>
<p>数据准备</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">id	NAME	age		gender	score
<span class="token number">1</span>	张三		<span class="token number">23</span>		男		<span class="token number">95</span>
<span class="token number">2</span>	李四		<span class="token number">24</span>		男		<span class="token number">98</span>
<span class="token number">3</span>	王五		<span class="token number">25</span>		女		<span class="token number">100</span>
<span class="token number">4</span>	赵六		<span class="token number">26</span>		女		<span class="token number">90</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>创建 stu_group () 存储过程，封装分组查询总成绩，并按照总成绩升序排序的功能</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DELIMITER</span> $

<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> stu_group<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
	<span class="token keyword">SELECT</span> gender<span class="token punctuation">,</span><span class="token function">SUM</span><span class="token punctuation">(</span>score<span class="token punctuation">)</span> getSum <span class="token keyword">FROM</span> student <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> gender <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> getSum <span class="token keyword">ASC</span><span class="token punctuation">;</span> 
<span class="token keyword">END</span>$

<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>

<span class="token comment">-- 调用存储过程</span>
<span class="token keyword">CALL</span> stu_group<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 删除存储过程</span>
<span class="token keyword">DROP</span> <span class="token keyword">PROCEDURE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> stu_group<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<hr>
<h4 id="-90"><a class="markdownIt-Anchor" href="#-90">#</a> <a href="#%E5%AD%98%E5%82%A8%E8%AF%AD%E6%B3%95"></a>存储语法</h4>
<h5 id="-91"><a class="markdownIt-Anchor" href="#-91">#</a> <a href="#%E5%8F%98%E9%87%8F%E4%BD%BF%E7%94%A8"></a>变量使用</h5>
<p>存储过程是可以进行编程的，意味着可以使用变量、表达式、条件控制语句等，来完成比较复杂的功能</p>
<ul>
<li>
<p>定义变量：DECLARE 定义的是局部变量，只能用在 BEGIN END 范围之内</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DECLARE</span> 变量名 数据类型 <span class="token punctuation">[</span><span class="token keyword">DEFAULT</span> 默认值<span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>变量的赋值</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SET</span> 变量名 <span class="token operator">=</span> 变量值<span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> 列名 <span class="token keyword">INTO</span> 变量名 <span class="token keyword">FROM</span> 表名 <span class="token punctuation">[</span><span class="token keyword">WHERE</span> 条件<span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li>
<p>数据准备：表 student</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">id	NAME	age		gender	score
<span class="token number">1</span>	张三		<span class="token number">23</span>		男		<span class="token number">95</span>
<span class="token number">2</span>	李四		<span class="token number">24</span>		男		<span class="token number">98</span>
<span class="token number">3</span>	王五		<span class="token number">25</span>		女		<span class="token number">100</span>
<span class="token number">4</span>	赵六		<span class="token number">26</span>		女		<span class="token number">90</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>定义两个 int 变量，用于存储男女同学的总分数</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DELIMITER</span> $
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> pro_test3<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
	<span class="token comment">-- 定义两个变量</span>
	<span class="token keyword">DECLARE</span> men<span class="token punctuation">,</span>women <span class="token keyword">INT</span><span class="token punctuation">;</span>
	<span class="token comment">-- 查询男同学的总分数，为men赋值</span>
	<span class="token keyword">SELECT</span> <span class="token function">SUM</span><span class="token punctuation">(</span>score<span class="token punctuation">)</span> <span class="token keyword">INTO</span> men <span class="token keyword">FROM</span> student <span class="token keyword">WHERE</span> gender<span class="token operator">=</span><span class="token string">'男'</span><span class="token punctuation">;</span>
	<span class="token comment">-- 查询女同学的总分数，为women赋值</span>
	<span class="token keyword">SELECT</span> <span class="token function">SUM</span><span class="token punctuation">(</span>score<span class="token punctuation">)</span> <span class="token keyword">INTO</span> women <span class="token keyword">FROM</span> student <span class="token keyword">WHERE</span> gender<span class="token operator">=</span><span class="token string">'女'</span><span class="token punctuation">;</span>
	<span class="token comment">-- 使用变量</span>
	<span class="token keyword">SELECT</span> men<span class="token punctuation">,</span>women<span class="token punctuation">;</span>
<span class="token keyword">END</span>$
<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
<span class="token comment">-- 调用存储过程</span>
<span class="token keyword">CALL</span> pro_test3<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<hr>
<h5 id="-92"><a class="markdownIt-Anchor" href="#-92">#</a> <a href="#if%E8%AF%AD%E5%8F%A5"></a>IF 语句</h5>
<ul>
<li>
<p>if 语句标准语法</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">IF</span> 判断条件<span class="token number">1</span> <span class="token keyword">THEN</span> 执行的<span class="token keyword">sql</span>语句<span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span><span class="token keyword">ELSEIF</span> 判断条件<span class="token number">2</span> <span class="token keyword">THEN</span> 执行的<span class="token keyword">sql</span>语句<span class="token number">2</span><span class="token punctuation">;</span><span class="token punctuation">]</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">[</span><span class="token keyword">ELSE</span> 执行的<span class="token keyword">sql</span>语句n<span class="token punctuation">;</span><span class="token punctuation">]</span>
<span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>数据准备：表 student</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">id	NAME	age		gender	score
<span class="token number">1</span>	张三		<span class="token number">23</span>		男		<span class="token number">95</span>
<span class="token number">2</span>	李四		<span class="token number">24</span>		男		<span class="token number">98</span>
<span class="token number">3</span>	王五		<span class="token number">25</span>		女		<span class="token number">100</span>
<span class="token number">4</span>	赵六		<span class="token number">26</span>		女		<span class="token number">90</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>根据总成绩判断：全班 380 分及以上学习优秀、320 ~ 380 学习良好、320 以下学习一般</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DELIMITER</span> $
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> pro_test4<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
	<span class="token keyword">DECLARE</span> total <span class="token keyword">INT</span><span class="token punctuation">;</span>							<span class="token comment">-- 定义总分数变量</span>
	<span class="token keyword">DECLARE</span> description <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">-- 定义分数描述变量</span>
	<span class="token keyword">SELECT</span> <span class="token function">SUM</span><span class="token punctuation">(</span>score<span class="token punctuation">)</span> <span class="token keyword">INTO</span> total <span class="token keyword">FROM</span> student<span class="token punctuation">;</span> 	<span class="token comment">-- 为总分数变量赋值</span>
	<span class="token comment">-- 判断总分数</span>
	<span class="token keyword">IF</span> total <span class="token operator">>=</span> <span class="token number">380</span> <span class="token keyword">THEN</span>
		<span class="token keyword">SET</span> description <span class="token operator">=</span> <span class="token string">'学习优秀'</span><span class="token punctuation">;</span>
	<span class="token keyword">ELSEIF</span> total <span class="token operator">>=</span><span class="token number">320</span> <span class="token operator">AND</span> total <span class="token operator">&lt;</span> <span class="token number">380</span> <span class="token keyword">THEN</span>
		<span class="token keyword">SET</span> description <span class="token operator">=</span> <span class="token string">'学习良好'</span><span class="token punctuation">;</span>
	<span class="token keyword">ELSE</span>
		<span class="token keyword">SET</span> description <span class="token operator">=</span> <span class="token string">'学习一般'</span><span class="token punctuation">;</span>
	<span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span>
<span class="token keyword">END</span>$
<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
<span class="token comment">-- 调用pro_test4存储过程</span>
<span class="token keyword">CALL</span> pro_test4<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<hr>
<h5 id="-93"><a class="markdownIt-Anchor" href="#-93">#</a> <a href="#%E5%8F%82%E6%95%B0%E4%BC%A0%E9%80%92"></a>参数传递</h5>
<ul>
<li>
<p>参数传递的语法</p>
<p>IN：代表输入参数，需要由调用者传递实际数据，默认的 OUT：代表输出参数，该参数可以作为返回值 INOUT：代表既可以作为输入参数，也可以作为输出参数</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DELIMITER</span> $

<span class="token comment">-- 标准语法</span>
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> 存储过程名称<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">IN</span><span class="token operator">|</span><span class="token keyword">OUT</span><span class="token operator">|</span><span class="token keyword">INOUT</span><span class="token punctuation">]</span> 参数名 数据类型<span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
	执行的<span class="token keyword">sql</span>语句<span class="token punctuation">;</span>
<span class="token keyword">END</span>$

<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>输入总成绩变量，代表学生总成绩，输出分数描述变量，代表学生总成绩的描述</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DELIMITER</span> $

<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> pro_test6<span class="token punctuation">(</span><span class="token operator">IN</span> total <span class="token keyword">INT</span><span class="token punctuation">,</span> <span class="token keyword">OUT</span> description <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
	<span class="token comment">-- 判断总分数</span>
	<span class="token keyword">IF</span> total <span class="token operator">>=</span> <span class="token number">380</span> <span class="token keyword">THEN</span> 
		<span class="token keyword">SET</span> description <span class="token operator">=</span> <span class="token string">'学习优秀'</span><span class="token punctuation">;</span>
	<span class="token keyword">ELSEIF</span> total <span class="token operator">>=</span> <span class="token number">320</span> <span class="token operator">AND</span> total <span class="token operator">&lt;</span> <span class="token number">380</span> <span class="token keyword">THEN</span> 
		<span class="token keyword">SET</span> description <span class="token operator">=</span> <span class="token string">'学习不错'</span><span class="token punctuation">;</span>
	<span class="token keyword">ELSE</span> 
		<span class="token keyword">SET</span> description <span class="token operator">=</span> <span class="token string">'学习一般'</span><span class="token punctuation">;</span>
	<span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span>
<span class="token keyword">END</span>$

<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
<span class="token comment">-- 调用pro_test6存储过程</span>
<span class="token keyword">CALL</span> pro_test6<span class="token punctuation">(</span><span class="token number">310</span><span class="token punctuation">,</span><span class="token variable">@description</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">CALL</span> pro_test6<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token function">SUM</span><span class="token punctuation">(</span>score<span class="token punctuation">)</span> <span class="token keyword">FROM</span> student<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">@description</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 查询总成绩描述</span>
<span class="token keyword">SELECT</span> <span class="token variable">@description</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>查看参数方法</p>
<ul>
<li>@变量名 : <strong>用户会话变量</strong>，代表整个会话过程他都是有作用的，类似于全局变量</li>
<li>@@变量名 : <strong>系统变量</strong></li>
</ul>
</li>
</ul>
<hr>
<h5 id="-94"><a class="markdownIt-Anchor" href="#-94">#</a> <a href="#case"></a>CASE</h5>
<ul>
<li>
<p>标准语法 1</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CASE</span> 表达式
    <span class="token keyword">WHEN</span> 值<span class="token number">1</span> <span class="token keyword">THEN</span> 执行<span class="token keyword">sql</span>语句<span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span><span class="token keyword">WHEN</span> 值<span class="token number">2</span> <span class="token keyword">THEN</span> 执行<span class="token keyword">sql</span>语句<span class="token number">2</span><span class="token punctuation">;</span><span class="token punctuation">]</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">[</span><span class="token keyword">ELSE</span> 执行<span class="token keyword">sql</span>语句n<span class="token punctuation">;</span><span class="token punctuation">]</span>
<span class="token keyword">END</span> <span class="token keyword">CASE</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>标准语法 2</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">sCASE
    <span class="token keyword">WHEN</span> 判断条件<span class="token number">1</span> <span class="token keyword">THEN</span> 执行<span class="token keyword">sql</span>语句<span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span><span class="token keyword">WHEN</span> 判断条件<span class="token number">2</span> <span class="token keyword">THEN</span> 执行<span class="token keyword">sql</span>语句<span class="token number">2</span><span class="token punctuation">;</span><span class="token punctuation">]</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">[</span><span class="token keyword">ELSE</span> 执行<span class="token keyword">sql</span>语句n<span class="token punctuation">;</span><span class="token punctuation">]</span>
<span class="token keyword">END</span> <span class="token keyword">CASE</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>演示</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DELIMITER</span> $
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> pro_test7<span class="token punctuation">(</span><span class="token operator">IN</span> total <span class="token keyword">INT</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
	<span class="token comment">-- 定义变量</span>
	<span class="token keyword">DECLARE</span> description <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">-- 使用case判断</span>
	<span class="token keyword">CASE</span>
	<span class="token keyword">WHEN</span> total <span class="token operator">>=</span> <span class="token number">380</span> <span class="token keyword">THEN</span>
		<span class="token keyword">SET</span> description <span class="token operator">=</span> <span class="token string">'学习优秀'</span><span class="token punctuation">;</span>
	<span class="token keyword">WHEN</span> total <span class="token operator">>=</span> <span class="token number">320</span> <span class="token operator">AND</span> total <span class="token operator">&lt;</span> <span class="token number">380</span> <span class="token keyword">THEN</span>
		<span class="token keyword">SET</span> description <span class="token operator">=</span> <span class="token string">'学习不错'</span><span class="token punctuation">;</span>
	<span class="token keyword">ELSE</span> 
		<span class="token keyword">SET</span> description <span class="token operator">=</span> <span class="token string">'学习一般'</span><span class="token punctuation">;</span>
	<span class="token keyword">END</span> <span class="token keyword">CASE</span><span class="token punctuation">;</span>
	
	<span class="token comment">-- 查询分数描述信息</span>
	<span class="token keyword">SELECT</span> description<span class="token punctuation">;</span>
<span class="token keyword">END</span>$
<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
<span class="token comment">-- 调用pro_test7存储过程</span>
<span class="token keyword">CALL</span> pro_test7<span class="token punctuation">(</span><span class="token number">390</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">CALL</span> pro_test7<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token function">SUM</span><span class="token punctuation">(</span>score<span class="token punctuation">)</span> <span class="token keyword">FROM</span> student<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<hr>
<h5 id="-95"><a class="markdownIt-Anchor" href="#-95">#</a> <a href="#while"></a>WHILE</h5>
<ul>
<li>
<p>while 循环语法</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">WHILE</span> 条件判断语句 <span class="token keyword">DO</span>
	循环体语句<span class="token punctuation">;</span>
	条件控制语句<span class="token punctuation">;</span>
<span class="token keyword">END</span> <span class="token keyword">WHILE</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>计算 1~100 之间的偶数和</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DELIMITER</span> $
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> pro_test6<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
	<span class="token comment">-- 定义求和变量</span>
	<span class="token keyword">DECLARE</span> result <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token comment">-- 定义初始化变量</span>
	<span class="token keyword">DECLARE</span> num <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token comment">-- while循环</span>
	<span class="token keyword">WHILE</span> num <span class="token operator">&lt;=</span> <span class="token number">100</span> <span class="token keyword">DO</span>
		<span class="token keyword">IF</span> num <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">=</span> <span class="token number">0</span> <span class="token keyword">THEN</span>
			<span class="token keyword">SET</span> result <span class="token operator">=</span> result <span class="token operator">+</span> num<span class="token punctuation">;</span>
		<span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span>
		<span class="token keyword">SET</span> num <span class="token operator">=</span> num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">END</span> <span class="token keyword">WHILE</span><span class="token punctuation">;</span>
	<span class="token comment">-- 查询求和结果</span>
	<span class="token keyword">SELECT</span> result<span class="token punctuation">;</span>
<span class="token keyword">END</span>$
<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>

<span class="token comment">-- 调用pro_test6存储过程</span>
<span class="token keyword">CALL</span> pro_test6<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<hr>
<h5 id="-96"><a class="markdownIt-Anchor" href="#-96">#</a> <a href="#repeat"></a>REPEAT</h5>
<ul>
<li>
<p>repeat 循环标准语法</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">初始化语句<span class="token punctuation">;</span>
<span class="token keyword">REPEAT</span>
	循环体语句<span class="token punctuation">;</span>
	条件控制语句<span class="token punctuation">;</span>
	UNTIL 条件判断语句
<span class="token keyword">END</span> <span class="token keyword">REPEAT</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>计算 1~10 之间的和</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DELIMITER</span> $
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> pro_test9<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
	<span class="token comment">-- 定义求和变量</span>
	<span class="token keyword">DECLARE</span> result <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token comment">-- 定义初始化变量</span>
	<span class="token keyword">DECLARE</span> num <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token comment">-- repeat循环</span>
	<span class="token keyword">REPEAT</span>
		<span class="token comment">-- 累加</span>
		<span class="token keyword">SET</span> result <span class="token operator">=</span> result <span class="token operator">+</span> num<span class="token punctuation">;</span>
		<span class="token comment">-- 让num+1</span>
		<span class="token keyword">SET</span> num <span class="token operator">=</span> num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token comment">-- 停止循环</span>
		UNTIL num <span class="token operator">></span> <span class="token number">10</span>
	<span class="token keyword">END</span> <span class="token keyword">REPEAT</span><span class="token punctuation">;</span>
	<span class="token comment">-- 查询求和结果</span>
	<span class="token keyword">SELECT</span> result<span class="token punctuation">;</span>
<span class="token keyword">END</span>$

<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
<span class="token comment">-- 调用pro_test9存储过程</span>
<span class="token keyword">CALL</span> pro_test9<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<hr>
<h5 id="-97"><a class="markdownIt-Anchor" href="#-97">#</a> <a href="#loop"></a>LOOP</h5>
<p>LOOP 实现简单的循环，退出循环的条件需要使用其他的语句定义，通常可以使用 LEAVE 语句实现，如果不加退出循环的语句，那么就变成了死循环</p>
<ul>
<li>
<p>loop 循环标准语法</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token punctuation">[</span>循环名称:<span class="token punctuation">]</span> <span class="token keyword">LOOP</span>
	条件判断语句
		<span class="token punctuation">[</span><span class="token keyword">LEAVE</span> 循环名称<span class="token punctuation">;</span><span class="token punctuation">]</span>
	循环体语句<span class="token punctuation">;</span>
	条件控制语句<span class="token punctuation">;</span>
<span class="token keyword">END</span> <span class="token keyword">LOOP</span> 循环名称<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>计算 1~10 之间的和</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DELIMITER</span> $
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> pro_test10<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
	<span class="token comment">-- 定义求和变量</span>
	<span class="token keyword">DECLARE</span> result <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token comment">-- 定义初始化变量</span>
	<span class="token keyword">DECLARE</span> num <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token comment">-- loop循环</span>
	l:<span class="token keyword">LOOP</span>
		<span class="token comment">-- 条件成立，停止循环</span>
		<span class="token keyword">IF</span> num <span class="token operator">></span> <span class="token number">10</span> <span class="token keyword">THEN</span>
			<span class="token keyword">LEAVE</span> l<span class="token punctuation">;</span>
		<span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span>
		<span class="token comment">-- 累加</span>
		<span class="token keyword">SET</span> result <span class="token operator">=</span> result <span class="token operator">+</span> num<span class="token punctuation">;</span>
		<span class="token comment">-- 让num+1</span>
		<span class="token keyword">SET</span> num <span class="token operator">=</span> num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">END</span> <span class="token keyword">LOOP</span> l<span class="token punctuation">;</span>
	<span class="token comment">-- 查询求和结果</span>
	<span class="token keyword">SELECT</span> result<span class="token punctuation">;</span>
<span class="token keyword">END</span>$
<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
<span class="token comment">-- 调用pro_test10存储过程</span>
<span class="token keyword">CALL</span> pro_test10<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<hr>
<h5 id="-98"><a class="markdownIt-Anchor" href="#-98">#</a> <a href="#%E6%B8%B8%E6%A0%87"></a>游标</h5>
<p>游标是用来存储查询结果集的数据类型，在存储过程和函数中可以使用光标对结果集进行循环的处理</p>
<ul>
<li>游标可以遍历返回的多行结果，每次拿到一整行数据</li>
<li>简单来说游标就类似于集合的迭代器遍历</li>
<li>MySQL 中的游标只能用在存储过程和函数中</li>
</ul>
<p>游标的语法</p>
<ul>
<li>
<p>创建游标</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DECLARE</span> 游标名称 <span class="token keyword">CURSOR</span> <span class="token keyword">FOR</span> 查询<span class="token keyword">sql</span>语句<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>打开游标</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">OPEN</span> 游标名称<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>使用游标获取数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">FETCH</span> 游标名称 <span class="token keyword">INTO</span> 变量名<span class="token number">1</span><span class="token punctuation">,</span>变量名<span class="token number">2</span><span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>关闭游标</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CLOSE</span> 游标名称<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>Mysql 通过一个 Error handler 声明来判断指针是否到尾部，并且必须和创建游标的 SQL 语句声明在一起：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DECLARE</span> <span class="token keyword">EXIT</span> <span class="token keyword">HANDLER</span> <span class="token keyword">FOR</span> <span class="token operator">NOT</span> FOUND <span class="token punctuation">(</span><span class="token keyword">do</span> <span class="token keyword">some</span> <span class="token keyword">action</span>，一般是设置标志变量<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<p>游标的基本使用</p>
<ul>
<li>
<p>数据准备：表 student</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">id	NAME	age		gender	score
<span class="token number">1</span>	张三		<span class="token number">23</span>		男		<span class="token number">95</span>
<span class="token number">2</span>	李四		<span class="token number">24</span>		男		<span class="token number">98</span>
<span class="token number">3</span>	王五		<span class="token number">25</span>		女		<span class="token number">100</span>
<span class="token number">4</span>	赵六		<span class="token number">26</span>		女		<span class="token number">90</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>创建 stu_score 表</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> stu_score<span class="token punctuation">(</span>
	id <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
	score <span class="token keyword">INT</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>将 student 表中所有的成绩保存到 stu_score 表中</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DELIMITER</span> $

<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> pro_test12<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
	<span class="token comment">-- 定义成绩变量</span>
	<span class="token keyword">DECLARE</span> s_score <span class="token keyword">INT</span><span class="token punctuation">;</span>
	<span class="token comment">-- 定义标记变量</span>
	<span class="token keyword">DECLARE</span> flag <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span>
	
	<span class="token comment">-- 创建游标，查询所有学生成绩数据</span>
	<span class="token keyword">DECLARE</span> stu_result <span class="token keyword">CURSOR</span> <span class="token keyword">FOR</span> <span class="token keyword">SELECT</span> score <span class="token keyword">FROM</span> student<span class="token punctuation">;</span>
	<span class="token comment">-- 游标结束后，将标记变量改为1  这两个必须声明在一起</span>
	<span class="token keyword">DECLARE</span> <span class="token keyword">EXIT</span> <span class="token keyword">HANDLER</span> <span class="token keyword">FOR</span> <span class="token operator">NOT</span> FOUND <span class="token keyword">SET</span> flag <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	
	<span class="token comment">-- 开启游标</span>
	<span class="token keyword">OPEN</span> stu_result<span class="token punctuation">;</span>
	<span class="token comment">-- 循环使用游标</span>
	<span class="token keyword">REPEAT</span>
		<span class="token comment">-- 使用游标，遍历结果,拿到数据</span>
		<span class="token keyword">FETCH</span> stu_result <span class="token keyword">INTO</span> s_score<span class="token punctuation">;</span>
		<span class="token comment">-- 将数据保存到stu_score表中</span>
		<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> stu_score <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span>s_score<span class="token punctuation">)</span><span class="token punctuation">;</span>
	UNTIL flag<span class="token operator">=</span><span class="token number">1</span>
	<span class="token keyword">END</span> <span class="token keyword">REPEAT</span><span class="token punctuation">;</span>
	<span class="token comment">-- 关闭游标</span>
	<span class="token keyword">CLOSE</span> stu_result<span class="token punctuation">;</span>
<span class="token keyword">END</span>$

<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>

<span class="token comment">-- 调用pro_test12存储过程</span>
<span class="token keyword">CALL</span> pro_test12<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 查询stu_score表</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> stu_score<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<hr>
<h4 id="-99"><a class="markdownIt-Anchor" href="#-99">#</a> <a href="#%E5%AD%98%E5%82%A8%E5%87%BD%E6%95%B0"></a>存储函数</h4>
<p>存储函数和存储过程是非常相似的，存储函数可以做的事情，存储过程也可以做到</p>
<p>存储函数有返回值，存储过程没有返回值（参数的 out 其实也相当于是返回数据了）</p>
<ul>
<li>
<p>创建存储函数</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DELIMITER</span> $
<span class="token comment">-- 标准语法</span>
<span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> 函数名称<span class="token punctuation">(</span>参数 数据类型<span class="token punctuation">)</span>
<span class="token keyword">RETURNS</span> 返回值类型
<span class="token keyword">BEGIN</span>
	执行的<span class="token keyword">sql</span>语句<span class="token punctuation">;</span>
	<span class="token keyword">RETURN</span> 结果<span class="token punctuation">;</span>
<span class="token keyword">END</span>$

<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>调用存储函数，因为有返回值，所以使用 SELECT 调用</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> 函数名称<span class="token punctuation">(</span>实际参数<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>删除存储函数</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">FUNCTION</span> 函数名称<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>定义存储函数，获取学生表中成绩大于 95 分的学生数量</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DELIMITER</span> $
<span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> fun_test<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">RETURN</span> <span class="token keyword">INT</span>
<span class="token keyword">BEGIN</span>
	<span class="token comment">-- 定义统计变量</span>
	<span class="token keyword">DECLARE</span> result <span class="token keyword">INT</span><span class="token punctuation">;</span>
	<span class="token comment">-- 查询成绩大于95分的学生数量，给统计变量赋值</span>
	<span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span>score<span class="token punctuation">)</span> <span class="token keyword">INTO</span> result <span class="token keyword">FROM</span> student <span class="token keyword">WHERE</span> score <span class="token operator">></span> <span class="token number">95</span><span class="token punctuation">;</span>
	<span class="token comment">-- 返回统计结果</span>
	<span class="token keyword">SELECT</span> result<span class="token punctuation">;</span>
<span class="token keyword">END</span>
<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
<span class="token comment">-- 调用fun_test存储函数</span>
<span class="token keyword">SELECT</span> fun_test<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<hr>
<h3 id="-100"><a class="markdownIt-Anchor" href="#-100">#</a> <a href="#%E8%A7%A6%E5%8F%91%E5%99%A8"></a>触发器</h3>
<h4 id="-101"><a class="markdownIt-Anchor" href="#-101">#</a> <a href="#%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D-2"></a>基本介绍</h4>
<p>触发器是与表有关的数据库对象，在 insert/update/delete 之前或之后触发并执行触发器中定义的 SQL 语句</p>
<ul>
<li>
<p>触发器的这种特性可以协助应用在数据库端确保数据的完整性 、日志记录 、数据校验等操作</p>
</li>
<li>
<p>使用别名 NEW 和 OLD 来引用触发器中发生变化的记录内容，这与其他的数据库是相似的</p>
</li>
<li>
<p>现在触发器还只支持行级触发，不支持语句级触发</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>触发器类型</th>
<th>OLD 的含义</th>
<th>NEW 的含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>INSERT 型触发器</td>
<td>无 (因为插入前状态无数据)</td>
<td>NEW 表示将要或者已经新增的数据</td>
</tr>
<tr>
<td>UPDATE 型触发器</td>
<td>OLD 表示修改之前的数据</td>
<td>NEW 表示将要或已经修改后的数据</td>
</tr>
<tr>
<td>DELETE 型触发器</td>
<td>OLD 表示将要或者已经删除的数据</td>
<td>无 (因为删除后状态无数据)</td>
</tr>
</tbody>
</table>
<hr>
<h4 id="-102"><a class="markdownIt-Anchor" href="#-102">#</a> <a href="#%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C-1"></a>基本操作</h4>
<ul>
<li>
<p>创建触发器</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DELIMITER</span> $

<span class="token keyword">CREATE</span> <span class="token keyword">TRIGGER</span> 触发器名称
BEFORE<span class="token operator">|</span><span class="token keyword">AFTER</span>  <span class="token keyword">INSERT</span><span class="token operator">|</span><span class="token keyword">UPDATE</span><span class="token operator">|</span><span class="token keyword">DELETE</span>
<span class="token keyword">ON</span> 表名
<span class="token punctuation">[</span><span class="token keyword">FOR EACH ROW</span><span class="token punctuation">]</span>  <span class="token comment">-- 行级触发器</span>
<span class="token keyword">BEGIN</span>
	触发器要执行的功能<span class="token punctuation">;</span>
<span class="token keyword">END</span>$

<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>查看触发器的状态、语法等信息</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SHOW</span> TRIGGERS<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>删除触发器，如果没有指定 schema_name，默认为当前数据库</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TRIGGER</span> <span class="token punctuation">[</span>schema_name<span class="token punctuation">.</span><span class="token punctuation">]</span>trigger_name<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<hr>
<h4 id="-103"><a class="markdownIt-Anchor" href="#-103">#</a> <a href="#%E8%A7%A6%E5%8F%91%E6%BC%94%E7%A4%BA"></a>触发演示</h4>
<p>通过触发器记录账户表的数据变更日志。包含：增加、修改、删除</p>
<ul>
<li>
<p>数据准备</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 创建db9数据库</span>
<span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> db9<span class="token punctuation">;</span>
<span class="token comment">-- 使用db9数据库</span>
<span class="token keyword">USE</span> db9<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 创建账户表account</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> account<span class="token punctuation">(</span>
	id <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>	<span class="token comment">-- 账户id</span>
	NAME <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>					<span class="token comment">-- 姓名</span>
	money <span class="token keyword">DOUBLE</span>						<span class="token comment">-- 余额</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 添加数据</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> account <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'张三'</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'李四'</span><span class="token punctuation">,</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 创建日志表account_log</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> account_log<span class="token punctuation">(</span>
	id <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>	<span class="token comment">-- 日志id</span>
	operation <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>				<span class="token comment">-- 操作类型 (insert update delete)</span>
	operation_time <span class="token keyword">DATETIME</span><span class="token punctuation">,</span>			<span class="token comment">-- 操作时间</span>
	operation_id <span class="token keyword">INT</span><span class="token punctuation">,</span>					<span class="token comment">-- 操作表的id</span>
	operation_params <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>       <span class="token comment">-- 操作参数</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>创建 INSERT 型触发器</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DELIMITER</span> $

<span class="token keyword">CREATE</span> <span class="token keyword">TRIGGER</span> account_insert
<span class="token keyword">AFTER</span> <span class="token keyword">INSERT</span>
<span class="token keyword">ON</span> account
<span class="token keyword">FOR EACH ROW</span>
<span class="token keyword">BEGIN</span>
	<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> account_log <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'INSERT'</span><span class="token punctuation">,</span><span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>new<span class="token punctuation">.</span>id<span class="token punctuation">,</span>CONCAT<span class="token punctuation">(</span><span class="token string">'插入后&#123;id='</span><span class="token punctuation">,</span>new<span class="token punctuation">.</span>id<span class="token punctuation">,</span><span class="token string">',name='</span><span class="token punctuation">,</span>new<span class="token punctuation">.</span>name<span class="token punctuation">,</span><span class="token string">',money='</span><span class="token punctuation">,</span>new<span class="token punctuation">.</span>money<span class="token punctuation">,</span><span class="token string">'&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">END</span>$

<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 向account表添加记录</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> account <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'王五'</span><span class="token punctuation">,</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 查询日志表</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> account_log<span class="token punctuation">;</span>
<span class="token comment">/*
id	operation	operation_time		operation_id	operation_params
1	INSERT	   	2021-01-26 19:51:11		3	     插入后&#123;id=3,name=王五money=2000&#125;
*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>创建 UPDATE 型触发器</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DELIMITER</span> $

<span class="token keyword">CREATE</span> <span class="token keyword">TRIGGER</span> account_update
<span class="token keyword">AFTER</span> <span class="token keyword">UPDATE</span>
<span class="token keyword">ON</span> account
<span class="token keyword">FOR EACH ROW</span>
<span class="token keyword">BEGIN</span>
	<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> account_log <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'UPDATE'</span><span class="token punctuation">,</span><span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>new<span class="token punctuation">.</span>id<span class="token punctuation">,</span>CONCAT<span class="token punctuation">(</span><span class="token string">'修改前&#123;id='</span><span class="token punctuation">,</span>old<span class="token punctuation">.</span>id<span class="token punctuation">,</span><span class="token string">',name='</span><span class="token punctuation">,</span>old<span class="token punctuation">.</span>name<span class="token punctuation">,</span><span class="token string">',money='</span><span class="token punctuation">,</span>old<span class="token punctuation">.</span>money<span class="token punctuation">,</span><span class="token string">'&#125;'</span><span class="token punctuation">,</span><span class="token string">'修改后&#123;id='</span><span class="token punctuation">,</span>new<span class="token punctuation">.</span>id<span class="token punctuation">,</span><span class="token string">',name='</span><span class="token punctuation">,</span>new<span class="token punctuation">.</span>name<span class="token punctuation">,</span><span class="token string">',money='</span><span class="token punctuation">,</span>new<span class="token punctuation">.</span>money<span class="token punctuation">,</span><span class="token string">'&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">END</span>$

<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 修改account表</span>
<span class="token keyword">UPDATE</span> account <span class="token keyword">SET</span> money<span class="token operator">=</span><span class="token number">3500</span> <span class="token keyword">WHERE</span> id<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span>

<span class="token comment">-- 查询日志表</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> account_log<span class="token punctuation">;</span>
<span class="token comment">/*
id	operation	operation_time		operation_id	  operation_params
2	UPDATE	   	2021-01-26 19:58:54		2		 更新前&#123;id=2,name=李四money=1000&#125;
												 更新后&#123;id=2,name=李四money=200&#125;
*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>创建 DELETE 型触发器</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DELIMITER</span> $

<span class="token keyword">CREATE</span> <span class="token keyword">TRIGGER</span> account_delete
<span class="token keyword">AFTER</span> <span class="token keyword">DELETE</span>
<span class="token keyword">ON</span> account
<span class="token keyword">FOR EACH ROW</span>
<span class="token keyword">BEGIN</span>
	<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> account_log <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'DELETE'</span><span class="token punctuation">,</span><span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>old<span class="token punctuation">.</span>id<span class="token punctuation">,</span>CONCAT<span class="token punctuation">(</span><span class="token string">'删除前&#123;id='</span><span class="token punctuation">,</span>old<span class="token punctuation">.</span>id<span class="token punctuation">,</span><span class="token string">',name='</span><span class="token punctuation">,</span>old<span class="token punctuation">.</span>name<span class="token punctuation">,</span><span class="token string">',money='</span><span class="token punctuation">,</span>old<span class="token punctuation">.</span>money<span class="token punctuation">,</span><span class="token string">'&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">END</span>$

<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 删除account表数据</span>
<span class="token keyword">DELETE</span> <span class="token keyword">FROM</span> account <span class="token keyword">WHERE</span> id<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span>

<span class="token comment">-- 查询日志表</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> account_log<span class="token punctuation">;</span>
<span class="token comment">/*
id	operation	operation_time		operation_id	operation_params
3	DELETE		2021-01-26 20:02:48		3	    删除前&#123;id=3,name=王五money=2000&#125;
*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<hr>
<h2 id="-104"><a class="markdownIt-Anchor" href="#-104">#</a> <a href="#%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E"></a>存储引擎</h2>
<h3 id="-105"><a class="markdownIt-Anchor" href="#-105">#</a> <a href="#%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D-3"></a>基本介绍</h3>
<p>对比其他数据库，MySQL 的架构可以在不同场景应用并发挥良好作用，主要体现在存储引擎，插件式的存储引擎架构将查询处理和其他的系统任务以及数据的存储提取分离，可以针对不同的存储需求可以选择最优的存储引擎</p>
<p>存储引擎的介绍：</p>
<ul>
<li>MySQL 数据库使用不同的机制存取表文件，机制的差别在于不同的存储方式、索引技巧、锁定水平等不同的功能和能力，在 MySQL 中，将这些不同的技术及配套的功能称为存储引擎</li>
<li>Oracle、SqlServer 等数据库只有一种存储引擎，MySQL <strong>提供了插件式的存储引擎架构</strong>，所以 MySQL 存在多种存储引擎，就会让数据库采取了不同的处理数据的方式和扩展功能</li>
<li>在关系型数据库中数据的存储是以表的形式存进行，所以存储引擎也称为表类型（存储和操作此表的类型）</li>
<li>通过选择不同的引擎，能够获取最佳的方案，也能够获得额外的速度或者功能，提高程序的整体效果。</li>
</ul>
<p>MySQL 支持的存储引擎：</p>
<ul>
<li>MySQL 支持的引擎包括：InnoDB、MyISAM、MEMORY、Archive、Federate、CSV、BLACKHOLE 等</li>
<li>MySQL5.5 之前的默认存储引擎是 MyISAM，5.5 之后就改为了 InnoDB</li>
</ul>
<hr>
<h3 id="-106"><a class="markdownIt-Anchor" href="#-106">#</a> <a href="#%E5%BC%95%E6%93%8E%E5%AF%B9%E6%AF%94"></a>引擎对比</h3>
<p>MyISAM 存储引擎：</p>
<ul>
<li>特点：不支持事务和外键，读取速度快，节约资源</li>
<li>应用场景：查询和插入操作为主，只有很少更新和删除操作，并对事务的完整性、并发性要求不高</li>
<li>存储方式：
<ul>
<li>每个 MyISAM 在磁盘上存储成 3 个文件，其文件名都和表名相同，拓展名不同</li>
<li>表的定义保存在 .frm 文件，表数据保存在 .MYD (MYData) 文件中，索引保存在 .MYI (MYIndex) 文件中</li>
</ul>
</li>
</ul>
<p>InnoDB 存储引擎：(MySQL5.5 版本后默认的存储引擎)</p>
<ul>
<li>特点：<strong>支持事务</strong>和外键操作，支持并发控制。对比 MyISAM 的存储引擎，InnoDB 写的处理效率差一些，并且会占用更多的磁盘空间以保留数据和索引</li>
<li>应用场景：对事务的完整性有比较高的要求，在并发条件下要求数据的一致性，读写频繁的操作</li>
<li>存储方式：
<ul>
<li>使用共享表空间存储， 这种方式创建的表的表结构保存在 .frm 文件中， 数据和索引保存在 innodb_data_home_dir 和 innodb_data_file_path 定义的表空间中，可以是多个文件</li>
<li>使用多表空间存储，创建的表的表结构存在 .frm 文件中，每个表的数据和索引单独保存在 .ibd 中</li>
</ul>
</li>
</ul>
<p>MEMORY 存储引擎：</p>
<ul>
<li>特点：每个 MEMORY 表实际对应一个磁盘文件 ，该文件中只存储表的结构，表数据保存在内存中，且默认使用 HASH 索引，这样有利于数据的快速处理，在需要快速定位记录可以提供更快的访问，但是服务一旦关闭，表中的数据就会丢失，数据存储不安全</li>
<li>应用场景：通常用于更新不太频繁的小表，用以快速得到访问结果，类似缓存</li>
<li>存储方式：表结构保存在 .frm 中</li>
</ul>
<p>MERGE 存储引擎：</p>
<ul>
<li>
<p>特点：</p>
<ul>
<li>是一组 MyISAM 表的组合，这些 MyISAM 表必须结构完全相同，通过将不同的表分布在多个磁盘上</li>
<li>MERGE 表本身并没有存储数据，对 MERGE 类型的表可以进行查询、更新、删除操作，这些操作实际上是对内部的 MyISAM 表进行的</li>
</ul>
</li>
<li>
<p>应用场景：将一系列等同的 MyISAM 表以逻辑方式组合在一起，并作为一个对象引用他们，适合做数据仓库</p>
</li>
<li>
<p>操作方式：</p>
<ul>
<li>插入操作是通过 INSERT_METHOD 子句定义插入的表，使用 FIRST 或 LAST 值使得插入操作被相应地作用在第一或者最后一个表上；不定义这个子句或者定义为 NO，表示不能对 MERGE 表执行插入操作</li>
<li>对 MERGE 表进行 DROP 操作，但是这个操作只是删除 MERGE 表的定义，对内部的表是没有任何影响的</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> order_1<span class="token punctuation">(</span>
<span class="token punctuation">)</span><span class="token keyword">ENGINE</span> <span class="token operator">=</span> MyISAM <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> order_2<span class="token punctuation">(</span>
<span class="token punctuation">)</span><span class="token keyword">ENGINE</span> <span class="token operator">=</span> MyISAM <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> order_all<span class="token punctuation">(</span>
	<span class="token comment">-- 结构与MyISAM表相同</span>
<span class="token punctuation">)</span><span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">MERGE</span> <span class="token keyword">UNION</span> <span class="token operator">=</span> <span class="token punctuation">(</span>order_1<span class="token punctuation">,</span>order_2<span class="token punctuation">)</span> INSERT_METHOD<span class="token operator">=</span><span class="token keyword">LAST</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d4d455247452e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/64fb2b6344d7b0c10d9010c02b6f727c5ae4872fef4b23be41b5a34d6d19c869/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d4d455247452e706e67">https://camo.githubusercontent.com/64fb2b6344d7b0c10d9010c02b6f727c5ae4872fef4b23be41b5a34d6d19c869/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d4d455247452e706e67</a>)</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>特性</th>
<th>MyISAM</th>
<th>InnoDB</th>
<th>MEMORY</th>
</tr>
</thead>
<tbody>
<tr>
<td>存储限制</td>
<td>有 (平台对文件系统大小的限制)</td>
<td>64TB</td>
<td>有 (平台的内存限制)</td>
</tr>
<tr>
<td><strong>事务安全</strong></td>
<td><strong>不支持</strong></td>
<td><strong>支持</strong></td>
<td><strong>不支持</strong></td>
</tr>
<tr>
<td><strong>锁机制</strong></td>
<td><strong>表锁</strong></td>
<td><strong>表锁 / 行锁</strong></td>
<td><strong>表锁</strong></td>
</tr>
<tr>
<td>B+Tree 索引</td>
<td>支持</td>
<td>支持</td>
<td>支持</td>
</tr>
<tr>
<td>哈希索引</td>
<td>不支持</td>
<td>不支持</td>
<td>支持</td>
</tr>
<tr>
<td>全文索引</td>
<td>支持</td>
<td>支持</td>
<td>不支持</td>
</tr>
<tr>
<td>集群索引</td>
<td>不支持</td>
<td>支持</td>
<td>不支持</td>
</tr>
<tr>
<td>数据索引</td>
<td>不支持</td>
<td>支持</td>
<td>支持</td>
</tr>
<tr>
<td>数据缓存</td>
<td>不支持</td>
<td>支持</td>
<td>N/A</td>
</tr>
<tr>
<td>索引缓存</td>
<td>支持</td>
<td>支持</td>
<td>N/A</td>
</tr>
<tr>
<td>数据可压缩</td>
<td>支持</td>
<td>不支持</td>
<td>不支持</td>
</tr>
<tr>
<td>空间使用</td>
<td>低</td>
<td>高</td>
<td>N/A</td>
</tr>
<tr>
<td>内存使用</td>
<td>低</td>
<td>高</td>
<td>中等</td>
</tr>
<tr>
<td>批量插入速度</td>
<td>高</td>
<td>低</td>
<td>高</td>
</tr>
<tr>
<td><strong>外键</strong></td>
<td><strong>不支持</strong></td>
<td><strong>支持</strong></td>
<td><strong>不支持</strong></td>
</tr>
</tbody>
</table>
<p>面试问题：MyIsam 和 InnoDB 的区别？</p>
<ul>
<li>
<p>事务：InnoDB 支持事务，MyISAM 不支持事务</p>
</li>
<li>
<p>外键：InnoDB 支持外键，MyISAM 不支持外键</p>
</li>
<li>
<p>索引：InnoDB 是聚集（聚簇）索引，MyISAM 是非聚集（非聚簇）索引</p>
</li>
<li>
<p>锁粒度：InnoDB 最小的锁粒度是行锁，MyISAM 最小的锁粒度是表锁</p>
</li>
<li>
<p>存储结构：参考本节上半部分</p>
</li>
</ul>
<hr>
<h3 id="-107"><a class="markdownIt-Anchor" href="#-107">#</a> <a href="#%E5%BC%95%E6%93%8E%E6%93%8D%E4%BD%9C"></a>引擎操作</h3>
<ul>
<li>
<p>查询数据库支持的存储引擎</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SHOW</span> ENGINES<span class="token punctuation">;</span>
<span class="token keyword">SHOW</span> VARIABLES <span class="token operator">LIKE</span> <span class="token string">'%storage_engine%'</span><span class="token punctuation">;</span> <span class="token comment">-- 查看Mysql数据库默认的存储引擎 </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li>
<p>查询某个数据库中所有数据表的存储引擎</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SHOW</span> <span class="token keyword">TABLE</span> <span class="token keyword">STATUS</span> <span class="token keyword">FROM</span> 数据库名称<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>查询某个数据库中某个数据表的存储引擎</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SHOW</span> <span class="token keyword">TABLE</span> <span class="token keyword">STATUS</span> <span class="token keyword">FROM</span> 数据库名称 <span class="token keyword">WHERE</span> NAME <span class="token operator">=</span> <span class="token string">'数据表名称'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>创建数据表，指定存储引擎</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> 表名<span class="token punctuation">(</span>
	列名<span class="token punctuation">,</span>数据类型<span class="token punctuation">,</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">)</span><span class="token keyword">ENGINE</span> <span class="token operator">=</span> 引擎名称<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>修改数据表的存储引擎</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> 表名 <span class="token keyword">ENGINE</span> <span class="token operator">=</span> 引擎名称<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<hr>
<h2 id="-108"><a class="markdownIt-Anchor" href="#-108">#</a> <a href="#%E7%B4%A2%E5%BC%95%E6%9C%BA%E5%88%B6"></a>索引机制</h2>
<h3 id="-109"><a class="markdownIt-Anchor" href="#-109">#</a> <a href="#%E7%B4%A2%E5%BC%95%E4%BB%8B%E7%BB%8D"></a>索引介绍</h3>
<h4 id="-110"><a class="markdownIt-Anchor" href="#-110">#</a> <a href="#%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D-4"></a>基本介绍</h4>
<p>MySQL 官方对索引的定义为：索引（index）是帮助 MySQL 高效获取数据的一种数据结构，** 本质是排好序的快速查找数据结构。** 在表数据之外，数据库系统还维护着满足特定查找算法的数据结构，这些数据结构以某种方式指向数据， 这样就可以在这些数据结构上实现高级查找算法，这种数据结构就是索引。</p>
<p><strong>索引是在存储引擎层实现的</strong>，所以并没有统一的索引标准，即不同存储引擎的索引的工作方式并不一样</p>
<p>索引使用：一张数据表，用于保存数据；一个索引配置文件，用于保存索引；每个索引都指向了某一个数据 [<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/66094f87a8751b5f2423ca5ca03608bdb0f8a7647ca4b87f1c75abaa554832d7/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d2545372542342541322545352542432539352545372539412538342545342542422538422545372542422538442e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/66094f87a8751b5f2423ca5ca03608bdb0f8a7647ca4b87f1c75abaa554832d7/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d2545372542342541322545352542432539352545372539412538342545342542422538422545372542422538442e706e67">https://camo.githubusercontent.com/66094f87a8751b5f2423ca5ca03608bdb0f8a7647ca4b87f1c75abaa554832d7/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d2545372542342541322545352542432539352545372539412538342545342542422538422545372542422538442e706e67</a>)</p>
<p>左边是数据表，一共有两列七条记录，最左边的是数据记录的物理地址（注意逻辑上相邻的记录在磁盘上也并不是一定物理相邻的）。为了加快 Col2 的查找，可以维护一个右边所示的二叉查找树，每个节点分别包含索引键值和一个指向对应数据的物理地址的指针，这样就可以运用二叉查找快速获取到相应数据</p>
<p>索引的优点：</p>
<ul>
<li>类似于书籍的目录索引，提高数据检索的效率，降低数据库的 IO 成本</li>
<li>通过索引列对数据进行排序，降低数据排序的成本，降低 CPU 的消耗</li>
</ul>
<p>索引的缺点：</p>
<ul>
<li>一般来说索引本身也很大，不可能全部存储在内存中，因此索引往往以索引文件的形式<strong>存储在磁盘</strong>上</li>
<li>虽然索引大大提高了查询效率，同时却也降低更新表的速度。对表进行 INSERT、UPDATE、DELETE 操作，MySQL 不仅要保存数据，还要保存一下索引文件每次更新添加了索引列的字段，还会调整因为更新所带来的键值变化后的索引信息，<strong>但是更新数据也需要先从数据库中获取</strong>，索引加快了获取速度，所以可以相互抵消一下。</li>
<li>索引会影响到 WHERE 的查询条件和排序 ORDER BY 两大功能</li>
</ul>
<hr>
<h4 id="-111"><a class="markdownIt-Anchor" href="#-111">#</a> <a href="#%E7%B4%A2%E5%BC%95%E5%88%86%E7%B1%BB"></a>索引分类</h4>
<p>索引一般的分类如下：</p>
<ul>
<li>
<p>功能分类</p>
<ul>
<li>主键索引：一种特殊的唯一索引，不允许有空值，一般在建表时同时创建主键索引</li>
<li>单列索引：一个索引只包含单个列，一个表可以有多个单列索引（普通索引）</li>
<li>联合索引：顾名思义，就是将单列索引进行组合</li>
<li>唯一索引：索引列的值必须唯一，<strong>允许有空值</strong>，如果是联合索引，则列值组合必须唯一
<ul>
<li>NULL 值可以出现多次，因为两个 NULL 比较的结果既不相等，也不不等，结果仍然是未知</li>
<li>可以声明不允许存储 NULL 值的非空唯一索引</li>
</ul>
</li>
<li>外键索引：只有 InnoDB 引擎支持外键索引，用来保证数据的一致性、完整性和实现级联操作</li>
</ul>
</li>
<li>
<p>结构分类</p>
<ul>
<li>BTree 索引：MySQL 使用最频繁的一个索引数据结构，是 InnoDB 和 MyISAM 存储引擎默认的索引类型，底层基于 B+Tree</li>
<li>Hash 索引：MySQL 中 Memory 存储引擎默认支持的索引类型</li>
<li>R-tree 索引（空间索引）：空间索引是 MyISAM 引擎的一个特殊索引类型，主要用于地理空间数据类型</li>
<li>Full-text 索引（全文索引）：快速匹配全部文档的方式。MyISAM 支持， InnoDB 不支持 FULLTEXT 类型的索引，但是 InnoDB 可以使用 sphinx 插件支持全文索引，MEMORY 引擎不支持</li>
</ul>
<table>
<thead>
<tr>
<th>引</th>
<th>InnoDB</th>
<th>MyISAM</th>
<th>Memory</th>
</tr>
</thead>
<tbody>
<tr>
<td>TREE</td>
<td>支持</td>
<td>支持</td>
<td>支持</td>
</tr>
<tr>
<td>ASH</td>
<td>不支持</td>
<td>不支持</td>
<td>支持</td>
</tr>
<tr>
<td>-tree</td>
<td>不支持</td>
<td>支持</td>
<td>不支持</td>
</tr>
<tr>
<td>ull-text</td>
<td>5.6 版本之后支持</td>
<td>支持</td>
<td>不支持</td>
</tr>
</tbody>
</table>
</li>
</ul>
<p>联合索引图示：根据身高年龄建立的组合索引（height,age）</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/d473635370714afbc238d105508ef200d61e83fd2a392e89401e585bd6fd1350/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d2545372542422538342545352539302538382545372542342541322545352542432539352545352539422542452e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/d473635370714afbc238d105508ef200d61e83fd2a392e89401e585bd6fd1350/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d2545372542422538342545352539302538382545372542342541322545352542432539352545352539422542452e706e67">https://camo.githubusercontent.com/d473635370714afbc238d105508ef200d61e83fd2a392e89401e585bd6fd1350/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d2545372542422538342545352539302538382545372542342541322545352542432539352545352539422542452e706e67</a>)</p>
<hr>
<h3 id="-112"><a class="markdownIt-Anchor" href="#-112">#</a> <a href="#%E7%B4%A2%E5%BC%95%E6%93%8D%E4%BD%9C"></a>索引操作</h3>
<p>索引在创建表的时候可以同时创建， 也可以随时增加新的索引</p>
<ul>
<li>
<p>创建索引：如果一个表中有一列是主键，那么会<strong>默认为其创建主键索引</strong>（主键列不需要单独创建索引）</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token punctuation">[</span><span class="token keyword">UNIQUE</span><span class="token operator">|</span>FULLTEXT<span class="token punctuation">]</span> <span class="token keyword">INDEX</span> 索引名称 <span class="token punctuation">[</span><span class="token keyword">USING</span> 索引类型<span class="token punctuation">]</span> <span class="token keyword">ON</span> 表名<span class="token punctuation">(</span>列名<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 索引类型默认是 B+TREE</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li>
<p>查看索引</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SHOW</span> <span class="token keyword">INDEX</span> <span class="token keyword">FROM</span> 表名<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>添加索引</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 单列索引</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> 表名 <span class="token keyword">ADD</span> <span class="token keyword">INDEX</span> 索引名称<span class="token punctuation">(</span>列名<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 组合索引</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> 表名 <span class="token keyword">ADD</span> <span class="token keyword">INDEX</span> 索引名称<span class="token punctuation">(</span>列名<span class="token number">1</span><span class="token punctuation">,</span>列名<span class="token number">2</span><span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 主键索引</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> 表名 <span class="token keyword">ADD</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">(</span>主键列名<span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token comment">-- 外键索引(添加外键约束，就是外键索引)</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> 表名 <span class="token keyword">ADD</span> <span class="token keyword">CONSTRAINT</span> 外键名 <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>本表外键列名<span class="token punctuation">)</span> <span class="token keyword">REFERENCES</span> 主表名<span class="token punctuation">(</span>主键列名<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 唯一索引</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> 表名 <span class="token keyword">ADD</span> <span class="token keyword">UNIQUE</span> 索引名称<span class="token punctuation">(</span>列名<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 全文索引(mysql只支持文本类型)</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> 表名 <span class="token keyword">ADD</span> FULLTEXT 索引名称<span class="token punctuation">(</span>列名<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>删除索引</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">INDEX</span> 索引名称 <span class="token keyword">ON</span> 表名<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>案例练习</p>
<p>数据准备：student</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">id	NAME	 age	score
<span class="token number">1</span>	张三		<span class="token number">23</span>		<span class="token number">99</span>
<span class="token number">2</span>	李四		<span class="token number">24</span>		<span class="token number">95</span>
<span class="token number">3</span>	王五		<span class="token number">25</span>		<span class="token number">98</span>
<span class="token number">4</span>	赵六		<span class="token number">26</span>		<span class="token number">97</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>索引操作：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 为student表中姓名列创建一个普通索引</span>
<span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_name <span class="token keyword">ON</span> student<span class="token punctuation">(</span>NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 为student表中年龄列创建一个唯一索引</span>
<span class="token keyword">CREATE</span> <span class="token keyword">UNIQUE</span> <span class="token keyword">INDEX</span> idx_age <span class="token keyword">ON</span> student<span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<hr>
<h3 id="-113"><a class="markdownIt-Anchor" href="#-113">#</a> <a href="#%E8%81%9A%E7%B0%87%E7%B4%A2%E5%BC%95"></a>聚簇索引</h3>
<h4 id="-114"><a class="markdownIt-Anchor" href="#-114">#</a> <a href="#%E7%B4%A2%E5%BC%95%E5%AF%B9%E6%AF%94"></a>索引对比</h4>
<p>聚簇索引是一种数据存储方式，并不是一种单独的索引类型</p>
<ul>
<li>
<p>聚簇索引的叶子节点存放的是主键值和数据行，支持覆盖索引</p>
</li>
<li>
<p>非聚簇索引的叶子节点存放的是主键值或指向数据行的指针（由存储引擎决定）</p>
</li>
</ul>
<p>在 Innodb 下主键索引是聚簇索引，在 MyISAM 下主键索引是非聚簇索引</p>
<hr>
<h4 id="-115"><a class="markdownIt-Anchor" href="#-115">#</a> <a href="#innodb"></a>Innodb</h4>
<h5 id="-116"><a class="markdownIt-Anchor" href="#-116">#</a> <a href="#%E8%81%9A%E7%B0%87%E7%B4%A2%E5%BC%95-1"></a>聚簇索引</h5>
<p>在 Innodb 存储引擎，B+ 树索引可以分为聚簇索引（也称聚集索引、clustered index）和辅助索引（也称非聚簇索引或二级索引、secondary index、non-clustered index）</p>
<p>InnoDB 中，聚簇索引是按照每张表的主键构造一颗 B+ 树，叶子节点中存放的就是整张表的数据，将聚簇索引的叶子节点称为数据页</p>
<ul>
<li>这个特性决定了<strong>数据也是索引的一部分</strong>，所以一张表只能有一个聚簇索引</li>
<li>辅助索引的存在不影响聚簇索引中数据的组织，所以一张表可以有多个辅助索引</li>
</ul>
<p>聚簇索引的优点：</p>
<ul>
<li>数据访问更快，聚簇索引将索引和数据保存在同一个 B+ 树中，因此从聚簇索引中获取数据比非聚簇索引更快</li>
<li>聚簇索引对于主键的排序查找和范围查找速度非常快</li>
</ul>
<p>聚簇索引的缺点：</p>
<ul>
<li>
<p>插入速度严重依赖于插入顺序，按照主键的顺序（递增）插入是最快的方式，否则将会出现页分裂，严重影响性能，所以对于 InnoDB 表，一般都会定义一个自增的 ID 列为主键</p>
</li>
<li>
<p>更新主键的代价很高，将会导致被更新的行移动，所以对于 InnoDB 表，一般定义主键为不可更新</p>
</li>
<li>
<p>二级索引访问需要两次索引查找，第一次找到主键值，第二次根据主键值找到行数据</p>
</li>
</ul>
<hr>
<h5 id="-117"><a class="markdownIt-Anchor" href="#-117">#</a> <a href="#%E8%BE%85%E5%8A%A9%E7%B4%A2%E5%BC%95"></a>辅助索引</h5>
<p>在聚簇索引之上创建的索引称之为辅助索引，非聚簇索引都是辅助索引，像复合索引、前缀索引、唯一索引等</p>
<p>辅助索引叶子节点存储的是主键值，而不是数据的物理地址，所以访问数据需要二次查找，推荐使用覆盖索引，可以减少回表查询</p>
<p><strong>检索过程</strong>：辅助索引找到主键值，再通过聚簇索引（二分）找到数据页，最后通过数据页中的 Page Directory（二分）找到对应的数据分组，遍历组内所所有的数据找到数据行</p>
<p>补充：无索引走全表查询，查到数据页后和上述步骤一致</p>
<hr>
<h5 id="-118"><a class="markdownIt-Anchor" href="#-118">#</a> <a href="#%E7%B4%A2%E5%BC%95%E5%AE%9E%E7%8E%B0"></a>索引实现</h5>
<p>InnoDB 使用 B+Tree 作为索引结构，并且 InnoDB 一定有索引</p>
<p>主键索引：</p>
<ul>
<li>
<p>在 InnoDB 中，表数据文件本身就是按 B+Tree 组织的一个索引结构，这个索引的 key 是数据表的主键，叶子节点 data 域保存了完整的数据记录</p>
</li>
<li>
<p>InnoDB 的表数据文件<strong>通过主键聚集数据</strong>，如果没有定义主键，会选择非空唯一索引代替，如果也没有这样的列，MySQL 会自动为 InnoDB 表生成一个<strong>隐含字段 row_id</strong> 作为主键，这个字段长度为 6 个字节，类型为长整形</p>
</li>
</ul>
<p>辅助索引：</p>
<ul>
<li>
<p>InnoDB 的所有辅助索引（二级索引）都引用主键作为 data 域</p>
</li>
<li>
<p>InnoDB 表是基于聚簇索引建立的，因此 InnoDB 的索引能提供一种非常快速的主键查找性能。不过辅助索引也会包含主键列，所以不建议使用过长的字段作为主键，<strong>过长的主索引会令辅助索引变得过大</strong></p>
</li>
</ul>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/693e639371a341ccca29101982bfee9255c66a8e74a704ed11e3e9ed666440d7/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d496e6e6f44422545382538312539412545372542302538372545352539322538432545382542452538352545352538412541392545372542342541322545352542432539352545372542422539332545362539452538342e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/693e639371a341ccca29101982bfee9255c66a8e74a704ed11e3e9ed666440d7/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d496e6e6f44422545382538312539412545372542302538372545352539322538432545382542452538352545352538412541392545372542342541322545352542432539352545372542422539332545362539452538342e706e67">https://camo.githubusercontent.com/693e639371a341ccca29101982bfee9255c66a8e74a704ed11e3e9ed666440d7/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d496e6e6f44422545382538312539412545372542302538372545352539322538432545382542452538352545352538412541392545372542342541322545352542432539352545372542422539332545362539452538342e706e67</a>)</p>
<hr>
<h4 id="-119"><a class="markdownIt-Anchor" href="#-119">#</a> <a href="#myisam"></a>MyISAM</h4>
<h5 id="-120"><a class="markdownIt-Anchor" href="#-120">#</a> <a href="#%E9%9D%9E%E8%81%9A%E7%B0%87"></a>非聚簇</h5>
<p>MyISAM 的主键索引使用的是非聚簇索引，索引文件和数据文件是分离的，<strong>索引文件仅保存数据的地址</strong></p>
<ul>
<li>主键索引 B+ 树的节点存储了主键，辅助键索引 B+ 树存储了辅助键，表数据存储在独立的地方，这两颗 B+ 树的叶子节点都使用一个地址指向真正的表数据，对于表数据来说，这两个键没有任何差别</li>
<li>由于索引树是独立的，通过辅助索引检索无需访问主键的索引树回表查询</li>
</ul>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/078f32ab7a3b7b499e0592ecf2ec74c314a9cf4dacdb20e085cfaefe29aa0277/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d2545382538312539412545372542302538372545372542342541322545352542432539352545352539322538432545382542452538352545352538412541392545372542342541322545352542432539352545362541332538302545392539342538312545362539352542302545362538442541452545352539422542452e6a7067" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/078f32ab7a3b7b499e0592ecf2ec74c314a9cf4dacdb20e085cfaefe29aa0277/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d2545382538312539412545372542302538372545372542342541322545352542432539352545352539322538432545382542452538352545352538412541392545372542342541322545352542432539352545362541332538302545392539342538312545362539352542302545362538442541452545352539422542452e6a7067">https://camo.githubusercontent.com/078f32ab7a3b7b499e0592ecf2ec74c314a9cf4dacdb20e085cfaefe29aa0277/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d2545382538312539412545372542302538372545372542342541322545352542432539352545352539322538432545382542452538352545352538412541392545372542342541322545352542432539352545362541332538302545392539342538312545362539352542302545362538442541452545352539422542452e6a7067</a>)</p>
<hr>
<h5 id="-121"><a class="markdownIt-Anchor" href="#-121">#</a> <a href="#%E7%B4%A2%E5%BC%95%E5%AE%9E%E7%8E%B0-1"></a>索引实现</h5>
<p>MyISAM 的索引方式也叫做非聚集的，之所以这么称呼是为了与 InnoDB 的聚集索引区分</p>
<p>主键索引：MyISAM 引擎使用 B+Tree 作为索引结构，叶节点的 data 域存放的是数据记录的地址</p>
<p>辅助索引：MyISAM 中主索引和辅助索引（Secondary key）在结构上没有任何区别，只是主索引要求 key 是唯一的，而辅助索引的 key 可以重复</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d4d794953414d2545342542382542422545392539342541452545352539322538432545382542452538352545352538412541392545372542342541322545352542432539352545372542422539332545362539452538342e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/d682f40868e7155f02b8211e0614b535c7e0bfb16092c39d6210c2470c725ada/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d4d794953414d2545342542382542422545392539342541452545352539322538432545382542452538352545352538412541392545372542342541322545352542432539352545372542422539332545362539452538342e706e67">https://camo.githubusercontent.com/d682f40868e7155f02b8211e0614b535c7e0bfb16092c39d6210c2470c725ada/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d4d794953414d2545342542382542422545392539342541452545352539322538432545382542452538352545352538412541392545372542342541322545352542432539352545372542422539332545362539452538342e706e67</a>)</p>
<p>参考文章：<a target="_blank" rel="noopener" href="https://blog.csdn.net/lm1060891265/article/details/81482136">https://blog.csdn.net/lm1060891265/article/details/81482136</a></p>
<hr>
<h3 id="-122"><a class="markdownIt-Anchor" href="#-122">#</a> <a href="#%E7%B4%A2%E5%BC%95%E7%BB%93%E6%9E%84"></a>索引结构</h3>
<h4 id="-123"><a class="markdownIt-Anchor" href="#-123">#</a> <a href="#%E6%95%B0%E6%8D%AE%E9%A1%B5"></a>数据页</h4>
<p>文件系统的最小单元是块（block），一个块的大小是 4K，系统从磁盘读取数据到内存时是以磁盘块为基本单位的，位于同一个磁盘块中的数据会被一次性读取出来，而不是需要什么取什么</p>
<p>InnoDB 存储引擎中有页（Page）的概念，页是 MySQL 磁盘管理的最小单位</p>
<ul>
<li><strong>InnoDB 存储引擎中默认每个页的大小为 16KB，索引中一个节点就是一个数据页</strong>，所以会一次性读取 16KB 的数据到内存</li>
<li>InnoDB 引擎将若干个地址连接磁盘块，以此来达到页的大小 16KB</li>
<li>在查询数据时如果一个页中的每条数据都能有助于定位数据记录的位置，这将会减少磁盘 I/O 次数，提高查询效率</li>
</ul>
<p>数据页物理结构，从上到下：</p>
<ul>
<li>File Header：上一页和下一页的指针、该页的类型（索引页、数据页、日志页等）、<strong>校验和</strong>、LSN（最近一次修改当前页面时的系统 lsn 值，事务持久性部分详解）等信息</li>
<li>Page Header：记录状态信息</li>
<li>Infimum + Supremum：当前页的最小记录和最大记录（头尾指针），Infimum 所在分组只有一条记录，Supremum 所在分组可以有 1 ~ 8 条记录，剩余的分组可以有 4 ~ 8 条记录</li>
<li>User Records：存储数据的记录</li>
<li>Free Space：尚未使用的存储空间</li>
<li>Page Directory：分组的目录，可以通过目录快速定位（二分法）数据的分组</li>
<li>File Trailer：检验和字段，在刷脏过程中，页首和页尾的校验和一致才能说明页面刷新成功，二者不同说明刷新期间发生了错误；LSN 字段，也是用来校验页面的完整性</li>
</ul>
<p>数据页中包含数据行，数据的存储是基于数据行的，数据行有 next_record 属性指向下一个行数据，所以是可以遍历的，但是一组数据至多 8 个行，通过 Page Directory 先定位到组，然后遍历获取所需的数据行即可</p>
<p>数据行中有三个隐藏字段：trx_id、roll_pointer、row_id（在事务章节会详细介绍它们的作用）</p>
<hr>
<h4 id="-124"><a class="markdownIt-Anchor" href="#-124">#</a> <a href="#btree"></a>BTree</h4>
<p>BTree 的索引类型是基于 B+Tree 树型数据结构的，B+Tree 又是 BTree 数据结构的变种，用在数据库和操作系统中的文件系统，特点是能够保持数据稳定有序</p>
<p>BTree 又叫多路平衡搜索树，一颗 m 叉的 BTree 特性如下：</p>
<ul>
<li>树中每个节点最多包含 m 个孩子</li>
<li>除根节点与叶子节点外，每个节点至少有 [ceil (m/2)] 个孩子</li>
<li>若根节点不是叶子节点，则至少有两个孩子</li>
<li>所有的叶子节点都在同一层</li>
<li>每个非叶子节点由 n 个 key 与 n+1 个指针组成，其中 [ceil (m/2)-1] &lt;= n &lt;= m-1</li>
</ul>
<p>5 叉，key 的数量 [ceil (m/2)-1] &lt;= n &lt;= m-1 为 2 &lt;= n &lt;=4 ，当 n&gt;4 时中间节点分裂到父节点，两边节点分裂</p>
<p>插入 C N G A H E K Q M F W L T Z D P R X Y S 数据的工作流程：</p>
<ul>
<li>
<p>插入前 4 个字母 C N G A</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d4254726565254535254237254135254534254244253943254536254235253831254537254138253842312e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/fb5604ac591fae4b83cbdf18fbb5b7e8b699fd2da477651c927a3c6ba15287d6/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d4254726565254535254237254135254534254244253943254536254235253831254537254138253842312e706e67">https://camo.githubusercontent.com/fb5604ac591fae4b83cbdf18fbb5b7e8b699fd2da477651c927a3c6ba15287d6/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d4254726565254535254237254135254534254244253943254536254235253831254537254138253842312e706e67</a>)</p>
</li>
<li>
<p>插入 H，n&gt;4，中间元素 G 字母向上分裂到新的节点</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d4254726565254535254237254135254534254244253943254536254235253831254537254138253842322e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/d4f3261c6168972758df2a75f4a3878e732b45ce271e07892e845632b19b86e2/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d4254726565254535254237254135254534254244253943254536254235253831254537254138253842322e706e67">https://camo.githubusercontent.com/d4f3261c6168972758df2a75f4a3878e732b45ce271e07892e845632b19b86e2/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d4254726565254535254237254135254534254244253943254536254235253831254537254138253842322e706e67</a>)</p>
</li>
<li>
<p>插入 E、K、Q 不需要分裂</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/bcdf8c7beba2e3f369d9500f12b3bdd2dbe9e7d6c85368a0214f3f742f873aab/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d4254726565254535254237254135254534254244253943254536254235253831254537254138253842332e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/bcdf8c7beba2e3f369d9500f12b3bdd2dbe9e7d6c85368a0214f3f742f873aab/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d4254726565254535254237254135254534254244253943254536254235253831254537254138253842332e706e67">https://camo.githubusercontent.com/bcdf8c7beba2e3f369d9500f12b3bdd2dbe9e7d6c85368a0214f3f742f873aab/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d4254726565254535254237254135254534254244253943254536254235253831254537254138253842332e706e67</a>)</p>
</li>
<li>
<p>插入 M，中间元素 M 字母向上分裂到父节点 G</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d4254726565254535254237254135254534254244253943254536254235253831254537254138253842342e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/71f60481da9d82678c38c49f70d88204c16643d10e39009893c1b8c5ffde55cc/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d4254726565254535254237254135254534254244253943254536254235253831254537254138253842342e706e67">https://camo.githubusercontent.com/71f60481da9d82678c38c49f70d88204c16643d10e39009893c1b8c5ffde55cc/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d4254726565254535254237254135254534254244253943254536254235253831254537254138253842342e706e67</a>)</p>
</li>
<li>
<p>插入 F，W，L，T 不需要分裂</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/d74d7f3146036e461aeeaecf7bfbaf866ed3fb9cc7d419954f01abd8808d00eb/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d4254726565254535254237254135254534254244253943254536254235253831254537254138253842352e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/d74d7f3146036e461aeeaecf7bfbaf866ed3fb9cc7d419954f01abd8808d00eb/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d4254726565254535254237254135254534254244253943254536254235253831254537254138253842352e706e67">https://camo.githubusercontent.com/d74d7f3146036e461aeeaecf7bfbaf866ed3fb9cc7d419954f01abd8808d00eb/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d4254726565254535254237254135254534254244253943254536254235253831254537254138253842352e706e67</a>)</p>
</li>
<li>
<p>插入 Z，中间元素 T 向上分裂到父节点中</p>
</li>
</ul>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/0ce9e6a8941c3b6555088cf275df2de988024e169a975839322afdc514c7af55/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d4254726565254535254237254135254534254244253943254536254235253831254537254138253842362e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/0ce9e6a8941c3b6555088cf275df2de988024e169a975839322afdc514c7af55/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d4254726565254535254237254135254534254244253943254536254235253831254537254138253842362e706e67">https://camo.githubusercontent.com/0ce9e6a8941c3b6555088cf275df2de988024e169a975839322afdc514c7af55/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d4254726565254535254237254135254534254244253943254536254235253831254537254138253842362e706e67</a>)</p>
<ul>
<li>
<p>插入 D，中间元素 D 向上分裂到父节点中，然后插入 P，R，X，Y 不需要分裂</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d4254726565254535254237254135254534254244253943254536254235253831254537254138253842372e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/8d217f9cf64f6b3e514fb875154066d5afc230b05f77dc2837a4b7a42bb83ec0/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d4254726565254535254237254135254534254244253943254536254235253831254537254138253842372e706e67">https://camo.githubusercontent.com/8d217f9cf64f6b3e514fb875154066d5afc230b05f77dc2837a4b7a42bb83ec0/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d4254726565254535254237254135254534254244253943254536254235253831254537254138253842372e706e67</a>)</p>
</li>
<li>
<p>最后插入 S，NPQR 节点 n&gt;5，中间节点 Q 向上分裂，但分裂后父节点 DGMT 的 n&gt;5，中间节点 M 向上分裂</p>
</li>
</ul>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d4254726565254535254237254135254534254244253943254536254235253831254537254138253842382e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/5ed5aff0b743bd61bc2f293c8f3cc3d13a5d32884e52ae9c8c88d38787a9d7cd/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d4254726565254535254237254135254534254244253943254536254235253831254537254138253842382e706e67">https://camo.githubusercontent.com/5ed5aff0b743bd61bc2f293c8f3cc3d13a5d32884e52ae9c8c88d38787a9d7cd/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d4254726565254535254237254135254534254244253943254536254235253831254537254138253842382e706e67</a>)</p>
<p>BTree 树就已经构建完成了，BTree 树和二叉树相比， 查询数据的效率更高， 因为对于相同的数据量来说，<strong>BTree 的层级结构比二叉树小</strong>，所以搜索速度快</p>
<p>BTree 结构的数据可以让系统高效的找到数据所在的磁盘块，定义一条记录为一个二元组 [key, data] ，key 为记录的键值，对应表中的主键值，data 为一行记录中除主键外的数据。对于不同的记录，key 值互不相同，BTree 中的每个节点根据实际情况可以包含大量的关键字信息和分支 [<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f2545372542342541322545352542432539352545372539412538342545352538452539462545372539302538362d42547265652e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/e3a0ad55f46fe036a6915b1d1c8bfb0bc965d7bcaac36810f9074503e328cfb2/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f2545372542342541322545352542432539352545372539412538342545352538452539462545372539302538362d42547265652e706e67">https://camo.githubusercontent.com/e3a0ad55f46fe036a6915b1d1c8bfb0bc965d7bcaac36810f9074503e328cfb2/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f2545372542342541322545352542432539352545372539412538342545352538452539462545372539302538362d42547265652e706e67</a>)</p>
<p>缺点：当进行范围查找时会出现回旋查找</p>
<hr>
<h4 id="-125"><a class="markdownIt-Anchor" href="#-125">#</a> <a href="#btree-1"></a>B+Tree</h4>
<h5 id="-126"><a class="markdownIt-Anchor" href="#-126">#</a> <a href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"></a>数据结构</h5>
<p>BTree 数据结构中每个节点中不仅包含数据的 key 值，还有 data 值。磁盘中每一页的存储空间是有限的，如果 data 数据较大时将会导致每个节点（即一个页）能存储的 key 的数量很小，当存储的数据量很大时同样会导致 B-Tree 的深度较大，增大查询时的磁盘 I/O 次数，进而影响查询效率，所以引入 B+Tree</p>
<p>B+Tree 为 BTree 的变种，B+Tree 与 BTree 的区别为：</p>
<ul>
<li>
<p>n 叉 B+Tree 最多含有 n 个 key（哈希值），而 BTree 最多含有 n-1 个 key</p>
</li>
<li>
<p>所有<strong>非叶子节点只存储键值 key</strong> 信息，只进行数据索引，使每个非叶子节点所能保存的关键字大大增加</p>
</li>
<li>
<p>所有<strong>数据都存储在叶子节点</strong>，所以每次数据查询的次数都一样</p>
</li>
<li>
<p><strong>叶子节点按照 key 大小顺序排列，左边结尾数据都会保存右边节点开始数据的指针，形成一个链表</strong></p>
</li>
<li>
<p>所有节点中的 key 在叶子节点中也存在（比如 5)，key 允许重复，B 树不同节点不存在重复的 key</p>
</li>
</ul>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/8fceb33a3ea5bad427cbddd7555cb3cbf31df26180ea2233cebb961ef4dd8263/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d422b54726565e695b0e68daee7bb93e69e842e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/8fceb33a3ea5bad427cbddd7555cb3cbf31df26180ea2233cebb961ef4dd8263/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d422b54726565e695b0e68daee7bb93e69e842e706e67">https://camo.githubusercontent.com/8fceb33a3ea5bad427cbddd7555cb3cbf31df26180ea2233cebb961ef4dd8263/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d422b54726565e695b0e68daee7bb93e69e842e706e67</a>)</p>
<p>B* 树：是 B+ 树的变体，在 B+ 树的非根和非叶子结点再增加指向兄弟的指针</p>
<hr>
<h5 id="-127"><a class="markdownIt-Anchor" href="#-127">#</a> <a href="#%E4%BC%98%E5%8C%96%E7%BB%93%E6%9E%84"></a>优化结构</h5>
<p>MySQL 索引数据结构对经典的 B+Tree 进行了优化，在原 B+Tree 的基础上，增加一个指向相邻叶子节点的链表指针，就形成了带有顺序指针的 B+Tree，<strong>提高区间访问的性能，防止回旋查找</strong></p>
<p>区间访问的意思是访问索引为 5 - 15 的数据，可以直接根据相邻节点的指针遍历</p>
<p>B+ 树的<strong>叶子节点是数据页</strong>（page），一个页里面可以存多个数据行</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f2545372542342541322545352542432539352545372539412538342545352538452539462545372539302538362d422b547265652e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/998e12eb33b8d03558b3d67b867e59b95f29727086e51243d0a997725696bcbc/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f2545372542342541322545352542432539352545372539412538342545352538452539462545372539302538362d422b547265652e706e67">https://camo.githubusercontent.com/998e12eb33b8d03558b3d67b867e59b95f29727086e51243d0a997725696bcbc/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f2545372542342541322545352542432539352545372539412538342545352538452539462545372539302538362d422b547265652e706e67</a>)</p>
<p>通常在 B+Tree 上有两个头指针，<strong>一个指向根节点，另一个指向关键字最小的叶子节点</strong>，而且所有叶子节点（即数据节点）之间是一种链式环结构。可以对 B+Tree 进行两种查找运算：</p>
<ul>
<li>有范围：对于主键的范围查找和分页查找</li>
<li>有顺序：从根节点开始，进行随机查找，顺序查找</li>
</ul>
<p>InnoDB 中每个数据页的大小默认是 16KB，</p>
<ul>
<li>索引行：一般表的主键类型为 INT（4 字节）或 BIGINT（8 字节），指针大小在 InnoDB 中设置为 6 字节节，也就是说一个页大概存储 16KB/(8B+6B)=1K 个键值（估值）。则一个深度为 3 的 B+Tree 索引可以维护  <code>10^3 * 10^3 * 10^3 = 10亿</code>  条记录</li>
<li>数据行：一行数据的大小可能是 1k，一个数据页可以存储 16 行</li>
</ul>
<p>实际情况中每个节点可能不能填充满，因此在数据库中，B+Tree 的高度一般都在 2-4 层。MySQL 的 InnoDB 存储引擎在设计时是<strong>将根节点常驻内存的</strong>，也就是说查找某一键值的行记录时最多只需要 1~3 次磁盘 I/O 操作</p>
<p>B+Tree 优点：提高查询速度，减少磁盘的 IO 次数，树形结构较小</p>
<hr>
<h5 id="-128"><a class="markdownIt-Anchor" href="#-128">#</a> <a href="#%E7%B4%A2%E5%BC%95%E7%BB%B4%E6%8A%A4"></a>索引维护</h5>
<p>B+ 树为了保持索引的有序性，在插入新值的时候需要做相应的维护</p>
<p>每个索引中每个块存储在磁盘页中，可能会出现以下两种情况：</p>
<ul>
<li>如果所在的数据页已经满了，这时候需要申请一个新的数据页，然后挪动部分数据过去，这个过程称为<strong>页分裂</strong></li>
<li>当相邻两个页由于删除了数据，利用率很低之后，会将数据页做<strong>页合并</strong>，合并的过程可以认为是分裂过程的逆过程</li>
<li>这两个情况都是由 B+ 树的结构决定的</li>
</ul>
<p>一般选用数据小的字段做索引，字段长度越小，普通索引的叶子节点就越小，普通索引占用的空间也就越小</p>
<hr>
<h3 id="-129"><a class="markdownIt-Anchor" href="#-129">#</a> <a href="#%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99"></a>设计原则</h3>
<p>索引的设计可以遵循一些已有的原则，创建索引的时候请尽量考虑符合这些原则，便于提升索引的使用效率</p>
<p>创建索引时的原则：</p>
<ul>
<li>
<p>对查询频次较高，且数据量比较大的表建立索引</p>
</li>
<li>
<p>使用唯一索引，区分度越高，使用索引的效率越高</p>
</li>
<li>
<p>索引字段的选择，最佳候选列应当从 where 子句的条件中提取，使用覆盖索引</p>
</li>
<li>
<p>使用短索引，索引创建之后也是使用硬盘来存储的，因此提升索引访问的 I/O 效率，也可以提升总体的访问效率。假如构成索引的字段总长度比较短，那么在给定大小的存储块内可以存储更多的索引值，相应的可以有效的提升 MySQL 访问索引的 I/O 效率</p>
</li>
<li>
<p>索引可以有效的提升查询数据的效率，但索引数量不是多多益善，索引越多，维护索引的代价越高。对于插入、更新、删除等 DML 操作比较频繁的表来说，索引过多，会引入相当高的维护代价，降低 DML 操作的效率，增加相应操作的时间消耗；另外索引过多的话，MySQL 也会犯选择困难病，虽然最终仍然会找到一个可用的索引，但提高了选择的代价</p>
</li>
<li>
<p>MySQL 建立联合索引时会遵守<strong>最左前缀匹配原则</strong>，即最左优先，在检索数据时从联合索引的最左边开始匹配</p>
<p>N 个列组合而成的组合索引，相当于创建了 N 个索引，如果查询时 where 句中使用了组成该索引的<strong>前</strong>几个字段，那么这条查询 SQL 可以利用组合索引来提升查询效率</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 对name、address、phone列建一个联合索引</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> <span class="token keyword">user</span> <span class="token keyword">ADD</span> <span class="token keyword">INDEX</span> index_three<span class="token punctuation">(</span>name<span class="token punctuation">,</span>address<span class="token punctuation">,</span>phone<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 查询语句执行时会依照最左前缀匹配原则，检索时分别会使用索引进行数据匹配。</span>
<span class="token punctuation">(</span>name<span class="token punctuation">,</span>address<span class="token punctuation">,</span>phone<span class="token punctuation">)</span>
<span class="token punctuation">(</span>name<span class="token punctuation">,</span>address<span class="token punctuation">)</span>
<span class="token punctuation">(</span>name<span class="token punctuation">,</span>phone<span class="token punctuation">)</span>	<span class="token comment">-- 只有name字段走了索引</span>
<span class="token punctuation">(</span>name<span class="token punctuation">)</span>

<span class="token comment">-- 索引的字段可以是任意顺序的，优化器会帮助我们调整顺序，下面的SQL语句可以命中索引</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">user</span> <span class="token keyword">WHERE</span> address <span class="token operator">=</span> <span class="token string">'北京'</span> <span class="token operator">AND</span> phone <span class="token operator">=</span> <span class="token string">'12345'</span> <span class="token operator">AND</span> name <span class="token operator">=</span> <span class="token string">'张三'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 如果联合索引中最左边的列不包含在条件查询中，SQL语句就不会命中索引，比如：</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">user</span> <span class="token keyword">WHERE</span> address <span class="token operator">=</span> <span class="token string">'北京'</span> <span class="token operator">AND</span> phone <span class="token operator">=</span> <span class="token string">'12345'</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
</ul>
<p>哪些情况不要建立索引：</p>
<ul>
<li>记录太少的表</li>
<li>经常增删改的表</li>
<li>频繁更新的字段不适合创建索引</li>
<li>where 条件里用不到的字段不创建索引</li>
</ul>
<hr>
<h3 id="-130"><a class="markdownIt-Anchor" href="#-130">#</a> <a href="#%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96"></a>索引优化</h3>
<h4 id="-131"><a class="markdownIt-Anchor" href="#-131">#</a> <a href="#%E8%A6%86%E7%9B%96%E7%B4%A2%E5%BC%95"></a>覆盖索引</h4>
<p>覆盖索引：包含所有满足查询需要的数据的索引（SELECT 后面的字段刚好是索引字段），可以利用该索引返回 SELECT 列表的字段，而不必根据索引去聚簇索引上读取数据文件</p>
<p>回表查询：要查找的字段不在非主键索引树上时，需要通过叶子节点的主键值去主键索引上获取对应的行数据</p>
<p>使用覆盖索引，防止回表查询：</p>
<ul>
<li>
<p>表 user 主键为 id，普通索引为 age，查询语句：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">user</span> <span class="token keyword">WHERE</span> age <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>查询过程：先通过普通索引 age=30 定位到主键值 id=1，再通过聚集索引 id=1 定位到行记录数据，需要两次扫描 B+ 树</p>
</li>
<li>
<p>使用覆盖索引：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">INDEX</span> idx_age <span class="token keyword">ON</span> <span class="token keyword">user</span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_age_name <span class="token keyword">ON</span> <span class="token keyword">user</span><span class="token punctuation">(</span>age<span class="token punctuation">,</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> id<span class="token punctuation">,</span>age <span class="token keyword">FROM</span> <span class="token keyword">user</span> <span class="token keyword">WHERE</span> age <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>在一棵索引树上就能获取查询所需的数据，无需回表速度更快</p>
</li>
</ul>
<p>使用覆盖索引，要注意 SELECT 列表中只取出需要的列，不可用 SELECT *，所有字段一起做索引会导致索引文件过大，查询性能下降</p>
<hr>
<h4 id="-132"><a class="markdownIt-Anchor" href="#-132">#</a> <a href="#%E7%B4%A2%E5%BC%95%E4%B8%8B%E6%8E%A8"></a>索引下推</h4>
<p>索引条件下推优化（Index Condition Pushdown，ICP）是 MySQL5.6 添加，可以在索引遍历过程中，对索引中包含的字段先做判断，直接过滤掉不满足条件的记录，减少回表次数</p>
<p>索引下推充分利用了索引中的数据，在查询出整行数据之前过滤掉无效的数据，再去主键索引树上查找</p>
<ul>
<li>
<p>不使用索引下推优化时存储引擎通过索引检索到数据返回给 MySQL 服务器，服务器判断数据是否符合条件，符合条件的数据去聚簇索引回表查询，获取完整的数据</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d2545342542382538442545342542442542462545372539342541382545372542342541322545352542432539352545342542382538422545362538452541382e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/8b26ea34adc7fcab74fcf559a7ca331a2a83a858c7a512f410ec6ae3c9dae0dc/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d2545342542382538442545342542442542462545372539342541382545372542342541322545352542432539352545342542382538422545362538452541382e706e67">https://camo.githubusercontent.com/8b26ea34adc7fcab74fcf559a7ca331a2a83a858c7a512f410ec6ae3c9dae0dc/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d2545342542382538442545342542442542462545372539342541382545372542342541322545352542432539352545342542382538422545362538452541382e706e67</a>)</p>
</li>
<li>
<p>使用索引下推优化时，如果<strong>存在某些被索引的列的判断条件</strong>时，MySQL 服务器将这一部分判断条件传递给存储引擎，由存储引擎在索引遍历的过程中判断数据是否符合传递的条件，将符合条件的数据进行回表，检索出来返回给服务器，由此减少 IO 次数</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d2545342542442542462545372539342541382545372542342541322545352542432539352545342542382538422545362538452541382e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/6d30f42d7458ed8b3ef51577dbe68eb50f6f438205c3dd3f900123b1212c5c0f/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d2545342542442542462545372539342541382545372542342541322545352542432539352545342542382538422545362538452541382e706e67">https://camo.githubusercontent.com/6d30f42d7458ed8b3ef51577dbe68eb50f6f438205c3dd3f900123b1212c5c0f/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d2545342542442542462545372539342541382545372542342541322545352542432539352545342542382538422545362538452541382e706e67</a>)</p>
</li>
</ul>
<p><strong>适用条件</strong>：</p>
<ul>
<li>需要存储引擎将索引中的数据与条件进行判断（所以<strong>条件列必须都在同一个索引中</strong>），所以优化是基于存储引擎的，只有特定引擎可以使用，适用于 InnoDB 和 MyISAM</li>
<li>存储引擎没有调用跨存储引擎的能力，跨存储引擎的功能有存储过程、触发器、视图，所以调用这些功能的不可以进行索引下推优化</li>
<li>对于 InnoDB 引擎只适用于二级索引，InnoDB 的聚簇索引会将整行数据读到缓冲区，不再需要去回表查询了，索引下推的目的减少 IO 次数也就失去了意义</li>
</ul>
<p>工作过程：用户表 user，(name, age) 是联合索引</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">user</span> <span class="token keyword">WHERE</span> name <span class="token operator">LIKE</span> <span class="token string">'张%'</span> <span class="token operator">AND</span>　age <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>	<span class="token comment">-- 头部模糊匹配会造成索引失效</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>
<p>优化前：在非主键索引树上找到满足第一个条件的行，然后通过叶子节点记录的主键值再回到主键索引树上查找到对应的行数据，再对比 AND 后的条件是否符合，符合返回数据，需要 4 次回表</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/e9e05504c98dfeed0959f871da9dc6d1e5313a32842c240f251e10e350795133/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d254537254234254132254535254243253935254534254238253842254536253845254138254534254243253938254535253843253936312e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/e9e05504c98dfeed0959f871da9dc6d1e5313a32842c240f251e10e350795133/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d254537254234254132254535254243253935254534254238253842254536253845254138254534254243253938254535253843253936312e706e67">https://camo.githubusercontent.com/e9e05504c98dfeed0959f871da9dc6d1e5313a32842c240f251e10e350795133/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d254537254234254132254535254243253935254534254238253842254536253845254138254534254243253938254535253843253936312e706e67</a>)</p>
</li>
<li>
<p>优化后：检查索引中存储的列信息是否符合索引条件，然后交由存储引擎用剩余的判断条件判断此行数据是否符合要求，<strong>不满足条件的不去读取表中的数据</strong>，满足下推条件的就根据主键值进行回表查询，2 次回表 [<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d254537254234254132254535254243253935254534254238253842254536253845254138254534254243253938254535253843253936322e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/57058e4fca702e5860d4b16a679378a58b12c9d69225e9cc08b5af7ed402067e/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d254537254234254132254535254243253935254534254238253842254536253845254138254534254243253938254535253843253936322e706e67">https://camo.githubusercontent.com/57058e4fca702e5860d4b16a679378a58b12c9d69225e9cc08b5af7ed402067e/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d254537254234254132254535254243253935254534254238253842254536253845254138254534254243253938254535253843253936322e706e67</a>)</p>
</li>
</ul>
<p>当使用 EXPLAIN 进行分析时，如果使用了索引条件下推，Extra 会显示 Using index condition</p>
<p>参考文章：<a target="_blank" rel="noopener" href="https://blog.csdn.net/sinat_29774479/article/details/103470244">https://blog.csdn.net/sinat_29774479/article/details/103470244</a></p>
<p>参考文章：<a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/69636">https://time.geekbang.org/column/article/69636</a></p>
<hr>
<h4 id="-133"><a class="markdownIt-Anchor" href="#-133">#</a> <a href="#%E5%89%8D%E7%BC%80%E7%B4%A2%E5%BC%95"></a>前缀索引</h4>
<p>当要索引的列字符很多时，索引会变大变慢，可以只索引列开始的部分字符串，节约索引空间，提高索引效率</p>
<p>注意：使用前缀索引就系统就忽略覆盖索引对查询性能的优化了</p>
<p>优化原则：<strong>降低重复的索引值</strong></p>
<p>比如地区表：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">area			gdp		code
chinaShanghai	<span class="token number">100</span>		aaa
chinaDalian		<span class="token number">200</span>		bbb
usaNewYork		<span class="token number">300</span>		ccc
chinaFuxin		<span class="token number">400</span>		ddd
chinaBeijing	<span class="token number">500</span>		eee<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>发现 area 字段很多都是以 china 开头的，那么如果以前 1-5 位字符做前缀索引就会出现大量索引值重复的情况，索引值重复性越低，查询效率也就越高，所以需要建立前 6 位字符的索引：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_area <span class="token keyword">ON</span> table_name<span class="token punctuation">(</span>area<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>场景：存储身份证</p>
<ul>
<li>直接创建完整索引，这样可能比较占用空间</li>
<li>创建前缀索引，节省空间，但会增加查询扫描次数，并且不能使用覆盖索引</li>
<li>倒序存储，再创建前缀索引，用于绕过字符串本身前缀的区分度不够的问题（前 6 位相同的很多）</li>
<li>创建 hash 字段索引，查询性能稳定，有额外的存储和计算消耗，跟第三种方式一样，都不支持范围扫描</li>
</ul>
<hr>
<h4 id="-134"><a class="markdownIt-Anchor" href="#-134">#</a> <a href="#%E7%B4%A2%E5%BC%95%E5%90%88%E5%B9%B6"></a>索引合并</h4>
<p>使用多个索引来完成一次查询的执行方法叫做索引合并 index merge</p>
<ul>
<li>
<p>Intersection 索引合并：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> table_test <span class="token keyword">WHERE</span> key1 <span class="token operator">=</span> <span class="token string">'a'</span> <span class="token operator">AND</span> key3 <span class="token operator">=</span> <span class="token string">'b'</span><span class="token punctuation">;</span> <span class="token comment"># key1 和 key3 列都是单列索引、二级索引</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>从不同索引中扫描到的记录的 id 值取<strong>交集</strong>（相同 id），然后执行回表操作，要求从每个二级索引获取到的记录都是按照主键值排序</p>
</li>
<li>
<p>Union 索引合并：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> table_test <span class="token keyword">WHERE</span> key1 <span class="token operator">=</span> <span class="token string">'a'</span> <span class="token operator">OR</span> key3 <span class="token operator">=</span> <span class="token string">'b'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>从不同索引中扫描到的记录的 id 值取<strong>并集</strong>，然后执行回表操作，要求从每个二级索引获取到的记录都是按照主键值排序</p>
</li>
<li>
<p>Sort-Union 索引合并</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> table_test <span class="token keyword">WHERE</span> key1 <span class="token operator">&lt;</span> <span class="token string">'a'</span> <span class="token operator">OR</span> key3 <span class="token operator">></span> <span class="token string">'b'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>先将从不同索引中扫描到的记录的主键值进行排序，再按照 Union 索引合并的方式进行查询</p>
</li>
</ul>
<hr>
<h2 id="-135"><a class="markdownIt-Anchor" href="#-135">#</a> <a href="#%E7%B3%BB%E7%BB%9F%E4%BC%98%E5%8C%96"></a>系统优化</h2>
<h3 id="-136"><a class="markdownIt-Anchor" href="#-136">#</a> <a href="#%E4%BC%98%E5%8C%96%E6%AD%A5%E9%AA%A4"></a>优化步骤</h3>
<h4 id="-137"><a class="markdownIt-Anchor" href="#-137">#</a> <a href="#%E6%89%A7%E8%A1%8C%E9%A2%91%E7%8E%87"></a>执行频率</h4>
<p>随着生产数据量的急剧增长，很多 SQL 语句逐渐显露出性能问题，对生产的影响也越来越大，此时有问题的 SQL 语句就成为整个系统性能的瓶颈，因此必须要进行优化</p>
<p>MySQL 客户端连接成功后，查询服务器状态信息：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SHOW</span> <span class="token punctuation">[</span><span class="token keyword">SESSION</span><span class="token operator">|</span><span class="token keyword">GLOBAL</span><span class="token punctuation">]</span> <span class="token keyword">STATUS</span> <span class="token operator">LIKE</span> <span class="token string">''</span><span class="token punctuation">;</span>
<span class="token comment">-- SESSION: 显示当前会话连接的统计结果，默认参数</span>
<span class="token comment">-- GLOBAL: 显示自数据库上次启动至今的统计结果</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<ul>
<li>
<p>查看 SQL 执行频率：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SHOW</span> <span class="token keyword">STATUS</span> <span class="token operator">LIKE</span> <span class="token string">'Com_____'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Com_xxx 表示每种语句执行的次数</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/9459487e7f2bc8bb22433b4fe6e083a4e018ab999abf7a92fae12438f5322f9f/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d53514c2545382541462541442545352538462541352545362538392541372545382541312538432545392541322539312545372538452538372e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/9459487e7f2bc8bb22433b4fe6e083a4e018ab999abf7a92fae12438f5322f9f/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d53514c2545382541462541442545352538462541352545362538392541372545382541312538432545392541322539312545372538452538372e706e67">https://camo.githubusercontent.com/9459487e7f2bc8bb22433b4fe6e083a4e018ab999abf7a92fae12438f5322f9f/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d53514c2545382541462541442545352538462541352545362538392541372545382541312538432545392541322539312545372538452538372e706e67</a>)</p>
</li>
<li>
<p>查询 SQL 语句影响的行数：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SHOW</span> <span class="token keyword">STATUS</span> <span class="token operator">LIKE</span> <span class="token string">'Innodb_rows_%'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/a64613dc24e8e66b5aec9a802df3d32482e33919975a08f622b8553a0d65fa4d/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d53514c2545382541462541442545352538462541352545352542442542312545352539332538442545372539412538342545382541312538432545362539352542302e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/a64613dc24e8e66b5aec9a802df3d32482e33919975a08f622b8553a0d65fa4d/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d53514c2545382541462541442545352538462541352545352542442542312545352539332538442545372539412538342545382541312538432545362539352542302e706e67">https://camo.githubusercontent.com/a64613dc24e8e66b5aec9a802df3d32482e33919975a08f622b8553a0d65fa4d/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d53514c2545382541462541442545352538462541352545352542442542312545352539332538442545372539412538342545382541312538432545362539352542302e706e67</a>)</p>
</li>
</ul>
<p>Com_xxxx：这些参数对于所有存储引擎的表操作都会进行累计</p>
<p>Innodb_xxxx：这几个参数只是针对 InnoDB 存储引擎的，累加的算法也略有不同</p>
<table>
<thead>
<tr>
<th style="text-align:left">参数</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Com_select</td>
<td>执行 SELECT 操作的次数，一次查询只累加 1</td>
</tr>
<tr>
<td style="text-align:left">Com_insert</td>
<td>执行 INSERT 操作的次数，对于批量插入的 INSERT 操作，只累加一次</td>
</tr>
<tr>
<td style="text-align:left">Com_update</td>
<td>执行 UPDATE 操作的次数</td>
</tr>
<tr>
<td style="text-align:left">Com_delete</td>
<td>执行 DELETE 操作的次数</td>
</tr>
<tr>
<td style="text-align:left">Innodb_rows_read</td>
<td>执行 SELECT 查询返回的行数</td>
</tr>
<tr>
<td style="text-align:left">Innodb_rows_inserted</td>
<td>执行 INSERT 操作插入的行数</td>
</tr>
<tr>
<td style="text-align:left">Innodb_rows_updated</td>
<td>执行 UPDATE 操作更新的行数</td>
</tr>
<tr>
<td style="text-align:left">Innodb_rows_deleted</td>
<td>执行 DELETE 操作删除的行数</td>
</tr>
<tr>
<td style="text-align:left">Connections</td>
<td>试图连接 MySQL 服务器的次数</td>
</tr>
<tr>
<td style="text-align:left">Uptime</td>
<td>服务器工作时间</td>
</tr>
<tr>
<td style="text-align:left">Slow_queries</td>
<td>慢查询的次数</td>
</tr>
</tbody>
</table>
<hr>
<h4 id="-138"><a class="markdownIt-Anchor" href="#-138">#</a> <a href="#%E5%AE%9A%E4%BD%8D%E4%BD%8E%E6%95%88"></a>定位低效</h4>
<p>SQL 执行慢有两种情况：</p>
<ul>
<li>偶尔慢：DB 在刷新脏页（学完事务就懂了）
<ul>
<li>redo log 写满了</li>
<li>内存不够用，要从 LRU 链表中淘汰</li>
<li>MySQL 认为系统空闲的时候</li>
<li>MySQL 关闭时</li>
</ul>
</li>
<li>一直慢的原因：索引没有设计好、SQL 语句没写好、MySQL 选错了索引</li>
</ul>
<p>通过以下两种方式定位执行效率较低的 SQL 语句</p>
<ul>
<li>
<p>慢日志查询： 慢查询日志在查询结束以后才记录，执行效率出现问题时查询日志并不能定位问题</p>
<p>配置文件修改：修改 .cnf 文件  <code>vim /etc/mysql/my.cnf</code> ，重启 MySQL 服务器</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token assign-left variable">slow_query_log</span><span class="token operator">=</span>ON
<span class="token assign-left variable">slow_query_log_file</span><span class="token operator">=</span>/usr/local/mysql/var/localhost-slow.log
<span class="token assign-left variable">long_query_time</span><span class="token operator">=</span><span class="token number">1</span>	<span class="token comment">#记录超过long_query_time秒的SQL语句的日志</span>
log-queries-not-using-indexes <span class="token operator">=</span> <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>使用命令配置：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">SET</span> slow_query_log<span class="token operator">=</span><span class="token keyword">ON</span><span class="token punctuation">;</span>
mysql<span class="token operator">></span> <span class="token keyword">SET</span> <span class="token keyword">GLOBAL</span> slow_query_log<span class="token operator">=</span><span class="token keyword">ON</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>查看是否配置成功：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SHOW</span> VARIABLES <span class="token operator">LIKE</span> <span class="token string">'%query%'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>SHOW PROCESSLIST：<strong>实时查看</strong>当前 MySQL 在进行的连接线程，包括线程的状态、是否锁表、SQL 的执行情况，同时对一些锁表操作进行优化</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d53484f575f50524f434553534c4953542545352539312542442545342542422541342e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/9236b257f069041a811b373ee2911c91e7495c02d407a80d966f7ae4c2d5cb6b/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d53484f575f50524f434553534c4953542545352539312542442545342542422541342e706e67">https://camo.githubusercontent.com/9236b257f069041a811b373ee2911c91e7495c02d407a80d966f7ae4c2d5cb6b/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d53484f575f50524f434553534c4953542545352539312542442545342542422541342e706e67</a>)</p>
</li>
</ul>
<hr>
<h4 id="-139"><a class="markdownIt-Anchor" href="#-139">#</a> <a href="#explain"></a>EXPLAIN</h4>
<h5 id="-140"><a class="markdownIt-Anchor" href="#-140">#</a> <a href="#%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92"></a>执行计划</h5>
<p>通过 EXPLAIN 命令获取执行 SQL 语句的信息，包括在 SELECT 语句执行过程中如何连接和连接的顺序，执行计划在优化器优化完成后、执行器之前生成，然后执行器会调用存储引擎检索数据</p>
<p>查询 SQL 语句的执行计划：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> table_1 <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d6578706c61696e25453625394625413525453825414625413253514c2545382541462541442545352538462541352545372539412538342545362538392541372545382541312538432545382541452541312545352538382539322e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/5aebe712a608d6427253d72ccbd9cdd4430c42ae767364c2504ae9f1caabed76/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d6578706c61696e25453625394625413525453825414625413253514c2545382541462541442545352538462541352545372539412538342545362538392541372545382541312538432545382541452541312545352538382539322e706e67">https://camo.githubusercontent.com/5aebe712a608d6427253d72ccbd9cdd4430c42ae767364c2504ae9f1caabed76/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d6578706c61696e25453625394625413525453825414625413253514c2545382541462541442545352538462541352545372539412538342545362538392541372545382541312538432545382541452541312545352538382539322e706e67</a>)</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>SELECT 的序列号</td>
</tr>
<tr>
<td>select_type</td>
<td>表示 SELECT 的类型</td>
</tr>
<tr>
<td>table</td>
<td>访问数据库中表名称，有时可能是简称或者临时表名称（&lt;table_name&gt;）</td>
</tr>
<tr>
<td>type</td>
<td>表示表的连接类型</td>
</tr>
<tr>
<td>possible_keys</td>
<td>表示查询时，可能使用的索引</td>
</tr>
<tr>
<td>key</td>
<td>表示实际使用的索引</td>
</tr>
<tr>
<td>key_len</td>
<td>索引字段的长度</td>
</tr>
<tr>
<td>ref</td>
<td>表示与索引列进行等值匹配的对象，常数、某个列、函数等，type 必须在（range, const] 之间，左闭右开</td>
</tr>
<tr>
<td>rows</td>
<td>扫描出的行数，表示 MySQL 根据表统计信息及索引选用情况，<strong>估算</strong>的找到所需的记录扫描的行数</td>
</tr>
<tr>
<td>filtered</td>
<td>条件过滤的行百分比，单表查询没意义，用于连接查询中对驱动表的扇出进行过滤，查询优化器预测所有扇出值满足剩余查询条件的百分比，相乘以后表示多表查询中还要对被驱动执行查询的次数</td>
</tr>
<tr>
<td>extra</td>
<td>执行情况的说明和描述</td>
</tr>
</tbody>
</table>
<p>MySQL <strong>执行计划的局限</strong>：</p>
<ul>
<li>只是计划，不是执行 SQL 语句，可以随着底层优化器输入的更改而更改</li>
<li>EXPLAIN 不会告诉显示关于触发器、存储过程的信息对查询的影响情况</li>
<li>EXPLAIN 不考虑各种 Cache</li>
<li>EXPLAIN 不能显示 MySQL 在执行查询时的动态，因为执行计划在执行查询之前生成</li>
<li>EXPALIN 部分统计信息是估算的，并非精确值</li>
<li>EXPALIN 只能解释 SELECT 操作，其他操作要重写为 SELECT 后查看执行计划</li>
<li>EXPLAIN PLAN 显示的是在解释语句时数据库将如何运行 SQL 语句，由于执行环境和 EXPLAIN PLAN 环境的不同，此计划可能与 SQL 语句实际的执行计划不同</li>
</ul>
<p>SHOW WARINGS：在使用 EXPALIN 命令后执行该语句，可以查询与执行计划相关的拓展信息，展示出 Level、Code、Message 三个字段，当 Code 为 1003 时，Message 字段展示的信息类似于将查询语句重写后的信息，但是不是等价，不能执行复制过来运行</p>
<p>环境准备：</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d2545362538392541372545382541312538432545382541452541312545352538382539322545372538452541462545352541322538332545352538372538362545352541342538372e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/60c905a58234d3628c1ebec69f8beda460fb0e70c45bbe660c0dac54899c7936/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d2545362538392541372545382541312538432545382541452541312545352538382539322545372538452541462545352541322538332545352538372538362545352541342538372e706e67">https://camo.githubusercontent.com/60c905a58234d3628c1ebec69f8beda460fb0e70c45bbe660c0dac54899c7936/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d2545362538392541372545382541312538432545382541452541312545352538382539322545372538452541462545352541322538332545352538372538362545352541342538372e706e67</a>)</p>
<hr>
<h5 id="-141"><a class="markdownIt-Anchor" href="#-141">#</a> <a href="#id"></a>id</h5>
<p>id 代表 SQL 执行的顺序的标识，每个 SELECT 关键字对应一个唯一 id，所以在同一个 SELECT 关键字中的表的 id 都是相同的。SELECT 后的 FROM 可以跟随多个表，每个表都会对应一条记录，这些记录的 id 都是相同的，</p>
<ul>
<li>
<p>id 相同时，执行顺序由上至下。连接查询的执行计划，记录的 id 值都是相同的，出现在前面的表为驱动表，后面为被驱动表</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> t_role r<span class="token punctuation">,</span> t_user u<span class="token punctuation">,</span> user_role ur <span class="token keyword">WHERE</span> r<span class="token punctuation">.</span>id <span class="token operator">=</span> ur<span class="token punctuation">.</span>role_id <span class="token operator">AND</span> u<span class="token punctuation">.</span>id <span class="token operator">=</span> ur<span class="token punctuation">.</span>user_id <span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d6578706c61696e25453425423925384269642545372539422542382545352539302538432e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/c8ca1ace419dccfbce954ef88215277d7e39e7adcad5b9fee130d03197c7f5c4/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d6578706c61696e25453425423925384269642545372539422542382545352539302538432e706e67">https://camo.githubusercontent.com/c8ca1ace419dccfbce954ef88215277d7e39e7adcad5b9fee130d03197c7f5c4/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d6578706c61696e25453425423925384269642545372539422542382545352539302538432e706e67</a>)</p>
</li>
<li>
<p>id 不同时，id 值越大优先级越高，越先被执行</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> t_role <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> role_id <span class="token keyword">FROM</span> user_role <span class="token keyword">WHERE</span> user_id <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> id <span class="token keyword">FROM</span> t_user <span class="token keyword">WHERE</span> username <span class="token operator">=</span> <span class="token string">'stu1'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/cf8289bdd89227dcaa8d74bdf1947c504d1104a5d7ff8e2e3b15f53067aef2d0/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d6578706c61696e25453425423925384269642545342542382538442545352539302538432e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/cf8289bdd89227dcaa8d74bdf1947c504d1104a5d7ff8e2e3b15f53067aef2d0/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d6578706c61696e25453425423925384269642545342542382538442545352539302538432e706e67">https://camo.githubusercontent.com/cf8289bdd89227dcaa8d74bdf1947c504d1104a5d7ff8e2e3b15f53067aef2d0/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d6578706c61696e25453425423925384269642545342542382538442545352539302538432e706e67</a>)</p>
</li>
<li>
<p>id 有相同也有不同时，id 相同的可以认为是一组，从上往下顺序执行；在所有的组中，id 的值越大的组，优先级越高，越先执行</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> t_role r <span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> user_role ur <span class="token keyword">WHERE</span> ur<span class="token punctuation">.</span><span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token string">'2'</span><span class="token punctuation">)</span> a <span class="token keyword">WHERE</span> r<span class="token punctuation">.</span>id <span class="token operator">=</span> a<span class="token punctuation">.</span>role_id <span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d6578706c61696e25453425423925384269642545372539422542382545352539302538432545352539322538432545342542382538442545352539302538432e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/7d7e017e706f5813e492ffda1205f8077c7b928690016154410e7ab63cdd52d6/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d6578706c61696e25453425423925384269642545372539422542382545352539302538432545352539322538432545342542382538442545352539302538432e706e67">https://camo.githubusercontent.com/7d7e017e706f5813e492ffda1205f8077c7b928690016154410e7ab63cdd52d6/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d6578706c61696e25453425423925384269642545372539422542382545352539302538432545352539322538432545342542382538442545352539302538432e706e67</a>)</p>
</li>
<li>
<p>id 为 NULL 时代表的是临时表</p>
</li>
</ul>
<hr>
<h5 id="-142"><a class="markdownIt-Anchor" href="#-142">#</a> <a href="#select"></a>select</h5>
<p>表示查询中每个 select 子句的类型（简单 OR 复杂）</p>
<table>
<thead>
<tr>
<th>select_type</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>SIMPLE</td>
<td>简单的 SELECT 查询，查询中不包含子查询或者 UNION</td>
</tr>
<tr>
<td>PRIMARY</td>
<td>查询中若包含任何复杂的子查询，最外层（也就是最左侧）查询标记为该标识</td>
</tr>
<tr>
<td>UNION</td>
<td>对于 UNION 或者 UNION ALL 的复杂查询，除了最左侧的查询，其余的小查询都是 UNION</td>
</tr>
<tr>
<td>UNION RESULT</td>
<td>UNION 需要使用临时表进行去重，临时表的是 UNION RESULT</td>
</tr>
<tr>
<td>DEPENDENT UNION</td>
<td>对于 UNION 或者 UNION ALL 的复杂查询，如果各个小查询都依赖外层查询，是相关子查询，除了最左侧的小查询为 DEPENDENT SUBQUERY，其余都是 DEPENDENT UNION</td>
</tr>
<tr>
<td>SUBQUERY</td>
<td>子查询不是相关子查询，该子查询第一个 SELECT 代表的查询就是这种类型，会进行物化（该子查询只需要执行一次）</td>
</tr>
<tr>
<td>DEPENDENT SUBQUERY</td>
<td>子查询是相关子查询，该子查询第一个 SELECT 代表的查询就是这种类型，不会物化（该子查询需要执行多次）</td>
</tr>
<tr>
<td>DERIVED</td>
<td>在 FROM 列表中包含的子查询，被标记为 DERIVED（衍生），也就是生成物化派生表的这个子查询</td>
</tr>
<tr>
<td>MATERIALIZED</td>
<td>将子查询物化后与与外层进行连接查询，生成物化表的子查询</td>
</tr>
</tbody>
</table>
<p>子查询为 DERIVED： <code>SELECT * FROM (SELECT key1 FROM t1) AS derived_1 WHERE key1 &gt; 10</code></p>
<p>子查询为 MATERIALIZED： <code>SELECT * FROM t1 WHERE key1 IN (SELECT key1 FROM t2)</code></p>
<hr>
<h5 id="-143"><a class="markdownIt-Anchor" href="#-143">#</a> <a href="#type"></a>type</h5>
<p>对表的访问方式，表示 MySQL 在表中找到所需行的方式，又称访问类型</p>
<table>
<thead>
<tr>
<th>type</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>ALL</td>
<td>全表扫描，如果是 InnoDB 引擎是扫描聚簇索引</td>
</tr>
<tr>
<td>index</td>
<td>可以使用覆盖索引，但需要扫描全部索引</td>
</tr>
<tr>
<td>range</td>
<td>索引范围扫描，常见于 between、&lt;、&gt; 等的查询</td>
</tr>
<tr>
<td>index_subquery</td>
<td>子查询可以普通索引，则子查询的 type 为 index_subquery</td>
</tr>
<tr>
<td>unique_subquery</td>
<td>子查询可以使用主键或唯一二级索引，则子查询的 type 为 index_subquery</td>
</tr>
<tr>
<td>index_merge</td>
<td>索引合并</td>
</tr>
<tr>
<td>ref_or_null</td>
<td>非唯一性索引（普通二级索引）并且可以存储 NULL，进行等值匹配</td>
</tr>
<tr>
<td>ref</td>
<td>非唯一性索引与常量等值匹配</td>
</tr>
<tr>
<td>eq_ref</td>
<td>唯一性索引（主键或不存储 NULL 的唯一二级索引）进行等值匹配，如果二级索引是联合索引，那么所有联合的列都要进行等值匹配</td>
</tr>
<tr>
<td>const</td>
<td>通过主键或者唯一二级索引与常量进行等值匹配</td>
</tr>
<tr>
<td>system</td>
<td>system 是 const 类型的特例，当查询的表只有一条记录的情况下，使用 system</td>
</tr>
<tr>
<td>NULL</td>
<td>MySQL 在优化过程中分解语句，执行时甚至不用访问表或索引</td>
</tr>
</tbody>
</table>
<p>从上到下，性能从差到好，一般来说需要保证查询至少达到 range 级别， 最好达到 ref</p>
<hr>
<h5 id="-144"><a class="markdownIt-Anchor" href="#-144">#</a> <a href="#key"></a>key</h5>
<p>possible_keys：</p>
<ul>
<li>指出 MySQL 能使用哪个索引在表中找到记录，查询涉及到的字段上若存在索引，则该索引将被列出，但不一定被查询使用</li>
<li>如果该列是 NULL，则没有相关的索引</li>
</ul>
<p>key：</p>
<ul>
<li>显示 MySQL 在查询中实际使用的索引，若没有使用索引，显示为 NULL</li>
<li>查询中若使用了<strong>覆盖索引</strong>，则该索引可能出现在 key 列表，不出现在 possible_keys</li>
</ul>
<p>key_len：</p>
<ul>
<li>表示索引中使用的字节数，可通过该列计算查询中使用的索引的长度</li>
<li>key_len 显示的值为索引字段的最大可能长度，并非实际使用长度，即 key_len 是根据表定义计算而得，不是通过表内检索出的</li>
<li>在不损失精确性的前提下，长度越短越好</li>
</ul>
<hr>
<h5 id="-145"><a class="markdownIt-Anchor" href="#-145">#</a> <a href="#extra"></a>Extra</h5>
<p>其他的额外的执行计划信息，在该列展示：</p>
<ul>
<li>No tables used：查询语句中使用 FROM dual 或者没有 FROM 语句</li>
<li>Impossible WHERE：查询语句中的 WHERE 子句条件永远为 FALSE，会导致没有符合条件的行</li>
<li>Using index：该值表示相应的 SELECT 操作中使用了<strong>覆盖索引</strong>（Covering Index）</li>
<li>Using index condition：第一种情况是搜索条件中虽然出现了索引列，但是部分条件无法形成扫描区间（<strong>索引失效</strong>），会根据可用索引的条件先搜索一遍再匹配无法使用索引的条件，回表查询数据；第二种是使用了<strong>索引条件下推</strong>优化</li>
<li>Using where：搜索条件需要在 Server 层判断，判断后执行回表操作查询，无法使用索引下推</li>
<li>Using join buffer：连接查询被驱动表无法利用索引，需要连接缓冲区来存储中间结果</li>
<li>Using filesort：无法利用索引完成排序（优化方向），需要对数据使用外部排序算法，将取得的数据在内存或磁盘中进行排序</li>
<li>Using temporary：表示 MySQL 需要使用临时表来存储结果集，常见于排序、去重、分组等场景</li>
<li>Select tables optimized away：说明仅通过使用索引，优化器可能仅从聚合函数结果中返回一行</li>
<li>No tables used：Query 语句中使用 from dual 或不含任何 from 子句</li>
</ul>
<p>参考文章：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/ggjucheng/archive/2012/11/11/2765237.html">https://www.cnblogs.com/ggjucheng/archive/2012/11/11/2765237.html</a></p>
<hr>
<h4 id="-146"><a class="markdownIt-Anchor" href="#-146">#</a> <a href="#profiles"></a>PROFILES</h4>
<p>SHOW PROFILES 能够在做 SQL 优化时分析当前会话中语句执行的<strong>资源消耗</strong>情况</p>
<ul>
<li>
<p>通过 have_profiling 参数，能够看到当前 MySQL 是否支持 profile： [<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/4584e174502a9a9056de9860051b12d40ce07607bb74784a1277c49994f43511/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d686176655f70726f66696c696e672e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/4584e174502a9a9056de9860051b12d40ce07607bb74784a1277c49994f43511/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d686176655f70726f66696c696e672e706e67">https://camo.githubusercontent.com/4584e174502a9a9056de9860051b12d40ce07607bb74784a1277c49994f43511/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d686176655f70726f66696c696e672e706e67</a>)</p>
</li>
<li>
<p>默认 profiling 是关闭的，可以通过 set 语句在 Session 级别开启 profiling：</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d70726f66696c696e672e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/846e880c367721f87cafd58473bdd7573871154f5f624b2ef47da472576844dd/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d70726f66696c696e672e706e67">https://camo.githubusercontent.com/846e880c367721f87cafd58473bdd7573871154f5f624b2ef47da472576844dd/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d70726f66696c696e672e706e67</a>)</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SET</span> profiling<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">#开启profiling 开关；</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>执行 SHOW PROFILES 指令， 来查看 SQL 语句执行的耗时:</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SHOW</span> PROFILES<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/ba646632d3a2e96b2639b7bbbcb3f033f107c6cc95094089ee69d7410d97a73e/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453625394625413525453725394325384253514c2545382541462541442545352538462541352545362538392541372545382541312538432545382538302539372545362539372542362e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/ba646632d3a2e96b2639b7bbbcb3f033f107c6cc95094089ee69d7410d97a73e/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453625394625413525453725394325384253514c2545382541462541442545352538462541352545362538392541372545382541312538432545382538302539372545362539372542362e706e67">https://camo.githubusercontent.com/ba646632d3a2e96b2639b7bbbcb3f033f107c6cc95094089ee69d7410d97a73e/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453625394625413525453725394325384253514c2545382541462541442545352538462541352545362538392541372545382541312538432545382538302539372545362539372542362e706e67</a>)</p>
</li>
<li>
<p>查看到该 SQL 执行过程中每个线程的状态和消耗的时间：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SHOW</span> PROFILE <span class="token keyword">FOR</span> QUERY query_id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/db68e55d3d08ed16887ef20192b2bac33e34f93fea30569abcadea719093f612/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d53514c2545362538392541372545382541312538432545362541462538462545342542382541412545372538412542362545362538302538312545362542362538382545382538302539372545372539412538342545362539372542362545392539372542342e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/db68e55d3d08ed16887ef20192b2bac33e34f93fea30569abcadea719093f612/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d53514c2545362538392541372545382541312538432545362541462538462545342542382541412545372538412542362545362538302538312545362542362538382545382538302539372545372539412538342545362539372542362545392539372542342e706e67">https://camo.githubusercontent.com/db68e55d3d08ed16887ef20192b2bac33e34f93fea30569abcadea719093f612/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d53514c2545362538392541372545382541312538432545362541462538462545342542382541412545372538412542362545362538302538312545362542362538382545382538302539372545372539412538342545362539372542362545392539372542342e706e67</a>)</p>
<p><strong>Sending data 状态</strong>表示 MySQL 线程开始访问数据行并把结果返回给客户端，而不仅仅是返回给客户端。由于在 Sending data 状态下，MySQL 线程需要做大量磁盘读取操作，所以是整个查询中耗时最长的状态。</p>
</li>
<li>
<p>在获取到最消耗时间的线程状态后，MySQL 支持选择 all、cpu、block io 、context switch、page faults 等类型查看 MySQL 在使用什么资源上耗费了过高的时间。例如，选择查看 CPU 的耗费时间：</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d53514c2545362538392541372545382541312538432545362541462538462545342542382541412545372538412542362545362538302538312545362542362538382545382538302539372545372539412538344350552e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/36aeab5b1a36159013b31ca8b917a6973d5bb51f1bc4298f84638263142e52fa/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d53514c2545362538392541372545382541312538432545362541462538462545342542382541412545372538412542362545362538302538312545362542362538382545382538302539372545372539412538344350552e706e67">https://camo.githubusercontent.com/36aeab5b1a36159013b31ca8b917a6973d5bb51f1bc4298f84638263142e52fa/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d53514c2545362538392541372545382541312538432545362541462538462545342542382541412545372538412542362545362538302538312545362542362538382545382538302539372545372539412538344350552e706e67</a>)</p>
<ul>
<li>Status：SQL 语句执行的状态</li>
<li>Durationsql：执行过程中每一个步骤的耗时</li>
<li>CPU_user：当前用户占有的 CPU</li>
<li>CPU_system：系统占有的 CPU</li>
</ul>
</li>
</ul>
<hr>
<h4 id="-147"><a class="markdownIt-Anchor" href="#-147">#</a> <a href="#trace"></a>TRACE</h4>
<p>MySQL 提供了对 SQL 的跟踪， 通过 trace 文件可以查看优化器生成执行计划的过程</p>
<ul>
<li>
<p>打开 trace 功能，设置格式为 JSON，并设置 trace 的最大使用内存，避免解析过程中因默认内存过小而不能够完整展示</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SET</span> optimizer_trace<span class="token operator">=</span><span class="token string">"enabled=on"</span><span class="token punctuation">,</span>end_markers_in_json<span class="token operator">=</span><span class="token keyword">ON</span><span class="token punctuation">;</span>	<span class="token comment">-- 会话内有效</span>
<span class="token keyword">SET</span> optimizer_trace_max_mem_size<span class="token operator">=</span><span class="token number">1000000</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li>
<p>执行 SQL 语句：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tb_item <span class="token keyword">WHERE</span> id <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>检查 information_schema.optimizer_trace：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> information_schema<span class="token punctuation">.</span>optimizer_trace \G<span class="token punctuation">;</span> <span class="token comment">-- \G代表竖列展示</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>执行信息主要有三个阶段：prepare 阶段、optimize 阶段（成本分析）、execute 阶段（执行）</p>
</li>
</ul>
<hr>
<h3 id="-148"><a class="markdownIt-Anchor" href="#-148">#</a> <a href="#%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88"></a>索引失效</h3>
<h4 id="-149"><a class="markdownIt-Anchor" href="#-149">#</a> <a href="#%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95"></a>创建索引</h4>
<p>索引是数据库优化最重要的手段之一，通过索引通常可以帮助用户解决大多数的 MySQL 的性能优化问题</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>tb_seller<span class="token punctuation">`</span> <span class="token punctuation">(</span>
	<span class="token punctuation">`</span>sellerid<span class="token punctuation">`</span> <span class="token keyword">varchar</span> <span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token keyword">varchar</span> <span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">`</span>nickname<span class="token punctuation">`</span> <span class="token keyword">varchar</span> <span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">`</span>password<span class="token punctuation">`</span> <span class="token keyword">varchar</span> <span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">`</span><span class="token keyword">status</span><span class="token punctuation">`</span> <span class="token keyword">varchar</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">`</span>address<span class="token punctuation">`</span> <span class="token keyword">varchar</span> <span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">`</span>createtime<span class="token punctuation">`</span> <span class="token keyword">datetime</span><span class="token punctuation">,</span>
    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">(</span><span class="token punctuation">`</span>sellerid<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">INNODB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>tb_seller<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>sellerid<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>nickname<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>password<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span><span class="token keyword">status</span><span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>address<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>createtime<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">'xiaomi'</span><span class="token punctuation">,</span><span class="token string">'小米科技'</span><span class="token punctuation">,</span><span class="token string">'小米官方旗舰店'</span><span class="token punctuation">,</span><span class="token string">'e10adc3949ba59abbe56e057f20f883e'</span><span class="token punctuation">,</span><span class="token string">'1'</span><span class="token punctuation">,</span><span class="token string">'西安市'</span><span class="token punctuation">,</span><span class="token string">'2088-01-01 12:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_seller_name_sta_addr <span class="token keyword">ON</span> tb_seller<span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token keyword">status</span><span class="token punctuation">,</span> address<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/627f9b60b48fc3e95e877f889b30c19d455b783ecd57131dfd6424bd370f69c0/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c2545342542442542462545372539342541382545372542342541322545352542432539352545372538452541462545352541322538332545352538372538362545352541342538372e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/627f9b60b48fc3e95e877f889b30c19d455b783ecd57131dfd6424bd370f69c0/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c2545342542442542462545372539342541382545372542342541322545352542432539352545372538452541462545352541322538332545352538372538362545352541342538372e706e67">https://camo.githubusercontent.com/627f9b60b48fc3e95e877f889b30c19d455b783ecd57131dfd6424bd370f69c0/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c2545342542442542462545372539342541382545372542342541322545352542432539352545372538452541462545352541322538332545352538372538362545352541342538372e706e67</a>)</p>
<hr>
<h4 id="-150"><a class="markdownIt-Anchor" href="#-150">#</a> <a href="#%E9%81%BF%E5%85%8D%E5%A4%B1%E6%95%88"></a>避免失效</h4>
<h5 id="-151"><a class="markdownIt-Anchor" href="#-151">#</a> <a href="#%E8%AF%AD%E5%8F%A5%E9%94%99%E8%AF%AF"></a>语句错误</h5>
<ul>
<li>
<p>全值匹配：对索引中所有列都指定具体值，这种情况索引生效，执行效率高</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tb_seller <span class="token keyword">WHERE</span> name<span class="token operator">=</span><span class="token string">'小米科技'</span> <span class="token operator">AND</span> <span class="token keyword">status</span><span class="token operator">=</span><span class="token string">'1'</span> <span class="token operator">AND</span> address<span class="token operator">=</span><span class="token string">'西安市'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/d4516dbe85cad297e91b9499c82efd92d50c765df9a948d7bab48d3af1cf87a6/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c254534254244254246254537253934254138254537254234254132254535254243253935312e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/d4516dbe85cad297e91b9499c82efd92d50c765df9a948d7bab48d3af1cf87a6/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c254534254244254246254537253934254138254537254234254132254535254243253935312e706e67">https://camo.githubusercontent.com/d4516dbe85cad297e91b9499c82efd92d50c765df9a948d7bab48d3af1cf87a6/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c254534254244254246254537253934254138254537254234254132254535254243253935312e706e67</a>)</p>
</li>
<li>
<p><strong>最左前缀法则</strong>：联合索引遵守最左前缀法则</p>
<p>匹配最左前缀法则，走索引：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tb_seller <span class="token keyword">WHERE</span> name<span class="token operator">=</span><span class="token string">'小米科技'</span><span class="token punctuation">;</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tb_seller <span class="token keyword">WHERE</span> name<span class="token operator">=</span><span class="token string">'小米科技'</span> <span class="token operator">AND</span> <span class="token keyword">status</span><span class="token operator">=</span><span class="token string">'1'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c254534254244254246254537253934254138254537254234254132254535254243253935322e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/721897bd44f2f224902766ca15a3a477be44cadc4449556f57d3a8d491c925b1/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c254534254244254246254537253934254138254537254234254132254535254243253935322e706e67">https://camo.githubusercontent.com/721897bd44f2f224902766ca15a3a477be44cadc4449556f57d3a8d491c925b1/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c254534254244254246254537253934254138254537254234254132254535254243253935322e706e67</a>)</p>
<p>违法最左前缀法则 ， 索引失效：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tb_seller <span class="token keyword">WHERE</span> <span class="token keyword">status</span><span class="token operator">=</span><span class="token string">'1'</span><span class="token punctuation">;</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tb_seller <span class="token keyword">WHERE</span> <span class="token keyword">status</span><span class="token operator">=</span><span class="token string">'1'</span> <span class="token operator">AND</span> address<span class="token operator">=</span><span class="token string">'西安市'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c254534254244254246254537253934254138254537254234254132254535254243253935332e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/f4f4a6f50ae2958f942a906ab8e9eb1c861ee7ef206ba3d9f9a841815ca3e6fd/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c254534254244254246254537253934254138254537254234254132254535254243253935332e706e67">https://camo.githubusercontent.com/f4f4a6f50ae2958f942a906ab8e9eb1c861ee7ef206ba3d9f9a841815ca3e6fd/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c254534254244254246254537253934254138254537254234254132254535254243253935332e706e67</a>)</p>
<p>如果符合最左法则，但是出现跳跃某一列，只有最左列索引生效：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tb_seller <span class="token keyword">WHERE</span> name<span class="token operator">=</span><span class="token string">'小米科技'</span> <span class="token operator">AND</span> address<span class="token operator">=</span><span class="token string">'西安市'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/e3925c673d75665328ffb9ab25a9b2b0a909f2e4d41a783a792746327e03e645/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c254534254244254246254537253934254138254537254234254132254535254243253935342e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/e3925c673d75665328ffb9ab25a9b2b0a909f2e4d41a783a792746327e03e645/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c254534254244254246254537253934254138254537254234254132254535254243253935342e706e67">https://camo.githubusercontent.com/e3925c673d75665328ffb9ab25a9b2b0a909f2e4d41a783a792746327e03e645/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c254534254244254246254537253934254138254537254234254132254535254243253935342e706e67</a>)</p>
<p>虽然索引列失效，但是系统<strong>使用了索引下推进行了优化</strong></p>
</li>
<li>
<p><strong>范围查询</strong>右边的列，不能使用索引：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tb_seller <span class="token keyword">WHERE</span> name<span class="token operator">=</span><span class="token string">'小米科技'</span> <span class="token operator">AND</span> <span class="token keyword">status</span><span class="token operator">></span><span class="token string">'1'</span> <span class="token operator">AND</span> address<span class="token operator">=</span><span class="token string">'西安市'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>根据前面的两个字段 name ， status 查询是走索引的， 但是最后一个条件 address 没有用到索引，使用了索引下推</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/f7a19fc83ba8449a2f722e62a46789ee3a9370e5e301adfb0e346c8f97e9acf0/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c254534254244254246254537253934254138254537254234254132254535254243253935352e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/f7a19fc83ba8449a2f722e62a46789ee3a9370e5e301adfb0e346c8f97e9acf0/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c254534254244254246254537253934254138254537254234254132254535254243253935352e706e67">https://camo.githubusercontent.com/f7a19fc83ba8449a2f722e62a46789ee3a9370e5e301adfb0e346c8f97e9acf0/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c254534254244254246254537253934254138254537254234254132254535254243253935352e706e67</a>)</p>
</li>
<li>
<p>在索引列上进行<strong>运算操作</strong>， 索引将失效：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tb_seller <span class="token keyword">WHERE</span> SUBSTRING<span class="token punctuation">(</span>name<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">'科技'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c254534254244254246254537253934254138254537254234254132254535254243253935362e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/9d703c187c02bb22c5eb837d4d5038f81b61001ad8316f31aca8d15bdd12444e/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c254534254244254246254537253934254138254537254234254132254535254243253935362e706e67">https://camo.githubusercontent.com/9d703c187c02bb22c5eb837d4d5038f81b61001ad8316f31aca8d15bdd12444e/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c254534254244254246254537253934254138254537254234254132254535254243253935362e706e67</a>)</p>
</li>
<li>
<p><strong>字符串不加单引号</strong>，造成索引失效：</p>
<p>在查询时，没有对字符串加单引号，MySQL 的查询优化器，会自动的进行类型转换，造成索引失效</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tb_seller <span class="token keyword">WHERE</span> name<span class="token operator">=</span><span class="token string">'小米科技'</span> <span class="token operator">AND</span> <span class="token keyword">status</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/c4a83d343da999304833e94f61b1ae9d40751f4c8caef665069feb6a2b56aeaf/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c254534254244254246254537253934254138254537254234254132254535254243253935372e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/c4a83d343da999304833e94f61b1ae9d40751f4c8caef665069feb6a2b56aeaf/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c254534254244254246254537253934254138254537254234254132254535254243253935372e706e67">https://camo.githubusercontent.com/c4a83d343da999304833e94f61b1ae9d40751f4c8caef665069feb6a2b56aeaf/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c254534254244254246254537253934254138254537254234254132254535254243253935372e706e67</a>)</p>
</li>
<li>
<p><strong>用 OR 分割条件，索引失效</strong>，导致全表查询：</p>
<p>OR 前的条件中的列有索引而后面的列中没有索引或 OR 前后两个列是同一个复合索引，都造成索引失效</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tb_seller <span class="token keyword">WHERE</span> name<span class="token operator">=</span><span class="token string">'阿里巴巴'</span> <span class="token operator">OR</span> createtime <span class="token operator">=</span> <span class="token string">'2088-01-01 12:00:00'</span><span class="token punctuation">;</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tb_seller <span class="token keyword">WHERE</span> name<span class="token operator">=</span><span class="token string">'小米科技'</span> <span class="token operator">OR</span> <span class="token keyword">status</span><span class="token operator">=</span><span class="token string">'1'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/2b0f757287f696c14066bd87eabeeb8ec69593ee789ff54f6be69f7cd458f372/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c25453425424425424625453725393425413825453725423425413225453525424325393531302e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/2b0f757287f696c14066bd87eabeeb8ec69593ee789ff54f6be69f7cd458f372/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c25453425424425424625453725393425413825453725423425413225453525424325393531302e706e67">https://camo.githubusercontent.com/2b0f757287f696c14066bd87eabeeb8ec69593ee789ff54f6be69f7cd458f372/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c25453425424425424625453725393425413825453725423425413225453525424325393531302e706e67</a>)</p>
<p><strong>AND 分割的条件不影响</strong>：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tb_seller <span class="token keyword">WHERE</span> name<span class="token operator">=</span><span class="token string">'阿里巴巴'</span> <span class="token operator">AND</span> createtime <span class="token operator">=</span> <span class="token string">'2088-01-01 12:00:00'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c25453425424425424625453725393425413825453725423425413225453525424325393531312e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/1736ec9d364fc348cc6ba201be8e036dd165a8f9e66a3d61b813391554218bd9/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c25453425424425424625453725393425413825453725423425413225453525424325393531312e706e67">https://camo.githubusercontent.com/1736ec9d364fc348cc6ba201be8e036dd165a8f9e66a3d61b813391554218bd9/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c25453425424425424625453725393425413825453725423425413225453525424325393531312e706e67</a>)</p>
</li>
<li>
<p><strong>以 % 开头的 LIKE 模糊查询</strong>，索引失效：</p>
<p>如果是尾部模糊匹配，索引不会失效；如果是头部模糊匹配，索引失效。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tb_seller <span class="token keyword">WHERE</span> name <span class="token operator">like</span> <span class="token string">'%科技%'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c25453425424425424625453725393425413825453725423425413225453525424325393531322e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/ed6371eb96cbbc0ba25a8462f006cf4c96a50c50e5a6e43d13927a1838b750e4/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c25453425424425424625453725393425413825453725423425413225453525424325393531322e706e67">https://camo.githubusercontent.com/ed6371eb96cbbc0ba25a8462f006cf4c96a50c50e5a6e43d13927a1838b750e4/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c25453425424425424625453725393425413825453725423425413225453525424325393531322e706e67</a>)</p>
<p>解决方案：通过覆盖索引来解决</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> sellerid<span class="token punctuation">,</span>name<span class="token punctuation">,</span><span class="token keyword">status</span> <span class="token keyword">FROM</span> tb_seller <span class="token keyword">WHERE</span> name <span class="token operator">like</span> <span class="token string">'%科技%'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/70f5622eb6b15a0c1129a78fda90f7ec70c33dabe735a7b2da19037161ca1257/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c25453425424425424625453725393425413825453725423425413225453525424325393531332e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/70f5622eb6b15a0c1129a78fda90f7ec70c33dabe735a7b2da19037161ca1257/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c25453425424425424625453725393425413825453725423425413225453525424325393531332e706e67">https://camo.githubusercontent.com/70f5622eb6b15a0c1129a78fda90f7ec70c33dabe735a7b2da19037161ca1257/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c25453425424425424625453725393425413825453725423425413225453525424325393531332e706e67</a>)</p>
<p>原因：在覆盖索引的这棵 B+ 数上只需要进行 like 的匹配，或者是基于覆盖索引查询再进行 WHERE 的判断就可以获得结果</p>
</li>
</ul>
<hr>
<h5 id="-152"><a class="markdownIt-Anchor" href="#-152">#</a> <a href="#%E7%B3%BB%E7%BB%9F%E4%BC%98%E5%8C%96-1"></a>系统优化</h5>
<p>系统优化为全表扫描：</p>
<ul>
<li>
<p>如果 MySQL 评估使用索引比全表更慢，则不使用索引，索引失效：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_address <span class="token keyword">ON</span> tb_seller<span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tb_seller <span class="token keyword">WHERE</span> address<span class="token operator">=</span><span class="token string">'西安市'</span><span class="token punctuation">;</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tb_seller <span class="token keyword">WHERE</span> address<span class="token operator">=</span><span class="token string">'北京市'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>北京市的键值占 9/10（区分度低），所以优化为全表扫描，type = ALL</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c25453425424425424625453725393425413825453725423425413225453525424325393531342e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/382ebdee57803d41a06d089bf0a0e577b3ec68bd8491b7ee4f05986de4ea2151/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c25453425424425424625453725393425413825453725423425413225453525424325393531342e706e67">https://camo.githubusercontent.com/382ebdee57803d41a06d089bf0a0e577b3ec68bd8491b7ee4f05986de4ea2151/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c25453425424425424625453725393425413825453725423425413225453525424325393531342e706e67</a>)</p>
</li>
<li>
<p>IS NULL、IS NOT NULL <strong>有时</strong>索引失效：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tb_seller <span class="token keyword">WHERE</span> name <span class="token operator">IS</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tb_seller <span class="token keyword">WHERE</span> name <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>NOT NULL 失效的原因是 name 列全部不是 null，优化为全表扫描，当 NULL 过多时，IS NULL 失效</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/9f6f553a2a744405f6987028ef1cfc19aacec866db42ba8f4bdf0a3b5cb13492/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c25453425424425424625453725393425413825453725423425413225453525424325393531352e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/9f6f553a2a744405f6987028ef1cfc19aacec866db42ba8f4bdf0a3b5cb13492/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c25453425424425424625453725393425413825453725423425413225453525424325393531352e706e67">https://camo.githubusercontent.com/9f6f553a2a744405f6987028ef1cfc19aacec866db42ba8f4bdf0a3b5cb13492/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c25453425424425424625453725393425413825453725423425413225453525424325393531352e706e67</a>)</p>
</li>
<li>
<p>IN 肯定会走索引，但是当 IN 的取值范围较大时会导致索引失效，走全表扫描：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tb_seller <span class="token keyword">WHERE</span> sellerId <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'alibaba'</span><span class="token punctuation">,</span><span class="token string">'huawei'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">-- 都走索引</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tb_seller <span class="token keyword">WHERE</span> sellerId <span class="token operator">NOT</span> <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'alibaba'</span><span class="token punctuation">,</span><span class="token string">'huawei'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
</ul>
<hr>
<h4 id="-153"><a class="markdownIt-Anchor" href="#-153">#</a> <a href="#%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86"></a>底层原理</h4>
<p>索引失效一般是针对联合索引，联合索引一般由几个字段组成，排序方式是先按照第一个字段进行排序，然后排序第二个，依此类推，图示（a, b）索引，<strong>a 相等的情况下 b 是有序的</strong></p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2de7b4a2e5bc95e5a4b1e69588e5ba95e5b182e58e9fe79086312e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/7b1876c4b9eb0b38761887d3cf2d53f6eaa12313711d2dd7ef363755e5d94ba0/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2de7b4a2e5bc95e5a4b1e69588e5ba95e5b182e58e9fe79086312e706e67">https://camo.githubusercontent.com/7b1876c4b9eb0b38761887d3cf2d53f6eaa12313711d2dd7ef363755e5d94ba0/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2de7b4a2e5bc95e5a4b1e69588e5ba95e5b182e58e9fe79086312e706e67</a>)</p>
<ul>
<li>
<p>最左前缀法则：当不匹配前面的字段的时候，后面的字段都是无序的。这种无序不仅体现在叶子节点，也会<strong>导致查询时扫描的非叶子节点也是无序的</strong>，因为索引树相当于忽略的第一个字段，就无法使用二分查找</p>
</li>
<li>
<p>范围查询右边的列，不能使用索引，比如语句：  <code>WHERE a &gt; 1 AND b = 1</code>  ，在 a 大于 1 的时候，b 是无序的，a &gt; 1 是扫描时有序的，但是找到以后进行寻找 b 时，索引树就不是有序的了</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2de7b4a2e5bc95e5a4b1e69588e5ba95e5b182e58e9fe79086322e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/8b6a2740049ea6f538031335e391fd90af31942e76dd73abe967e498a7c3d865/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2de7b4a2e5bc95e5a4b1e69588e5ba95e5b182e58e9fe79086322e706e67">https://camo.githubusercontent.com/8b6a2740049ea6f538031335e391fd90af31942e76dd73abe967e498a7c3d865/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2de7b4a2e5bc95e5a4b1e69588e5ba95e5b182e58e9fe79086322e706e67</a>)</p>
</li>
<li>
<p>以 % 开头的 LIKE 模糊查询，索引失效，比如语句： <code>WHERE a LIKE '%d'</code> ，前面的不确定，导致不符合最左匹配，直接去索引中搜索以 d 结尾的节点，所以没有顺序 [<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d254537254234254132254535254243253935254535254134254231254536253935253838254535254241253935254535254231253832254535253845253946254537253930253836332e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/f8472f9a966dfeac4f3dbc62cea0c362f1f4fa630ae3a007f0b15f7f6c1ad65e/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d254537254234254132254535254243253935254535254134254231254536253935253838254535254241253935254535254231253832254535253845253946254537253930253836332e706e67">https://camo.githubusercontent.com/f8472f9a966dfeac4f3dbc62cea0c362f1f4fa630ae3a007f0b15f7f6c1ad65e/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d254537254234254132254535254243253935254535254134254231254536253935253838254535254241253935254535254231253832254535253845253946254537253930253836332e706e67</a>)</p>
</li>
</ul>
<p>参考文章：<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/B_M09dzLe9w7cT46rdGIeQ">https://mp.weixin.qq.com/s/B_M09dzLe9w7cT46rdGIeQ</a></p>
<hr>
<h4 id="-154"><a class="markdownIt-Anchor" href="#-154">#</a> <a href="#%E6%9F%A5%E7%9C%8B%E7%B4%A2%E5%BC%95"></a>查看索引</h4>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SHOW</span> <span class="token keyword">STATUS</span> <span class="token operator">LIKE</span> <span class="token string">'Handler_read%'</span><span class="token punctuation">;</span>	
<span class="token keyword">SHOW</span> <span class="token keyword">GLOBAL</span> <span class="token keyword">STATUS</span> <span class="token operator">LIKE</span> <span class="token string">'Handler_read%'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/993308f2f41979d523cd70f23e0effb76a776dad6ffdc5f8f00fbb21d9e33851/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c2545362539462541352545372539432538422545372542342541322545352542432539352545342542442542462545372539342541382545362538332538352545352538362542352e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/993308f2f41979d523cd70f23e0effb76a776dad6ffdc5f8f00fbb21d9e33851/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c2545362539462541352545372539432538422545372542342541322545352542432539352545342542442542462545372539342541382545362538332538352545352538362542352e706e67">https://camo.githubusercontent.com/993308f2f41979d523cd70f23e0effb76a776dad6ffdc5f8f00fbb21d9e33851/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c2545362539462541352545372539432538422545372542342541322545352542432539352545342542442542462545372539342541382545362538332538352545352538362542352e706e67</a>)</p>
<ul>
<li>
<p>Handler_read_first：索引中第一条被读的次数，如果较高，表示服务器正执行大量全索引扫描（这个值越低越好）</p>
</li>
<li>
<p>Handler_read_key：如果索引正在工作，这个值代表一个行被索引值读的次数，值越低表示索引不经常使用（这个值越高越好）</p>
</li>
<li>
<p>Handler_read_next：按照键顺序读下一行的请求数，如果范围约束或执行索引扫描来查询索引列，值增加</p>
</li>
<li>
<p>Handler_read_prev：按照键顺序读前一行的请求数，该读方法主要用于优化 ORDER BY … DESC</p>
</li>
<li>
<p>Handler_read_rnd：根据固定位置读一行的请求数，如果执行大量查询并对结果进行排序则该值较高，可能是使用了大量需要 MySQL 扫描整个表的查询或连接，这个值较高意味着运行效率低，应该建立索引来解决</p>
</li>
<li>
<p>Handler_read_rnd_next：在数据文件中读下一行的请求数，如果正进行大量的表扫描，该值较高，说明表索引不正确或写入的查询没有利用索引</p>
</li>
</ul>
<hr>
<h3 id="-155"><a class="markdownIt-Anchor" href="#-155">#</a> <a href="#sql-%E4%BC%98%E5%8C%96"></a>SQL 优化</h3>
<h4 id="-156"><a class="markdownIt-Anchor" href="#-156">#</a> <a href="#%E8%A6%86%E7%9B%96%E7%B4%A2%E5%BC%95-1"></a>覆盖索引</h4>
<p>复合索引叶子节点不仅保存了复合索引的值，还有主键索引，所以使用覆盖索引的时候，加上主键也会用到索引</p>
<p>尽量使用覆盖索引，避免 SELECT *：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> name<span class="token punctuation">,</span><span class="token keyword">status</span><span class="token punctuation">,</span>address <span class="token keyword">FROM</span> tb_seller <span class="token keyword">WHERE</span> name<span class="token operator">=</span><span class="token string">'小米科技'</span> <span class="token operator">AND</span> <span class="token keyword">status</span><span class="token operator">=</span><span class="token string">'1'</span> <span class="token operator">AND</span> address<span class="token operator">=</span><span class="token string">'西安市'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c254534254244254246254537253934254138254537254234254132254535254243253935382e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/0665a36e7f2e43078ed33efbde6fadfdf04d366e9601d8051c72b3e85595080b/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c254534254244254246254537253934254138254537254234254132254535254243253935382e706e67">https://camo.githubusercontent.com/0665a36e7f2e43078ed33efbde6fadfdf04d366e9601d8051c72b3e85595080b/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c254534254244254246254537253934254138254537254234254132254535254243253935382e706e67</a>)</p>
<p>如果查询列，超出索引列，也会降低性能：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> name<span class="token punctuation">,</span><span class="token keyword">status</span><span class="token punctuation">,</span>address<span class="token punctuation">,</span>password <span class="token keyword">FROM</span> tb_seller <span class="token keyword">WHERE</span> name<span class="token operator">=</span><span class="token string">'小米科技'</span> <span class="token operator">AND</span> <span class="token keyword">status</span><span class="token operator">=</span><span class="token string">'1'</span> <span class="token operator">AND</span> address<span class="token operator">=</span><span class="token string">'西安市'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c254534254244254246254537253934254138254537254234254132254535254243253935392e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/0dc76f01647dca3950293917ac01988d70580d8e4eac76b511cc10fa07be04a5/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c254534254244254246254537253934254138254537254234254132254535254243253935392e706e67">https://camo.githubusercontent.com/0dc76f01647dca3950293917ac01988d70580d8e4eac76b511cc10fa07be04a5/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c254534254244254246254537253934254138254537254234254132254535254243253935392e706e67</a>)</p>
<hr>
<h4 id="-157"><a class="markdownIt-Anchor" href="#-157">#</a> <a href="#%E5%87%8F%E5%B0%91%E8%AE%BF%E9%97%AE"></a>减少访问</h4>
<p>避免对数据进行重复检索：能够一次连接就获取到结果的，就不用两次连接，这样可以大大减少对数据库无用的重复请求</p>
<ul>
<li>
<p>查询数据：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> id<span class="token punctuation">,</span>name <span class="token keyword">FROM</span> tb_book<span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> id<span class="token punctuation">,</span><span class="token keyword">status</span> <span class="token keyword">FROM</span> tb_book<span class="token punctuation">;</span> <span class="token comment">-- 向数据库提交两次请求，数据库就要做两次查询操作</span>
<span class="token comment">-- > 优化为:</span>
<span class="token keyword">SELECT</span> id<span class="token punctuation">,</span>name<span class="token punctuation">,</span>statu <span class="token keyword">FROM</span> tb_book<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>插入数据：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tb_test <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'Tom'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tb_test <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'Cat'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tb_test <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">'Jerry'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">-- 连接三次数据库</span>
<span class="token comment">-- >优化为</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tb_test <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'Tom'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'Cat'</span><span class="token punctuation">)</span>，<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">'Jerry'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">-- 连接一次</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>在事务中进行数据插入：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">start</span> <span class="token keyword">transaction</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tb_test <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'Tom'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tb_test <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'Cat'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tb_test <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">'Jerry'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">commit</span><span class="token punctuation">;</span>	<span class="token comment">-- 手动提交，分段提交</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>数据有序插入：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tb_test <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'Tom'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tb_test <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'Cat'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tb_test <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">'Jerry'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<p>增加 cache 层：在应用中增加缓存层来达到减轻数据库负担的目的。可以部分数据从数据库中抽取出来放到应用端以文本方式存储，或者使用框架（Mybatis）提供的一级缓存 / 二级缓存，或者使用 Redis 数据库来缓存数据</p>
<hr>
<h4 id="-158"><a class="markdownIt-Anchor" href="#-158">#</a> <a href="#%E6%95%B0%E6%8D%AE%E6%8F%92%E5%85%A5"></a>数据插入</h4>
<p>当使用 load 命令导入数据的时候，适当的设置可以提高导入的效率：</p>
<p>![](<a target="_blank" rel="noopener" href="https://gitee.com/seazean/images/raw/master/DB/MySQL-%E4%BC%98%E5%8C%96SQL">https://gitee.com/seazean/images/raw/master/DB/MySQL - 优化 SQL</a> load data.png)</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">LOAD</span> <span class="token keyword">DATA</span> <span class="token keyword">LOCAL</span> <span class="token keyword">INFILE</span> <span class="token operator">=</span> <span class="token string">'/home/seazean/sql1.log'</span> <span class="token keyword">INTO</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>tb_user_1<span class="token punctuation">`</span> FIELD <span class="token keyword">TERMINATED</span> <span class="token keyword">BY</span> <span class="token string">','</span> <span class="token keyword">LINES</span> <span class="token keyword">TERMINATED</span> <span class="token keyword">BY</span> <span class="token string">'\n'</span><span class="token punctuation">;</span> <span class="token comment">-- 文件格式如上图</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>对于 InnoDB 类型的表，有以下几种方式可以提高导入的效率：</p>
<ol>
<li>
<p><strong>主键顺序插入</strong>：因为 InnoDB 类型的表是按照主键的顺序保存的，所以将导入的数据按照主键的顺序排列，可以有效的提高导入数据的效率，如果 InnoDB 表没有主键，那么系统会自动默认创建一个内部列作为主键。</p>
<p><strong>主键是否连续对性能影响不大，只要是递增的就可以</strong>，比如雪花算法产生的 ID 不是连续的，但是是递增的</p>
<ul>
<li>插入 ID 顺序排列数据：</li>
</ul>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/a7d9a7988bfe6902419b95affb16941fbce9463db4ac525f55e80b7a0d47068d/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c25453625384625393225453525383525413549442545392541312542412545352542412538462545362538452539322545352538382539372545362539352542302545362538442541452e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/a7d9a7988bfe6902419b95affb16941fbce9463db4ac525f55e80b7a0d47068d/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c25453625384625393225453525383525413549442545392541312542412545352542412538462545362538452539322545352538382539372545362539352542302545362538442541452e706e67">https://camo.githubusercontent.com/a7d9a7988bfe6902419b95affb16941fbce9463db4ac525f55e80b7a0d47068d/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c25453625384625393225453525383525413549442545392541312542412545352542412538462545362538452539322545352538382539372545362539352542302545362538442541452e706e67</a>)</p>
<ul>
<li>插入 ID 无序排列数据：</li>
</ul>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/869d084121978ad48f1a95a153bfa990416c0ab457b4308810fd38f6b159c31d/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c25453625384625393225453525383525413549442545362539372541302545352542412538462545362538452539322545352538382539372545362539352542302545362538442541452e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/869d084121978ad48f1a95a153bfa990416c0ab457b4308810fd38f6b159c31d/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c25453625384625393225453525383525413549442545362539372541302545352542412538462545362538452539322545352538382539372545362539352542302545362538442541452e706e67">https://camo.githubusercontent.com/869d084121978ad48f1a95a153bfa990416c0ab457b4308810fd38f6b159c31d/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c25453625384625393225453525383525413549442545362539372541302545352542412538462545362538452539322545352538382539372545362539352542302545362538442541452e706e67</a>)</p>
</li>
<li>
<p><strong>关闭唯一性校验</strong>：在导入数据前执行  <code>SET UNIQUE_CHECKS=0</code> ，关闭唯一性校验；导入结束后执行  <code>SET UNIQUE_CHECKS=1</code> ，恢复唯一性校验，可以提高导入的效率。</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c2545362538462539322545352538352541352545362539352542302545362538442541452545352538352542332545392539372541442545352539342541462545342542382538302545362538302541372545362541302541312545392541412538432e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/308defc11a83855696b1574c8b54aedfae590b1faeebc06a6afb9a4718365021/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c2545362538462539322545352538352541352545362539352542302545362538442541452545352538352542332545392539372541442545352539342541462545342542382538302545362538302541372545362541302541312545392541412538432e706e67">https://camo.githubusercontent.com/308defc11a83855696b1574c8b54aedfae590b1faeebc06a6afb9a4718365021/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c2545362538462539322545352538352541352545362539352542302545362538442541452545352538352542332545392539372541442545352539342541462545342542382538302545362538302541372545362541302541312545392541412538432e706e67</a>)</p>
</li>
<li>
<p><strong>手动提交事务</strong>：如果应用使用自动提交的方式，建议在导入前执行 <code>SET AUTOCOMMIT=0</code> ，关闭自动提交；导入结束后再打开自动提交，可以提高导入的效率。</p>
<p>事务需要控制大小，事务太大可能会影响执行的效率。MySQL 有 innodb_log_buffer_size 配置项，超过这个值的日志会写入磁盘数据，效率会下降，所以在事务大小达到配置项数据级前进行事务提交可以提高效率</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c2545362538462539322545352538352541352545362539352542302545362538442541452545362538392538422545352538412541382545362538462539302545342542412541342545342542412538422545352538412541312e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/185152378fd9703f56b38579df62e189f79e252f31d705a4a167bc3721c0fe29/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c2545362538462539322545352538352541352545362539352542302545362538442541452545362538392538422545352538412541382545362538462539302545342542412541342545342542412538422545352538412541312e706e67">https://camo.githubusercontent.com/185152378fd9703f56b38579df62e189f79e252f31d705a4a167bc3721c0fe29/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c2545362538462539322545352538352541352545362539352542302545362538442541452545362538392538422545352538412541382545362538462539302545342542412541342545342542412538422545352538412541312e706e67</a>)</p>
</li>
</ol>
<hr>
<h4 id="-159"><a class="markdownIt-Anchor" href="#-159">#</a> <a href="#order-by"></a>ORDER BY</h4>
<p>数据准备：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>emp<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>age<span class="token punctuation">`</span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>salary<span class="token punctuation">`</span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">INNODB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>emp<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>age<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>salary<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">,</span><span class="token string">'Tom'</span><span class="token punctuation">,</span><span class="token string">'25'</span><span class="token punctuation">,</span><span class="token string">'2300'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">-- ...</span>
<span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_emp_age_salary <span class="token keyword">ON</span> emp<span class="token punctuation">(</span>age<span class="token punctuation">,</span>salary<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>
<p>第一种是通过对返回数据进行排序，所有不通过索引直接返回结果的排序都叫 FileSort 排序，会在内存中重新排序</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> emp <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> age <span class="token keyword">DESC</span><span class="token punctuation">;</span>	<span class="token comment">-- 年龄降序</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>![](<a target="_blank" rel="noopener" href="https://gitee.com/seazean/images/raw/master/DB/MySQL-%E4%BC%98%E5%8C%96SQL">https://gitee.com/seazean/images/raw/master/DB/MySQL - 优化 SQL</a> ORDER BY 排序 1.png)</p>
</li>
<li>
<p>第二种通过有序索引顺序扫描直接返回<strong>有序数据</strong>，这种情况为 Using index，不需要额外排序，操作效率高</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> id<span class="token punctuation">,</span> age<span class="token punctuation">,</span> salary <span class="token keyword">FROM</span> emp <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> age <span class="token keyword">DESC</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>![](<a target="_blank" rel="noopener" href="https://gitee.com/seazean/images/raw/master/DB/MySQL-%E4%BC%98%E5%8C%96SQL">https://gitee.com/seazean/images/raw/master/DB/MySQL - 优化 SQL</a> ORDER BY 排序 2.png)</p>
</li>
<li>
<p>多字段排序：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> id<span class="token punctuation">,</span>age<span class="token punctuation">,</span>salary <span class="token keyword">FROM</span> emp <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> age <span class="token keyword">DESC</span><span class="token punctuation">,</span> salary <span class="token keyword">DESC</span><span class="token punctuation">;</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> id<span class="token punctuation">,</span>age<span class="token punctuation">,</span>salary <span class="token keyword">FROM</span> emp <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> salary <span class="token keyword">DESC</span><span class="token punctuation">,</span> age <span class="token keyword">DESC</span><span class="token punctuation">;</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> id<span class="token punctuation">,</span>age<span class="token punctuation">,</span>salary <span class="token keyword">FROM</span> emp <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> age <span class="token keyword">DESC</span><span class="token punctuation">,</span> salary <span class="token keyword">ASC</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>![](<a target="_blank" rel="noopener" href="https://gitee.com/seazean/images/raw/master/DB/MySQL-%E4%BC%98%E5%8C%96SQL">https://gitee.com/seazean/images/raw/master/DB/MySQL - 优化 SQL</a> ORDER BY 排序 3.png)</p>
<p>尽量减少额外的排序，通过索引直接返回有序数据。<strong>需要满足 Order by 使用相同的索引、Order By 的顺序和索引顺序相同、Order by 的字段都是升序或都是降序</strong>，否则需要额外的操作，就会出现 FileSort</p>
</li>
</ul>
<p>优化：通过创建合适的索引能够减少 Filesort 的出现，但是某些情况下条件限制不能让 Filesort 消失，就要加快 Filesort 的排序操作</p>
<p>对于 Filesort ， MySQL 有两种排序算法：</p>
<ul>
<li>两次扫描算法：MySQL4.1 之前，使用该方式排序。首先根据条件取出排序字段和行指针信息，然后在排序区 sort buffer 中排序，如果 sort buffer 不够，则在临时表 temporary table 中存储排序结果。完成排序后再根据行指针<strong>回表读取记录</strong>，该操作可能会导致大量随机 I/O 操作</li>
<li>一次扫描算法：一次性取出满足条件的所有数据，需要回表，然后在排序区 sort buffer 中排序后直接输出结果集。排序时内存开销较大，但是排序效率比两次扫描算法高</li>
</ul>
<p>MySQL 通过比较系统变量 max_length_for_sort_data 的大小和 Query 语句取出的字段的大小，来判定使用哪种排序算法。如果前者大，则说明 sort buffer 空间足够，使用第二种优化之后的算法，否则使用第一种。</p>
<p>可以适当提高 sort_buffer_size 和 max_length_for_sort_data 系统变量，来增大排序区的大小，提高排序的效率</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SET</span> @<span class="token variable">@max_length_for_sort_data</span> <span class="token operator">=</span> <span class="token number">10000</span><span class="token punctuation">;</span> 		<span class="token comment">-- 设置全局变量</span>
<span class="token keyword">SET</span> max_length_for_sort_data <span class="token operator">=</span> <span class="token number">10240</span><span class="token punctuation">;</span> 			<span class="token comment">-- 设置会话变量</span>
<span class="token keyword">SHOW</span> VARIABLES <span class="token operator">LIKE</span> <span class="token string">'max_length_for_sort_data'</span><span class="token punctuation">;</span>	<span class="token comment">-- 默认1024</span>
<span class="token keyword">SHOW</span> VARIABLES <span class="token operator">LIKE</span> <span class="token string">'sort_buffer_size'</span><span class="token punctuation">;</span>			<span class="token comment">-- 默认262114</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<h4 id="-160"><a class="markdownIt-Anchor" href="#-160">#</a> <a href="#group-by"></a>GROUP BY</h4>
<p>GROUP BY 也会进行排序操作，与 ORDER BY 相比，GROUP BY 主要只是多了排序之后的分组操作，所以在 GROUP BY 的实现过程中，与 ORDER BY 一样也可以利用到索引</p>
<ul>
<li>
<p>分组查询：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">INDEX</span> idx_emp_age_salary <span class="token keyword">ON</span> emp<span class="token punctuation">;</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> age<span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> emp <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> age<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>![](<a target="_blank" rel="noopener" href="https://gitee.com/seazean/images/raw/master/DB/MySQL-%E4%BC%98%E5%8C%96SQL">https://gitee.com/seazean/images/raw/master/DB/MySQL - 优化 SQL</a> GROUP BY 排序 1.png)</p>
<p>Using temporary：表示 MySQL 需要使用临时表来存储结果集，常见于排序和分组查询</p>
</li>
<li>
<p>查询包含 GROUP BY 但是用户想要避免排序结果的消耗， 则可以执行 ORDER BY NULL 禁止排序：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> age<span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> emp <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> age <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>![](<a target="_blank" rel="noopener" href="https://gitee.com/seazean/images/raw/master/DB/MySQL-%E4%BC%98%E5%8C%96SQL">https://gitee.com/seazean/images/raw/master/DB/MySQL - 优化 SQL</a> GROUP BY 排序 2.png)</p>
</li>
<li>
<p>创建索引：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_emp_age_salary <span class="token keyword">ON</span> emp<span class="token punctuation">(</span>age<span class="token punctuation">,</span>salary<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>![](<a target="_blank" rel="noopener" href="https://gitee.com/seazean/images/raw/master/DB/MySQL-%E4%BC%98%E5%8C%96SQL">https://gitee.com/seazean/images/raw/master/DB/MySQL - 优化 SQL</a> GROUP BY 排序 3.png)</p>
</li>
</ul>
<hr>
<h4 id="-161"><a class="markdownIt-Anchor" href="#-161">#</a> <a href="#or"></a>OR</h4>
<p>对于包含 OR 的查询子句，如果要利用索引，则 OR 之间的<strong>每个条件列都必须用到索引，而且不能使用到条件之间的复合索引</strong>，如果没有索引，则应该考虑增加索引</p>
<ul>
<li>
<p>执行查询语句：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> emp <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">OR</span> age <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>	<span class="token comment">-- 两个索引，并且不是复合索引</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>![](<a target="_blank" rel="noopener" href="https://gitee.com/seazean/images/raw/master/DB/MySQL-%E4%BC%98%E5%8C%96SQL">https://gitee.com/seazean/images/raw/master/DB/MySQL - 优化 SQL</a> OR 条件查询 1.png)</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">Extra: Using sort_union<span class="token punctuation">(</span>idx_emp_age_salary,PRIMARY<span class="token punctuation">)</span><span class="token punctuation">;</span> Using where<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>使用 UNION 替换 OR，求并集：</p>
<p>注意：该优化只针对多个索引列有效，如果有列没有被索引，查询效率可能会因为没有选择 OR 而降低</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> emp <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">UNION</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> emp <span class="token keyword">WHERE</span> age <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>![](<a target="_blank" rel="noopener" href="https://gitee.com/seazean/images/raw/master/DB/MySQL-%E4%BC%98%E5%8C%96SQL">https://gitee.com/seazean/images/raw/master/DB/MySQL - 优化 SQL</a> OR 条件查询 2.png)</p>
</li>
<li>
<p>UNION 要优于 OR 的原因：</p>
<ul>
<li>UNION 语句的 type 值为 ref，OR 语句的 type 值为 range</li>
<li>UNION 语句的 ref 值为 const，OR 语句的 ref 值为 null，const 表示是常量值引用，非常快</li>
</ul>
</li>
</ul>
<hr>
<h4 id="-162"><a class="markdownIt-Anchor" href="#-162">#</a> <a href="#%E5%B5%8C%E5%A5%97%E6%9F%A5%E8%AF%A2-1"></a>嵌套查询</h4>
<p>MySQL 4.1 版本之后，开始支持 SQL 的子查询</p>
<ul>
<li>可以使用 SELECT 语句来创建一个单列的查询结果，然后把结果作为过滤条件用在另一个查询中</li>
<li>使用子查询可以一次性的完成逻辑上需要多个步骤才能完成的 SQL 操作，同时也可以避免事务或者表锁死</li>
<li>在有些情况下，子查询是可以被更高效的连接（JOIN）替代</li>
</ul>
<p>例如查找有角色的所有的用户信息：</p>
<ul>
<li>
<p>执行计划：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> t_user <span class="token keyword">WHERE</span> id <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> user_id <span class="token keyword">FROM</span> user_role<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/810948b89f06a56816a096372ef57c04c531132913f9f41bb6f7ffeecf35f87d/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c254535254235253843254535254135253937254536253946254135254538254146254132312e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/810948b89f06a56816a096372ef57c04c531132913f9f41bb6f7ffeecf35f87d/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c254535254235253843254535254135253937254536253946254135254538254146254132312e706e67">https://camo.githubusercontent.com/810948b89f06a56816a096372ef57c04c531132913f9f41bb6f7ffeecf35f87d/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c254535254235253843254535254135253937254536253946254135254538254146254132312e706e67</a>)</p>
</li>
<li>
<p>优化后：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> t_user u <span class="token punctuation">,</span> user_role ur <span class="token keyword">WHERE</span> u<span class="token punctuation">.</span>id <span class="token operator">=</span> ur<span class="token punctuation">.</span>user_id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/6d5cdf3f516c2e52e5de70dc95784b94c897419770fd27658634b4600ea8a900/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c254535254235253843254535254135253937254536253946254135254538254146254132322e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/6d5cdf3f516c2e52e5de70dc95784b94c897419770fd27658634b4600ea8a900/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c254535254235253843254535254135253937254536253946254135254538254146254132322e706e67">https://camo.githubusercontent.com/6d5cdf3f516c2e52e5de70dc95784b94c897419770fd27658634b4600ea8a900/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c254535254235253843254535254135253937254536253946254135254538254146254132322e706e67</a>)</p>
<p>连接查询之所以效率更高 ，是因为不需要在内存中创建临时表来完成逻辑上需要两个步骤的查询工作</p>
</li>
</ul>
<hr>
<h4 id="-163"><a class="markdownIt-Anchor" href="#-163">#</a> <a href="#%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2-1"></a>分页查询</h4>
<p>一般分页查询时，通过创建覆盖索引能够比较好地提高性能</p>
<p>一个常见的问题是  <code>LIMIT 200000,10</code> ，此时需要 MySQL 扫描前 200010 记录，仅仅返回 200000 - 200010 之间的记录，其他记录丢弃，查询排序的代价非常大</p>
<ul>
<li>
<p>分页查询：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tb_user_1 <span class="token keyword">LIMIT</span> <span class="token number">200000</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/27781a201b35385c66d54157785696a9800af465a75f2d7bc5f931662c411288/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c254535253838253836254539254131254235254536253946254135254538254146254132312e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/27781a201b35385c66d54157785696a9800af465a75f2d7bc5f931662c411288/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c254535253838253836254539254131254235254536253946254135254538254146254132312e706e67">https://camo.githubusercontent.com/27781a201b35385c66d54157785696a9800af465a75f2d7bc5f931662c411288/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c254535253838253836254539254131254235254536253946254135254538254146254132312e706e67</a>)</p>
</li>
<li>
<p>优化方式一：子查询，在索引列 id 上完成排序分页操作，最后根据主键关联回原表查询所需要的其他列内容</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tb_user_1 t<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> id <span class="token keyword">FROM</span> tb_user_1 <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> id <span class="token keyword">LIMIT</span> <span class="token number">200000</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span> a <span class="token keyword">WHERE</span> t<span class="token punctuation">.</span>id <span class="token operator">=</span> a<span class="token punctuation">.</span>id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c254535253838253836254539254131254235254536253946254135254538254146254132322e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/677b8baed3095814b38fb4df1188a91f88dcdd7c995958bbaa64a85189fc69a5/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c254535253838253836254539254131254235254536253946254135254538254146254132322e706e67">https://camo.githubusercontent.com/677b8baed3095814b38fb4df1188a91f88dcdd7c995958bbaa64a85189fc69a5/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c254535253838253836254539254131254235254536253946254135254538254146254132322e706e67</a>)</p>
</li>
<li>
<p>优化方式二：方案适用于主键自增的表，可以把 LIMIT 查询转换成某个位置的查询</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tb_user_1 <span class="token keyword">WHERE</span> id <span class="token operator">></span> <span class="token number">200000</span> <span class="token keyword">LIMIT</span> <span class="token number">10</span><span class="token punctuation">;</span>				<span class="token comment">-- 写法 1</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tb_user_1 <span class="token keyword">WHERE</span> id <span class="token operator">BETWEEN</span> <span class="token number">200000</span> <span class="token operator">and</span> <span class="token number">200010</span><span class="token punctuation">;</span>	<span class="token comment">-- 写法 2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c254535253838253836254539254131254235254536253946254135254538254146254132332e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/4151e2e6b381dbe5775366fc4e95adf1173d711facbf13f91d2ad17693129cc2/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c254535253838253836254539254131254235254536253946254135254538254146254132332e706e67">https://camo.githubusercontent.com/4151e2e6b381dbe5775366fc4e95adf1173d711facbf13f91d2ad17693129cc2/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c254535253838253836254539254131254235254536253946254135254538254146254132332e706e67</a>)</p>
</li>
</ul>
<hr>
<h4 id="-164"><a class="markdownIt-Anchor" href="#-164">#</a> <a href="#%E4%BD%BF%E7%94%A8%E6%8F%90%E7%A4%BA"></a>使用提示</h4>
<p>SQL 提示，是优化数据库的一个重要手段，就是在 SQL 语句中加入一些提示来达到优化操作的目的</p>
<ul>
<li>
<p>USE INDEX：在查询语句中表名的后面添加 USE INDEX 来提供 MySQL 去参考的索引列表，可以让 MySQL 不再考虑其他可用的索引</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_seller_name <span class="token keyword">ON</span> tb_seller<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tb_seller <span class="token keyword">USE</span> <span class="token keyword">INDEX</span><span class="token punctuation">(</span>idx_seller_name<span class="token punctuation">)</span> <span class="token keyword">WHERE</span> name<span class="token operator">=</span><span class="token string">'小米科技'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c254534254244254246254537253934254138254536253846253930254537254134254241312e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/c64027433218fabb66c105f4f456452bc07949ed5ff161641d8a3b3f861493cf/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c254534254244254246254537253934254138254536253846253930254537254134254241312e706e67">https://camo.githubusercontent.com/c64027433218fabb66c105f4f456452bc07949ed5ff161641d8a3b3f861493cf/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c254534254244254246254537253934254138254536253846253930254537254134254241312e706e67</a>)</p>
</li>
<li>
<p>IGNORE INDEX：让 MySQL 忽略一个或者多个索引，则可以使用 IGNORE INDEX 作为提示</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tb_seller <span class="token keyword">IGNORE</span> <span class="token keyword">INDEX</span><span class="token punctuation">(</span>idx_seller_name<span class="token punctuation">)</span> <span class="token keyword">WHERE</span> name <span class="token operator">=</span> <span class="token string">'小米科技'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/d78e260db0de87aee36f75dceada37bf1bb9ffe551bfbeb0c67ff6e7e5d08f73/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c254534254244254246254537253934254138254536253846253930254537254134254241322e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/d78e260db0de87aee36f75dceada37bf1bb9ffe551bfbeb0c67ff6e7e5d08f73/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c254534254244254246254537253934254138254536253846253930254537254134254241322e706e67">https://camo.githubusercontent.com/d78e260db0de87aee36f75dceada37bf1bb9ffe551bfbeb0c67ff6e7e5d08f73/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c254534254244254246254537253934254138254536253846253930254537254134254241322e706e67</a>)</p>
</li>
<li>
<p>FORCE INDEX：强制 MySQL 使用一个特定的索引</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tb_seller <span class="token keyword">FORCE</span> <span class="token keyword">INDEX</span><span class="token punctuation">(</span>idx_seller_name_sta_addr<span class="token punctuation">)</span> <span class="token keyword">WHERE</span> NAME<span class="token operator">=</span><span class="token string">'小米科技'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/f1197367e851a123850566f4469e37fe5925f17e3ab3d11145c7c4e76207c6ec/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c254534254244254246254537253934254138254536253846253930254537254134254241332e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/f1197367e851a123850566f4469e37fe5925f17e3ab3d11145c7c4e76207c6ec/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c254534254244254246254537253934254138254536253846253930254537254134254241332e706e67">https://camo.githubusercontent.com/f1197367e851a123850566f4469e37fe5925f17e3ab3d11145c7c4e76207c6ec/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d25453425424325393825453525384325393653514c254534254244254246254537253934254138254536253846253930254537254134254241332e706e67</a>)</p>
</li>
</ul>
<hr>
<h4 id="-165"><a class="markdownIt-Anchor" href="#-165">#</a> <a href="#%E7%BB%9F%E8%AE%A1%E8%AE%A1%E6%95%B0"></a>统计计数</h4>
<p>在不同的 MySQL 引擎中，count (*) 有不同的实现方式：</p>
<ul>
<li>MyISAM 引擎把一个表的总行数存在了磁盘上，因此执行 count (*) 的时候会直接返回这个数，效率很高，但不支持事务</li>
<li>show table status 命令通过采样估算可以快速获取，但是不准确</li>
<li>InnoDB 表执行 count (*) 会遍历全表，虽然结果准确，但会导致性能问题</li>
</ul>
<p>解决方案：</p>
<ul>
<li>
<p>计数保存在 Redis 中，但是更新 MySQL 和 Redis 的操作不是原子的，会存在数据一致性的问题</p>
</li>
<li>
<p>计数直接放到数据库里单独的一张计数表中，利用事务解决计数精确问题：</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2de8aea1e695b0636f756e74e4bc98e58c962e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/d1a5bf6d6d0480c844296cd3e7f087b6af5466a17f7b278fc49c93bef7d60c2d/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2de8aea1e695b0636f756e74e4bc98e58c962e706e67">https://camo.githubusercontent.com/d1a5bf6d6d0480c844296cd3e7f087b6af5466a17f7b278fc49c93bef7d60c2d/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2de8aea1e695b0636f756e74e4bc98e58c962e706e67</a>)</p>
<p>会话 B 的读操作在 T3 执行的，这时更新事务还没有提交，所以计数值加 1 这个操作对会话 B 还不可见，因此会话 B 查询的计数值和最近 100 条记录，返回的结果逻辑上就是一致的</p>
<p>并发系统性能的角度考虑，应该先插入操作记录再更新计数表，因为更新计数表涉及到行锁的竞争，<strong>先插入再更新能最大程度地减少事务之间的锁等待，提升并发度</strong></p>
</li>
</ul>
<p>count 函数的按照效率排序： <code>count(字段) &lt; count(主键id) &lt; count(1) ≈ count(*)</code> ，所以建议尽量使用 count (*)</p>
<ul>
<li>
<p>count (主键 id)：InnoDB 引擎会遍历整张表，把每一行的 id 值都取出来返回给 Server 层，Server 判断 id 不为空就按行累加</p>
</li>
<li>
<p>count (1)：InnoDB 引擎遍历整张表但不取值，Server 层对于返回的每一行，放一个数字 1 进去，判断不为空就按行累加</p>
</li>
<li>
<p>count (字段)：如果这个字段是定义为 not null 的话，一行行地从记录里面读出这个字段，判断不能为 null，按行累加；如果这个字段定义允许为 null，那么执行的时候，判断到有可能是 null，还要把值取出来再判断一下，不是 null 才累加</p>
</li>
</ul>
<p>参考文章：<a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/72775">https://time.geekbang.org/column/article/72775</a></p>
<hr>
<h3 id="-166"><a class="markdownIt-Anchor" href="#-166">#</a> <a href="#%E5%86%85%E5%AD%98%E4%BC%98%E5%8C%96"></a>内存优化</h3>
<h4 id="-167"><a class="markdownIt-Anchor" href="#-167">#</a> <a href="#%E4%BC%98%E5%8C%96%E5%8E%9F%E5%88%99"></a>优化原则</h4>
<p>三个原则：</p>
<ul>
<li>将尽量多的内存分配给 MySQL 做缓存，但也要给操作系统和其他程序预留足够内存</li>
<li>MyISAM 存储引擎的数据文件读取依赖于操作系统自身的 IO 缓存，如果有 MyISAM 表，就要预留更多的内存给操作系统做 IO 缓存</li>
<li>排序区、连接区等缓存是分配给每个数据库会话（Session）专用的，值的设置要根据最大连接数合理分配，如果设置太大，不但浪费资源，而且在并发数较高时会导致物理内存耗尽</li>
</ul>
<p>MyISAM 存储引擎使用 key_buffer 缓存索引块，加速 MyISAM 索引的读写速度。对于 MyISAM 表的数据块没有特别的缓存机制，完全依赖于操作系统的 IO 缓存</p>
<ul>
<li>
<p>key_buffer_size：该变量决定 MyISAM 索引块缓存区的大小，直接影响到 MyISAM 表的存取效率</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SHOW</span> VARIABLES <span class="token operator">LIKE</span> <span class="token string">'key_buffer_size'</span><span class="token punctuation">;</span>	<span class="token comment">-- 单位是字节</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>在 MySQL 配置文件中设置该值，建议至少将 1/4 可用内存分配给 key_buffer_size：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">vim</span> /etc/mysql/my.cnf
<span class="token assign-left variable">key_buffer_size</span><span class="token operator">=</span>1024M<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li>
<p>read_buffer_size：如果需要经常顺序扫描 MyISAM 表，可以通过增大 read_buffer_size 的值来改善性能。但 read_buffer_size 是每个 Session 独占的，如果默认值设置太大，并发环境就会造成内存浪费</p>
</li>
<li>
<p>read_rnd_buffer_size：对于需要做排序的 MyISAM 表的查询，如带有 ORDER BY 子句的语句，适当增加该的值，可以改善此类的 SQL 的性能，但是 read_rnd_buffer_size 是每个 Session 独占的，如果默认值设置太大，就会造成内存浪费</p>
</li>
</ul>
<hr>
<h4 id="-168"><a class="markdownIt-Anchor" href="#-168">#</a> <a href="#%E7%BC%93%E5%86%B2%E5%86%85%E5%AD%98"></a>缓冲内存</h4>
<p>Buffer Pool 本质上是 InnoDB 向操作系统申请的一段连续的内存空间。InnoDB 的数据是按数据页为单位来读写，每个数据页的大小默认是 16KB。数据是存放在磁盘中，每次读写数据都需要进行磁盘 IO 将数据读入内存进行操作，效率会很低，所以提供了 Buffer Pool 来暂存这些数据页，缓存中的这些页又叫缓冲页</p>
<p>工作原理：</p>
<ul>
<li>从数据库读取数据时，会首先从缓存中读取，如果缓存中没有，则从磁盘读取后放入 Buffer Pool</li>
<li>向数据库写入数据时，会首先写入缓存，缓存中修改的数据会<strong>定期刷新</strong>到磁盘，这一过程称为刷脏</li>
</ul>
<p><strong>唯一索引的更新不能使用 Buffer，只有普通索引可以使用，直接写入 Buffer 就结束，不用校验唯一性</strong></p>
<p>Buffer Pool 中每个缓冲页都有对应的控制信息，包括表空间编号、页号、偏移量、链表信息等，控制信息存放在占用的内存称为控制块，控制块与缓冲页是一一对应的，但并不是物理上相连的，都在缓冲池中</p>
<p>MySQL 提供了缓冲页的快速查找方式：<strong>哈希表</strong>，使用表空间号和页号作为 Key，缓冲页控制块的地址作为 Value 创建一个哈希表，获取数据页时根据 Key 进行哈希寻址：</p>
<ul>
<li>如果不存在对应的缓存页，就从 free 链表中选一个空闲缓冲页，把磁盘中的对应页加载到该位置</li>
<li>如果存在对应的缓存页，直接获取使用，提高查询数据的效率</li>
</ul>
<hr>
<h4 id="-169"><a class="markdownIt-Anchor" href="#-169">#</a> <a href="#%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86"></a>内存管理</h4>
<h5 id="-170"><a class="markdownIt-Anchor" href="#-170">#</a> <a href="#free-%E9%93%BE%E8%A1%A8"></a>Free 链表</h5>
<p>MySQL 启动时完成对 Buffer Pool 的初始化，先向操作系统申请连续的内存空间，然后将内存划分为若干对控制块和缓冲页。为了区分空闲和已占用的数据页，将所有缓冲页对应的控制块作为一个节点放入一个链表中，就是 Free 链表（<strong>空闲链表</strong>）</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2de7a9bae997b2e993bee8a1a82e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/95fd87081d143532d9411167dd535180117315abb3ba386c86a50057862d86cb/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2de7a9bae997b2e993bee8a1a82e706e67">https://camo.githubusercontent.com/95fd87081d143532d9411167dd535180117315abb3ba386c86a50057862d86cb/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2de7a9bae997b2e993bee8a1a82e706e67</a>)</p>
<p>基节点：是一块单独申请的内存空间（占 40 字节），并不在 Buffer Pool 的那一大片连续内存空间里</p>
<p>磁盘加载页的流程：</p>
<ul>
<li>从 Free 链表中取出一个空闲的缓冲页</li>
<li>把缓冲页对应的控制块的信息填上（页所在的表空间、页号之类的信息）</li>
<li>把缓冲页对应的 Free 链表节点（控制块）从链表中移除，表示该缓冲页已经被使用</li>
</ul>
<p>参考文章：<a target="_blank" rel="noopener" href="https://blog.csdn.net/li1325169021/article/details/121124440">https://blog.csdn.net/li1325169021/article/details/121124440</a></p>
<hr>
<h5 id="-171"><a class="markdownIt-Anchor" href="#-171">#</a> <a href="#flush-%E9%93%BE%E8%A1%A8"></a>Flush 链表</h5>
<p>Flush 链表是一个用来<strong>存储脏页</strong>的链表，对于已经修改过的缓冲脏页，第一次修改后加入到<strong>链表头部</strong>，以后每次修改都不会重新加入，只修改部分控制信息，出于性能考虑并不是直接更新到磁盘，而是在未来的某个时间进行刷脏</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/4c69d138d338ecefac6b832cf17fbc71329b09e3b3afb7b71b5d43ac7740d215/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2de8848fe9a1b5e993bee8a1a82e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/4c69d138d338ecefac6b832cf17fbc71329b09e3b3afb7b71b5d43ac7740d215/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2de8848fe9a1b5e993bee8a1a82e706e67">https://camo.githubusercontent.com/4c69d138d338ecefac6b832cf17fbc71329b09e3b3afb7b71b5d43ac7740d215/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2de8848fe9a1b5e993bee8a1a82e706e67</a>)</p>
<p>后台有专门的线程每隔一段时间把脏页刷新到磁盘：</p>
<ul>
<li>从 Flush 链表中刷新一部分页面到磁盘：
<ul>
<li>后台线程定时从 Flush 链表刷脏，根据系统的繁忙程度来决定刷新速率，这种方式称为 BUF_FLUSH_LIST</li>
<li>线程刷脏的比较慢，导致用户线程加载一个新的数据页时发现没有空闲缓冲页，此时会尝试从 LRU 链表尾部寻找未修改的缓冲页直接释放，如果没有就会将 LRU 链表尾部的一个脏页<strong>同步刷新</strong>到磁盘，速度较慢，这种方式称为 BUF_FLUSH_SINGLE_PAGE</li>
</ul>
</li>
<li>从 LRU 链表的冷数据中刷新一部分页面到磁盘，即：BUF_FLUSH_LRU
<ul>
<li>后台线程会定时从 LRU 链表的尾部开始扫描一些页面，扫描的页面数量可以通过系统变量  <code>innodb_lru_scan_depth</code>  指定，如果在 LRU 链表中发现脏页，则把它们刷新到磁盘，这种方式称为 BUF_FLUSH_LRU</li>
<li>控制块里会存储该缓冲页是否被修改的信息，所以可以很容易的获取到某个缓冲页是否是脏页</li>
</ul>
</li>
</ul>
<p>参考文章：<a target="_blank" rel="noopener" href="https://blog.csdn.net/li1325169021/article/details/121125765">https://blog.csdn.net/li1325169021/article/details/121125765</a></p>
<hr>
<h5 id="-172"><a class="markdownIt-Anchor" href="#-172">#</a> <a href="#lru-%E9%93%BE%E8%A1%A8"></a>LRU 链表</h5>
<p>当 Buffer Pool 中没有空闲缓冲页时就需要淘汰掉最近最少使用的部分缓冲页，为了实现这个功能，MySQL 创建了一个 LRU 链表，当访问某个页时：</p>
<ul>
<li>如果该页不在 Buffer Pool 中，把该页从磁盘加载进来后会将该缓冲页对应的控制块作为节点放入 <strong>LRU 链表的头部</strong></li>
<li>如果该页在 Buffer Pool 中，则直接把该页对应的控制块移动到 LRU 链表的头部，所以 LRU 链表尾部就是最近最少使用的缓冲页</li>
</ul>
<p>MySQL 基于局部性原理提供了预读功能：</p>
<ul>
<li>线性预读：系统变量  <code>innodb_read_ahead_threshold</code> ，如果顺序访问某个区（extent：16 KB 的页，连续 64 个形成一个区，一个区默认 1MB 大小）的页面数超过了该系统变量值，就会触发一次<strong>异步读取</strong>下一个区中全部的页面到 Buffer Pool 中</li>
<li>随机预读：如果某个区 13 个连续的页面都被加载到 Buffer Pool，无论这些页面是否是顺序读取，都会触发一次<strong>异步读取</strong>本区所有的其他页面到 Buffer Pool 中</li>
</ul>
<p>预读会造成加载太多用不到的数据页，造成那些使用频率很高的数据页被挤到 LRU 链表尾部，所以 InnoDB 将 LRU 链表分成两段：</p>
<ul>
<li>一部分存储使用频率很高的数据页，这部分链表也叫热数据，young 区</li>
<li>一部分存储使用频率不高的冷数据，old 区，默认占 37%，可以通过系统变量  <code>innodb_old_blocks_pct</code>  指定</li>
</ul>
<p>当磁盘上的某数据页被初次加载到 Buffer Pool 中会被放入 old 区，淘汰时优先淘汰 old 区</p>
<ul>
<li>当对 old 区的数据进行访问时，会在控制块记录下访问时间，等待后续的访问时间与第一次访问的时间是否在某个时间间隔内，通过系统变量  <code>innodb_old_blocks_time</code>  指定时间间隔，默认 1000ms，成立就移动到 young 区的链表头部</li>
<li><code>innodb_old_blocks_time</code>  为 0 时，每次访问一个页面都会放入 young 区的头部</li>
</ul>
<hr>
<h4 id="-173"><a class="markdownIt-Anchor" href="#-173">#</a> <a href="#%E5%8F%82%E6%95%B0%E4%BC%98%E5%8C%96"></a>参数优化</h4>
<p>Innodb 用一块内存区做 IO 缓存池，该缓存池不仅用来缓存 Innodb 的索引块，也用来缓存 Innodb 的数据块，可以通过下面的指令查看 Buffer Pool 的状态信息：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SHOW</span> <span class="token keyword">ENGINE</span> <span class="token keyword">INNODB</span> <span class="token keyword">STATUS</span>\G<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><code>Buffer pool hit rate</code>  字段代表<strong>内存命中率</strong>，表示 Buffer Pool 对查询的加速效果</p>
<p>核心参数：</p>
<ul>
<li>
<p><code>innodb_buffer_pool_size</code> ：该变量决定了 Innodb 存储引擎表数据和索引数据的最大缓存区大小，默认 128M</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SHOW</span> VARIABLES <span class="token operator">LIKE</span> <span class="token string">'innodb_buffer_pool_size'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>在保证操作系统及其他程序有足够内存可用的情况下， <code>innodb_buffer_pool_size</code>  的值越大，缓存命中率越高</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token assign-left variable">innodb_buffer_pool_size</span><span class="token operator">=</span>512M<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p><code>innodb_log_buffer_size</code> ：该值决定了 Innodb 日志缓冲区的大小，保存要写入磁盘上的日志文件数据</p>
<p>对于可能产生大量更新记录的大事务，增加该值的大小，可以避免 Innodb 在事务提交前就执行不必要的日志写入磁盘操作，影响执行效率，通过配置文件修改：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token assign-left variable">innodb_log_buffer_size</span><span class="token operator">=</span>10M<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<p>在多线程下，访问 Buffer Pool 中的各种链表都需要加锁，所以将 Buffer Pool 拆成若干个小实例，每个实例独立管理内存空间和各种链表（类似 ThreadLocal），多线程访问各实例互不影响，提高了并发能力</p>
<ul>
<li>在系统启动时设置系统变量  <code>innodb_buffer_pool_instance</code>  可以指定 Buffer Pool 实例的个数，但是当 Buffer Pool 小于 1GB 时，设置多个实例时无效的</li>
</ul>
<p>MySQL 5.7.5 之前  <code>innodb_buffer_pool_size</code>  只支持在系统启动时修改，现在已经支持运行时修改 Buffer Pool 的大小，但是每次调整参数都会重新向操作系统申请一块连续的内存空间，<strong>将旧的缓冲池的内容拷贝到新空间</strong>非常耗时，所以 MySQL 开始以一个 chunk 为单位向操作系统申请内存，所以一个 Buffer Pool 实例由多个 chunk 组成</p>
<ul>
<li>
<p>指定系统变量  <code>innodb_buffer_pool_chunk_size</code>  来改变 chunk 的大小，只能在启动时修改，运行中不能修改，而且该变量并不包含缓冲页的控制块的内存大小</p>
</li>
<li>
<p><code>innodb_buffer_pool_size</code>  必须是  <code>innodb_buffer_pool_chunk_size × innodb_buffer_pool_instance</code>  的倍数，默认值是  <code>128M × 16 = 2G</code> ，Buffer Pool 必须是 2G 的整数倍，如果指定 5G，会自动调整成 6G</p>
</li>
<li>
<p>如果启动时  <code>chunk × instances</code>  &gt;  <code>pool_size</code> ，那么 chunk 的值会自动设置为  <code>pool_size ÷ instances</code></p>
</li>
</ul>
<hr>
<h4 id="-174"><a class="markdownIt-Anchor" href="#-174">#</a> <a href="#%E5%85%B6%E4%BB%96%E5%86%85%E5%AD%98"></a>其他内存</h4>
<p>InnoDB 管理的 Buffer Pool 中有一块内存叫 Change Buffer 用来对<strong>增删改</strong>操作提供缓存，参数  <code>innodb_change_buffer_max_size</code>  来动态设置，设置为 50 时表示 Change Buffer 的大小最多只能占用 Buffer Pool 的 50%</p>
<p>Server 层针对优化<strong>查询</strong>的内存为 Net Buffer，内存的大小是由参数  <code>net_buffer_length</code>  定义，默认 16k，实现流程：</p>
<ul>
<li>获取一行数据写入 Net Buffer，重复获取直到 Net Buffer 写满，调用网络接口发出去</li>
<li>若发送成功就清空 Net Buffer，然后继续取下一行；若发送函数返回  <code>EAGAIN</code>  或  <code>WSAEWOULDBLOCK</code> ，表示本地网络栈  <code>socket send buffer</code>  写满了，进入等待，直到网络栈重新可写再继续发送</li>
</ul>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d2545362539462541352545382541462541322545352538362538352545352541442539382545342542432539382545352538432539362e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/d5b8d9f937c5791a6c1f90cbe59d208947be577832edb9052f41d39a7b0550eb/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d2545362539462541352545382541462541322545352538362538352545352541442539382545342542432539382545352538432539362e706e67">https://camo.githubusercontent.com/d5b8d9f937c5791a6c1f90cbe59d208947be577832edb9052f41d39a7b0550eb/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d2545362539462541352545382541462541322545352538362538352545352541442539382545342542432539382545352538432539362e706e67</a>)</p>
<p>MySQL 采用的是边算边发的逻辑，因此对于数据量很大的查询来说，不会在 Server 端保存完整的结果集，如果客户端读结果不及时，会堵住 MySQL 的查询过程，但是不会把内存打爆导致 OOM</p>
<p>参考文章：<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_33589510/article/details/117673449">https://blog.csdn.net/qq_33589510/article/details/117673449</a></p>
<hr>
<h3 id="-175"><a class="markdownIt-Anchor" href="#-175">#</a> <a href="#%E5%B9%B6%E5%8F%91%E4%BC%98%E5%8C%96"></a>并发优化</h3>
<p>MySQL Server 是多线程结构，包括后台线程和客户服务线程。多线程可以有效利用服务器资源，提高数据库的并发性能。在 MySQL 中，控制并发连接和线程的主要参数：</p>
<ul>
<li>
<p>max_connections：控制允许连接到 MySQL 数据库的最大连接数，默认值是 151</p>
<p>如果状态变量 connection_errors_max_connections 不为零，并且一直增长，则说明不断有连接请求因数据库连接数已达到允许最大值而失败，这时可以考虑增大 max_connections 的值</p>
<p>Mysql 最大可支持的连接数取决于很多因素，包括操作系统平台的线程库的质量、内存大小、每个连接的负荷、CPU 的处理速度、期望的响应时间等。在 Linux 平台下，性能好的服务器，可以支持 500-1000 个连接，需要根据服务器性能进行评估设定</p>
</li>
<li>
<p>back_log：控制 MySQL 监听 TCP 端口时的积压请求栈的大小</p>
<p>如果 Mysql 的连接数达到 max_connections 时，新来的请求将会被存在堆栈中，以等待某一连接释放资源，该堆栈的数量即 back_log。如果等待连接的数量超过 back_log，将不被授予连接资源直接报错</p>
<p>5.6.6 版本之前默认值为 50，之后的版本默认为  <code>50 + (max_connections/5)</code> ，但最大不超过 900，如果需要数据库在较短的时间内处理大量连接请求， 可以考虑适当增大 back_log 的值</p>
</li>
<li>
<p>table_open_cache：控制所有 SQL 语句执行线程可打开表缓存的数量</p>
<p>在执行 SQL 语句时，每个执行线程至少要打开 1 个表缓存，该参数的值应该根据设置的最大连接数以及每个连接执行关联查询中涉及的表的最大数量来设定： <code>max_connections * N</code></p>
</li>
<li>
<p>thread_cache_size：可控制 MySQL 缓存客户服务线程的数量</p>
<p>为了加快连接数据库的速度，MySQL 会缓存一定数量的客户服务线程以备重用，池化思想</p>
</li>
<li>
<p>innodb_lock_wait_timeout：设置 InnoDB 事务等待行锁的时间，默认值是 50ms</p>
<p>对于需要快速反馈的业务系统，可以将行锁的等待时间调小，以避免事务被长时间挂起； 对于后台运行的批量处理程序来说，可以将行锁的等待时间调大，以避免发生大的回滚操作</p>
</li>
</ul>
<hr>
<h2 id="-176"><a class="markdownIt-Anchor" href="#-176">#</a> <a href="#%E4%BA%8B%E5%8A%A1%E6%9C%BA%E5%88%B6"></a>事务机制</h2>
<h3 id="-177"><a class="markdownIt-Anchor" href="#-177">#</a> <a href="#%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D-5"></a>基本介绍</h3>
<p>事务（Transaction）是访问和更新数据库的程序执行单元；事务中可能包含一个或多个 SQL 语句，这些语句要么都执行，要么都不执行，作为一个关系型数据库，MySQL 支持事务。</p>
<p>单元中的每条 SQL 语句都相互依赖，形成一个整体</p>
<ul>
<li>
<p>如果某条 SQL 语句执行失败或者出现错误，那么整个单元就会回滚，撤回到事务最初的状态</p>
</li>
<li>
<p>如果单元中所有的 SQL 语句都执行成功，则事务就顺利执行</p>
</li>
</ul>
<p>事务的四大特征：ACID</p>
<ul>
<li>原子性 (atomicity)</li>
<li>一致性 (consistency)</li>
<li>隔离性 (isolaction)</li>
<li>持久性 (durability)</li>
</ul>
<p>事务的几种状态：</p>
<ul>
<li>活动的（active）：事务对应的数据库操作正在执行中</li>
<li>部分提交的（partially committed）：事务的最后一个操作执行完，但是内存还没刷新至磁盘</li>
<li>失败的（failed）：当事务处于活动状态或部分提交状态时，如果数据库遇到了错误或刷脏失败，或者用户主动停止当前的事务</li>
<li>中止的（aborted）：失败状态的事务回滚完成后的状态</li>
<li>提交的（committed）：当处于部分提交状态的事务刷脏成功，就处于提交状态</li>
</ul>
<hr>
<h3 id="-178"><a class="markdownIt-Anchor" href="#-178">#</a> <a href="#%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86"></a>事务管理</h3>
<h4 id="-179"><a class="markdownIt-Anchor" href="#-179">#</a> <a href="#%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C-2"></a>基本操作</h4>
<p>事务管理的三个步骤</p>
<ol>
<li>
<p>开启事务：记录回滚点，并通知服务器，将要执行一组操作，要么同时成功、要么同时失败</p>
</li>
<li>
<p>执行 SQL 语句：执行具体的一条或多条 SQL 语句</p>
</li>
<li>
<p>结束事务（提交 | 回滚）</p>
<ul>
<li>提交：没出现问题，数据进行更新</li>
<li>回滚：出现问题，数据恢复到开启事务时的状态</li>
</ul>
</li>
</ol>
<p>事务操作：</p>
<ul>
<li>
<p>显式开启事务</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">START</span> <span class="token keyword">TRANSACTION</span> <span class="token punctuation">[</span><span class="token keyword">READ</span> ONLY<span class="token operator">|</span><span class="token keyword">READ</span> <span class="token keyword">WRITE</span><span class="token operator">|</span><span class="token keyword">WITH</span> <span class="token keyword">CONSISTENT</span> <span class="token keyword">SNAPSHOT</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">#可以跟一个或多个状态，最后的是一致性读</span>
<span class="token keyword">BEGIN</span> <span class="token punctuation">[</span><span class="token keyword">WORK</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>说明：不填状态默认是读写事务</p>
</li>
<li>
<p>回滚事务，用来手动中止事务</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ROLLBACK</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>提交事务，显示执行是手动提交，MySQL 默认为自动提交</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">COMMIT</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>保存点：在事务的执行过程中设置的还原点，调用 ROLLBACK 时可以指定回滚到哪个点</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SAVEPOINT</span> point_name<span class="token punctuation">;</span>						<span class="token comment">#设置保存点</span>
<span class="token keyword">RELEASE</span> point_name							<span class="token comment">#删除保存点</span>
<span class="token keyword">ROLLBACK</span> <span class="token punctuation">[</span><span class="token keyword">WORK</span><span class="token punctuation">]</span> <span class="token keyword">TO</span> <span class="token punctuation">[</span><span class="token keyword">SAVEPOINT</span><span class="token punctuation">]</span> point_name	<span class="token comment">#回滚至某个保存点，不填默认回滚到事务执行之前的状态</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>操作演示</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 开启事务</span>
<span class="token keyword">START</span> <span class="token keyword">TRANSACTION</span><span class="token punctuation">;</span>

<span class="token comment">-- 张三给李四转账500元</span>
<span class="token comment">-- 1.张三账户-500</span>
<span class="token keyword">UPDATE</span> account <span class="token keyword">SET</span> money<span class="token operator">=</span>money<span class="token operator">-</span><span class="token number">500</span> <span class="token keyword">WHERE</span> NAME<span class="token operator">=</span><span class="token string">'张三'</span><span class="token punctuation">;</span>
<span class="token comment">-- 2.李四账户+500</span>
<span class="token keyword">UPDATE</span> account <span class="token keyword">SET</span> money<span class="token operator">=</span>money<span class="token operator">+</span><span class="token number">500</span> <span class="token keyword">WHERE</span> NAME<span class="token operator">=</span><span class="token string">'李四'</span><span class="token punctuation">;</span>

<span class="token comment">-- 回滚事务(出现问题)</span>
<span class="token keyword">ROLLBACK</span><span class="token punctuation">;</span>

<span class="token comment">-- 提交事务(没出现问题)</span>
<span class="token keyword">COMMIT</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<hr>
<h4 id="-180"><a class="markdownIt-Anchor" href="#-180">#</a> <a href="#%E6%8F%90%E4%BA%A4%E6%96%B9%E5%BC%8F"></a>提交方式</h4>
<p>提交方式的相关语法：</p>
<ul>
<li>
<p>查看事务提交方式</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> @<span class="token variable">@AUTOCOMMIT</span><span class="token punctuation">;</span>  <span class="token comment">-- 1 代表自动提交    0 代表手动提交</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>修改事务提交方式</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SET</span> @<span class="token variable">@AUTOCOMMIT</span><span class="token operator">=</span>数字<span class="token punctuation">;</span>	<span class="token comment">-- 系统</span>
<span class="token keyword">SET</span> AUTOCOMMIT<span class="token operator">=</span>数字<span class="token punctuation">;</span>		<span class="token comment">-- 会话</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li>
<p><strong>系统变量的操作</strong>：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SET</span> <span class="token punctuation">[</span><span class="token keyword">GLOBAL</span><span class="token operator">|</span><span class="token keyword">SESSION</span><span class="token punctuation">]</span> 变量名 <span class="token operator">=</span> 值<span class="token punctuation">;</span>					<span class="token comment">-- 默认是会话</span>
<span class="token keyword">SET</span> @@<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token keyword">GLOBAL</span><span class="token operator">|</span><span class="token keyword">SESSION</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">]</span>变量名 <span class="token operator">=</span> 值<span class="token punctuation">;</span>				<span class="token comment">-- 默认是系统</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SHOW</span> <span class="token punctuation">[</span><span class="token keyword">GLOBAL</span><span class="token operator">|</span><span class="token keyword">SESSION</span><span class="token punctuation">]</span> VARIABLES <span class="token punctuation">[</span><span class="token operator">LIKE</span> <span class="token string">'变量%'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>	  <span class="token comment">-- 默认查看会话内系统变量值</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<p>工作原理：</p>
<ul>
<li>自动提交：如果没有 START TRANSACTION 显式地开始一个事务，那么<strong>每条 SQL 语句都会被当做一个事务执行提交操作</strong>；显式开启事务后，会在本次事务结束（提交或回滚）前暂时关闭自动提交</li>
<li>手动提交：不需要显式的开启事务，所有的 SQL 语句都在一个事务中，直到执行了提交或回滚，然后进入下一个事务</li>
<li>隐式提交：存在一些特殊的命令，在事务中执行了这些命令会马上强制执行 COMMIT 提交事务
<ul>
<li>DDL 语句 (CREATE/DROP/ALTER)、LOCK TABLES 语句、LOAD DATA 导入数据语句、主从复制语句等</li>
<li>当一个事务还没提交或回滚，显式的开启一个事务会隐式的提交上一个事务</li>
</ul>
</li>
</ul>
<hr>
<h4 id="-181"><a class="markdownIt-Anchor" href="#-181">#</a> <a href="#%E4%BA%8B%E5%8A%A1-id"></a>事务 ID</h4>
<p>只读事务不能对普通的表进行增删改操作，但是可以对临时表增删改，读写事务可以对数据表执行增删改查操作</p>
<p>事务在执行过程中对某个表执行了<strong>增删改操作或者创建表</strong>，就会为当前事务分配一个独一无二的事务 ID（对临时表并不会分配 ID），如果当前事务没有被分配 ID，默认是 0</p>
<p>事务 ID 本质上就是一个数字，服务器在内存中维护一个全局变量：</p>
<ul>
<li>每当需要为某个事务分配 ID，就会把全局变量的值赋值给事务 ID，然后变量自增 1</li>
<li>每当变量值为 256 的倍数时，就将该变量的值刷新到系统表空间的 Max Trx ID 属性中，该属性占 8 字节</li>
<li>系统再次启动后，会读取表空间的 Max Trx ID 属性到内存，加上 256 后赋值给全局变量，因为关机时的事务 ID 可能并不是 256 的倍数，会比 Max Trx ID 大，所以需要加上 256 保持事务 ID 是一个递增的数字</li>
</ul>
<p><strong>聚簇索引</strong>的行记录除了完整的数据，还会自动添加 trx_id、roll_pointer 隐藏列，如果表中没有主键并且没有非空唯一索引，也会添加一个 row_id 的隐藏列作为聚簇索引</p>
<hr>
<h3 id="-182"><a class="markdownIt-Anchor" href="#-182">#</a> <a href="#%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB"></a>隔离级别</h3>
<h4 id="-183"><a class="markdownIt-Anchor" href="#-183">#</a> <a href="#%E5%9B%9B%E7%A7%8D%E7%BA%A7%E5%88%AB"></a>四种级别</h4>
<p>事务的隔离级别：多个客户端操作时，各个客户端的事务之间应该是隔离的，<strong>不同的事务之间不该互相影响</strong>，而如果多个事务操作同一批数据时，则需要设置不同的隔离级别，否则就会产生问题。</p>
<p>隔离级别分类：</p>
<table>
<thead>
<tr>
<th>隔离级别</th>
<th>名称</th>
<th>会引发的问题</th>
<th>数据库默认隔离级别</th>
</tr>
</thead>
<tbody>
<tr>
<td>Read Uncommitted</td>
<td>读未提交</td>
<td>脏读、不可重复读、幻读</td>
<td></td>
</tr>
<tr>
<td>Read Committed</td>
<td>读已提交</td>
<td>不可重复读、幻读</td>
<td>Oracle / SQL Server</td>
</tr>
<tr>
<td>Repeatable Read</td>
<td>可重复读</td>
<td>幻读</td>
<td>MySQL</td>
</tr>
<tr>
<td>Serializable</td>
<td>可串行化</td>
<td>无</td>
<td></td>
</tr>
</tbody>
</table>
<p>一般来说，隔离级别越低，系统开销越低，可支持的并发越高，但隔离性也越差</p>
<ul>
<li>
<p>脏写 (Dirty Write)：当两个或多个事务选择同一行，最初的事务修改的值被后面事务修改的值覆盖，所有的隔离级别都可以避免脏写（又叫丢失更新），因为有行锁</p>
</li>
<li>
<p>脏读 (Dirty Reads)：在一个事务处理过程中读取了另一个<strong>未提交</strong>的事务中修改过的数据</p>
</li>
<li>
<p>不可重复读 (Non-Repeatable Reads)：在一个事务处理过程中读取了另一个事务中修改并<strong>已提交</strong>的数据</p>
<blockquote>
<p>可重复读的意思是不管读几次，结果都一样，可以重复的读，可以理解为快照读，要读的数据集不会发生变化</p>
</blockquote>
</li>
<li>
<p>幻读 (Phantom Reads)：在事务中按某个条件先后两次查询数据库，后一次查询查到了前一次查询没有查到的行，<strong>数据条目</strong>发生了变化。比如查询某数据不存在，准备插入此记录，但执行插入时发现此记录已存在，无法插入</p>
</li>
</ul>
<p>隔离级别操作语法：</p>
<ul>
<li>
<p>查询数据库隔离级别</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> @<span class="token variable">@TX_ISOLATION</span><span class="token punctuation">;</span>
<span class="token keyword">SHOW</span> VARIABLES <span class="token operator">LIKE</span> <span class="token string">'tx_isolation'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li>
<p>修改数据库隔离级别</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SET</span> <span class="token keyword">GLOBAL</span> <span class="token keyword">TRANSACTION</span> <span class="token keyword">ISOLATION</span> <span class="token keyword">LEVEL</span> 级别字符串<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<hr>
<h4 id="-184"><a class="markdownIt-Anchor" href="#-184">#</a> <a href="#%E5%8A%A0%E9%94%81%E5%88%86%E6%9E%90"></a>加锁分析</h4>
<p>InnoDB 存储引擎支持事务，所以加锁分析是基于该存储引擎</p>
<ul>
<li>
<p>Read Uncommitted 级别，任何操作都不会加锁</p>
</li>
<li>
<p>Read Committed 级别，增删改操作会加写锁（行锁），读操作不加锁</p>
<p>MySQL 做了优化，在 Server 层过滤条件时发现不满足的记录会调用 unlock_row 方法释放该记录的行锁，保证最后只有满足条件的记录加锁，但是扫表过程中每条记录的<strong>加锁操作不能省略</strong>。所以对数据量很大的表做批量修改时，如果无法使用相应的索引，需要在 Server 过滤数据时就会特别慢，出现虽然没有修改某些行的数据，但是还是被锁住了的现象，这种情况同样适用于 RR</p>
</li>
<li>
<p>Repeatable Read 级别，增删改操作会加写锁，读操作不加锁。因为读写锁不兼容，加了写锁后其他事务就无法修改数据，影响了并发性能，为了保证隔离性和并发性，MySQL 通过 MVCC 解决了读写冲突。RR 级别下的锁有很多种，锁机制章节详解</p>
</li>
<li>
<p>Serializable 级别，读加共享锁，写加排他锁，读写互斥，使用的悲观锁的理论，实现简单，数据更加安全，但是并发能力非常差</p>
<ul>
<li>串行化：让所有事务按顺序单独执行，写操作会加写锁，读操作会加读锁</li>
<li>可串行化：让所有操作相同数据的事务顺序执行，通过加锁实现</li>
</ul>
</li>
</ul>
<p>参考文章：<a target="_blank" rel="noopener" href="https://tech.meituan.com/2014/08/20/innodb-lock.html">https://tech.meituan.com/2014/08/20/innodb-lock.html</a></p>
<hr>
<h3 id="-185"><a class="markdownIt-Anchor" href="#-185">#</a> <a href="#%E5%8E%9F%E5%AD%90%E7%89%B9%E6%80%A7"></a>原子特性</h3>
<h4 id="-186"><a class="markdownIt-Anchor" href="#-186">#</a> <a href="#%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F"></a>实现方式</h4>
<p>原子性是指事务是一个不可分割的工作单位，事务的操作如果成功就必须要完全应用到数据库，失败则不能对数据库有任何影响。比如事务中一个 SQL 语句执行失败，则已执行的语句也必须回滚，数据库退回到事务前的状态</p>
<p>InnoDB 存储引擎提供了两种事务日志：redo log（重做日志）和 undo log（回滚日志）</p>
<ul>
<li>redo log 用于保证事务持久性</li>
<li>undo log 用于保证事务原子性和隔离性</li>
</ul>
<p>undo log 属于逻辑日志，根据每行操作进行记录，记录了 SQL 执行相关的信息，用来回滚行记录到某个版本</p>
<p>当事务对数据库进行修改时，InnoDB 会先记录对应的 undo log，如果事务执行失败或调用了 rollback 导致事务回滚，InnoDB 会根据 undo log 的内容<strong>做与之前相反的操作</strong>：</p>
<ul>
<li>
<p>对于每个 insert，回滚时会执行 delete</p>
</li>
<li>
<p>对于每个 delete，回滚时会执行 insert</p>
</li>
<li>
<p>对于每个 update，回滚时会执行一个相反的 update，把数据修改回去</p>
</li>
</ul>
<p>参考文章：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/kismetv/p/10331633.html">https://www.cnblogs.com/kismetv/p/10331633.html</a></p>
<hr>
<h4 id="-187"><a class="markdownIt-Anchor" href="#-187">#</a> <a href="#dml-%E8%A7%A3%E6%9E%90"></a>DML 解析</h4>
<h5 id="-188"><a class="markdownIt-Anchor" href="#-188">#</a> <a href="#insert-1"></a>INSERT</h5>
<p>乐观插入：当前数据页的剩余空间充足，直接将数据进行插入</p>
<p>悲观插入：当前数据页的剩余空间不足，需要进行页分裂，申请一个新的页面来插入数据，会造成更多的 redo log，undo log 影响不大</p>
<p>当向某个表插入一条记录，实际上需要向聚簇索引和所有二级索引都插入一条记录，但是 undo log 只需要针对聚簇索引记录，在回滚时会根据聚簇索引去所有的二级索引进行回滚操作</p>
<p>roll_pointer 是一个指针，<strong>指向记录对应的 undo log 日志</strong>，一条记录就是一个数据行，行格式中的 roll_pointer 就指向 undo log</p>
<hr>
<h5 id="-189"><a class="markdownIt-Anchor" href="#-189">#</a> <a href="#delete-1"></a>DELETE</h5>
<p>插入到页面中的记录会根据 next_record 属性组成一个单向链表，这个链表称为正常链表，被删除的记录也会通过 next_record 组成一个垃圾链表，该链表中所占用的存储空间可以被重新利用，并不会直接清除数据</p>
<p>在页面 Page Header 中，PAGE_FREE 属性指向垃圾链表的头节点，删除的工作过程：</p>
<ul>
<li>
<p>将要删除的记录的 delete_flag 位置为 1，其他不做修改，这个过程叫 <strong>delete mark</strong></p>
</li>
<li>
<p>在事务提交前，delete_flag = 1 的记录一直都会处于中间状态</p>
</li>
<li>
<p>事务提交后，有专门的线程将 delete_flag = 1 的记录从正常链表移除并加入垃圾链表，这个过程叫 <strong>purge</strong></p>
<p>purge 线程在执行删除操作时会创建一个 ReadView，根据事务的可见性移除数据（隔离特性部分详解）</p>
</li>
</ul>
<p>当有新插入的记录时，首先判断 PAGE_FREE 指向的头节点是否足够容纳新纪录：</p>
<ul>
<li>如果可以容纳新纪录，就会直接重用已删除的记录的存储空间，然后让 PAGE_FREE 指向垃圾链表的下一个节点</li>
<li>如果不能容纳新纪录，就直接向页面申请新的空间存储，并不会遍历垃圾链表</li>
</ul>
<p>重用已删除的记录空间，可能会造成空间碎片，当数据页容纳不了一条记录时，会判断将碎片空间加起来是否可以容纳，判断为真就会重新组织页内的记录：</p>
<ul>
<li>开辟一个临时页面，将页内记录一次插入到临时页面，此时临时页面时没有碎片的</li>
<li>把临时页面的内容复制到本页，这样就解放出了内存碎片，但是会耗费很大的性能资源</li>
</ul>
<hr>
<h5 id="-190"><a class="markdownIt-Anchor" href="#-190">#</a> <a href="#update-1"></a>UPDATE</h5>
<p>执行 UPDATE 语句，对于更新主键和不更新主键有两种不同的处理方式</p>
<p>不更新主键的情况：</p>
<ul>
<li>
<p>就地更新（in-place update），如果更新后的列和更新前的列占用的存储空间一样大，就可以直接在原记录上修改</p>
</li>
<li>
<p>先删除旧纪录，再插入新纪录，这里的删除不是 delete mark，而是直接将记录加入垃圾链表，并且修改页面的相应的控制信息，执行删除的线程不是 purge，是执行更新的用户线程</p>
<p>插入新记录时可能造成页空间不足，从而导致页分裂</p>
</li>
</ul>
<p>更新主键的情况：</p>
<ul>
<li>将旧纪录进行 delete mark，在更新语句提交后由 purge 线程移入垃圾链表</li>
<li>根据更新的各列的值创建一条新纪录，插入到聚簇索引中</li>
</ul>
<p>在对一条记录修改前会<strong>将记录的隐藏列 trx_id 和 roll_pointer 的旧值记录到 undo log 对应的属性中</strong>，这样就记录的 roll_pointer 指向当前 undo log 记录，当前 undo log 记录的 roll_pointer 指向旧的 undo log 记录，<strong>形成一个版本链</strong></p>
<hr>
<h4 id="-191"><a class="markdownIt-Anchor" href="#-191">#</a> <a href="#%E5%9B%9E%E6%BB%9A%E6%97%A5%E5%BF%97"></a>回滚日志</h4>
<p>undo log 是采用段的方式来记录，Rollback Segement 称为回滚段，本质上就是一个类型是 Rollback Segement Header 的页面</p>
<p>每个回滚段中有 1024 个 undo slot，每个 slot 存放 undo 链表页面的头节点页号，每个链表对应一个叫 undo log segment 的段</p>
<ul>
<li>在以前老版本，只支持 1 个 Rollback Segement，只能记录 1024 个 undo log segment</li>
<li>MySQL5.5 开始支持 128 个 Rollback Segement，支持 128*1024 个 undo 操作</li>
</ul>
<p>工作流程：</p>
<ul>
<li>
<p>事务执行前需要到系统表空间第 5 号页面中分配一个回滚段（页），获取一个 Rollback Segement Header 页面的地址</p>
</li>
<li>
<p>回滚段页面有 1024 个 undo slot，首先去回滚段的两个 cached 链表获取缓存的 slot，缓存中没有就在回滚段页面中找一个可用的 undo slot 分配给当前事务</p>
</li>
<li>
<p>如果是缓存中获取的 slot，则该 slot 对应的 undo log segment 已经分配了，需要重新分配，然后从 undo log segment 中申请一个页面作为日志链表的头节点，并填入对应的 slot 中</p>
</li>
<li>
<p>每个事务 undo 日志在记录的时候占用两个 undo 页面的组成链表，分别为 insert undo 链表和 update undo 链表，链表的头节点页面为 first undo page 会包含一些管理信息，其他页面为 normal undo page</p>
<p>说明：事务执行过程的临时表也需要两个 undo 链表，不和普通表共用，这些链表并不是事务开始就分配，而是按需分配</p>
</li>
</ul>
<hr>
<h3 id="-192"><a class="markdownIt-Anchor" href="#-192">#</a> <a href="#%E9%9A%94%E7%A6%BB%E7%89%B9%E6%80%A7"></a>隔离特性</h3>
<h4 id="-193"><a class="markdownIt-Anchor" href="#-193">#</a> <a href="#%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F-1"></a>实现方式</h4>
<p>隔离性是指，事务内部的操作与其他事务是隔离的，多个并发事务之间要相互隔离，不能互相干扰</p>
<ul>
<li>
<p>严格的隔离性，对应了事务隔离级别中的 serializable，实际应用中对性能考虑很少使用可串行化</p>
</li>
<li>
<p>与原子性、持久性侧重于研究事务本身不同，隔离性研究的是<strong>不同事务</strong>之间的相互影响</p>
</li>
</ul>
<p>隔离性让并发情形下的事务之间互不干扰：</p>
<ul>
<li>一个事务的写操作对另一个事务的写操作（写写）：锁机制保证隔离性</li>
<li>一个事务的写操作对另一个事务的读操作（读写）：MVCC 保证隔离性</li>
</ul>
<p>锁机制：事务在修改数据之前，需要先获得相应的锁，获得锁之后，事务便可以修改数据；该事务操作期间，这部分数据是锁定的，其他事务如果需要修改数据，需要等待当前事务提交或回滚后释放锁（详解见锁机制）</p>
<hr>
<h4 id="-194"><a class="markdownIt-Anchor" href="#-194">#</a> <a href="#%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6"></a>并发控制</h4>
<p>MVCC 全称 Multi-Version Concurrency Control，即多版本并发控制，用来<strong>解决读写冲突的无锁并发控制</strong>，可以在发生读写请求冲突时不用加锁解决，这个读是指的快照读（也叫一致性读或一致性无锁读），而不是当前读：</p>
<ul>
<li>快照读：实现基于 MVCC，因为是多版本并发，所以快照读读到的数据不一定是当前最新的数据，有可能是历史版本的数据</li>
<li>当前读：读取数据库记录是当前最新的版本（产生幻读、不可重复读），可以对读取的数据进行加锁，防止其他事务修改数据，是悲观锁的一种操作，读写操作加共享锁或者排他锁和串行化事务的隔离级别都是当前读</li>
</ul>
<p>数据库并发场景：</p>
<ul>
<li>
<p>读 - 读：不存在任何问题，也不需要并发控制</p>
</li>
<li>
<p>读 - 写：有线程安全问题，可能会造成事务隔离性问题，可能遇到脏读，幻读，不可重复读</p>
</li>
<li>
<p>写 - 写：有线程安全问题，可能会存在脏写（丢失更新）问题</p>
</li>
</ul>
<p>MVCC 的优点：</p>
<ul>
<li>在并发读写数据库时，做到在读操作时不用阻塞写操作，写操作也不用阻塞读操作，提高了并发读写的性能</li>
<li>可以解决脏读，不可重复读等事务隔离问题（加锁也能解决），但不能解决更新丢失问题</li>
</ul>
<p>提高读写和写写的并发性能：</p>
<ul>
<li>MVCC + 悲观锁：MVCC 解决读写冲突，悲观锁解决写写冲突</li>
<li>MVCC + 乐观锁：MVCC 解决读写冲突，乐观锁解决写写冲突</li>
</ul>
<p>参考文章：<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/8845ddca3b23">https://www.jianshu.com/p/8845ddca3b23</a></p>
<hr>
<h4 id="-195"><a class="markdownIt-Anchor" href="#-195">#</a> <a href="#%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"></a>实现原理</h4>
<h5 id="-196"><a class="markdownIt-Anchor" href="#-196">#</a> <a href="#%E9%9A%90%E8%97%8F%E5%AD%97%E6%AE%B5"></a>隐藏字段</h5>
<p>实现原理主要是隐藏字段，undo 日志，Read View 来实现的</p>
<p>数据库中的<strong>聚簇索引</strong>每行数据，除了自定义的字段，还有数据库隐式定义的字段：</p>
<ul>
<li>DB_TRX_ID：最近修改事务 ID，记录创建该数据或最后一次修改该数据的事务 ID</li>
<li>DB_ROLL_PTR：回滚指针，<strong>指向记录对应的 undo log 日志</strong>，undo log 中又指向上一个旧版本的 undo log</li>
<li>DB_ROW_ID：隐含的自增 ID（<strong>隐藏主键</strong>），如果数据表没有主键，InnoDB 会自动以 DB_ROW_ID 作为聚簇索引</li>
</ul>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d4d5643432545372538392538382545362539432541432545392539332542452545392539412539302545382539372538462545352541442539372545362541452542352e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/75e154bbcfa54354449c01a4197b7662c63ed4e230ecb412a69c95d5ff76fa91/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d4d5643432545372538392538382545362539432541432545392539332542452545392539412539302545382539372538462545352541442539372545362541452542352e706e67">https://camo.githubusercontent.com/75e154bbcfa54354449c01a4197b7662c63ed4e230ecb412a69c95d5ff76fa91/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d4d5643432545372538392538382545362539432541432545392539332542452545392539412539302545382539372538462545352541442539372545362541452542352e706e67</a>)</p>
<hr>
<h5 id="-197"><a class="markdownIt-Anchor" href="#-197">#</a> <a href="#%E7%89%88%E6%9C%AC%E9%93%BE"></a>版本链</h5>
<p>undo log 是逻辑日志，记录的是每个事务对数据执行的操作，而不是记录的全部数据，要<strong>根据 undo log 逆推出以往事务的数据</strong></p>
<p>undo log 的作用：</p>
<ul>
<li>保证事务进行 rollback 时的原子性和一致性，当事务进行回滚的时候可以用 undo log 的数据进行恢复</li>
<li>用于 MVCC 快照读，通过读取 undo log 的历史版本数据可以实现不同事务版本号都拥有自己独立的快照数据版本</li>
</ul>
<p>undo log 主要分为两种：</p>
<ul>
<li>
<p>insert undo log：事务在 insert 新记录时产生的 undo log，只在事务回滚时需要，并且在事务提交后可以被立即丢弃</p>
</li>
<li>
<p>update undo log：事务在进行 update 或 delete 时产生的 undo log，在事务回滚时需要，在快照读时也需要。不能随意删除，只有在快速读或事务回滚不涉及该日志时，对应的日志才会被 purge 线程统一清除</p>
</li>
</ul>
<p>每次对数据库记录进行改动，都会产生的新版本的 undo log，随着更新次数的增多，所有的版本都会被 roll_pointer 属性连接成一个链表，把这个链表称之为<strong>版本链</strong>，版本链的头节点就是当前的最新的 undo log，链尾就是最早的旧 undo log</p>
<p>说明：因为 DELETE 删除记录，都是移动到垃圾链表中，不是真正的删除，所以才可以通过版本链访问原始数据</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/c92c99383492900ab78748916eed2d7ea9d8a5acb5fc9211a0061f5af114cb45/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d4d564343e78988e69cace993be2e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/c92c99383492900ab78748916eed2d7ea9d8a5acb5fc9211a0061f5af114cb45/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d4d564343e78988e69cace993be2e706e67">https://camo.githubusercontent.com/c92c99383492900ab78748916eed2d7ea9d8a5acb5fc9211a0061f5af114cb45/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d4d564343e78988e69cace993be2e706e67</a>)</p>
<p>补充：undo 是逻辑日志，这里只是直观的展示出来</p>
<p>工作流程：</p>
<ul>
<li>有个事务插入 persion 表一条新记录，name 为 Jerry，age 为 24</li>
<li>事务 1 修改该行数据时，数据库会先对该行加排他锁，然后先记录 undo log，然后修改该行 name 为 Tom，并且修改隐藏字段的事务 ID 为当前事务 1 的 ID（默认为 1 之后递增），回滚指针指向拷贝到 undo log 的副本记录，事务提交后，释放锁</li>
<li>以此类推</li>
</ul>
<hr>
<h5 id="-198"><a class="markdownIt-Anchor" href="#-198">#</a> <a href="#%E8%AF%BB%E8%A7%86%E5%9B%BE"></a>读视图</h5>
<p>Read View 是事务进行读数据操作时产生的读视图，该事务执行快照读的那一刻会生成数据库系统当前的一个快照，记录并维护系统当前活跃事务的 ID，用来做可见性判断，根据视图判断当前事务能够看到哪个版本的数据</p>
<p>注意：这里的快照并不是把所有的数据拷贝一份副本，而是由 undo log 记录的逻辑日志，根据库中的数据进行计算出历史数据</p>
<p>工作流程：将版本链的头节点的事务 ID（最新数据事务 ID）DB_TRX_ID 取出来，与系统当前活跃事务的 ID 对比进行可见性分析，不可见就通过 DB_ROLL_PTR 回滚指针去取出 undo log 中的下一个 DB_TRX_ID 比较，直到找到最近的满足可见性的 DB_TRX_ID，该事务 ID 所在的旧记录就是当前事务能看见的最新的记录</p>
<p>Read View 几个属性：</p>
<ul>
<li>m_ids：生成 Read View 时当前系统中活跃的事务 id 列表（未提交的事务集合，当前事务也在其中）</li>
<li>min_trx_id：生成 Read View 时当前系统中活跃的最小的事务 id，也就是 m_ids 中的最小值（已提交的事务集合）</li>
<li>max_trx_id：生成 Read View 时当前系统应该分配给下一个事务的 id 值，m_ids 中的最大值加 1（未开始事务）</li>
<li>creator_trx_id：生成该 Read View 的事务的事务 id，就是判断该 id 的事务能读到什么数据</li>
</ul>
<p>creator 创建一个 Read View，进行可见性算法分析：（解决了读未提交）</p>
<ul>
<li>
<p>db_trx_id == creator_trx_id：表示这个数据就是当前事务自己生成的，自己生成的数据自己肯定能看见，所以此数据对 creator 是可见的</p>
</li>
<li>
<p>db_trx_id &lt; min_trx_id：该版本对应的事务 ID 小于 Read view 中的最小活跃事务 ID，则这个事务在当前事务之前就已经被提交了，对 creator 可见</p>
</li>
<li>
<p>db_trx_id &gt;= max_trx_id：该版本对应的事务 ID 大于 Read view 中当前系统的最大事务 ID，则说明该数据是在当前 Read view 创建之后才产生的，对 creator 不可见</p>
</li>
<li>
<p>min_trx_id&lt;= db_trx_id &lt; max_trx_id：判断 db_trx_id 是否在活跃事务列表 m_ids 中</p>
<ul>
<li>在列表中，说明该版本对应的事务正在运行，数据不能显示（<strong>不能读到未提交的数据</strong>）</li>
<li>不在列表中，说明该版本对应的事务已经被提交，数据可以显示（<strong>可以读到已经提交的数据</strong>）</li>
</ul>
</li>
</ul>
<hr>
<h5 id="-199"><a class="markdownIt-Anchor" href="#-199">#</a> <a href="#%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B-1"></a>工作流程</h5>
<p>表 user 数据</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">id</span>		name		age
<span class="token number">1</span>		张三		   <span class="token number">18</span>	<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>Transaction 20：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">START</span> <span class="token keyword">TRANSACTION</span><span class="token punctuation">;</span>	<span class="token comment">-- 开启事务</span>
<span class="token keyword">UPDATE</span> <span class="token keyword">user</span> <span class="token keyword">SET</span> name <span class="token operator">=</span> <span class="token string">'李四'</span> <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">UPDATE</span> <span class="token keyword">user</span> <span class="token keyword">SET</span> name <span class="token operator">=</span> <span class="token string">'王五'</span> <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>Transaction 60：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">START</span> <span class="token keyword">TRANSACTION</span><span class="token punctuation">;</span>	<span class="token comment">-- 开启事务</span>
<span class="token comment">-- 操作表的其他数据</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d4d564343254535254237254135254534254244253943254536254235253831254537254138253842312e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/a169fdfd2f7dc3cbddd68f9fb9e6da78a5c9e46ec19d163c3e2a04de8060e940/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d4d564343254535254237254135254534254244253943254536254235253831254537254138253842312e706e67">https://camo.githubusercontent.com/a169fdfd2f7dc3cbddd68f9fb9e6da78a5c9e46ec19d163c3e2a04de8060e940/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d4d564343254535254237254135254534254244253943254536254235253831254537254138253842312e706e67</a>)</p>
<p>ID 为 0 的事务创建 Read View：</p>
<ul>
<li>m_ids：20、60</li>
<li>min_trx_id：20</li>
<li>max_trx_id：61</li>
<li>creator_trx_id：0</li>
</ul>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/0d7e9c39dabdb63629ec6625717e2d4009e6a8303721c1c8561560247e59a684/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d4d564343254535254237254135254534254244253943254536254235253831254537254138253842322e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/0d7e9c39dabdb63629ec6625717e2d4009e6a8303721c1c8561560247e59a684/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d4d564343254535254237254135254534254244253943254536254235253831254537254138253842322e706e67">https://camo.githubusercontent.com/0d7e9c39dabdb63629ec6625717e2d4009e6a8303721c1c8561560247e59a684/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d4d564343254535254237254135254534254244253943254536254235253831254537254138253842322e706e67</a>)</p>
<p>只有红框部分才复合条件，所以只有张三对应的版本的数据可以被看到</p>
<p>参考视频：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1t5411u7Fg">https://www.bilibili.com/video/BV1t5411u7Fg</a></p>
<hr>
<h5 id="-200"><a class="markdownIt-Anchor" href="#-200">#</a> <a href="#%E4%BA%8C%E7%BA%A7%E7%B4%A2%E5%BC%95"></a>二级索引</h5>
<p>只有在聚簇索引中才有 trx_id 和 roll_pointer 的隐藏列，对于二级索引判断可见性的方式：</p>
<ul>
<li>二级索引页面的 Page Header 中有一个 PAGE_MAX_TRX_ID 属性，代表修改当前页面的最大的事务 ID，SELECT 语句访问某个二级索引时会判断 ReadView 的 min_trx_id 是否大于该属性，大于说明该页面的所有属性对 ReadView 可见</li>
<li>如果属性判断不可见，就需要利用二级索引获取主键值，进行回表操作，得到聚簇索引后再按照聚簇索引的可见性判断的方法操作</li>
</ul>
<hr>
<h4 id="-201"><a class="markdownIt-Anchor" href="#-201">#</a> <a href="#rc-rr"></a>RC RR</h4>
<p>Read View 用于支持 RC（Read Committed，读已提交）和 RR（Repeatable Read，可重复读）隔离级别的实现，所以 <strong>SELECT 在 RC 和 RR 隔离级别才使用 MVCC 读取记录</strong></p>
<p>RR、RC 生成时机：</p>
<ul>
<li>RC 隔离级别下，每次读取数据前都会生成最新的 Read View（当前读）</li>
<li>RR 隔离级别下，在第一次数据读取时才会创建 Read View（快照读）</li>
</ul>
<p>RC、RR 级别下的 InnoDB 快照读区别</p>
<ul>
<li>
<p>RC 级别下，事务中每次快照读都会新生成一个 Read View，这就是在 RC 级别下的事务中可以看到别的事务提交的更新的原因</p>
</li>
<li>
<p>RR 级别下，某个事务的对某条记录的第一次快照读会创建一个 Read View， 将当前系统活跃的其他事务记录起来，此后在调用快照读的时候，使用的是同一个 Read View，所以一个事务的查询结果每次都是相同的</p>
<p>RR 级别下，通过  <code>START TRANSACTION WITH CONSISTENT SNAPSHOT</code>  开启事务，会在执行该语句后立刻生成一个 Read View，不是在执行第一条 SELECT 语句时生成</p>
</li>
</ul>
<p>解决幻读问题：</p>
<ul>
<li>
<p>快照读：通过 MVCC 来进行控制的，在可重复读隔离级别下，普通查询是快照读，是不会看到别的事务插入的数据的，但是<strong>并不能完全避免幻读</strong></p>
<p>场景：RR 级别，T1 事务开启，创建 Read View，此时 T2 去 INSERT 新的一行然后提交，然后 T1 去 UPDATE 该行会发现更新成功，因为 <strong>Read View 并不能阻止事务去更新数据</strong>，并且把这条新记录的 trx_id 给变为当前的事务 id，所以对当前事务就是可见的</p>
</li>
<li>
<p>当前读：通过 next-key 锁（行锁 + 间隙锁）来解决问题</p>
</li>
</ul>
<hr>
<h3 id="-202"><a class="markdownIt-Anchor" href="#-202">#</a> <a href="#%E6%8C%81%E4%B9%85%E7%89%B9%E6%80%A7"></a>持久特性</h3>
<h4 id="-203"><a class="markdownIt-Anchor" href="#-203">#</a> <a href="#%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F-2"></a>实现方式</h4>
<p>持久性是指一个事务一旦被提交了，那么对数据库中数据的改变就是永久性的，接下来的其他操作或故障不应该对其有任何影响。</p>
<p>Buffer Pool 的使用提高了读写数据的效率，但是如果 MySQL 宕机，此时 Buffer Pool 中修改的数据还没有刷新到磁盘，就会导致数据的丢失，事务的持久性无法保证，所以引入了 redo log 日志：</p>
<ul>
<li>redo log <strong>记录数据页的物理修改</strong>，而不是某一行或某几行的修改，用来恢复<strong>提交后</strong>的数据页，只能恢复到最后一次提交的位置</li>
<li>redo log 采用的是 WAL（Write-ahead logging，<strong>预写式日志</strong>），所有修改要先写入日志，再更新到磁盘，保证了数据不会因 MySQL 宕机而丢失，从而满足了持久性要求</li>
<li>简单的 redo log 是纯粹的物理日志，负责的 redo log 会存在物理日志和逻辑日志</li>
</ul>
<p>工作过程：MySQL 发生了宕机，InnoDB 会判断一个数据页在崩溃恢复时丢失了更新，就会将它读到内存，然后根据 redo log 内容更新内存，更新完成后，内存页变成脏页，然后进行刷脏</p>
<p>缓冲池的<strong>刷脏策略</strong>：</p>
<ul>
<li>redo log 文件是固定大小的，如果写满了就要擦除以前的记录，在擦除之前需要把旧记录更新到磁盘中的数据文件中</li>
<li>Buffer Pool 内存不足，需要淘汰部分数据页，如果淘汰的是脏页，就要先将脏页写到磁盘（要避免大事务）</li>
<li>系统空闲时，后台线程会自动进行刷脏（Flush 链表部分已经详解）</li>
<li>MySQL 正常关闭时，会把内存的脏页都刷新到磁盘上</li>
</ul>
<hr>
<h4 id="-204"><a class="markdownIt-Anchor" href="#-204">#</a> <a href="#%E9%87%8D%E5%81%9A%E6%97%A5%E5%BF%97"></a>重做日志</h4>
<h5 id="-205"><a class="markdownIt-Anchor" href="#-205">#</a> <a href="#%E6%97%A5%E5%BF%97%E7%BC%93%E5%86%B2"></a>日志缓冲</h5>
<p>服务器启动时会向操作系统申请一片连续内存空间作为 redo log buffer（重做日志缓冲区），可以通过  <code>innodb_log_buffer_size</code>  系统变量指定 redo log buffer 的大小，默认是 16MB</p>
<p>log buffer 被划分为若干 redo log block（块，类似数据页的概念），每个默认大小 512 字节，每个 block 由 12 字节的 log block head、496 字节的 log block body、4 字节的 log block trailer 组成</p>
<ul>
<li>当数据修改时，先修改 Change Buffer 中的数据，然后在 redo log buffer 记录这次操作，写入 log buffer 的过程是顺序写入的（先写入前面的 block，写满后继续写下一个）</li>
<li>log buffer 中有一个指针 buf_free，来标识该位置之前都是填满的 block，该位置之后都是空闲区域（<strong>碰撞指针</strong>）</li>
</ul>
<p>MySQL 规定对底层页面的一次原子访问称为一个 Mini-Transaction（MTR），比如在 B+ 树上插入一条数据就算一个 MTR</p>
<ul>
<li>
<p>一个事务包含若干个 MTR，一个 MTR 对应一组若干条 redo log，一组 redo log 是不可分割的，在进行数据恢复时也把一组 redo log 当作一个不可分割的整体处理</p>
</li>
<li>
<p>所以不是每生成一条 redo 日志就将其插入到 log buffer 中，而是一个 MTR 结束后<strong>将一组 redo 日志写入 log buffer</strong></p>
</li>
</ul>
<hr>
<h5 id="-206"><a class="markdownIt-Anchor" href="#-206">#</a> <a href="#%E6%97%A5%E5%BF%97%E5%88%B7%E7%9B%98"></a>日志刷盘</h5>
<p>redo log 需要在事务提交时将日志写入磁盘，但是比将内存中的 Buffer Pool 修改的数据写入磁盘的速度快，原因：</p>
<ul>
<li>刷脏是随机 IO，因为每次修改的数据位置随机，但写 redo log 是尾部追加操作，属于顺序 IO</li>
<li>刷脏是以数据页（Page）为单位的，一个页上的一个小修改都要整页写入，而 redo log 中只包含真正需要写入的部分，减少无效 IO</li>
</ul>
<p>InnoDB 引擎会在适当的时候，把内存中 redo log buffer 持久化到磁盘，具体的<strong>刷盘策略</strong>：</p>
<ul>
<li>在事务提交时需要进行刷盘，通过修改参数  <code>innodb_flush_log_at_trx_commit</code>  设置：
<ul>
<li>0：表示当提交事务时，并不将缓冲区的 redo 日志写入磁盘，而是等待后台线程每秒刷新一次</li>
<li>1：在事务提交时将缓冲区的 redo 日志<strong>同步写入</strong>到磁盘，保证一定会写入成功（默认值）</li>
<li>2：在事务提交时将缓冲区的 redo 日志异步写入到磁盘，不能保证提交时肯定会写入，只是有这个动作。已经写入到操作系统的缓存，如果操作系统没有宕机而 MySQL 宕机，也是可以恢复数据的</li>
</ul>
</li>
<li>写入 redo log buffer 的日志超过了总容量的一半，就会将日志刷入到磁盘文件，这会影响执行效率，所以开发中应<strong>避免大事务</strong></li>
<li>服务器关闭时</li>
<li>checkpoint 时（下小节详解）</li>
</ul>
<p>redo 日志在磁盘中以文件组的形式存储，同一组中的每个文件大小一样格式一样，</p>
<ul>
<li><code>innodb_log_group_home_dir</code>  代表磁盘存储 redo log 的文件目录，默认是当前数据目录</li>
<li><code>innodb_log_file_size</code>  代表文件大小，默认 48M， <code>innodb_log_files_in_group</code>  代表文件个数，默认 2 最大 100，所以日志的文件大小为  <code>innodb_log_file_size * innodb_log_files_in_group</code></li>
</ul>
<p>redo 日志文件也是由若干个 512 字节的 block 组成，日志文件的前 2048 个字节（前 4 个 block）用来存储一些管理信息，以后的用来存储 log buffer 中的 block 镜像</p>
<p>注意：block 并不代表一组 redo log，一组日志可能占用不到一个 block 或者几个 block，依赖于 MTR 的大小</p>
<p>服务器启动后 redo 磁盘空间不变，所以 redo 磁盘中的日志文件是被<strong>循环使用</strong>的，采用循环写数据的方式，写完尾部重新写头部，所以要确保头部 log 对应的修改已经持久化到磁盘</p>
<hr>
<h5 id="-207"><a class="markdownIt-Anchor" href="#-207">#</a> <a href="#%E6%97%A5%E5%BF%97%E5%BA%8F%E5%8F%B7"></a>日志序号</h5>
<p>lsn (log sequence number) 代表已经写入的 redo 日志量、flushed_to_disk_lsn 指刷新到磁盘中的 redo 日志量，两者都是<strong>全局变量</strong>，如果两者的值相同，说明 log buffer 中所有的 redo 日志都已经持久化到磁盘</p>
<p>工作过程：写入 log buffer 数据时，buf_free 会进行偏移，偏移量就会加到 lsn 上</p>
<p>MTR 的执行过程中修改过的页对应的控制块会加到 Buffer Pool 的 flush 链表中，链表中脏页是按照第一次修改的时间进行排序的（头插），控制块中有两个指针用来记录脏页被修改的时间：</p>
<ul>
<li>oldest_modification：第一次修改 Buffer Pool 中某个缓冲页时，将修改该页的 MTR <strong>开始时</strong>对应的 lsn 值写入这个属性，所以链表页是以该值进行排序的</li>
<li>newest_modification：每次修改页面，都将 MTR <strong>结束时</strong>对应的 lsn 值写入这个属性，所以是该页面最后一次修改后对应的 lsn 值</li>
</ul>
<p>全局变量 checkpoint_lsn 表示当前系统可以被覆盖的 redo 日志总量，当 redo 日志对应的脏页已经被刷新到磁盘后，该文件空间就可以被覆盖重用，此时执行一次 checkpoint 来更新 checkpoint_lsn 的值存入管理信息，刷脏和执行一次 checkpoint 并不是同一个线程</p>
<p><strong>checkpoint</strong>：从 flush 链表尾部中找出还未刷脏的页面，该页面是当前系统中最早被修改的脏页，该页面之前产生的脏页都已经刷脏，然后将该页 oldest_modification 值赋值给 checkpoint_lsn，因为 lsn 小于该值时产生的 redo 日志都可以被覆盖了</p>
<p>checkpoint_lsn 是一个总量，随着 lsn 写入的增加，刷脏的继续进行，所以 checkpoint_lsn 值就会一直变大，该值的增量就代表磁盘文件中当前位置向后可以被覆盖的文件的量</p>
<p>在系统忙碌时，后台线程的刷脏操作不能将脏页快速刷出，导致系统无法及时执行 checkpoint，这时需要用户线程从 flush 链表中把最早修改的脏页刷新到磁盘中，然后执行 checkpoint</p>
<p>使用命令可以查看当前 InnoDB 存储引擎各种 lsn 的值：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SHOW</span> <span class="token keyword">ENGINE</span> <span class="token keyword">INNODB</span> <span class="token keyword">STATUS</span>\G<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<hr>
<h5 id="-208"><a class="markdownIt-Anchor" href="#-208">#</a> <a href="#%E5%B4%A9%E6%BA%83%E6%81%A2%E5%A4%8D"></a>崩溃恢复</h5>
<p>恢复的起点：在从 redo 日志文件组的管理信息中获取最近发生 checkpoint 的信息，从 checkpoint_lsn 对应的日志文件开始恢复</p>
<p>恢复的终点：扫描日志文件的 block，block 的头部记录着当前 block 使用了多少字节，填满的 block 总是 512 字节， 如果某个 block 不是 512 字节，说明该 block 就是需要恢复的最后一个 block</p>
<p>恢复的过程：按照 redo log 依次执行恢复数据，优化方式</p>
<ul>
<li>使用哈希表：根据 redo log 的 space ID 和 page number 属性计算出哈希值，将对同一页面的修改放入同一个槽里，可以一次性完成对某页的恢复，<strong>避免了随机 IO</strong></li>
<li>跳过已经刷新到磁盘中的页面：数据页的 File Header 中的 FILE_PAGE_LSN 属性（类似 newest_modification）表示最近一次修改页面时的 lsn 值，如果在 checkpoint 后，数据页被刷新到磁盘中，那么该页 lsn 属性肯定大于 checkpoint_lsn</li>
</ul>
<p>问题：系统崩溃前没有提交的事务的 redo log 可能已经刷盘，这些数据可能在重启后也会恢复</p>
<p>解决：通过 undo log 在服务器重启时将未提交的事务回滚掉，定位到 128 个回滚段，遍历 slot，获取 undo 链表首节点页面的 undo segement header 中的 TRX_UNDO_STATE 属性，表示当前链表的事务属性，如果是活跃的就全部回滚</p>
<p>参考书籍：<a target="_blank" rel="noopener" href="https://book.douban.com/subject/35231266/">https://book.douban.com/subject/35231266/</a></p>
<hr>
<h4 id="-209"><a class="markdownIt-Anchor" href="#-209">#</a> <a href="#%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B-2"></a>工作流程</h4>
<p>MySQL 中还存在 binlog（二进制日志）也可以记录写操作并用于数据的恢复，<strong>保证数据不丢失</strong>，二者的区别是：</p>
<ul>
<li>
<p>作用不同：redo log 是用于 crash recovery （故障恢复），保证 MySQL 宕机也不会影响持久性；binlog 是用于 point-in-time recovery 的，保证服务器可以基于时间点恢复数据，此外 binlog 还用于主从复制</p>
</li>
<li>
<p>层次不同：redo log 是 InnoDB 存储引擎实现的，而 binlog 是 MySQL 的服务器层实现的，同时支持 InnoDB 和其他存储引擎</p>
</li>
<li>
<p>内容不同：redo log 是物理日志，内容基于磁盘的 Page；binlog 的内容是二进制的，根据 binlog_format 参数的不同，可能基于 SQL 语句、基于数据本身或者二者的混合（日志部分详解）</p>
</li>
<li>
<p>写入时机不同：binlog 在事务提交时一次写入；redo log 的写入时机相对多元</p>
</li>
</ul>
<p>两种日志在 update 更新数据的<strong>作用时机</strong>：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">update</span> T <span class="token keyword">set</span> c<span class="token operator">=</span>c<span class="token operator">+</span><span class="token number">1</span> <span class="token keyword">where</span> ID<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/8e96db01892c532fc1fe4090dec99bfa9ce6fcd55fec36989f2688436fea0f65/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d757064617465e79a84e689a7e8a18ce6b581e7a88b2e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/8e96db01892c532fc1fe4090dec99bfa9ce6fcd55fec36989f2688436fea0f65/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d757064617465e79a84e689a7e8a18ce6b581e7a88b2e706e67">https://camo.githubusercontent.com/8e96db01892c532fc1fe4090dec99bfa9ce6fcd55fec36989f2688436fea0f65/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d757064617465e79a84e689a7e8a18ce6b581e7a88b2e706e67</a>)</p>
<p>流程说明：执行引擎将这行新数据更新到内存中（Buffer Pool）后，然后会将这个更新操作记录到 redo log buffer 里，此时 redo log 处于 prepare 状态，代表执行完成随时可以提交事务，然后执行器生成这个操作的 binlog 并<strong>把 binlog 写入磁盘</strong>，在提交事务后 <strong>redo log 也持久化到磁盘</strong></p>
<p>redo log 和 binlog 都可以用于表示事务的提交状态，而<strong>两阶段提交就是让这两个状态保持逻辑上的一致</strong>，也有利于主从复制，更好的保持主从数据的一致性</p>
<p>故障恢复数据：</p>
<ul>
<li>如果在时刻 A 发生了崩溃（crash），由于此时 binlog 还没写，redo log 也没提交，所以数据恢复的时候这个事务会回滚</li>
<li>如果在时刻 B 发生了崩溃，redo log 和 binlog 有一个共同的数据字段叫 XID，崩溃恢复的时候，会按顺序扫描 redo log：
<ul>
<li>如果 redo log 里面的事务是完整的，也就是已经有了 commit 标识，说明 binlog 也已经记录完整，直接从 redo log 恢复数据</li>
<li>如果 redo log 里面的事务只有 prepare，就根据 XID 去 binlog 中判断对应的事务是否存在并完整，如果完整可以从 binlog 恢复 redo log 的信息，进而恢复数据，提交事务</li>
</ul>
</li>
</ul>
<p>判断一个事务的 binlog 是否完整的方法：</p>
<ul>
<li>statement 格式的 binlog，最后会有 COMMIT</li>
<li>row 格式的 binlog，最后会有一个 XID event</li>
<li>MySQL 5.6.2 版本以后，引入了 binlog-checksum 参数用来验证 binlog 内容的正确性</li>
</ul>
<p>参考文章：<a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/73161">https://time.geekbang.org/column/article/73161</a></p>
<hr>
<h4 id="-210"><a class="markdownIt-Anchor" href="#-210">#</a> <a href="#%E7%B3%BB%E7%BB%9F%E4%BC%98%E5%8C%96-2"></a>系统优化</h4>
<p>系统在进行刷脏时会占用一部分系统资源，会影响系统的性能，产生系统抖动</p>
<ul>
<li>一个查询要淘汰的脏页个数太多，会导致查询的响应时间明显变长</li>
<li>日志写满，更新全部堵住，写性能跌为 0，这种情况对敏感业务来说，是不能接受的</li>
</ul>
<p>InnoDB 刷脏页的控制策略：</p>
<ul>
<li>
<p><code>innodb_io_capacity</code>  参数代表磁盘的读写能力，建议设置成磁盘的 IOPS（每秒的 IO 次数）</p>
</li>
<li>
<p>刷脏速度参考两个因素：脏页比例和 redo log 写盘速度</p>
<ul>
<li>参数  <code>innodb_max_dirty_pages_pct</code>  是脏页比例上限，默认值是 75%，InnoDB 会根据当前的脏页比例，算出一个范围在 0 到 100 之间的数字</li>
<li>InnoDB 每次写入的日志都有一个序号，当前写入的序号跟 checkpoint 对应的序号之间的差值，InnoDB 根据差值算出一个范围在 0 到 100 之间的数字</li>
<li>两者较大的值记为 R，执行引擎按照 innodb_io_capacity 定义的能力乘以 R% 来控制刷脏页的速度</li>
</ul>
</li>
<li>
<p><code>innodb_flush_neighbors</code>  参数置为 1 代表控制刷脏时检查相邻的数据页，如果也是脏页就一起刷脏，并检查邻居的邻居，这个行为会一直蔓延直到不是脏页，在 MySQL 8.0 中该值的默认值是 0，不建议开启此功能</p>
</li>
</ul>
<hr>
<h3 id="-211"><a class="markdownIt-Anchor" href="#-211">#</a> <a href="#%E4%B8%80%E8%87%B4%E7%89%B9%E6%80%A7"></a>一致特性</h3>
<p>一致性是指事务执行前后，数据库的完整性约束没有被破坏，事务执行的前后都是合法的数据状态。</p>
<p>数据库的完整性约束包括但不限于：实体完整性（如行的主键存在且唯一）、列完整性（如字段的类型、大小、长度要符合要求）、外键约束、用户自定义完整性（如转账前后，两个账户余额的和应该不变）</p>
<p>实现一致性的措施：</p>
<ul>
<li>保证原子性、持久性和隔离性，如果这些特性无法保证，事务的一致性也无法保证</li>
<li>数据库本身提供保障，例如不允许向整形列插入字符串值、字符串长度不能超过列的限制等</li>
<li>应用层面进行保障，例如如果转账操作只扣除转账者的余额，而没有增加接收者的余额，无论数据库实现的多么完美，也无法保证状态的一致</li>
</ul>
<hr>
<h2 id="-212"><a class="markdownIt-Anchor" href="#-212">#</a> <a href="#%E9%94%81%E6%9C%BA%E5%88%B6"></a>锁机制</h2>
<h3 id="-213"><a class="markdownIt-Anchor" href="#-213">#</a> <a href="#%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D-6"></a>基本介绍</h3>
<p>锁机制：数据库为了保证数据的一致性，在共享的资源被并发访问时变得安全有序所设计的一种规则</p>
<p>利用 MVCC 性质进行读取的操作叫<strong>一致性读</strong>，读取数据前加锁的操作叫<strong>锁定读</strong></p>
<p>锁的分类：</p>
<ul>
<li>
<p>按操作分类：</p>
<ul>
<li>共享锁：也叫读锁。对同一份数据，多个事务读操作可以同时加锁而不互相影响 ，但不能修改数据</li>
<li>排他锁：也叫写锁。当前的操作没有完成前，会阻断其他操作的读取和写入</li>
</ul>
</li>
<li>
<p>按粒度分类：</p>
<ul>
<li>表级锁：会锁定整个表，开销小，加锁快；不会出现死锁；锁定力度大，发生锁冲突概率高，并发度最低，偏向 MyISAM</li>
<li>行级锁：会锁定当前操作行，开销大，加锁慢；会出现死锁；锁定力度小，发生锁冲突概率低，并发度高，偏向 InnoDB</li>
<li>页级锁：锁的力度、发生冲突的概率和加锁开销介于表锁和行锁之间，会出现死锁，并发性能一般</li>
</ul>
</li>
<li>
<p>按使用方式分类：</p>
<ul>
<li>悲观锁：每次查询数据时都认为别人会修改，很悲观，所以查询时加锁</li>
<li>乐观锁：每次查询数据时都认为别人不会修改，很乐观，但是更新时会判断一下在此期间别人有没有去更新这个数据</li>
</ul>
</li>
<li>
<p>不同存储引擎支持的锁</p>
<table>
<thead>
<tr>
<th>储引擎</th>
<th>表级锁</th>
<th>行级锁</th>
<th>页级锁</th>
</tr>
</thead>
<tbody>
<tr>
<td>yISAM</td>
<td>支持</td>
<td>不支持</td>
<td>不支持</td>
</tr>
<tr>
<td>nnoDB</td>
<td><strong>支持</strong></td>
<td><strong>支持</strong></td>
<td>不支持</td>
</tr>
<tr>
<td>EMORY</td>
<td>支持</td>
<td>不支持</td>
<td>不支持</td>
</tr>
<tr>
<td>DB</td>
<td>支持</td>
<td>不支持</td>
<td>支持</td>
</tr>
</tbody>
</table>
</li>
</ul>
<p>从锁的角度来说：表级锁更适合于以查询为主，只有少量按索引条件更新数据的应用，如 Web 应用；而行级锁则更适合于有大量按索引条件并发更新少量不同数据，同时又有并查询的应用，如一些在线事务处理系统</p>
<hr>
<h3 id="-214"><a class="markdownIt-Anchor" href="#-214">#</a> <a href="#%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84"></a>内存结构</h3>
<p>对一条记录加锁的本质就是在内存中创建一个锁结构与之关联，结构包括</p>
<ul>
<li>事务信息：锁对应的事务信息，一个锁属于一个事务</li>
<li>索引信息：对于行级锁，需要记录加锁的记录属于哪个索引</li>
<li>表锁和行锁信息：表锁记录着锁定的表，行锁记录了 Space ID 所在表空间、Page Number 所在的页号、n_bits 使用了多少比特</li>
<li>type_mode：一个 32 比特的数，被分成 lock_mode、lock_type、rec_lock_type 三个部分
<ul>
<li>lock_mode：锁模式，记录是共享锁、排他锁、意向锁之类</li>
<li>lock_type：代表表级锁还是行级锁</li>
<li>rec_lock_type：代表行锁的具体类型和 is_waiting 属性，is_waiting = true 时表示当前事务尚未获取到锁，处于等待状态。事务获取锁后的锁结构是 is_waiting 为 false，释放锁时会检查是否与当前记录关联的锁结构，如果有就唤醒对应事务的线程</li>
</ul>
</li>
</ul>
<p>一个事务可能操作多条记录，为了节省内存，满足下面条件的锁使用同一个锁结构：</p>
<ul>
<li>在同一个事务中的加锁操作</li>
<li>被加锁的记录在同一个页面中</li>
<li>加锁的类型时一样的</li>
<li>加锁的状态时一样的</li>
</ul>
<hr>
<h3 id="-215"><a class="markdownIt-Anchor" href="#-215">#</a> <a href="#server"></a>Server</h3>
<p>MySQL 里面表级别的锁有两种：一种是表锁，一种是元数据锁（meta data lock，MDL)</p>
<p>MDL 叫元数据锁，主要用来保护 MySQL 内部对象的元数据，保证数据读写的正确性，<strong>当对一个表做增删改查的时候，加 MDL 读锁；当要对表做结构变更操作 DDL 的时候，加 MDL 写锁</strong>，两种锁不相互兼容，所以可以保证 DDL、DML、DQL 操作的安全</p>
<p>说明：DDL 操作执行前会隐式提交当前会话的事务，因为 DDL 一般会在若干个特殊事务中完成，开启特殊事务前需要提交到其他事务</p>
<p>MDL 锁的特性：</p>
<ul>
<li>
<p>MDL 锁不需要显式使用，在访问一个表的时候会被自动加上，在事务开始执行时申请，在整个事务提交后释放</p>
</li>
<li>
<p>MDL 锁是在 Server 中实现，不是 InnoDB 存储引擎层能直接实现的锁</p>
</li>
<li>
<p>MDL 锁还能实现其他粒度级别的锁，比如全局锁、库级别的锁、表空间级别的锁</p>
</li>
</ul>
<p>FLUSH TABLES WITH READ LOCK 简称（FTWRL），全局读锁，让整个库处于只读状态，工作流程：</p>
<ol>
<li>上全局读锁（lock_global_read_lock）</li>
<li>清理表缓存（close_cached_tables）</li>
<li>上全局 COMMIT 锁（make_global_read_lock_block_commit）</li>
</ol>
<p>该命令主要用于备份工具做一致性备份，由于 FTWRL 需要持有两把全局的 MDL 锁，并且还要关闭所有表对象，因此杀伤性很大</p>
<hr>
<h3 id="-216"><a class="markdownIt-Anchor" href="#-216">#</a> <a href="#myisam-1"></a>MyISAM</h3>
<h4 id="-217"><a class="markdownIt-Anchor" href="#-217">#</a> <a href="#%E8%A1%A8%E7%BA%A7%E9%94%81"></a>表级锁</h4>
<p>MyISAM 存储引擎只支持表锁，这也是 MySQL 开始几个版本中唯一支持的锁类型</p>
<p>MyISAM 引擎在执行查询语句之前，会<strong>自动</strong>给涉及到的所有表加读锁，在执行增删改之前，会<strong>自动</strong>给涉及的表加写锁，这个过程并不需要用户干预，所以用户一般不需要直接用 LOCK TABLE 命令给 MyISAM 表显式加锁</p>
<ul>
<li>
<p>加锁命令：（对 InnoDB 存储引擎也适用）</p>
<p>读锁：所有连接只能读取数据，不能修改</p>
<p>写锁：其他连接不能查询和修改数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 读锁</span>
<span class="token keyword">LOCK</span> <span class="token keyword">TABLE</span> table_name <span class="token keyword">READ</span><span class="token punctuation">;</span>

<span class="token comment">-- 写锁</span>
<span class="token keyword">LOCK</span> <span class="token keyword">TABLE</span> table_name <span class="token keyword">WRITE</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>解锁命令：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 将当前会话所有的表进行解锁</span>
<span class="token keyword">UNLOCK</span> <span class="token keyword">TABLES</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
</ul>
<p>锁的兼容性：</p>
<ul>
<li>对 MyISAM 表的读操作，不会阻塞其他用户对同一表的读请求，但会阻塞对同一表的写请求</li>
<li>对 MyISAM 表的写操作，则会阻塞其他用户对同一表的读和写操作</li>
</ul>
<p>![](<a target="_blank" rel="noopener" href="https://gitee.com/seazean/images/raw/master/DB/MySQL-MyISAM">https://gitee.com/seazean/images/raw/master/DB/MySQL-MyISAM</a> 锁的兼容性.png)</p>
<p>锁调度：<strong>MyISAM 的读写锁调度是写优先</strong>，因为写锁后其他线程不能做任何操作，大量的更新会使查询很难得到锁，从而造成永远阻塞，所以 MyISAM 不适合做写为主的表的存储引擎</p>
<hr>
<h4 id="-218"><a class="markdownIt-Anchor" href="#-218">#</a> <a href="#%E9%94%81%E6%93%8D%E4%BD%9C"></a>锁操作</h4>
<h5 id="-219"><a class="markdownIt-Anchor" href="#-219">#</a> <a href="#%E8%AF%BB%E9%94%81"></a>读锁</h5>
<p>两个客户端操作 Client 1 和 Client 2，简化为 C1、C2</p>
<ul>
<li>
<p>数据准备：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>tb_book<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>publish_time<span class="token punctuation">`</span> <span class="token keyword">DATE</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span><span class="token keyword">status</span><span class="token punctuation">`</span> <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span>MYISAM <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tb_book <span class="token punctuation">(</span>id<span class="token punctuation">,</span> NAME<span class="token punctuation">,</span> publish_time<span class="token punctuation">,</span> <span class="token keyword">STATUS</span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'java编程思想'</span><span class="token punctuation">,</span><span class="token string">'2088-08-01'</span><span class="token punctuation">,</span><span class="token string">'1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tb_book <span class="token punctuation">(</span>id<span class="token punctuation">,</span> NAME<span class="token punctuation">,</span> publish_time<span class="token punctuation">,</span> <span class="token keyword">STATUS</span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'mysql编程思想'</span><span class="token punctuation">,</span><span class="token string">'2088-08-08'</span><span class="token punctuation">,</span><span class="token string">'0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>C1、C2 加读锁，同时查询可以正常查询出数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">LOCK</span> <span class="token keyword">TABLE</span> tb_book <span class="token keyword">READ</span><span class="token punctuation">;</span>	<span class="token comment">-- C1、C2</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tb_book<span class="token punctuation">;</span>		<span class="token comment">-- C1、C2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>![](<a target="_blank" rel="noopener" href="https://gitee.com/seazean/images/raw/master/DB/MySQL-MyISAM">https://gitee.com/seazean/images/raw/master/DB/MySQL-MyISAM</a> 读锁 1.png)</p>
</li>
<li>
<p>C1 加读锁，C1、C2 查询未锁定的表，C1 报错，C2 正常查询</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">LOCK</span> <span class="token keyword">TABLE</span> tb_book <span class="token keyword">READ</span><span class="token punctuation">;</span>	<span class="token comment">-- C1</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tb_user<span class="token punctuation">;</span>		<span class="token comment">-- C1、C2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>![](<a target="_blank" rel="noopener" href="https://gitee.com/seazean/images/raw/master/DB/MySQL-MyISAM">https://gitee.com/seazean/images/raw/master/DB/MySQL-MyISAM</a> 读锁 2.png)</p>
<p>C1、C2 执行插入操作，C1 报错，C2 等待获取</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tb_book <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'Spring高级'</span><span class="token punctuation">,</span><span class="token string">'2088-01-01'</span><span class="token punctuation">,</span><span class="token string">'1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">-- C1、C2</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>![](<a target="_blank" rel="noopener" href="https://gitee.com/seazean/images/raw/master/DB/MySQL-MyISAM">https://gitee.com/seazean/images/raw/master/DB/MySQL-MyISAM</a> 读锁 3.png)</p>
<p>当在 C1 中释放锁指令 UNLOCK TABLES，C2 中的 INSERT 语句立即执行</p>
</li>
</ul>
<hr>
<h5 id="-220"><a class="markdownIt-Anchor" href="#-220">#</a> <a href="#%E5%86%99%E9%94%81"></a>写锁</h5>
<p>两个客户端操作 Client 1 和 Client 2，简化为 C1、C2</p>
<ul>
<li>
<p>C1 加写锁，C1、C2 查询表，C1 正常查询，C2 需要等待</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">LOCK</span> <span class="token keyword">TABLE</span> tb_book <span class="token keyword">WRITE</span><span class="token punctuation">;</span>	<span class="token comment">-- C1</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tb_book<span class="token punctuation">;</span>		<span class="token comment">-- C1、C2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>![](<a target="_blank" rel="noopener" href="https://gitee.com/seazean/images/raw/master/DB/MySQL-MyISAM">https://gitee.com/seazean/images/raw/master/DB/MySQL-MyISAM</a> 写锁 1.png)</p>
<p>当在 C1 中释放锁指令 UNLOCK TABLES，C2 中的 SELECT 语句立即执行</p>
</li>
<li>
<p>C1、C2 同时加写锁</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">LOCK</span> <span class="token keyword">TABLE</span> tb_book <span class="token keyword">WRITE</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>![](<a target="_blank" rel="noopener" href="https://gitee.com/seazean/images/raw/master/DB/MySQL-MyISAM">https://gitee.com/seazean/images/raw/master/DB/MySQL-MyISAM</a> 写锁 2.png)</p>
</li>
<li>
<p>C1 加写锁，C1、C2 查询未锁定的表，C1 报错，C2 正常查询</p>
</li>
</ul>
<hr>
<h4 id="-221"><a class="markdownIt-Anchor" href="#-221">#</a> <a href="#%E9%94%81%E7%8A%B6%E6%80%81"></a>锁状态</h4>
<ul>
<li>
<p>查看锁竞争：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SHOW</span> <span class="token keyword">OPEN</span> <span class="token keyword">TABLES</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/21ec81d0fdb80f8bf11c39a42c9c856a588b129f2370381f93bdf006c02b2cc8/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d254539253934253831254534254241253839254537253934254138254536253833253835254535253836254235254536253946254135254537253943253842312e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/21ec81d0fdb80f8bf11c39a42c9c856a588b129f2370381f93bdf006c02b2cc8/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d254539253934253831254534254241253839254537253934254138254536253833253835254535253836254235254536253946254135254537253943253842312e706e67">https://camo.githubusercontent.com/21ec81d0fdb80f8bf11c39a42c9c856a588b129f2370381f93bdf006c02b2cc8/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d254539253934253831254534254241253839254537253934254138254536253833253835254535253836254235254536253946254135254537253943253842312e706e67</a>)</p>
<p>In_user：表当前被查询使用的次数，如果该数为零，则表是打开的，但是当前没有被使用</p>
<p>Name_locked：表名称是否被锁定，名称锁定用于取消表或对表进行重命名等操作</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">LOCK</span> <span class="token keyword">TABLE</span> tb_book <span class="token keyword">READ</span><span class="token punctuation">;</span>	<span class="token comment">-- 执行命令</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d254539253934253831254534254241253839254537253934254138254536253833253835254535253836254235254536253946254135254537253943253842322e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/3cc41a5e96076dd10c2f7b9ae27f5403fbb7629f5dc0ec4954d08d7ea017ffb6/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d254539253934253831254534254241253839254537253934254138254536253833253835254535253836254235254536253946254135254537253943253842322e706e67">https://camo.githubusercontent.com/3cc41a5e96076dd10c2f7b9ae27f5403fbb7629f5dc0ec4954d08d7ea017ffb6/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d254539253934253831254534254241253839254537253934254138254536253833253835254535253836254235254536253946254135254537253943253842322e706e67</a>)</p>
</li>
<li>
<p>查看锁状态：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SHOW</span> <span class="token keyword">STATUS</span> <span class="token operator">LIKE</span> <span class="token string">'Table_locks%'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>![](<a target="_blank" rel="noopener" href="https://gitee.com/seazean/images/raw/master/DB/MySQL-MyISAM">https://gitee.com/seazean/images/raw/master/DB/MySQL-MyISAM</a> 锁状态.png)</p>
<p>Table_locks_immediate：指的是能立即获得表级锁的次数，每立即获取锁，值加 1</p>
<p>Table_locks_waited：指的是不能立即获取表级锁而需要等待的次数，每等待一次，该值加 1，此值高说明存在着较为严重的表级锁争用情况</p>
</li>
</ul>
<hr>
<h3 id="-222"><a class="markdownIt-Anchor" href="#-222">#</a> <a href="#innodb-1"></a>InnoDB</h3>
<h4 id="-223"><a class="markdownIt-Anchor" href="#-223">#</a> <a href="#%E8%A1%8C%E7%BA%A7%E9%94%81"></a>行级锁</h4>
<h5 id="-224"><a class="markdownIt-Anchor" href="#-224">#</a> <a href="#%E8%AE%B0%E5%BD%95%E9%94%81"></a>记录锁</h5>
<p>InnoDB 与 MyISAM 的最大不同有两点：一是支持事务；二是采用了行级锁，<strong>InnoDB 同时支持表锁和行锁</strong></p>
<p>行级锁，也成为记录锁（Record Lock），InnoDB 实现了以下两种类型的行锁：</p>
<ul>
<li>共享锁 (S)：又称为读锁，简称 S 锁，多个事务对于同一数据可以共享一把锁，都能访问到数据，但是只能读不能修改</li>
<li>排他锁 (X)：又称为写锁，简称 X 锁，不能与其他锁并存，如一个事务获取了一个数据行的排他锁，其他事务就不能再获取该行的其他锁，包括共享锁和排他锁，只有获取排他锁的事务是可以对数据读取和修改</li>
</ul>
<p>RR 隔离界别下，对于 UPDATE、DELETE 和 INSERT 语句，InnoDB 会<strong>自动给涉及数据集加排他锁</strong>（行锁），在 commit 的时候会自动释放（在事务中加的锁，会<strong>在事务中止或提交时自动释放</strong>）；对于普通 SELECT 语句，不会加任何锁（只是针对 InnoDB 层来说的，因为在 Server 层会加 MDL 读锁），通过 MVCC 防止冲突</p>
<p>锁的兼容性：</p>
<ul>
<li>共享锁和共享锁 兼容</li>
<li>共享锁和排他锁 冲突</li>
<li>排他锁和排他锁 冲突</li>
<li>排他锁和共享锁 冲突</li>
</ul>
<p>可以通过以下语句显式给数据集加共享锁或排他锁：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> table_name <span class="token keyword">WHERE</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">LOCK</span> <span class="token operator">IN</span> <span class="token keyword">SHARE</span> <span class="token keyword">MODE</span>	<span class="token comment">-- 共享锁</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> table_name <span class="token keyword">WHERE</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">FOR</span> <span class="token keyword">UPDATE</span>			<span class="token comment">-- 排他锁</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<hr>
<h5 id="-225"><a class="markdownIt-Anchor" href="#-225">#</a> <a href="#%E9%94%81%E6%93%8D%E4%BD%9C-1"></a>锁操作</h5>
<p>两个客户端操作 Client 1 和 Client 2，简化为 C1、C2</p>
<ul>
<li>
<p>环境准备</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> test_innodb_lock<span class="token punctuation">(</span>
	id <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	sex <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">INNODB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> test_innodb_lock <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'100'</span><span class="token punctuation">,</span><span class="token string">'1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- ..........</span>

<span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_test_innodb_lock_id <span class="token keyword">ON</span> test_innodb_lock<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_test_innodb_lock_name <span class="token keyword">ON</span> test_innodb_lock<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>关闭自动提交功能：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SET</span> AUTOCOMMIT<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">-- C1、C2</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>正常查询数据：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> test_innodb_lock<span class="token punctuation">;</span>	<span class="token comment">-- C1、C2</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>查询 id 为 3 的数据，正常查询：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> test_innodb_lock <span class="token keyword">WHERE</span> id<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span>	<span class="token comment">-- C1、C2</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>![](<a target="_blank" rel="noopener" href="https://gitee.com/seazean/images/raw/master/DB/MySQL-InnoDB">https://gitee.com/seazean/images/raw/master/DB/MySQL-InnoDB</a> 锁操作 1.png)</p>
</li>
<li>
<p>C1 更新 id 为 3 的数据，但不提交：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">UPDATE</span> test_innodb_lock <span class="token keyword">SET</span> name<span class="token operator">=</span><span class="token string">'300'</span> <span class="token keyword">WHERE</span> id<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span>	<span class="token comment">-- C1</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>![](<a target="_blank" rel="noopener" href="https://gitee.com/seazean/images/raw/master/DB/MySQL-InnoDB">https://gitee.com/seazean/images/raw/master/DB/MySQL-InnoDB</a> 锁操作 2.png)</p>
<p>C2 查询不到 C1 修改的数据，因为隔离界别为 REPEATABLE READ，C1 提交事务，C2 查询：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">COMMIT</span><span class="token punctuation">;</span>	<span class="token comment">-- C1</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>![](<a target="_blank" rel="noopener" href="https://gitee.com/seazean/images/raw/master/DB/MySQL-InnoDB">https://gitee.com/seazean/images/raw/master/DB/MySQL-InnoDB</a> 锁操作 3.png)</p>
<p>提交后仍然查询不到 C1 修改的数据，因为隔离级别可以防止脏读、不可重复读，所以 C2 需要提交才可以查询到其他事务对数据的修改：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">COMMIT</span><span class="token punctuation">;</span>	<span class="token comment">-- C2</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> test_innodb_lock <span class="token keyword">WHERE</span> id<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span>	<span class="token comment">-- C2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>![](<a target="_blank" rel="noopener" href="https://gitee.com/seazean/images/raw/master/DB/MySQL-InnoDB">https://gitee.com/seazean/images/raw/master/DB/MySQL-InnoDB</a> 锁操作 4.png)</p>
</li>
<li>
<p>C1 更新 id 为 3 的数据，但不提交，C2 也更新 id 为 3 的数据：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">UPDATE</span> test_innodb_lock <span class="token keyword">SET</span> name<span class="token operator">=</span><span class="token string">'3'</span> <span class="token keyword">WHERE</span> id<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span>	<span class="token comment">-- C1</span>
<span class="token keyword">UPDATE</span> test_innodb_lock <span class="token keyword">SET</span> name<span class="token operator">=</span><span class="token string">'30'</span> <span class="token keyword">WHERE</span> id<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span>	<span class="token comment">-- C2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>![](<a target="_blank" rel="noopener" href="https://gitee.com/seazean/images/raw/master/DB/MySQL-InnoDB">https://gitee.com/seazean/images/raw/master/DB/MySQL-InnoDB</a> 锁操作 5.png)</p>
<p>当 C1 提交，C2 直接解除阻塞，直接更新</p>
</li>
<li>
<p>操作不同行的数据：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">UPDATE</span> test_innodb_lock <span class="token keyword">SET</span> name<span class="token operator">=</span><span class="token string">'10'</span> <span class="token keyword">WHERE</span> id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">-- C1</span>
<span class="token keyword">UPDATE</span> test_innodb_lock <span class="token keyword">SET</span> name<span class="token operator">=</span><span class="token string">'30'</span> <span class="token keyword">WHERE</span> id<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span>	<span class="token comment">-- C2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>![](<a target="_blank" rel="noopener" href="https://gitee.com/seazean/images/raw/master/DB/MySQL-InnoDB">https://gitee.com/seazean/images/raw/master/DB/MySQL-InnoDB</a> 锁操作 6.png)</p>
<p>由于 C1、C2 操作的不同行，获取不同的行锁，所以都可以正常获取行锁</p>
</li>
</ul>
<hr>
<h4 id="-226"><a class="markdownIt-Anchor" href="#-226">#</a> <a href="#%E9%94%81%E5%88%86%E7%B1%BB"></a>锁分类</h4>
<h5 id="-227"><a class="markdownIt-Anchor" href="#-227">#</a> <a href="#%E9%97%B4%E9%9A%99%E9%94%81"></a>间隙锁</h5>
<p>当使用范围条件检索数据，并请求共享或排他锁时，InnoDB 会给符合条件的已有数据进行加锁，对于键值在条件范围内但并不存在的记录，叫做间隙（GAP）， InnoDB 会对间隙进行加锁，就是间隙锁</p>
<ul>
<li>唯一索引加锁只有在值存在时才是行锁，值不存在会变成间隙锁，所以范围查询时容易出现间隙锁</li>
<li>对于联合索引且是唯一索引，如果 where 条件只包括联合索引的一部分，那么会加间隙锁</li>
</ul>
<p>加锁的基本单位是 next-key lock，该锁是行锁和 gap lock 的组合，可以保护当前记录和前面的间隙</p>
<ul>
<li>加锁遵循左开右闭原则</li>
<li>假设有 10、11、13，那么可能的间隙锁包括：(负无穷，10]、(10,11]、(11,13]、(13,20, 正无穷)，锁住索引 11 会对 (10,11] 加锁</li>
</ul>
<p>间隙锁优点：RR 级别下间隙锁可以解决事务的一部分的<strong>幻读问题</strong>，通过对间隙加锁，可以防止读取过程中数据条目发生变化</p>
<p>间隙锁危害：当锁定一个范围的键值后，即使某些不存在的键值也会被无辜的锁定，造成在锁定的时候无法插入锁定键值范围内的任何数据，在某些场景下这可能会对性能造成很大的危害</p>
<ul>
<li>
<p>关闭自动提交功能：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SET</span> AUTOCOMMIT<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">-- C1、C2</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>查询数据表：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> test_innodb_lock<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>![](<a target="_blank" rel="noopener" href="https://gitee.com/seazean/images/raw/master/DB/MySQL-InnoDB">https://gitee.com/seazean/images/raw/master/DB/MySQL-InnoDB</a> 间隙锁 1.png)</p>
</li>
<li>
<p>C1 根据 id 范围更新数据，C2 插入数据：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">UPDATE</span> test_innodb_lock <span class="token keyword">SET</span> name<span class="token operator">=</span><span class="token string">'8888'</span> <span class="token keyword">WHERE</span> id <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span>	<span class="token comment">-- C1</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> test_innodb_lock <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'200'</span><span class="token punctuation">,</span><span class="token string">'2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">-- C2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>![](<a target="_blank" rel="noopener" href="https://gitee.com/seazean/images/raw/master/DB/MySQL-InnoDB">https://gitee.com/seazean/images/raw/master/DB/MySQL-InnoDB</a> 间隙锁 2.png)</p>
<p>出现间隙锁，C2 被阻塞，等待 C1 提交事务后才能更新</p>
</li>
</ul>
<hr>
<h5 id="-228"><a class="markdownIt-Anchor" href="#-228">#</a> <a href="#%E6%84%8F%E5%90%91%E9%94%81"></a>意向锁</h5>
<p>InnoDB 为了支持多粒度的加锁，允许行锁和表锁同时存在，支持在不同粒度上的加锁操作，InnoDB 增加了意向锁（Intention Lock）</p>
<p>意向锁是将锁定的对象分为多个层次，意向锁意味着事务希望在更细粒度上进行加锁，意向锁分为两种：</p>
<ul>
<li>意向共享锁（IS）：事务有意向对表中的某些行加共享锁</li>
<li>意向排他锁（IX）：事务有意向对表中的某些行加排他锁</li>
</ul>
<p><strong>IX，IS 是表级锁</strong>，不会和行级的 X，S 锁发生冲突，意向锁是在加表级锁之前添加，为了在加表级锁时可以快速判断表中是否有记录被上锁，比如向一个表添加表级 X 锁的时：</p>
<ul>
<li>没有意向锁，则需要遍历整个表判断是否有锁定的记录</li>
<li>有了意向锁，首先判断是否存在意向锁，然后判断该意向锁与即将添加的表级锁是否兼容即可，因为意向锁的存在代表有表级锁的存在或者即将有表级锁的存在</li>
</ul>
<p>兼容性如下所示：</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d2545362538342538462545352539302539312545392539342538312545352538352542432545352541452542392545362538302541372e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/f359a6faf987324481657da84bdb007210b7c7ffbb6dcf699b86c1ecb3abc2d6/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d2545362538342538462545352539302539312545392539342538312545352538352542432545352541452542392545362538302541372e706e67">https://camo.githubusercontent.com/f359a6faf987324481657da84bdb007210b7c7ffbb6dcf699b86c1ecb3abc2d6/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d2545362538342538462545352539302539312545392539342538312545352538352542432545352541452542392545362538302541372e706e67</a>)</p>
<p><strong>插入意向锁</strong> Insert Intention Lock 是在插入一行记录操作之前设置的一种间隙锁，是行级锁</p>
<p>插入意向锁释放了一种插入信号，即多个事务在相同的索引间隙插入时如果不是插入间隙中相同的位置就不需要互相等待。假设某列有索引值 2，6，只要两个事务插入位置不同，如事务 A 插入 3，事务 B 插入 4，那么就可以同时插入</p>
<hr>
<h5 id="-229"><a class="markdownIt-Anchor" href="#-229">#</a> <a href="#%E8%87%AA%E5%A2%9E%E9%94%81"></a>自增锁</h5>
<p>系统会自动给 AUTO_INCREMENT 修饰的列进行递增赋值，实现方式：</p>
<ul>
<li>AUTO_INC 锁：表级锁，执行插入语句时会自动添加，在该语句执行完成后释放，并不是事务结束</li>
<li>轻量级锁：为插入语句生成 AUTO_INCREMENT 修饰的列时获取该锁，生成以后释放掉，不需要等到插入语句执行完后释放</li>
</ul>
<p>系统变量  <code>innodb_autoinc_lock_mode</code>  控制采取哪种方式：</p>
<ul>
<li>0：全部采用 AUTO_INC 锁</li>
<li>1：全部采用轻量级锁</li>
<li>2：混合使用，在插入记录的数量确定是采用轻量级锁，不确定时采用 AUTO_INC 锁</li>
</ul>
<hr>
<h5 id="-230"><a class="markdownIt-Anchor" href="#-230">#</a> <a href="#%E9%9A%90%E5%BC%8F%E9%94%81"></a>隐式锁</h5>
<p>一般情况下 INSERT 语句是不需要在内存中生成锁结构的，会进行隐式的加锁，保护的是插入后的安全</p>
<p>注意：如果插入的间隙被其他事务加了间隙锁，此次插入会被阻塞，并在该间隙插入一个插入意向锁</p>
<ul>
<li>聚簇索引：索引记录有 trx_id 隐藏列，表示最后改动该记录的事务 id，插入数据后事务 id 就是当前事务。其他事务想获取该记录的锁时会判断当前记录的事务 id 是否是活跃的，如果不是就可以正常加锁；如果是就创建一个 X 的锁结构，该锁的 is_waiting 是 false，为自己的事务创建一个锁结构，is_waiting 是 true（类似 Java 中的锁升级）</li>
<li>二级索引：获取数据页 Page Header 中的 PAGE_MAX_TRX_ID 属性，代表修改当前页面的最大的事务 ID，如果小于当前活跃的最小事务 id，就证明插入该数据的事务已经提交，否则就需要获取到主键值进行回表操作</li>
</ul>
<p>隐式锁起到了延迟生成锁的效果，如果其他事务与隐式锁没有冲突，就可以避免锁结构的生成，节省了内存资源</p>
<p>INSERT 在两种情况下会生成锁结构：</p>
<ul>
<li>
<p>重复键：在插入主键或唯一二级索引时遇到重复的键值会报错，在报错前需要对对应的聚簇索引进行加锁</p>
<ul>
<li>隔离级别 &lt;= Read Uncommitted，加 S 型 Record Lock</li>
<li>隔离级别 &gt;= Repeatable Read，加 S 型 next_key 锁</li>
</ul>
</li>
<li>
<p>外键检查：如果待插入的记录在父表中可以找到，会对父表的记录加 S 型 Record Lock。如果待插入的记录在父表中找不到</p>
<ul>
<li>隔离级别 &lt;= Read Committed，不加锁</li>
<li>隔离级别 &gt;= Repeatable Read，加间隙锁</li>
</ul>
</li>
</ul>
<hr>
<h4 id="-231"><a class="markdownIt-Anchor" href="#-231">#</a> <a href="#%E9%94%81%E4%BC%98%E5%8C%96"></a>锁优化</h4>
<h5 id="-232"><a class="markdownIt-Anchor" href="#-232">#</a> <a href="#%E4%BC%98%E5%8C%96%E9%94%81"></a>优化锁</h5>
<p>InnoDB 存储引擎实现了行级锁定，虽然在锁定机制的实现方面带来了性能损耗可能比表锁会更高，但是在整体并发处理能力方面要远远优于 MyISAM 的表锁，当系统并发量较高的时候，InnoDB 的整体性能远远好于 MyISAM</p>
<p>但是使用不当可能会让 InnoDB 的整体性能表现不仅不能比 MyISAM 高，甚至可能会更差</p>
<p>优化建议：</p>
<ul>
<li>尽可能让所有数据检索都能通过索引来完成，避免无索引行锁升级为表锁</li>
<li>合理设计索引，尽量缩小锁的范围</li>
<li>尽可能减少索引条件及索引范围，避免间隙锁</li>
<li>尽量控制事务大小，减少锁定资源量和时间长度</li>
<li>尽可使用低级别事务隔离（需要业务层面满足需求）</li>
</ul>
<hr>
<h5 id="-233"><a class="markdownIt-Anchor" href="#-233">#</a> <a href="#%E9%94%81%E5%8D%87%E7%BA%A7"></a>锁升级</h5>
<p>索引失效造成行锁升级为表锁，不通过索引检索数据，InnoDB 会将对表中的所有记录加锁，实际效果和<strong>表锁</strong>一样实际开发过程应避免出现索引失效的状况</p>
<ul>
<li>
<p>查看当前表的索引：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SHOW</span> <span class="token keyword">INDEX</span> <span class="token keyword">FROM</span> test_innodb_lock<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>关闭自动提交功能：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SET</span> AUTOCOMMIT<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">-- C1、C2</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>执行更新语句：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">UPDATE</span> test_innodb_lock <span class="token keyword">SET</span> sex<span class="token operator">=</span><span class="token string">'2'</span> <span class="token keyword">WHERE</span> name<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">;</span>	<span class="token comment">-- C1</span>
<span class="token keyword">UPDATE</span> test_innodb_lock <span class="token keyword">SET</span> sex<span class="token operator">=</span><span class="token string">'2'</span> <span class="token keyword">WHERE</span> id<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span>		<span class="token comment">-- C2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>![](<a target="_blank" rel="noopener" href="https://gitee.com/seazean/images/raw/master/DB/MySQL-InnoDB">https://gitee.com/seazean/images/raw/master/DB/MySQL-InnoDB</a> 锁升级.png)</p>
<p>索引失效：执行更新时 name 字段为 varchar 类型，造成索引失效，最终行锁变为表锁</p>
</li>
</ul>
<hr>
<h5 id="-234"><a class="markdownIt-Anchor" href="#-234">#</a> <a href="#%E6%AD%BB%E9%94%81"></a>死锁</h5>
<p>不同事务由于互相持有对方需要的锁而导致事务都无法继续执行的情况称为死锁</p>
<p>死锁情况：线程 A 修改了 id = 1 的数据，请求修改 id = 2 的数据，线程 B 修改了 id = 2 的数据，请求修改 id = 1 的数据，产生死锁</p>
<p>解决策略：</p>
<ul>
<li>直接进入等待直到超时，超时时间可以通过参数 innodb_lock_wait_timeout 来设置，但是时间的设置不好控制，超时可能不是因为死锁，而是因为事务处理比较慢，所以一般不采取该方式</li>
<li>主动死锁检测，发现死锁后<strong>主动回滚死锁链条中较小的一个事务</strong>，让其他事务得以继续执行，将参数  <code>innodb_deadlock_detect</code>  设置为 on，表示开启该功能。较小的意思就是事务执行过程中插入、删除、更新的记录条数</li>
</ul>
<p>通过执行  <code>SHOW ENGINE INNODB STATUS</code>  可以查看最近发生的一次死循环，全局系统变量  <code>innodb_print_all_deadlocks</code>  设置为 on，就可以将每个死锁信息都记录在 MySQL 错误日志中</p>
<p>死锁一般是行级锁，当表锁发生死锁时，会在事务中访问其他表时直接报错，破坏了持有并等待的死锁条件</p>
<hr>
<h4 id="-235"><a class="markdownIt-Anchor" href="#-235">#</a> <a href="#%E9%94%81%E7%8A%B6%E6%80%81-1"></a>锁状态</h4>
<p>查看锁信息</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SHOW</span> <span class="token keyword">STATUS</span> <span class="token operator">LIKE</span> <span class="token string">'innodb_row_lock%'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d496e6e6f444220e99481e4ba89e794a82e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/fac757a0baa2d1df016999eff66e5ffde88669aef6bc4f3ffa85e05f759f48da/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d496e6e6f444220e99481e4ba89e794a82e706e67">https://camo.githubusercontent.com/fac757a0baa2d1df016999eff66e5ffde88669aef6bc4f3ffa85e05f759f48da/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d496e6e6f444220e99481e4ba89e794a82e706e67</a>)</p>
<p>参数说明：</p>
<ul>
<li>
<p>Innodb_row_lock_current_waits：当前正在等待锁定的数量</p>
</li>
<li>
<p>Innodb_row_lock_time：从系统启动到现在锁定总时间长度</p>
</li>
<li>
<p>Innodb_row_lock_time_avg：每次等待所花平均时长</p>
</li>
<li>
<p>Innodb_row_lock_time_max：从系统启动到现在等待最长的一次所花的时间</p>
</li>
<li>
<p>Innodb_row_lock_waits：系统启动后到现在总共等待的次数</p>
</li>
</ul>
<p>当等待的次数很高，而且每次等待的时长也不短的时候，就需要分析系统中为什么会有如此多的等待，然后根据分析结果制定优化计划</p>
<p>查看锁状态：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> information_schema<span class="token punctuation">.</span>innodb_locks<span class="token punctuation">;</span>	<span class="token comment">#锁的概况</span>
<span class="token keyword">SHOW</span> <span class="token keyword">ENGINE</span> <span class="token keyword">INNODB</span> <span class="token keyword">STATUS</span>\G<span class="token punctuation">;</span> <span class="token comment">#InnoDB整体状态，其中包括锁的情况</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/32fdb634ee71221cdc08c67712b52e0cf515d307abf8df35aa5e0d88a8a88982/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d496e6e6f44422545362539462541352545372539432538422545392539342538312545372538412542362545362538302538312e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/32fdb634ee71221cdc08c67712b52e0cf515d307abf8df35aa5e0d88a8a88982/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d496e6e6f44422545362539462541352545372539432538422545392539342538312545372538412542362545362538302538312e706e67">https://camo.githubusercontent.com/32fdb634ee71221cdc08c67712b52e0cf515d307abf8df35aa5e0d88a8a88982/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d496e6e6f44422545362539462541352545372539432538422545392539342538312545372538412542362545362538302538312e706e67</a>)</p>
<p>lock_id 是锁 id；lock_trx_id 为事务 id；lock_mode 为 X 代表排它锁（写锁）；lock_type 为 RECORD 代表锁为行锁（记录锁）</p>
<hr>
<h3 id="-236"><a class="markdownIt-Anchor" href="#-236">#</a> <a href="#%E4%B9%90%E8%A7%82%E9%94%81"></a>乐观锁</h3>
<p>悲观锁：在整个数据处理过程中，将数据处于锁定状态，为了保证事务的隔离性，就需要一致性锁定读。读取数据时给加锁，其它事务无法修改这些数据，修改删除数据时也加锁，其它事务同样无法读取这些数据</p>
<p>悲观锁和乐观锁使用前提：</p>
<ul>
<li>对于读的操作远多于写的操作的时候，一个更新操作加锁会阻塞所有的读取操作，降低了吞吐量，最后需要释放锁，锁是需要一些开销的，这时候可以选择乐观锁</li>
<li>如果是读写比例差距不是非常大或者系统没有响应不及时，吞吐量瓶颈的问题，那就不要去使用乐观锁，它增加了复杂度，也带来了业务额外的风险，这时候可以选择悲观锁</li>
</ul>
<p>乐观锁的现方式：</p>
<ul>
<li>
<p>版本号</p>
<ol>
<li>
<p>给数据表中添加一个 version 列，每次更新后都将这个列的值加 1</p>
</li>
<li>
<p>读取数据时，将版本号读取出来，在执行更新的时候，比较版本号</p>
</li>
<li>
<p>如果相同则执行更新，如果不相同，说明此条数据已经发生了变化</p>
</li>
<li>
<p>用户自行根据这个通知来决定怎么处理，比如重新开始一遍，或者放弃本次更新</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 创建city表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> city<span class="token punctuation">(</span>
	id <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>  <span class="token comment">-- 城市id</span>
	NAME <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                   <span class="token comment">-- 城市名称</span>
	VERSION <span class="token keyword">INT</span>                         <span class="token comment">-- 版本号</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 添加数据</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> city <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'北京'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'上海'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'广州'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'深圳'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 修改北京为北京市</span>
<span class="token comment">-- 1.查询北京的version</span>
<span class="token keyword">SELECT</span> VERSION <span class="token keyword">FROM</span> city <span class="token keyword">WHERE</span> NAME<span class="token operator">=</span><span class="token string">'北京'</span><span class="token punctuation">;</span>
<span class="token comment">-- 2.修改北京为北京市，版本号+1。并对比版本号</span>
<span class="token keyword">UPDATE</span> city <span class="token keyword">SET</span> NAME<span class="token operator">=</span><span class="token string">'北京市'</span><span class="token punctuation">,</span>VERSION<span class="token operator">=</span>VERSION<span class="token operator">+</span><span class="token number">1</span> <span class="token keyword">WHERE</span> NAME<span class="token operator">=</span><span class="token string">'北京'</span> <span class="token operator">AND</span> VERSION<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ol>
</li>
<li>
<p>时间戳</p>
<ul>
<li>和版本号方式基本一样，给数据表中添加一个列，名称无所谓，数据类型需要是 <strong>timestamp</strong></li>
<li>每次更新后都将最新时间插入到此列</li>
<li>读取数据时，将时间读取出来，在执行更新的时候，比较时间</li>
<li>如果相同则执行更新，如果不相同，说明此条数据已经发生了变化</li>
</ul>
</li>
</ul>
<hr>
<h2 id="-237"><a class="markdownIt-Anchor" href="#-237">#</a> <a href="#%E4%B8%BB%E4%BB%8E"></a>主从</h2>
<h3 id="-238"><a class="markdownIt-Anchor" href="#-238">#</a> <a href="#%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D-7"></a>基本介绍</h3>
<p>复制是指将主数据库的 DDL 和 DML 操作通过二进制日志传到从库服务器中，然后在从库上对这些日志重新执行（也叫重做），从而使得从库和主库的数据保持同步</p>
<p>MySQL 支持一台主库同时向多台从库进行复制，从库同时也可以作为其他从服务器的主库，实现链状复制</p>
<p>MySQL 复制的优点主要包含以下三个方面：</p>
<ul>
<li>
<p>主库出现问题，可以快速切换到从库提供服务</p>
</li>
<li>
<p>可以在从库上执行查询操作，从主库中更新，实现读写分离</p>
</li>
<li>
<p>可以在从库中执行备份，以避免备份期间影响主库的服务</p>
</li>
</ul>
<hr>
<h3 id="-239"><a class="markdownIt-Anchor" href="#-239">#</a> <a href="#%E5%A4%8D%E5%88%B6%E5%8E%9F%E7%90%86"></a>复制原理</h3>
<h4 id="-240"><a class="markdownIt-Anchor" href="#-240">#</a> <a href="#%E4%B8%BB%E4%BB%8E%E7%BB%93%E6%9E%84"></a>主从结构</h4>
<p>MySQL 的主从之间维持了一个长连接。主库内部有一个线程，专门用于服务从库的长连接，连接过程：</p>
<ul>
<li>从库执行 change master 命令，设置主库的 IP、端口、用户名、密码以及要从哪个位置开始请求 binlog，这个位置包含文件名和日志偏移量</li>
<li>从库执行 start slave 命令，这时从库会启动两个线程，就是图中的 io_thread 和 sql_thread，其中 io_thread 负责与主库建立连接</li>
<li>主库校验完用户名、密码后，开始按照从传过来的位置，从本地读取 binlog 发给从库，开始主从复制</li>
</ul>
<p>主从复制原理图：</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d2545342542382542422545342542422538452545352541342538442545352538382542362545352538452539462545372539302538362545352539422542452e6a7067" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/aa107b4dd020262f0bd10837bccffc6b577f5bfc61b5c93eb24100b0788b7b58/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d2545342542382542422545342542422538452545352541342538442545352538382542362545352538452539462545372539302538362545352539422542452e6a7067">https://camo.githubusercontent.com/aa107b4dd020262f0bd10837bccffc6b577f5bfc61b5c93eb24100b0788b7b58/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d2545342542382542422545342542422538452545352541342538442545352538382542362545352538452539462545372539302538362545352539422542452e6a7067</a>)</p>
<p>主从复制主要依赖的是 binlog，MySQL 默认是异步复制，需要三个线程：</p>
<ul>
<li>binlog dump thread：在主库事务提交时，负责把数据变更记录在二进制日志文件 binlog 中，并通知 slave 有数据更新</li>
<li>I/O thread：负责从主服务器上拉取二进制日志，并将 binlog 日志内容依次写到 relay log 中转日志的最末端，并将新的 binlog 文件名和 offset 记录到 master-info 文件中，以便下一次读取日志时从指定 binlog 日志文件及位置开始读取新的 binlog 日志内容</li>
<li>SQL thread：监测本地 relay log 中新增了日志内容，读取中继日志并重做其中的 SQL 语句，从库在 <a target="_blank" rel="noopener" href="http://relay-log.info">relay-log.info</a> 中记录当前应用中继日志的文件名和位置点以便下一次执行</li>
</ul>
<p>同步与异步：</p>
<ul>
<li>异步复制有数据丢失风险，例如数据还未同步到从库，主库就给客户端响应，然后主库挂了，此时从库晋升为主库的话数据是缺失的</li>
<li>同步复制，主库需要将 binlog 复制到所有从库，等所有从库响应了之后主库才进行其他逻辑，这样的话性能很差，一般不会选择</li>
<li>MySQL 5.7 之出现了半同步复制，有参数可以选择成功同步几个从库就返回响应</li>
</ul>
<hr>
<h4 id="-241"><a class="markdownIt-Anchor" href="#-241">#</a> <a href="#%E4%B8%BB%E4%B8%BB%E7%BB%93%E6%9E%84"></a>主主结构</h4>
<p>主主结构就是两个数据库之间总是互为主从关系，这样在切换的时候就不用再修改主从关系</p>
<p>循环复制：在库 A 上更新了一条语句，然后把生成的 binlog 发给库 B，库 B 执行完这条更新语句后也会生成 binlog，会再发给 A</p>
<p>解决方法：</p>
<ul>
<li>两个库的 server id 必须不同，如果相同则它们之间不能设定为主主关系</li>
<li>一个库接到 binlog 并在重放的过程中，生成与原 binlog 的 server id 相同的新的 binlog</li>
<li>每个库在收到从主库发过来的日志后，先判断 server id，如果跟自己的相同，表示这个日志是自己生成的，就直接丢弃这个日志</li>
</ul>
<hr>
<h3 id="-242"><a class="markdownIt-Anchor" href="#-242">#</a> <a href="#%E4%B8%BB%E4%BB%8E%E5%BB%B6%E8%BF%9F"></a>主从延迟</h3>
<h4 id="-243"><a class="markdownIt-Anchor" href="#-243">#</a> <a href="#%E5%BB%B6%E8%BF%9F%E5%8E%9F%E5%9B%A0"></a>延迟原因</h4>
<p>正常情况主库执行更新生成的所有 binlog，都可以传到从库并被正确地执行，从库就能达到跟主库一致的状态，这就是最终一致性</p>
<p>主从延迟是主从之间是存在一定时间的数据不一致，就是同一个事务在从库执行完成的时间和主库执行完成的时间的差值，即 T2-T1</p>
<ul>
<li>主库 A 执行完成一个事务，写入 binlog，该时刻记为 T1</li>
<li>日志传给从库 B，从库 B 执行完这个事务，该时刻记为 T2</li>
</ul>
<p>通过在从库执行  <code>show slave status</code>  命令，返回结果会显示 seconds_behind_master 表示当前从库延迟了多少秒</p>
<ul>
<li>每一个事务的 binlog 都有一个时间字段，用于记录主库上<strong>写入</strong>的时间</li>
<li>从库取出当前正在<strong>执行</strong>的事务的时间字段，跟系统的时间进行相减，得到的就是 seconds_behind_master</li>
</ul>
<p>主从延迟的原因：</p>
<ul>
<li>从库的查询压力大</li>
<li>大事务的执行，主库必须要等到事务完成之后才会写入 binlog，导致从节点出现应用 binlog 延迟</li>
<li>主库的 DDL，从库与主库的 DDL 同步是串行进行，DDL 在主库执行时间很长，那么从库也会消耗同样的时间</li>
<li>锁冲突问题也可能导致从节点的 SQL 线程执行慢</li>
<li>从库的机器性能比主库的差，导致从库的复制能力弱</li>
</ul>
<p>主从同步问题永远都是<strong>一致性和性能的权衡</strong>，需要根据实际的应用场景，可以采取下面的办法：</p>
<ul>
<li>
<p>优化 SQL，避免慢 SQL，减少批量操作</p>
</li>
<li>
<p>降低多线程大事务并发的概率，优化业务逻辑</p>
</li>
<li>
<p>业务中大多数情况查询操作要比更新操作更多，搭建一主多从结构，让这些从库来分担读的压力</p>
</li>
<li>
<p>尽量采用短的链路，主库和从库服务器的距离尽量要短，提升端口带宽，减少 binlog 传输的网络延时</p>
</li>
<li>
<p>实时性要求高的业务读强制走主库，从库只做备份</p>
</li>
</ul>
<hr>
<h4 id="-244"><a class="markdownIt-Anchor" href="#-244">#</a> <a href="#%E5%B9%B6%E8%A1%8C%E5%A4%8D%E5%88%B6"></a>并行复制</h4>
<h5 id="-245"><a class="markdownIt-Anchor" href="#-245">#</a> <a href="#mysql56"></a>MySQL5.6</h5>
<p>高并发情况下，主库的会产生大量的 binlog，在从库中有两个线程 IO Thread 和 SQL Thread 单线程执行，会导致主库延迟变大。为了改善复制延迟问题，MySQL 5.6 版本增加了并行复制功能，以采用多线程机制来促进执行</p>
<p>coordinator 就是原来的 sql_thread，并行复制中它不再直接更新数据，只<strong>负责读取中转日志和分发事务</strong>：</p>
<ul>
<li>线程分配完成并不是立即执行，为了防止造成更新覆盖，更新同一 DB 的两个事务必须被分发到同一个工作线程</li>
<li>同一个事务不能被拆开，必须放到同一个工作线程</li>
</ul>
<p>MySQL 5.6 版本的策略：每个线程对应一个 hash 表，用于保存当前这个线程的执行队列里的事务所涉及的表，hash 表的 key 是数据库 名，value 是一个数字，表示队列中有多少个事务修改这个库，适用于主库上有多个 DB 的情况</p>
<p>每个事务在分发的时候，跟线程的冲突（事务操作的是同一个 DB）关系包括以下三种情况：</p>
<ul>
<li>如果跟所有线程都不冲突，coordinator 线程就会把这个事务分配给最空闲的线程</li>
<li>如果只跟一个线程冲突，coordinator 线程就会把这个事务分配给这个存在冲突关系的线程</li>
<li>如果跟多于一个线程冲突，coordinator 线程就进入等待状态，直到和这个事务存在冲突关系的线程只剩下 1 个</li>
</ul>
<p>优缺点：</p>
<ul>
<li>构造 hash 值的时候很快，只需要库名，而且一个实例上 DB 数也不会很多，不会出现需要构造很多个项的情况</li>
<li>不要求 binlog 的格式，statement 格式的 binlog 也可以很容易拿到库名（日志章节详解了 binlog）</li>
<li>主库上的表都放在同一个 DB 里面，这个策略就没有效果了；或者不同 DB 的热点不同，比如一个是业务逻辑库，一个是系统配置库，那也起不到并行的效果，需要<strong>把相同热度的表均匀分到这些不同的 DB 中</strong>，才可以使用这个策略</li>
</ul>
<hr>
<h5 id="-246"><a class="markdownIt-Anchor" href="#-246">#</a> <a href="#mysql57"></a>MySQL5.7</h5>
<p>MySQL 5.7 并行复制策略的思想是：</p>
<ul>
<li>所有处于 commit 状态的事务可以并行执行</li>
<li>同时处于 prepare 状态的事务，在从库执行时是可以并行的</li>
<li>处于 prepare 状态的事务，与处于 commit 状态的事务之间，在从库执行时也是可以并行的</li>
</ul>
<p>MySQL 5.7 由参数 slave-parallel-type 来控制并行复制策略：</p>
<ul>
<li>配置为 DATABASE，表示使用 MySQL 5.6 版本的<strong>按库（DB）并行策略</strong></li>
<li>配置为 LOGICAL_CLOCK，表示的<strong>按提交状态并行</strong>执行</li>
</ul>
<p>MySQL 5.7.22 版本里，MySQL 增加了一个新的并行复制策略，基于 WRITESET 的并行复制。新增了一个参数 binlog-transaction-dependency-tracking，用来控制是否启用这个新策略：</p>
<ul>
<li>
<p>COMMIT_ORDER：表示根据同时进入 prepare 和 commit 来判断是否可以并行的策略</p>
</li>
<li>
<p>WRITESET：表示的是对于每个事务涉及更新的每一行，计算出这一行的 hash 值，组成该事务的 writeset 集合，如果两个事务没有操作相同的行，也就是说它们的 writeset 没有交集，就可以并行（<strong>按行并行</strong>）</p>
</li>
<li>
<p>WRITESET_SESSION：是在 WRITESET 的基础上多了一个约束，即在主库上同一个线程先后执行的两个事务，在备库执行的时候，要保证相同的先后顺序</p>
<p>为了唯一标识，这个 hash 表的值是通过  <code>库名 + 表名 + 索引名 + 值</code> （表示的是某一行）计算出来的</p>
</li>
</ul>
<p>MySQL 5.7.22 按行并发的优势：</p>
<ul>
<li>writeset 是在主库生成后直接写入到 binlog 里面的，这样在备库执行的时候，不需要解析 binlog 内容，节省了计算量</li>
<li>不需要把整个事务的 binlog 都扫一遍才能决定分发到哪个线程，更省内存</li>
<li>从库的分发策略不依赖于 binlog 内容，所以 binlog 是 statement 格式也可以，更节约内存（因为 row 才记录更改的行）</li>
</ul>
<p>MySQL 5.7.22 的并行复制策略在通用性上是有保证的，但是对于表上没主键、唯一和外键约束的场景，WRITESET 策略也是没法并行的，也会暂时退化为单线程模型</p>
<p>参考文章：<a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/77083">https://time.geekbang.org/column/article/77083</a></p>
<hr>
<h4 id="-247"><a class="markdownIt-Anchor" href="#-247">#</a> <a href="#%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB"></a>读写分离</h4>
<p>读写分离：可以降低主库的访问压力，提高系统的并发能力</p>
<ul>
<li>主库不建查询的索引，从库建查询的索引。因为索引需要维护的，比如插入一条数据，不仅要在聚簇索引上面插入，对应的二级索引也得插入</li>
<li>将读操作分到从库了之后，可以在主库把查询要用的索引删了，减少写操作对主库的影响</li>
</ul>
<p>读写分离产生了读写延迟，造成数据的不一致性。假如客户端执行完一个更新事务后马上发起查询，如果查询选择的是从库的话，可能读到的还是以前的数据，叫过期读</p>
<p>解决方案：</p>
<ul>
<li>
<p>强制将写之后<strong>立刻读的操作转移到主库</strong>，比如刚注册的用户，直接登录从库查询可能查询不到，先走主库登录</p>
</li>
<li>
<p><strong>二次查询</strong>，如果从库查不到数据，则再去主库查一遍，由 API 封装，比较简单，但导致主库压力大</p>
</li>
<li>
<p>更新主库后，读从库之前先 sleep 一下，类似于执行一条  <code>select sleep(1)</code>  命令</p>
</li>
<li>
<p>确保主备无延迟的方法，每次从库执行查询请求前，先判断 seconds_behind_master 是否已经等于 0，如果不等于那就等到这个参数变为 0 才能执行查询请求</p>
</li>
</ul>
<hr>
<h3 id="-248"><a class="markdownIt-Anchor" href="#-248">#</a> <a href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"></a>负载均衡</h3>
<p>负载均衡是应用中使用非常普遍的一种优化方法，机制就是利用某种均衡算法，将固定的负载量分布到不同的服务器上，以此来降低单台服务器的负载，达到优化的效果</p>
<ul>
<li>
<p>分流查询：通过 MySQL 的主从复制，实现读写分离，使增删改操作走主节点，查询操作走从节点，从而可以降低单台服务器的读写压力</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/08eb90f9a129ecbf0ed814460f9ccc77bd82cdcece9732b3eab9ae2123abebd6/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d2545382542342539462545382542442542442545352539442538372545382541312541312545342542382542422545342542422538452545352541342538442545352538382542362e6a7067" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/08eb90f9a129ecbf0ed814460f9ccc77bd82cdcece9732b3eab9ae2123abebd6/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d2545382542342539462545382542442542442545352539442538372545382541312541312545342542382542422545342542422538452545352541342538442545352538382542362e6a7067">https://camo.githubusercontent.com/08eb90f9a129ecbf0ed814460f9ccc77bd82cdcece9732b3eab9ae2123abebd6/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d2545382542342539462545382542442542442545352539442538372545382541312541312545342542382542422545342542422538452545352541342538442545352538382542362e6a7067</a>)</p>
</li>
<li>
<p>分布式数据库架构：适合大数据量、负载高的情况，具有良好的拓展性和高可用性。通过在多台服务器之间分布数据，可以实现在多台服务器之间的负载均衡，提高访问效率</p>
</li>
</ul>
<hr>
<h3 id="-249"><a class="markdownIt-Anchor" href="#-249">#</a> <a href="#%E4%B8%BB%E4%BB%8E%E6%90%AD%E5%BB%BA"></a>主从搭建</h3>
<h4 id="-250"><a class="markdownIt-Anchor" href="#-250">#</a> <a href="#%E6%90%AD%E5%BB%BA%E6%B5%81%E7%A8%8B"></a>搭建流程</h4>
<h5 id="-251"><a class="markdownIt-Anchor" href="#-251">#</a> <a href="#master"></a>master</h5>
<ol>
<li>
<p>在 master 的配置文件（/etc/mysql/my.cnf）中，配置如下内容：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token comment">#mysql 服务ID,保证整个集群环境中唯一</span>
server-id<span class="token operator">=</span><span class="token number">1</span>

<span class="token comment">#mysql binlog 日志的存储路径和文件名</span>
log-bin<span class="token operator">=</span>/var/lib/mysql/mysqlbin

<span class="token comment">#错误日志,默认已经开启</span>
<span class="token comment">#log-err</span>

<span class="token comment">#mysql的安装目录</span>
<span class="token comment">#basedir</span>

<span class="token comment">#mysql的临时目录</span>
<span class="token comment">#tmpdir</span>

<span class="token comment">#mysql的数据存放目录</span>
<span class="token comment">#datadir</span>

<span class="token comment">#是否只读,1 代表只读, 0 代表读写</span>
read-only<span class="token operator">=</span><span class="token number">0</span>

<span class="token comment">#忽略的数据, 指不需要同步的数据库</span>
binlog-ignore-db<span class="token operator">=</span>mysql

<span class="token comment">#指定同步的数据库</span>
<span class="token comment">#binlog-do-db=db01</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>执行完毕之后，需要重启 MySQL</p>
</li>
<li>
<p>创建同步数据的账户，并且进行授权操作：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">GRANT</span> <span class="token keyword">REPLICATION</span> SLAVE <span class="token keyword">ON</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">TO</span> <span class="token string">'seazean'</span><span class="token variable">@'192.168.0.137'</span> IDENTIFIED <span class="token keyword">BY</span> <span class="token string">'123456'</span><span class="token punctuation">;</span>
FLUSH <span class="token keyword">PRIVILEGES</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li>
<p>查看 master 状态：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SHOW</span> MASTER <span class="token keyword">STATUS</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/af58ae3fbaeec302c1a906c8c3916a5041904de8e3a7a3f3a9369bed4e5b19a8/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d2545362539462541352545372539432538426d61737465722545372538412542362545362538302538312e6a7067" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/af58ae3fbaeec302c1a906c8c3916a5041904de8e3a7a3f3a9369bed4e5b19a8/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d2545362539462541352545372539432538426d61737465722545372538412542362545362538302538312e6a7067">https://camo.githubusercontent.com/af58ae3fbaeec302c1a906c8c3916a5041904de8e3a7a3f3a9369bed4e5b19a8/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d2545362539462541352545372539432538426d61737465722545372538412542362545362538302538312e6a7067</a>)</p>
<ul>
<li>File：从哪个日志文件开始推送日志文件</li>
<li>Position：从哪个位置开始推送日志</li>
<li>Binlog_Ignore_DB：指定不需要同步的数据库</li>
</ul>
</li>
</ol>
<hr>
<h5 id="-252"><a class="markdownIt-Anchor" href="#-252">#</a> <a href="#slave"></a>slave</h5>
<ol>
<li>
<p>在 slave 端配置文件中，配置如下内容：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token comment">#mysql服务端ID,唯一</span>
server-id<span class="token operator">=</span><span class="token number">2</span>

<span class="token comment">#指定binlog日志</span>
log-bin<span class="token operator">=</span>/var/lib/mysql/mysqlbin<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>执行完毕之后，需要重启 MySQL</p>
</li>
<li>
<p>指定当前从库对应的主库的 IP 地址、用户名、密码，从哪个日志文件开始的那个位置开始同步推送日志</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">CHANGE MASTER <span class="token keyword">TO</span> MASTER_HOST<span class="token operator">=</span> <span class="token string">'192.168.0.138'</span><span class="token punctuation">,</span> MASTER_USER<span class="token operator">=</span><span class="token string">'seazean'</span><span class="token punctuation">,</span> MASTER_PASSWORD<span class="token operator">=</span><span class="token string">'seazean'</span><span class="token punctuation">,</span> MASTER_LOG_FILE<span class="token operator">=</span><span class="token string">'mysqlbin.000001'</span><span class="token punctuation">,</span> MASTER_LOG_POS<span class="token operator">=</span><span class="token number">413</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>开启同步操作：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">START</span> SLAVE<span class="token punctuation">;</span>
<span class="token keyword">SHOW</span> SLAVE <span class="token keyword">STATUS</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li>
<p>停止同步操作：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">STOP SLAVE<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ol>
<hr>
<h5 id="-253"><a class="markdownIt-Anchor" href="#-253">#</a> <a href="#%E9%AA%8C%E8%AF%81"></a>验证</h5>
<ol>
<li>
<p>在主库中创建数据库，创建表并插入数据：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> db01<span class="token punctuation">;</span>
<span class="token keyword">USE</span> db01<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">user</span><span class="token punctuation">(</span>
	id <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
	name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
	sex <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">INNODB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token keyword">user</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span>NAME<span class="token punctuation">,</span>sex<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'Tom'</span><span class="token punctuation">,</span><span class="token string">'1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token keyword">user</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span>NAME<span class="token punctuation">,</span>sex<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'Trigger'</span><span class="token punctuation">,</span><span class="token string">'0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token keyword">user</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span>NAME<span class="token punctuation">,</span>sex<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'Dawn'</span><span class="token punctuation">,</span><span class="token string">'1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>在从库中查询数据，进行验证：</p>
<p>在从库中，可以查看到刚才创建的数据库：</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/46f7c7ef7a3122a225f7eeb36862feb318221b17d2fcc77b043012fbcb1332ee/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d254534254238254242254534254242253845254535254134253844254535253838254236254539254141253843254538254146253831312e6a7067" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/46f7c7ef7a3122a225f7eeb36862feb318221b17d2fcc77b043012fbcb1332ee/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d254534254238254242254534254242253845254535254134253844254535253838254236254539254141253843254538254146253831312e6a7067">https://camo.githubusercontent.com/46f7c7ef7a3122a225f7eeb36862feb318221b17d2fcc77b043012fbcb1332ee/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d254534254238254242254534254242253845254535254134253844254535253838254236254539254141253843254538254146253831312e6a7067</a>)</p>
<p>在该数据库中，查询表中的数据：</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d254534254238254242254534254242253845254535254134253844254535253838254236254539254141253843254538254146253831322e6a7067" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/36fbe629173bf93fed421a2f03944aea0731d5a4f70f11e5489477549e8ea67e/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d254534254238254242254534254242253845254535254134253844254535253838254236254539254141253843254538254146253831322e6a7067">https://camo.githubusercontent.com/36fbe629173bf93fed421a2f03944aea0731d5a4f70f11e5489477549e8ea67e/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d254534254238254242254534254242253845254535254134253844254535253838254236254539254141253843254538254146253831322e6a7067</a>)</p>
</li>
</ol>
<hr>
<h4 id="-254"><a class="markdownIt-Anchor" href="#-254">#</a> <a href="#%E4%B8%BB%E4%BB%8E%E5%88%87%E6%8D%A2"></a>主从切换</h4>
<p>正常切换步骤：</p>
<ul>
<li>
<p>在开始切换之前先对主库进行锁表  <code>flush tables with read lock</code> ，然后等待所有语句执行完成，切换完成后可以释放锁</p>
</li>
<li>
<p>检查 slave 同步状态，在 slave 执行  <code>show processlist</code></p>
</li>
<li>
<p>停止 slave io 线程，执行命令  <code>STOP SLAVE IO_THREAD</code></p>
</li>
<li>
<p>提升 slave 为 master</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">Stop slave<span class="token punctuation">;</span>
Reset master<span class="token punctuation">;</span>
Reset slave <span class="token keyword">all</span><span class="token punctuation">;</span>
<span class="token keyword">set</span> <span class="token keyword">global</span> read_only<span class="token operator">=</span><span class="token keyword">off</span><span class="token punctuation">;</span>	<span class="token comment">-- 设置为可更新状态</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>将原来 master 变为 slave（参考搭建流程中的 slave 方法）</p>
</li>
</ul>
<p>主库发生故障，从库会进行上位，其他从库指向新的主库</p>
<hr>
<h2 id="-255"><a class="markdownIt-Anchor" href="#-255">#</a> <a href="#%E6%97%A5%E5%BF%97"></a>日志</h2>
<h3 id="-256"><a class="markdownIt-Anchor" href="#-256">#</a> <a href="#%E6%97%A5%E5%BF%97%E5%88%86%E7%B1%BB"></a>日志分类</h3>
<p>在任何一种数据库中，都会有各种各样的日志，记录着数据库工作的过程，可以帮助数据库管理员追踪数据库曾经发生过的各种事件。</p>
<p>MySQL 日志主要包括六种：</p>
<ol>
<li>重做日志（redo log）</li>
<li>回滚日志（undo log）</li>
<li>归档日志（binlog）（二进制日志）</li>
<li>错误日志（errorlog）</li>
<li>慢查询日志（slow query log）</li>
<li>一般查询日志（general log）</li>
<li>中继日志（relay log）</li>
</ol>
<hr>
<h3 id="-257"><a class="markdownIt-Anchor" href="#-257">#</a> <a href="#%E9%94%99%E8%AF%AF%E6%97%A5%E5%BF%97"></a>错误日志</h3>
<p>错误日志是 MySQL 中最重要的日志之一，记录了当 mysqld 启动和停止时，以及服务器在运行过程中发生任何严重错误时的相关信息。当数据库出现任何故障导致无法正常使用时，可以首先查看此日志</p>
<p>该日志是默认开启的，默认位置是： <code>/var/log/mysql/error.log</code></p>
<p>查看指令：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SHOW</span> VARIABLES <span class="token operator">LIKE</span> <span class="token string">'log_error%'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>查看日志内容：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">tail</span> -f /var/log/mysql/error.log<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<hr>
<h3 id="-258"><a class="markdownIt-Anchor" href="#-258">#</a> <a href="#%E5%BD%92%E6%A1%A3%E6%97%A5%E5%BF%97"></a>归档日志</h3>
<h4 id="-259"><a class="markdownIt-Anchor" href="#-259">#</a> <a href="#%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D-8"></a>基本介绍</h4>
<p>归档日志（BINLOG）也叫二进制日志，是因为采用二进制进行存储，记录了所有的 DDL（数据定义语言）语句和 DML（数据操作语言）语句，但<strong>不包括数据查询语句，在事务提交前的最后阶段写入</strong></p>
<p>作用：<strong>灾难时的数据恢复和 MySQL 的主从复制</strong></p>
<p>归档日志默认情况下是没有开启的，需要在 MySQL 配置文件中开启，并配置 MySQL 日志的格式：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token builtin class-name">cd</span> /etc/mysql
<span class="token function">vim</span> my.cnf

<span class="token comment"># 配置开启binlog日志， 日志的文件前缀为 mysqlbin -----> 生成的文件名如: mysqlbin.000001</span>
<span class="token assign-left variable">log_bin</span><span class="token operator">=</span>mysqlbin
<span class="token comment"># 配置二进制日志的格式</span>
<span class="token assign-left variable">binlog_format</span><span class="token operator">=</span>STATEMENT<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>日志存放位置：配置时给定了文件名但是没有指定路径，日志默认写入 MySQL 的数据目录</p>
<p>日志格式：</p>
<ul>
<li>
<p>STATEMENT：该日志格式在日志文件中记录的都是 SQL 语句，每一条对数据进行修改的 SQL 都会记录在日志文件中，通过 mysqlbinlog 工具，可以查看到每条语句的文本。主从复制时，从库会将日志解析为原语句，并在从库重新执行一遍</p>
<p>缺点：可能会导致主备不一致，因为记录的 SQL 在不同的环境中可能选择的索引不同，导致结果不同</p>
</li>
<li>
<p>ROW：该日志格式在日志文件中记录的是每一行的数据变更，而不是记录 SQL 语句。比如执行 SQL 语句  <code>update tb_book set status='1'</code> ，如果是 STATEMENT，在日志中会记录一行 SQL 语句； 如果是 ROW，由于是对全表进行更新，就是每一行记录都会发生变更，ROW 格式的日志中会记录每一行的数据变更</p>
<p>缺点：记录的数据比较多，占用很多的存储空间</p>
</li>
<li>
<p>MIXED：这是 MySQL 默认的日志格式，混合了 STATEMENT 和 ROW 两种格式。MIXED 格式能尽量利用两种模式的优点，而避开它们的缺点</p>
</li>
</ul>
<hr>
<h4 id="-260"><a class="markdownIt-Anchor" href="#-260">#</a> <a href="#%E6%97%A5%E5%BF%97%E8%AF%BB%E5%8F%96"></a>日志读取</h4>
<p>日志文件存储位置：/var/lib/mysql</p>
<p>由于日志以二进制方式存储，不能直接读取，需要用 mysqlbinlog 工具来查看，语法如下：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">mysqlbinlog log-file<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>查看 STATEMENT 格式日志：</p>
<ul>
<li>
<p>执行插入语句：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tb_book <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'Lucene'</span><span class="token punctuation">,</span><span class="token string">'2088-05-01'</span><span class="token punctuation">,</span><span class="token string">'0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p><code>cd /var/lib/mysql</code> ：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">-rw-r-----  <span class="token number">1</span> mysql mysql      <span class="token number">177</span> <span class="token number">5</span>月  <span class="token number">23</span> <span class="token number">21</span>:08 mysqlbin.000001
-rw-r-----  <span class="token number">1</span> mysql mysql       <span class="token number">18</span> <span class="token number">5</span>月  <span class="token number">23</span> <span class="token number">21</span>:04 mysqlbin.index<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>mysqlbin.index：该文件是日志索引文件 ， 记录日志的文件名；</p>
<p>mysqlbing.000001：日志文件</p>
</li>
<li>
<p>查看日志内容：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">mysqlbinlog mysqlbing.000001<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/b5be268c9cfaea9eeea41a6b1c13363099d92aaf8015d7ac576338565e7396cb/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d254536253937254135254535254246253937254538254146254242254535253846253936312e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/b5be268c9cfaea9eeea41a6b1c13363099d92aaf8015d7ac576338565e7396cb/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d254536253937254135254535254246253937254538254146254242254535253846253936312e706e67">https://camo.githubusercontent.com/b5be268c9cfaea9eeea41a6b1c13363099d92aaf8015d7ac576338565e7396cb/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d254536253937254135254535254246253937254538254146254242254535253846253936312e706e67</a>)</p>
<p>日志结尾有 COMMIT</p>
</li>
</ul>
<p>查看 ROW 格式日志：</p>
<ul>
<li>
<p>修改配置：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token comment"># 配置二进制日志的格式</span>
<span class="token assign-left variable">binlog_format</span><span class="token operator">=</span>ROW<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li>
<p>插入数据：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tb_book <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'SpringCloud实战'</span><span class="token punctuation">,</span><span class="token string">'2088-05-05'</span><span class="token punctuation">,</span><span class="token string">'0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>查看日志内容：日志格式 ROW，直接查看数据是乱码，可以在 mysqlbinlog 后面加上参数 -vv</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysqlbinlog <span class="token operator">-</span>vv mysqlbin<span class="token punctuation">.</span><span class="token number">000002</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d254536253937254135254535254246253937254538254146254242254535253846253936322e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/e985c8b653713e0bdd5f62f395a88dde79479d3bcb2f97649118ab5ef76eba94/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d254536253937254135254535254246253937254538254146254242254535253846253936322e706e67">https://camo.githubusercontent.com/e985c8b653713e0bdd5f62f395a88dde79479d3bcb2f97649118ab5ef76eba94/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d254536253937254135254535254246253937254538254146254242254535253846253936322e706e67</a>)</p>
</li>
</ul>
<hr>
<h4 id="-261"><a class="markdownIt-Anchor" href="#-261">#</a> <a href="#%E6%97%A5%E5%BF%97%E5%88%A0%E9%99%A4"></a>日志删除</h4>
<p>对于比较繁忙的系统，生成日志量大，这些日志如果长时间不清除，将会占用大量的磁盘空间，需要删除日志</p>
<ul>
<li>
<p>Reset Master 指令删除全部 binlog 日志，删除之后，日志编号将从 xxxx.000001 重新开始</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">Reset Master	<span class="token comment">-- MySQL指令</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>执行指令  <code>PURGE MASTER LOGS TO 'mysqlbin.***</code> ，该命令将删除  <code>***</code>  编号之前的所有日志</p>
</li>
<li>
<p>执行指令  <code>PURGE MASTER LOGS BEFORE 'yyyy-mm-dd hh:mm:ss'</code>  ，该命令将删除日志为  <code>yyyy-mm-dd hh:mm:ss</code>  之前产生的日志</p>
</li>
<li>
<p>设置参数  <code>--expire_logs_days=#</code> ，此参数的含义是设置日志的过期天数，过了指定的天数后日志将会被自动删除，这样做有利于减少管理日志的工作量，配置 my.cnf 文件：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token assign-left variable">log_bin</span><span class="token operator">=</span>mysqlbin
<span class="token assign-left variable">binlog_format</span><span class="token operator">=</span>ROW
--expire_logs_days<span class="token operator">=</span><span class="token number">3</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<hr>
<h3 id="-262"><a class="markdownIt-Anchor" href="#-262">#</a> <a href="#%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97"></a>查询日志</h3>
<p>查询日志中记录了客户端的所有操作语句，而二进制日志不包含查询数据的 SQL 语句</p>
<p>默认情况下，查询日志是未开启的。如果需要开启查询日志，配置 my.cnf：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token comment"># 该选项用来开启查询日志，可选值0或者1，0代表关闭，1代表开启 </span>
<span class="token assign-left variable">general_log</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token comment"># 设置日志的文件名，如果没有指定，默认的文件名为host_name.log，存放在/var/lib/mysql</span>
<span class="token assign-left variable">general_log_file</span><span class="token operator">=</span>mysql_query.log<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>配置完毕之后，在数据库执行以下操作：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tb_book<span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tb_book <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">UPDATE</span> tb_book <span class="token keyword">SET</span> name <span class="token operator">=</span> <span class="token string">'lucene入门指南'</span> <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tb_book <span class="token keyword">WHERE</span> id <span class="token operator">&lt;</span> <span class="token number">8</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>执行完毕之后， 再次来查询日志文件：</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/45f00bd805c932bc47c754687eda1ff1563404c0c58079e1259f69da06ab1975/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d2545362539462541352545382541462541322545362539372541352545352542462539372e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/45f00bd805c932bc47c754687eda1ff1563404c0c58079e1259f69da06ab1975/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d2545362539462541352545382541462541322545362539372541352545352542462539372e706e67">https://camo.githubusercontent.com/45f00bd805c932bc47c754687eda1ff1563404c0c58079e1259f69da06ab1975/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d2545362539462541352545382541462541322545362539372541352545352542462539372e706e67</a>)</p>
<hr>
<h3 id="-263"><a class="markdownIt-Anchor" href="#-263">#</a> <a href="#%E6%85%A2%E6%97%A5%E5%BF%97"></a>慢日志</h3>
<p>慢查询日志记录所有执行时间超过 long_query_time 并且扫描记录数不小于 min_examined_row_limit 的所有的 SQL 语句的日志。long_query_time 默认为 10 秒，最小为 0， 精度到微秒</p>
<p>慢查询日志默认是关闭的，可以通过两个参数来控制慢查询日志，配置文件  <code>/etc/mysql/my.cnf</code> ：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token comment"># 该参数用来控制慢查询日志是否开启，可选值0或者1，0代表关闭，1代表开启 </span>
<span class="token assign-left variable">slow_query_log</span><span class="token operator">=</span><span class="token number">1</span> 

<span class="token comment"># 该参数用来指定慢查询日志的文件名，存放在 /var/lib/mysql</span>
<span class="token assign-left variable">slow_query_log_file</span><span class="token operator">=</span>slow_query.log

<span class="token comment"># 该选项用来配置查询的时间限制，超过这个时间将认为值慢查询，将需要进行日志记录，默认10s</span>
<span class="token assign-left variable">long_query_time</span><span class="token operator">=</span><span class="token number">10</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>日志读取：</p>
<ul>
<li>
<p>直接通过 cat 指令查询该日志文件：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">cat</span> slow_query.log<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/b083fb0904e13191356b525dcb10e8cb14301c4a61dccb09160cf4b27f1c6c69/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d254536253835254132254536253937254135254535254246253937254538254146254242254535253846253936312e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/b083fb0904e13191356b525dcb10e8cb14301c4a61dccb09160cf4b27f1c6c69/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d254536253835254132254536253937254135254535254246253937254538254146254242254535253846253936312e706e67">https://camo.githubusercontent.com/b083fb0904e13191356b525dcb10e8cb14301c4a61dccb09160cf4b27f1c6c69/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d254536253835254132254536253937254135254535254246253937254538254146254242254535253846253936312e706e67</a>)</p>
</li>
<li>
<p>如果慢查询日志内容很多，直接查看文件比较繁琐，可以借助 mysql 自带的 mysqldumpslow 工具对慢查询日志进行分类汇总：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">mysqldumpslow slow_query.log<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d254536253835254132254536253937254135254535254246253937254538254146254242254535253846253936322e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/83bc25d5f8a96aff6423426e698a7e8cce05c81ea196f25d0d35af94228b26a6/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d254536253835254132254536253937254135254535254246253937254538254146254242254535253846253936322e706e67">https://camo.githubusercontent.com/83bc25d5f8a96aff6423426e698a7e8cce05c81ea196f25d0d35af94228b26a6/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f4d7953514c2d254536253835254132254536253937254135254535254246253937254538254146254242254535253846253936322e706e67</a>)</p>
</li>
</ul>
<hr>
<h2 id="-264"><a class="markdownIt-Anchor" href="#-264">#</a> <a href="#%E8%8C%83%E5%BC%8F"></a>范式</h2>
<h3 id="-265"><a class="markdownIt-Anchor" href="#-265">#</a> <a href="#%E7%AC%AC%E4%B8%80%E8%8C%83%E5%BC%8F"></a>第一范式</h3>
<p>建立科学的，<strong>规范的数据表</strong>就需要满足一些规则来优化数据的设计和存储，这些规则就称为范式</p>
<p>**1NF：** 数据库表的每一列都是不可分割的原子数据项，不能是集合、数组等非原子数据项。即表中的某个列有多个值时，必须拆分为不同的列。简而言之，<strong>第一范式每一列不可再拆分，称为原子性</strong></p>
<p>基本表：</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/b11eb8d307dc186530b4e674394e4cc918d572eef20fd3b22efe6d0bc29e1c1d/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f2545362539392541452545392538302539412545382541312541382e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/b11eb8d307dc186530b4e674394e4cc918d572eef20fd3b22efe6d0bc29e1c1d/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f2545362539392541452545392538302539412545382541312541382e706e67">https://camo.githubusercontent.com/b11eb8d307dc186530b4e674394e4cc918d572eef20fd3b22efe6d0bc29e1c1d/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f2545362539392541452545392538302539412545382541312541382e706e67</a>)</p>
<p>第一范式表：</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f2545372541432541432545342542382538302545382538432538332545352542432538462e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/3a98b07d96970a9eb840aa03555ad94ae882f2558d1be6cd7765aae680097af8/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f2545372541432541432545342542382538302545382538432538332545352542432538462e706e67">https://camo.githubusercontent.com/3a98b07d96970a9eb840aa03555ad94ae882f2558d1be6cd7765aae680097af8/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f2545372541432541432545342542382538302545382538432538332545352542432538462e706e67</a>)</p>
<hr>
<h3 id="-266"><a class="markdownIt-Anchor" href="#-266">#</a> <a href="#%E7%AC%AC%E4%BA%8C%E8%8C%83%E5%BC%8F"></a>第二范式</h3>
<p>**2NF：** 在满足第一范式的基础上，非主属性完全依赖于主码（主关键字、主键），消除非主属性对主码的部分函数依赖。简而言之，<strong>表中的每一个字段 （所有列）都完全依赖于主键，记录的唯一性</strong></p>
<p>作用：遵守第二范式减少数据冗余，通过主键区分相同数据。</p>
<ol>
<li>函数依赖：A → B，如果通过 A 属性 (属性组) 的值，可以确定唯一 B 属性的值，则称 B 依赖于 A
<ul>
<li>学号 → 姓名；(学号，课程名称) → 分数</li>
</ul>
</li>
<li>完全函数依赖：A → B，如果 A 是一个属性组，则 B 属性值的确定需要依赖于 A 属性组的所有属性值
<ul>
<li>(学号，课程名称) → 分数</li>
</ul>
</li>
<li>部分函数依赖：A → B，如果 A 是一个属性组，则 B 属性值的确定只需要依赖于 A 属性组的某些属性值
<ul>
<li>(学号，课程名称) → 姓名</li>
</ul>
</li>
<li>传递函数依赖：A → B，B → C，如果通过 A 属性 (属性组) 的值，可以确定唯一 B 属性的值，在通过 B 属性 (属性组) 的值，可以确定唯一 C 属性的值，则称 C 传递函数依赖于 A
<ul>
<li>学号 → 系名，系名 → 系主任</li>
</ul>
</li>
<li>码：如果在一张表中，一个属性或属性组，被其他所有属性所完全依赖，则称这个属性 (属性组) 为该表的码
<ul>
<li>该表中的码：(学号，课程名称)</li>
<li>主属性：码属性组中的所有属性</li>
<li>非主属性：除码属性组以外的属性</li>
</ul>
</li>
</ol>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/9a85ef8c6301db31cd78875ee75da0df2b5120daf11d0dff5b7b9affadfefd5f/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f2545372541432541432545342542412538432545382538432538332545352542432538462e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/9a85ef8c6301db31cd78875ee75da0df2b5120daf11d0dff5b7b9affadfefd5f/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f2545372541432541432545342542412538432545382538432538332545352542432538462e706e67">https://camo.githubusercontent.com/9a85ef8c6301db31cd78875ee75da0df2b5120daf11d0dff5b7b9affadfefd5f/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f2545372541432541432545342542412538432545382538432538332545352542432538462e706e67</a>)</p>
<hr>
<h3 id="-267"><a class="markdownIt-Anchor" href="#-267">#</a> <a href="#%E7%AC%AC%E4%B8%89%E8%8C%83%E5%BC%8F"></a>第三范式</h3>
<p>**3NF：** 在满足第二范式的基础上，表中的任何属性不依赖于其它非主属性，消除传递依赖。简而言之，<strong>非主键都直接依赖于主键，而不是通过其它的键来间接依赖于主键</strong>。</p>
<p>作用：可以通过主键 id 区分相同数据，修改数据的时候只需要修改一张表（方便修改），反之需要修改多表。</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f2545372541432541432545342542382538392545382538432538332545352542432538462e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/03fd34be85a8330e001665f34014cf5c3b8fcd28a11b1601a04b2767ff0621bf/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f2545372541432541432545342542382538392545382538432538332545352542432538462e706e67">https://camo.githubusercontent.com/03fd34be85a8330e001665f34014cf5c3b8fcd28a11b1601a04b2767ff0621bf/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f2545372541432541432545342542382538392545382538432538332545352542432538462e706e67</a>)</p>
<hr>
<h3 id="-268"><a class="markdownIt-Anchor" href="#-268">#</a> <a href="#%E6%80%BB%E7%BB%93"></a>总结</h3>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f2545342542382538392545352541342541372545382538432538332545352542432538462e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/a466d700efe3b147aea786fd0cd11265884366eaa6488a862696a436d6848918/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f2545342542382538392545352541342541372545382538432538332545352542432538462e706e67">https://camo.githubusercontent.com/a466d700efe3b147aea786fd0cd11265884366eaa6488a862696a436d6848918/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f2545342542382538392545352541342541372545382538432538332545352542432538462e706e67</a>)</p>
<hr>
<h1 id="-269"><a class="markdownIt-Anchor" href="#-269">#</a> <a href="#jdbc"></a>JDBC</h1>
<h2 id="-270"><a class="markdownIt-Anchor" href="#-270">#</a> <a href="#%E6%A6%82%E8%BF%B0"></a>概述</h2>
<p>JDBC（Java DataBase Connectivity，java 数据库连接）是一种用于执行 SQL 语句的 Java API，可以为多种关系型数据库提供统一访问，是由一组用 Java 语言编写的类和接口组成的。</p>
<p>JDBC 是 Java 官方提供的一套规范（接口），用于帮助开发人员快速实现不同关系型数据库的连接</p>
<p>使用 JDBC 需要导包</p>
<hr>
<h2 id="-271"><a class="markdownIt-Anchor" href="#-271">#</a> <a href="#%E5%8A%9F%E8%83%BD%E7%B1%BB"></a>功能类</h2>
<h3 id="-272"><a class="markdownIt-Anchor" href="#-272">#</a> <a href="#drivermanager"></a>DriverManager</h3>
<p>DriverManager：驱动管理对象</p>
<ul>
<li>
<p>注册驱动</p>
<ul>
<li>
<p>注册给定的驱动： <code>public static void registerDriver(Driver driver)</code></p>
</li>
<li>
<p>代码实现语法： <code>Class.forName(&quot;com.mysql.jdbc.Driver)</code></p>
</li>
<li>
<p>com.mysql.jdbc.Driver 中存在静态代码块</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">static</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">DriverManager</span><span class="token punctuation">.</span><span class="token function">registerDriver</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Driver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> var1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Can't register driver!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>不需要通过 DriverManager 调用静态方法 registerDriver，因为 Driver 类被使用，则自动执行静态代码块完成注册驱动</p>
</li>
<li>
<p>jar 包中 META-INF 目录下存在一个 java.sql.Driver 配置文件，文件中指定了 com.mysql.jdbc.Driver</p>
</li>
</ul>
</li>
<li>
<p>获取数据库连接并返回连接对象</p>
<p><code>public static Connection getConnection(String url, String user, String password)</code></p>
<ul>
<li>url：指定连接的路径。语法： <code>jdbc:mysql://ip地址(域名):端口号/数据库名称</code></li>
<li>user：用户名</li>
<li>password：密码</li>
</ul>
</li>
</ul>
<hr>
<h3 id="-273"><a class="markdownIt-Anchor" href="#-273">#</a> <a href="#connection"></a>Connection</h3>
<p>Connection：数据库连接对象</p>
<ul>
<li>获取执行者对象
<ul>
<li>获取普通执行者对象： <code>Statement createStatement()</code></li>
<li>获取预编译执行者对象： <code>PreparedStatement prepareStatement(String sql)</code></li>
</ul>
</li>
<li>管理事务
<ul>
<li>开启事务： <code>setAutoCommit(boolean autoCommit)</code> ，false 开启事务，true 自动提交模式（默认）</li>
<li>提交事务： <code>void commit()</code></li>
<li>回滚事务： <code>void rollback()</code></li>
</ul>
</li>
<li>释放资源
<ul>
<li>释放此 Connection 对象的数据库和 JDBC 资源： <code>void close()</code></li>
</ul>
</li>
</ul>
<hr>
<h3 id="-274"><a class="markdownIt-Anchor" href="#-274">#</a> <a href="#statement"></a>Statement</h3>
<p>Statement：执行 sql 语句的对象</p>
<ul>
<li>执行 DML 语句： <code>int executeUpdate(String sql)</code>
<ul>
<li>返回值 int：返回影响的行数</li>
<li>参数 sql：可以执行 insert、update、delete 语句</li>
</ul>
</li>
<li>执行 DQL 语句： <code>ResultSet executeQuery(String sql)</code>
<ul>
<li>返回值 ResultSet：封装查询的结果</li>
<li>参数 sql：可以执行 select 语句</li>
</ul>
</li>
<li>释放资源
<ul>
<li>释放此 Statement 对象的数据库和 JDBC 资源： <code>void close()</code></li>
</ul>
</li>
</ul>
<hr>
<h3 id="-275"><a class="markdownIt-Anchor" href="#-275">#</a> <a href="#resultset"></a>ResultSet</h3>
<p>ResultSet：结果集对象，ResultSet 对象维护了一个游标，指向当前的数据行，初始在第一行</p>
<ul>
<li>判断结果集中是否有数据： <code>boolean next()</code>
<ul>
<li>有数据返回 true，并将索引<strong>向下移动一行</strong></li>
<li>没有数据返回 false</li>
</ul>
</li>
<li>获取结果集中<strong>当前行</strong>的数据： <code>XXX getXxx(&quot;列名&quot;)</code>
<ul>
<li>XXX 代表数据类型（要获取某列数据，这一列的数据类型）</li>
<li>例如：String getString (“name”); int getInt (“age”);</li>
</ul>
</li>
<li>释放资源
<ul>
<li>释放 ResultSet 对象的数据库和 JDBC 资源： <code>void close()</code></li>
</ul>
</li>
</ul>
<hr>
<h3 id="-276"><a class="markdownIt-Anchor" href="#-276">#</a> <a href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"></a>代码实现</h3>
<p>数据准备</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 创建db14数据库</span>
<span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> db14<span class="token punctuation">;</span>

<span class="token comment">-- 使用db14数据库</span>
<span class="token keyword">USE</span> db14<span class="token punctuation">;</span>

<span class="token comment">-- 创建student表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> student<span class="token punctuation">(</span>
	sid <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>	<span class="token comment">-- 学生id</span>
	NAME <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>					<span class="token comment">-- 学生姓名</span>
	age <span class="token keyword">INT</span><span class="token punctuation">,</span>							<span class="token comment">-- 学生年龄</span>
	birthday <span class="token keyword">DATE</span><span class="token punctuation">,</span>						<span class="token comment">-- 学生生日</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 添加数据</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> student <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'张三'</span><span class="token punctuation">,</span><span class="token number">23</span><span class="token punctuation">,</span><span class="token string">'1999-09-23'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'李四'</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token string">'1998-08-10'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'王五'</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token string">'1996-06-06'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'赵六'</span><span class="token punctuation">,</span><span class="token number">26</span><span class="token punctuation">,</span><span class="token string">'1994-10-20'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>JDBC 连接代码：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JDBCDemo01</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>
        <span class="token comment">//1.导入jar包</span>
        <span class="token comment">//2.注册驱动</span>
        <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"com.mysql.jdbc.Driver"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//3.获取连接</span>
        <span class="token class-name">Connection</span> con <span class="token operator">=</span> <span class="token class-name">DriverManager</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token string">"jdbc:mysql://192.168.2.184:3306/db2"</span><span class="token punctuation">,</span><span class="token string">"root"</span><span class="token punctuation">,</span><span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//4.获取执行者对象</span>
        <span class="token class-name">Statement</span> stat <span class="token operator">=</span> con<span class="token punctuation">.</span><span class="token function">createStatement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//5.执行sql语句，并且接收结果</span>
        <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">"SELECT * FROM user"</span><span class="token punctuation">;</span>
        <span class="token class-name">ResultSet</span> rs <span class="token operator">=</span> stat<span class="token punctuation">.</span><span class="token function">executeQuery</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//6.处理结果</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span>rs<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>rs<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\t"</span> <span class="token operator">+</span> rs<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">//7.释放资源</span>
        con<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stat<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        con<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<h2 id="-277"><a class="markdownIt-Anchor" href="#-277">#</a> <a href="#%E5%B7%A5%E5%85%B7%E7%B1%BB"></a>工具类</h2>
<ul>
<li>
<p>配置文件（在 src 下创建 config.properties）</p>
<pre class="line-numbers language-ini" data-language="ini"><code class="language-ini"><span class="token key attr-name">driverClass</span><span class="token punctuation">=</span><span class="token value attr-value">com.mysql.jdbc.Driver</span>
<span class="token key attr-name">url</span><span class="token punctuation">=</span><span class="token value attr-value">jdbc:mysql://192.168.2.184:3306/db14</span>
<span class="token key attr-name">username</span><span class="token punctuation">=</span><span class="token value attr-value">root</span>
<span class="token key attr-name">password</span><span class="token punctuation">=</span><span class="token value attr-value">123456</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>工具类</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JDBCUtils</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//1.私有构造方法</span>
    <span class="token keyword">private</span> <span class="token class-name">JDBCUtils</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token comment">//2.声明配置信息变量</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> driverClass<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> url<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Connection</span> con<span class="token punctuation">;</span>

    <span class="token comment">//3.静态代码块中实现加载配置文件和注册驱动</span>
    <span class="token keyword">static</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span><span class="token punctuation">&#123;</span>
            <span class="token comment">//通过类加载器返回配置文件的字节流</span>
            <span class="token class-name">InputStream</span> is <span class="token operator">=</span> <span class="token class-name">JDBCUtils</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                	<span class="token function">getResourceAsStream</span><span class="token punctuation">(</span><span class="token string">"config.properties"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//创建Properties集合，加载流对象的信息</span>
            <span class="token class-name">Properties</span> prop <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            prop<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>is<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//获取信息为变量赋值</span>
            driverClass <span class="token operator">=</span> prop<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"driverClass"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            url <span class="token operator">=</span> prop<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"url"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            username <span class="token operator">=</span> prop<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            password <span class="token operator">=</span> prop<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//注册驱动</span>
            <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>driverClass<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//4.获取数据库连接的方法</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Connection</span> <span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            con <span class="token operator">=</span> <span class="token class-name">DriverManager</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span>username<span class="token punctuation">,</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> con<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//5.释放资源的方法</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token class-name">Connection</span> con<span class="token punctuation">,</span> <span class="token class-name">Statement</span> stat<span class="token punctuation">,</span> <span class="token class-name">ResultSet</span> rs<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>con <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                con<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>stat <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                stat<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>rs <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                rs<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
	<span class="token comment">//方法重载，可能没有返回值对象</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token class-name">Connection</span> con<span class="token punctuation">,</span> <span class="token class-name">Statement</span> stat<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">close</span><span class="token punctuation">(</span>con<span class="token punctuation">,</span>stat<span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<hr>
<h2 id="-278"><a class="markdownIt-Anchor" href="#-278">#</a> <a href="#%E6%95%B0%E6%8D%AE%E5%B0%81%E8%A3%85"></a>数据封装</h2>
<p>从数据库读取数据并封装成 Student 对象，需要：</p>
<ul>
<li>
<p>Student 类成员变量对应表中的列</p>
</li>
<li>
<p>所有的基本数据类型需要使用包装类，<strong>以防 null 值无法赋值</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Student</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> sid<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> age<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Date</span> birthday<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>数据准备</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 创建db14数据库</span>
<span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> db14<span class="token punctuation">;</span>

<span class="token comment">-- 使用db14数据库</span>
<span class="token keyword">USE</span> db14<span class="token punctuation">;</span>

<span class="token comment">-- 创建student表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> student<span class="token punctuation">(</span>
	sid <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>	<span class="token comment">-- 学生id</span>
	NAME <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>					<span class="token comment">-- 学生姓名</span>
	age <span class="token keyword">INT</span><span class="token punctuation">,</span>							<span class="token comment">-- 学生年龄</span>
	birthday <span class="token keyword">DATE</span>						<span class="token comment">-- 学生生日</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 添加数据</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> student <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'张三'</span><span class="token punctuation">,</span><span class="token number">23</span><span class="token punctuation">,</span><span class="token string">'1999-09-23'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'李四'</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token string">'1998-08-10'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'王五'</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token string">'1996-06-06'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">'赵六'</span><span class="token punctuation">,</span><span class="token number">26</span><span class="token punctuation">,</span><span class="token string">'1994-10-20'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>操作数据库</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StudentDaoImpl</span><span class="token punctuation">&#123;</span>
	<span class="token comment">//查询所有学生信息</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Student</span><span class="token punctuation">></span></span> <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//1. </span>
        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Student</span><span class="token punctuation">></span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Connection</span> con <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">Statement</span> stat <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">ResultSet</span> rs <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span><span class="token punctuation">&#123;</span>
            <span class="token comment">//2.获取数据库连接</span>
			con <span class="token operator">=</span> <span class="token class-name">JDBCUtils</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

           	<span class="token comment">//3.获取执行者对象</span>
           	stat <span class="token operator">=</span> con<span class="token punctuation">.</span><span class="token function">createStatement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

           	<span class="token comment">//4.执行sql语句，并且接收返回的结果集</span>
			<span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">"SELECT * FROM student"</span><span class="token punctuation">;</span>
           	rs <span class="token operator">=</span> stat<span class="token punctuation">.</span><span class="token function">executeQuery</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>

          	<span class="token comment">//5.处理结果集</span>
           	<span class="token keyword">while</span><span class="token punctuation">(</span>rs<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">Integer</span> sid <span class="token operator">=</span> rs<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">"sid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               	<span class="token class-name">String</span> name <span class="token operator">=</span> rs<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               	<span class="token class-name">Integer</span> age <span class="token operator">=</span> rs<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               	<span class="token class-name">Date</span> birthday <span class="token operator">=</span> rs<span class="token punctuation">.</span><span class="token function">getDate</span><span class="token punctuation">(</span><span class="token string">"birthday"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

               	<span class="token comment">//封装Student对象</span>
               	<span class="token class-name">Student</span> stu <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span>sid<span class="token punctuation">,</span>name<span class="token punctuation">,</span>age<span class="token punctuation">,</span>birthday<span class="token punctuation">)</span><span class="token punctuation">;</span>
               	<span class="token comment">//将student对象保存到集合中</span>
               	list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>stu<span class="token punctuation">)</span><span class="token punctuation">;</span>
           	<span class="token punctuation">&#125;</span>
       	<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
           	e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       	<span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
           	<span class="token comment">//6.释放资源</span>
           	<span class="token class-name">JDBCUtils</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>con<span class="token punctuation">,</span>stat<span class="token punctuation">,</span>rs<span class="token punctuation">)</span><span class="token punctuation">;</span>
       	<span class="token punctuation">&#125;</span>
		<span class="token comment">//将集合对象返回</span>
		<span class="token keyword">return</span> list<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

	<span class="token comment">//添加学生信息</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">insert</span><span class="token punctuation">(</span><span class="token class-name">Student</span> stu<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Connection</span> con <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">Statement</span> stat <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span><span class="token punctuation">&#123;</span>
            con <span class="token operator">=</span> <span class="token class-name">JDBCUtils</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//3.获取执行者对象</span>
            stat <span class="token operator">=</span> con<span class="token punctuation">.</span><span class="token function">createStatement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//4.执行sql语句，并且接收返回的结果集</span>
            <span class="token class-name">Date</span> d <span class="token operator">=</span> stu<span class="token punctuation">.</span><span class="token function">getBirthday</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">SimpleDateFormat</span> sdf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">"yyyy-MM-dd"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> birthday <span class="token operator">=</span> sdf<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">"INSERT INTO student VALUES ('"</span><span class="token operator">+</span>stu<span class="token punctuation">.</span><span class="token function">getSid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"','"</span><span class="token operator">+</span>stu<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"','"</span><span class="token operator">+</span>stu<span class="token punctuation">.</span><span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"','"</span><span class="token operator">+</span>birthday<span class="token operator">+</span><span class="token string">"')"</span><span class="token punctuation">;</span>
            result <span class="token operator">=</span> stat<span class="token punctuation">.</span><span class="token function">executeUpdate</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//6.释放资源</span>
            <span class="token class-name">JDBCUtils</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>con<span class="token punctuation">,</span>stat<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">//将结果返回</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<hr>
<h2 id="-279"><a class="markdownIt-Anchor" href="#-279">#</a> <a href="#%E6%B3%A8%E5%85%A5%E6%94%BB%E5%87%BB"></a>注入攻击</h2>
<h3 id="-280"><a class="markdownIt-Anchor" href="#-280">#</a> <a href="#%E6%94%BB%E5%87%BB%E6%BC%94%E7%A4%BA"></a>攻击演示</h3>
<p>SQL 注入攻击演示</p>
<ul>
<li>
<p>在登录界面，输入一个错误的用户名或密码，也可以登录成功</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f53514c2545362542332541382545352538352541352545362539342542422545352538372542422545362542432539342545372541342542412e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/a37e0e32b620a4a2d29fc69cba0bd30da61d2c185543e766eb0b35e01eaeb1ec/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f53514c2545362542332541382545352538352541352545362539342542422545352538372542422545362542432539342545372541342542412e706e67">https://camo.githubusercontent.com/a37e0e32b620a4a2d29fc69cba0bd30da61d2c185543e766eb0b35e01eaeb1ec/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f53514c2545362542332541382545352538352541352545362539342542422545352538372542422545362542432539342545372541342542412e706e67</a>)</p>
</li>
<li>
<p>原理：我们在密码处输入的所有内容，都应该认为是密码的组成，但是 Statement 对象在执行 SQL 语句时，将一部分内容当做查询条件来执行</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">user</span> <span class="token keyword">WHERE</span> loginname<span class="token operator">=</span><span class="token string">'aaa'</span> <span class="token operator">AND</span> password<span class="token operator">=</span><span class="token string">'aaa'</span> <span class="token operator">OR</span> <span class="token string">'1'</span><span class="token operator">=</span><span class="token string">'1'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<hr>
<h3 id="-281"><a class="markdownIt-Anchor" href="#-281">#</a> <a href="#%E6%94%BB%E5%87%BB%E8%A7%A3%E5%86%B3"></a>攻击解决</h3>
<p>PreparedStatement：预编译 sql 语句的执行者对象，继承  <code>PreparedStatement extends Statement</code></p>
<ul>
<li>在执行 sql 语句之前，将 sql 语句进行提前编译。明确 sql 语句的格式，剩余的内容都会认为是参数</li>
<li>sql 语句中的参数使用？作为占位符</li>
</ul>
<p>为？占位符赋值的方法： <code>setXxx(int parameterIndex, xxx data)</code></p>
<ul>
<li>
<p>参数 1：? 的位置编号（编号从 1 开始）</p>
</li>
<li>
<p>参数 2：? 的实际参数</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">"SELECT * FROM user WHERE loginname=? AND password=?"</span><span class="token punctuation">;</span>
pst <span class="token operator">=</span> con<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
pst<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>loginName<span class="token punctuation">)</span><span class="token punctuation">;</span>
pst<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<p>执行 sql 语句的方法</p>
<ul>
<li>执行 insert、update、delete 语句： <code>int executeUpdate()</code></li>
<li>执行 select 语句： <code>ResultSet executeQuery()</code></li>
</ul>
<hr>
<h2 id="-282"><a class="markdownIt-Anchor" href="#-282">#</a> <a href="#%E8%BF%9E%E6%8E%A5%E6%B1%A0"></a>连接池</h2>
<h3 id="-283"><a class="markdownIt-Anchor" href="#-283">#</a> <a href="#%E6%A6%82%E5%BF%B5"></a>概念</h3>
<p>数据库连接背景：数据库连接是一种关键的、有限的、昂贵的资源，这一点在多用户的网页应用程序中体现得尤为突出。对数据库连接的管理能显著影响到整个应用程序的伸缩性和健壮性，影响到程序的性能指标。</p>
<p>数据库连接池：<strong>数据库连接池负责分配、管理和释放数据库连接</strong>，它允许应用程序<strong>重复使用</strong>一个现有的数据库连接，而不是再重新建立一个，这项技术能明显提高对数据库操作的性能。</p>
<p>数据库连接池原理</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/743151224f05aad8b5e868896a8b56f193a5c330aeb9bfb2dcfecdf88485a700/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f2545362539352542302545362538442541452545352542412539332545382542462539452545362538452541352545362542312541302545352538452539462545372539302538362545352539422542452545382541372541332e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/743151224f05aad8b5e868896a8b56f193a5c330aeb9bfb2dcfecdf88485a700/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f2545362539352542302545362538442541452545352542412539332545382542462539452545362538452541352545362542312541302545352538452539462545372539302538362545352539422542452545382541372541332e706e67">https://camo.githubusercontent.com/743151224f05aad8b5e868896a8b56f193a5c330aeb9bfb2dcfecdf88485a700/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f2545362539352542302545362538442541452545352542412539332545382542462539452545362538452541352545362542312541302545352538452539462545372539302538362545352539422542452545382541372541332e706e67</a>)</p>
<hr>
<h3 id="-284"><a class="markdownIt-Anchor" href="#-284">#</a> <a href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%B1%A0"></a>自定义池</h3>
<p>DataSource 接口概述：</p>
<ul>
<li>java.sql.DataSource 接口：数据源（数据库连接池）</li>
<li>Java 中 DataSource 是一个标准的数据源接口，官方提供的数据库连接池规范，连接池类实现该接口</li>
<li>获取数据库连接对象： <code>Connection getConnection()</code></li>
</ul>
<p>自定义连接池：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyDataSource</span> <span class="token keyword">implements</span> <span class="token class-name">DataSource</span><span class="token punctuation">&#123;</span>
    <span class="token comment">//1.定义集合容器，用于保存多个数据库连接对象</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Connection</span><span class="token punctuation">></span></span> pool <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">synchronizedList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Connection</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//2.静态代码块，生成10个数据库连接保存到集合中</span>
    <span class="token keyword">static</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Connection</span> con <span class="token operator">=</span> <span class="token class-name">JDBCUtils</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            pool<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>con<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//3.返回连接池的大小</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> pool<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//4.从池中返回一个数据库连接</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Connection</span> <span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//从池中获取数据库连接</span>
            <span class="token keyword">return</span> pool<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"连接数量已用尽"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>测试连接池功能：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyDataSourceTest</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>
        <span class="token comment">//创建数据库连接池对象</span>
        <span class="token class-name">MyDataSource</span> dataSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"使用之前连接池数量："</span> <span class="token operator">+</span> dataSource<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//10</span>
        
        <span class="token comment">//获取数据库连接对象</span>
        <span class="token class-name">Connection</span> con <span class="token operator">=</span> dataSource<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>con<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// JDBC4Connection</span>

        <span class="token comment">//查询学生表全部信息</span>
        <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">"SELECT * FROM student"</span><span class="token punctuation">;</span>
        <span class="token class-name">PreparedStatement</span> pst <span class="token operator">=</span> con<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ResultSet</span> rs <span class="token operator">=</span> pst<span class="token punctuation">.</span><span class="token function">executeQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span><span class="token punctuation">(</span>rs<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>rs<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">"sid"</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\t"</span> <span class="token operator">+</span> rs<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\t"</span> <span class="token operator">+</span> rs<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\t"</span> <span class="token operator">+</span> rs<span class="token punctuation">.</span><span class="token function">getDate</span><span class="token punctuation">(</span><span class="token string">"birthday"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        
        <span class="token comment">//释放资源</span>
        rs<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pst<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//目前的连接对象close方法，是直接关闭连接，而不是将连接归还池中</span>
        con<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"使用之后连接池数量："</span> <span class="token operator">+</span> dataSource<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//9</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>结论：释放资源并没有把连接归还给连接池</p>
<hr>
<h3 id="-285"><a class="markdownIt-Anchor" href="#-285">#</a> <a href="#%E5%BD%92%E8%BF%98%E8%BF%9E%E6%8E%A5"></a>归还连接</h3>
<p>归还数据库连接的方式：继承方式、装饰者设计者模式、适配器设计模式、动态代理方式</p>
<h4 id="-286"><a class="markdownIt-Anchor" href="#-286">#</a> <a href="#%E7%BB%A7%E6%89%BF%E6%96%B9%E5%BC%8F"></a>继承方式</h4>
<p>继承（无法解决）</p>
<ul>
<li>通过打印连接对象，发现 DriverManager 获取的连接实现类是 JDBC4Connection</li>
<li>自定义一个类，继承 JDBC4Connection 这个类，重写 close () 方法</li>
<li>通过查看 JDBC 工具类获取连接的方法我们发现：我们虽然自定义了一个子类，完成了归还连接的操作。但是 DriverManager 获取的还是 JDBC4Connection 这个对象，并不是我们的子类对象。</li>
</ul>
<p>代码实现</p>
<ul>
<li>
<p>自定义继承连接类</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//1.定义一个类，继承JDBC4Connection</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyConnection1</span> <span class="token keyword">extends</span> <span class="token class-name">JDBC4Connection</span><span class="token punctuation">&#123;</span>
    <span class="token comment">//2.定义Connection连接对象和容器对象的成员变量</span>
    <span class="token keyword">private</span> <span class="token class-name">Connection</span> con<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Connection</span><span class="token punctuation">></span></span> pool<span class="token punctuation">;</span>

    <span class="token comment">//3.通过有参构造方法为成员变量赋值</span>
    <span class="token keyword">public</span> <span class="token class-name">MyConnection1</span><span class="token punctuation">(</span><span class="token class-name">String</span> hostToConnectTo<span class="token punctuation">,</span> <span class="token keyword">int</span> portToConnectTo<span class="token punctuation">,</span> <span class="token class-name">Properties</span> info<span class="token punctuation">,</span> <span class="token class-name">String</span> databaseToConnectTo<span class="token punctuation">,</span> <span class="token class-name">String</span> url<span class="token punctuation">,</span><span class="token class-name">Connection</span> con<span class="token punctuation">,</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Connection</span><span class="token punctuation">></span></span> pool<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>hostToConnectTo<span class="token punctuation">,</span> portToConnectTo<span class="token punctuation">,</span> info<span class="token punctuation">,</span> databaseToConnectTo<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>con <span class="token operator">=</span> con<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>pool <span class="token operator">=</span> pool<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//4.重写close方法，完成归还连接</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">&#123;</span>
        pool<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>con<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>自定义连接池类</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//将之前的连接对象换成自定义的子类对象</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">MyConnection1</span> con<span class="token punctuation">;</span>

<span class="token comment">//4.获取数据库连接的方法</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Connection</span> <span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//等效于：MyConnection1 con = new JDBC4Connection();  语法错误！</span>
        con <span class="token operator">=</span> <span class="token class-name">DriverManager</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span>username<span class="token punctuation">,</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> con<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<hr>
<h4 id="-287"><a class="markdownIt-Anchor" href="#-287">#</a> <a href="#%E8%A3%85%E9%A5%B0%E8%80%85"></a>装饰者</h4>
<p>自定义类实现 Connection 接口，通过装饰设计模式，实现和 mysql 驱动包中的 Connection 实现类相同的功能</p>
<p>在实现类对每个获取的 Connection 进行装饰：把连接和连接池参数传递进行包装</p>
<p>特点：通过装饰设计模式连接类我们发现，有很多需要重写的方法，代码太繁琐</p>
<ul>
<li>
<p>装饰设计模式类</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//1.定义一个类，实现Connection接口</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyConnection2</span> <span class="token keyword">implements</span> <span class="token class-name">Connection</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//2.定义Connection连接对象和连接池容器对象的变量</span>
    <span class="token keyword">private</span> <span class="token class-name">Connection</span> con<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Connection</span><span class="token punctuation">></span></span> pool<span class="token punctuation">;</span>

    <span class="token comment">//3.提供有参构造方法，接收连接对象和连接池对象，对变量赋值</span>
    <span class="token keyword">public</span> <span class="token class-name">MyConnection2</span><span class="token punctuation">(</span><span class="token class-name">Connection</span> con<span class="token punctuation">,</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Connection</span><span class="token punctuation">></span></span> pool<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>con <span class="token operator">=</span> con<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>pool <span class="token operator">=</span> pool<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//4.在close()方法中，完成连接的归还</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">&#123;</span>
        pool<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>con<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//5.剩余方法，只需要调用mysql驱动包的连接对象完成即可</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Statement</span> <span class="token function">createStatement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> con<span class="token punctuation">.</span><span class="token function">createStatement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>自定义连接池类</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Connection</span> <span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//从池中获取数据库连接</span>
        <span class="token class-name">Connection</span> con <span class="token operator">=</span> pool<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//通过自定义连接对象进行包装</span>
        <span class="token class-name">MyConnection2</span> mycon <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyConnection2</span><span class="token punctuation">(</span>con<span class="token punctuation">,</span>pool<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//返回包装后的连接对象</span>
        <span class="token keyword">return</span> mycon<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"连接数量已用尽"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<hr>
<h4 id="-288"><a class="markdownIt-Anchor" href="#-288">#</a> <a href="#%E9%80%82%E9%85%8D%E5%99%A8"></a>适配器</h4>
<p>使用适配器设计模式改进，提供一个适配器类，实现 Connection 接口，将所有功能进行实现（除了 close 方法），自定义连接类只需要继承这个适配器类，重写需要改进的 close () 方法即可。</p>
<p>特点：自定义连接类中很简洁。剩余所有的方法抽取到了适配器类中，但是适配器这个类还是我们自己编写。</p>
<ul>
<li>
<p>适配器类</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">MyAdapter</span> <span class="token keyword">implements</span> <span class="token class-name">Connection</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">// 定义数据库连接对象的变量</span>
    <span class="token keyword">private</span> <span class="token class-name">Connection</span> con<span class="token punctuation">;</span>

    <span class="token comment">// 通过构造方法赋值</span>
    <span class="token keyword">public</span> <span class="token class-name">MyAdapter</span><span class="token punctuation">(</span><span class="token class-name">Connection</span> con<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>con <span class="token operator">=</span> con<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 所有的方法，均调用mysql的连接对象实现</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Statement</span> <span class="token function">createStatement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> con<span class="token punctuation">.</span><span class="token function">createStatement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>自定义连接类</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyConnection3</span> <span class="token keyword">extends</span> <span class="token class-name">MyAdapter</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//2.定义Connection连接对象和连接池容器对象的变量</span>
    <span class="token keyword">private</span> <span class="token class-name">Connection</span> con<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Connection</span><span class="token punctuation">></span></span> pool<span class="token punctuation">;</span>

    <span class="token comment">//3.提供有参构造方法，接收连接对象和连接池对象，对变量赋值</span>
    <span class="token keyword">public</span> <span class="token class-name">MyConnection3</span><span class="token punctuation">(</span><span class="token class-name">Connection</span> con<span class="token punctuation">,</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Connection</span><span class="token punctuation">></span></span> pool<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>con<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 将接收的数据库连接对象给适配器父类传递</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>con <span class="token operator">=</span> con<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>pool <span class="token operator">=</span> pool<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//4.在close()方法中，完成连接的归还</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">&#123;</span>
        pool<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>con<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>自定义连接池类</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//从池中返回一个数据库连接</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Connection</span> <span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//从池中获取数据库连接</span>
        <span class="token class-name">Connection</span> con <span class="token operator">=</span> pool<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//通过自定义连接对象进行包装</span>
        <span class="token class-name">MyConnection3</span> mycon <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyConnection3</span><span class="token punctuation">(</span>con<span class="token punctuation">,</span>pool<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//返回包装后的连接对象</span>
        <span class="token keyword">return</span> mycon<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"连接数量已用尽"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<hr>
<h4 id="-289"><a class="markdownIt-Anchor" href="#-289">#</a> <a href="#%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86"></a>动态代理</h4>
<p>使用动态代理的方式来改进</p>
<p>自定义数据库连接池类：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyDataSource</span> <span class="token keyword">implements</span> <span class="token class-name">DataSource</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//1.准备一个容器。用于保存多个数据库连接对象</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Connection</span><span class="token punctuation">></span></span> pool <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">synchronizedList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//2.定义静态代码块,获取多个连接对象保存到容器中</span>
    <span class="token keyword">static</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Connection</span> con <span class="token operator">=</span> <span class="token class-name">JDBCUtils</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            pool<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>con<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//3.提供一个获取连接池大小的方法</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> pool<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

   	<span class="token comment">//动态代理方式</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Connection</span> <span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Connection</span> con <span class="token operator">=</span> pool<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">Connection</span> proxyCon <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Connection</span><span class="token punctuation">)</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span>
                con<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">Connection</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> 
                <span class="token keyword">new</span> <span class="token class-name">InvocationHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">/*
                    执行Connection实现类连接对象所有的方法都会经过invoke
                    如果是close方法，归还连接
                    如果不是，直接执行连接对象原有的功能即可
                 */</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> proxy<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"close"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token comment">//归还连接</span>
                        pool<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>con<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                        <span class="token keyword">return</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>con<span class="token punctuation">,</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> proxyCon<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"连接数量已用尽"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<h3 id="-290"><a class="markdownIt-Anchor" href="#-290">#</a> <a href="#%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE"></a>开源项目</h3>
<h4 id="-291"><a class="markdownIt-Anchor" href="#-291">#</a> <a href="#c3p0"></a>C3P0</h4>
<p>使用 C3P0 连接池：</p>
<ul>
<li>
<p>配置文件名称：c3p0-config.xml，必须放在 src 目录下</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>c3p0-config</span><span class="token punctuation">></span></span>
  <span class="token comment">&lt;!-- 使用默认的配置读取连接池对象 --></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>default-config</span><span class="token punctuation">></span></span>
  	<span class="token comment">&lt;!--  连接参数 --></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>driverClass<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>com.mysql.jdbc.Driver<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>jdbcUrl<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>jdbc:mysql://192.168.2.184:3306/db14<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>user<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>root<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>123456<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
    
    <span class="token comment">&lt;!-- 连接池参数 --></span>
    <span class="token comment">&lt;!--初始化数量--></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>initialPoolSize<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
    <span class="token comment">&lt;!--最大连接数量--></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>maxPoolSize<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>10<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
    <span class="token comment">&lt;!--超时时间 3000ms--></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>checkoutTimeout<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>3000<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>default-config</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>named-config</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>otherc3p0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span> 
    <span class="token comment">&lt;!--  连接参数 --></span>
    <span class="token comment">&lt;!-- 连接池参数 --></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>named-config</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>c3p0-config</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>代码演示</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">C3P0Test1</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>
        <span class="token comment">//1.创建c3p0的数据库连接池对象</span>
        <span class="token class-name">DataSource</span> dataSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComboPooledDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2.通过连接池对象获取数据库连接</span>
        <span class="token class-name">Connection</span> con <span class="token operator">=</span> dataSource<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//3.执行操作</span>
        <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">"SELECT * FROM student"</span><span class="token punctuation">;</span>
        <span class="token class-name">PreparedStatement</span> pst <span class="token operator">=</span> con<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//4.执行sql语句，接收结果集</span>
        <span class="token class-name">ResultSet</span> rs <span class="token operator">=</span> pst<span class="token punctuation">.</span><span class="token function">executeQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//5.处理结果集</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span>rs<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>rs<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">"sid"</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\t"</span> <span class="token operator">+</span> rs<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\t"</span> <span class="token operator">+</span> rs<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\t"</span> <span class="token operator">+</span> rs<span class="token punctuation">.</span><span class="token function">getDate</span><span class="token punctuation">(</span><span class="token string">"birthday"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">//6.释放资源</span>
        rs<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   pst<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   con<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<h4 id="-292"><a class="markdownIt-Anchor" href="#-292">#</a> <a href="#druid"></a>Druid</h4>
<p>Druid 连接池：</p>
<ul>
<li>
<p>配置文件：druid.properties，必须放在 src 目录下</p>
<pre class="line-numbers language-ini" data-language="ini"><code class="language-ini"><span class="token key attr-name">driverClassName</span><span class="token punctuation">=</span><span class="token value attr-value">com.mysql.jdbc.Driver</span>
<span class="token key attr-name">url</span><span class="token punctuation">=</span><span class="token value attr-value">jdbc:mysql://192.168.2.184:3306/db14</span>
<span class="token key attr-name">username</span><span class="token punctuation">=</span><span class="token value attr-value">root</span>
<span class="token key attr-name">password</span><span class="token punctuation">=</span><span class="token value attr-value">123456</span>
<span class="token key attr-name">initialSize</span><span class="token punctuation">=</span><span class="token value attr-value">5</span>
<span class="token key attr-name">maxActive</span><span class="token punctuation">=</span><span class="token value attr-value">10</span>
<span class="token key attr-name">maxWait</span><span class="token punctuation">=</span><span class="token value attr-value">3000</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>代码演示</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DruidTest1</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>
        <span class="token comment">//获取配置文件的流对象</span>
        <span class="token class-name">InputStream</span> is <span class="token operator">=</span> <span class="token class-name">DruidTest1</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResourceAsStream</span><span class="token punctuation">(</span><span class="token string">"druid.properties"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//1.通过Properties集合，加载配置文件</span>
        <span class="token class-name">Properties</span> prop <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        prop<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>is<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2.通过Druid连接池工厂类获取数据库连接池对象</span>
        <span class="token class-name">DataSource</span> dataSource <span class="token operator">=</span> <span class="token class-name">DruidDataSourceFactory</span><span class="token punctuation">.</span><span class="token function">createDataSource</span><span class="token punctuation">(</span>prop<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//3.通过连接池对象获取数据库连接进行使用</span>
        <span class="token class-name">Connection</span> con <span class="token operator">=</span> dataSource<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
		<span class="token comment">//4.执行sql语句，接收结果集</span>
        <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">"SELECT * FROM student"</span><span class="token punctuation">;</span>
        <span class="token class-name">PreparedStatement</span> pst <span class="token operator">=</span> con<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ResultSet</span> rs <span class="token operator">=</span> pst<span class="token punctuation">.</span><span class="token function">executeQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//5.处理结果集</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span>rs<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>rs<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">"sid"</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\t"</span> <span class="token operator">+</span> rs<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\t"</span> <span class="token operator">+</span> rs<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\t"</span> <span class="token operator">+</span> rs<span class="token punctuation">.</span><span class="token function">getDate</span><span class="token punctuation">(</span><span class="token string">"birthday"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">//6.释放资源</span>
        rs<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   pst<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   con<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<h3 id="-293"><a class="markdownIt-Anchor" href="#-293">#</a> <a href="#%E5%B7%A5%E5%85%B7%E7%B1%BB-1"></a>工具类</h3>
<p>数据库连接池的工具类：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataSourceUtils</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//1.私有构造方法</span>
    <span class="token keyword">private</span> <span class="token class-name">DataSourceUtils</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

    <span class="token comment">//2.声明数据源变量</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">DataSource</span> dataSource<span class="token punctuation">;</span>

    <span class="token comment">//3.提供静态代码块，完成配置文件的加载和获取数据库连接池对象</span>
    <span class="token keyword">static</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span><span class="token punctuation">&#123;</span>
            <span class="token comment">//完成配置文件的加载</span>
            <span class="token class-name">InputStream</span> is <span class="token operator">=</span> <span class="token class-name">DataSourceUtils</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResourceAsStream</span><span class="token punctuation">(</span><span class="token string">"druid.properties"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Properties</span> prop <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            prop<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>is<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//获取数据库连接池对象</span>
            dataSource <span class="token operator">=</span> <span class="token class-name">DruidDataSourceFactory</span><span class="token punctuation">.</span><span class="token function">createDataSource</span><span class="token punctuation">(</span>prop<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//4.提供一个获取数据库连接的方法</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Connection</span> <span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Connection</span> con <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            con <span class="token operator">=</span> dataSource<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> con<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//5.提供一个获取数据库连接池对象的方法</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">DataSource</span> <span class="token function">getDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> dataSource<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//6.释放资源</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token class-name">Connection</span> con<span class="token punctuation">,</span> <span class="token class-name">Statement</span> stat<span class="token punctuation">,</span> <span class="token class-name">ResultSet</span> rs<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>con <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                con<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>stat <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                stat<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>rs <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                rs<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
	<span class="token comment">//方法重载</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token class-name">Connection</span> con<span class="token punctuation">,</span> <span class="token class-name">Statement</span> stat<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>con <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                con<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>stat <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                stat<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<h1 id="-294"><a class="markdownIt-Anchor" href="#-294">#</a> <a href="#redis"></a>Redis</h1>
<h2 id="-295"><a class="markdownIt-Anchor" href="#-295">#</a> <a href="#nosql"></a>NoSQL</h2>
<h3 id="-296"><a class="markdownIt-Anchor" href="#-296">#</a> <a href="#%E6%A6%82%E8%BF%B0-1"></a>概述</h3>
<p>NoSQL（Not-Only SQL）：泛指非关系型的数据库，作为关系型数据库的补充。</p>
<p>MySQL 支持 ACID 特性，保证可靠性和持久性，读取性能不高，因此需要缓存的来减缓数据库的访问压力。</p>
<p>作用：应对基于海量用户和海量数据前提下的数据处理问题</p>
<p>特征：</p>
<ul>
<li>可扩容，可伸缩，SQL 数据关系过于复杂，Nosql 不存关系，只存数据</li>
<li>大数据量下高性能，数据不存取在磁盘 IO，存取在内存</li>
<li>灵活的数据模型，设计了一些数据存储格式，能保证效率上的提高</li>
<li>高可用，集群</li>
</ul>
<p>常见的 Nosql：Redis、memcache、HBase、MongoDB</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/88e985474117cc9e3e06b11f12412846f2e8dee527bb25a9d2473a499892aa24/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f2545372539342542352545352539352538362545352539432542412545362539392541462545382541372541332545352538362542332545362539362542392545362541312538382e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/88e985474117cc9e3e06b11f12412846f2e8dee527bb25a9d2473a499892aa24/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f2545372539342542352545352539352538362545352539432542412545362539392541462545382541372541332545352538362542332545362539362542392545362541312538382e706e67">https://camo.githubusercontent.com/88e985474117cc9e3e06b11f12412846f2e8dee527bb25a9d2473a499892aa24/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f2545372539342542352545352539352538362545352539432542412545362539392541462545382541372541332545352538362542332545362539362542392545362541312538382e706e67</a>)</p>
<p>参考视频：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1CJ411m7Gc">https://www.bilibili.com/video/BV1CJ411m7Gc</a></p>
<p>参考视频：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1Rv41177Af">https://www.bilibili.com/video/BV1Rv41177Af</a></p>
<hr>
<h3 id="-297"><a class="markdownIt-Anchor" href="#-297">#</a> <a href="#redis-1"></a>Redis</h3>
<p>Redis (REmote DIctionary Server) ：用 C 语言开发的一个开源的高性能键值对（key-value）数据库。</p>
<p>特征：</p>
<ul>
<li>数据间没有必然的关联关系，<strong>不存关系，只存数据</strong></li>
<li>数据<strong>存储在内存</strong>，存取速度快，解决了磁盘 IO 速度慢的问题</li>
<li>内部采用<strong>单线程</strong>机制进行工作</li>
<li>高性能，官方测试数据，50 个并发执行 100000 个请求，读的速度是 110000 次 /s, 写的速度是 81000 次 /s</li>
<li>多数据类型支持
<ul>
<li>字符串类型：string（String）</li>
<li>列表类型：list（LinkedList）</li>
<li>散列类型：hash（HashMap）</li>
<li>集合类型：set（HashSet）</li>
<li>有序集合类型：zset/sorted_set（TreeSet）</li>
</ul>
</li>
<li>支持持久化，可以进行数据灾难恢复</li>
</ul>
<p>应用：</p>
<ul>
<li>
<p>为热点数据加速查询（主要场景），如热点商品、热点新闻、热点资讯、推广类等高访问量信息等</p>
</li>
<li>
<p>即时信息查询，如排行榜、网站访问统计、公交到站信息、在线人数（聊天室、网站）、设备信号等</p>
</li>
<li>
<p>时效性信息控制，如验证码控制、投票控制等</p>
</li>
<li>
<p>分布式数据共享，如分布式集群架构中的 session 分离</p>
</li>
<li>
<p>消息队列</p>
</li>
</ul>
<hr>
<h3 id="-298"><a class="markdownIt-Anchor" href="#-298">#</a> <a href="#%E5%AE%89%E8%A3%85%E5%90%AF%E5%8A%A8"></a>安装启动</h3>
<h4 id="-299"><a class="markdownIt-Anchor" href="#-299">#</a> <a href="#centos"></a>CentOS</h4>
<ol>
<li>
<p>下载 Redis</p>
<p>下载安装包：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">wget</span> http://download.redis.io/releases/redis-5.0.0.tar.gz<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>解压安装包：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">tar</span> –xvf redis-5.0.0.tar.gz<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>编译（在解压的目录中执行）：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">make</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>安装（在解压的目录中执行）：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">make</span> <span class="token function">install</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>安装 Redis</p>
<p>redis-server，服务器启动命令 客户端启动命令</p>
<p>redis-cli，redis 核心配置文件</p>
<p>redis.conf，RDB 文件检查工具（快照持久化文件）</p>
<p>redis-check-dump，AOF 文件修复工具</p>
<p>redis-check-aof</p>
</li>
</ol>
<hr>
<h4 id="-300"><a class="markdownIt-Anchor" href="#-300">#</a> <a href="#ubuntu"></a>Ubuntu</h4>
<p>安装：</p>
<ul>
<li>
<p>Redis 5.0 被包含在默认的 Ubuntu 20.04 软件源中</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">sudo</span> <span class="token function">apt</span> update
<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> redis-server<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li>
<p>检查 Redis 状态</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">sudo</span> systemctl status redis-server<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<p>启动：</p>
<ul>
<li>
<p>启动服务器 —— 参数启动</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">redis-server <span class="token punctuation">[</span>--port port<span class="token punctuation">]</span>
<span class="token comment">#redis-server --port 6379</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li>
<p>启动服务器 —— 配置文件启动</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">redis-server config_file_name
<span class="token comment">#redis-server /etc/redis/conf/redis-6397.conf</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li>
<p>启动客户端：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">redis-cli <span class="token punctuation">[</span>-h host<span class="token punctuation">]</span> <span class="token punctuation">[</span>-p port<span class="token punctuation">]</span>
<span class="token comment">#redis-cli -h 192.168.2.185 -p 6397</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>注意：服务器启动指定端口使用的是–port，客户端启动指定端口使用的是 - p</p>
</li>
</ul>
<hr>
<h3 id="-301"><a class="markdownIt-Anchor" href="#-301">#</a> <a href="#%E5%9F%BA%E6%9C%AC%E9%85%8D%E7%BD%AE"></a>基本配置</h3>
<h4 id="-302"><a class="markdownIt-Anchor" href="#-302">#</a> <a href="#%E7%B3%BB%E7%BB%9F%E7%9B%AE%E5%BD%95"></a>系统目录</h4>
<ol>
<li>
<p>创建文件结构</p>
<p>创建配置文件存储目录</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">mkdir</span> conf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>创建服务器文件存储目录（包含日志、数据、临时配置文件等）</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">mkdir</span> data<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>创建配置文件副本放入 conf 目录，Ubuntu 系统配置文件 redis.conf 在目录  <code>/etc/redis</code>  中</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">cat</span> redis.conf <span class="token operator">|</span> <span class="token function">grep</span> -v <span class="token string">"#"</span> <span class="token operator">|</span> <span class="token function">grep</span> -v <span class="token string">"^$"</span> -<span class="token operator">></span> /conf/redis-6379.conf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>去除配置文件的注释和空格，输出到新的文件，命令方式采用 redis-port.conf</p>
</li>
</ol>
<hr>
<h4 id="-303"><a class="markdownIt-Anchor" href="#-303">#</a> <a href="#%E6%9C%8D%E5%8A%A1%E5%99%A8"></a>服务器</h4>
<ul>
<li>
<p>设置服务器以守护进程的方式运行，关闭后服务器控制台中将打印服务器运行信息（同日志内容相同）：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">daemonize <span class="token function">yes</span><span class="token operator">|</span>no<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>绑定主机地址，绑定本地 IP 地址，否则 SSH 无法访问：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token builtin class-name">bind</span> <span class="token function">ip</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>设置服务器端口：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">port port<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>设置服务器文件保存地址：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">dir</span> path<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>设置数据库的数量：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">databases <span class="token number">16</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>多服务器快捷配置：</p>
<p>导入并加载指定配置文件信息，用于快速创建 redis 公共配置较多的 redis 实例配置文件，便于维护</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">include /path/conf_name.conf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<hr>
<h4 id="-304"><a class="markdownIt-Anchor" href="#-304">#</a> <a href="#%E5%AE%A2%E6%88%B7%E7%AB%AF"></a>客户端</h4>
<ul>
<li>
<p>服务器允许客户端连接最大数量，默认 0，表示无限制，当客户端连接到达上限后，Redis 会拒绝新的连接：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">maxclients count<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>客户端闲置等待最大时长，达到最大值后关闭对应连接，如需关闭该功能，设置为 0：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">timeout</span> seconds<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<hr>
<h4 id="-305"><a class="markdownIt-Anchor" href="#-305">#</a> <a href="#%E6%97%A5%E5%BF%97%E9%85%8D%E7%BD%AE"></a>日志配置</h4>
<ul>
<li>
<p>设置服务器以指定日志记录级别：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">loglevel debug<span class="token operator">|</span>verbose<span class="token operator">|</span>notice<span class="token operator">|</span>warning<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>日志记录文件名</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">logfile filename<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<p>注意：日志级别开发期设置为 verbose 即可，生产环境中配置为 notice，简化日志输出量，降低写日志 IO 的频度</p>
<p><strong>配置文件：</strong></p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token builtin class-name">bind</span> <span class="token number">192.168</span>.2.185
port <span class="token number">6379</span>
<span class="token comment">#timeout 0</span>
daemonize no
logfile /etc/redis/data/redis-6379.log
<span class="token function">dir</span> /etc/redis/data
dbfilename <span class="token string">"dump-6379.rdb"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<h2 id="-306"><a class="markdownIt-Anchor" href="#-306">#</a> <a href="#%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84-1"></a>体系结构</h2>
<h3 id="-307"><a class="markdownIt-Anchor" href="#-307">#</a> <a href="#%E5%AD%98%E5%82%A8%E5%AF%B9%E8%B1%A1"></a>存储对象</h3>
<p>Redis 使用对象来表示数据库中的键和值，当在 Redis 数据库中新创建一个键值对时至少会创建两个对象，一个对象用作键值对的键（键对象），另一个对象用作键值对的值（值对象）</p>
<p>Redis 中对象由一个 redisObject 结构表示，该结构中和保存数据有关的三个属性分别是 type、 encoding、ptr：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">redisObiect</span><span class="token punctuation">&#123;</span>
	<span class="token comment">//类型</span>
	<span class="token keyword">unsigned</span> type<span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">;</span>
	<span class="token comment">//编码</span>
	<span class="token keyword">unsigned</span> encoding<span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">;</span>
	<span class="token comment">//指向底层数据结构的指针</span>
	<span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Redis 中主要数据结构有：简单动态字符串（SDS）、双端链表、字典、压缩列表、整数集合、跳跃表</p>
<p>Redis 并没有直接使用数据结构来实现键值对数据库，而是基于这些数据结构创建了一个对象系统，包含字符串对象、列表对象、哈希对象、集合对象和有序集合对象这五种类型的对象，而每种对象又通过不同的编码映射到不同的底层数据结构</p>
<p>Redis 自身是一个 Map，其中所有的数据都是采用 key : value 的形式存储，<strong>键对象都是字符串对象</strong>，而值对象有五种基本类型和三种高级类型对象</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/3c6ed3798b7bee7d333e670de396245ef1f553ea0f5c3ffd11c37da2b9987939/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d2545352541462542392545382542312541312545362541382541312545352539452538422e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/3c6ed3798b7bee7d333e670de396245ef1f553ea0f5c3ffd11c37da2b9987939/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d2545352541462542392545382542312541312545362541382541312545352539452538422e706e67">https://camo.githubusercontent.com/3c6ed3798b7bee7d333e670de396245ef1f553ea0f5c3ffd11c37da2b9987939/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d2545352541462542392545382542312541312545362541382541312545352539452538422e706e67</a>)</p>
<hr>
<h3 id="-308"><a class="markdownIt-Anchor" href="#-308">#</a> <a href="#%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B"></a>线程模型</h3>
<p>Redis 基于 Reactor 模式开发了网络事件处理器，这个处理器被称为文件事件处理器（file event handler），这个文件事件处理器是单线程的，所以 Redis 叫做单线程的模型</p>
<p>文件事件处理器以单线程方式运行，但是使用 I/O 多路复用程序来监听多个套接字，既实现了高性能的网络通信模型，又很好地与 Redis 服务器中其他同样以单线程方式运行的模块进行对接，保持了 Redis 单线程设计的简单性</p>
<p>工作原理：</p>
<ul>
<li>
<p>文件事件处理器使用 I/O 多路复用（multiplexing）程序来同时监听多个套接字，并根据套接字目前执行的任务来为套接字关联不同的事件处理器</p>
</li>
<li>
<p>当被监听的套接字准备好执行连接应答 (accept)、读取 (read)、写入 (write)、关闭 (close) 等操作时，与操作相对应的文件事件就会产生，这时文件事件处理器会将处理请求放入<strong>单线程的执行队列</strong>中，等待调用套接字关联好的事件处理器来处理事件</p>
</li>
</ul>
<p><strong>Redis 单线程也能高效的原因</strong>：</p>
<ul>
<li>纯内存操作</li>
<li>核心是基于非阻塞的 IO 多路复用机制，单线程可以高效处理多个请求</li>
<li>底层使用 C 语言实现，C 语言实现的程序距离操作系统更近，执行速度相对会更快</li>
<li>单线程同时也<strong>避免了多线程的上下文频繁切换问题</strong>，预防了多线程可能产生的竞争问题</li>
</ul>
<hr>
<h3 id="-309"><a class="markdownIt-Anchor" href="#-309">#</a> <a href="#%E5%A4%9A%E7%BA%BF%E7%A8%8B"></a>多线程</h3>
<p>Redis6.0 引入多线程主要是为了提高网络 IO 读写性能，因为这是 Redis 的一个性能瓶颈（Redis 的瓶颈主要受限于内存和网络），多线程只是用来<strong>处理网络数据的读写和协议解析</strong>， 执行命令仍然是单线程顺序执行，因此不需要担心线程安全问题。</p>
<p>Redis6.0 的多线程默认是禁用的，只使用主线程。如需开启需要修改 redis 配置文件  <code>redis.conf</code>  ：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">io-threads-do-reads yesCopy to clipboardErrorCopied<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>开启多线程后，还需要设置线程数，否则是不生效的，同样需要修改 redis 配置文件 :</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">io-threads <span class="token number">4</span> <span class="token comment">#官网建议4核的机器建议设置为2或3个线程，8核的建议设置为6个线程</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732de5a49ae7babfe7a88b2e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/1d1c47300e04c13f832d0c8aabe3e77086dbc78ff59c79425dca3ed849c086f8/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732de5a49ae7babfe7a88b2e706e67">https://camo.githubusercontent.com/1d1c47300e04c13f832d0c8aabe3e77086dbc78ff59c79425dca3ed849c086f8/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732de5a49ae7babfe7a88b2e706e67</a>)</p>
<p>参考文章：<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/dqmiR0ECf4lB6Y2OyK-dyA">https://mp.weixin.qq.com/s/dqmiR0ECf4lB6Y2OyK-dyA</a></p>
<hr>
<h2 id="-310"><a class="markdownIt-Anchor" href="#-310">#</a> <a href="#%E5%9F%BA%E6%9C%AC%E6%8C%87%E4%BB%A4"></a>基本指令</h2>
<h3 id="-311"><a class="markdownIt-Anchor" href="#-311">#</a> <a href="#%E6%93%8D%E4%BD%9C%E6%8C%87%E4%BB%A4"></a>操作指令</h3>
<p>读写数据：</p>
<ul>
<li>
<p>设置 key，value 数据：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token builtin class-name">set</span> key value
<span class="token comment">#set name seazean</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li>
<p>根据 key 查询对应的 value，如果<strong>不存在，返回空（nil）</strong>：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">get key
<span class="token comment">#get name</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
</ul>
<p>帮助信息：</p>
<ul>
<li>
<p>获取命令帮助文档</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token builtin class-name">help</span> <span class="token punctuation">[</span>command<span class="token punctuation">]</span>
<span class="token comment">#help set</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li>
<p>获取组中所有命令信息名称</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token builtin class-name">help</span> <span class="token punctuation">[</span>@group-name<span class="token punctuation">]</span>
<span class="token comment">#help @string</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
</ul>
<p>退出服务</p>
<ul>
<li>
<p>退出客户端：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">quit
<span class="token builtin class-name">exit</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li>
<p>退出客户端服务器快捷键：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">Ctrl+C<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<hr>
<h3 id="-312"><a class="markdownIt-Anchor" href="#-312">#</a> <a href="#key-%E6%8C%87%E4%BB%A4"></a>key 指令</h3>
<p>key 是一个字符串，通过 key 获取 redis 中保存的数据</p>
<ul>
<li>
<p>基本操作</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">del key						<span class="token comment">#删除指定key</span>
unlink key   				<span class="token comment">#非阻塞删除key，真正的删除会在后续异步操作</span>
exists key					<span class="token comment">#获取key是否存在</span>
<span class="token builtin class-name">type</span> key					<span class="token comment">#获取key的类型</span>
<span class="token function">sort</span> key <span class="token punctuation">[</span>ASC/DESC<span class="token punctuation">]</span>			<span class="token comment">#对key中数据排序，默认对数字排序，并不更改集合中的数据位置，只是查询</span>
<span class="token function">sort</span> key alpha				<span class="token comment">#对key中字母排序</span>
<span class="token function">rename</span> key newkey			<span class="token comment">#改名</span>
renamenx key newkey			<span class="token comment">#改名</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>时效性控制</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">expire key seconds			<span class="token comment">#为指定key设置有效期，单位为秒</span>
pexpire key milliseconds	<span class="token comment">#为指定key设置有效期，单位为毫秒</span>
expireat key timestamp		<span class="token comment">#为指定key设置有效期，单位为时间戳</span>
pexpireat key mil-timestamp	<span class="token comment">#为指定key设置有效期，单位为毫秒时间戳</span>

ttl key						<span class="token comment">#获取key的有效时间，每次获取会自动变化(减小)，类似于倒计时，</span>
							<span class="token comment">#-1代表永久性，-2代表不存在/失效</span>
pttl key					<span class="token comment">#获取key的有效时间，单位是毫秒，每次获取会自动变化(减小)</span>
persist key					<span class="token comment">#切换key从时效性转换为永久性</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>查询模式</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">keys pattern				<span class="token comment">#查询key</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>查询模式规则：* 匹配任意数量的任意符号；? 配合一个任意符号；[] 匹配一个指定符号</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">keys *						<span class="token comment">#查询所有key</span>
keys aa*					<span class="token comment">#查询所有以aa开头</span>
keys *bb					<span class="token comment">#查询所有以bb结尾</span>
keys ??cc					<span class="token comment">#查询所有前面两个字符任意，后面以cc结尾 </span>
keys user:?					<span class="token comment">#查询所有以user:开头，最后一个字符任意</span>
keys u<span class="token punctuation">[</span>st<span class="token punctuation">]</span>er:1				<span class="token comment">#查询所有以u开头，以er:1结尾，中间包含一个字母，s或t</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<hr>
<h3 id="-313"><a class="markdownIt-Anchor" href="#-313">#</a> <a href="#db-%E6%8C%87%E4%BB%A4"></a>DB 指令</h3>
<p>Redis 在使用过程中，随着操作数据量的增加，会出现大量的数据以及对应的 key，数据不区分种类、类别混在一起，容易引起重复或者冲突，所以 Redis 为每个服务提供 16 个数据库，编码 0-15，每个数据库之间相互独立，** 共用 **Redis 内存，不区分大小</p>
<ul>
<li>
<p>基本操作</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token keyword">select</span> index	<span class="token comment">#切换数据库，index从0-15取值</span>
<span class="token function">ping</span>			<span class="token comment">#测试数据库是否连接正常，返回PONG</span>
<span class="token builtin class-name">echo</span> message	<span class="token comment">#控制台输出信息</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>扩展操作</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">move key db		<span class="token comment">#数据移动到指定数据库，db是数据库编号</span>
dbsize			<span class="token comment">#获取当前数据库的数据总量，即key的个数</span>
flushdb			<span class="token comment">#清除当前数据库的所有数据</span>
flushall		<span class="token comment">#清除所有数据</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<hr>
<h3 id="-314"><a class="markdownIt-Anchor" href="#-314">#</a> <a href="#%E9%80%9A%E4%BF%A1%E6%8C%87%E4%BB%A4"></a>通信指令</h3>
<p>Redis 发布订阅（pub/sub）是一种消息通信模式：发送者（pub）发送消息，订阅者（sub）接收消息。</p>
<p>Redis 客户端可以订阅任意数量的频道</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/f19c2d31ff6ba5e88aaa693ae8f7ec7666cd97297fe70c3acd1ead4cceb05050/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d2545352538462539312545352542382538332545382541452541322545392539382538352e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/f19c2d31ff6ba5e88aaa693ae8f7ec7666cd97297fe70c3acd1ead4cceb05050/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d2545352538462539312545352542382538332545382541452541322545392539382538352e706e67">https://camo.githubusercontent.com/f19c2d31ff6ba5e88aaa693ae8f7ec7666cd97297fe70c3acd1ead4cceb05050/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d2545352538462539312545352542382538332545382541452541322545392539382538352e706e67</a>)</p>
<p>操作命令：</p>
<ol>
<li>打开一个客户端订阅 channel1： <code>SUBSCRIBE channel1</code></li>
<li>打开另一个客户端，给 channel1 发布消息 hello： <code>publish channel1 hello</code></li>
<li>第一个客户端可以看到发送的消息</li>
</ol>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/e2b599f31cad51802b97d4d68c858dee8c68553f28e7b12b5555de5657d59e96/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732de58f91e5b883e8aea2e99885e68c87e4bba4e6938de4bd9c2e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/e2b599f31cad51802b97d4d68c858dee8c68553f28e7b12b5555de5657d59e96/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732de58f91e5b883e8aea2e99885e68c87e4bba4e6938de4bd9c2e706e67">https://camo.githubusercontent.com/e2b599f31cad51802b97d4d68c858dee8c68553f28e7b12b5555de5657d59e96/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732de58f91e5b883e8aea2e99885e68c87e4bba4e6938de4bd9c2e706e67</a>)</p>
<p>注意：发布的消息没有持久化，所以订阅的客户端只能收到订阅后发布的消息</p>
<hr>
<h3 id="-315"><a class="markdownIt-Anchor" href="#-315">#</a> <a href="#acl-%E6%8C%87%E4%BB%A4"></a>ACL 指令</h3>
<p>Redis ACL 是 Access Control List（访问控制列表）的缩写，该功能允许根据可以执行的命令和可以访问的键来限制某些连接</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/2c9f868650e9ed90bf09eea6661aec4546930210967ac5cad56047a1b722fcf3/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d41434c2545362538432538372545342542422541342e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/2c9f868650e9ed90bf09eea6661aec4546930210967ac5cad56047a1b722fcf3/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d41434c2545362538432538372545342542422541342e706e67">https://camo.githubusercontent.com/2c9f868650e9ed90bf09eea6661aec4546930210967ac5cad56047a1b722fcf3/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d41434c2545362538432538372545342542422541342e706e67</a>)</p>
<ul>
<li>
<p>acl cat：查看添加权限指令类别</p>
</li>
<li>
<p>acl whoami：查看当前用户</p>
</li>
<li>
<p>acl setuser username on &gt;password ~cached:* +get：设置有用户名、密码、ACL 权限（只能 get）</p>
</li>
</ul>
<hr>
<h2 id="-316"><a class="markdownIt-Anchor" href="#-316">#</a> <a href="#%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"></a>数据类型</h2>
<h3 id="-317"><a class="markdownIt-Anchor" href="#-317">#</a> <a href="#string"></a>string</h3>
<h4 id="-318"><a class="markdownIt-Anchor" href="#-318">#</a> <a href="#%E7%AE%80%E4%BB%8B-1"></a>简介</h4>
<p>存储的数据：单个数据，最简单的数据存储类型，也是最常用的数据存储类型，实质上是存一个字符串，string 类型是二进制安全的，意味着 Redis 的 string 可以包含任何数据，比如图片或者序列化的对象</p>
<p>存储数据的格式：一个存储空间保存一个数据，每一个空间中只能保存一个字符串信息</p>
<p>存储内容：通常使用字符串，如果字符串以整数的形式展示，可以作为数字操作使用</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d737472696e67e7bb93e69e84e59bbe2e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/d3c831a8a3da0a08a28686b8d2dc2d2f9f37c7590a0b35605c83d006c22a4dd6/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d737472696e67e7bb93e69e84e59bbe2e706e67">https://camo.githubusercontent.com/d3c831a8a3da0a08a28686b8d2dc2d2f9f37c7590a0b35605c83d006c22a4dd6/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d737472696e67e7bb93e69e84e59bbe2e706e67</a>)</p>
<p>Redis 所有操作都是<strong>原子性</strong>的，采用<strong>单线程</strong>机制，命令是单个顺序执行，无需考虑并发带来影响，原子性就是有一个失败则都失败</p>
<hr>
<h4 id="-319"><a class="markdownIt-Anchor" href="#-319">#</a> <a href="#%E6%93%8D%E4%BD%9C"></a>操作</h4>
<p>指令操作：</p>
<ul>
<li>
<p>数据操作：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token builtin class-name">set</span> key value			<span class="token comment">#添加/修改数据添加/修改数据</span>
del key					<span class="token comment">#删除数据</span>
setnx key value			<span class="token comment">#判定性添加数据，键值为空则设添加</span>
mset k1 v1 k2 v2<span class="token punctuation">..</span>.		<span class="token comment">#添加/修改多个数据，m：Multiple</span>
append key value		<span class="token comment">#追加信息到原始信息后部（如果原始信息存在就追加，否则新建）</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>查询操作</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">get key					<span class="token comment">#获取数据</span>
mget key1 key2<span class="token punctuation">..</span>.		<span class="token comment">#获取多个数据</span>
strlen key				<span class="token comment">#获取数据字符个数（字符串长度）</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>设置数值数据增加 / 减少指定范围的值</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">incr key					<span class="token comment">#key++</span>
incrby key increment		<span class="token comment">#key+increment</span>
incrbyfloat key increment	<span class="token comment">#对小数操作</span>
decr key					<span class="token comment">#key--</span>
decrby key increment		<span class="token comment">#key-increment</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>设置数据具有指定的生命周期</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">setex key seconds value  		<span class="token comment">#设置key-value存活时间，seconds单位是秒</span>
psetex key milliseconds value	<span class="token comment">#毫秒级</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
</ul>
<p>注意事项：</p>
<ol>
<li>
<p>数据操作不成功的反馈与数据正常操作之间的差异</p>
<ul>
<li>
<p>表示运行结果是否成功 (integer) 0 → false 失败</p>
<p>(integer) 1 → true 成功</p>
</li>
<li>
<p>表示运行结果值 (integer) 3 → 3 3 个</p>
<p>(integer) 1 → 1 1 个</p>
</li>
</ul>
</li>
<li>
<p>数据未获取到时，对应的数据为（nil），等同于 null</p>
</li>
<li>
<p><strong>数据最大存储量</strong>：512MB</p>
</li>
<li>
<p>string 在 redis 内部存储默认就是一个字符串，当遇到增减类操作 incr，decr 时<strong>会转成数值型</strong>进行计算</p>
</li>
<li>
<p>按数值进行操作的数据，如果原始数据不能转成数值，或超越了 redis 数值上限范围，将报错 9223372036854775807（java 中 Long 型数据最大值，Long.MAX_VALUE）</p>
</li>
<li>
<p>redis 可用于控制数据库表主键 id，为数据库表主键提供生成策略，保障数据库表的主键唯一性</p>
</li>
</ol>
<p>单数据和多数据的选择：</p>
<ul>
<li>单数据执行 3 条指令的过程：3 次发送 + 3 次处理 + 3 次返回</li>
<li>多数据执行 1 条指令的过程：1 次发送 + 3 次处理 + 1 次返回（发送和返回的事件略高于单数据）</li>
</ul>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f737472696e67e58d95e695b0e68daee4b88ee5a49ae695b0e68daee6938de4bd9c2e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/ba8c1671bef3a40fef6f1f0d113fbe6d304d6df90ba279b9d60ad56f73b364f2/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f737472696e67e58d95e695b0e68daee4b88ee5a49ae695b0e68daee6938de4bd9c2e706e67">https://camo.githubusercontent.com/ba8c1671bef3a40fef6f1f0d113fbe6d304d6df90ba279b9d60ad56f73b364f2/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f737472696e67e58d95e695b0e68daee4b88ee5a49ae695b0e68daee6938de4bd9c2e706e67</a>)</p>
<hr>
<h4 id="-320"><a class="markdownIt-Anchor" href="#-320">#</a> <a href="#%E5%BA%94%E7%94%A8"></a>应用</h4>
<p>主页高频访问信息显示控制，例如新浪微博大 V 主页显示粉丝数与微博数量</p>
<ul>
<li>
<p>在 Redis 中为大 V 用户设定用户信息，以用户主键和属性值作为 key，后台设定定时刷新策略</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token builtin class-name">set</span> user:id:3506728370:fans <span class="token number">12210947</span>
<span class="token builtin class-name">set</span> user:id:3506728370:blogs <span class="token number">6164</span>
<span class="token builtin class-name">set</span> user:id:3506728370:focuses <span class="token number">83</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>使用 JSON 格式保存数据</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">user:id:3506728370 → <span class="token punctuation">&#123;</span><span class="token string">"fans"</span>:12210947,<span class="token string">"blogs"</span>:6164,<span class="token string">"focuses"</span>:83<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>key 的设置约定：表名：主键名：主键值：字段名</p>
<table>
<thead>
<tr>
<th>名</th>
<th>主键名</th>
<th>主键值</th>
<th>字段名</th>
</tr>
</thead>
<tbody>
<tr>
<td>rder</td>
<td>id</td>
<td>29437595</td>
<td>name</td>
</tr>
<tr>
<td>quip</td>
<td>id</td>
<td>390472345</td>
<td>type</td>
</tr>
<tr>
<td>ews</td>
<td>id</td>
<td>202004150</td>
<td>title</td>
</tr>
</tbody>
</table>
</li>
</ul>
<hr>
<h4 id="-321"><a class="markdownIt-Anchor" href="#-321">#</a> <a href="#%E5%AE%9E%E7%8E%B0"></a>实现</h4>
<p>Redis 字符串对象底层的数据结构实现主要是 int 和简单动态字符串 SDS，是可以修改的字符串，内部结构实现上类似于 Java 的 ArrayList，采用<strong>预分配冗余空间</strong>的方式来减少内存的频繁分配</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">sdshdr</span><span class="token punctuation">&#123;</span>
     <span class="token comment">//记录buf数组中已使用字节的数量</span>
     <span class="token comment">//等于 SDS 保存字符串的长度</span>
     <span class="token keyword">int</span> len<span class="token punctuation">;</span>
     <span class="token comment">//记录 buf 数组中未使用字节的数量</span>
     <span class="token keyword">int</span> free<span class="token punctuation">;</span>
     <span class="token comment">//字节数组，用于保存字符串</span>
     <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/74bf57b4c0ebdbd111f702121e26de203439cb5e881e0bde6db1f14d6197f126/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d737472696e672545362539352542302545362538442541452545372542422539332545362539452538342e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/74bf57b4c0ebdbd111f702121e26de203439cb5e881e0bde6db1f14d6197f126/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d737472696e672545362539352542302545362538442541452545372542422539332545362539452538342e706e67">https://camo.githubusercontent.com/74bf57b4c0ebdbd111f702121e26de203439cb5e881e0bde6db1f14d6197f126/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d737472696e672545362539352542302545362538442541452545372542422539332545362539452538342e706e67</a>)</p>
<p>内部为当前字符串实际分配的空间 capacity 一般要高于实际字符串长度 len，当字符串长度小于 1M 时，扩容都是双倍现有的空间，如果超过 1M，扩容时一次只会多扩 1M 的空间，需要注意的是字符串最大长度为 512M</p>
<p>详解请参考文章：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/hunternet/p/9957913.html">https://www.cnblogs.com/hunternet/p/9957913.html</a></p>
<hr>
<h3 id="-322"><a class="markdownIt-Anchor" href="#-322">#</a> <a href="#hash"></a>hash</h3>
<h4 id="-323"><a class="markdownIt-Anchor" href="#-323">#</a> <a href="#%E7%AE%80%E4%BB%8B-2"></a>简介</h4>
<p>数据存储需求：对一系列存储的数据进行编组，方便管理，典型应用存储对象信息</p>
<p>数据存储结构：一个存储空间保存多个键值对数据</p>
<p>hash 类型：底层使用<strong>哈希表</strong>结构实现数据存储</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f68617368e7bb93e69e84e59bbe2e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/cbb1d4dd26d9eb93ba656ba3f1808419ca5e1536496fae53803961e52b582c2f/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f68617368e7bb93e69e84e59bbe2e706e67">https://camo.githubusercontent.com/cbb1d4dd26d9eb93ba656ba3f1808419ca5e1536496fae53803961e52b582c2f/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f68617368e7bb93e69e84e59bbe2e706e67</a>)</p>
<p>Redis 中的 hash 类似于 Java 中的  <code>Map&lt;String, Map&lt;Object,object&gt;&gt;</code> ，左边是 key，右边是值，中间叫 field 字段，本质上 <strong>hash 存了一个 key-value 的存储空间</strong></p>
<p>hash 是指的一个数据类型，并不是一个数据</p>
<ul>
<li>如果 field 数量较少，存储结构优化为<strong>压缩列表结构</strong>（有序）</li>
<li>如果 field 数量较多，存储结构使用 HashMap 结构（无序）</li>
</ul>
<hr>
<h4 id="-324"><a class="markdownIt-Anchor" href="#-324">#</a> <a href="#%E6%93%8D%E4%BD%9C-1"></a>操作</h4>
<p>指令操作：</p>
<ul>
<li>
<p>数据操作</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">hset key field value		<span class="token comment">#添加/修改数据</span>
hdel key field1 <span class="token punctuation">[</span>field2<span class="token punctuation">]</span>	<span class="token comment">#删除数据，[]代表可选</span>
hsetnx key field value		<span class="token comment">#设置field的值，如果该field存在则不做任何操作</span>
hmset key f1 v1 f2 v2<span class="token punctuation">..</span>.	<span class="token comment">#添加/修改多个数据</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>查询操作</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">hget key field				<span class="token comment">#获取指定field对应数据</span>
hgetall key					<span class="token comment">#获取指定key所有数据</span>
hmget key field1 field2<span class="token punctuation">..</span>.	<span class="token comment">#获取多个数据</span>
hexists key field			<span class="token comment">#获取哈希表中是否存在指定的字段</span>
hlen key					<span class="token comment">#获取哈希表中字段的数量</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>获取哈希表中所有的字段名或字段值</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">hkeys key					<span class="token comment">#获取所有的field	</span>
hvals key					<span class="token comment">#获取所有的value</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li>
<p>设置指定字段的数值数据增加指定范围的值</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">hincrby key field increment		<span class="token comment">#指定字段的数值数据增加指定的值，increment为负数则减少</span>
hincrbyfloat key field increment<span class="token comment">#操作小数</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
</ul>
<p>注意事项</p>
<ol>
<li>hash 类型中 value 只能存储字符串，不允许存储其他数据类型，不存在嵌套现象，如果数据未获取到，对应的值为（nil）</li>
<li>每个 hash 可以存储 2^32 - 1 个键值对</li>
<li>hash 类型和对象的数据存储形式相似，并且可以灵活添加删除对象属性。但 hash 设计初衷不是为了存储大量对象而设计的，不可滥用，不可将 hash 作为对象列表使用</li>
<li>hgetall 操作可以获取全部属性，如果内部 field 过多，遍历整体数据效率就很会低，有可能成为数据访问瓶颈</li>
</ol>
<hr>
<h4 id="-325"><a class="markdownIt-Anchor" href="#-325">#</a> <a href="#%E5%BA%94%E7%94%A8-1"></a>应用</h4>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">user:id:3506728370 → <span class="token punctuation">&#123;</span><span class="token string">"name"</span><span class="token builtin class-name">:</span><span class="token string">"春晚"</span>,<span class="token string">"fans"</span>:12210862,<span class="token string">"blogs"</span>:83<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>对于以上数据，使用单条去存的话，存的条数会很多。但如果用 json 格式，存一条数据就够了。</p>
<p>假如现在粉丝数量发生了变化，要把整个值都改变，但是用单条存就不存在这个问题，只需要改其中一个就可以</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f68617368e5ba94e794a8e59cbae699afe7bb93e69e84e59bbe2e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/fe8dd3e1b6da2bd409c54a2cf5524c093e0f3d9b4fd1fc8a4dcdbc897c0d11a5/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f68617368e5ba94e794a8e59cbae699afe7bb93e69e84e59bbe2e706e67">https://camo.githubusercontent.com/fe8dd3e1b6da2bd409c54a2cf5524c093e0f3d9b4fd1fc8a4dcdbc897c0d11a5/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f68617368e5ba94e794a8e59cbae699afe7bb93e69e84e59bbe2e706e67</a>)</p>
<p>可以实现购物车的功能，key 对应着每个用户，存储空间存储购物车的信息</p>
<hr>
<h4 id="-326"><a class="markdownIt-Anchor" href="#-326">#</a> <a href="#%E5%AE%9E%E7%8E%B0-1"></a>实现</h4>
<h5 id="-327"><a class="markdownIt-Anchor" href="#-327">#</a> <a href="#%E5%BA%95%E5%B1%82%E7%BB%93%E6%9E%84"></a>底层结构</h5>
<p>哈希类型的内部编码有两种：ziplist（压缩列表）、hashtable（哈希表、字典）</p>
<p>当存储的数据量比较小的情况下，Redis 才使用压缩列表来实现字典类型，具体需要满足两个条件：</p>
<ul>
<li>当键值对个数小于 hash-max-ziplist-entries 配置（默认 512 个）</li>
<li>所有键值都小于 hash-max-ziplist-value 配置（默认 64 字节）</li>
</ul>
<p>ziplist 使用更加紧凑的结构实现多个元素的连续存储，所以在节省内存方面比 hashtable 更加优秀，当 ziplist 无法满足哈希类型时，Redis 会使用 hashtable 作为哈希的内部实现，因为此时 ziplist 的读写效率会下降，而 hashtable 的读写时间复杂度为 O (1)</p>
<hr>
<h5 id="-328"><a class="markdownIt-Anchor" href="#-328">#</a> <a href="#%E5%8E%8B%E7%BC%A9%E5%88%97%E8%A1%A8"></a>压缩列表</h5>
<p>压缩列表（ziplist）是列表和哈希的底层实现之一，压缩列表用来紧凑数据存储，节省内存，有序：</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732de58e8be7bca9e58897e8a1a8e695b0e68daee7bb93e69e842e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/f4f275cf29a89b8e072108fba7222b263398a961cd0a264c7e78ad023d2d49cd/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732de58e8be7bca9e58897e8a1a8e695b0e68daee7bb93e69e842e706e67">https://camo.githubusercontent.com/f4f275cf29a89b8e072108fba7222b263398a961cd0a264c7e78ad023d2d49cd/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732de58e8be7bca9e58897e8a1a8e695b0e68daee7bb93e69e842e706e67</a>)</p>
<p>压缩列表是由一系列特殊编码的连续内存块组成的顺序型（sequential）数据结枃，一个压缩列表可以包含任意多个节点（entry），每个节点可以保存一个字节数组或者一个整数值</p>
<hr>
<h5 id="-329"><a class="markdownIt-Anchor" href="#-329">#</a> <a href="#%E5%93%88%E5%B8%8C%E8%A1%A8"></a>哈希表</h5>
<p>Redis 字典使用散列表为底层实现，一个散列表里面有多个散列表节点，每个散列表节点就保存了字典中的一个键值对，发生哈希冲突采用链表法解决，存储无序</p>
<ul>
<li>为了避免散列表性能的下降，当装载因子大于 1 的时候，Redis 会触发扩容，将散列表扩大为原来大小的 2 倍左右</li>
<li>当数据动态减少之后，为了节省内存，当装载因子小于 0.1 的时候，Redis 就会触发缩容，缩小为字典中数据个数的 50 % 左右</li>
</ul>
<hr>
<h3 id="-330"><a class="markdownIt-Anchor" href="#-330">#</a> <a href="#list"></a>list</h3>
<h4 id="-331"><a class="markdownIt-Anchor" href="#-331">#</a> <a href="#%E7%AE%80%E4%BB%8B-3"></a>简介</h4>
<p>数据存储需求：存储多个数据，并对数据进入存储空间的顺序进行区分</p>
<p>数据存储结构：一个存储空间保存多个数据，且通过数据可以体现进入顺序，允许重复元素</p>
<p>list 类型：保存多个数据，底层使用<strong>双向链表</strong>存储结构实现，类似于 LinkedList</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f6c697374e7bb93e69e84e59bbe2e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/3381099a7e1aee13b0deb4efc658a6796614be5dc3b36781a99339278f511d13/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f6c697374e7bb93e69e84e59bbe2e706e67">https://camo.githubusercontent.com/3381099a7e1aee13b0deb4efc658a6796614be5dc3b36781a99339278f511d13/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f6c697374e7bb93e69e84e59bbe2e706e67</a>)</p>
<p>如果两端都能存取数据的话，这就是双端队列，如果只能从一端进一端出，这个模型叫栈</p>
<hr>
<h4 id="-332"><a class="markdownIt-Anchor" href="#-332">#</a> <a href="#%E6%93%8D%E4%BD%9C-2"></a>操作</h4>
<p>指令操作：</p>
<ul>
<li>
<p>数据操作</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">lpush key value1 <span class="token punctuation">[</span>value2<span class="token punctuation">]</span><span class="token punctuation">..</span>.<span class="token comment">#从左边添加/修改数据</span>
rpush key value1 <span class="token punctuation">[</span>value2<span class="token punctuation">]</span><span class="token punctuation">..</span>.<span class="token comment">#从右边添加/修改数据</span>
lpop key					<span class="token comment">#从左边获取并移除第一个数据，类似于出栈/出队</span>
rpop key					<span class="token comment">#从右边获取并移除第一个数据</span>
lrem key count value		<span class="token comment">#删除指定数据，count=2删除2个，该value可能有多个(重复数据)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>查询操作</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">lrange key start stop		<span class="token comment">#从左边遍历数据并指定开始和结束索引，0是第一个索引，-1是终索引</span>
lindex key index			<span class="token comment">#获取指定索引数据，没有则为nil，没有索引越界</span>
llen key					<span class="token comment">#list中数据长度/个数</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>规定时间内获取并移除数据</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">b							<span class="token comment">#代表阻塞</span>
blpop key1 <span class="token punctuation">[</span>key2<span class="token punctuation">]</span> <span class="token function">timeout</span>	<span class="token comment">#在指定时间内获取指定key(可以多个)的数据，超时则为(nil)</span>
							<span class="token comment">#可以从其他客户端写数据，当前客户端阻塞读取数据</span>
brpop key1 <span class="token punctuation">[</span>key2<span class="token punctuation">]</span> <span class="token function">timeout</span>	<span class="token comment">#从右边操作</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>复制操作</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">brpoplpush <span class="token builtin class-name">source</span> destination <span class="token function">timeout</span>	<span class="token comment">#从source获取数据放入destination，假如在指定时间内没有任何元素被弹出，则返回一个nil和等待时长。反之，返回一个含有两个元素的列表，第一个元素是被弹出元素的值，第二个元素是等待时长</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<p>注意事项</p>
<ol>
<li>list 中保存的数据都是 string 类型的，数据总容量是有限的，最多 2^32 - 1 个元素（4294967295）</li>
<li>list 具有索引的概念，但操作数据时通常以队列的形式进行入队出队，或以栈的形式进行入栈出栈</li>
<li>获取全部数据操作结束索引设置为 -1</li>
<li>list 可以对数据进行分页操作，通常第一页的信息来自于 list，第 2 页及更多的信息通过数据库的形式加载</li>
</ol>
<hr>
<h4 id="-333"><a class="markdownIt-Anchor" href="#-333">#</a> <a href="#%E5%BA%94%E7%94%A8-2"></a>应用</h4>
<p>企业运营过程中，系统将产生出大量的运营数据，如何保障多台服务器操作日志的统一顺序输出？</p>
<ul>
<li>依赖 list 的数据具有顺序的特征对信息进行管理，右进左查或者左近左查</li>
<li>使用队列模型解决多路信息汇总合并的问题</li>
<li>使用栈模型解决最新消息的问题</li>
</ul>
<p>微信文章订阅公众号：</p>
<ul>
<li>比如订阅了两个公众号，它们发布了两篇文章，文章 ID 分别为 666 和 888，可以通过执行  <code>LPUSH key 666 888</code>  命令推送给我</li>
</ul>
<hr>
<h4 id="-334"><a class="markdownIt-Anchor" href="#-334">#</a> <a href="#%E5%AE%9E%E7%8E%B0-2"></a>实现</h4>
<h5 id="-335"><a class="markdownIt-Anchor" href="#-335">#</a> <a href="#%E5%BA%95%E5%B1%82%E7%BB%93%E6%9E%84-1"></a>底层结构</h5>
<p>在 Redis3.2 版本以前列表类型的内部编码有两种：ziplist（压缩列表）和 linkedlist（链表）</p>
<p>列表中存储的数据量比较小的时候，列表就会使用一块连续的内存存储，采用压缩列表的方式实现：</p>
<ul>
<li>列表中保存的单个数据（有可能是字符串类型的）小于 64 字节</li>
<li>列表中数据个数少于 512 个</li>
</ul>
<p>在 Redis3.2 版本 以后对列表数据结构进行了改造，使用 **quicklist（快速列表）** 代替了 linkedlist</p>
<hr>
<h5 id="-336"><a class="markdownIt-Anchor" href="#-336">#</a> <a href="#%E9%93%BE%E8%A1%A8%E7%BB%93%E6%9E%84"></a>链表结构</h5>
<p>Redis 链表为<strong>双向无环链表</strong>，使用 listNode 结构表示</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">listNode</span>
<span class="token punctuation">&#123;</span> 
	<span class="token comment">// 前置节点 </span>
	<span class="token keyword">struct</span> <span class="token class-name">listNode</span> <span class="token operator">*</span>prev<span class="token punctuation">;</span> 
	<span class="token comment">// 后置节点 </span>
	<span class="token keyword">struct</span> <span class="token class-name">listNode</span> <span class="token operator">*</span>next<span class="token punctuation">;</span> 
	<span class="token comment">// 节点的值 </span>
	<span class="token keyword">void</span> <span class="token operator">*</span>value<span class="token punctuation">;</span> 
<span class="token punctuation">&#125;</span> listNode<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/09e8f083ae935ed33352a065809d2be417be5f0ce14b4cb2bd85e0ebdf3b23bd/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d2545392539332542452545382541312541382545362539352542302545362538442541452545372542422539332545362539452538342e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/09e8f083ae935ed33352a065809d2be417be5f0ce14b4cb2bd85e0ebdf3b23bd/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d2545392539332542452545382541312541382545362539352542302545362538442541452545372542422539332545362539452538342e706e67">https://camo.githubusercontent.com/09e8f083ae935ed33352a065809d2be417be5f0ce14b4cb2bd85e0ebdf3b23bd/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d2545392539332542452545382541312541382545362539352542302545362538442541452545372542422539332545362539452538342e706e67</a>)</p>
<ul>
<li>双向：链表节点带有前驱、后继指针，获取某个节点的前驱、后继节点的时间复杂度为 O (1)</li>
<li>无环：链表为非循环链表，表头节点的前驱指针和表尾节点的后继指针都指向 NULL，对链表的访问以 NULL 为终点</li>
</ul>
<hr>
<h5 id="-337"><a class="markdownIt-Anchor" href="#-337">#</a> <a href="#%E5%BF%AB%E9%80%9F%E5%88%97%E8%A1%A8"></a>快速列表</h5>
<p>quicklist 实际上是 ziplist 和 linkedlist 的混合体，将 linkedlist 按段切分，每一段使用 ziplist 来紧凑存储，多个 ziplist 之间使用双向指针串接起来，既满足了快速的插入删除性能，又不会出现太大的空间冗余</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/230c4f12c0aaf592b769749f5d4c1e62a8d56c66d3509230bf47633d387f3d60/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732de5bfabe9809fe58897e8a1a8e695b0e68daee7bb93e69e842e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/230c4f12c0aaf592b769749f5d4c1e62a8d56c66d3509230bf47633d387f3d60/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732de5bfabe9809fe58897e8a1a8e695b0e68daee7bb93e69e842e706e67">https://camo.githubusercontent.com/230c4f12c0aaf592b769749f5d4c1e62a8d56c66d3509230bf47633d387f3d60/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732de5bfabe9809fe58897e8a1a8e695b0e68daee7bb93e69e842e706e67</a>)</p>
<hr>
<h3 id="-338"><a class="markdownIt-Anchor" href="#-338">#</a> <a href="#set"></a>set</h3>
<h4 id="-339"><a class="markdownIt-Anchor" href="#-339">#</a> <a href="#%E7%AE%80%E4%BB%8B-4"></a>简介</h4>
<p>数据存储需求：存储大量的数据，在查询方面提供更高的效率</p>
<p>数据存储结构：能够保存大量的数据，高效的内部存储机制，便于查询</p>
<p>set 类型：与 hash 存储结构哈希表完全相同，只是仅存储键不存储值（nil），所以添加，删除，查找的复杂度都是 O (1)，并且<strong>值是不允许重复且无序的</strong></p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f736574e7bb93e69e84e59bbe2e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/76062244de5f2f6cc406be617b256cb2d3c9ab5a0818aa4a3542c3c6857cc532/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f736574e7bb93e69e84e59bbe2e706e67">https://camo.githubusercontent.com/76062244de5f2f6cc406be617b256cb2d3c9ab5a0818aa4a3542c3c6857cc532/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f736574e7bb93e69e84e59bbe2e706e67</a>)</p>
<hr>
<h4 id="-340"><a class="markdownIt-Anchor" href="#-340">#</a> <a href="#%E6%93%8D%E4%BD%9C-3"></a>操作</h4>
<p>指令操作：</p>
<ul>
<li>
<p>数据操作</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">sadd key member1 <span class="token punctuation">[</span>member2<span class="token punctuation">]</span>	<span class="token comment">#添加数据</span>
srem key member1 <span class="token punctuation">[</span>member2<span class="token punctuation">]</span>	<span class="token comment">#删除数据</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li>
<p>查询操作</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">smembers key				<span class="token comment">#获取全部数据</span>
scard key					<span class="token comment">#获取集合数据总量</span>
sismember key member		<span class="token comment">#判断集合中是否包含指定数据</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>随机操作</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">spop key <span class="token punctuation">[</span>count<span class="token punctuation">]</span>			<span class="token comment">#随机获取集中的某个数据并将该数据移除集合</span>
srandmember key <span class="token punctuation">[</span>count<span class="token punctuation">]</span>		<span class="token comment">#随机获取集合中指定(数量)的数据</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li>
<p>集合的交、并、差</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">sinter key1 <span class="token punctuation">[</span>key2<span class="token punctuation">..</span>.<span class="token punctuation">]</span>  					<span class="token comment">#两个集合的交集，不存在为(empty list or set)</span>
sunion key1 <span class="token punctuation">[</span>key2<span class="token punctuation">..</span>.<span class="token punctuation">]</span>  					<span class="token comment">#两个集合的并集</span>
<span class="token function">sdiff</span> key1 <span class="token punctuation">[</span>key2<span class="token punctuation">..</span>.<span class="token punctuation">]</span>					<span class="token comment">#两个集合的差集</span>

sinterstore destination key1 <span class="token punctuation">[</span>key2<span class="token punctuation">..</span>.<span class="token punctuation">]</span>	<span class="token comment">#两个集合的交集并存储到指定集合中</span>
sunionstore destination key1 <span class="token punctuation">[</span>key2<span class="token punctuation">..</span>.<span class="token punctuation">]</span>	<span class="token comment">#两个集合的并集并存储到指定集合中</span>
sdiffstore destination key1 <span class="token punctuation">[</span>key2<span class="token punctuation">..</span>.<span class="token punctuation">]</span>	<span class="token comment">#两个集合的差集并存储到指定集合中</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>复制</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">smove <span class="token builtin class-name">source</span> destination member			<span class="token comment">#将指定数据从原始集合中移动到目标集合中</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<p>注意事项</p>
<ol>
<li>set 类型不允许数据重复，如果添加的数据在 set 中已经存在，将只保留一份</li>
<li>set 虽然与 hash 的存储结构相同，但是无法启用 hash 中存储值的空间</li>
</ol>
<hr>
<h4 id="-341"><a class="markdownIt-Anchor" href="#-341">#</a> <a href="#%E5%BA%94%E7%94%A8-3"></a>应用</h4>
<p>应用场景：</p>
<ol>
<li>
<p>黑名单：资讯类信息类网站追求高访问量，但是由于其信息的价值，往往容易被不法分子利用，通过爬虫技术，快速获取信息，个别特种行业网站信息通过爬虫获取分析后，可以转换成商业机密。</p>
<p>注意：爬虫不一定做摧毁性的工作，有些小型网站需要爬虫为其带来一些流量。</p>
</li>
<li>
<p>白名单：对于安全性更高的应用访问，仅仅靠黑名单是不能解决安全问题的，此时需要设定可访问的用户群体， 依赖白名单做更为苛刻的访问验证</p>
</li>
<li>
<p>随机操作可以实现抽奖功能</p>
</li>
<li>
<p>集合的交并补可以实现微博共同关注的查看，可以根据共同关注或者共同喜欢推荐相关内容</p>
</li>
</ol>
<hr>
<h4 id="-342"><a class="markdownIt-Anchor" href="#-342">#</a> <a href="#%E5%AE%9E%E7%8E%B0-3"></a>实现</h4>
<p>集合类型的内部编码有两种：</p>
<ul>
<li>
<p>intset（整数集合）：当集合中的元素都是整数且元素个数小于 set-maxintset-entries 配置（默认 512 个）时，Redis 会选用 intset 来作为集合的内部实现，从而减少内存的使用</p>
</li>
<li>
<p>hashtable（哈希表，字典）：当无法满足 intset 条件时，Redis 会使用 hashtable 作为集合的内部实现</p>
</li>
</ul>
<p>整数集合（intset）是 Redis 用于保存整数值的集合抽象数据结构，可以保存类型为 int16_t、int32_t 或者 int64_t 的整数值，并且保证集合中的元素是<strong>有序不重复</strong>的</p>
<hr>
<h3 id="-343"><a class="markdownIt-Anchor" href="#-343">#</a> <a href="#sorted"></a>sorted</h3>
<h4 id="-344"><a class="markdownIt-Anchor" href="#-344">#</a> <a href="#%E7%AE%80%E4%BB%8B-5"></a>简介</h4>
<p>数据存储需求：数据排序有利于数据的有效展示，需要提供一种可以根据自身特征进行排序的方式</p>
<p>数据存储结构：新的存储模型，可以保存可排序的数据</p>
<p>sorted_set 类型：在 set 的存储结构基础上添加可排序字段，类似于 TreeSet</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/51b0684aa86f337fa98cf35341b715a744584abc636917187e78a858a3aa0bb5/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d736f727465645f736574e7bb93e69e84e59bbe2e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/51b0684aa86f337fa98cf35341b715a744584abc636917187e78a858a3aa0bb5/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d736f727465645f736574e7bb93e69e84e59bbe2e706e67">https://camo.githubusercontent.com/51b0684aa86f337fa98cf35341b715a744584abc636917187e78a858a3aa0bb5/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d736f727465645f736574e7bb93e69e84e59bbe2e706e67</a>)</p>
<hr>
<h4 id="-345"><a class="markdownIt-Anchor" href="#-345">#</a> <a href="#%E6%93%8D%E4%BD%9C-4"></a>操作</h4>
<p>指令操作：</p>
<ul>
<li>
<p>数据操作</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">zadd key score1 member1 <span class="token punctuation">[</span>score2 member2<span class="token punctuation">]</span>	<span class="token comment">#添加数据</span>
zrem key member <span class="token punctuation">[</span>member <span class="token punctuation">..</span>.<span class="token punctuation">]</span>				<span class="token comment">#删除数据</span>
zremrangebyrank key start stop 				<span class="token comment">#删除指定索引范围的数据</span>
zremrangebyscore key min max				<span class="token comment">#删除指定分数区间内的数据</span>
zscore key member							<span class="token comment">#获取指定值的分数</span>
zincrby key increment member				<span class="token comment">#指定值的分数增加increment</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>查询操作</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">zrange key start stop <span class="token punctuation">[</span>WITHSCORES<span class="token punctuation">]</span>		<span class="token comment">#获取指定范围的数据，升序，WITHSCORES 代表显示分数</span>
zrevrange key start stop <span class="token punctuation">[</span>WITHSCORES<span class="token punctuation">]</span>	<span class="token comment">#获取指定范围的数据，降序</span>

zrangebyscore key min max <span class="token punctuation">[</span>WITHSCORES<span class="token punctuation">]</span> <span class="token punctuation">[</span>LIMIT offset count<span class="token punctuation">]</span>	<span class="token comment">#按条件获取数据，从小到大</span>
zrevrangebyscore key max min <span class="token punctuation">[</span>WITHSCORES<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">..</span>.<span class="token punctuation">]</span>				<span class="token comment">#从大到小</span>

zcard key										<span class="token comment">#获取集合数据的总量</span>
zcount key min max								<span class="token comment">#获取指定分数区间内的数据总量</span>
zrank key member								<span class="token comment">#获取数据对应的索引（排名）升序</span>
zrevrank key member								<span class="token comment">#获取数据对应的索引（排名）降序</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>min 与 max 用于限定搜索查询的条件</li>
<li>start 与 stop 用于限定查询范围，作用于索引，表示开始和结束索引</li>
<li>offset 与 count 用于限定查询范围，作用于查询结果，表示开始位置和数据总量</li>
</ul>
</li>
<li>
<p>集合的交、并操作</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">zinterstore destination numkeys key <span class="token punctuation">[</span>key <span class="token punctuation">..</span>.<span class="token punctuation">]</span>	<span class="token comment">#两个集合的交集并存储到指定集合中</span>
zunionstore destination numkeys key <span class="token punctuation">[</span>key <span class="token punctuation">..</span>.<span class="token punctuation">]</span>	<span class="token comment">#两个集合的并集并存储到指定集合中</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
</ul>
<p>注意事项：</p>
<ol>
<li>score 保存的数据存储空间是 64 位，如果是整数范围是 -9007199254740992~9007199254740992</li>
<li>score 保存的数据也可以是一个双精度的 double 值，基于双精度浮点数的特征可能会丢失精度，慎重使用</li>
<li>sorted_set 底层存储还是基于 set 结构的，因此数据不能重复，如果重复添加相同的数据，score 值将被反复覆盖，保留最后一次修改的结果</li>
</ol>
<hr>
<h4 id="-346"><a class="markdownIt-Anchor" href="#-346">#</a> <a href="#%E5%BA%94%E7%94%A8-4"></a>应用</h4>
<ul>
<li>排行榜</li>
<li>对于基于时间线限定的任务处理，将处理时间记录为 score 值，利用排序功能区分处理的先后顺序</li>
<li>当任务或者消息待处理，形成了任务队列或消息队列时，对于高优先级的任务要保障对其优先处理，采用 score 记录权重</li>
</ul>
<hr>
<h4 id="-347"><a class="markdownIt-Anchor" href="#-347">#</a> <a href="#%E5%AE%9E%E7%8E%B0-4"></a>实现</h4>
<h5 id="-348"><a class="markdownIt-Anchor" href="#-348">#</a> <a href="#%E5%BA%95%E5%B1%82%E7%BB%93%E6%9E%84-2"></a>底层结构</h5>
<p>有序集合是由 ziplist（压缩列表）或 skiplist（跳跃表）组成的</p>
<p>当数据比较少时，有序集合使用的是 ziplist 存储的，使用 ziplist 格式存储需要满足以下两个条件：</p>
<ul>
<li>有序集合保存的元素个数要小于 128 个；</li>
<li>有序集合保存的所有元素大小都小于 64 字节</li>
</ul>
<p>当元素比较多时，此时 ziplist 的读写效率会下降，时间复杂度是 O (n)，跳表的时间复杂度是 O (logn)</p>
<hr>
<h5 id="-349"><a class="markdownIt-Anchor" href="#-349">#</a> <a href="#%E8%B7%B3%E8%B7%83%E8%A1%A8"></a>跳跃表</h5>
<p>Redis 使用跳跃表作为有序集合键的底层实现之一，如果一个有序集合包含的<strong>元素数量比较多</strong>，又或者有序集合中元素的<strong>成员是比较长的字符串</strong>时，Redis 就会使用跳跃表来作为有序集合健的底层实现</p>
<p>跳跃表在链表的基础上增加了多级索引以提升查找的效率，索引是占内存的，所以是一个<strong>空间换时间</strong>的方案。原始链表中存储的有可能是很大的对象，而索引结点只需要存储关键值和几个指针，并不需要存储对象，因此当节点本身比较大或者元素数量比较多的时候，其优势可以被放大，而缺点则可以忽略</p>
<ul>
<li>
<p>基于单向链表加索引的方式实现</p>
</li>
<li>
<p>Redis 的跳跃表实现由 zskiplist 和 zskiplistnode 两个结构组成，其中 zskiplist 用于保存跳跃表信息（比如表头节点、表尾节点、长度），而 zskiplistnode 则用于表示跳跃表节点</p>
</li>
<li>
<p>Redis 每个跳跃表节点的层高都是 1 至 32 之间的随机数（Redis5 之后最大层数为 64）</p>
</li>
<li>
<p>在同一个跳跃表中，多个节点可以包含相同的分值，但每个节点的成员对象必须是唯一的。跳跃表中的节点按照分值大小进行排序，当分值相同时节点按照成员对象的大小进行排序</p>
</li>
</ul>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/f4209cf2b531a300ec2923a00085603f0e7b1214286648f5f5fa7e1c8b77841c/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d2545382542372542332545382542372538332545382541312541382545362539352542302545362538442541452545372542422539332545362539452538342e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/f4209cf2b531a300ec2923a00085603f0e7b1214286648f5f5fa7e1c8b77841c/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d2545382542372542332545382542372538332545382541312541382545362539352542302545362538442541452545372542422539332545362539452538342e706e67">https://camo.githubusercontent.com/f4209cf2b531a300ec2923a00085603f0e7b1214286648f5f5fa7e1c8b77841c/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d2545382542372542332545382542372538332545382541312541382545362539352542302545362538442541452545372542422539332545362539452538342e706e67</a>)</p>
<p>个人笔记：JUC → 并发包 → ConcurrentSkipListMap 详解跳跃表</p>
<p>参考文章：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/hunternet/p/11248192.html">https://www.cnblogs.com/hunternet/p/11248192.html</a></p>
<hr>
<h3 id="-350"><a class="markdownIt-Anchor" href="#-350">#</a> <a href="#bitmaps"></a>Bitmaps</h3>
<h4 id="-351"><a class="markdownIt-Anchor" href="#-351">#</a> <a href="#%E6%93%8D%E4%BD%9C-5"></a>操作</h4>
<p>Bitmaps 本身不是一种数据类型， 实际上就是字符串（key-value） ， 但是它可以对字符串的位进行操作</p>
<p>数据结构的详解查看 Java → Algorithm → 位图</p>
<p>指令操作：</p>
<ul>
<li>
<p>获取指定 key 对应<strong>偏移量</strong>上的 bit 值</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">getbit key offset<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>设置指定 key 对应偏移量上的 bit 值，value 只能是 1 或 0</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">setbit key offset value<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>对指定 key 按位进行交、并、非、异或操作，并将结果保存到 destKey 中</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">bitop option destKey key1 <span class="token punctuation">[</span>key2<span class="token punctuation">..</span>.<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>option：and 交、or 并、not 非、xor 异或</p>
</li>
<li>
<p>统计指定 key 中 1 的数量</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">bitcount key <span class="token punctuation">[</span>start end<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<hr>
<h4 id="-352"><a class="markdownIt-Anchor" href="#-352">#</a> <a href="#%E5%BA%94%E7%94%A8-5"></a>应用</h4>
<ul>
<li>
<p>解决 Redis 缓存穿透，判断给定数据是否存在， 防止缓存穿透</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d4269746d617073e5ba94e794a8e4b98be7bc93e5ad98e7a9bfe9808f2e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/410a69368e6ed8e54f934df2523a436ccd22c21c004211eb6c71a06034c0a39c/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d4269746d617073e5ba94e794a8e4b98be7bc93e5ad98e7a9bfe9808f2e706e67">https://camo.githubusercontent.com/410a69368e6ed8e54f934df2523a436ccd22c21c004211eb6c71a06034c0a39c/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d4269746d617073e5ba94e794a8e4b98be7bc93e5ad98e7a9bfe9808f2e706e67</a>)</p>
</li>
<li>
<p>垃圾邮件过滤，对每一个发送邮件的地址进行判断是否在布隆的黑名单中，如果在就判断为垃圾邮件</p>
</li>
<li>
<p>爬虫去重，爬给定网址的时候对已经爬取过的 URL 去重</p>
</li>
<li>
<p>信息状态统计</p>
</li>
</ul>
<hr>
<h3 id="-353"><a class="markdownIt-Anchor" href="#-353">#</a> <a href="#hyper"></a>Hyper</h3>
<p>基数是数据集去重后元素个数，HyperLogLog 是用来做基数统计的，运用了 LogLog 的算法</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">&#125;</span> 	基数集： <span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span> <span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">&#125;</span> 	基数：<span class="token number">5</span>
<span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">&#125;</span> 	基数集： <span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">&#125;</span> 				基数：<span class="token number">2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>相关指令：</p>
<ul>
<li>
<p>添加数据</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">pfadd key element <span class="token punctuation">[</span>element <span class="token punctuation">..</span>.<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>统计数据</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">pfcount key <span class="token punctuation">[</span>key <span class="token punctuation">..</span>.<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>合并数据</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">pfmerge destkey sourcekey <span class="token punctuation">[</span>sourcekey<span class="token punctuation">..</span>.<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<p>应用场景：</p>
<ul>
<li>用于进行基数统计，不是集合不保存数据，只记录数量而不是具体数据，比如网站的访问量</li>
<li>核心是基数估算算法，最终数值存在一定误差</li>
<li>误差范围：基数估计的结果是一个带有 0.81% 标准错误的近似值</li>
<li>耗空间极小，每个 hyperloglog key 占用了 12K 的内存用于标记基数</li>
<li>pfadd 命令不是一次性分配 12K 内存使用，会随着基数的增加内存逐渐增大</li>
<li>Pfmerge 命令合并后占用的存储空间为 12K，无论合并之前数据量多少</li>
</ul>
<hr>
<h3 id="-354"><a class="markdownIt-Anchor" href="#-354">#</a> <a href="#geo"></a>GEO</h3>
<p>GeoHash 是一种地址编码方法，把二维的空间经纬度数据编码成一个字符串</p>
<ul>
<li>
<p>添加坐标点</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">geoadd key longitude latitude member <span class="token punctuation">[</span>longitude latitude member <span class="token punctuation">..</span>.<span class="token punctuation">]</span>
georadius key longitude latitude radius m<span class="token operator">|</span>km<span class="token operator">|</span>ft<span class="token operator">|</span>mi <span class="token punctuation">[</span>withcoord<span class="token punctuation">]</span> <span class="token punctuation">[</span>withdist<span class="token punctuation">]</span> <span class="token punctuation">[</span>withhash<span class="token punctuation">]</span> <span class="token punctuation">[</span>count count<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li>
<p>获取坐标点</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">geopos key member <span class="token punctuation">[</span>member <span class="token punctuation">..</span>.<span class="token punctuation">]</span>
georadiusbymember key member radius m<span class="token operator">|</span>km<span class="token operator">|</span>ft<span class="token operator">|</span>mi <span class="token punctuation">[</span>withcoord<span class="token punctuation">]</span> <span class="token punctuation">[</span>withdist<span class="token punctuation">]</span> <span class="token punctuation">[</span>withhash<span class="token punctuation">]</span> <span class="token punctuation">[</span>count count<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li>
<p>计算距离</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">geodist key member1 member2 <span class="token punctuation">[</span>unit<span class="token punctuation">]</span>	<span class="token comment">#计算坐标点距离</span>
geohash key member <span class="token punctuation">[</span>member <span class="token punctuation">..</span>.<span class="token punctuation">]</span>		<span class="token comment">#计算经纬度</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
</ul>
<p>redis 应用于地理位置计算</p>
<hr>
<h2 id="-355"><a class="markdownIt-Anchor" href="#-355">#</a> <a href="#jedis"></a>Jedis</h2>
<h3 id="-356"><a class="markdownIt-Anchor" href="#-356">#</a> <a href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"></a>基本使用</h3>
<p>Jedis 用于 Java 语言连接 redis 服务，并提供对应的操作 API</p>
<ol>
<li>
<p>jar 包导入</p>
<ul>
<li>
<p>下载地址：<a target="_blank" rel="noopener" href="https://mvnrepository.com/artifact/redis.clients/jedis">https://mvnrepository.com/artifact/redis.clients/jedis</a></p>
</li>
<li>
<p>基于 maven：</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>redis.clients<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>jedis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.9.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
</li>
<li>
<p>客户端连接 redis API 文档：<a target="_blank" rel="noopener" href="http://xetorthio.github.io/jedis/">http://xetorthio.github.io/jedis/</a></p>
<p>连接 redis： <code>Jedis jedis = new Jedis(&quot;192.168.0.185&quot;, 6379);</code>  操作 redis： <code>jedis.set(&quot;name&quot;, &quot;seazean&quot;); jedis.get(&quot;name&quot;);</code>  关闭 redis： <code>jedis.close();</code></p>
</li>
</ol>
<p>代码实现：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JedisTest</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//1.获取连接对象</span>
        <span class="token class-name">Jedis</span> jedis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jedis</span><span class="token punctuation">(</span><span class="token string">"192.168.2.185"</span><span class="token punctuation">,</span><span class="token number">6379</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//2.执行操作</span>
        jedis<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">,</span><span class="token string">"39"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> hello <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hello<span class="token punctuation">)</span><span class="token punctuation">;</span>
        jedis<span class="token punctuation">.</span><span class="token function">lpush</span><span class="token punctuation">(</span><span class="token string">"list1"</span><span class="token punctuation">,</span><span class="token string">"a"</span><span class="token punctuation">,</span><span class="token string">"b"</span><span class="token punctuation">,</span><span class="token string">"c"</span><span class="token punctuation">,</span><span class="token string">"d"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> list1 <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">lrange</span><span class="token punctuation">(</span><span class="token string">"list1"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token operator">:</span>list1 <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        jedis<span class="token punctuation">.</span><span class="token function">sadd</span><span class="token punctuation">(</span><span class="token string">"set1"</span><span class="token punctuation">,</span><span class="token string">"abc"</span><span class="token punctuation">,</span><span class="token string">"abc"</span><span class="token punctuation">,</span><span class="token string">"def"</span><span class="token punctuation">,</span><span class="token string">"poi"</span><span class="token punctuation">,</span><span class="token string">"cba"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Long</span> len <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">scard</span><span class="token punctuation">(</span><span class="token string">"set1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//3.关闭连接</span>
        jedis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<h3 id="-357"><a class="markdownIt-Anchor" href="#-357">#</a> <a href="#%E5%B7%A5%E5%85%B7%E7%B1%BB-2"></a>工具类</h3>
<p>连接池对象： JedisPool：Jedis 提供的连接池技术<br>
 poolConfig：连接池配置对象 host：redis 服务地址 port：redis 服务端口号</p>
<p>JedisPool 的构造器如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">JedisPool</span><span class="token punctuation">(</span><span class="token class-name">GenericObjectPoolConfig</span> poolConfig<span class="token punctuation">,</span> <span class="token class-name">String</span> host<span class="token punctuation">,</span> <span class="token keyword">int</span> port<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">this</span><span class="token punctuation">(</span>poolConfig<span class="token punctuation">,</span> host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<ul>
<li>
<p>创建配置文件 redis.properties</p>
<pre class="line-numbers language-ini" data-language="ini"><code class="language-ini"><span class="token key attr-name">redis.maxTotal</span><span class="token punctuation">=</span><span class="token value attr-value">50</span>
<span class="token key attr-name">redis.maxIdel</span><span class="token punctuation">=</span><span class="token value attr-value">10</span>
<span class="token key attr-name">redis.host</span><span class="token punctuation">=</span><span class="token value attr-value">192.168.2.185</span>
<span class="token key attr-name">redis.port</span><span class="token punctuation">=</span><span class="token value attr-value">6379</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>工具类：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JedisUtils</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> maxTotal<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> maxIdel<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> host<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> port<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">JedisPoolConfig</span> jpc<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">JedisPool</span> jp<span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ResourceBundle</span> bundle <span class="token operator">=</span> <span class="token class-name">ResourceBundle</span><span class="token punctuation">.</span><span class="token function">getBundle</span><span class="token punctuation">(</span><span class="token string">"redis"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//最大连接数</span>
        maxTotal <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>bundle<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"redis.maxTotal"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//活动连接数</span>
        maxIdel <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>bundle<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"redis.maxIdel"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        host <span class="token operator">=</span> bundle<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"redis.host"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        port <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>bundle<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"redis.port"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//Jedis连接配置</span>
        jpc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JedisPoolConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jpc<span class="token punctuation">.</span><span class="token function">setMaxTotal</span><span class="token punctuation">(</span>maxTotal<span class="token punctuation">)</span><span class="token punctuation">;</span>
        jpc<span class="token punctuation">.</span><span class="token function">setMaxIdle</span><span class="token punctuation">(</span>maxIdel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//连接池对象</span>
        jp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JedisPool</span><span class="token punctuation">(</span>jpc<span class="token punctuation">,</span> host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//对外访问接口，提供jedis连接对象，连接从连接池获取</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Jedis</span> <span class="token function">getJedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> jp<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<hr>
<h3 id="-358"><a class="markdownIt-Anchor" href="#-358">#</a> <a href="#%E5%8F%AF%E8%A7%86%E5%8C%96"></a>可视化</h3>
<p>Redis Desktop Manager</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/0745c36c5de683fc165d6eb61189af41c1b7785b92045eba2f4268659be1b292/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732de58fafe8a786e58c96e5b7a5e585b72e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/0745c36c5de683fc165d6eb61189af41c1b7785b92045eba2f4268659be1b292/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732de58fafe8a786e58c96e5b7a5e585b72e706e67">https://camo.githubusercontent.com/0745c36c5de683fc165d6eb61189af41c1b7785b92045eba2f4268659be1b292/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732de58fafe8a786e58c96e5b7a5e585b72e706e67</a>)</p>
<hr>
<h2 id="-359"><a class="markdownIt-Anchor" href="#-359">#</a> <a href="#%E6%8C%81%E4%B9%85%E5%8C%96"></a>持久化</h2>
<h3 id="-360"><a class="markdownIt-Anchor" href="#-360">#</a> <a href="#%E6%A6%82%E8%BF%B0-2"></a>概述</h3>
<p>持久化：利用永久性存储介质将数据进行保存，在特定的时间将保存的数据进行恢复的工作机制称为持久化</p>
<p>作用：持久化用于防止数据的意外丢失，确保数据安全性，因为 Redis 是内存级，所以需要持久化到磁盘</p>
<p>计算机中的数据全部都是二进制，保存一组数据有两种方式 [<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732de68c81e4b985e58c96e79a84e4b8a4e7a78de696b9e5bc8f2e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/9a5205d4f2473d4da7b3820a18a27ed51083f34dc09dfdee303240966593440c/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732de68c81e4b985e58c96e79a84e4b8a4e7a78de696b9e5bc8f2e706e67">https://camo.githubusercontent.com/9a5205d4f2473d4da7b3820a18a27ed51083f34dc09dfdee303240966593440c/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732de68c81e4b985e58c96e79a84e4b8a4e7a78de696b9e5bc8f2e706e67</a>)</p>
<p>第一种：将当前数据状态进行保存，快照形式，存储数据结果，存储格式简单</p>
<p>第二种：将数据的操作过程进行保存，日志形式，存储操作过程，存储格式复杂</p>
<hr>
<h3 id="-361"><a class="markdownIt-Anchor" href="#-361">#</a> <a href="#rdb"></a>RDB</h3>
<h4 id="-362"><a class="markdownIt-Anchor" href="#-362">#</a> <a href="#save"></a>save</h4>
<p>save 指令：手动执行一次保存操作</p>
<p>配置 redis.conf：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">dir</span> path				<span class="token comment">#设置存储.rdb文件的路径，通常设置成存储空间较大的目录中，目录名称data</span>
dbfilename <span class="token string">"x.rdb"</span>		<span class="token comment">#设置本地数据库文件名，默认值为dump.rdb，通常设置为dump-端口号.rdb</span>
rdbcompression <span class="token function">yes</span><span class="token operator">|</span>no	<span class="token comment">#设置存储至本地数据库时是否压缩数据，默认yes，设置为no节省CPU运行时间</span>
rdbchecksum <span class="token function">yes</span><span class="token operator">|</span>no		<span class="token comment">#设置读写文件过程是否进行RDB格式校验，默认yes，设置为no，节约读写10%时间</span>
						<span class="token comment">#消耗，但存在数据损坏的风险</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>工作原理：redis 是个<strong>单线程的工作模式</strong>，会创建一个任务队列，所有的命令都会进到这个队列排队执行。当某个指令在执行的时候，队列后面的指令都要等待，所以这种执行方式会非常耗时。</p>
<p>save 指令的执行会阻塞当前 Redis 服务器，直到当前 RDB 过程完成为止，有可能会造成长时间阻塞，线上环境不建议使用</p>
<hr>
<h4 id="-363"><a class="markdownIt-Anchor" href="#-363">#</a> <a href="#bgsave"></a>bgsave</h4>
<p>指令：bgsave（bg 是 background，后台执行的意思）</p>
<p>配置 redis.conf</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">stop-writes-on-bgsave-error <span class="token function">yes</span><span class="token operator">|</span>no	<span class="token comment">#后台存储过程中如果出现错误，是否停止保存操作，默认yes</span>
dbfilename filename  
<span class="token function">dir</span> path  
rdbcompression <span class="token function">yes</span><span class="token operator">|</span>no  
rdbchecksum <span class="token function">yes</span><span class="token operator">|</span>no<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>bgsave 指令工作原理：</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d6267736176652545352542372541352545342542442539432545352538452539462545372539302538362e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/b3541b529f5f1c2d68faa325b726eae5c78a4e4e9a83a63a33a8d78f69b04b76/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d6267736176652545352542372541352545342542442539432545352538452539462545372539302538362e706e67">https://camo.githubusercontent.com/b3541b529f5f1c2d68faa325b726eae5c78a4e4e9a83a63a33a8d78f69b04b76/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d6267736176652545352542372541352545342542442539432545352538452539462545372539302538362e706e67</a>)</p>
<p>流程：当执行 bgsave 的时候，客户端发出 bgsave 指令给到 redis 服务器，服务器返回后台已经开始执行的信息给客户端，同时使用 fork 函数创建一个子进程，让子进程去执行 save 相关的操作。持久化过程是先将数据写入到一个临时文件中，持久化操作结束再用这个临时文件<strong>替换</strong>上次持久化的文件，在这个过程中主进程是不进行任何 IO 操作的，这确保了极高的性能</p>
<p>bgsave 分成两个过程：第一个是服务端收到指令直接告诉客户端开始执行；另外一个过程是 fork 的子进程在完成后台的保存操作，操作完以后返回消息。<strong>两个进程不相互影响</strong>，所以在持久化期间 Redis 可以正常工作</p>
<p>注意：bgsave 命令是针对 save 阻塞问题做的优化，Redis 内部所有涉及到 RDB 操作都采用 bgsave 的方式，save 命令可以放弃使用</p>
<hr>
<h4 id="-364"><a class="markdownIt-Anchor" href="#-364">#</a> <a href="#%E8%87%AA%E5%8A%A8"></a>自动</h4>
<p>配置文件自动 RDB，无需显式调用相关指令，save 配置启动后底层执行的是 bgsave 操作</p>
<p>配置 redis.conf：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">save second changes <span class="token comment">#设置自动持久化条件，满足限定时间范围内key的变化数量就进行持久化(bgsave)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>参数：</p>
<ul>
<li>second：监控时间范围</li>
<li>changes：监控 key 的变化量</li>
</ul>
<p>说明： save 配置中对于 second 与 changes 设置通常具有互补对应关系，尽量不要设置成包含性关系</p>
<p>示例：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">save <span class="token number">300</span> <span class="token number">10</span>	<span class="token comment">#300s内10个key发生变化就进行持久化</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>判定 key 变化的原理：</p>
<ul>
<li>对数据产生了影响</li>
<li>不进行数据比对，比如 name 键存在，重新 set name seazean 也算一次变化</li>
</ul>
<p>save 配置要根据实际业务情况进行设置，频度过高或过低都会出现性能问题，结果可能是灾难性的</p>
<p>RDB 三种启动方式对比：</p>
<table>
<thead>
<tr>
<th>方式</th>
<th>save 指令</th>
<th>bgsave 指令</th>
</tr>
</thead>
<tbody>
<tr>
<td>读写</td>
<td>同步</td>
<td>异步</td>
</tr>
<tr>
<td>阻塞客户端指令</td>
<td>是</td>
<td>否</td>
</tr>
<tr>
<td>额外内存消耗</td>
<td>否</td>
<td>是</td>
</tr>
<tr>
<td>启动新进程</td>
<td>否</td>
<td>是</td>
</tr>
</tbody>
</table>
<hr>
<h4 id="-365"><a class="markdownIt-Anchor" href="#-365">#</a> <a href="#%E6%80%BB%E7%BB%93-1"></a>总结</h4>
<ul>
<li>
<p>RDB 特殊启动形式的指令（客户端输入）</p>
<ul>
<li>
<p>服务器运行过程中重启</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">debug reload<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>关闭服务器时指定保存数据</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">shutdown</span> save<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>默认情况下执行 shutdown 命令时，自动执行 bgsave（如果没有开启 AOF 持久化功能）</p>
</li>
<li>
<p>全量复制：主从复制部分详解</p>
</li>
</ul>
</li>
<li>
<p>RDB 优点：</p>
<ul>
<li>RDB 是一个紧凑压缩的二进制文件，存储效率较高，但存储数据量较大时，存储效率较低</li>
<li>RDB 内部存储的是 redis 在某个时间点的数据快照，非常<strong>适合用于数据备份，全量复制</strong>等场景</li>
<li>RDB 恢复数据的速度要比 AOF 快很多，因为是快照，直接恢复</li>
</ul>
</li>
<li>
<p>RDB 缺点：</p>
<ul>
<li>bgsave 指令每次运行要执行 fork 操作创建子进程，会牺牲一些性能</li>
<li>RDB 方式无论是执行指令还是利用配置，无法做到实时持久化，具有丢失数据的可能性，最后一次持久化后的数据可能丢失</li>
<li>Redis 的众多版本中未进行 RDB 文件格式的版本统一，可能出现各版本之间数据格式无法兼容</li>
</ul>
</li>
<li>
<p>应用：服务器中每 X 小时执行 bgsave 备份，并将 RDB 文件拷贝到远程机器中，用于灾难恢复</p>
</li>
</ul>
<hr>
<h3 id="-366"><a class="markdownIt-Anchor" href="#-366">#</a> <a href="#aof"></a>AOF</h3>
<h4 id="-367"><a class="markdownIt-Anchor" href="#-367">#</a> <a href="#%E6%A6%82%E8%BF%B0-3"></a>概述</h4>
<p>AOF（append only file）持久化：以独立日志的方式记录每次写命令（不记录读），<strong>增量保存</strong>，只许追加文件但不可以改写文件，重启时再重新执行 AOF 文件中命令达到恢复数据的目的，<strong>与 RDB 相比可以简单理解为由记录数据改为记录数据的变化</strong></p>
<p>AOF 主要作用是解决了数据持久化的实时性，目前已经是 Redis 持久化的主流方式</p>
<p>AOF 写数据过程： [<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d414f462545352542372541352545342542442539432545352538452539462545372539302538362e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/31a806b2c838f8840c52956395f1bf6f26aecddfd1cf66fdef4911af26bfc7b9/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d414f462545352542372541352545342542442539432545352538452539462545372539302538362e706e67">https://camo.githubusercontent.com/31a806b2c838f8840c52956395f1bf6f26aecddfd1cf66fdef4911af26bfc7b9/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d414f462545352542372541352545342542442539432545352538452539462545372539302538362e706e67</a>)</p>
<hr>
<h4 id="-368"><a class="markdownIt-Anchor" href="#-368">#</a> <a href="#%E7%AD%96%E7%95%A5"></a>策略</h4>
<p>客户端的请求写命令会被 append 追加到 AOF 缓冲区内</p>
<p>启动 AOF 基本配置：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">appendonly <span class="token function">yes</span><span class="token operator">|</span>no				<span class="token comment">#开启AOF持久化功能，默认no，即不开启状态</span>
appendfilename filename			<span class="token comment">#AOF持久化文件名，默认appendonly.aof，建议设置appendonly-端口号.aof</span>
<span class="token function">dir</span>								<span class="token comment">#AOF持久化文件保存路径，与RDB持久化文件路径保持一致即可</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">appendfsync always<span class="token operator">|</span>everysec<span class="token operator">|</span>no	<span class="token comment">#AOF写数据策略：默认为everysec</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>AOF 持久化数据的三种策略（appendfsync）：</p>
<ul>
<li>
<p>always（每次）：每次写入操作均同步到 AOF 文件中，<strong>数据零误差，性能较低</strong>，不建议使用。</p>
</li>
<li>
<p>everysec（每秒）：每秒将缓冲区中的指令同步到 AOF 文件中，在系统突然宕机的情况下丢失 1 秒内的数据 数据<strong>准确性较高，性能较高</strong>，建议使用，也是默认配置</p>
</li>
<li>
<p>no（系统控制）：由操作系统控制每次同步到 AOF 文件的周期，整体过程<strong>不可控</strong></p>
</li>
</ul>
<p><strong>AOF 缓冲区同步文件策略</strong>，系统调用 write 和 fsync：</p>
<ul>
<li>write 操作会触发延迟写（delayed write）机制，Linux 在内核提供页缓冲区用来提高硬盘 IO 性能，write 操作在写入系统缓冲区后直接返回</li>
<li>同步硬盘操作依赖于系统调度机制，比如缓冲区页空间写满或达到特定时间周期。同步文件之前，如果此时系统故障宕机，缓冲区内数据将丢失</li>
<li>fsync 针对单个文件操作（比如 AOF 文件）做强制硬盘同步，fsync 将阻塞到写入硬盘完成后返回，保证了数据持久化</li>
</ul>
<p>异常恢复：AOF 文件损坏，通过 redis-check-aof–fix appendonly.aof 进行恢复，重启 Redis，然后重新加载</p>
<hr>
<h4 id="-369"><a class="markdownIt-Anchor" href="#-369">#</a> <a href="#%E9%87%8D%E5%86%99"></a>重写</h4>
<h5 id="-370"><a class="markdownIt-Anchor" href="#-370">#</a> <a href="#%E4%BB%8B%E7%BB%8D"></a>介绍</h5>
<p>随着命令不断写入 AOF，文件会越来越大，为了解决这个问题 Redis 引入了 AOF 重写机制压缩文件体积</p>
<p>AOF 重写：将 Redis 进程内的数据转化为写命令同步到<strong>新</strong> AOF 文件的过程，简单说就是将对同一个数据的若干个条命令执行结果转化成最终结果数据对应的指令进行记录</p>
<p>AOF 重写作用：</p>
<ul>
<li>降低磁盘占用量，提高磁盘利用率</li>
<li>提高持久化效率，降低持久化写时间，提高 IO 性能</li>
<li>降低数据恢复的用时，提高数据恢复效率</li>
</ul>
<p>AOF 重写规则：</p>
<ul>
<li>
<p>进程内具有时效性的数据，并且数据已超时将不再写入文件</p>
</li>
<li>
<p>非写入类的无效指令将被忽略，只保留最终数据的写入命令</p>
<p>如 del key1、 hdel key2、srem key3、set key4 111、set key4 222 等，select 指令虽然不更改数据，但是更改了数据的存储位置，此类命令同样需要记录</p>
</li>
<li>
<p>对同一数据的多条写命令合并为一条命令</p>
<p>如 lpushlist1 a、lpush list1 b、lpush list1 c 可以转化为：lpush list1 a b c。</p>
<p>为防止数据量过大造成客户端缓冲区溢出，对 list、set、hash、zset 等类型，每条指令最多写入 64 个元素</p>
</li>
</ul>
<hr>
<h5 id="-371"><a class="markdownIt-Anchor" href="#-371">#</a> <a href="#%E6%96%B9%E5%BC%8F"></a>方式</h5>
<ul>
<li>
<p>手动重写</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">bgrewriteaof<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>原理分析：</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/7b2e1acb1b7c01858573e85f7d84f910ffb474ae75c245bafb4ffea9d0118342/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d414f462545362538392538422545352538412541382545392538372538442545352538362539392545352538452539462545372539302538362e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/7b2e1acb1b7c01858573e85f7d84f910ffb474ae75c245bafb4ffea9d0118342/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d414f462545362538392538422545352538412541382545392538372538442545352538362539392545352538452539462545372539302538362e706e67">https://camo.githubusercontent.com/7b2e1acb1b7c01858573e85f7d84f910ffb474ae75c245bafb4ffea9d0118342/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d414f462545362538392538422545352538412541382545392538372538442545352538362539392545352538452539462545372539302538362e706e67</a>)</p>
</li>
<li>
<p>自动重写</p>
<p>触发时机：Redis 会记录上次重写时的 AOF 大小，默认配置是当 AOF 文件大小是上次重写后大小的一倍且文件大于 64M 时触发</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">auto-aof-rewrite-min-size size		<span class="token comment">#设置重写的基准值，最小文件 64MB，达到这个值开始重写</span>
auto-aof-rewrite-percentage percent	<span class="token comment">#触发AOF文件执行重写的增长率，当前AOF文件大小超过上一次重写的AOF文件大小的百分之多少才会重写，比如文件达到 100% 时开始重写就是两倍时触发</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>自动重写触发比对参数（ 运行指令  <code>info Persistence</code>  获取具体信息 ）：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">aof_current_size					<span class="token comment">#AOF文件当前尺寸大小（单位:字节）</span>
aof_base_size						<span class="token comment">#AOF文件上次启动和重写时的尺寸大小（单位:字节）</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>自动重写触发条件公式：</p>
<ul>
<li>aof_current_size &gt; auto-aof-rewrite-min-size</li>
<li>(aof_current_size - aof_base_size) / aof_base_size &gt;= auto-aof-rewrite-percentage</li>
</ul>
</li>
</ul>
<hr>
<h4 id="-372"><a class="markdownIt-Anchor" href="#-372">#</a> <a href="#%E6%B5%81%E7%A8%8B"></a>流程</h4>
<p>持久化流程：</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/75149d7edcf9d7a784f8a3d712c6d5e10d3980e0a8e3b34888267808de3af797/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d414f46254539253837253844254535253836253939254536254235253831254537254138253842312e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/75149d7edcf9d7a784f8a3d712c6d5e10d3980e0a8e3b34888267808de3af797/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d414f46254539253837253844254535253836253939254536254235253831254537254138253842312e706e67">https://camo.githubusercontent.com/75149d7edcf9d7a784f8a3d712c6d5e10d3980e0a8e3b34888267808de3af797/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d414f46254539253837253844254535253836253939254536254235253831254537254138253842312e706e67</a>)</p>
<p>重写流程：</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d414f46254539253837253844254535253836253939254536254235253831254537254138253842322e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/e4d56ebdf8e65e627d739a216860f1ff8d4ebabaa0fcd2ab9df31dc398b37255/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d414f46254539253837253844254535253836253939254536254235253831254537254138253842322e706e67">https://camo.githubusercontent.com/e4d56ebdf8e65e627d739a216860f1ff8d4ebabaa0fcd2ab9df31dc398b37255/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d414f46254539253837253844254535253836253939254536254235253831254537254138253842322e706e67</a>)</p>
<p>使用<strong>新的 AOF 文件覆盖旧的 AOF 文件</strong>，完成 AOF 重写</p>
<hr>
<h3 id="-373"><a class="markdownIt-Anchor" href="#-373">#</a> <a href="#%E5%AF%B9%E6%AF%94"></a>对比</h3>
<p>AOF 和 RDB 同时开启，系统默认取 AOF 的数据（数据不会存在丢失）</p>
<p>RDB 与 AOF 对比：</p>
<table>
<thead>
<tr>
<th>持久化方式</th>
<th>RDB</th>
<th>AOF</th>
</tr>
</thead>
<tbody>
<tr>
<td>占用存储空间</td>
<td>小（数据级：压缩）</td>
<td>大（指令级：重写）</td>
</tr>
<tr>
<td><strong>存储速度</strong></td>
<td>慢</td>
<td>快</td>
</tr>
<tr>
<td><strong>恢复速度</strong></td>
<td>快</td>
<td>慢</td>
</tr>
<tr>
<td>数据安全性</td>
<td>会丢失数据</td>
<td>依据策略决定</td>
</tr>
<tr>
<td>资源消耗</td>
<td>高 / 重量级</td>
<td>低 / 轻量级</td>
</tr>
<tr>
<td>启动优先级</td>
<td>低</td>
<td>高</td>
</tr>
</tbody>
</table>
<p>应用场景：</p>
<ul>
<li>
<p>对数据<strong>非常敏感</strong>，建议使用默认的 AOF 持久化方案</p>
<p>AOF 持久化策略使用 everysecond，每秒钟 fsync 一次，该策略 redis 仍可以保持很好的处理性能，当出现问题时，最多丢失 1 秒内的数据</p>
<p>注意：AOF 文件存储体积较大，恢复速度较慢，因为要执行每条指令</p>
</li>
<li>
<p>数据呈现<strong>阶段有效性</strong>，建议使用 RDB 持久化方案</p>
<p>数据可以良好的做到阶段内无丢失，且恢复速度较快，阶段内数据恢复通常采用 RDB 方案</p>
<p>注意：利用 RDB 实现紧凑的数据持久化，存储数据量较大时，存储效率较低</p>
</li>
</ul>
<p>综合对比：</p>
<ul>
<li>RDB 与 AOF 的选择实际上是在做一种权衡，每种都有利有弊</li>
<li>如不能承受数分钟以内的数据丢失，对业务数据非常敏感，选用 AOF</li>
<li>如能承受数分钟以内的数据丢失，且追求大数据集的恢复速度，选用 RDB</li>
<li>灾难恢复选用 RDB</li>
<li>双保险策略，同时开启 RDB 和 AOF，重启后 Redis 优先使用 AOF 来恢复数据，降低丢失数据的量</li>
<li>不建议单独用 AOF，因为可能会出现 Bug，如果只是做纯内存缓存，可以都不用</li>
</ul>
<hr>
<h3 id="-374"><a class="markdownIt-Anchor" href="#-374">#</a> <a href="#fork"></a>fork</h3>
<h4 id="-375"><a class="markdownIt-Anchor" href="#-375">#</a> <a href="#%E4%BB%8B%E7%BB%8D-1"></a>介绍</h4>
<p>fork () 函数创建一个子进程，子进程与父进程几乎是完全相同的进程，系统先给子进程分配资源，然后把原来的进程的所有数据都复制到子进程中，只有少数值与父进程的值不同，相当于克隆了一个进程</p>
<p>在完成对其调用之后，会产生 2 个进程，且每个进程都会<strong>从 fork () 的返回处开始执行</strong>，这两个进程将执行相同的程序段，但是拥有各自不同的堆段，栈段，数据段，每个子进程都可修改各自的数据段，堆段，和栈段</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;unistd.h></span></span>
<span class="token class-name">pid_t</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 父进程返回子进程的pid，子进程返回0，错误返回负值，根据返回值的不同进行对应的逻辑处理</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>fork 调用一次，却能够<strong>返回两次</strong>，可能有三种不同的返回值：</p>
<ul>
<li>在父进程中，fork 返回新创建子进程的进程 ID</li>
<li>在子进程中，fork 返回 0</li>
<li>如果出现错误，fork 返回一个负值，错误原因：
<ul>
<li>当前的进程数已经达到了系统规定的上限，这时 errno 的值被设置为 EAGAIN</li>
<li>系统内存不足，这时 errno 的值被设置为 ENOMEM</li>
</ul>
</li>
</ul>
<p>fpid 的值在父子进程中不同：进程形成了链表，父进程的 fpid 指向子进程的进程 id，因为子进程没有子进程，所以其 fpid 为 0</p>
<p>创建新进程成功后，系统中出现两个基本完全相同的进程，这两个进程执行没有固定的先后顺序，哪个进程先执行要看系统的调度策略</p>
<p>每个进程都有一个独特（互不相同）的进程标识符 process ID，可以通过 getpid () 函数获得；还有一个记录父进程 pid 的变量，可以通过 getppid () 函数获得变量的值</p>
<hr>
<h4 id="-376"><a class="markdownIt-Anchor" href="#-376">#</a> <a href="#%E4%BD%BF%E7%94%A8"></a>使用</h4>
<p>基本使用：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span>  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span>   </span>
<span class="token keyword">int</span> <span class="token function">main</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>   
<span class="token punctuation">&#123;</span>   
    <span class="token class-name">pid_t</span> fpid<span class="token punctuation">;</span> <span class="token comment">// fpid表示fork函数返回的值  </span>
    <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  
    fpid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fpid <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>   
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"error in fork!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>fpid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"i am the child process, my process id is %d/n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
        count<span class="token operator">++</span><span class="token punctuation">;</span>  
    <span class="token punctuation">&#125;</span>  
    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>  
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"i am the parent process, my process id is %d/n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
        count<span class="token operator">++</span><span class="token punctuation">;</span>  
    <span class="token punctuation">&#125;</span>  
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"count: %d/n"</span><span class="token punctuation">,</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 1  </span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  
<span class="token punctuation">&#125;</span>  
<span class="token comment">/*输出内容：
    i am the child process, my process id is 5574
    count: 1
    i am the parent process, my process id is 5573
    count: 1
*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>进阶使用：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span>  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span>  </span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>  
<span class="token punctuation">&#123;</span>  
   <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  
   <span class="token comment">// ppid 指当前进程的父进程pid  </span>
   <span class="token comment">// pid 指当前进程的pid,  </span>
   <span class="token comment">// fpid 指fork返回给当前进程的值，在这可以表示子进程</span>
   <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  
       <span class="token class-name">pid_t</span> fpid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
       <span class="token keyword">if</span><span class="token punctuation">(</span>fpid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>  
           <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d child  %4d %4d %4d/n"</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span> <span class="token function">getppid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fpid<span class="token punctuation">)</span><span class="token punctuation">;</span>  
       <span class="token keyword">else</span>  
           <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d parent %4d %4d %4d/n"</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span> <span class="token function">getppid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>fpid<span class="token punctuation">)</span><span class="token punctuation">;</span>  
   <span class="token punctuation">&#125;</span>  
   <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  
<span class="token punctuation">&#125;</span> 
<span class="token comment">/*输出内容：
	i        父id  id  子id
	0 parent 2043 3224 3225
    0 child  3224 3225    0
    1 parent 2043 3224 3226
    1 parent 3224 3225 3227
    1 child     1 3227    0
    1 child     1 3226    0 
*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d666f726be587bde695b0e4bdbfe794a8e6bc94e7a4ba2e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/abcb0151515bba5b237741111fd33e0cfa1be39b6337b526f373386438536d94/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d666f726be587bde695b0e4bdbfe794a8e6bc94e7a4ba2e706e67">https://camo.githubusercontent.com/abcb0151515bba5b237741111fd33e0cfa1be39b6337b526f373386438536d94/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d666f726be587bde695b0e4bdbfe794a8e6bc94e7a4ba2e706e67</a>)</p>
<p>在 p3224 和 p3225 执行完第二个循环后，main 函数退出，进程死亡。所以 p3226，p3227 就没有父进程了，成为孤儿进程，所以 p3226 和 p3227 的父进程就被置为 ID 为 1 的 init 进程（笔记 Tool → Linux → 进程管理详解）</p>
<p>参考文章：<a target="_blank" rel="noopener" href="https://blog.csdn.net/love_gaohz/article/details/41727415">https://blog.csdn.net/love_gaohz/article/details/41727415</a></p>
<hr>
<h4 id="-377"><a class="markdownIt-Anchor" href="#-377">#</a> <a href="#%E5%86%85%E5%AD%98"></a>内存</h4>
<p>fork () 调用之后父子进程的内存关系</p>
<p>早期 Linux 的 fork () 实现时，就是全部复制，这种方法效率太低，而且造成了很大的内存浪费，现在 Linux 实现采用了两种方法：</p>
<ul>
<li>
<p>父子进程的代码段是相同的，所以代码段是没必要复制的，只需内核将代码段标记为只读，父子进程就共享此代码段。fork () 之后在进程创建代码段时，子进程的进程级页表项都指向和父进程相同的物理页帧</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d666f726be4bba5e5908ee58685e5ad98e585b3e7b3bb312e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/b7c487c49d4f1ef129a18fa04872bd12a7c7a783c2be4ac37576b67f32cec961/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d666f726be4bba5e5908ee58685e5ad98e585b3e7b3bb312e706e67">https://camo.githubusercontent.com/b7c487c49d4f1ef129a18fa04872bd12a7c7a783c2be4ac37576b67f32cec961/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d666f726be4bba5e5908ee58685e5ad98e585b3e7b3bb312e706e67</a>)</p>
</li>
<li>
<p>对于父进程的数据段，堆段，栈段中的各页，由于父子进程要相互独立，采用<strong>写时复制</strong>的技术，来提高内存以及内核的利用率</p>
<p>在 fork 之后两个进程用的是相同的物理空间（内存区），子进程的代码段、数据段、堆栈都是指向父进程的物理空间，<strong>两者的虚拟空间不同，但其对应的物理空间是同一个</strong>。当父子进程中有更改相应段的行为发生时，再为子进程相应的段分配物理空间，如果两者的代码完全相同，代码段继续共享父进程的物理空间；而如果两者执行的代码不同，子进程的代码段也会分配单独的物理空间。</p>
<p>fork 之后内核会将子进程放在队列的前面，让子进程先执行，以免父进程执行导致写时复制，而后子进程再执行，因无意义的复制而造成效率的下降</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/cd680504a04561b817f33510872235341163027aed45427c8932c31a783f03af/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d666f726be4bba5e5908ee58685e5ad98e585b3e7b3bb322e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/cd680504a04561b817f33510872235341163027aed45427c8932c31a783f03af/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d666f726be4bba5e5908ee58685e5ad98e585b3e7b3bb322e706e67">https://camo.githubusercontent.com/cd680504a04561b817f33510872235341163027aed45427c8932c31a783f03af/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d666f726be4bba5e5908ee58685e5ad98e585b3e7b3bb322e706e67</a>)</p>
</li>
</ul>
<p>补充知识：</p>
<p>vfork（虚拟内存 fork virtual memory fork）：调用 vfork () 父进程被挂起，子进程使用父进程的地址空间。不采用写时复制，如果子进程修改父地址空间的任何页面，这些修改过的页面对于恢复的父进程是可见的</p>
<p>参考文章：<a target="_blank" rel="noopener" href="https://blog.csdn.net/Shreck66/article/details/47039937">https://blog.csdn.net/Shreck66/article/details/47039937</a></p>
<hr>
<h2 id="-378"><a class="markdownIt-Anchor" href="#-378">#</a> <a href="#%E4%BA%8B%E5%8A%A1%E6%9C%BA%E5%88%B6-1"></a>事务机制</h2>
<h3 id="-379"><a class="markdownIt-Anchor" href="#-379">#</a> <a href="#%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C-3"></a>基本操作</h3>
<p>Redis 事务的主要作用就是串联多个命令防止别的命令插队</p>
<ul>
<li>
<p>开启事务</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">multi	<span class="token comment">#设定事务的开启位置，此指令执行后，后续的所有指令均加入到事务中</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>执行事务</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token builtin class-name">exec</span>	<span class="token comment">#设定事务的结束位置，同时执行事务，与multi成对出现，成对使用</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>加入事务的命令暂时进入到任务队列中，并没有立即执行，只有执行 exec 命令才开始执行</p>
</li>
<li>
<p>取消事务</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">discard	<span class="token comment">#终止当前事务的定义，发生在multi之后，exec之前</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>一般用于事务执行过程中输入了错误的指令，直接取消这次事务，类似于回滚</p>
</li>
</ul>
<p>Redis 事务的三大特性：</p>
<ul>
<li>Redis 事务是一个单独的隔离操作，将一系列预定义命令包装成一个整体（一个队列），当执行时按照添加顺序依次执行，中间不会被打断或者干扰</li>
<li>Redis 事务<strong>没有隔离级别</strong>的概念，队列中的命令在事务没有提交之前都不会实际被执行</li>
<li>Redis 单条命令式保存原子性的，但是事务<strong>不保证原子性</strong>，事务中如果有一条命令执行失败，其后的命令仍然会被执行，没有回滚</li>
</ul>
<hr>
<h3 id="-380"><a class="markdownIt-Anchor" href="#-380">#</a> <a href="#%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B-3"></a>工作流程</h3>
<p>事务机制整体工作流程：</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d2545342542412538422545352538412541312545372539412538342545352542372541352545342542442539432545362542352538312545372541382538422e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/c4c73c395d6c76a98ed37b819c2136c0b37ab685b19a457baa70852be2ede5b1/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d2545342542412538422545352538412541312545372539412538342545352542372541352545342542442539432545362542352538312545372541382538422e706e67">https://camo.githubusercontent.com/c4c73c395d6c76a98ed37b819c2136c0b37ab685b19a457baa70852be2ede5b1/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d2545342542412538422545352538412541312545372539412538342545352542372541352545342542442539432545362542352538312545372541382538422e706e67</a>)</p>
<p>几种常见错误：</p>
<ul>
<li>
<p>定义事务的过程中，命令格式输入错误，出现语法错误造成，<strong>整体事务中所有命令均不会执行</strong>，包括那些语法正确的命令</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/0a1489558a1e821203ce010f48d4eb3db86a0bbf1762c576c0b488d09b390b4c/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732de4ba8be58aa1e4b8ade587bae78eb0e8afade6b395e99499e8afaf2e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/0a1489558a1e821203ce010f48d4eb3db86a0bbf1762c576c0b488d09b390b4c/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732de4ba8be58aa1e4b8ade587bae78eb0e8afade6b395e99499e8afaf2e706e67">https://camo.githubusercontent.com/0a1489558a1e821203ce010f48d4eb3db86a0bbf1762c576c0b488d09b390b4c/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732de4ba8be58aa1e4b8ade587bae78eb0e8afade6b395e99499e8afaf2e706e67</a>)</p>
</li>
<li>
<p>定义事务的过程中，命令执行出现错误，例如对字符串进行 incr 操作，能够正确运行的命令会执行，运行错误的命令不会被执行</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732de4ba8be58aa1e4b8ade587bae78eb0e689a7e8a18ce99499e8afaf2e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/4fc996ef2e2e57eb70199c57c97a7c6fef50500a2471f971ccaee51f53e39418/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732de4ba8be58aa1e4b8ade587bae78eb0e689a7e8a18ce99499e8afaf2e706e67">https://camo.githubusercontent.com/4fc996ef2e2e57eb70199c57c97a7c6fef50500a2471f971ccaee51f53e39418/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732de4ba8be58aa1e4b8ade587bae78eb0e689a7e8a18ce99499e8afaf2e706e67</a>)</p>
</li>
<li>
<p>已经执行完毕的命令对应的数据不会自动回滚，需要程序员在代码中实现回滚，应该尽可能避免：</p>
<p>事务操作之前记录数据的状态</p>
<ul>
<li>单数据：string</li>
<li>多数据：hash、list、set、zset</li>
</ul>
<p>设置指令恢复所有的被修改的项</p>
<ul>
<li>单数据：直接 set（注意周边属性，例如时效）</li>
<li>多数据：修改对应值或整体克隆复制</li>
</ul>
</li>
</ul>
<hr>
<h3 id="-381"><a class="markdownIt-Anchor" href="#-381">#</a> <a href="#%E7%9B%91%E6%8E%A7%E9%94%81"></a>监控锁</h3>
<p>对 key 添加监视锁，是一种乐观锁，在执行 exec 前如果其他客户端的操作导致 key 发生了变化，执行结果为 nil</p>
<ul>
<li>
<p>添加监控锁</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">watch</span> key1 <span class="token punctuation">[</span>key2……<span class="token punctuation">]</span>	<span class="token comment">#可以监控一个或者多个key</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>取消对所有 key 的监视</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">unwatch<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<p>应用：基于状态控制的批量任务执行，防止其他线程对变量的修改</p>
<hr>
<h3 id="-382"><a class="markdownIt-Anchor" href="#-382">#</a> <a href="#%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"></a>分布式锁</h3>
<h4 id="-383"><a class="markdownIt-Anchor" href="#-383">#</a> <a href="#%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C-4"></a>基本操作</h4>
<p>由于分布式系统多线程并发分布在不同机器上，这将使单机部署情况下的并发控制锁策略失效，需要分布式锁</p>
<p>Redis 分布式锁的基本使用，悲观锁</p>
<ul>
<li>
<p>使用 setnx 设置一个公共锁</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">setnx lock-key value	<span class="token comment"># value任意数，返回为1设置成功，返回为0设置失败</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>对于返回设置成功的，拥有控制权，进行下一步的具体业务操作</li>
<li>对于返回设置失败的，不具有控制权，排队或等待</li>
</ul>
<p><code>NX</code> ：只在键不存在时，才对键进行设置操作， <code>SET key value NX</code>  效果等同于  <code>SETNX key value</code></p>
<p><code>XX</code>  ：只在键已经存在时，才对键进行设置操作</p>
<p><code>EX</code> ：设置键 key 的过期时间，单位时秒</p>
<p><code>PX</code> ：设置键 key 的过期时间，单位时毫秒</p>
<p>说明：由于  <code>SET</code>  命令加上选项已经可以完全取代 SETNX、SETEX、PSETEX 的功能，Redis 不推荐使用这几个命令</p>
</li>
<li>
<p>操作完毕通过 del 操作释放锁</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">del lock-key <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>使用 expire 为锁 key 添加存活（持有）时间，过期自动删除（放弃）锁</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">expire lock-key second 
pexpire lock-key milliseconds<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>通过 expire 设置过期时间缺乏原子性，如果在 setnx 和 expire 之间出现异常，锁也无法释放</p>
</li>
<li>
<p>在 set 时指定过期时间</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">SET key value <span class="token punctuation">[</span>EX seconds <span class="token operator">|</span> PX milliseconds<span class="token punctuation">]</span> NX
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<p>应用：解决抢购时出现超卖现象</p>
<hr>
<h4 id="-384"><a class="markdownIt-Anchor" href="#-384">#</a> <a href="#%E9%98%B2%E8%AF%AF%E5%88%A0"></a>防误删</h4>
<p>setnx 获取锁时，设置一个指定的唯一值（uuid），释放前获取这个值，判断是否自己的锁，防止出现线程之间误删了其他线程的锁</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 加锁, unique_value作为客户端唯一性的标识</span>
SET lock_key unique_value NX PX <span class="token number">10000</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>unique_value 是客户端的唯一标识，可以用一个随机生成的字符串来表示，PX 10000 则表示 lock_key 会在 10s 后过期，以免客户端在这期间发生异常而无法释放锁</p>
<hr>
<h2 id="-385"><a class="markdownIt-Anchor" href="#-385">#</a> <a href="#%E5%88%A0%E9%99%A4%E7%AD%96%E7%95%A5"></a>删除策略</h2>
<h3 id="-386"><a class="markdownIt-Anchor" href="#-386">#</a> <a href="#%E8%BF%87%E6%9C%9F%E6%95%B0%E6%8D%AE"></a>过期数据</h3>
<p>Redis 是一种内存级数据库，所有数据均存放在内存中，内存中的数据可以通过 TTL 指令获取其状态</p>
<p>TTL 返回的值有三种情况：正数，-1，-2</p>
<ul>
<li>正数：代表该数据在内存中还能存活的时间</li>
<li>-1：永久有效的数据</li>
<li>2 ：已经过期的数据或被删除的数据或未定义的数据</li>
</ul>
<p>删除策略：<strong>删除策略就是针对已过期数据的处理策略</strong>，已过期的数据不一定被立即删除，在不同的场景下使用不同的删除方式会有不同效果，这就是删除策略的问题</p>
<p>过期数据是一块独立的存储空间，Hash 结构，field 是内存地址，value 是过期时间，保存了所有 key 的过期描述，在最终进行过期处理的时候，对该空间的数据进行检测， 当时间到期之后通过 field 找到内存该地址处的数据，然后进行相关操作</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732de697b6e69588e680a7e695b0e68daee79a84e5ad98e582a8e7bb93e69e842e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/3a9d13c1e8d799376e60a9a682ac7d706038d6c163c22db8909391ab8e5181fb/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732de697b6e69588e680a7e695b0e68daee79a84e5ad98e582a8e7bb93e69e842e706e67">https://camo.githubusercontent.com/3a9d13c1e8d799376e60a9a682ac7d706038d6c163c22db8909391ab8e5181fb/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732de697b6e69588e680a7e695b0e68daee79a84e5ad98e582a8e7bb93e69e842e706e67</a>)</p>
<hr>
<h3 id="-387"><a class="markdownIt-Anchor" href="#-387">#</a> <a href="#%E6%95%B0%E6%8D%AE%E5%88%A0%E9%99%A4-1"></a>数据删除</h3>
<h4 id="-388"><a class="markdownIt-Anchor" href="#-388">#</a> <a href="#%E5%88%A0%E9%99%A4%E7%AD%96%E7%95%A5-1"></a>删除策略</h4>
<p>在内存占用与 CPU 占用之间寻找一种平衡，顾此失彼都会造成整体 Redis 性能的下降，甚至引发服务器宕机或内存泄露</p>
<p>针对过期数据有三种删除策略：</p>
<ul>
<li>定时删除</li>
<li>惰性删除</li>
<li>定期删除</li>
</ul>
<hr>
<h4 id="-389"><a class="markdownIt-Anchor" href="#-389">#</a> <a href="#%E5%AE%9A%E6%97%B6%E5%88%A0%E9%99%A4"></a>定时删除</h4>
<p>创建一个定时器，当 key 设置有过期时间，且过期时间到达时，由定时器任务立即执行对键的删除操作</p>
<ul>
<li>优点：节约内存，到时就删除，快速释放掉不必要的内存占用</li>
<li>缺点：无论 CPU 此时负载量多高，均占用 CPU，会影响 Redis 服务器响应时间和指令吞吐量</li>
<li>总结：用处理器性能换取存储空间（拿时间换空间）</li>
</ul>
<hr>
<h4 id="-390"><a class="markdownIt-Anchor" href="#-390">#</a> <a href="#%E6%83%B0%E6%80%A7%E5%88%A0%E9%99%A4"></a>惰性删除</h4>
<p>数据到达过期时间，不做处理，等下次访问该数据时，需要判断：</p>
<ul>
<li>如果未过期，返回数据</li>
<li>如果已过期，删除，返回不存在</li>
</ul>
<p>在任何 get 操作之前都要执行 <strong>expireIfNeeded()</strong>，相当于绑定在一起</p>
<p>特点：</p>
<ul>
<li>优点：节约 CPU 性能，发现必须删除的时候才删除</li>
<li>缺点：内存压力很大，出现长期占用内存的数据</li>
<li>总结：用存储空间换取处理器性能（拿空间换时间）</li>
</ul>
<hr>
<h4 id="-391"><a class="markdownIt-Anchor" href="#-391">#</a> <a href="#%E5%AE%9A%E6%9C%9F%E5%88%A0%E9%99%A4"></a>定期删除</h4>
<p>定时删除和惰性删除这两种方案都是走的极端，定期删除就是折中方案</p>
<p>定期删除是周期性轮询 Redis 库中的时效性数据，采用随机抽取的策略，利用过期数据占比的方式控制删除频度</p>
<p>定期删除方案：</p>
<ul>
<li>
<p>Redis 启动服务器初始化时，读取配置 server.hz 的值，默认为 10，执行指令 info server 可以查看</p>
</li>
<li>
<p>每秒钟执行 server.hz 次 serverCron () → databasesCron () → activeExpireCycle ()</p>
</li>
<li>
<p>databasesCron () 操作是<strong>轮询每个数据库</strong></p>
</li>
<li>
<p>activeExpireCycle () 对某个数据库中的每个 expires 进行检测，每次执行耗时：250ms/server.hz</p>
<p>对某个 expires [*] 检测时，随机挑选 W 个 key 检测</p>
<ul>
<li>如果 key 超时，删除 key</li>
<li>如果一轮中删除的 key 的数量 &gt; W*25%，循环该过程</li>
<li>如果一轮中删除的 key 的数量 ≤ W*25%，检查下一个 expires []，0-15 循环</li>
<li>W 取值 = ACTIVE_EXPIRE_CYCLE_LOOKUPS_PER_LOOP 属性值，自定义值</li>
</ul>
</li>
<li>
<p>参数 current_db 用于记录 activeExpireCycle () 进入哪个 expires [*] 执行</p>
</li>
<li>
<p>如果 activeExpireCycle () 执行时间到期，下次从 current_db 继续向下执行</p>
</li>
</ul>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732de5ae9ae69c9fe588a0e999a42e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/83879c568c1a6af09f296ec7b53c1479567763167ed35a28d2274238ba62feb8/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732de5ae9ae69c9fe588a0e999a42e706e67">https://camo.githubusercontent.com/83879c568c1a6af09f296ec7b53c1479567763167ed35a28d2274238ba62feb8/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732de5ae9ae69c9fe588a0e999a42e706e67</a>)</p>
<p>定期删除特点：</p>
<ul>
<li>CPU 性能占用设置有峰值，检测频度可自定义设置</li>
<li>内存压力不是很大，长期占用内存的冷数据会被持续清理</li>
<li>周期性抽查存储空间（随机抽查，重点抽查）</li>
</ul>
<hr>
<h4 id="-392"><a class="markdownIt-Anchor" href="#-392">#</a> <a href="#%E7%AD%96%E7%95%A5%E5%AF%B9%E6%AF%94"></a>策略对比</h4>
<table>
<thead>
<tr>
<th></th>
<th>优点</th>
<th>缺点</th>
<th>特点</th>
</tr>
</thead>
<tbody>
<tr>
<td>定时删除</td>
<td>节约内存，无占用</td>
<td>不分时段占用 CPU 资源，频度高</td>
<td>拿时间换空间</td>
</tr>
<tr>
<td>惰性删除</td>
<td>内存占用严重</td>
<td>延时执行，CPU 利用率高</td>
<td>拿空间换时间</td>
</tr>
<tr>
<td>定期删除</td>
<td>内存定期随机清理</td>
<td>每秒花费固定的 CPU 资源维护内存</td>
<td>随机抽查，重点抽查</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="-393"><a class="markdownIt-Anchor" href="#-393">#</a> <a href="#%E6%95%B0%E6%8D%AE%E6%B7%98%E6%B1%B0"></a>数据淘汰</h3>
<h4 id="-394"><a class="markdownIt-Anchor" href="#-394">#</a> <a href="#%E9%80%90%E5%87%BA%E7%AE%97%E6%B3%95"></a>逐出算法</h4>
<p>数据淘汰策略：当新数据进入 Redis 时，在执行每一个命令前，会调用 <strong>freeMemoryIfNeeded()</strong> 检测内存是否充足。如果内存不满足新加入数据的最低存储要求，Redis 要临时删除一些数据为当前指令清理存储空间，清理数据的策略称为<strong>逐出算法</strong></p>
<p>逐出数据的过程不是 100% 能够清理出足够的可使用的内存空间，如果不成功则反复执行，当对所有数据尝试完毕，如不能达到内存清理的要求，<strong>出现 Redis 内存打满异常</strong>：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">(</span>error<span class="token punctuation">)</span> OOM <span class="token builtin class-name">command</span> not allowed when used memory <span class="token operator">></span><span class="token string">'maxmemory'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<hr>
<h4 id="-395"><a class="markdownIt-Anchor" href="#-395">#</a> <a href="#%E7%AD%96%E7%95%A5%E9%85%8D%E7%BD%AE"></a>策略配置</h4>
<p>Redis 如果不设置最大内存大小或者设置最大内存大小为 0，在 64 位操作系统下不限制内存大小，在 32 位操作系统默认为 3GB 内存，一般推荐设置 Redis 内存为最大物理内存的四分之三</p>
<p>内存配置方式：</p>
<ul>
<li>
<p>通过修改文件配置（永久生效）：修改配置文件 maxmemory 字段，单位为字节</p>
</li>
<li>
<p>通过命令修改（重启失效）：</p>
<ul>
<li>
<p><code>config set maxmemory 104857600</code> ：设置 Redis 最大占用内存为 100MB</p>
</li>
<li>
<p><code>config get maxmemory</code> ：获取 Redis 最大占用内存</p>
</li>
<li>
<p><code>info</code>  ：可以查看 Redis 内存使用情况， <code>used_memory_human</code>  字段表示实际已经占用的内存， <code>maxmemory</code>  表示最大占用内存</p>
</li>
</ul>
</li>
</ul>
<p>影响数据淘汰的相关配置如下，配置 conf 文件：</p>
<ul>
<li>
<p>每次选取待删除数据的个数，采用随机获取数据的方式作为待检测删除数据，防止全库扫描，导致严重的性能消耗，降低读写性能</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">maxmemory-samples count<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>达到最大内存后的，对被挑选出来的数据进行删除的策略</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">maxmemory-policy policy<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>数据删除的策略 policy：3 类 8 种</p>
<p>第一类：检测易失数据（可能会过期的数据集 server.db [i].expires）：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">volatile-lru	<span class="token comment"># 对设置了过期时间的 key 选择最近最久未使用使用的数据淘汰</span>
volatile-lfu	<span class="token comment"># 对设置了过期时间的 key 选择最近使用次数最少的数据淘汰</span>
volatile-ttl	<span class="token comment"># 对设置了过期时间的 key 选择将要过期的数据淘汰</span>
volatile-random	<span class="token comment"># 对设置了过期时间的 key 选择任意数据淘汰</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>第二类：检测全库数据（所有数据集 server.db [i].dict ）：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">allkeys-lru		<span class="token comment"># 对所有 key 选择最近最少使用的数据淘汰</span>
allkeLyRs-lfu	<span class="token comment"># 对所有 key 选择最近使用次数最少的数据淘汰</span>
allkeys-random	<span class="token comment"># 对所有 key 选择任意数据淘汰，相当于随机</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>第三类：放弃数据驱逐</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">no-enviction	<span class="token comment">#禁止驱逐数据(redis4.0中默认策略)，会引发OOM(Out Of Memory)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<p>数据淘汰策略配置依据：使用 INFO 命令输出监控信息，查询缓存 hit 和 miss 的次数，根据需求调优 Redis 配置</p>
<hr>
<h2 id="-396"><a class="markdownIt-Anchor" href="#-396">#</a> <a href="#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"></a>主从复制</h2>
<h3 id="-397"><a class="markdownIt-Anchor" href="#-397">#</a> <a href="#%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D-9"></a>基本介绍</h3>
<p><strong>三高</strong>架构：</p>
<ul>
<li>
<p>高并发：应用提供某一业务要能支持很多客户端同时访问的能力，我们称为并发</p>
</li>
<li>
<p>高性能：性能带给我们最直观的感受就是：速度快，时间短</p>
</li>
<li>
<p>高可用：</p>
<ul>
<li>可用性：应用服务在全年宕机的时间加在一起就是全年应用服务不可用的时间</li>
<li>业界可用性目标 5 个 9，即 99.999%，即服务器年宕机时长低于 315 秒，约 5.25 分钟</li>
</ul>
</li>
</ul>
<p>主从复制：</p>
<ul>
<li>
<p>概念：将 master 中的数据即时、有效的复制到 slave 中</p>
</li>
<li>
<p>特征：一个 master 可以拥有多个 slave，一个 slave 只对应一个 master</p>
</li>
<li>
<p>职责：master 和 slave 各自的职责不一样</p>
<p>master：</p>
<ul>
<li><strong>写数据</strong>，执行写操作时，将出现变化的数据自动同步到 slave</li>
<li>读数据（可忽略）</li>
</ul>
<p>slave</p>
<ul>
<li><strong>读数据</strong></li>
<li>写数据（禁止）</li>
</ul>
</li>
</ul>
<p>主从复制的机制：</p>
<ul>
<li>
<p><strong>薪火相传</strong>：一个 slave 可以是下一个 slave 的 master，slave 同样可以接收其他 slave 的连接和同步请求，那么该 slave 作为了链条中下一个的 master, 可以有效减轻 master 的写压力，去中心化降低风险</p>
<p>注意：主机挂了，从机还是从机，无法写数据了</p>
</li>
<li>
<p><strong>反客为主</strong>：当一个 master 宕机后，后面的 slave 可以立刻升为 master，其后面的 slave 不做任何修改</p>
<p>将从机变为主机的命令： <code>slaveof no one</code></p>
</li>
</ul>
<p>主从复制的作用：</p>
<ul>
<li><strong>读写分离</strong>：master 写、slave 读，提高服务器的读写负载能力</li>
<li><strong>负载均衡</strong>：基于主从结构，配合读写分离，由 slave 分担 master 负载，并根据需求的变化，改变 slave 的数量，通过多个从节点分担数据读取负载，大大提高 Redis 服务器并发量与数据吞吐量</li>
<li>故障恢复：当 master 出现问题时，由 slave 提供服务，实现快速的故障恢复</li>
<li>数据冗余：实现数据热备份，是持久化之外的一种数据冗余方式</li>
<li>高可用基石：基于主从复制，构建哨兵模式与集群，实现 Redis 的高可用方案</li>
</ul>
<p>主从复制的应用场景：</p>
<ul>
<li>
<p>机器故障：硬盘故障、系统崩溃，造成数据丢失，对业务形成灾难性打击，基本上会放弃使用 redis</p>
</li>
<li>
<p>容量瓶颈：内存不足，放弃使用 redis</p>
</li>
<li>
<p>解决方案：为了避免单点 Redis 服务器故障，准备多台服务器，互相连通。将数据复制多个副本保存在不同的服务器上连接在一起，并保证数据是同步的。即使有其中一台服务器宕机，其他服务器依然可以继续提供服务，实现 Redis 高可用，同时实现数据冗余备份</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/ebe5688ce86dd95b4a625ed84a850216c6f624cad48295f10001a07aa0e5489c/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732de4b8bbe4bb8ee5a48de588b6e5a49ae58fb0e69c8de58aa1e599a8e8bf9ee68ea5e696b9e6a1882e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/ebe5688ce86dd95b4a625ed84a850216c6f624cad48295f10001a07aa0e5489c/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732de4b8bbe4bb8ee5a48de588b6e5a49ae58fb0e69c8de58aa1e599a8e8bf9ee68ea5e696b9e6a1882e706e67">https://camo.githubusercontent.com/ebe5688ce86dd95b4a625ed84a850216c6f624cad48295f10001a07aa0e5489c/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732de4b8bbe4bb8ee5a48de588b6e5a49ae58fb0e69c8de58aa1e599a8e8bf9ee68ea5e696b9e6a1882e706e67</a>)</p>
</li>
</ul>
<hr>
<h3 id="-398"><a class="markdownIt-Anchor" href="#-398">#</a> <a href="#%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B-4"></a>工作流程</h3>
<p>主从复制过程大体可以分为 3 个阶段</p>
<ul>
<li>建立连接阶段（即准备阶段）</li>
<li>数据同步阶段</li>
<li>命令传播阶段</li>
</ul>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/f5191b017300c30d65165952516bae1bd890c0bf4d4654948f49c80b3ae07ae9/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d2545342542382542422545342542422538452545352541342538442545352538382542362545352542372541352545342542442539432545362542352538312545372541382538422e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/f5191b017300c30d65165952516bae1bd890c0bf4d4654948f49c80b3ae07ae9/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d2545342542382542422545342542422538452545352541342538442545352538382542362545352542372541352545342542442539432545362542352538312545372541382538422e706e67">https://camo.githubusercontent.com/f5191b017300c30d65165952516bae1bd890c0bf4d4654948f49c80b3ae07ae9/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d2545342542382542422545342542422538452545352541342538442545352538382542362545352542372541352545342542442539432545362542352538312545372541382538422e706e67</a>)</p>
<hr>
<h3 id="-399"><a class="markdownIt-Anchor" href="#-399">#</a> <a href="#%E5%BB%BA%E7%AB%8B%E8%BF%9E%E6%8E%A5"></a>建立连接</h3>
<h4 id="-400"><a class="markdownIt-Anchor" href="#-400">#</a> <a href="#%E5%BB%BA%E7%AB%8B%E6%B5%81%E7%A8%8B"></a>建立流程</h4>
<p>建立连接阶段：建立 slave 到 master 的连接，使 master 能够识别 slave，并保存 slave 端口号</p>
<p>流程如下：</p>
<ol>
<li>设置 master 的地址和端口，保存 master 信息</li>
<li>建立 socket 连接</li>
<li>发送 ping 命令（定时器任务）</li>
<li>身份验证（可能没有）</li>
<li>发送 slave 端口信息</li>
<li>主从连接成功</li>
</ol>
<p>连接成功的状态：</p>
<ul>
<li>
<p>slave：保存 master 的地址与端口</p>
</li>
<li>
<p>master：保存 slave 的端口</p>
</li>
<li>
<p>主从之间创建了连接的 socket</p>
</li>
</ul>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732de4b8bbe4bb8ee5a48de588b6e5bbbae7ab8be8bf9ee68ea52e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/3069ce57969f54cbcddca79031f50a889ec99c42beba449a108b36f08341ad70/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732de4b8bbe4bb8ee5a48de588b6e5bbbae7ab8be8bf9ee68ea52e706e67">https://camo.githubusercontent.com/3069ce57969f54cbcddca79031f50a889ec99c42beba449a108b36f08341ad70/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732de4b8bbe4bb8ee5a48de588b6e5bbbae7ab8be8bf9ee68ea52e706e67</a>)</p>
<hr>
<h4 id="-401"><a class="markdownIt-Anchor" href="#-401">#</a> <a href="#%E7%9B%B8%E5%85%B3%E6%8C%87%E4%BB%A4"></a>相关指令</h4>
<ul>
<li>
<p>master 和 slave 互联</p>
<p>方式一：客户端发送命令</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">slaveof masterip masterport<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>方式二：服务器带参启动</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">redis-server --slaveof masterip masterport<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>方式三：服务器配置（主流方式）</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">slaveof masterip masterport<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>
<p>slave 系统信息：info 指令</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">master_link_down_since_seconds
masterhost <span class="token operator">&amp;</span> masterport<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li>
<p>master 系统信息：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">uslave_listening_port<span class="token punctuation">(</span>多个<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>系统信息：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">info replication<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
</li>
<li>
<p>主从断开连接：断开 slave 与 master 的连接，slave 断开连接后，不会删除已有数据，只是不再接受 master 发送的数据</p>
<p>slave 客户端执行命令：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">slaveof no one	<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>授权访问：master 有服务端和客户端，slave 也有服务端和客户端，不仅服务端之间可以发命令，客户端也可以</p>
<p>master 客户端发送命令设置密码：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">requirepass password<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>master 配置文件设置密码：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">config <span class="token builtin class-name">set</span> requirepass password
config get requirepass<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>slave 客户端发送命令设置密码：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">auth password<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>slave 配置文件设置密码：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">masterauth password<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>slave 启动服务器设置密码：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">redis-server –a password<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<hr>
<h3 id="-402"><a class="markdownIt-Anchor" href="#-402">#</a> <a href="#%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5"></a>数据同步</h3>
<h4 id="-403"><a class="markdownIt-Anchor" href="#-403">#</a> <a href="#%E5%90%8C%E6%AD%A5%E6%B5%81%E7%A8%8B"></a>同步流程</h4>
<p>数据同步需求：</p>
<ul>
<li>在 slave 初次连接 master 后，复制 master 中的所有数据到 slave</li>
<li>将 slave 的数据库状态更新成 master 当前的数据库状态</li>
</ul>
<p>同步过程如下：</p>
<ol>
<li>请求同步数据</li>
<li>创建 RDB 同步数据</li>
<li>恢复 RDB 同步数据（从服务器会<strong>清空原有数据</strong>）</li>
<li>请求部分同步数据</li>
<li>恢复部分同步数据</li>
<li>数据同步工作完成</li>
</ol>
<p>同步完成的状态：</p>
<ul>
<li>
<p>slave：具有 master 端全部数据，包含 RDB 过程接收的数据</p>
</li>
<li>
<p>master：保存 slave 当前数据同步的位置</p>
</li>
<li>
<p>主从之间完成了数据克隆</p>
</li>
</ul>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732de4b8bbe4bb8ee5a48de588b6e695b0e68daee5908ce6ada52e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/ae56b0846534c56ce627dcff7c0163fac22fbaefc5c471f0110da57d652365a8/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732de4b8bbe4bb8ee5a48de588b6e695b0e68daee5908ce6ada52e706e67">https://camo.githubusercontent.com/ae56b0846534c56ce627dcff7c0163fac22fbaefc5c471f0110da57d652365a8/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732de4b8bbe4bb8ee5a48de588b6e695b0e68daee5908ce6ada52e706e67</a>)</p>
<hr>
<h4 id="-404"><a class="markdownIt-Anchor" href="#-404">#</a> <a href="#%E5%90%8C%E6%AD%A5%E4%BC%98%E5%8C%96"></a>同步优化</h4>
<ul>
<li>
<p>数据同步阶段 master 说明</p>
<ol>
<li>
<p>master 数据量巨大，数据同步阶段应避开流量高峰期，避免造成 master 阻塞，影响业务正常执行</p>
</li>
<li>
<p>复制缓冲区大小设定不合理，会导致<strong>数据溢出</strong>。比如进行全量复制周期太长，进行部分复制时发现数据已经存在丢失的情况，必须进行第二次全量复制，致使 slave 陷入死循环状态</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">repl-backlog-size ?mb<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>建议设置如下：</p>
<ul>
<li>测算从 master 到 slave 的重连平均时长 second</li>
<li>获取 master 平均每秒产生写命令数据总量 write_size_per_second</li>
<li>最优复制缓冲区空间 = 2 * second * write_size_per_second</li>
</ul>
</li>
<li>
<p>master 单机内存占用主机内存的比例不应过大，建议使用 50%-70% 的内存，留下 30%-50% 的内存用于执行 bgsave 命令和创建复制缓冲区</p>
</li>
</ol>
</li>
<li>
<p>数据同步阶段 slave 说明</p>
<ol>
<li>
<p>为避免 slave 进行全量复制、部分复制时服务器响应阻塞或数据不同步，建议关闭此期间的对外服务</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">slave-serve-stale-data <span class="token function">yes</span><span class="token operator">|</span>no<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>数据同步阶段，master 发给 slave 信息可以理解 master 是 slave 的一个客户端，主动向 slave 发送命令</p>
</li>
<li>
<p>多个 slave 同时对 master 请求数据同步，master 发送的 RDB 文件增多，会对带宽造成巨大冲击，如果 master 带宽不足，因此数据同步需要根据业务需求，适量错峰</p>
</li>
<li>
<p>slave 过多时，建议调整拓扑结构，由一主多从结构变为树状结构，中间的节点既是 master，也是 slave。注意使用树状结构时，由于层级深度，导致深度越高的 slave 与最顶层 master 间数据同步延迟较大，数据一致性变差，应谨慎选择</p>
</li>
</ol>
</li>
</ul>
<hr>
<h3 id="-405"><a class="markdownIt-Anchor" href="#-405">#</a> <a href="#%E5%91%BD%E4%BB%A4%E4%BC%A0%E6%92%AD"></a>命令传播</h3>
<h4 id="-406"><a class="markdownIt-Anchor" href="#-406">#</a> <a href="#%E4%BC%A0%E6%92%AD%E5%8E%9F%E7%90%86"></a>传播原理</h4>
<p>命令传播：当 master 数据库状态被修改后，导致主从服务器数据库状态不一致，此时需要让主从数据同步到一致的状态，同步的动作称为命令传播</p>
<p>命令传播的过程：master 将接收到的数据变更命令发送给 slave，slave 接收命令后执行命令</p>
<p>命令传播阶段出现了断网现象：</p>
<ul>
<li>网络闪断闪连：忽略</li>
<li>短时间网络中断：部分复制</li>
<li>长时间网络中断：全量复制</li>
</ul>
<p>部分复制的三个核心要素：服务器的运行 id（run id）、主服务器的复制积压缓冲区、主从服务器的复制偏移量</p>
<ul>
<li>
<p>服务器运行 ID（runid）：服务器运行 ID 是每一台服务器每次运行的身份识别码，一台服务器多次运行可以生成多个运行 ID，由 40 位字符组成，是一个随机的十六进制字符</p>
<p>作用：用于在服务器间进行传输识别身份，如果想两次操作均对同一台服务器进行，必须每次操作携带对应的运行 ID，用于对方识别</p>
<p>实现：运行 ID 在每台服务器启动时自动生成，master 在首次连接 slave 时，将运行 ID 发送给 slave，slave 保存此 ID，通过 info Server 命令，可以查看节点的 runid</p>
</li>
<li>
<p>复制缓冲区：复制积压缓冲区，是一个先进先出（FIFO）的队列，用于存储服务器执行过的命令</p>
<p>作用：用于保存 master 收到的所有指令（仅影响数据变更的指令，例如 set，select）</p>
<p>实现方式：每次传播命令，master 都会将传播的命令记录下来，并存储在复制缓冲区，复制缓冲区默认数据存储空间大小是 1M，当入队元素的数量大于队列长度时，最先入队的元素被弹出，新元素会被放入队列</p>
</li>
<li>
<p>复制偏移量：一个数字，描述复制缓冲区中的指令字节位置</p>
<ul>
<li>master 复制偏移量：记录发送给所有 slave 的指令字节对应的位置（多个）</li>
<li>slave 复制偏移量：记录 slave 接收 master 发送过来的指令字节对应的位置（一个）</li>
</ul>
<p>作用：同步信息，比对 master 与 slave 的差异，当 slave 断线后，恢复数据使用</p>
<p>数据来源：</p>
<ul>
<li>master 端：发送一次记录一次</li>
<li>slave 端：接收一次记录一次</li>
</ul>
</li>
</ul>
<p><strong>工作原理</strong>：</p>
<ul>
<li>通过 offset 区分不同的 slave 当前数据传播的差异</li>
<li>master 记录已发送的信息对应的 offset</li>
<li>slave 记录已接收的信息对应的 offset</li>
</ul>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732de4b8bbe4bb8ee5a48de588b6e5a48de588b6e7bc93e586b2e58cbae58e9fe790862e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/091a34d9b50b85c8a38be21956d3fa42163e0d0fafbaab185665374231dc1c04/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732de4b8bbe4bb8ee5a48de588b6e5a48de588b6e7bc93e586b2e58cbae58e9fe790862e706e67">https://camo.githubusercontent.com/091a34d9b50b85c8a38be21956d3fa42163e0d0fafbaab185665374231dc1c04/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732de4b8bbe4bb8ee5a48de588b6e5a48de588b6e7bc93e586b2e58cbae58e9fe790862e706e67</a>)</p>
<hr>
<h4 id="-407"><a class="markdownIt-Anchor" href="#-407">#</a> <a href="#%E5%A4%8D%E5%88%B6%E6%B5%81%E7%A8%8B"></a>复制流程</h4>
<p>全量复制 / 部分复制</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d2545342542382542422545342542422538452545352541342538442545352538382542362545362542352538312545372541382538422545362539422542342545362539362542302e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/d80166c7199067801e21aa59bc0a6d6452a30b7b74f4c690c0fe69b506315a90/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d2545342542382542422545342542422538452545352541342538442545352538382542362545362542352538312545372541382538422545362539422542342545362539362542302e706e67">https://camo.githubusercontent.com/d80166c7199067801e21aa59bc0a6d6452a30b7b74f4c690c0fe69b506315a90/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d2545342542382542422545342542422538452545352541342538442545352538382542362545362542352538312545372541382538422545362539422542342545362539362542302e706e67</a>)</p>
<hr>
<h4 id="-408"><a class="markdownIt-Anchor" href="#-408">#</a> <a href="#%E5%BF%83%E8%B7%B3%E6%9C%BA%E5%88%B6"></a>心跳机制</h4>
<p>心跳机制：进入命令传播阶段，master 与 slave 间需要信息交换，使用心跳机制维护，实现双方连接保持在线</p>
<p>master 心跳任务：</p>
<ul>
<li>内部指令：PING</li>
<li>周期：由  <code>repl-ping-slave-period</code>  决定，默认 10 秒</li>
<li>作用：判断 slave 是否在线</li>
<li>查询：INFO replication 获取 slave 最后一次连接时间间隔，lag 项维持在 0 或 1 视为正常</li>
</ul>
<p>slave 心跳任务</p>
<ul>
<li offset="">内部指令：REPLCONF ACK</li>
<li>周期：1 秒</li>
<li>作用：汇报 slave 自己的复制偏移量，获取最新的数据变更指令；判断 master 是否在线</li>
</ul>
<p>心跳阶段注意事项：</p>
<ul>
<li>
<p>当 slave 多数掉线，或延迟过高时，master 为保障数据稳定性，将拒绝所有信息同步</p>
<p>slave 数量少于 2 个，或者所有 slave 的延迟都大于等于 8 秒时，强制关闭 master 写功能，停止数据同步</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">min-slaves-to-write <span class="token number">2</span>
min-slaves-max-lag <span class="token number">8</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li>
<p>slave 数量由 slave 发送 REPLCONF ACK 命令做确认</p>
</li>
<li>
<p>slave 延迟由 slave 发送 REPLCONF ACK 命令做确认</p>
</li>
</ul>
<hr>
<h3 id="-409"><a class="markdownIt-Anchor" href="#-409">#</a> <a href="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98"></a>常见问题</h3>
<h4 id="-410"><a class="markdownIt-Anchor" href="#-410">#</a> <a href="#%E9%87%8D%E5%90%AF%E6%81%A2%E5%A4%8D"></a>重启恢复</h4>
<p>系统不断运行，master 的数据量会越来越大，一旦 master 重启，runid 将发生变化，会导致全部 slave 的全量复制操作</p>
<p>解决方法：本机保存上次 runid，重启后恢复该值，使所有 slave 认为还是之前的 master</p>
<p>优化方案：</p>
<ul>
<li>
<p>master 内部创建 master_replid 变量，使用 runid 相同的策略生成，长度 41 位，并发送给所有 slave</p>
</li>
<li>
<p>在 master 关闭时执行命令  <code>shutdown save</code> ，进行 RDB 持久化，将 runid 与 offset 保存到 RDB 文件中</p>
<p><code>redis-check-rdb dump.rdb</code>  命令可以查看该信息，保存为 repl-id 和 repl-offset</p>
</li>
<li>
<p>master 重启后加载 RDB 文件，恢复数据</p>
<p>重启后，将 RDB 文件中保存的 repl-id 与 repl-offset 加载到内存中</p>
<ul>
<li>master_repl_id = repl-id，master_repl_offset = repl-offset</li>
<li>通过 info 命令可以查看该信息</li>
</ul>
</li>
</ul>
<hr>
<h4 id="-411"><a class="markdownIt-Anchor" href="#-411">#</a> <a href="#%E7%BD%91%E7%BB%9C%E4%B8%AD%E6%96%AD"></a>网络中断</h4>
<p>master 的 CPU 占用过高或 slave 频繁断开连接</p>
<ul>
<li>
<p>出现的原因：</p>
<ul>
<li>slave 每 1 秒发送 REPLCONF ACK 命令到 master</li>
<li>当 slave 接到了慢查询时（keys * ，hgetall 等），会大量占用 CPU 性能</li>
<li>master 每 1 秒调用复制定时函数 replicationCron ()，比对 slave 发现长时间没有进行响应</li>
</ul>
<p>最终导致 master 各种资源（输出缓冲区、带宽、连接等）被严重占用</p>
</li>
<li>
<p>解决方法：通过设置合理的超时时间，确认是否释放 slave</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">repl-timeout	<span class="token comment"># 该参数定义了超时时间的阈值（默认60秒），超过该值，释放slave</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<p>slave 与 master 连接断开</p>
<ul>
<li>
<p>出现的原因：</p>
<ul>
<li>master 发送 ping 指令频度较低</li>
<li>master 设定超时时间较短</li>
<li>ping 指令在网络中存在丢包</li>
</ul>
</li>
<li>
<p>解决方法：提高 ping 指令发送的频度</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">repl-ping-slave-period	<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>超时时间 repl-time 的时间至少是 ping 指令频度的 5 到 10 倍，否则 slave 很容易判定超时</p>
</li>
</ul>
<hr>
<h4 id="-412"><a class="markdownIt-Anchor" href="#-412">#</a> <a href="#%E4%B8%80%E8%87%B4%E6%80%A7"></a>一致性</h4>
<p>网络信息不同步，数据发送有延迟，导致多个 slave 获取相同数据不同步</p>
<p>解决方案：</p>
<ul>
<li>
<p><strong>优化主从间的网络环境</strong>，通常放置在同一个机房部署，如使用阿里云等云服务器时要注意此现象</p>
</li>
<li>
<p>监控主从节点延迟（通过 offset）判断，如果 slave 延迟过大，<strong>暂时屏蔽程序对该 slave 的数据访问</strong></p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">slave-serve-stale-data <span class="token function">yes</span><span class="token operator">|</span>no<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>开启后仅响应 info、slaveof 等少数命令（慎用，除非对数据一致性要求很高）</p>
</li>
</ul>
<hr>
<h2 id="-413"><a class="markdownIt-Anchor" href="#-413">#</a> <a href="#%E5%93%A8%E5%85%B5%E6%A8%A1%E5%BC%8F"></a>哨兵模式</h2>
<h3 id="-414"><a class="markdownIt-Anchor" href="#-414">#</a> <a href="#%E5%93%A8%E5%85%B5%E6%A6%82%E8%BF%B0"></a>哨兵概述</h3>
<p>如果 Redis 的 master 宕机了，需要从 slave 中重新选出一个 master，要实现这些功能就需要 Redis 的哨兵</p>
<p>哨兵（sentinel）是一个分布式系统，用于对主从结构中的每台服务器进行<strong>监控</strong>，当出现故障时通过<strong>投票机制选择</strong>新的 master 并将所有 slave 连接到新的 master</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/131b2e9648d7986ca7e2fd2c1b5870f304715afaa3e4f623ad4d1754d62bc619/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732de593a8e585b5e6a8a1e5bc8f2e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/131b2e9648d7986ca7e2fd2c1b5870f304715afaa3e4f623ad4d1754d62bc619/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732de593a8e585b5e6a8a1e5bc8f2e706e67">https://camo.githubusercontent.com/131b2e9648d7986ca7e2fd2c1b5870f304715afaa3e4f623ad4d1754d62bc619/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732de593a8e585b5e6a8a1e5bc8f2e706e67</a>)</p>
<p>哨兵的作用：</p>
<ul>
<li>
<p>监控：监控 master 和 slave，不断的检查 master 和 slave 是否正常运行，master 存活检测、master 与 slave 运行情况检测</p>
</li>
<li>
<p>通知：当被监控的服务器出现问题时，向其他（哨兵间，客户端）发送通知</p>
</li>
<li>
<p>自动故障转移：断开 master 与 slave 连接，选取一个 slave 作为 master，将其他 slave 连接新的 master，并告知客户端新的服务器地址</p>
</li>
</ul>
<p>注意：哨兵也是一台 Redis 服务器，只是不提供数据相关服务，通常哨兵的数量配置为单数（投票）</p>
<hr>
<h3 id="-415"><a class="markdownIt-Anchor" href="#-415">#</a> <a href="#%E5%90%AF%E7%94%A8%E5%93%A8%E5%85%B5"></a>启用哨兵</h3>
<p>配置哨兵：</p>
<ul>
<li>
<p>配置一拖二的主从结构</p>
</li>
<li>
<p>配置三个哨兵（配置相同，端口不同），sentinel.conf</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">port <span class="token number">26401</span>
<span class="token function">dir</span> <span class="token string">"/redis/data"</span>
sentinel monitor mymaster <span class="token number">127.0</span>.0.1 <span class="token number">6401</span> <span class="token number">2</span>
sentinel down-after-milliseconds mymaster <span class="token number">5000</span>
sentinel failover-timeout mymaster <span class="token number">20000</span>
sentinel parallel-sync mymaster <span class="token number">1</span>
sentinel deny-scripts-reconfig <span class="token function">yes</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>配置说明：</p>
<ul>
<li>
<p>设置哨兵监听的主服务器信息， sentinel_number 表示参与投票的哨兵数量</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">sentinel monitor master_name master_host master_port sentinel_number<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>指定哨兵在监控 Redis 服务时，设置判定服务器宕机的时长，该设置控制是否进行主从切换</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">sentinel down-after-milliseconds master_name million_seconds<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>出现故障后，故障切换的最大超时时间，超过该值，认定切换失败，默认 3 分钟</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">sentinel failover-timeout master_name	million_seconds<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>指定同时进行主从的 slave 数量，数值越大，要求网络资源越高，要求约小，同步时间约长</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">sentinel parallel-syncs master_name sync_slave_number<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
</li>
</ul>
<p>启动哨兵：</p>
<ul>
<li>
<p>服务端命令（Linux 命令）：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">redis-sentinel filename<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<hr>
<h3 id="-416"><a class="markdownIt-Anchor" href="#-416">#</a> <a href="#%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"></a>工作原理</h3>
<h4 id="-417"><a class="markdownIt-Anchor" href="#-417">#</a> <a href="#%E7%9B%91%E6%8E%A7%E9%98%B6%E6%AE%B5"></a>监控阶段</h4>
<p>哨兵在进行主从切换过程中经历三个阶段</p>
<ul>
<li>监控</li>
<li>通知</li>
<li>故障转移</li>
</ul>
<p>监控阶段作用：同步各个节点的状态信息</p>
<ul>
<li>
<p>获取各个 sentinel 的状态（是否在线）</p>
</li>
<li>
<p>获取 master 的状态</p>
<pre class="line-numbers language-gfm" data-language="gfm"><code class="language-gfm">master属性
	prunid
	prole：master
	各个slave的详细信息	<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>获取所有 slave 的状态（根据 master 中的 slave 信息）</p>
<pre class="line-numbers language-gfm" data-language="gfm"><code class="language-gfm">slave属性
	prunid
	prole：slave
	pmaster_host、master_port
	poffset<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<p>内部的工作原理：</p>
<p>sentinel 1 首先连接 master，建立 cmd 通道，根据主节点访问从节点，连接完成</p>
<p>sentinel 2 首先连接 master，然后通过 master 中的 sentinels 发现其他哨兵，然后寻找哨兵建立连接，哨兵之间同步数据</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732de593a8e585b5e6a8a1e5bc8fe79b91e68ea7e5b7a5e4bd9ce58e9fe790862e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/b4a24406fc88d3a73544e710dc4e2347ea7f4ea072801a75a9192cbc2cde3081/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732de593a8e585b5e6a8a1e5bc8fe79b91e68ea7e5b7a5e4bd9ce58e9fe790862e706e67">https://camo.githubusercontent.com/b4a24406fc88d3a73544e710dc4e2347ea7f4ea072801a75a9192cbc2cde3081/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732de593a8e585b5e6a8a1e5bc8fe79b91e68ea7e5b7a5e4bd9ce58e9fe790862e706e67</a>)</p>
<hr>
<h4 id="-418"><a class="markdownIt-Anchor" href="#-418">#</a> <a href="#%E9%80%9A%E7%9F%A5%E9%98%B6%E6%AE%B5"></a>通知阶段</h4>
<p>sentinel 在通知阶段不断的去获取 master/slave 的信息，然后在各个 sentinel 之间进行共享，流程如下：</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d2545352539332541382545352538352542352545362541382541312545352542432538462545392538302539412545372539462541352545352542372541352545342542442539432545362542352538312545372541382538422e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/459181416ea335a66cf9dad88e2680d97a4b870d98567161e612389db95b35ab/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d2545352539332541382545352538352542352545362541382541312545352542432538462545392538302539412545372539462541352545352542372541352545342542442539432545362542352538312545372541382538422e706e67">https://camo.githubusercontent.com/459181416ea335a66cf9dad88e2680d97a4b870d98567161e612389db95b35ab/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d2545352539332541382545352538352542352545362541382541312545352542432538462545392538302539412545372539462541352545352542372541352545342542442539432545362542352538312545372541382538422e706e67</a>)</p>
<hr>
<h4 id="-419"><a class="markdownIt-Anchor" href="#-419">#</a> <a href="#%E6%95%85%E9%9A%9C%E8%BD%AC%E7%A7%BB"></a>故障转移</h4>
<p>当 master 宕机后，sentinel 会判断出 master 是否真的宕机，具体的操作流程：</p>
<ul>
<li>
<p>检测 master</p>
<p>sentinel1 检测到 master 下线后会做 flag:SRI_S_DOWN 标志，此时 master 的状态是主观下线，并通知其他哨兵，其他哨兵也会尝试与 master 连接，如果大于 (n/2) + 1 个 sentinel 检测到 master 下线，就达成共识更改 flag，此时 master 的状态是客观下线</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d254535253933254138254535253835254235254536254138254131254535254243253846254536253935253835254539253941253943254538254244254143254537254137254242254535254237254135254534254244253943254536254235253831254537254138253842312e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/bf37b740cfd15d6f4078b57f2b3f0d6d5569a5d7f9d07c568f3b30a011c9f35e/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d254535253933254138254535253835254235254536254138254131254535254243253846254536253935253835254539253941253943254538254244254143254537254137254242254535254237254135254534254244253943254536254235253831254537254138253842312e706e67">https://camo.githubusercontent.com/bf37b740cfd15d6f4078b57f2b3f0d6d5569a5d7f9d07c568f3b30a011c9f35e/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d254535253933254138254535253835254235254536254138254131254535254243253846254536253935253835254539253941253943254538254244254143254537254137254242254535254237254135254534254244253943254536254235253831254537254138253842312e706e67</a>)</p>
</li>
<li>
<p>当 sentinel 认定 master 下线之后，此时需要决定更换 master，选举某个 sentinel 处理事故</p>
<p>在选举的时候每一个 sentinel 都有一票，于是每个 sentinel 都会发出一个指令，在内网广播要做主持人；比如 sentinel1 和 sentinel4 发出这个选举指令了，那么 sentinel2 既能接到 sentinel1 的也能接到 sentinel4 的，sentinel2 会把一票投给其中一方，投给指令最先到达的 sentinel。选举最终得票多的，就成为了处理事故的哨兵，需要注意在这个过程中有可能会存在失败的现象，就是一轮选举完没有选取，那就会接着进行第二轮第三轮直到完成选举。</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d254535253933254138254535253835254235254536254138254131254535254243253846254536253935253835254539253941253943254538254244254143254537254137254242254535254237254135254534254244253943254536254235253831254537254138253842322e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/f1814dc9af979f273cab2c8873ef7339fa5934e8ecd594e58853c6a8e4092ac2/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d254535253933254138254535253835254235254536254138254131254535254243253846254536253935253835254539253941253943254538254244254143254537254137254242254535254237254135254534254244253943254536254235253831254537254138253842322e706e67">https://camo.githubusercontent.com/f1814dc9af979f273cab2c8873ef7339fa5934e8ecd594e58853c6a8e4092ac2/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d254535253933254138254535253835254235254536254138254131254535254243253846254536253935253835254539253941253943254538254244254143254537254137254242254535254237254135254534254244253943254536254235253831254537254138253842322e706e67</a>)</p>
</li>
</ul>
<p>选择新的 master，在服务器列表中挑选备选 master 的原则：</p>
<ul>
<li>
<p>不在线的 OUT</p>
</li>
<li>
<p>响应慢的 OUT</p>
</li>
<li>
<p>与原 master 断开时间久的 OUT</p>
</li>
<li>
<p>优先原则：先根据优先级 → offset → runid</p>
</li>
</ul>
<p>选出新的 master 之后，发送指令（sentinel ）给其他的 slave</p>
<ul>
<li>向新的 master 发送 slaveof no one</li>
<li>向其他 slave 发送 slaveof 新 masterIP 端口</li>
</ul>
<hr>
<h2 id="-420"><a class="markdownIt-Anchor" href="#-420">#</a> <a href="#%E9%9B%86%E7%BE%A4%E6%A8%A1%E5%BC%8F"></a>集群模式</h2>
<h3 id="-421"><a class="markdownIt-Anchor" href="#-421">#</a> <a href="#%E9%9B%86%E7%BE%A4%E6%A6%82%E8%BF%B0"></a>集群概述</h3>
<p>集群就是使用网络将若干台计算机联通起来，并提供统一的管理方式，使其对外呈现单机的服务效果</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d2545392539422538362545372542452541342545352539422542452545372541342542412e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/3df4cbabe94965c8c259746aa140c0dd3268b0e8cd0c93d171f7244574dfad0d/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d2545392539422538362545372542452541342545352539422542452545372541342542412e706e67">https://camo.githubusercontent.com/3df4cbabe94965c8c259746aa140c0dd3268b0e8cd0c93d171f7244574dfad0d/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d2545392539422538362545372542452541342545352539422542452545372541342542412e706e67</a>)</p>
<p><strong>集群作用：</strong></p>
<ul>
<li>分散单台服务器的访问压力，实现负载均衡</li>
<li>分散单台服务器的存储压力，实现可扩展性</li>
<li>降低单台服务器宕机带来的业务灾难</li>
</ul>
<hr>
<h3 id="-422"><a class="markdownIt-Anchor" href="#-422">#</a> <a href="#%E7%BB%93%E6%9E%84%E8%AE%BE%E8%AE%A1"></a>结构设计</h3>
<p><strong>数据存储设计：</strong></p>
<ol>
<li>
<p>通过算法设计，计算出 key 应该保存的位置（类似哈希寻址）</p>
<pre class="line-numbers language-gfm" data-language="gfm"><code class="language-gfm">key -&gt; CRC16(key) -&gt; 值 -&gt; %16384 -&gt; 存储位置<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>将所有的存储空间计划切割成 16384 份，每台主机保存一部分</p>
<p>注意：每份代表的是一个存储空间，不是一个 key 的保存空间，可以存储多个 key</p>
</li>
<li>
<p>将 key 按照计算出的结果放到对应的存储空间</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/0186096e64d9cdd09535135509243565e903b42b73cd0c1037090dbfd72caf79/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732de99b86e7bea4e5ad98e582a8e7a9bae997b42e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/0186096e64d9cdd09535135509243565e903b42b73cd0c1037090dbfd72caf79/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732de99b86e7bea4e5ad98e582a8e7a9bae997b42e706e67">https://camo.githubusercontent.com/0186096e64d9cdd09535135509243565e903b42b73cd0c1037090dbfd72caf79/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732de99b86e7bea4e5ad98e582a8e7a9bae997b42e706e67</a>)</p>
</li>
</ol>
<p>查找数据：</p>
<ul>
<li>各个数据库相互通信，保存各个库中槽的编号数据</li>
<li>一次命中，直接返回</li>
<li>一次未命中，告知具体位置，最多两次命中</li>
</ul>
<p>设置数据：系统默认存储到某一个</p>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://camo.githubusercontent.com/ba001911a1145f37c7d96eba6b48847d19285243e47debdf4b61abdbea5f2793/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732de99b86e7bea4e69fa5e689bee695b0e68dae2e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/ba001911a1145f37c7d96eba6b48847d19285243e47debdf4b61abdbea5f2793/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732de99b86e7bea4e69fa5e689bee695b0e68dae2e706e67">https://camo.githubusercontent.com/ba001911a1145f37c7d96eba6b48847d19285243e47debdf4b61abdbea5f2793/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732de99b86e7bea4e69fa5e689bee695b0e68dae2e706e67</a>)</p>
<hr>
<h3 id="-423"><a class="markdownIt-Anchor" href="#-423">#</a> <a href="#%E7%BB%93%E6%9E%84%E6%90%AD%E5%BB%BA"></a>结构搭建</h3>
<p>整体框架：</p>
<ul>
<li>配置服务器（3 主 3 从）</li>
<li>建立通信（Meet）</li>
<li>分槽（Slot）</li>
<li>搭建主从（master-slave）</li>
</ul>
<p>创建集群 conf 配置文件：</p>
<ul>
<li>
<p>redis-6501.conf</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">port <span class="token number">6501</span>
<span class="token function">dir</span> <span class="token string">"/redis/data"</span>
dbfilename <span class="token string">"dump-6501.rdb"</span>
cluster-enabled <span class="token function">yes</span>
cluster-config-file <span class="token string">"cluster-6501.conf"</span>
cluster-node-timeout <span class="token number">5000</span>

<span class="token comment">#其他配置文件参照上面的修改端口即可，内容完全一样</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>服务端启动：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">redis-server config_file_name<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>客户端启动：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">redis-cli -p <span class="token number">6504</span> -c<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<p><strong>cluster 配置：</strong></p>
<ul>
<li>
<p>是否启用 cluster，加入 cluster 节点</p>
<pre class="line-numbers language-ini" data-language="ini"><code class="language-ini">cluster-enabled yes|no<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>cluster 配置文件名，该文件属于自动生成，仅用于快速查找文件并查询文件内容</p>
<pre class="line-numbers language-ini" data-language="ini"><code class="language-ini">cluster-config-file filename<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>节点服务响应超时时间，用于判定该节点是否下线或切换为从节点</p>
<pre class="line-numbers language-ini" data-language="ini"><code class="language-ini">cluster-node-timeout milliseconds<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>master 连接的 slave 最小数量</p>
<pre class="line-numbers language-ini" data-language="ini"><code class="language-ini">cluster-migration-barrier min_slave_number<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<p>客户端启动命令：</p>
<p><strong>cluster 节点操作命令（客户端命令）：</strong></p>
<ul>
<li>
<p>查看集群节点信息</p>
<pre class="line-numbers language-ini" data-language="ini"><code class="language-ini">cluster nodes<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>更改 slave 指向新的 master</p>
<pre class="line-numbers language-ini" data-language="ini"><code class="language-ini">cluster replicate master-id<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>发现一个新节点，新增 master</p>
<pre class="line-numbers language-ini" data-language="ini"><code class="language-ini">cluster meet ip:port<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>忽略一个没有 solt 的节点</p>
<pre class="line-numbers language-ini" data-language="ini"><code class="language-ini">cluster forget server_id<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>手动故障转移</p>
<pre class="line-numbers language-ini" data-language="ini"><code class="language-ini">cluster failover<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<p><strong>集群操作命令（Linux）：</strong></p>
<ul>
<li>
<p>创建集群</p>
<pre class="line-numbers language-ini" data-language="ini"><code class="language-ini">redis-cli –-cluster create masterhost1:masterport1 masterhost2:masterport2  masterhost3:masterport3 [masterhostn:masterportn …] slavehost1:slaveport1  slavehost2:slaveport2 slavehost3:slaveport3 -–cluster-replicas n<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>注意：master 与 slave 的数量要匹配，一个 master 对应 n 个 slave，由最后的参数 n 决定。master 与 slave 的匹配顺序为第一个 master 与前 n 个 slave 分为一组，形成主从结构</p>
</li>
<li>
<p>添加 master 到当前集群中，连接时可以指定任意现有节点地址与端口</p>
<pre class="line-numbers language-ini" data-language="ini"><code class="language-ini">redis-cli --cluster add-node new-master-host:new-master-port now-host:now-port<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>添加 slave</p>
<pre class="line-numbers language-ini" data-language="ini"><code class="language-ini">redis-cli --cluster add-node new-slave-host:new-slave-port master-host:master-port --cluster-slave --cluster-master-id masterid<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>删除节点，如果删除的节点是 master，必须保障其中没有槽 slot</p>
<pre class="line-numbers language-ini" data-language="ini"><code class="language-ini">redis-cli --cluster del-node del-slave-host:del-slave-port del-slave-id<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>重新分槽，分槽是从具有槽的 master 中划分一部分给其他 master，过程中不创建新的槽</p>
<pre class="line-numbers language-ini" data-language="ini"><code class="language-ini">redis-cli --cluster reshard new-master-host:new-master:port --cluster-from src-  master-id1, src-master-id2, src-master-idn --cluster-to target-master-id --  cluster-slots slots<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>注意：将需要参与分槽的所有 masterid 不分先后顺序添加到参数中，使用  <code>,</code>  分隔，指定目标得到的槽的数量，所有的槽将平均从每个来源的 master 处获取</p>
</li>
<li>
<p>重新分配槽，从具有槽的 master 中分配指定数量的槽到另一个 master 中，常用于清空指定 master 中的槽</p>
<pre class="line-numbers language-ini" data-language="ini"><code class="language-ini">redis-cli --cluster reshard src-master-host:src-master-port --cluster-from src-  master-id --cluster-to target-master-id --cluster-slots slots --cluster-yes<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<hr>
<h2 id="-424"><a class="markdownIt-Anchor" href="#-424">#</a> <a href="#%E7%BC%93%E5%AD%98%E6%96%B9%E6%A1%88"></a>缓存方案</h2>
<h3 id="-425"><a class="markdownIt-Anchor" href="#-425">#</a> <a href="#%E7%BC%93%E5%AD%98%E6%A8%A1%E5%BC%8F"></a>缓存模式</h3>
<h4 id="-426"><a class="markdownIt-Anchor" href="#-426">#</a> <a href="#%E6%97%81%E8%B7%AF%E7%BC%93%E5%AD%98"></a>旁路缓存</h4>
<p>缓存本质：弥补 CPU 的高算力和 IO 的慢读写之间巨大的鸿沟</p>
<p>旁路缓存模式 Cache Aside Pattern 是平时使用比较多的一个缓存读写模式，比较适合读请求比较多的场景</p>
<p>Cache Aside Pattern 中服务端需要同时维系 DB 和 cache，并且是以 DB 的结果为准</p>
<ul>
<li>写操作：先更新 DB，然后直接删除 cache</li>
<li>读操作：从 cache 中读取数据，读取到就直接返回；读取不到就从 DB 中读取数据返回，并放到 cache</li>
</ul>
<p>时序导致的不一致问题：</p>
<ul>
<li>
<p>在写数据的过程中，不能先删除 cache 再更新 DB，因为会造成缓存的不一致。比如请求 1 先写数据 A，请求 2 随后读数据 A，当请求 1 删除 cache 后，请求 2 直接读取了 DB，此时请求 1 还没写入 DB（延迟双删）</p>
</li>
<li>
<p>在写数据的过程中，先更新 DB 再删除 cache 也会出现问题，但是概率很小，因为缓存的写入速度非常快</p>
</li>
</ul>
<p>旁路缓存的缺点：</p>
<ul>
<li>首次请求数据一定不在 cache 的问题，一般采用缓存预热的方法，将热点数据可以提前放入 cache 中</li>
<li>写操作比较频繁的话导致 cache 中的数据会被频繁被删除，影响缓存命中率</li>
</ul>
<hr>
<h4 id="-427"><a class="markdownIt-Anchor" href="#-427">#</a> <a href="#%E8%AF%BB%E5%86%99%E7%A9%BF%E9%80%8F"></a>读写穿透</h4>
<p>读写穿透模式 Read/Write Through Pattern：服务端把 cache 视为主要数据存储，从中读取数据并将数据写入其中，cache 负责将此数据同步写入 DB，从而减轻了应用程序的职责</p>
<ul>
<li>
<p>写操作：先查 cache，cache 中不存在，直接更新 DB；cache 中存在则先更新 cache，然后 cache 服务更新 DB（同步更新 cache 和 DB）</p>
</li>
<li>
<p>读操作：从 cache 中读取数据，读取到就直接返回 ；读取不到先从 DB 加载，写入到 cache 后返回响应</p>
<p>Read-Through Pattern 实际只是在 Cache-Aside Pattern 之上进行了封装。在 Cache-Aside Pattern 下，发生读请求的时候，如果 cache 中不存在对应的数据，是由客户端负责把数据写入 cache，而 Read Through Pattern 则是 cache 服务自己来写入缓存的，对客户端是透明的</p>
</li>
</ul>
<p>Read-Through Pattern 也存在首次不命中的问题，采用缓存预热解决</p>
<hr>
<h4 id="-428"><a class="markdownIt-Anchor" href="#-428">#</a> <a href="#%E5%BC%82%E6%AD%A5%E7%BC%93%E5%AD%98"></a>异步缓存</h4>
<p>异步缓存写入 Write Behind Pattern 由 cache 服务来负责 cache 和 DB 的读写，对比读写穿透不同的是 Write Behind Caching 是只更新缓存，不直接更新 DB，改为<strong>异步批量</strong>的方式来更新 DB，可以减小写的成本</p>
<p>缺点：这种模式对数据一致性没有高要求，可能出现 cache 还没异步更新 DB，服务就挂掉了</p>
<p>应用：</p>
<ul>
<li>
<p>DB 的写性能非常高，适合一些数据经常变化又对数据一致性要求不高的场景，比如浏览量、点赞量</p>
</li>
<li>
<p>MySQL 的 InnoDB Buffer Pool 机制用到了这种策略</p>
</li>
</ul>
<hr>
<h3 id="-429"><a class="markdownIt-Anchor" href="#-429">#</a> <a href="#%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4"></a>缓存一致</h3>
<p>使用缓存代表不需要强一致性，只需要最终一致性</p>
<p>缓存不一致的方法：</p>
<ul>
<li>数据库和缓存数据强一致场景：
<ul>
<li>更新 DB 时同样更新 cache，加一个锁来保证更新 cache 时不存在线程安全问题，这样可以增加命中率</li>
<li>延迟双删：先淘汰缓存再写数据库，休眠 1 秒再次淘汰缓存，可以将 1 秒内造成的缓存脏数据再次删除</li>
<li>CDC 同步：通过 canal 订阅 MySQL binlog 的变更上报给 Kafka，系统监听 Kafka 消息触发缓存失效</li>
</ul>
</li>
<li>可以短暂允许数据库和缓存数据不一致场景：更新 DB 的时候同样更新 cache，但是给缓存加一个比较短的过期时间，这样就可以保证即使数据不一致影响也比较小</li>
</ul>
<p>参考文章：<a target="_blank" rel="noopener" href="http://cccboke.com/archives/2020-09-30-21-29-56">http://cccboke.com/archives/2020-09-30-21-29-56</a></p>
<hr>
<h3 id="-430"><a class="markdownIt-Anchor" href="#-430">#</a> <a href="#%E4%BC%81%E4%B8%9A%E6%96%B9%E6%A1%88"></a>企业方案</h3>
<h4 id="-431"><a class="markdownIt-Anchor" href="#-431">#</a> <a href="#%E7%BC%93%E5%AD%98%E9%A2%84%E7%83%AD"></a>缓存预热</h4>
<p>场景：宕机，服务器启动后迅速宕机</p>
<p>问题排查：</p>
<ol>
<li>
<p>请求数量较高，大量的请求过来之后都需要去从缓存中获取数据，但是缓存中又没有，此时从数据库中查找数据然后将数据再存入缓存，造成了短期内对 redis 的高强度操作从而导致问题</p>
</li>
<li>
<p>主从之间数据吞吐量较大，数据同步操作频度较高</p>
</li>
</ol>
<p>解决方案：</p>
<ul>
<li>
<p>前置准备工作：</p>
<ol>
<li>
<p>日常例行统计数据访问记录，统计访问频度较高的热点数据</p>
</li>
<li>
<p>利用 LRU 数据删除策略，构建数据留存队列例如：storm 与 kafka 配合</p>
</li>
</ol>
</li>
<li>
<p>准备工作：</p>
<ol>
<li>
<p>将统计结果中的数据分类，根据级别，redis 优先加载级别较高的热点数据</p>
</li>
<li>
<p>利用分布式多服务器同时进行数据读取，提速数据加载过程</p>
</li>
<li>
<p>热点数据主从同时预热</p>
</li>
</ol>
</li>
<li>
<p>实施：</p>
<ol start="4">
<li>
<p>使用脚本程序固定触发数据预热过程</p>
</li>
<li>
<p>如果条件允许，使用了 CDN（内容分发网络），效果会更好</p>
</li>
</ol>
</li>
</ul>
<p>总的来说：缓存预热就是系统启动前，提前将相关的缓存数据直接加载到缓存系统。避免在用户请求的时候，先查询数据库，然后再将数据缓存的问题，用户直接查询事先被预热的缓存数据！</p>
<hr>
<h4 id="-432"><a class="markdownIt-Anchor" href="#-432">#</a> <a href="#%E7%BC%93%E5%AD%98%E9%9B%AA%E5%B4%A9"></a>缓存雪崩</h4>
<p>场景：数据库服务器崩溃，一连串的问题会随之而来</p>
<p>问题排查：在一个较短的时间内，<strong>缓存中较多的 key 集中过期</strong>，此周期内请求访问过期的数据 Redis 未命中，Redis 向数据库获取数据，数据库同时收到大量的请求无法及时处理。</p>
<p>解决方案：</p>
<ol>
<li>加锁，慎用</li>
<li>设置热点数据永远不过期，如果缓存数据库是分布式部署，将热点数据均匀分布在不同搞得缓存数据库中</li>
<li>缓存数据的过期时间设置随机，防止同一时间大量数据过期现象发生</li>
<li>构建<strong>多级缓存</strong>架构，Nginx 缓存 + Redis 缓存 + ehcache 缓存</li>
<li>灾难预警机制，监控 Redis 服务器性能指标，CPU 使用率、内存容量、平均响应时间、线程数</li>
<li>限流、降级：短时间范围内牺牲一些客户体验，限制一部分请求访问，降低应用服务器压力，待业务低速运转后再逐步放开访问</li>
</ol>
<p>总的来说：缓存雪崩就是瞬间过期数据量太大，导致对数据库服务器造成压力。如能够有效避免过期时间集中，可以有效解决雪崩现象的出现（约 40%），配合其他策略一起使用，并监控服务器的运行数据，根据运行记录做快速调整。</p>
<hr>
<h4 id="-433"><a class="markdownIt-Anchor" href="#-433">#</a> <a href="#%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF"></a>缓存击穿</h4>
<p>场景：系统平稳运行过程中，数据库连接量瞬间激增，Redis 服务器无大量 key 过期，Redis 内存平稳无波动，Redis 服务器 CPU 正常，但是数据库崩溃</p>
<p>问题排查：</p>
<ol>
<li>
<p><strong>Redis 中某个 key 过期，该 key 访问量巨大</strong></p>
</li>
<li>
<p>多个数据请求从服务器直接压到 Redis 后，均未命中</p>
</li>
<li>
<p>Redis 在短时间内发起了大量对数据库中同一数据的访问</p>
</li>
</ol>
<p>简而言之两点：单个 key 高热数据，key 过期</p>
<p>解决方案：</p>
<ol>
<li>
<p>预先设定：以电商为例，每个商家根据店铺等级，指定若干款主打商品，在购物节期间，加大此类信息 key 的过期时长 注意：购物节不仅仅指当天，以及后续若干天，访问峰值呈现逐渐降低的趋势</p>
</li>
<li>
<p>现场调整：监控访问量，对自然流量激增的数据<strong>延长过期时间或设置为永久性 key</strong></p>
</li>
<li>
<p>后台刷新数据：启动定时任务，高峰期来临之前，刷新数据有效期，确保不丢失</p>
</li>
<li>
<p><strong>二级缓存</strong>：设置不同的失效时间，保障不会被同时淘汰就行</p>
</li>
<li>
<p>加锁：分布式锁，防止被击穿，但是要注意也是性能瓶颈，慎重</p>
</li>
</ol>
<p>总的来说：缓存击穿就是单个高热数据过期的瞬间，数据访问量较大，未命中 Redis 后，发起了大量对同一数据的数据库访问，导致对数据库服务器造成压力。应对策略应该在业务数据分析与预防方面进行，配合运行监控测试与即时调整策略，毕竟单个 key 的过期监控难度较高，配合雪崩处理策略即可</p>
<hr>
<h4 id="-434"><a class="markdownIt-Anchor" href="#-434">#</a> <a href="#%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F"></a>缓存穿透</h4>
<p>场景：系统平稳运行过程中，应用服务器流量随时间增量较大，Redis 服务器命中率随时间逐步降低，Redis 内存平稳，内存无压力，Redis 服务器 CPU 占用激增，数据库服务器压力激增，数据库崩溃</p>
<p>问题排查：</p>
<ol>
<li>
<p>Redis 中大面积出现未命中</p>
</li>
<li>
<p>出现非正常 URL 访问</p>
</li>
</ol>
<p>问题分析：</p>
<ul>
<li>访问了不存在的数据，跳过了 Redis 缓存，数据库页查询不到对应数据</li>
<li>Redis 获取到 null 数据未进行持久化，直接返回</li>
<li>出现黑客攻击服务器</li>
</ul>
<p>解决方案：</p>
<ol>
<li>
<p>缓存 null：对查询结果为 null 的数据进行缓存，设定短时限，例如 30-60 秒，最高 5 分钟</p>
</li>
<li>
<p>白名单策略：提前预热各种分类<strong>数据 id 对应的 bitmaps</strong>，id 作为 bitmaps 的 offset，相当于设置了数据白名单。当加载正常数据时放行，加载异常数据时直接拦截（效率偏低），也可以使用布隆过滤器（有关布隆过滤器的命中问题对当前状况可以忽略）</p>
</li>
<li>
<p>实时监控：实时监控 Redis 命中率（业务正常范围时，通常会有一个波动值）与 null 数据的占比</p>
<ul>
<li>非活动时段波动：通常检测 3-5 倍，超过 5 倍纳入重点排查对象</li>
<li>活动时段波动：通常检测 10-50 倍，超过 50 倍纳入重点排查对象</li>
</ul>
<p>根据倍数不同，启动不同的排查流程。然后使用黑名单进行防控</p>
</li>
<li>
<p>key 加密：临时启动防灾业务 key，对 key 进行业务层传输加密服务，设定校验程序，过来的 key 校验；例如每天随机分配 60 个加密串，挑选 2 到 3 个，混淆到页面数据 id 中，发现访问 key 不满足规则，驳回数据访问</p>
</li>
</ol>
<p>总的来说：缓存击穿是指访问了不存在的数据，跳过了合法数据的 Redis 数据缓存阶段，每次访问数据库，导致对数据库服务器造成压力。通常此类数据的出现量是一个较低的值，当出现此类情况以毒攻毒，并及时报警。无论是黑名单还是白名单，都是对整体系统的压力，警报解除后尽快移除</p>
<p>参考视频：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV15y4y1r7X3">https://www.bilibili.com/video/BV15y4y1r7X3</a></p>
<hr>
<h3 id="-435"><a class="markdownIt-Anchor" href="#-435">#</a> <a href="#%E6%80%A7%E8%83%BD%E6%8C%87%E6%A0%87"></a>性能指标</h3>
<p>Redis 中的监控指标如下：</p>
<ul>
<li>
<p>性能指标：Performance</p>
<p>响应请求的平均时间：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">latency<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>平均每秒处理请求总数：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">instantaneous_ops_per_sec<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>缓存查询命中率（通过查询总次数与查询得到非 nil 数据总次数计算而来）：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">hit_rate<span class="token punctuation">(</span>calculated<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>内存指标：Memory</p>
<p>当前内存使用量：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">used_memory<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>内存碎片率（关系到是否进行碎片整理）：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">mem_fragmentation_ratio<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>为避免内存溢出删除的 key 的总数量：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">evicted_keys<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>基于阻塞操作（BLPOP 等）影响的客户端数量：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">blocked_clients<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>基本活动指标：Basic_activity</p>
<p>当前客户端连接总数：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">connected_clients<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>当前连接 slave 总数：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">connected_slaves<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>最后一次主从信息交换距现在的秒：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">master_last_io_seconds_ago<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>key 的总数：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">keyspace<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>持久性指标：Persistence</p>
<p>当前服务器其最后一次 RDB 持久化的时间：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">rdb_last_save_time<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>当前服务器最后一次 RDB 持久化后数据变化总量：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">rdb_changes_since_last_save<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>错误指标：Error</p>
<p>被拒绝连接的客户端总数（基于达到最大连接值的因素）：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">rejected_connections<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>key 未命中的总次数：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">keyspace_misses<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>主从断开的秒数：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">master_link_down_since_seconds<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<p>要对 redis 的相关指标进行监控，我们可以采用一些用具：</p>
<ul>
<li>CloudInsight Redis</li>
<li>Prometheus</li>
<li>Redis-stat</li>
<li>Redis-faina</li>
<li>RedisLive</li>
<li>zabbix</li>
</ul>
<p>命令工具：</p>
<ul>
<li>
<p>benchmark</p>
<p>测试当前服务器的并发性能：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">redis-benchmark <span class="token punctuation">[</span>-h <span class="token punctuation">]</span> <span class="token punctuation">[</span>-p <span class="token punctuation">]</span> <span class="token punctuation">[</span>-c <span class="token punctuation">]</span> <span class="token punctuation">[</span>-n <span class="token operator">&lt;</span>requests<span class="token punctuation">]</span><span class="token operator">></span> <span class="token punctuation">[</span>-k <span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>范例：100 个连接，5000 次请求对应的性能</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">redis-benchmark -c <span class="token number">100</span> -n <span class="token number">5000</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>[<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d72656469732d62656e63686d61726b2545362538432538372545342542422541342e706e67" alt=""></p>
<p>](<a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/004427565e853954e0c0cfe3d56cac9e10a52b9ccc60729836c089620dab8f69/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d72656469732d62656e63686d61726b2545362538432538372545342542422541342e706e67">https://camo.githubusercontent.com/004427565e853954e0c0cfe3d56cac9e10a52b9ccc60729836c089620dab8f69/68747470733a2f2f67697465652e636f6d2f7365617a65616e2f696d616765732f7261772f6d61737465722f44422f52656469732d72656469732d62656e63686d61726b2545362538432538372545342542422541342e706e67</a>)</p>
</li>
<li>
<p>redis-cli</p>
<p>monitor：启动服务器调试信息</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">monitor<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>slowlog：慢日志</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">slowlog <span class="token punctuation">[</span>operator<span class="token punctuation">]</span>    <span class="token comment">#获取慢查询日志</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>get ：获取慢查询日志信息</li>
<li>len ：获取慢查询日志条目数</li>
<li>reset ：重置慢查询日志</li>
</ul>
<p>相关配置：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">slowlog-log-slower-than <span class="token number">1000</span> <span class="token comment">#设置慢查询的时间下线，单位：微妙</span>
slowlog-max-len <span class="token number">100</span>	<span class="token comment">#设置慢查询命令对应的日志显示长度，单位：命令数</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Harry Qu</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://harryqu1229.github.io/2021/12/30/mysql+jdbc+redis/">https://harryqu1229.github.io/2021/12/30/mysql+jdbc+redis/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/jdbc/">jdbc</a><a class="post-meta__tags" href="/tags/fundamental/">fundamental</a><a class="post-meta__tags" href="/tags/databases/">databases</a><a class="post-meta__tags" href="/tags/mysql/">mysql</a><a class="post-meta__tags" href="/tags/redis/">redis</a></div><div class="post_share"><div class="addthis_inline_share_toolbox"></div><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-621848f44e1c3724" async="async"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/12/29/webpack5%E5%9F%BA%E7%A1%80/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/default-covers/hello-world.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">My Webpack5 Advanced notes</div></div></a></div><div class="next-post pull-right"><a href="/2021/12/30/maven,netty,rocketmq/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/default-covers/house.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">Maven + Netty + Rocketmq</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2021/12/31/MySQL%E4%B8%80%E7%82%B9%E7%AC%94%E8%AE%B0/" title="Mysql notes"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/default-covers/town.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-12-31</div><div class="title">Mysql notes</div></div></a></div><div><a href="/2021/12/31/MySQL%E5%B8%B8%E7%94%A8%E5%87%BD%E6%95%B0%E6%B1%87%E6%80%BB/" title="Mysql commonly used functions"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/default-covers/house.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-12-31</div><div class="title">Mysql commonly used functions</div></div></a></div><div><a href="/2021/12/30/MySQL/" title="My Mysql Notes"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/default-covers/mountain.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-12-30</div><div class="title">My Mysql Notes</div></div></a></div><div><a href="/2021/12/31/MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E5%BC%80%E5%8F%91%E7%9A%84%E4%B8%89%E5%8D%81%E5%85%AD%E6%9D%A1%E5%86%9B%E8%A7%84/" title="Mysql principles"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/default-covers/code.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-12-31</div><div class="title">Mysql principles</div></div></a></div><div><a href="/2022/01/03/MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BE%E8%AE%A1%E8%A7%84%E8%8C%83/" title="Mysql design protocol"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/default-covers/forest.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-03</div><div class="title">Mysql design protocol</div></div></a></div><div><a href="/2022/01/15/%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/" title="Mysql data types"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/default-covers/code.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-15</div><div class="title">Mysql data types</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comment</span></div><div id="comment-switch"><span class="first-comment">Disqus</span><span class="switch-btn"></span><span class="second-comment">Gitalk</span></div></div><div class="comment-wrap"><div><div id="disqus_thread"></div></div><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/avatar.jpeg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Harry Qu</div><div class="author-info__description">Software Engineering Student</div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">158</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">84</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">57</div></a></div></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/HarryQu1229"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://www.linkedin.com/in/harry-qu-a0a38220a" target="_blank" title="LinkedIn"><i class="fab fa-linkedin"></i></a><a class="social-icon" href="https://github.com/HarryQu1229" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:Harryqu666@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="weixin://dl/chat?harry666ya" target="_blank" title="Wechat"><i class="fab fa-weixin"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">be healthy, stay safe</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text"> MySQL</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-2"><span class="toc-number">1.1.</span> <span class="toc-text"> 简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-3"><span class="toc-number">1.1.1.</span> <span class="toc-text"> 数据库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-4"><span class="toc-number">1.1.2.</span> <span class="toc-text"> MySQL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-5"><span class="toc-number">1.1.3.</span> <span class="toc-text"> 常用工具</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-6"><span class="toc-number">1.1.3.1.</span> <span class="toc-text"> mysql</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-7"><span class="toc-number">1.1.3.2.</span> <span class="toc-text"> admin</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-8"><span class="toc-number">1.1.3.3.</span> <span class="toc-text"> binlog</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-9"><span class="toc-number">1.1.3.4.</span> <span class="toc-text"> dump</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#-10"><span class="toc-number">1.1.3.4.1.</span> <span class="toc-text"> 命令介绍</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-11"><span class="toc-number">1.1.3.4.2.</span> <span class="toc-text"> 数据备份</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-12"><span class="toc-number">1.1.3.5.</span> <span class="toc-text"> import</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-13"><span class="toc-number">1.1.3.6.</span> <span class="toc-text"> show</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-14"><span class="toc-number">1.2.</span> <span class="toc-text"> 体系结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-15"><span class="toc-number">1.2.1.</span> <span class="toc-text"> 整体架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-16"><span class="toc-number">1.2.2.</span> <span class="toc-text"> 执行流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-17"><span class="toc-number">1.2.2.1.</span> <span class="toc-text"> 连接器</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#-18"><span class="toc-number">1.2.2.1.1.</span> <span class="toc-text"> 连接原理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-19"><span class="toc-number">1.2.2.1.2.</span> <span class="toc-text"> 连接状态</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-20"><span class="toc-number">1.2.2.2.</span> <span class="toc-text"> 查询缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#-21"><span class="toc-number">1.2.2.2.1.</span> <span class="toc-text"> 工作流程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-22"><span class="toc-number">1.2.2.2.2.</span> <span class="toc-text"> 缓存配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-23"><span class="toc-number">1.2.2.2.3.</span> <span class="toc-text"> 缓存失效</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-24"><span class="toc-number">1.2.2.3.</span> <span class="toc-text"> 分析器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-25"><span class="toc-number">1.2.2.4.</span> <span class="toc-text"> 优化器</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#-26"><span class="toc-number">1.2.2.4.1.</span> <span class="toc-text"> 成本分析</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-27"><span class="toc-number">1.2.2.4.2.</span> <span class="toc-text"> 统计数据</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-28"><span class="toc-number">1.2.2.4.3.</span> <span class="toc-text"> 错选索引</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-29"><span class="toc-number">1.2.2.5.</span> <span class="toc-text"> 执行器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-30"><span class="toc-number">1.2.3.</span> <span class="toc-text"> 数据空间</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-31"><span class="toc-number">1.2.3.1.</span> <span class="toc-text"> 数据存储</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-32"><span class="toc-number">1.2.3.2.</span> <span class="toc-text"> 数据删除</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-33"><span class="toc-number">1.2.3.3.</span> <span class="toc-text"> 重建数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-34"><span class="toc-number">1.2.3.4.</span> <span class="toc-text"> inplace</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-35"><span class="toc-number">1.3.</span> <span class="toc-text"> 单表操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-36"><span class="toc-number">1.3.1.</span> <span class="toc-text"> SQL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-37"><span class="toc-number">1.3.2.</span> <span class="toc-text"> DDL</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-38"><span class="toc-number">1.3.2.1.</span> <span class="toc-text"> 数据库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-39"><span class="toc-number">1.3.2.2.</span> <span class="toc-text"> 数据表</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-40"><span class="toc-number">1.3.3.</span> <span class="toc-text"> DML</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-41"><span class="toc-number">1.3.3.1.</span> <span class="toc-text"> INSERT</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-42"><span class="toc-number">1.3.3.2.</span> <span class="toc-text"> UPDATE</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-43"><span class="toc-number">1.3.3.3.</span> <span class="toc-text"> DELETE</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-44"><span class="toc-number">1.3.4.</span> <span class="toc-text"> DQL</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-45"><span class="toc-number">1.3.4.1.</span> <span class="toc-text"> 查询语法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-46"><span class="toc-number">1.3.4.2.</span> <span class="toc-text"> 查询全部</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-47"><span class="toc-number">1.3.4.3.</span> <span class="toc-text"> 条件查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-48"><span class="toc-number">1.3.4.4.</span> <span class="toc-text"> 函数查询</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#-49"><span class="toc-number">1.3.4.4.1.</span> <span class="toc-text"> 聚合函数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-50"><span class="toc-number">1.3.4.4.2.</span> <span class="toc-text"> 文本函数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-51"><span class="toc-number">1.3.4.4.3.</span> <span class="toc-text"> 数字函数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-52"><span class="toc-number">1.3.4.4.4.</span> <span class="toc-text"> 日期函数</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-53"><span class="toc-number">1.3.4.5.</span> <span class="toc-text"> 正则查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-54"><span class="toc-number">1.3.4.6.</span> <span class="toc-text"> 排序查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-55"><span class="toc-number">1.3.4.7.</span> <span class="toc-text"> 分组查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-56"><span class="toc-number">1.3.4.8.</span> <span class="toc-text"> 分页查询</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-57"><span class="toc-number">1.4.</span> <span class="toc-text"> 多表操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-58"><span class="toc-number">1.4.1.</span> <span class="toc-text"> 约束分类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-59"><span class="toc-number">1.4.1.1.</span> <span class="toc-text"> 约束介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-60"><span class="toc-number">1.4.1.2.</span> <span class="toc-text"> 主键约束</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-61"><span class="toc-number">1.4.1.3.</span> <span class="toc-text"> 主键自增</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-62"><span class="toc-number">1.4.1.4.</span> <span class="toc-text"> 唯一约束</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-63"><span class="toc-number">1.4.1.5.</span> <span class="toc-text"> 非空约束</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-64"><span class="toc-number">1.4.1.6.</span> <span class="toc-text"> 外键约束</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-65"><span class="toc-number">1.4.1.7.</span> <span class="toc-text"> 外键级联</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-66"><span class="toc-number">1.4.2.</span> <span class="toc-text"> 多表设计</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-67"><span class="toc-number">1.4.2.1.</span> <span class="toc-text"> 一对一</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-68"><span class="toc-number">1.4.2.2.</span> <span class="toc-text"> 一对多</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-69"><span class="toc-number">1.4.2.3.</span> <span class="toc-text"> 多对多</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-70"><span class="toc-number">1.4.3.</span> <span class="toc-text"> 连接查询</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-71"><span class="toc-number">1.4.3.1.</span> <span class="toc-text"> 连接原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-72"><span class="toc-number">1.4.3.2.</span> <span class="toc-text"> 内外连接</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#-73"><span class="toc-number">1.4.3.2.1.</span> <span class="toc-text"> 内连接</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-74"><span class="toc-number">1.4.3.2.2.</span> <span class="toc-text"> 外连接</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-75"><span class="toc-number">1.4.3.3.</span> <span class="toc-text"> 关联查询</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-76"><span class="toc-number">1.4.4.</span> <span class="toc-text"> 嵌套查询</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-77"><span class="toc-number">1.4.4.1.</span> <span class="toc-text"> 查询分类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-78"><span class="toc-number">1.4.4.2.</span> <span class="toc-text"> 查询优化</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-79"><span class="toc-number">1.4.5.</span> <span class="toc-text"> 查询练习</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-80"><span class="toc-number">1.5.</span> <span class="toc-text"> 存储结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-81"><span class="toc-number">1.5.1.</span> <span class="toc-text"> 视图</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-82"><span class="toc-number">1.5.1.1.</span> <span class="toc-text"> 基本介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-83"><span class="toc-number">1.5.1.2.</span> <span class="toc-text"> 视图创建</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-84"><span class="toc-number">1.5.1.3.</span> <span class="toc-text"> 视图查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-85"><span class="toc-number">1.5.1.4.</span> <span class="toc-text"> 视图修改</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-86"><span class="toc-number">1.5.1.5.</span> <span class="toc-text"> 视图删除</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-87"><span class="toc-number">1.5.2.</span> <span class="toc-text"> 存储过程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-88"><span class="toc-number">1.5.2.1.</span> <span class="toc-text"> 基本介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-89"><span class="toc-number">1.5.2.2.</span> <span class="toc-text"> 基本操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-90"><span class="toc-number">1.5.2.3.</span> <span class="toc-text"> 存储语法</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#-91"><span class="toc-number">1.5.2.3.1.</span> <span class="toc-text"> 变量使用</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-92"><span class="toc-number">1.5.2.3.2.</span> <span class="toc-text"> IF 语句</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-93"><span class="toc-number">1.5.2.3.3.</span> <span class="toc-text"> 参数传递</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-94"><span class="toc-number">1.5.2.3.4.</span> <span class="toc-text"> CASE</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-95"><span class="toc-number">1.5.2.3.5.</span> <span class="toc-text"> WHILE</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-96"><span class="toc-number">1.5.2.3.6.</span> <span class="toc-text"> REPEAT</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-97"><span class="toc-number">1.5.2.3.7.</span> <span class="toc-text"> LOOP</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-98"><span class="toc-number">1.5.2.3.8.</span> <span class="toc-text"> 游标</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-99"><span class="toc-number">1.5.2.4.</span> <span class="toc-text"> 存储函数</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-100"><span class="toc-number">1.5.3.</span> <span class="toc-text"> 触发器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-101"><span class="toc-number">1.5.3.1.</span> <span class="toc-text"> 基本介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-102"><span class="toc-number">1.5.3.2.</span> <span class="toc-text"> 基本操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-103"><span class="toc-number">1.5.3.3.</span> <span class="toc-text"> 触发演示</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-104"><span class="toc-number">1.6.</span> <span class="toc-text"> 存储引擎</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-105"><span class="toc-number">1.6.1.</span> <span class="toc-text"> 基本介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-106"><span class="toc-number">1.6.2.</span> <span class="toc-text"> 引擎对比</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-107"><span class="toc-number">1.6.3.</span> <span class="toc-text"> 引擎操作</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-108"><span class="toc-number">1.7.</span> <span class="toc-text"> 索引机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-109"><span class="toc-number">1.7.1.</span> <span class="toc-text"> 索引介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-110"><span class="toc-number">1.7.1.1.</span> <span class="toc-text"> 基本介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-111"><span class="toc-number">1.7.1.2.</span> <span class="toc-text"> 索引分类</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-112"><span class="toc-number">1.7.2.</span> <span class="toc-text"> 索引操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-113"><span class="toc-number">1.7.3.</span> <span class="toc-text"> 聚簇索引</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-114"><span class="toc-number">1.7.3.1.</span> <span class="toc-text"> 索引对比</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-115"><span class="toc-number">1.7.3.2.</span> <span class="toc-text"> Innodb</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#-116"><span class="toc-number">1.7.3.2.1.</span> <span class="toc-text"> 聚簇索引</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-117"><span class="toc-number">1.7.3.2.2.</span> <span class="toc-text"> 辅助索引</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-118"><span class="toc-number">1.7.3.2.3.</span> <span class="toc-text"> 索引实现</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-119"><span class="toc-number">1.7.3.3.</span> <span class="toc-text"> MyISAM</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#-120"><span class="toc-number">1.7.3.3.1.</span> <span class="toc-text"> 非聚簇</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-121"><span class="toc-number">1.7.3.3.2.</span> <span class="toc-text"> 索引实现</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-122"><span class="toc-number">1.7.4.</span> <span class="toc-text"> 索引结构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-123"><span class="toc-number">1.7.4.1.</span> <span class="toc-text"> 数据页</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-124"><span class="toc-number">1.7.4.2.</span> <span class="toc-text"> BTree</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-125"><span class="toc-number">1.7.4.3.</span> <span class="toc-text"> B+Tree</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#-126"><span class="toc-number">1.7.4.3.1.</span> <span class="toc-text"> 数据结构</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-127"><span class="toc-number">1.7.4.3.2.</span> <span class="toc-text"> 优化结构</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-128"><span class="toc-number">1.7.4.3.3.</span> <span class="toc-text"> 索引维护</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-129"><span class="toc-number">1.7.5.</span> <span class="toc-text"> 设计原则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-130"><span class="toc-number">1.7.6.</span> <span class="toc-text"> 索引优化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-131"><span class="toc-number">1.7.6.1.</span> <span class="toc-text"> 覆盖索引</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-132"><span class="toc-number">1.7.6.2.</span> <span class="toc-text"> 索引下推</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-133"><span class="toc-number">1.7.6.3.</span> <span class="toc-text"> 前缀索引</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-134"><span class="toc-number">1.7.6.4.</span> <span class="toc-text"> 索引合并</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-135"><span class="toc-number">1.8.</span> <span class="toc-text"> 系统优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-136"><span class="toc-number">1.8.1.</span> <span class="toc-text"> 优化步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-137"><span class="toc-number">1.8.1.1.</span> <span class="toc-text"> 执行频率</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-138"><span class="toc-number">1.8.1.2.</span> <span class="toc-text"> 定位低效</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-139"><span class="toc-number">1.8.1.3.</span> <span class="toc-text"> EXPLAIN</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#-140"><span class="toc-number">1.8.1.3.1.</span> <span class="toc-text"> 执行计划</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-141"><span class="toc-number">1.8.1.3.2.</span> <span class="toc-text"> id</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-142"><span class="toc-number">1.8.1.3.3.</span> <span class="toc-text"> select</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-143"><span class="toc-number">1.8.1.3.4.</span> <span class="toc-text"> type</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-144"><span class="toc-number">1.8.1.3.5.</span> <span class="toc-text"> key</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-145"><span class="toc-number">1.8.1.3.6.</span> <span class="toc-text"> Extra</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-146"><span class="toc-number">1.8.1.4.</span> <span class="toc-text"> PROFILES</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-147"><span class="toc-number">1.8.1.5.</span> <span class="toc-text"> TRACE</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-148"><span class="toc-number">1.8.2.</span> <span class="toc-text"> 索引失效</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-149"><span class="toc-number">1.8.2.1.</span> <span class="toc-text"> 创建索引</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-150"><span class="toc-number">1.8.2.2.</span> <span class="toc-text"> 避免失效</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#-151"><span class="toc-number">1.8.2.2.1.</span> <span class="toc-text"> 语句错误</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-152"><span class="toc-number">1.8.2.2.2.</span> <span class="toc-text"> 系统优化</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-153"><span class="toc-number">1.8.2.3.</span> <span class="toc-text"> 底层原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-154"><span class="toc-number">1.8.2.4.</span> <span class="toc-text"> 查看索引</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-155"><span class="toc-number">1.8.3.</span> <span class="toc-text"> SQL 优化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-156"><span class="toc-number">1.8.3.1.</span> <span class="toc-text"> 覆盖索引</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-157"><span class="toc-number">1.8.3.2.</span> <span class="toc-text"> 减少访问</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-158"><span class="toc-number">1.8.3.3.</span> <span class="toc-text"> 数据插入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-159"><span class="toc-number">1.8.3.4.</span> <span class="toc-text"> ORDER BY</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-160"><span class="toc-number">1.8.3.5.</span> <span class="toc-text"> GROUP BY</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-161"><span class="toc-number">1.8.3.6.</span> <span class="toc-text"> OR</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-162"><span class="toc-number">1.8.3.7.</span> <span class="toc-text"> 嵌套查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-163"><span class="toc-number">1.8.3.8.</span> <span class="toc-text"> 分页查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-164"><span class="toc-number">1.8.3.9.</span> <span class="toc-text"> 使用提示</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-165"><span class="toc-number">1.8.3.10.</span> <span class="toc-text"> 统计计数</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-166"><span class="toc-number">1.8.4.</span> <span class="toc-text"> 内存优化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-167"><span class="toc-number">1.8.4.1.</span> <span class="toc-text"> 优化原则</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-168"><span class="toc-number">1.8.4.2.</span> <span class="toc-text"> 缓冲内存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-169"><span class="toc-number">1.8.4.3.</span> <span class="toc-text"> 内存管理</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#-170"><span class="toc-number">1.8.4.3.1.</span> <span class="toc-text"> Free 链表</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-171"><span class="toc-number">1.8.4.3.2.</span> <span class="toc-text"> Flush 链表</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-172"><span class="toc-number">1.8.4.3.3.</span> <span class="toc-text"> LRU 链表</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-173"><span class="toc-number">1.8.4.4.</span> <span class="toc-text"> 参数优化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-174"><span class="toc-number">1.8.4.5.</span> <span class="toc-text"> 其他内存</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-175"><span class="toc-number">1.8.5.</span> <span class="toc-text"> 并发优化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-176"><span class="toc-number">1.9.</span> <span class="toc-text"> 事务机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-177"><span class="toc-number">1.9.1.</span> <span class="toc-text"> 基本介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-178"><span class="toc-number">1.9.2.</span> <span class="toc-text"> 事务管理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-179"><span class="toc-number">1.9.2.1.</span> <span class="toc-text"> 基本操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-180"><span class="toc-number">1.9.2.2.</span> <span class="toc-text"> 提交方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-181"><span class="toc-number">1.9.2.3.</span> <span class="toc-text"> 事务 ID</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-182"><span class="toc-number">1.9.3.</span> <span class="toc-text"> 隔离级别</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-183"><span class="toc-number">1.9.3.1.</span> <span class="toc-text"> 四种级别</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-184"><span class="toc-number">1.9.3.2.</span> <span class="toc-text"> 加锁分析</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-185"><span class="toc-number">1.9.4.</span> <span class="toc-text"> 原子特性</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-186"><span class="toc-number">1.9.4.1.</span> <span class="toc-text"> 实现方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-187"><span class="toc-number">1.9.4.2.</span> <span class="toc-text"> DML 解析</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#-188"><span class="toc-number">1.9.4.2.1.</span> <span class="toc-text"> INSERT</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-189"><span class="toc-number">1.9.4.2.2.</span> <span class="toc-text"> DELETE</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-190"><span class="toc-number">1.9.4.2.3.</span> <span class="toc-text"> UPDATE</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-191"><span class="toc-number">1.9.4.3.</span> <span class="toc-text"> 回滚日志</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-192"><span class="toc-number">1.9.5.</span> <span class="toc-text"> 隔离特性</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-193"><span class="toc-number">1.9.5.1.</span> <span class="toc-text"> 实现方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-194"><span class="toc-number">1.9.5.2.</span> <span class="toc-text"> 并发控制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-195"><span class="toc-number">1.9.5.3.</span> <span class="toc-text"> 实现原理</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#-196"><span class="toc-number">1.9.5.3.1.</span> <span class="toc-text"> 隐藏字段</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-197"><span class="toc-number">1.9.5.3.2.</span> <span class="toc-text"> 版本链</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-198"><span class="toc-number">1.9.5.3.3.</span> <span class="toc-text"> 读视图</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-199"><span class="toc-number">1.9.5.3.4.</span> <span class="toc-text"> 工作流程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-200"><span class="toc-number">1.9.5.3.5.</span> <span class="toc-text"> 二级索引</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-201"><span class="toc-number">1.9.5.4.</span> <span class="toc-text"> RC RR</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-202"><span class="toc-number">1.9.6.</span> <span class="toc-text"> 持久特性</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-203"><span class="toc-number">1.9.6.1.</span> <span class="toc-text"> 实现方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-204"><span class="toc-number">1.9.6.2.</span> <span class="toc-text"> 重做日志</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#-205"><span class="toc-number">1.9.6.2.1.</span> <span class="toc-text"> 日志缓冲</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-206"><span class="toc-number">1.9.6.2.2.</span> <span class="toc-text"> 日志刷盘</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-207"><span class="toc-number">1.9.6.2.3.</span> <span class="toc-text"> 日志序号</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-208"><span class="toc-number">1.9.6.2.4.</span> <span class="toc-text"> 崩溃恢复</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-209"><span class="toc-number">1.9.6.3.</span> <span class="toc-text"> 工作流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-210"><span class="toc-number">1.9.6.4.</span> <span class="toc-text"> 系统优化</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-211"><span class="toc-number">1.9.7.</span> <span class="toc-text"> 一致特性</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-212"><span class="toc-number">1.10.</span> <span class="toc-text"> 锁机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-213"><span class="toc-number">1.10.1.</span> <span class="toc-text"> 基本介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-214"><span class="toc-number">1.10.2.</span> <span class="toc-text"> 内存结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-215"><span class="toc-number">1.10.3.</span> <span class="toc-text"> Server</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-216"><span class="toc-number">1.10.4.</span> <span class="toc-text"> MyISAM</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-217"><span class="toc-number">1.10.4.1.</span> <span class="toc-text"> 表级锁</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-218"><span class="toc-number">1.10.4.2.</span> <span class="toc-text"> 锁操作</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#-219"><span class="toc-number">1.10.4.2.1.</span> <span class="toc-text"> 读锁</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-220"><span class="toc-number">1.10.4.2.2.</span> <span class="toc-text"> 写锁</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-221"><span class="toc-number">1.10.4.3.</span> <span class="toc-text"> 锁状态</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-222"><span class="toc-number">1.10.5.</span> <span class="toc-text"> InnoDB</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-223"><span class="toc-number">1.10.5.1.</span> <span class="toc-text"> 行级锁</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#-224"><span class="toc-number">1.10.5.1.1.</span> <span class="toc-text"> 记录锁</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-225"><span class="toc-number">1.10.5.1.2.</span> <span class="toc-text"> 锁操作</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-226"><span class="toc-number">1.10.5.2.</span> <span class="toc-text"> 锁分类</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#-227"><span class="toc-number">1.10.5.2.1.</span> <span class="toc-text"> 间隙锁</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-228"><span class="toc-number">1.10.5.2.2.</span> <span class="toc-text"> 意向锁</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-229"><span class="toc-number">1.10.5.2.3.</span> <span class="toc-text"> 自增锁</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-230"><span class="toc-number">1.10.5.2.4.</span> <span class="toc-text"> 隐式锁</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-231"><span class="toc-number">1.10.5.3.</span> <span class="toc-text"> 锁优化</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#-232"><span class="toc-number">1.10.5.3.1.</span> <span class="toc-text"> 优化锁</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-233"><span class="toc-number">1.10.5.3.2.</span> <span class="toc-text"> 锁升级</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-234"><span class="toc-number">1.10.5.3.3.</span> <span class="toc-text"> 死锁</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-235"><span class="toc-number">1.10.5.4.</span> <span class="toc-text"> 锁状态</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-236"><span class="toc-number">1.10.6.</span> <span class="toc-text"> 乐观锁</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-237"><span class="toc-number">1.11.</span> <span class="toc-text"> 主从</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-238"><span class="toc-number">1.11.1.</span> <span class="toc-text"> 基本介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-239"><span class="toc-number">1.11.2.</span> <span class="toc-text"> 复制原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-240"><span class="toc-number">1.11.2.1.</span> <span class="toc-text"> 主从结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-241"><span class="toc-number">1.11.2.2.</span> <span class="toc-text"> 主主结构</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-242"><span class="toc-number">1.11.3.</span> <span class="toc-text"> 主从延迟</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-243"><span class="toc-number">1.11.3.1.</span> <span class="toc-text"> 延迟原因</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-244"><span class="toc-number">1.11.3.2.</span> <span class="toc-text"> 并行复制</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#-245"><span class="toc-number">1.11.3.2.1.</span> <span class="toc-text"> MySQL5.6</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-246"><span class="toc-number">1.11.3.2.2.</span> <span class="toc-text"> MySQL5.7</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-247"><span class="toc-number">1.11.3.3.</span> <span class="toc-text"> 读写分离</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-248"><span class="toc-number">1.11.4.</span> <span class="toc-text"> 负载均衡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-249"><span class="toc-number">1.11.5.</span> <span class="toc-text"> 主从搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-250"><span class="toc-number">1.11.5.1.</span> <span class="toc-text"> 搭建流程</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#-251"><span class="toc-number">1.11.5.1.1.</span> <span class="toc-text"> master</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-252"><span class="toc-number">1.11.5.1.2.</span> <span class="toc-text"> slave</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-253"><span class="toc-number">1.11.5.1.3.</span> <span class="toc-text"> 验证</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-254"><span class="toc-number">1.11.5.2.</span> <span class="toc-text"> 主从切换</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-255"><span class="toc-number">1.12.</span> <span class="toc-text"> 日志</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-256"><span class="toc-number">1.12.1.</span> <span class="toc-text"> 日志分类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-257"><span class="toc-number">1.12.2.</span> <span class="toc-text"> 错误日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-258"><span class="toc-number">1.12.3.</span> <span class="toc-text"> 归档日志</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-259"><span class="toc-number">1.12.3.1.</span> <span class="toc-text"> 基本介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-260"><span class="toc-number">1.12.3.2.</span> <span class="toc-text"> 日志读取</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-261"><span class="toc-number">1.12.3.3.</span> <span class="toc-text"> 日志删除</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-262"><span class="toc-number">1.12.4.</span> <span class="toc-text"> 查询日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-263"><span class="toc-number">1.12.5.</span> <span class="toc-text"> 慢日志</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-264"><span class="toc-number">1.13.</span> <span class="toc-text"> 范式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-265"><span class="toc-number">1.13.1.</span> <span class="toc-text"> 第一范式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-266"><span class="toc-number">1.13.2.</span> <span class="toc-text"> 第二范式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-267"><span class="toc-number">1.13.3.</span> <span class="toc-text"> 第三范式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-268"><span class="toc-number">1.13.4.</span> <span class="toc-text"> 总结</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#-269"><span class="toc-number">2.</span> <span class="toc-text"> JDBC</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-270"><span class="toc-number">2.1.</span> <span class="toc-text"> 概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-271"><span class="toc-number">2.2.</span> <span class="toc-text"> 功能类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-272"><span class="toc-number">2.2.1.</span> <span class="toc-text"> DriverManager</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-273"><span class="toc-number">2.2.2.</span> <span class="toc-text"> Connection</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-274"><span class="toc-number">2.2.3.</span> <span class="toc-text"> Statement</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-275"><span class="toc-number">2.2.4.</span> <span class="toc-text"> ResultSet</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-276"><span class="toc-number">2.2.5.</span> <span class="toc-text"> 代码实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-277"><span class="toc-number">2.3.</span> <span class="toc-text"> 工具类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-278"><span class="toc-number">2.4.</span> <span class="toc-text"> 数据封装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-279"><span class="toc-number">2.5.</span> <span class="toc-text"> 注入攻击</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-280"><span class="toc-number">2.5.1.</span> <span class="toc-text"> 攻击演示</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-281"><span class="toc-number">2.5.2.</span> <span class="toc-text"> 攻击解决</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-282"><span class="toc-number">2.6.</span> <span class="toc-text"> 连接池</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-283"><span class="toc-number">2.6.1.</span> <span class="toc-text"> 概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-284"><span class="toc-number">2.6.2.</span> <span class="toc-text"> 自定义池</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-285"><span class="toc-number">2.6.3.</span> <span class="toc-text"> 归还连接</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-286"><span class="toc-number">2.6.3.1.</span> <span class="toc-text"> 继承方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-287"><span class="toc-number">2.6.3.2.</span> <span class="toc-text"> 装饰者</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-288"><span class="toc-number">2.6.3.3.</span> <span class="toc-text"> 适配器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-289"><span class="toc-number">2.6.3.4.</span> <span class="toc-text"> 动态代理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-290"><span class="toc-number">2.6.4.</span> <span class="toc-text"> 开源项目</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-291"><span class="toc-number">2.6.4.1.</span> <span class="toc-text"> C3P0</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-292"><span class="toc-number">2.6.4.2.</span> <span class="toc-text"> Druid</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-293"><span class="toc-number">2.6.5.</span> <span class="toc-text"> 工具类</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#-294"><span class="toc-number">3.</span> <span class="toc-text"> Redis</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-295"><span class="toc-number">3.1.</span> <span class="toc-text"> NoSQL</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-296"><span class="toc-number">3.1.1.</span> <span class="toc-text"> 概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-297"><span class="toc-number">3.1.2.</span> <span class="toc-text"> Redis</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-298"><span class="toc-number">3.1.3.</span> <span class="toc-text"> 安装启动</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-299"><span class="toc-number">3.1.3.1.</span> <span class="toc-text"> CentOS</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-300"><span class="toc-number">3.1.3.2.</span> <span class="toc-text"> Ubuntu</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-301"><span class="toc-number">3.1.4.</span> <span class="toc-text"> 基本配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-302"><span class="toc-number">3.1.4.1.</span> <span class="toc-text"> 系统目录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-303"><span class="toc-number">3.1.4.2.</span> <span class="toc-text"> 服务器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-304"><span class="toc-number">3.1.4.3.</span> <span class="toc-text"> 客户端</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-305"><span class="toc-number">3.1.4.4.</span> <span class="toc-text"> 日志配置</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-306"><span class="toc-number">3.2.</span> <span class="toc-text"> 体系结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-307"><span class="toc-number">3.2.1.</span> <span class="toc-text"> 存储对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-308"><span class="toc-number">3.2.2.</span> <span class="toc-text"> 线程模型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-309"><span class="toc-number">3.2.3.</span> <span class="toc-text"> 多线程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-310"><span class="toc-number">3.3.</span> <span class="toc-text"> 基本指令</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-311"><span class="toc-number">3.3.1.</span> <span class="toc-text"> 操作指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-312"><span class="toc-number">3.3.2.</span> <span class="toc-text"> key 指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-313"><span class="toc-number">3.3.3.</span> <span class="toc-text"> DB 指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-314"><span class="toc-number">3.3.4.</span> <span class="toc-text"> 通信指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-315"><span class="toc-number">3.3.5.</span> <span class="toc-text"> ACL 指令</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-316"><span class="toc-number">3.4.</span> <span class="toc-text"> 数据类型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-317"><span class="toc-number">3.4.1.</span> <span class="toc-text"> string</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-318"><span class="toc-number">3.4.1.1.</span> <span class="toc-text"> 简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-319"><span class="toc-number">3.4.1.2.</span> <span class="toc-text"> 操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-320"><span class="toc-number">3.4.1.3.</span> <span class="toc-text"> 应用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-321"><span class="toc-number">3.4.1.4.</span> <span class="toc-text"> 实现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-322"><span class="toc-number">3.4.2.</span> <span class="toc-text"> hash</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-323"><span class="toc-number">3.4.2.1.</span> <span class="toc-text"> 简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-324"><span class="toc-number">3.4.2.2.</span> <span class="toc-text"> 操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-325"><span class="toc-number">3.4.2.3.</span> <span class="toc-text"> 应用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-326"><span class="toc-number">3.4.2.4.</span> <span class="toc-text"> 实现</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#-327"><span class="toc-number">3.4.2.4.1.</span> <span class="toc-text"> 底层结构</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-328"><span class="toc-number">3.4.2.4.2.</span> <span class="toc-text"> 压缩列表</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-329"><span class="toc-number">3.4.2.4.3.</span> <span class="toc-text"> 哈希表</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-330"><span class="toc-number">3.4.3.</span> <span class="toc-text"> list</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-331"><span class="toc-number">3.4.3.1.</span> <span class="toc-text"> 简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-332"><span class="toc-number">3.4.3.2.</span> <span class="toc-text"> 操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-333"><span class="toc-number">3.4.3.3.</span> <span class="toc-text"> 应用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-334"><span class="toc-number">3.4.3.4.</span> <span class="toc-text"> 实现</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#-335"><span class="toc-number">3.4.3.4.1.</span> <span class="toc-text"> 底层结构</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-336"><span class="toc-number">3.4.3.4.2.</span> <span class="toc-text"> 链表结构</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-337"><span class="toc-number">3.4.3.4.3.</span> <span class="toc-text"> 快速列表</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-338"><span class="toc-number">3.4.4.</span> <span class="toc-text"> set</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-339"><span class="toc-number">3.4.4.1.</span> <span class="toc-text"> 简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-340"><span class="toc-number">3.4.4.2.</span> <span class="toc-text"> 操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-341"><span class="toc-number">3.4.4.3.</span> <span class="toc-text"> 应用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-342"><span class="toc-number">3.4.4.4.</span> <span class="toc-text"> 实现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-343"><span class="toc-number">3.4.5.</span> <span class="toc-text"> sorted</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-344"><span class="toc-number">3.4.5.1.</span> <span class="toc-text"> 简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-345"><span class="toc-number">3.4.5.2.</span> <span class="toc-text"> 操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-346"><span class="toc-number">3.4.5.3.</span> <span class="toc-text"> 应用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-347"><span class="toc-number">3.4.5.4.</span> <span class="toc-text"> 实现</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#-348"><span class="toc-number">3.4.5.4.1.</span> <span class="toc-text"> 底层结构</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-349"><span class="toc-number">3.4.5.4.2.</span> <span class="toc-text"> 跳跃表</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-350"><span class="toc-number">3.4.6.</span> <span class="toc-text"> Bitmaps</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-351"><span class="toc-number">3.4.6.1.</span> <span class="toc-text"> 操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-352"><span class="toc-number">3.4.6.2.</span> <span class="toc-text"> 应用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-353"><span class="toc-number">3.4.7.</span> <span class="toc-text"> Hyper</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-354"><span class="toc-number">3.4.8.</span> <span class="toc-text"> GEO</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-355"><span class="toc-number">3.5.</span> <span class="toc-text"> Jedis</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-356"><span class="toc-number">3.5.1.</span> <span class="toc-text"> 基本使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-357"><span class="toc-number">3.5.2.</span> <span class="toc-text"> 工具类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-358"><span class="toc-number">3.5.3.</span> <span class="toc-text"> 可视化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-359"><span class="toc-number">3.6.</span> <span class="toc-text"> 持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-360"><span class="toc-number">3.6.1.</span> <span class="toc-text"> 概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-361"><span class="toc-number">3.6.2.</span> <span class="toc-text"> RDB</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-362"><span class="toc-number">3.6.2.1.</span> <span class="toc-text"> save</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-363"><span class="toc-number">3.6.2.2.</span> <span class="toc-text"> bgsave</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-364"><span class="toc-number">3.6.2.3.</span> <span class="toc-text"> 自动</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-365"><span class="toc-number">3.6.2.4.</span> <span class="toc-text"> 总结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-366"><span class="toc-number">3.6.3.</span> <span class="toc-text"> AOF</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-367"><span class="toc-number">3.6.3.1.</span> <span class="toc-text"> 概述</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-368"><span class="toc-number">3.6.3.2.</span> <span class="toc-text"> 策略</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-369"><span class="toc-number">3.6.3.3.</span> <span class="toc-text"> 重写</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#-370"><span class="toc-number">3.6.3.3.1.</span> <span class="toc-text"> 介绍</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-371"><span class="toc-number">3.6.3.3.2.</span> <span class="toc-text"> 方式</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-372"><span class="toc-number">3.6.3.4.</span> <span class="toc-text"> 流程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-373"><span class="toc-number">3.6.4.</span> <span class="toc-text"> 对比</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-374"><span class="toc-number">3.6.5.</span> <span class="toc-text"> fork</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-375"><span class="toc-number">3.6.5.1.</span> <span class="toc-text"> 介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-376"><span class="toc-number">3.6.5.2.</span> <span class="toc-text"> 使用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-377"><span class="toc-number">3.6.5.3.</span> <span class="toc-text"> 内存</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-378"><span class="toc-number">3.7.</span> <span class="toc-text"> 事务机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-379"><span class="toc-number">3.7.1.</span> <span class="toc-text"> 基本操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-380"><span class="toc-number">3.7.2.</span> <span class="toc-text"> 工作流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-381"><span class="toc-number">3.7.3.</span> <span class="toc-text"> 监控锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-382"><span class="toc-number">3.7.4.</span> <span class="toc-text"> 分布式锁</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-383"><span class="toc-number">3.7.4.1.</span> <span class="toc-text"> 基本操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-384"><span class="toc-number">3.7.4.2.</span> <span class="toc-text"> 防误删</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-385"><span class="toc-number">3.8.</span> <span class="toc-text"> 删除策略</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-386"><span class="toc-number">3.8.1.</span> <span class="toc-text"> 过期数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-387"><span class="toc-number">3.8.2.</span> <span class="toc-text"> 数据删除</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-388"><span class="toc-number">3.8.2.1.</span> <span class="toc-text"> 删除策略</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-389"><span class="toc-number">3.8.2.2.</span> <span class="toc-text"> 定时删除</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-390"><span class="toc-number">3.8.2.3.</span> <span class="toc-text"> 惰性删除</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-391"><span class="toc-number">3.8.2.4.</span> <span class="toc-text"> 定期删除</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-392"><span class="toc-number">3.8.2.5.</span> <span class="toc-text"> 策略对比</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-393"><span class="toc-number">3.8.3.</span> <span class="toc-text"> 数据淘汰</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-394"><span class="toc-number">3.8.3.1.</span> <span class="toc-text"> 逐出算法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-395"><span class="toc-number">3.8.3.2.</span> <span class="toc-text"> 策略配置</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-396"><span class="toc-number">3.9.</span> <span class="toc-text"> 主从复制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-397"><span class="toc-number">3.9.1.</span> <span class="toc-text"> 基本介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-398"><span class="toc-number">3.9.2.</span> <span class="toc-text"> 工作流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-399"><span class="toc-number">3.9.3.</span> <span class="toc-text"> 建立连接</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-400"><span class="toc-number">3.9.3.1.</span> <span class="toc-text"> 建立流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-401"><span class="toc-number">3.9.3.2.</span> <span class="toc-text"> 相关指令</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-402"><span class="toc-number">3.9.4.</span> <span class="toc-text"> 数据同步</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-403"><span class="toc-number">3.9.4.1.</span> <span class="toc-text"> 同步流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-404"><span class="toc-number">3.9.4.2.</span> <span class="toc-text"> 同步优化</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-405"><span class="toc-number">3.9.5.</span> <span class="toc-text"> 命令传播</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-406"><span class="toc-number">3.9.5.1.</span> <span class="toc-text"> 传播原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-407"><span class="toc-number">3.9.5.2.</span> <span class="toc-text"> 复制流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-408"><span class="toc-number">3.9.5.3.</span> <span class="toc-text"> 心跳机制</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-409"><span class="toc-number">3.9.6.</span> <span class="toc-text"> 常见问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-410"><span class="toc-number">3.9.6.1.</span> <span class="toc-text"> 重启恢复</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-411"><span class="toc-number">3.9.6.2.</span> <span class="toc-text"> 网络中断</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-412"><span class="toc-number">3.9.6.3.</span> <span class="toc-text"> 一致性</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-413"><span class="toc-number">3.10.</span> <span class="toc-text"> 哨兵模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-414"><span class="toc-number">3.10.1.</span> <span class="toc-text"> 哨兵概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-415"><span class="toc-number">3.10.2.</span> <span class="toc-text"> 启用哨兵</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-416"><span class="toc-number">3.10.3.</span> <span class="toc-text"> 工作原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-417"><span class="toc-number">3.10.3.1.</span> <span class="toc-text"> 监控阶段</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-418"><span class="toc-number">3.10.3.2.</span> <span class="toc-text"> 通知阶段</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-419"><span class="toc-number">3.10.3.3.</span> <span class="toc-text"> 故障转移</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-420"><span class="toc-number">3.11.</span> <span class="toc-text"> 集群模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-421"><span class="toc-number">3.11.1.</span> <span class="toc-text"> 集群概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-422"><span class="toc-number">3.11.2.</span> <span class="toc-text"> 结构设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-423"><span class="toc-number">3.11.3.</span> <span class="toc-text"> 结构搭建</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-424"><span class="toc-number">3.12.</span> <span class="toc-text"> 缓存方案</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-425"><span class="toc-number">3.12.1.</span> <span class="toc-text"> 缓存模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-426"><span class="toc-number">3.12.1.1.</span> <span class="toc-text"> 旁路缓存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-427"><span class="toc-number">3.12.1.2.</span> <span class="toc-text"> 读写穿透</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-428"><span class="toc-number">3.12.1.3.</span> <span class="toc-text"> 异步缓存</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-429"><span class="toc-number">3.12.2.</span> <span class="toc-text"> 缓存一致</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-430"><span class="toc-number">3.12.3.</span> <span class="toc-text"> 企业方案</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-431"><span class="toc-number">3.12.3.1.</span> <span class="toc-text"> 缓存预热</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-432"><span class="toc-number">3.12.3.2.</span> <span class="toc-text"> 缓存雪崩</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-433"><span class="toc-number">3.12.3.3.</span> <span class="toc-text"> 缓存击穿</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-434"><span class="toc-number">3.12.3.4.</span> <span class="toc-text"> 缓存穿透</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-435"><span class="toc-number">3.12.4.</span> <span class="toc-text"> 性能指标</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-map"><div class="card-content"><div class="item-headline"><i class="fa fa-globe-asia" aria-hidden="true"></i><span>Visitor Map</span></div><script id="clstr_globe" type="text/javascript" defer="defer" src="//clustrmaps.com/globe.js?d=4LA950xi3DtQgUHPlkO0mo-n_QgrcOu-1BIiVpExg7k"></script></div></div><div class="card-widget card-pixiv"><div class="card-content"><div class="item-headline"><i class="fa fa-image" aria-hidden="true"></i><span>Pixiv Top50</span><iframe src="https://cloud.mokeyjay.com/pixiv" frameborder="0" style="width:99%;height:380px;margin:0;"></iframe></div></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/07/28/Maven/" title="My Maven notes"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/default-covers/hello-world.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="My Maven notes"/></a><div class="content"><a class="title" href="/2022/07/28/Maven/" title="My Maven notes">My Maven notes</a><time datetime="2022-07-27T12:00:00.000Z" title="Created 2022-07-28 00:00:00">2022-07-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/07/25/nodejs/" title="Nodejs notes"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/default-covers/town.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Nodejs notes"/></a><div class="content"><a class="title" href="/2022/07/25/nodejs/" title="Nodejs notes">Nodejs notes</a><time datetime="2022-07-24T12:00:00.000Z" title="Created 2022-07-25 00:00:00">2022-07-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/06/12/%E7%AE%97%E6%B3%95%E7%BB%88%E6%9E%81%E6%8C%87%E5%8D%97/" title="My ultimate data structure and algorithm guide"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/default-covers/statue.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="My ultimate data structure and algorithm guide"/></a><div class="content"><a class="title" href="/2022/06/12/%E7%AE%97%E6%B3%95%E7%BB%88%E6%9E%81%E6%8C%87%E5%8D%97/" title="My ultimate data structure and algorithm guide">My ultimate data structure and algorithm guide</a><time datetime="2022-06-11T12:00:00.000Z" title="Created 2022-06-12 00:00:00">2022-06-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/06/12/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" title="Design Patterns"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/default-covers/home.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Design Patterns"/></a><div class="content"><a class="title" href="/2022/06/12/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" title="Design Patterns">Design Patterns</a><time datetime="2022-06-11T12:00:00.000Z" title="Created 2022-06-12 00:00:00">2022-06-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/06/11/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%20-%20%E5%B7%A5%E5%8E%82%E6%96%B9%E6%B3%95/" title="Design Patterns - Factory Method"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/default-covers/home.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Design Patterns - Factory Method"/></a><div class="content"><a class="title" href="/2022/06/11/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%20-%20%E5%B7%A5%E5%8E%82%E6%96%B9%E6%B3%95/" title="Design Patterns - Factory Method">Design Patterns - Factory Method</a><time datetime="2022-06-10T12:00:00.000Z" title="Created 2022-06-11 00:00:00">2022-06-11</time></div></div></div></div></div></div></main><footer id="footer" style="background: transparent"><div id="footer-wrap"><div class="copyright">&copy;2021 - 2022 By Harry Qu</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="Chat"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="Scroll To Comments"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Local search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>function loadDisqus () {
  var disqus_config = function () {
    this.page.url = 'https://harryqu1229.github.io/2021/12/30/mysql+jdbc+redis/'
    this.page.identifier = '2021/12/30/mysql+jdbc+redis/'
    this.page.title = 'Mysql + JDBC + Redis'
  };

  window.disqusReset = () => {
    DISQUS.reset({
      reload: true,
      config: disqus_config
    })
  }

  if (window.DISQUS) disqusReset()
  else {
    (function() { 
      var d = document, s = d.createElement('script');
      s.src = 'https://harry-study-blog.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  }
}

if ('Disqus' === 'Disqus' || !true) {
  if (true) btf.loadComment(document.getElementById('disqus_thread'), loadDisqus)
  else loadDisqus()
} else {
  function loadOtherComment () {
    loadDisqus()
  }
}
</script><script>function addGitalkSource () {
  const ele = document.createElement('link')
  ele.rel = 'stylesheet'
  ele.href= 'https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css'
  document.getElementsByTagName('head')[0].appendChild(ele)
}

function loadGitalk () {
  function initGitalk () {
    var gitalk = new Gitalk(Object.assign({
      clientID: '5df1e915e0fa867b50de',
      clientSecret: 'ce1cb793fe49078ee9d0102d3326d0d50ff6937b',
      repo: 'blog-comments-storage',
      owner: 'HarryQu1229',
      admin: ['HarryQu1229'],
      id: 'bf7540d6ebd38976f014e70f7b0e0055',
      updateCountCallback: commentCount
    },null))

    gitalk.render('gitalk-container')
  }

  if (typeof Gitalk === 'function') initGitalk()
  else {
    addGitalkSource()
    getScript('https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js').then(initGitalk)
  }
}

function commentCount(n){
  let isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
  if (isCommentCount) {
    isCommentCount.innerHTML= n
  }
}

if ('Disqus' === 'Gitalk' || !true) {
  if (true) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
  else loadGitalk()
} else {
  function loadOtherComment () {
    loadGitalk()
  }
}</script></div><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[image]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[link]') // replace url
    content = content.replace(/<code>.*?<\/code>/gi, '[code]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getComment = () => {
    fetch('https://disqus.com/api/3.0/forums/listPosts.json?forum=harry-study-blog&related=thread&limit=6&api_key=B5XFmdGuVaYDW7OIBakffpXoKorvphwRiwONIol4puEtr8YiwYAMAk2K7QcExNLY')
      .then(response => response.json())
      .then(data => {
        const disqusArray = data.response.map(item => {
          return {
            'avatar': item.author.avatar.cache,
            'content': changeContent(item.message),
            'nick': item.author.name,
            'url': item.url,
            'date': item.createdAt
          }
        })

        saveToLocal.set('disqus-newest-comments', JSON.stringify(disqusArray), 10/(60*24))
        generateHtml(disqusArray)
      }).catch(e => {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.innerHTML= "Unable to get the data, please make sure the settings are correct."
      })
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }
        
        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick}</span><time> / ${btf.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += 'No Comment'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom.innerHTML= result
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('disqus-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><div class="aplayer no-destroy" data-id="2809513713" data-server="netease" data-type="playlist" data-autoplay="false" data-fixed="true" data-order="random" data-theme="#e9ccd3"> </div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/fireworks.min.js"></script><script id="canvas_nest" defer="defer" color="255,255,255" opacity="0.7" zIndex="-1" count="99" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script>((window.gitter = {}).chat = {}).options = {
  disableDefaultChat: true,
};
document.addEventListener('gitter-sidecar-ready', (e) => {
  const GitterChat = e.detail.Chat
  let chat

  function initGitter () {
    chat = new GitterChat({
      room: 'HarryStudyBlog/community',
      activationElement: '#chat_btn'
    });
  }

  initGitter()

  if (true) {
    document.addEventListener('pjax:complete', () => {
      chat.destroy()
      initGitter()
    })
  }

})</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async="async" defer="defer"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/gh/metowolf/MetingJS@1.2/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --><script data-pjax>
  function butterfly_footer_beautify_injector_config(){
    var parent_div_git = document.getElementById('footer-wrap');
    var item_html = '<div id="ghbdages" style="overflow:hidden;max-height:90px;height:auto;text-align:center;margin-top:10px"><div class="swiper-wrapper"><div class="swiper-slide"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" title="博客框架为Hexo_v5.4.0"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&amp;logo=hexo" alt=""/></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px" title="主题版本Butterfly_v3.8.2"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&amp;logo=bitdefender" alt=""/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" title="本站项目由Github托管"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&amp;logo=GitHub" alt=""/></a></div><div class="swiper-slide"><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" style="margin-inline:5px" title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&amp;logo=Claris" alt=""/></a></div></div></div><style>a.github-badge:hover:before {display:none}</style>';
    console.log('已挂载butterfly_footer_beautify')
    parent_div_git.insertAdjacentHTML("beforeend",item_html)
    }
  var elist = 'undefined'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_footer_beautify_injector_config();
  }
  else if (epage === cpage){
    butterfly_footer_beautify_injector_config();
  }
  </script><script defer src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.js"></script><script defer data-pjax src="https://npm.elemecdn.com/hexo-butterfly-footer-beautify/lib/swiperbdage_init.min.js"></script><!-- hexo injector body_end end --><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"position":"right","width":300,"height":450},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html>