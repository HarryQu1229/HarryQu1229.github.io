<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Java big Summary | Harry Blog</title><meta name="keywords" content="summary,javase"><meta name="author" content="Harry Qu"><meta name="copyright" content="Harry Qu"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="# Java 基础语法特性  1. 注释 2. 基本数据类型 3. 变量 4. 数组 5. 枚举 6. 操作符 7. 方法 8. 控制语句 9. 异常 10. 泛型 11. 反射 12. 注解 13. 序列化  # 1. 注释 空白行，或者注释的内容，都会被 Java 编译器忽略掉。 Java 支持多种注释方式，下面的示例展示了各种注释的使用方式： public class HelloWorld">
<meta property="og:type" content="article">
<meta property="og:title" content="Java big Summary">
<meta property="og:url" content="https://harryqu1229.github.io/2022/04/30/java%E5%A4%A7%E6%80%BB%E7%BB%93/index.html">
<meta property="og:site_name" content="Harry Blog">
<meta property="og:description" content="# Java 基础语法特性  1. 注释 2. 基本数据类型 3. 变量 4. 数组 5. 枚举 6. 操作符 7. 方法 8. 控制语句 9. 异常 10. 泛型 11. 反射 12. 注解 13. 序列化  # 1. 注释 空白行，或者注释的内容，都会被 Java 编译器忽略掉。 Java 支持多种注释方式，下面的示例展示了各种注释的使用方式： public class HelloWorld">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://harryqu1229.github.io/img/default-covers/mountain.jpg">
<meta property="article:published_time" content="2022-04-29T12:00:00.000Z">
<meta property="article:modified_time" content="2022-06-12T01:08:36.029Z">
<meta property="article:author" content="Harry Qu">
<meta property="article:tag" content="javase">
<meta property="article:tag" content="fundamental">
<meta property="article:tag" content="summary">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://harryqu1229.github.io/img/default-covers/mountain.jpg"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://harryqu1229.github.io/2022/04/30/java%E5%A4%A7%E6%80%BB%E7%BB%93/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: undefined,
  noticeOutdate: {"limitDay":100,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"prismjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"Traditional Chinese Activated Manually","cht_to_chs":"Simplified Chinese Activated Manually","day_to_night":"Dark Mode Activated Manually","night_to_day":"Light Mode Activated Manually","bgLight":"#C78550","bgDark":"#c08eaf","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Java big Summary',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-06-12 13:08:36'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><style type="text/css">.aplayer.aplayer-fixed.aplayer-narrow .aplayer-body{left:-66px!important}.aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover{left:0!important}</style><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-footer-beautify@1.0.0/lib/runtime.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-filter-gitcalendar/lib/gitcalendar.css" media="print" onload="this.media='all'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">Loading...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpeg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">158</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">84</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">57</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-graduation-cap"></i><span> Journey</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> Hobbies</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/Music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/Photos/"><i class="fa-fw fas fa-images"></i><span> Photos</span></a></li><li><a class="site-page child" href="/Movies/"><i class="fa-fw fas fa-video"></i><span> Movies</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Links</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.vox-cdn.com/thumbor/_AobZZDt_RVStktVR7mUZpBkovc=/0x0:640x427/1200x800/filters:focal(0x0:640x427)/cdn.vox-cdn.com/assets/1087137/java_logo_640.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Harry Blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-graduation-cap"></i><span> Journey</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> Hobbies</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/Music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/Photos/"><i class="fa-fw fas fa-images"></i><span> Photos</span></a></li><li><a class="site-page child" href="/Movies/"><i class="fa-fw fas fa-video"></i><span> Movies</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Links</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Java big Summary</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2022-04-29T12:00:00.000Z" title="Created 2022-04-30 00:00:00">2022-04-30</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2022-06-12T01:08:36.029Z" title="Updated 2022-06-12 13:08:36">2022-06-12</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Important/">Important</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Important/java/">java</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word count:</span><span class="word-count">229.5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading time:</span><span>848min</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Java big Summary"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="java-基础语法特性"><a class="markdownIt-Anchor" href="#java-基础语法特性">#</a> Java 基础语法特性</h1>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/blob/master/docs/basics/java-basic-grammar.md#1-%E6%B3%A8%E9%87%8A">1. 注释</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/blob/master/docs/basics/java-basic-grammar.md#2-%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B">2. 基本数据类型</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/blob/master/docs/basics/java-basic-grammar.md#3-%E5%8F%98%E9%87%8F">3. 变量</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/blob/master/docs/basics/java-basic-grammar.md#4-%E6%95%B0%E7%BB%84">4. 数组</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/blob/master/docs/basics/java-basic-grammar.md#5-%E6%9E%9A%E4%B8%BE">5. 枚举</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/blob/master/docs/basics/java-basic-grammar.md#6-%E6%93%8D%E4%BD%9C%E7%AC%A6">6. 操作符</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/blob/master/docs/basics/java-basic-grammar.md#7-%E6%96%B9%E6%B3%95">7. 方法</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/blob/master/docs/basics/java-basic-grammar.md#8-%E6%8E%A7%E5%88%B6%E8%AF%AD%E5%8F%A5">8. 控制语句</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/blob/master/docs/basics/java-basic-grammar.md#9-%E5%BC%82%E5%B8%B8">9. 异常</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/blob/master/docs/basics/java-basic-grammar.md#10-%E6%B3%9B%E5%9E%8B">10. 泛型</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/blob/master/docs/basics/java-basic-grammar.md#11-%E5%8F%8D%E5%B0%84">11. 反射</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/blob/master/docs/basics/java-basic-grammar.md#12-%E6%B3%A8%E8%A7%A3">12. 注解</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/blob/master/docs/basics/java-basic-grammar.md#13-%E5%BA%8F%E5%88%97%E5%8C%96">13. 序列化</a></li>
</ul>
<h2 id="1-注释"><a class="markdownIt-Anchor" href="#1-注释">#</a> 1. 注释</h2>
<p>空白行，或者注释的内容，都会被 Java 编译器忽略掉。</p>
<p>Java 支持多种注释方式，下面的示例展示了各种注释的使用方式：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloWorld</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">/*
     * JavaDoc 注释
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 单行注释</span>
        <span class="token comment">/* 多行注释：
           1. 注意点a
           2. 注意点b
         */</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Hello World"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="2-基本数据类型"><a class="markdownIt-Anchor" href="#2-基本数据类型">#</a> 2. 基本数据类型</h2>
<p><a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/dunwu/images/dev/cs/java/javacore/xmind/Java%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B.svg"><img src="https://raw.githubusercontent.com/dunwu/images/dev/cs/java/javacore/xmind/Java%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B.svg" alt="img"></a></p>
<blockquote>
<p>👉 扩展阅读：<a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/blob/master/docs/basics/java-data-type.md">深入理解 Java 基本数据类型</a></p>
</blockquote>
<h2 id="3-变量"><a class="markdownIt-Anchor" href="#3-变量">#</a> 3. 变量</h2>
<p>Java 支持的变量类型有：</p>
<ul>
<li><code>局部变量</code>  - 类方法中的变量。</li>
<li><code>实例变量（也叫成员变量）</code>  - 类方法外的变量，不过没有  <code>static</code>  修饰。</li>
<li><code>类变量（也叫静态变量）</code>  - 类方法外的变量，用  <code>static</code>  修饰。</li>
</ul>
<p>特性对比：</p>
<table>
<thead>
<tr>
<th>局部变量</th>
<th>实例变量（也叫成员变量）</th>
<th>类变量（也叫静态变量）</th>
</tr>
</thead>
<tbody>
<tr>
<td>局部变量声明在方法、构造方法或者语句块中。</td>
<td>实例变量声明在方法、构造方法和语句块之外。</td>
<td>类变量声明在方法、构造方法和语句块之外。并且以 static 修饰。</td>
</tr>
<tr>
<td>局部变量在方法、构造方法、或者语句块被执行的时候创建，当它们执行完成后，变量将会被销毁。</td>
<td>实例变量在对象创建的时候创建，在对象被销毁的时候销毁。</td>
<td>类变量在第一次被访问时创建，在程序结束时销毁。</td>
</tr>
<tr>
<td>局部变量没有默认值，所以必须经过初始化，才可以使用。</td>
<td>实例变量具有默认值。数值型变量的默认值是 0，布尔型变量的默认值是 false，引用类型变量的默认值是 null。变量的值可以在声明时指定，也可以在构造方法中指定。</td>
<td>类变量具有默认值。数值型变量的默认值是 0，布尔型变量的默认值是 false，引用类型变量的默认值是 null。变量的值可以在声明时指定，也可以在构造方法中指定。此外，静态变量还可以在静态语句块中初始化。</td>
</tr>
<tr>
<td>对于局部变量，如果是基本类型，会把值直接存储在栈；如果是引用类型，会把其对象存储在堆，而把这个对象的引用（指针）存储在栈。</td>
<td>实例变量存储在堆。</td>
<td>类变量存储在静态存储区。</td>
</tr>
<tr>
<td>访问修饰符不能用于局部变量。</td>
<td>访问修饰符可以用于实例变量。</td>
<td>访问修饰符可以用于类变量。</td>
</tr>
<tr>
<td>局部变量只在声明它的方法、构造方法或者语句块中可见。</td>
<td>实例变量对于类中的方法、构造方法或者语句块是可见的。一般情况下应该把实例变量设为私有。通过使用访问修饰符可以使实例变量对子类可见。</td>
<td>与实例变量具有相似的可见性。但为了对类的使用者可见，大多数静态变量声明为 public 类型。</td>
</tr>
<tr>
<td></td>
<td>实例变量可以直接通过变量名访问。但在静态方法以及其他类中，就应该使用完全限定名：ObejectReference.VariableName。</td>
<td>静态变量可以通过：ClassName.VariableName 的方式访问。</td>
</tr>
<tr>
<td></td>
<td></td>
<td>无论一个类创建了多少个对象，类只拥有类变量的一份拷贝。</td>
</tr>
<tr>
<td></td>
<td></td>
<td>类变量除了被声明为常量外很少使用。</td>
</tr>
</tbody>
</table>
<p><strong>变量修饰符</strong></p>
<ul>
<li>访问级别修饰符
<ul>
<li>如果变量是实例变量或类变量，可以添加访问级别修饰符（public/protected/private）</li>
</ul>
</li>
<li>静态修饰符
<ul>
<li>如果变量是类变量，需要添加 static 修饰</li>
</ul>
</li>
<li>final
<ul>
<li>如果变量使用  <code>fianl</code>  修饰符，就表示这是一个常量，不能被修改。</li>
</ul>
</li>
</ul>
<h2 id="4-数组"><a class="markdownIt-Anchor" href="#4-数组">#</a> 4. 数组</h2>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/cs/java/javacore/xmind/Java%E6%95%B0%E7%BB%84.svg" alt="img"></p>
<blockquote>
<p>👉 扩展阅读：<a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/blob/master/docs/basics/java-array.md">深入理解 Java 数组</a></p>
</blockquote>
<h2 id="5-枚举"><a class="markdownIt-Anchor" href="#5-枚举">#</a> 5. 枚举</h2>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/cs/java/javacore/xmind/Java%E6%9E%9A%E4%B8%BE.svg" alt="img"></p>
<blockquote>
<p>👉 扩展阅读：<a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/blob/master/docs/basics/java-enum.md">深入理解 Java 数组</a></p>
</blockquote>
<h2 id="6-操作符"><a class="markdownIt-Anchor" href="#6-操作符">#</a> 6. 操作符</h2>
<p>Java 中支持的操作符类型如下：</p>
<p><a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/dunwu/images/dev/cs/java/javacore/xmind/Java%E6%93%8D%E4%BD%9C%E7%AC%A6.svg"><img src="https://raw.githubusercontent.com/dunwu/images/dev/cs/java/javacore/xmind/Java%E6%93%8D%E4%BD%9C%E7%AC%A6.svg" alt="img"></a></p>
<blockquote>
<p>👉 扩展阅读：<a target="_blank" rel="noopener" href="http://www.runoob.com/java/java-operators.html">Java 操作符</a></p>
</blockquote>
<h2 id="7-方法"><a class="markdownIt-Anchor" href="#7-方法">#</a> 7. 方法</h2>
<p><a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/dunwu/images/dev/snap/20220125072221.png"><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20220125072221.png" alt="img" style="zoom:200%;" /></a></p>
<blockquote>
<p>👉 扩展阅读：<a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/blob/master/docs/basics/java-method.md">深入理解 Java 方法</a></p>
</blockquote>
<h2 id="8-控制语句"><a class="markdownIt-Anchor" href="#8-控制语句">#</a> 8. 控制语句</h2>
<p><a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/dunwu/images/dev/cs/java/javacore/xmind/Java%E6%8E%A7%E5%88%B6%E8%AF%AD%E5%8F%A5.svg"><img src="https://raw.githubusercontent.com/dunwu/images/dev/cs/java/javacore/xmind/Java%E6%8E%A7%E5%88%B6%E8%AF%AD%E5%8F%A5.svg" alt="img"></a></p>
<blockquote>
<p>👉 扩展阅读：<a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/blob/master/docs/basics/java-control-statement.md">Java 控制语句</a></p>
</blockquote>
<h2 id="9-异常"><a class="markdownIt-Anchor" href="#9-异常">#</a> 9. 异常</h2>
<p><a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/dunwu/images/dev/cs/java/javacore/xmind/Java%E5%BC%82%E5%B8%B8%E6%A1%86%E6%9E%B6.svg"><img src="https://raw.githubusercontent.com/dunwu/images/dev/cs/java/javacore/xmind/Java%E5%BC%82%E5%B8%B8%E6%A1%86%E6%9E%B6.svg" alt="img"></a></p>
<p><a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/dunwu/images/dev/cs/java/javacore/xmind/Java%E5%BC%82%E5%B8%B8.svg"><img src="https://raw.githubusercontent.com/dunwu/images/dev/cs/java/javacore/xmind/Java%E5%BC%82%E5%B8%B8.svg" alt="img"></a></p>
<blockquote>
<p>👉 扩展阅读：<a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/blob/master/docs/basics/java-exception.md">深入理解 Java 异常</a></p>
</blockquote>
<h2 id="10-泛型"><a class="markdownIt-Anchor" href="#10-泛型">#</a> 10. 泛型</h2>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/cs/java/javacore/xmind/Java%E6%B3%9B%E5%9E%8B.svg" alt="img"></p>
<blockquote>
<p>👉 扩展阅读：<a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/blob/master/docs/basics/java-generic.md">深入理解 Java 泛型</a></p>
</blockquote>
<h2 id="11-反射"><a class="markdownIt-Anchor" href="#11-反射">#</a> 11. 反射</h2>
<p><a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/dunwu/images/dev/cs/java/javacore/xmind/Java%E5%8F%8D%E5%B0%84.svg"><img src="https://raw.githubusercontent.com/dunwu/images/dev/cs/java/javacore/xmind/Java%E5%8F%8D%E5%B0%84.svg" alt="img"></a></p>
<p><a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/dunwu/images/dev/cs/java/javacore/xmind/Java%E4%BB%A3%E7%90%86.svg"><img src="https://raw.githubusercontent.com/dunwu/images/dev/cs/java/javacore/xmind/Java%E4%BB%A3%E7%90%86.svg" alt="img"></a></p>
<blockquote>
<p>👉 扩展阅读：<a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/blob/master/docs/basics/java-reflection.md">深入理解 Java 反射和动态代理</a></p>
</blockquote>
<h2 id="12-注解"><a class="markdownIt-Anchor" href="#12-注解">#</a> 12. 注解</h2>
<p><a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/dunwu/images/dev/cs/java/javacore/xmind/%E6%B3%A8%E8%A7%A3%E7%AE%80%E4%BB%8B.svg"><img src="https://raw.githubusercontent.com/dunwu/images/dev/cs/java/javacore/xmind/%E6%B3%A8%E8%A7%A3%E7%AE%80%E4%BB%8B.svg" alt="img"></a></p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/cs/java/javacore/xmind/%E5%85%83%E6%B3%A8%E8%A7%A3.svg" alt="img"></p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/cs/java/javacore/xmind/%E5%86%85%E7%BD%AE%E6%B3%A8%E8%A7%A3.svg" alt="img"></p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/cs/java/javacore/xmind/%E8%87%AA%E5%AE%9A%E4%B9%89%E6%B3%A8%E8%A7%A3.svg" alt="img"></p>
<blockquote>
<p>👉 扩展阅读：<a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/blob/master/docs/basics/java-annotation.md">深入理解 Java 注解</a></p>
</blockquote>
<h2 id="13-序列化"><a class="markdownIt-Anchor" href="#13-序列化">#</a> 13. 序列化</h2>
<p><a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/dunwu/images/dev/cs/java/javacore/xmind/Java%E5%BA%8F%E5%88%97%E5%8C%96.svg"><img src="https://raw.githubusercontent.com/dunwu/images/dev/cs/java/javacore/xmind/Java%E5%BA%8F%E5%88%97%E5%8C%96.svg" alt="img"></a></p>
<hr>
<h1 id="深入理解-java-基本数据类型"><a class="markdownIt-Anchor" href="#深入理解-java-基本数据类型">#</a> 深入理解 Java 基本数据类型</h1>
<blockquote>
<p><strong>📦 本文以及示例源码已归档在 <a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/">javacore(opens new window)</a></strong></p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/1553754196283.png" alt="img"></p>
<ul>
<li>\1. 数据类型分类
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-data-type.html#11-%E5%80%BC%E7%B1%BB%E5%9E%8B">1.1. 值类型</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-data-type.html#12-%E5%80%BC%E7%B1%BB%E5%9E%8B%E5%92%8C%E5%BC%95%E7%94%A8%E7%B1%BB%E5%9E%8B%E7%9A%84%E5%8C%BA%E5%88%AB">1.2. 值类型和引用类型的区别</a></li>
</ul>
</li>
<li>\2. 数据转换
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-data-type.html#21-%E8%87%AA%E5%8A%A8%E8%BD%AC%E6%8D%A2">2.1. 自动转换</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-data-type.html#22-%E5%BC%BA%E5%88%B6%E8%BD%AC%E6%8D%A2">2.2. 强制转换</a></li>
</ul>
</li>
<li>\3. 装箱和拆箱
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-data-type.html#31-%E5%8C%85%E8%A3%85%E7%B1%BB%E8%A3%85%E7%AE%B1%E6%8B%86%E7%AE%B1">3.1. 包装类、装箱、拆箱</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-data-type.html#32-%E8%87%AA%E5%8A%A8%E8%A3%85%E7%AE%B1%E8%87%AA%E5%8A%A8%E6%8B%86%E7%AE%B1">3.2. 自动装箱、自动拆箱</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-data-type.html#33-%E8%A3%85%E7%AE%B1%E6%8B%86%E7%AE%B1%E7%9A%84%E5%BA%94%E7%94%A8%E5%92%8C%E6%B3%A8%E6%84%8F%E7%82%B9">3.3. 装箱、拆箱的应用和注意点</a></li>
</ul>
</li>
<li>\4. 判等问题
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-data-type.html#41-%E5%8C%85%E8%A3%85%E7%B1%BB%E7%9A%84%E5%88%A4%E7%AD%89">4.1. 包装类的判等</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-data-type.html#42-string-%E7%9A%84%E5%88%A4%E7%AD%89">4.2. String 的判等</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-data-type.html#43-%E5%AE%9E%E7%8E%B0-equals">4.3. 实现 equals</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-data-type.html#44-hashcode-%E5%92%8C-equals-%E8%A6%81%E9%85%8D%E5%AF%B9%E5%AE%9E%E7%8E%B0">4.4. hashCode 和 equals 要配对实现</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-data-type.html#45-compareto-%E5%92%8C-equals-%E7%9A%84%E9%80%BB%E8%BE%91%E4%B8%80%E8%87%B4%E6%80%A7">4.5. compareTo 和 equals 的逻辑一致性</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-data-type.html#46-%E5%B0%8F%E5%BF%83-lombok-%E7%94%9F%E6%88%90%E4%BB%A3%E7%A0%81%E7%9A%84%E5%9D%91">4.6. 小心 Lombok 生成代码的 “坑”</a></li>
</ul>
</li>
<li>\5. 数值计算
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-data-type.html#51-%E6%B5%AE%E7%82%B9%E6%95%B0%E8%AE%A1%E7%AE%97%E9%97%AE%E9%A2%98">5.1. 浮点数计算问题</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-data-type.html#52-%E6%B5%AE%E7%82%B9%E6%95%B0%E7%B2%BE%E5%BA%A6%E5%92%8C%E6%A0%BC%E5%BC%8F%E5%8C%96">5.2. 浮点数精度和格式化</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-data-type.html#53-bigdecimal-%E5%88%A4%E7%AD%89%E9%97%AE%E9%A2%98">5.3. BigDecimal 判等问题</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-data-type.html#54-%E6%95%B0%E5%80%BC%E6%BA%A2%E5%87%BA">5.4. 数值溢出</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-data-type.html#6-%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">6. 参考资料</a></li>
</ul>
<h2 id=""><a class="markdownIt-Anchor" href="#">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-data-type.html#_1-%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E5%88%86%E7%B1%BB">#</a>1. 数据类型分类</h2>
<p>Java 中的数据类型有两类：</p>
<ul>
<li>值类型（又叫内置数据类型，基本数据类型）</li>
<li>引用类型（除值类型以外，都是引用类型，包括  <code>String</code> 、数组）</li>
</ul>
<h3 id="-2"><a class="markdownIt-Anchor" href="#-2">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-data-type.html#_1-1-%E5%80%BC%E7%B1%BB%E5%9E%8B">#</a>1.1. 值类型</h3>
<p>Java 语言提供了 <strong>8</strong> 种基本类型，大致分为 <strong>4</strong> 类</p>
<table>
<thead>
<tr>
<th>基本数据类型</th>
<th>分类</th>
<th>比特数</th>
<th>默认值</th>
<th>取值范围</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>boolean</code></td>
<td><strong>布尔型</strong></td>
<td>8 位</td>
<td><code>false</code></td>
<td false,="" true=""></td>
<td></td>
</tr>
<tr>
<td><code>char</code></td>
<td><strong>字符型</strong></td>
<td>16 位</td>
<td><code>'\u0000'</code></td>
<td>[0, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>16</mn></msup><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">2^{16} - 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.897438em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">6</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>]</td>
<td>存储 Unicode 码，用单引号赋值</td>
</tr>
<tr>
<td><code>byte</code></td>
<td><strong>整数型</strong></td>
<td>8 位</td>
<td><code>0</code></td>
<td>[-<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>7</mn></msup></mrow><annotation encoding="application/x-tex">2^7</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">7</span></span></span></span></span></span></span></span></span></span></span>, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>7</mn></msup><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">2^7 - 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.897438em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">7</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>]</td>
<td></td>
</tr>
<tr>
<td><code>short</code></td>
<td><strong>整数型</strong></td>
<td>16 位</td>
<td><code>0</code></td>
<td>[-<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>15</mn></msup></mrow><annotation encoding="application/x-tex">2^{15}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">5</span></span></span></span></span></span></span></span></span></span></span></span>, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>15</mn></msup><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">2^{15} - 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.897438em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">5</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>]</td>
<td></td>
</tr>
<tr>
<td><code>int</code></td>
<td><strong>整数型</strong></td>
<td>32 位</td>
<td><code>0</code></td>
<td>[-<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>31</mn></msup></mrow><annotation encoding="application/x-tex">2^{31}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span></span>, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>31</mn></msup><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">2^{31} - 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.897438em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>]</td>
<td></td>
</tr>
<tr>
<td><code>long</code></td>
<td><strong>整数型</strong></td>
<td>64 位</td>
<td><code>0L</code></td>
<td>[-<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>63</mn></msup></mrow><annotation encoding="application/x-tex">2^{63}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">6</span><span class="mord mtight">3</span></span></span></span></span></span></span></span></span></span></span></span>, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>63</mn></msup><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">2^{63} - 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.897438em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">6</span><span class="mord mtight">3</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>]</td>
<td>赋值时一般在数字后加上  <code>l</code>  或  <code>L</code></td>
</tr>
<tr>
<td><code>float</code></td>
<td><strong>浮点型</strong></td>
<td>32 位</td>
<td><code>+0.0F</code></td>
<td>[<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mrow><mo>−</mo><mn>149</mn></mrow></msup></mrow><annotation encoding="application/x-tex">2^{-149}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span><span class="mord mtight">4</span><span class="mord mtight">9</span></span></span></span></span></span></span></span></span></span></span></span>, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>128</mn></msup><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">2^{128} - 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.897438em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">2</span><span class="mord mtight">8</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>]</td>
<td>赋值时必须在数字后加上  <code>f</code>  或  <code>F</code></td>
</tr>
<tr>
<td><code>double</code></td>
<td><strong>浮点型</strong></td>
<td>64 位</td>
<td><code>+0.0D</code></td>
<td>[<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mrow><mo>−</mo><mn>1074</mn></mrow></msup></mrow><annotation encoding="application/x-tex">2^{-1074}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span><span class="mord mtight">0</span><span class="mord mtight">7</span><span class="mord mtight">4</span></span></span></span></span></span></span></span></span></span></span></span>, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>1024</mn></msup><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">2^{1024} - 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.897438em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">0</span><span class="mord mtight">2</span><span class="mord mtight">4</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>]</td>
<td>赋值时一般在数字后加  <code>d</code>  或  <code>D</code></td>
</tr>
</tbody>
</table>
<p>尽管各种数据类型的默认值看起来不一样，但在内存中都是 0。</p>
<p>在这些基本类型中， <code>boolean</code>  和  <code>char</code>  是唯二的无符号类型。</p>
<h3 id="-3"><a class="markdownIt-Anchor" href="#-3">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-data-type.html#_1-2-%E5%80%BC%E7%B1%BB%E5%9E%8B%E5%92%8C%E5%BC%95%E7%94%A8%E7%B1%BB%E5%9E%8B%E7%9A%84%E5%8C%BA%E5%88%AB">#</a>1.2. 值类型和引用类型的区别</h3>
<ul>
<li>从概念方面来说
<ul>
<li>基本类型：变量名指向具体的数值。</li>
<li>引用类型：变量名指向存数据对象的内存地址。</li>
</ul>
</li>
<li>从内存方面来说
<ul>
<li>基本类型：变量在声明之后，Java 就会立刻分配给他内存空间。</li>
<li>引用类型：它以特殊的方式（类似 C 指针）向对象实体（具体的值），这类变量声明时不会分配内存，只是存储了一个内存地址。</li>
</ul>
</li>
<li>从使用方面来说
<ul>
<li>基本类型：使用时需要赋具体值，判断时使用  <code>==</code>  号。</li>
<li>引用类型：使用时可以赋 null，判断时使用  <code>equals</code>  方法。</li>
</ul>
</li>
</ul>
<blockquote>
<p>👉 扩展阅读：<a target="_blank" rel="noopener" href="https://juejin.im/post/59cd71835188255d3448faf6">Java 基本数据类型和引用类型 (opens new window)</a></p>
<p>这篇文章对于基本数据类型和引用类型的内存存储讲述比较生动。</p>
</blockquote>
<h2 id="-4"><a class="markdownIt-Anchor" href="#-4">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-data-type.html#_2-%E6%95%B0%E6%8D%AE%E8%BD%AC%E6%8D%A2">#</a>2. 数据转换</h2>
<p>Java 中，数据类型转换有两种方式：</p>
<ul>
<li>自动转换</li>
<li>强制转换</li>
</ul>
<h3 id="-5"><a class="markdownIt-Anchor" href="#-5">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-data-type.html#_2-1-%E8%87%AA%E5%8A%A8%E8%BD%AC%E6%8D%A2">#</a>2.1. 自动转换</h3>
<p>一般情况下，定义了某数据类型的变量，就不能再随意转换。但是 JAVA 允许用户对基本类型做<strong>有限度</strong>的类型转换。</p>
<p>如果符合以下条件，则 JAVA 将会自动做类型转换：</p>
<ul>
<li>
<p><strong>由小数据转换为大数据</strong></p>
<p>显而易见的是，“小” 数据类型的数值表示范围小于 “大” 数据类型的数值表示范围，即精度小于 “大” 数据类型。</p>
<p>所以，如果 “大” 数据向 “小” 数据转换，会丢失数据精度。比如：long 转为 int，则超出 int 表示范围的数据将会丢失，导致结果的不确定性。</p>
<p>反之，“小” 数据向 “大” 数据转换，则不会存在数据丢失情况。由于这个原因，这种类型转换也称为<strong>扩大转换</strong>。</p>
<p>这些类型由 “小” 到 “大” 分别为：(byte，short，char) &lt; int &lt; long &lt; float &lt; double。</p>
<p>这里我们所说的 “大” 与 “小”，并不是指占用字节的多少，而是指表示值的范围的大小。</p>
</li>
<li>
<p><strong>转换前后的数据类型要兼容</strong></p>
<p>由于 boolean 类型只能存放 true 或 false，这与整数或字符是不兼容的，因此不可以做类型转换。</p>
</li>
<li>
<p><strong>整型类型和浮点型进行计算后，结果会转为浮点类型</strong></p>
</li>
</ul>
<p>示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">long</span> x <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>
<span class="token keyword">float</span> y <span class="token operator">=</span> <span class="token number">14.3f</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"x/y = "</span> <span class="token operator">+</span> x<span class="token operator">/</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>输出：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">x/y = 1.9607843<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>可见 long 虽然精度大于 float 类型，但是结果为浮点数类型。</p>
<h3 id="-6"><a class="markdownIt-Anchor" href="#-6">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-data-type.html#_2-2-%E5%BC%BA%E5%88%B6%E8%BD%AC%E6%8D%A2">#</a>2.2. 强制转换</h3>
<p>在不符合自动转换条件时或者根据用户的需要，可以对数据类型做强制的转换。</p>
<p><strong>强制转换使用括号  <code>()</code>  。</strong></p>
<p>引用类型也可以使用强制转换。</p>
<p>示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">float</span> f <span class="token operator">=</span> <span class="token number">25.5f</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>f<span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"x = "</span> <span class="token operator">+</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h2 id="-7"><a class="markdownIt-Anchor" href="#-7">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-data-type.html#_3-%E8%A3%85%E7%AE%B1%E5%92%8C%E6%8B%86%E7%AE%B1">#</a>3. 装箱和拆箱</h2>
<h3 id="-8"><a class="markdownIt-Anchor" href="#-8">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-data-type.html#_3-1-%E5%8C%85%E8%A3%85%E7%B1%BB%E3%80%81%E8%A3%85%E7%AE%B1%E3%80%81%E6%8B%86%E7%AE%B1">#</a>3.1. 包装类、装箱、拆箱</h3>
<p>Java 中为每一种基本数据类型提供了相应的包装类，如下：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Byte &lt;-> byte
Short &lt;-> short
Integer &lt;-> int
Long &lt;-> long
Float &lt;-> float
Double &lt;-> double
Character &lt;-> char
Boolean &lt;-> boolean<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>引入包装类的目的</strong>就是：提供一种机制，使得<strong>基本数据类型可以与引用类型互相转换</strong>。</p>
<p>基本数据类型与包装类的转换被称为 <code>装箱</code> 和 <code>拆箱</code> 。</p>
<ul>
<li>
<p><code>装箱</code> （boxing）是将值类型转换为引用类型</p>
<p>。例如： <code>int</code>  转 <code>Integer</code></p>
<ul>
<li>装箱过程是通过调用包装类的  <code>valueOf</code>  方法实现的。</li>
</ul>
</li>
<li>
<p><code>拆箱</code> （unboxing）是将引用类型转换为值类型</p>
<p>。例如： <code>Integer</code>  转 <code>int</code></p>
<ul>
<li>拆箱过程是通过调用包装类的  <code>xxxValue</code>  方法实现的。（xxx 代表对应的基本数据类型）。</li>
</ul>
</li>
</ul>
<h3 id="-9"><a class="markdownIt-Anchor" href="#-9">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-data-type.html#_3-2-%E8%87%AA%E5%8A%A8%E8%A3%85%E7%AE%B1%E3%80%81%E8%87%AA%E5%8A%A8%E6%8B%86%E7%AE%B1">#</a>3.2. 自动装箱、自动拆箱</h3>
<p>基本数据（Primitive）型的自动装箱（boxing）拆箱（unboxing）自 JDK 5 开始提供的功能。</p>
<p>自动装箱与拆箱的机制可以让我们在 Java 的变量赋值或者是方法调用等情况下使用原始类型或者对象类型更加简单直接。 因为自动装箱会隐式地创建对象，如果在一个循环体中，会创建无用的中间对象，这样会增加 GC 压力，拉低程序的性能。所以在写循环时一定要注意代码，避免引入不必要的自动装箱操作。</p>
<p>JDK 5 之前的形式：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Integer</span> i1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Integer</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 非自动装箱</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>JDK 5 之后：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Integer</span> i2 <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span> <span class="token comment">// 自动装箱</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Java 对于自动装箱和拆箱的设计，依赖于一种叫做享元模式的设计模式（有兴趣的朋友可以去了解一下源码，这里不对设计模式展开详述）。</p>
<blockquote>
<p>👉 扩展阅读：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/dolphin0520/p/3780005.html">深入剖析 Java 中的装箱和拆箱 (opens new window)</a></p>
<p>结合示例，一步步阐述装箱和拆箱原理。</p>
</blockquote>
<h3 id="-10"><a class="markdownIt-Anchor" href="#-10">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-data-type.html#_3-3-%E8%A3%85%E7%AE%B1%E3%80%81%E6%8B%86%E7%AE%B1%E7%9A%84%E5%BA%94%E7%94%A8%E5%92%8C%E6%B3%A8%E6%84%8F%E7%82%B9">#</a>3.3. 装箱、拆箱的应用和注意点</h3>
<h4 id="-11"><a class="markdownIt-Anchor" href="#-11">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-data-type.html#%E8%A3%85%E7%AE%B1%E3%80%81%E6%8B%86%E7%AE%B1%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF">#</a>装箱、拆箱应用场景</h4>
<ul>
<li>一种最普通的场景是：调用一个<strong>含类型为  <code>Object</code>  参数的方法</strong>，该  <code>Object</code>  可支持任意类型（因为  <code>Object</code>  是所有类的父类），以便通用。当你需要将一个值类型（如 int）传入时，需要使用  <code>Integer</code>  装箱。</li>
<li>另一种用法是：一个<strong>非泛型的容器</strong>，同样是为了保证通用，而将元素类型定义为  <code>Object</code> 。于是，要将值类型数据加入容器时，需要装箱。</li>
<li>当  <code>==</code>  运算符的两个操作，一个操作数是包装类，另一个操作数是表达式（即包含算术运算）则比较的是数值（即会触发自动拆箱的过程）。</li>
</ul>
<p>【示例】装箱、拆箱示例</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Integer</span> i1 <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span> <span class="token comment">// 自动装箱</span>
<span class="token class-name">Integer</span> i2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Integer</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 非自动装箱</span>
<span class="token class-name">Integer</span> i3 <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 非自动装箱</span>
<span class="token keyword">int</span> i4 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Integer</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 自动拆箱</span>
<span class="token keyword">int</span> i5 <span class="token operator">=</span> i2<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 非自动拆箱</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"i1 = ["</span> <span class="token operator">+</span> i1 <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"i2 = ["</span> <span class="token operator">+</span> i2 <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"i3 = ["</span> <span class="token operator">+</span> i3 <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"i4 = ["</span> <span class="token operator">+</span> i4 <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"i5 = ["</span> <span class="token operator">+</span> i5 <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"i1 == i2 is ["</span> <span class="token operator">+</span> <span class="token punctuation">(</span>i1 <span class="token operator">==</span> i2<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"i1 == i4 is ["</span> <span class="token operator">+</span> <span class="token punctuation">(</span>i1 <span class="token operator">==</span> i4<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 自动拆箱</span>
<span class="token comment">// Output:</span>
<span class="token comment">// i1 = [10]</span>
<span class="token comment">// i2 = [10]</span>
<span class="token comment">// i3 = [10]</span>
<span class="token comment">// i4 = [10]</span>
<span class="token comment">// i5 = [10]</span>
<span class="token comment">// i1 == i2 is [false]</span>
<span class="token comment">// i1 == i4 is [true]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>【说明】</p>
<p>上面的例子，虽然简单，但却隐藏了自动装箱、拆箱和非自动装箱、拆箱的应用。从例子中可以看到，明明所有变量都初始化为数值 10 了，但为何会出现  <code>i1 == i2 is [false</code>  而  <code>i1 == i4 is [true]</code>  ？</p>
<p>原因在于：</p>
<ul>
<li>i1、i2 都是包装类，使用  <code>==</code>  时，Java 将它们当做两个对象，而非两个 int 值来比较，所以两个对象自然是不相等的。正确的比较操作应该使用  <code>equals</code>  方法。</li>
<li>i1 是包装类，i4 是基础数据类型，使用  <code>==</code>  时，Java 会将两个 i1 这个包装类对象自动拆箱为一个  <code>int</code>  值，再代入到  <code>==</code>  运算表达式中计算；最终，相当于两个  <code>int</code>  进行比较，由于值相同，所以结果相等。</li>
</ul>
<p>【示例】包装类判等问题</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Integer</span> a <span class="token operator">=</span> <span class="token number">127</span><span class="token punctuation">;</span> <span class="token comment">//Integer.valueOf(127)</span>
<span class="token class-name">Integer</span> b <span class="token operator">=</span> <span class="token number">127</span><span class="token punctuation">;</span> <span class="token comment">//Integer.valueOf(127)</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"\nInteger a = 127;\nInteger b = 127;\na == b ? &#123;&#125;"</span><span class="token punctuation">,</span> a <span class="token operator">==</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// true</span>

<span class="token class-name">Integer</span> c <span class="token operator">=</span> <span class="token number">128</span><span class="token punctuation">;</span> <span class="token comment">//Integer.valueOf(128)</span>
<span class="token class-name">Integer</span> d <span class="token operator">=</span> <span class="token number">128</span><span class="token punctuation">;</span> <span class="token comment">//Integer.valueOf(128)</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"\nInteger c = 128;\nInteger d = 128;\nc == d ? &#123;&#125;"</span><span class="token punctuation">,</span> c <span class="token operator">==</span> d<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//false</span>
<span class="token comment">//设置-XX:AutoBoxCacheMax=1000再试试</span>

<span class="token class-name">Integer</span> e <span class="token operator">=</span> <span class="token number">127</span><span class="token punctuation">;</span> <span class="token comment">//Integer.valueOf(127)</span>
<span class="token class-name">Integer</span> f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Integer</span><span class="token punctuation">(</span><span class="token number">127</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//new instance</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"\nInteger e = 127;\nInteger f = new Integer(127);\ne == f ? &#123;&#125;"</span><span class="token punctuation">,</span> e <span class="token operator">==</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//false</span>

<span class="token class-name">Integer</span> g <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Integer</span><span class="token punctuation">(</span><span class="token number">127</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//new instance</span>
<span class="token class-name">Integer</span> h <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Integer</span><span class="token punctuation">(</span><span class="token number">127</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//new instance</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"\nInteger g = new Integer(127);\nInteger h = new Integer(127);\ng == h ? &#123;&#125;"</span><span class="token punctuation">,</span> g <span class="token operator">==</span> h<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//false</span>

<span class="token class-name">Integer</span> i <span class="token operator">=</span> <span class="token number">128</span><span class="token punctuation">;</span> <span class="token comment">//unbox</span>
<span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">128</span><span class="token punctuation">;</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"\nInteger i = 128;\nint j = 128;\ni == j ? &#123;&#125;"</span><span class="token punctuation">,</span> i <span class="token operator">==</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过运行结果可以看到，虽然看起来永远是在对 127 和 127、128 和 128 判等，但 == 却并非总是返回 true。</p>
<h4 id="-12"><a class="markdownIt-Anchor" href="#-12">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-data-type.html#%E8%A3%85%E7%AE%B1%E3%80%81%E6%8B%86%E7%AE%B1%E5%BA%94%E7%94%A8%E6%B3%A8%E6%84%8F%E7%82%B9">#</a>装箱、拆箱应用注意点</h4>
<ol>
<li>装箱操作会创建对象，频繁的装箱操作会造成不必要的内存消耗，影响性能。所以<strong>应该尽量避免装箱。</strong></li>
<li>基础数据类型的比较操作使用  <code>==</code> ，包装类的比较操作使用  <code>equals</code>  方法。</li>
</ol>
<h2 id="-13"><a class="markdownIt-Anchor" href="#-13">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-data-type.html#_4-%E5%88%A4%E7%AD%89%E9%97%AE%E9%A2%98">#</a>4. 判等问题</h2>
<p>Java 中，通常使用  <code>equals</code>  或  <code>==</code>  进行判等操作。 <code>equals</code>  是方法而  <code>==</code>  是操作符。此外，二者使用也是有区别的：</p>
<ul>
<li>对<strong>基本类型</strong>，比如  <code>int</code> 、 <code>long</code> ，进行判等，<strong>只能使用  <code>==</code> ，比较的是字面值</strong>。因为基本类型的值就是其数值。</li>
<li>对<strong>引用类型</strong>，比如  <code>Integer</code> 、 <code>Long</code>  和  <code>String</code> ，进行判等，<strong>需要使用  <code>equals</code>  进行内容判等</strong>。因为引用类型的直接值是指针，使用  <code>==</code>  的话，比较的是指针，也就是两个对象在内存中的地址，即比较它们是不是同一个对象，而不是比较对象的内容。</li>
</ul>
<h3 id="-14"><a class="markdownIt-Anchor" href="#-14">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-data-type.html#_4-1-%E5%8C%85%E8%A3%85%E7%B1%BB%E7%9A%84%E5%88%A4%E7%AD%89">#</a>4.1. 包装类的判等</h3>
<p>我们通过一个示例来深入研究一下判等问题。</p>
<p>【示例】包装类的判等</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Integer</span> a <span class="token operator">=</span> <span class="token number">127</span><span class="token punctuation">;</span> <span class="token comment">//Integer.valueOf(127)</span>
<span class="token class-name">Integer</span> b <span class="token operator">=</span> <span class="token number">127</span><span class="token punctuation">;</span> <span class="token comment">//Integer.valueOf(127)</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"\nInteger a = 127;\nInteger b = 127;\na == b ? &#123;&#125;"</span><span class="token punctuation">,</span> a <span class="token operator">==</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// true</span>

<span class="token class-name">Integer</span> c <span class="token operator">=</span> <span class="token number">128</span><span class="token punctuation">;</span> <span class="token comment">//Integer.valueOf(128)</span>
<span class="token class-name">Integer</span> d <span class="token operator">=</span> <span class="token number">128</span><span class="token punctuation">;</span> <span class="token comment">//Integer.valueOf(128)</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"\nInteger c = 128;\nInteger d = 128;\nc == d ? &#123;&#125;"</span><span class="token punctuation">,</span> c <span class="token operator">==</span> d<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//false</span>
<span class="token comment">//设置-XX:AutoBoxCacheMax=1000再试试</span>

<span class="token class-name">Integer</span> e <span class="token operator">=</span> <span class="token number">127</span><span class="token punctuation">;</span> <span class="token comment">//Integer.valueOf(127)</span>
<span class="token class-name">Integer</span> f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Integer</span><span class="token punctuation">(</span><span class="token number">127</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//new instance</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"\nInteger e = 127;\nInteger f = new Integer(127);\ne == f ? &#123;&#125;"</span><span class="token punctuation">,</span> e <span class="token operator">==</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//false</span>

<span class="token class-name">Integer</span> g <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Integer</span><span class="token punctuation">(</span><span class="token number">127</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//new instance</span>
<span class="token class-name">Integer</span> h <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Integer</span><span class="token punctuation">(</span><span class="token number">127</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//new instance</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"\nInteger g = new Integer(127);\nInteger h = new Integer(127);\ng == h ? &#123;&#125;"</span><span class="token punctuation">,</span> g <span class="token operator">==</span> h<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//false</span>

<span class="token class-name">Integer</span> i <span class="token operator">=</span> <span class="token number">128</span><span class="token punctuation">;</span> <span class="token comment">//unbox</span>
<span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">128</span><span class="token punctuation">;</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"\nInteger i = 128;\nint j = 128;\ni == j ? &#123;&#125;"</span><span class="token punctuation">,</span> i <span class="token operator">==</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>第一个案例中，编译器会把 Integer a = 127 转换为 Integer.valueOf (127)。查看源码可以发现，这个转换在内部其实做了缓存，使得两个 Integer 指向同一个对象，所以 == 返回 true。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Integer</span> <span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">>=</span> <span class="token class-name">IntegerCache</span><span class="token punctuation">.</span>low <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;=</span> <span class="token class-name">IntegerCache</span><span class="token punctuation">.</span>high<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token class-name">IntegerCache</span><span class="token punctuation">.</span>cache<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token class-name">IntegerCache</span><span class="token punctuation">.</span>low<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Integer</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>第二个案例中，之所以同样的代码 128 就返回 false 的原因是，默认情况下会缓存 [-128,127] 的数值，而 128 处于这个区间之外。设置 JVM 参数加上 -XX:AutoBoxCacheMax=1000 再试试，是不是就返回 true 了呢？</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">IntegerCache</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> low <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">128</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> high<span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Integer</span> cache<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// high value may be configured by property</span>
        <span class="token keyword">int</span> h <span class="token operator">=</span> <span class="token number">127</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> integerCacheHighPropValue <span class="token operator">=</span>
            sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span>VM<span class="token punctuation">.</span><span class="token function">getSavedProperty</span><span class="token punctuation">(</span><span class="token string">"java.lang.Integer.IntegerCache.high"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>integerCacheHighPropValue <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>integerCacheHighPropValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
                i <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// Maximum array size is Integer.MAX_VALUE</span>
                h <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span>MAX_VALUE <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token operator">-</span>low<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span><span class="token punctuation">(</span> <span class="token class-name">NumberFormatException</span> nfe<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// If the property cannot be parsed into an int, ignore it.</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        high <span class="token operator">=</span> h<span class="token punctuation">;</span>

        cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Integer</span><span class="token punctuation">[</span><span class="token punctuation">(</span>high <span class="token operator">-</span> low<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> j <span class="token operator">=</span> low<span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> cache<span class="token punctuation">.</span>length<span class="token punctuation">;</span> k<span class="token operator">++</span><span class="token punctuation">)</span>
            cache<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Integer</span><span class="token punctuation">(</span>j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// range [-128, 127] must be interned (JLS7 5.1.7)</span>
        <span class="token keyword">assert</span> <span class="token class-name">IntegerCache</span><span class="token punctuation">.</span>high <span class="token operator">>=</span> <span class="token number">127</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token class-name">IntegerCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>第三和第四个案例中，New 出来的 Integer 始终是不走缓存的新对象。比较两个新对象，或者比较一个新对象和一个来自缓存的对象，结果肯定不是相同的对象，因此返回 false。</p>
<p>第五个案例中，我们把装箱的 Integer 和基本类型 int 比较，前者会先拆箱再比较，比较的肯定是数值而不是引用，因此返回 true。</p>
<blockquote>
<p>【总结】综上，我们可以得出结论：<strong>包装类需要使用  <code>equals</code>  进行内容判等，而不能使用  <code>==</code> </strong>。</p>
</blockquote>
<h3 id="-15"><a class="markdownIt-Anchor" href="#-15">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-data-type.html#_4-2-string-%E7%9A%84%E5%88%A4%E7%AD%89">#</a>4.2. String 的判等</h3>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">String</span> a <span class="token operator">=</span> <span class="token string">"1"</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> b <span class="token operator">=</span> <span class="token string">"1"</span><span class="token punctuation">;</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"\nString a = \"1\";\nString b = \"1\";\na == b ? &#123;&#125;"</span><span class="token punctuation">,</span> a <span class="token operator">==</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//true</span>

<span class="token class-name">String</span> c <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> d <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"\nString c = new String(\"2\");\nString d = new String(\"2\");\nc == d ? &#123;&#125;"</span><span class="token punctuation">,</span> c <span class="token operator">==</span> d<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//false</span>

<span class="token class-name">String</span> e <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">"3"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">"3"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"\nString e = new String(\"3\").intern();\nString f = new String(\"3\").intern();\ne == f ? &#123;&#125;"</span><span class="token punctuation">,</span> e <span class="token operator">==</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//true</span>

<span class="token class-name">String</span> g <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">"4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> h <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">"4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"\nString g = new String(\"4\");\nString h = new String(\"4\");\ng == h ? &#123;&#125;"</span><span class="token punctuation">,</span> g<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在 JVM 中，当代码中出现双引号形式创建字符串对象时，JVM 会先对这个字符串进行检查，如果字符串常量池中存在相同内容的字符串对象的引用，则将这个引用返回；否则，创建新的字符串对象，然后将这个引用放入字符串常量池，并返回该引用。这种机制，就是字符串驻留或池化。</p>
<p>第一个案例返回 true，因为 Java 的字符串驻留机制，直接使用双引号声明出来的两个 String 对象指向常量池中的相同字符串。</p>
<p>第二个案例，new 出来的两个 String 是不同对象，引用当然不同，所以得到 false 的结果。</p>
<p>第三个案例，使用 String 提供的 intern 方法也会走常量池机制，所以同样能得到 true。</p>
<p>第四个案例，通过 equals 对值内容判等，是正确的处理方式，当然会得到 true。</p>
<p>虽然使用 new 声明的字符串调用 intern 方法，也可以让字符串进行驻留，但在业务代码中滥用 intern，可能会产生性能问题。</p>
<p>【示例】String#intern 性能测试</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//-XX:+PrintStringTableStatistics</span>
<span class="token comment">//-XX:StringTableSize=10000000</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">long</span> begin <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
list <span class="token operator">=</span> <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10000000</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">mapToObj</span><span class="token punctuation">(</span>i <span class="token operator">-></span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"size:"</span> <span class="token operator">+</span> list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"time:"</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> begin<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上面的示例执行时间会比较长。原因在于：字符串常量池是一个固定容量的 Map。如果容量太小（Number of buckets=60013）、字符串太多（1000 万个字符串），那么每一个桶中的字符串数量会非常多，所以搜索起来就很慢。输出结果中的 Average bucket size=167，代表了 Map 中桶的平均长度是 167。</p>
<p>解决方法是：设置 JVM 参数 -XX:StringTableSize=10000000，指定更多的桶。</p>
<p>为了方便观察，可以在启动程序时设置 JVM 参数 -XX:+PrintStringTableStatistic，程序退出时可以打印出字符串常量表的统计信息。</p>
<p>执行结果比不设置 -XX:StringTableSize 要快很多。</p>
<blockquote>
<p>【总结】<strong>没事别轻易用 intern，如果要用一定要注意控制驻留的字符串的数量，并留意常量表的各项指标</strong>。</p>
</blockquote>
<h3 id="-16"><a class="markdownIt-Anchor" href="#-16">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-data-type.html#_4-3-%E5%AE%9E%E7%8E%B0-equals">#</a>4.3. 实现 equals</h3>
<p>如果看过 Object 类源码，你可能就知道，equals 的实现其实是比较对象引用</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">==</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>之所以 Integer 或 String 能通过 equals 实现内容判等，是因为它们都覆写了这个方法。</p>
<p>对于自定义类型，如果不覆写 equals 的话，默认就是使用 Object 基类的按引用的比较方式。</p>
<p>实现一个更好的 equals 应该注意的点：</p>
<ul>
<li>考虑到性能，可以先进行指针判等，如果对象是同一个那么直接返回 true；</li>
<li>需要对另一方进行判空，空对象和自身进行比较，结果一定是 fasle；</li>
<li>需要判断两个对象的类型，如果类型都不同，那么直接返回 false；</li>
<li>确保类型相同的情况下再进行类型强制转换，然后逐一判断所有字段。</li>
</ul>
<p>【示例】自定义 equals 示例</p>
<p>自定义类：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Point</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> x<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> y<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> desc<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>自定义 equals：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">==</span> o<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>o <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> o<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token class-name">Point</span> that <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Point</span><span class="token punctuation">)</span> o<span class="token punctuation">;</span>
    <span class="token keyword">return</span> x <span class="token operator">==</span> that<span class="token punctuation">.</span>x <span class="token operator">&amp;&amp;</span> y <span class="token operator">==</span> that<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-17"><a class="markdownIt-Anchor" href="#-17">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-data-type.html#_4-4-hashcode-%E5%92%8C-equals-%E8%A6%81%E9%85%8D%E5%AF%B9%E5%AE%9E%E7%8E%B0">#</a>4.4. hashCode 和 equals 要配对实现</h3>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Point</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Point</span> p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PointWrong</span><span class="token punctuation">></span></span> points <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
points<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>p1<span class="token punctuation">)</span><span class="token punctuation">;</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"points.contains(p2) ? &#123;&#125;"</span><span class="token punctuation">,</span> points<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>p2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>按照改进后的 equals 方法，这 2 个对象可以认为是同一个，Set 中已经存在了 p1 就应该包含 p2，但结果却是 false。</p>
<p>出现这个 Bug 的原因是，散列表需要使用 hashCode 来定位元素放到哪个桶。如果自定义对象没有实现自定义的 hashCode 方法，就会使用 Object 超类的默认实现，得到的两个 hashCode 是不同的，导致无法满足需求。</p>
<p>要自定义 hashCode，我们可以直接使用 Objects.hash 方法来实现。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-18"><a class="markdownIt-Anchor" href="#-18">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-data-type.html#_4-5-compareto-%E5%92%8C-equals-%E7%9A%84%E9%80%BB%E8%BE%91%E4%B8%80%E8%87%B4%E6%80%A7">#</a>4.5. compareTo 和 equals 的逻辑一致性</h3>
<p>【示例】自定义 compareTo 出错示例</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Student</span> <span class="token keyword">implements</span> <span class="token class-name">Comparable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Student</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">compareTo</span><span class="token punctuation">(</span><span class="token class-name">Student</span> other<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>id<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"this &#123;&#125; == other &#123;&#125;"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> other<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>调用：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Student</span><span class="token punctuation">></span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"zhang"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"wang"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Student</span> student <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"li"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"ArrayList.indexOf"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> index1 <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>student<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Collections.binarySearch"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> index2 <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">binarySearch</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> student<span class="token punctuation">)</span><span class="token punctuation">;</span>

log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"index1 = "</span> <span class="token operator">+</span> index1<span class="token punctuation">)</span><span class="token punctuation">;</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"index2 = "</span> <span class="token operator">+</span> index2<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>binarySearch 方法内部调用了元素的 compareTo 方法进行比较；</p>
<ul>
<li>indexOf 的结果没问题，列表中搜索不到 id 为 2、name 是 li 的学生；</li>
<li>binarySearch 返回了索引 1，代表搜索到的结果是 id 为 2，name 是 wang 的学生。</li>
</ul>
<p>修复方式很简单，确保 compareTo 的比较逻辑和 equals 的实现一致即可。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">StudentRight</span> <span class="token keyword">implements</span> <span class="token class-name">Comparable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StudentRight</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">compareTo</span><span class="token punctuation">(</span><span class="token class-name">StudentRight</span> other<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token class-name">Comparator</span><span class="token punctuation">.</span><span class="token function">comparing</span><span class="token punctuation">(</span><span class="token class-name">StudentRight</span><span class="token operator">::</span><span class="token function">getName</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">thenComparingInt</span><span class="token punctuation">(</span><span class="token class-name">StudentRight</span><span class="token operator">::</span><span class="token function">getId</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> other<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-19"><a class="markdownIt-Anchor" href="#-19">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-data-type.html#_4-6-%E5%B0%8F%E5%BF%83-lombok-%E7%94%9F%E6%88%90%E4%BB%A3%E7%A0%81%E7%9A%84-%E5%9D%91">#</a>4.6. 小心 Lombok 生成代码的 “坑”</h3>
<p>Lombok 的 @Data 注解会帮我们实现 equals 和 hashcode 方法，但是有继承关系时， Lombok 自动生成的方法可能就不是我们期望的了。</p>
<p>@EqualsAndHashCode 默认实现没有使用父类属性。为解决这个问题，我们可以手动设置 callSuper 开关为 true，来覆盖这种默认行为。</p>
<h2 id="-20"><a class="markdownIt-Anchor" href="#-20">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-data-type.html#_5-%E6%95%B0%E5%80%BC%E8%AE%A1%E7%AE%97">#</a>5. 数值计算</h2>
<h3 id="-21"><a class="markdownIt-Anchor" href="#-21">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-data-type.html#_5-1-%E6%B5%AE%E7%82%B9%E6%95%B0%E8%AE%A1%E7%AE%97%E9%97%AE%E9%A2%98">#</a>5.1. 浮点数计算问题</h3>
<p>计算机是把数值保存在了变量中，不同类型的数值变量能保存的数值范围不同，当数值超过类型能表达的数值上限则会发生溢出问题。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token number">0.1</span> <span class="token operator">+</span> <span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0.30000000000000004</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">-</span> <span class="token number">0.8</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0.19999999999999996</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token number">4.015</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 401.49999999999994</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token number">123.3</span> <span class="token operator">/</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1.2329999999999999</span>
<span class="token keyword">double</span> amount1 <span class="token operator">=</span> <span class="token number">2.15</span><span class="token punctuation">;</span>
<span class="token keyword">double</span> amount2 <span class="token operator">=</span> <span class="token number">1.10</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>amount1 <span class="token operator">-</span> amount2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1.0499999999999998</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上面的几个示例，输出结果和我们预期的很不一样。为什么会是这样呢？</p>
<p>出现这种问题的主要原因是，计算机是以二进制存储数值的，浮点数也不例外。Java 采用了 IEEE 754 标准实现浮点数的表达和运算，你可以通过这里查看数值转化为二进制的结果。</p>
<p>比如，0.1 的二进制表示为 0.0 0011 0011 0011… （0011 无限循环)，再转换为十进制就是 0.1000000000000000055511151231257827021181583404541015625。对于计算机而言，0.1 无法精确表达，这是浮点数计算造成精度损失的根源。</p>
<p><strong>浮点数无法精确表达和运算的场景，一定要使用 BigDecimal 类型</strong>。</p>
<p>使用 BigDecimal 时，有个细节要格外注意。让我们来看一段代码：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Output: 0.3000000000000000166533453693773481063544750213623046875</span>

<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subtract</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token number">0.8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Output: 0.1999999999999999555910790149937383830547332763671875</span>

<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token number">4.015</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Output: 401.49999999999996802557689079549163579940795898437500</span>

<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token number">123.3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">divide</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Output: 1.232999999999999971578290569595992565155029296875</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>为什么输出结果仍然不符合预期呢？</p>
<p><strong>使用 BigDecimal 表示和计算浮点数，且务必使用字符串的构造方法来初始化 BigDecimal</strong>。</p>
<h3 id="-22"><a class="markdownIt-Anchor" href="#-22">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-data-type.html#_5-2-%E6%B5%AE%E7%82%B9%E6%95%B0%E7%B2%BE%E5%BA%A6%E5%92%8C%E6%A0%BC%E5%BC%8F%E5%8C%96">#</a>5.2. 浮点数精度和格式化</h3>
<p><strong>浮点数的字符串格式化也要通过 BigDecimal 进行</strong>。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">wrong1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">double</span> num1 <span class="token operator">=</span> <span class="token number">3.35</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> num2 <span class="token operator">=</span> <span class="token number">3.35f</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%.1f"</span><span class="token punctuation">,</span> num1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3.4</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%.1f"</span><span class="token punctuation">,</span> num2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3.3</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">wrong2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">double</span> num1 <span class="token operator">=</span> <span class="token number">3.35</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> num2 <span class="token operator">=</span> <span class="token number">3.35f</span><span class="token punctuation">;</span>
    <span class="token class-name">DecimalFormat</span> format <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DecimalFormat</span><span class="token punctuation">(</span><span class="token string">"#.##"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    format<span class="token punctuation">.</span><span class="token function">setRoundingMode</span><span class="token punctuation">(</span><span class="token class-name">RoundingMode</span><span class="token punctuation">.</span>DOWN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>format<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>num1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3.35</span>
    format<span class="token punctuation">.</span><span class="token function">setRoundingMode</span><span class="token punctuation">(</span><span class="token class-name">RoundingMode</span><span class="token punctuation">.</span>DOWN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>format<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>num2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3.34</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">right</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">BigDecimal</span> num1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">"3.35"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BigDecimal</span> num2 <span class="token operator">=</span> num1<span class="token punctuation">.</span><span class="token function">setScale</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">.</span>ROUND_DOWN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>num2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3.3</span>
    <span class="token class-name">BigDecimal</span> num3 <span class="token operator">=</span> num1<span class="token punctuation">.</span><span class="token function">setScale</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">.</span>ROUND_HALF_UP<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>num3<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3.4</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-23"><a class="markdownIt-Anchor" href="#-23">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-data-type.html#_5-3-bigdecimal-%E5%88%A4%E7%AD%89%E9%97%AE%E9%A2%98">#</a>5.3. BigDecimal 判等问题</h3>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">wrong</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">"1.0"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">right</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">"1.0"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>BigDecimal 的 equals 方法的注释中说明了原因，equals 比较的是 BigDecimal 的 value 和 scale，1.0 的 scale 是 1，1 的 scale 是 0，所以结果一定是 false。</p>
<p><strong>如果我们希望只比较 BigDecimal 的 value，可以使用 compareTo 方法</strong>。</p>
<p>BigDecimal 的 equals 和 hashCode 方法会同时考虑 value 和 scale，如果结合 HashSet 或 HashMap 使用的话就可能会出现麻烦。比如，我们把值为 1.0 的 BigDecimal 加入 HashSet，然后判断其是否存在值为 1 的 BigDecimal，得到的结果是 false。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BigDecimal</span><span class="token punctuation">></span></span> hashSet1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
hashSet1<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">"1.0"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hashSet1<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//返回false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>解决办法有两个：</p>
<p>第一个方法是，使用 TreeSet 替换 HashSet。TreeSet 不使用 hashCode 方法，也不使用 equals 比较元素，而是使用 compareTo 方法，所以不会有问题。</p>
<p>第二个方法是，把 BigDecimal 存入 HashSet 或 HashMap 前，先使用 stripTrailingZeros 方法去掉尾部的零，比较的时候也去掉尾部的 0，确保 value 相同的 BigDecimal，scale 也是一致的。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BigDecimal</span><span class="token punctuation">></span></span> hashSet2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
hashSet2<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">"1.0"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stripTrailingZeros</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hashSet2<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">"1.000"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stripTrailingZeros</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//返回true</span>

<span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BigDecimal</span><span class="token punctuation">></span></span> treeSet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
treeSet<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">"1.0"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>treeSet<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//返回true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-24"><a class="markdownIt-Anchor" href="#-24">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-data-type.html#_5-4-%E6%95%B0%E5%80%BC%E6%BA%A2%E5%87%BA">#</a>5.4. 数值溢出</h3>
<p>数值计算还有一个要小心的点是溢出，不管是 int 还是 long，所有的基本数值类型都有超出表达范围的可能性。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">long</span> l <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>l <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// -9223372036854775808</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>l <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">==</span> <span class="token class-name">Long</span><span class="token punctuation">.</span>MIN_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><strong>显然这是发生了溢出，而且是默默的溢出，并没有任何异常</strong>。这类问题非常容易被忽略，改进方式有下面 2 种。</p>
<p>方法一是，考虑使用 Math 类的 addExact、subtractExact 等 xxExact 方法进行数值运算，这些方法可以在数值溢出时主动抛出异常。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">long</span> l <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">addExact</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    ex<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>方法二是，使用大数类 BigInteger。BigDecimal 是处理浮点数的专家，而 BigInteger 则是对大数进行科学计算的专家。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">BigInteger</span> i <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigInteger</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">BigInteger</span><span class="token punctuation">.</span>ONE<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">long</span> l <span class="token operator">=</span> i<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">BigInteger</span><span class="token punctuation">.</span>ONE<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">longValueExact</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    ex<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<h1 id="深入理解-java-string-类型"><a class="markdownIt-Anchor" href="#深入理解-java-string-类型">#</a> 深入理解 Java String 类型</h1>
<blockquote>
<p><strong>📦 本文以及示例源码已归档在 <a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/">javacore(opens new window)</a></strong></p>
<p>String 类型可能是 Java 中应用最频繁的引用类型，但它的性能问题却常常被忽略。高效的使用字符串，可以提升系统的整体性能。当然，要做到高效使用字符串，需要深入了解其特性。</p>
</blockquote>
<ul>
<li>
<p><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-string.html#1-string-%E7%9A%84%E4%B8%8D%E5%8F%AF%E5%8F%98%E6%80%A7">1. String 的不可变性</a></p>
</li>
<li>
<ol start="2">
<li>String 的性能考量</li>
</ol>
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-string.html#21-%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%8B%BC%E6%8E%A5">2.1. 字符串拼接</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-string.html#22-%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%88%86%E5%89%B2">2.2. 字符串分割</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-string.html#23-stringintern">2.3. String.intern</a></li>
</ul>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-string.html#3-stringstringbufferstringbuilder-%E6%9C%89%E4%BB%80%E4%B9%88%E5%8C%BA%E5%88%AB">3. String、StringBuffer、StringBuilder 有什么区别</a></p>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-string.html#4-%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">4. 参考资料</a></p>
</li>
</ul>
<h2 id="-25"><a class="markdownIt-Anchor" href="#-25">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-string.html#_1-string-%E7%9A%84%E4%B8%8D%E5%8F%AF%E5%8F%98%E6%80%A7">#</a>1. String 的不可变性</h2>
<p>我们先来看下  <code>String</code>  的定义：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">String</span>
    <span class="token keyword">implements</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span><span class="token punctuation">,</span> <span class="token class-name">Comparable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span><span class="token punctuation">,</span> <span class="token class-name">CharSequence</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">/** The value is used for character storage. */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">char</span> value<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>String</code>  类被  <code>final</code>  关键字修饰，表示<strong>不可继承  <code>String</code>  类</strong>。</p>
<p><code>String</code>  类的数据存储于  <code>char[]</code>  数组，这个数组被  <code>final</code>  关键字修饰，表示 <strong> <code>String</code>  对象不可被更改</strong>。</p>
<p>为什么 Java 要这样设计？</p>
<p>（1）<strong>保证 String 对象安全性</strong>。避免 String 被篡改。</p>
<p>（2）<strong>保证 hash 值不会频繁变更</strong>。</p>
<p>（3）<strong>可以实现字符串常量池</strong>。通常有两种创建字符串对象的方式，一种是通过字符串常量的方式创建，如  <code>String str=&quot;abc&quot;;</code>  另一种是字符串变量通过 new 形式的创建，如  <code>String str = new String(&quot;abc&quot;)</code> 。</p>
<p>使用第一种方式创建字符串对象时，JVM 首先会检查该对象是否在字符串常量池中，如果在，就返回该对象引用，否则新的字符串将在常量池中被创建。这种方式可以减少同一个值的字符串对象的重复创建，节约内存。</p>
<p><code>String str = new String(&quot;abc&quot;)</code>  这种方式，首先在编译类文件时， <code>&quot;abc&quot;</code>  常量字符串将会放入到常量结构中，在类加载时， <code>&quot;abc&quot;</code>  将会在常量池中创建；其次，在调用 new 时，JVM 命令将会调用  <code>String</code>  的构造函数，同时引用常量池中的  <code>&quot;abc&quot;</code>  字符串，在堆内存中创建一个  <code>String</code>  对象；最后，str 将引用  <code>String</code>  对象。</p>
<h2 id="-26"><a class="markdownIt-Anchor" href="#-26">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-string.html#_2-string-%E7%9A%84%E6%80%A7%E8%83%BD%E8%80%83%E9%87%8F">#</a>2. String 的性能考量</h2>
<h3 id="-27"><a class="markdownIt-Anchor" href="#-27">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-string.html#_2-1-%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%8B%BC%E6%8E%A5">#</a>2.1. 字符串拼接</h3>
<p><strong>字符串常量的拼接，编译器会将其优化为一个常量字符串</strong>。</p>
<p>【示例】字符串常量拼接</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 本行代码在 class 文件中，会被编译器直接优化为：</span>
    <span class="token comment">// String str = "abc";</span>
    <span class="token class-name">String</span> str <span class="token operator">=</span> <span class="token string">"a"</span> <span class="token operator">+</span> <span class="token string">"b"</span> <span class="token operator">+</span> <span class="token string">"c"</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"str = "</span> <span class="token operator">+</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>字符串变量的拼接，编译器会优化成  <code>StringBuilder</code>  的方式</strong>。</p>
<p>【示例】字符串变量的拼接</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">String</span> str <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 本行代码会被编译器优化为：</span>
        <span class="token comment">// str = (new StringBuilder(String.valueOf(str))).append(i).toString();</span>
        str <span class="token operator">=</span> str <span class="token operator">+</span> i<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>但是，每次循环都会生成一个新的  <code>StringBuilder</code>  实例，同样也会降低系统的性能。</p>
<p>字符串拼接的正确方案：</p>
<ul>
<li>如果需要使用<strong>字符串拼接，应该优先考虑  <code>StringBuilder</code>  的  <code>append</code>  方法替代使用  <code>+</code>  号</strong>。</li>
<li>如果在并发编程中， <code>String</code>  对象的拼接涉及到线程安全，可以使用  <code>StringBuffer</code> 。但是要注意，由于  <code>StringBuffer</code>  是线程安全的，涉及到锁竞争，所以从性能上来说，要比  <code>StringBuilder</code>  差一些。</li>
</ul>
<h3 id="-28"><a class="markdownIt-Anchor" href="#-28">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-string.html#_2-2-%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%88%86%E5%89%B2">#</a>2.2. 字符串分割</h3>
<p><strong> <code>String</code>  的  <code>split()</code>  方法使用正则表达式实现其强大的分割功能</strong>。而正则表达式的性能是非常不稳定的，使用不恰当会引起回溯问题，很可能导致 CPU 居高不下。</p>
<p>所以，应该慎重使用  <code>split()</code>  方法，<strong>可以考虑用  <code>String.indexOf()</code>  方法代替  <code>split()</code>  方法完成字符串的分割</strong>。如果实在无法满足需求，你就在使用 Split () 方法时，对回溯问题加以重视就可以了。</p>
<h3 id="-29"><a class="markdownIt-Anchor" href="#-29">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-string.html#_2-3-string-intern">#</a>2.3. String.intern</h3>
<p><strong>在每次赋值的时候使用  <code>String</code>  的  <code>intern</code>  方法，如果常量池中有相同值，就会重复使用该对象，返回对象引用，这样一开始的对象就可以被回收掉</strong>。</p>
<p>在字符串常量中，默认会将对象放入常量池；在字符串变量中，对象是会创建在堆内存中，同时也会在常量池中创建一个字符串对象，复制到堆内存对象中，并返回堆内存对象引用。</p>
<p>如果调用  <code>intern</code>  方法，会去查看字符串常量池中是否有等于该对象的字符串，如果没有，就在常量池中新增该对象，并返回该对象引用；如果有，就返回常量池中的字符串引用。堆内存中原有的对象由于没有引用指向它，将会通过垃圾回收器回收。</p>
<p>【示例】</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SharedLocation</span> <span class="token punctuation">&#123;</span>

	<span class="token keyword">private</span> <span class="token class-name">String</span> city<span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token class-name">String</span> region<span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token class-name">String</span> countryCode<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token class-name">SharedLocation</span> sharedLocation <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SharedLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
sharedLocation<span class="token punctuation">.</span><span class="token function">setCity</span><span class="token punctuation">(</span>messageInfo<span class="token punctuation">.</span><span class="token function">getCity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		sharedLocation<span class="token punctuation">.</span><span class="token function">setCountryCode</span><span class="token punctuation">(</span>messageInfo<span class="token punctuation">.</span><span class="token function">getRegion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
sharedLocation<span class="token punctuation">.</span><span class="token function">setRegion</span><span class="token punctuation">(</span>messageInfo<span class="token punctuation">.</span><span class="token function">getCountryCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>使用  <code>intern</code>  方法需要注意：一定要结合实际场景。因为常量池的实现是类似于一个 HashTable 的实现方式，HashTable 存储的数据越大，遍历的时间复杂度就会增加。如果数据过大，会增加整个字符串常量池的负担。</p>
</blockquote>
<h2 id="-30"><a class="markdownIt-Anchor" href="#-30">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-string.html#_3-string%E3%80%81stringbuffer%E3%80%81stringbuilder-%E6%9C%89%E4%BB%80%E4%B9%88%E5%8C%BA%E5%88%AB">#</a>3. String、StringBuffer、StringBuilder 有什么区别</h2>
<p><code>String</code>  是 Java 语言非常基础和重要的类，提供了构造和管理字符串的各种基本逻辑。它是典型的  <code>Immutable</code>  类，被声明成为  <code>final class</code> ，所有属性也都是  <code>final</code>  的。也由于它的不可变性，类似拼接、裁剪字符串等动作，都会产生新的  <code>String</code>  对象。由于字符串操作的普遍性，所以相关操作的效率往往对应用性能有明显影响。</p>
<p><code>StringBuffer</code>  是为解决上面提到拼接产生太多中间对象的问题而提供的一个类，我们可以用  <code>append</code>  或者  <code>add</code>  方法，把字符串添加到已有序列的末尾或者指定位置。 <code>StringBuffer</code>  是一个<strong>线程安全的</strong>可修改字符序列。 <code>StringBuffer</code>  的线程安全是通过在各种修改数据的方法上用  <code>synchronized</code>  关键字修饰实现的。</p>
<p><code>StringBuilder</code>  是 Java 1.5 中新增的，在能力上和 StringBuffer 没有本质区别，但是它去掉了线程安全的部分，有效减小了开销，是绝大部分情况下进行字符串拼接的首选。</p>
<p><code>StringBuffer</code>  和  <code>StringBuilder</code>  底层都是利用可修改的（char，JDK 9 以后是 byte）数组，二者都继承了  <code>AbstractStringBuilder</code> ，里面包含了基本操作，区别仅在于最终的方法是否加了  <code>synchronized</code> 。构建时初始字符串长度加 16（这意味着，如果没有构建对象时输入最初的字符串，那么初始值就是 16）。我们如果确定拼接会发生非常多次，而且大概是可预计的，那么就可以指定合适的大小，避免很多次扩容的开销。扩容会产生多重开销，因为要抛弃原有数组，创建新的（可以简单认为是倍数）数组，还要进行  <code>arraycopy</code> 。</p>
<p><strong>除非有线程安全的需要，不然一般都使用  <code>StringBuilder</code> </strong></p>
<hr>
<h1 id="java-面向对象"><a class="markdownIt-Anchor" href="#java-面向对象">#</a> Java 面向对象</h1>
<blockquote>
<p>在<a target="_blank" rel="noopener" href="https://github.com/dunwu/blog/blob/master/source/_posts/programming/java/javacore/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B.md">深入理解 Java 基本数据类型 (opens new window)</a> 中我们了解 Java 中支持的基本数据类型（值类型）。本文开始讲解 Java 中重要的引用类型 —— 类。</p>
<p><strong>📦 本文以及示例源码已归档在 <a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/">javacore(opens new window)</a></strong></p>
</blockquote>
<ul>
<li>
<ol>
<li>面向对象</li>
</ol>
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-oop.html#11-%E5%B0%81%E8%A3%85">1.1. 封装</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-oop.html#12-%E7%BB%A7%E6%89%BF">1.2. 继承</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-oop.html#13-%E5%A4%9A%E6%80%81">1.3. 多态</a></li>
</ul>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-oop.html#2-%E7%B1%BB">2. 类</a></p>
</li>
<li>
<ol start="3">
<li>方法</li>
</ol>
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-oop.html#31-%E6%96%B9%E6%B3%95%E5%AE%9A%E4%B9%89">3.1. 方法定义</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-oop.html#32-%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8">3.2. 方法调用</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-oop.html#33-%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95">3.3. 构造方法</a></li>
</ul>
</li>
<li>
<ol start="4">
<li>变量</li>
</ol>
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-oop.html#41-%E5%8F%98%E9%87%8F%E4%BF%AE%E9%A5%B0%E7%AC%A6">4.1. 变量修饰符</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-oop.html#42-%E5%88%9B%E5%BB%BA%E5%AF%B9%E8%B1%A1">4.2. 创建对象</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-oop.html#43-%E8%AE%BF%E9%97%AE%E5%AE%9E%E4%BE%8B%E5%8F%98%E9%87%8F%E5%92%8C%E6%96%B9%E6%B3%95">4.3. 访问实例变量和方法</a></li>
</ul>
</li>
<li>
<ol start="5">
<li>访问权限控制</li>
</ol>
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-oop.html#51-%E4%BB%A3%E7%A0%81%E7%BB%84%E7%BB%87">5.1. 代码组织</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-oop.html#52-%E8%AE%BF%E9%97%AE%E6%9D%83%E9%99%90%E4%BF%AE%E9%A5%B0%E5%85%B3%E9%94%AE%E5%AD%97">5.2. 访问权限修饰关键字</a></li>
</ul>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-oop.html#6-%E6%8E%A5%E5%8F%A3">6. 接口</a></p>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-oop.html#7-%E6%8A%BD%E8%B1%A1%E7%B1%BB">7. 抽象类</a></p>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-oop.html#8-%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">8. 参考资料</a></p>
</li>
</ul>
<h2 id="-31"><a class="markdownIt-Anchor" href="#-31">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-oop.html#_1-%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1">#</a>1. 面向对象</h2>
<p>每种编程语言，都有自己的操纵内存中元素的方式。</p>
<p>Java 中提供了<a target="_blank" rel="noopener" href="https://github.com/dunwu/blog/blob/master/source/_posts/programming/java/javacore/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B.md">基本数据类型 (opens new window)</a>，但这还不能满足编写程序时，需要抽象更加复杂数据类型的需要。因此，Java 中，允许开发者通过类（类的机制下面会讲到）创建自定义类型。</p>
<p>有了自定义类型，那么数据类型自然会千变万化，所以，必须要有一定的机制，使得它们仍然保持一些必要的、通用的特性。</p>
<p>Java 世界有一句名言：一切皆为对象。这句话，你可能第一天学 Java 时，就听过了。这不仅仅是一句口号，也体现在 Java 的设计上。</p>
<ul>
<li>首先，所有 Java 类都继承自  <code>Object</code>  类（从这个名字，就可见一斑）。</li>
<li>几乎所有 Java 对象初始化时，都要使用  <code>new</code>  创建对象（<a target="_blank" rel="noopener" href="https://github.com/dunwu/blog/blob/master/source/_posts/programming/java/javacore/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B.md">基本数据类型 (opens new window)</a>、String、枚举特殊处理），对象存储在堆中。</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 下面两</span>
<span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token string">"abc"</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">"abc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>其中， <code>String s</code>  定义了一个名为 s 的引用，它指向一个  <code>String</code>  类型的对象，而实际的对象是  <code>“abc”</code>  字符串。这就像是，使用遥控器（引用）来操纵电视机（对象）。</p>
<p>与 C/C++ 这类语言不同，程序员只需要通过  <code>new</code>  创建一个对象，但不必负责销毁或结束一个对象。负责运行 Java 程序的 Java 虚拟机有一个垃圾回收器，它会监视  <code>new</code>  创建的对象，一旦发现对象不再被引用，则会释放对象的内存空间。</p>
<h3 id="-32"><a class="markdownIt-Anchor" href="#-32">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-oop.html#_1-1-%E5%B0%81%E8%A3%85">#</a>1.1. 封装</h3>
<p><strong>封装（Encapsulation）是指一种将抽象性函式接口的实现细节部份包装、隐藏起来的方法。</strong></p>
<p>封装最主要的作用在于我们能修改自己的实现代码，而不用修改那些调用我们代码的程序片段。</p>
<p>适当的封装可以让程式码更容易理解与维护，也加强了程式码的安全性。</p>
<p>封装的优点：</p>
<ul>
<li>良好的封装能够减少耦合。</li>
<li>类内部的结构可以自由修改。</li>
<li>可以对成员变量进行更精确的控制。</li>
<li>隐藏信息，实现细节。</li>
</ul>
<p>实现封装的步骤：</p>
<ol>
<li>修改属性的可见性来限制对属性的访问（一般限制为 private）。</li>
<li>对每个值属性提供对外的公共方法访问，也就是创建一对赋取值方法，用于对私有属性的访问。</li>
</ol>
<h3 id="-33"><a class="markdownIt-Anchor" href="#-33">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-oop.html#_1-2-%E7%BB%A7%E6%89%BF">#</a>1.2. 继承</h3>
<p>继承是 java 面向对象编程技术的一块基石，因为它允许创建分等级层次的类。</p>
<p>继承就是子类继承父类的特征和行为，使得子类对象（实例）具有父类的实例域和方法，或子类从父类继承方法，使得子类具有父类相同的行为。</p>
<p>现实中的例子：</p>
<p>狗和鸟都是动物。如果将狗、鸟作为类，它们可以继承动物类。</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/1552641712126.png" alt="img"></p>
<p>类的继承形式：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">class 父类 &#123;&#125;

class 子类 extends 父类 &#123;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="-34"><a class="markdownIt-Anchor" href="#-34">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-oop.html#%E7%BB%A7%E6%89%BF%E7%B1%BB%E5%9E%8B">#</a>继承类型</h4>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/types_of_inheritance.png" alt="img"></p>
<h4 id="-35"><a class="markdownIt-Anchor" href="#-35">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-oop.html#%E7%BB%A7%E6%89%BF%E7%9A%84%E7%89%B9%E6%80%A7">#</a>继承的特性</h4>
<ul>
<li>子类拥有父类非 private 的属性、方法。</li>
<li>子类可以拥有自己的属性和方法，即子类可以对父类进行扩展。</li>
<li>子类可以用自己的方式实现父类的方法。</li>
<li>Java 的继承是单继承，但是可以多重继承，单继承就是一个子类只能继承一个父类，多重继承就是，例如 A 类继承 B 类，B 类继承 C 类，所以按照关系就是 C 类是 B 类的父类，B 类是 A 类的父类，这是 Java 继承区别于 C++ 继承的一个特性。</li>
<li>提高了类之间的耦合性（继承的缺点，耦合度高就会造成代码之间的联系越紧密，代码独立性越差）。</li>
</ul>
<h4 id="-36"><a class="markdownIt-Anchor" href="#-36">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-oop.html#%E7%BB%A7%E6%89%BF%E5%85%B3%E9%94%AE%E5%AD%97">#</a>继承关键字</h4>
<p>继承可以使用 extends 和 implements 这两个关键字来实现继承，而且所有的类都是继承于 java.lang.Object，当一个类没有继承的两个关键字，则默认继承 object（这个类在 <strong>java.lang</strong> 包中，所以不需要 <strong>import</strong>）祖先类。</p>
<h3 id="-37"><a class="markdownIt-Anchor" href="#-37">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-oop.html#_1-3-%E5%A4%9A%E6%80%81">#</a>1.3. 多态</h3>
<p>刚开始学习面向对象编程时，容易被各种术语弄得云里雾里。所以，很多人会死记硬背书中对于术语的定义。</p>
<p>但是，随着应用和理解的深入，应该会渐渐有更进一步的认识，将其融汇贯通的理解。</p>
<p>学习类之前，先让我们思考一个问题：Java 中为什么要引入类机制，设计的初衷是什么？</p>
<p>Java 中提供的基本数据类型，只能表示单一的数值，这用于数值计算，还 OK。但是，如果要抽象模拟现实中更复杂的事物，则无法做到。</p>
<p>试想，如果要让你抽象狗的数据模型，怎么做？狗有眼耳口鼻等器官，有腿，狗有大小，毛色，这些都是它的状态，狗会跑、会叫、会吃东西，这些是它的行为。</p>
<p>类的引入，就是为了抽象这种相对复杂的事物。</p>
<p>对象是用于计算机语言对问题域中事物的描述。<strong>对象通过方法和属性来分别描述事物所具有的行为和状态。</strong></p>
<p><strong>类是用于描述同一类的对象的一个抽象的概念，类中定义了这一类对象所具有的行为和状态。</strong></p>
<p>类可以看成是创建 Java 对象的模板。</p>
<p>什么是方法？扩展阅读：<a target="_blank" rel="noopener" href="https://www.zhihu.com/question/20275578/answer/26577791">面向对象编程的弊端是什么？ - invalid s 的回答 (opens new window)</a></p>
<h2 id="-38"><a class="markdownIt-Anchor" href="#-38">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-oop.html#_2-%E7%B1%BB">#</a>2. 类</h2>
<p>与大多数面向对象编程语言一样，Java 使用  <code>class</code>  （类）关键字来表示自定义类型。自定义类型是为了更容易抽象现实事物。</p>
<p>在一个类中，可以设置一静一动两种元素：属性（静）和方法（动）。</p>
<ul>
<li><strong>属性（有的人喜欢称为成员、字段）</strong> - 属性抽象的是事物的状态。类属性可以是任何类型的对象。</li>
<li><strong>方法（有的人喜欢称为函数）</strong> - 方法抽象的是事物的行为。</li>
</ul>
<p>类的形式如下：</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/1552640231731.png" alt="img"></p>
<h2 id="-39"><a class="markdownIt-Anchor" href="#-39">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-oop.html#_3-%E6%96%B9%E6%B3%95">#</a>3. 方法</h2>
<h3 id="-40"><a class="markdownIt-Anchor" href="#-40">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-oop.html#_3-1-%E6%96%B9%E6%B3%95%E5%AE%9A%E4%B9%89">#</a>3.1. 方法定义</h3>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">修饰符 返回值类型 方法名(参数类型 参数名)&#123;
    ...
    方法体
    ...
    return 返回值;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>方法包含一个方法头和一个方法体。下面是一个方法的所有部分：</p>
<ul>
<li>** 修饰符：** 修饰符，这是可选的，告诉编译器如何调用该方法。定义了该方法的访问类型。</li>
<li>** 返回值类型 ：** 方法可能有返回值。如果没有返回值，这种情况下，返回值类型应设为 void。</li>
<li>** 方法名：** 是方法的实际名称。方法名和参数表共同构成方法签名。</li>
<li>** 参数类型：** 参数像是一个占位符。当方法被调用时，传递值给参数。这个值被称为实参或变量。参数列表是指方法的参数类型、顺序和参数的个数。参数是可选的，方法可以不包含任何参数。</li>
<li>** 方法体：** 方法体包含具体的语句，定义该方法的功能。</li>
</ul>
<p>示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
   <span class="token keyword">return</span> x <span class="token operator">+</span> y<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="-41"><a class="markdownIt-Anchor" href="#-41">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-oop.html#_3-2-%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8">#</a>3.2. 方法调用</h3>
<p>Java 支持两种调用方法的方式，根据方法是否返回值来选择。</p>
<p>当程序调用一个方法时，程序的控制权交给了被调用的方法。当被调用方法的返回语句执行或者到达方法体闭括号时候交还控制权给程序。</p>
<p>当方法返回一个值的时候，方法调用通常被当做一个值。例如：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">int larger = max(30, 40);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>如果方法返回值是 void，方法调用一定是一条语句。例如，方法 println 返回 void。下面的调用是个语句：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">System.out.println("Hello World");<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="-42"><a class="markdownIt-Anchor" href="#-42">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-oop.html#_3-3-%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95">#</a>3.3. 构造方法</h3>
<p>每个类都有构造方法。如果没有显式地为类定义任何构造方法，Java 编译器将会为该类提供一个默认构造方法。</p>
<p>在创建一个对象的时候，至少要调用一个构造方法。构造方法的名称必须与类同名，一个类可以有多个构造方法。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Puppy</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token class-name">Puppy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">Puppy</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token comment">// 这个构造器仅有一个参数：name</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="-43"><a class="markdownIt-Anchor" href="#-43">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-oop.html#_4-%E5%8F%98%E9%87%8F">#</a>4. 变量</h2>
<p>Java 支持的变量类型有：</p>
<ul>
<li><code>局部变量</code>  - 类方法中的变量。</li>
<li><code>实例变量（也叫成员变量）</code>  - 类方法外的变量，不过没有  <code>static</code>  修饰。</li>
<li><code>类变量（也叫静态变量）</code>  - 类方法外的变量，用  <code>static</code>  修饰。</li>
</ul>
<p>特性对比：</p>
<table>
<thead>
<tr>
<th>局部变量</th>
<th>实例变量（也叫成员变量）</th>
<th>类变量（也叫静态变量）</th>
</tr>
</thead>
<tbody>
<tr>
<td>局部变量声明在方法、构造方法或者语句块中。</td>
<td>实例变量声明在方法、构造方法和语句块之外。</td>
<td>类变量声明在方法、构造方法和语句块之外。并且以 static 修饰。</td>
</tr>
<tr>
<td>局部变量在方法、构造方法、或者语句块被执行的时候创建，当它们执行完成后，变量将会被销毁。</td>
<td>实例变量在对象创建的时候创建，在对象被销毁的时候销毁。</td>
<td>类变量在第一次被访问时创建，在程序结束时销毁。</td>
</tr>
<tr>
<td>局部变量没有默认值，所以必须经过初始化，才可以使用。</td>
<td>实例变量具有默认值。数值型变量的默认值是 0，布尔型变量的默认值是 false，引用类型变量的默认值是 null。变量的值可以在声明时指定，也可以在构造方法中指定。</td>
<td>类变量具有默认值。数值型变量的默认值是 0，布尔型变量的默认值是 false，引用类型变量的默认值是 null。变量的值可以在声明时指定，也可以在构造方法中指定。此外，静态变量还可以在静态语句块中初始化。</td>
</tr>
<tr>
<td>对于局部变量，如果是基本类型，会把值直接存储在栈；如果是引用类型，会把其对象存储在堆，而把这个对象的引用（指针）存储在栈。</td>
<td>实例变量存储在堆。</td>
<td>类变量存储在静态存储区。</td>
</tr>
<tr>
<td>访问修饰符不能用于局部变量。</td>
<td>访问修饰符可以用于实例变量。</td>
<td>访问修饰符可以用于类变量。</td>
</tr>
<tr>
<td>局部变量只在声明它的方法、构造方法或者语句块中可见。</td>
<td>实例变量对于类中的方法、构造方法或者语句块是可见的。一般情况下应该把实例变量设为私有。通过使用访问修饰符可以使实例变量对子类可见。</td>
<td>与实例变量具有相似的可见性。但为了对类的使用者可见，大多数静态变量声明为 public 类型。</td>
</tr>
<tr>
<td></td>
<td>实例变量可以直接通过变量名访问。但在静态方法以及其他类中，就应该使用完全限定名：ObejectReference.VariableName。</td>
<td>静态变量可以通过：ClassName.VariableName 的方式访问。</td>
</tr>
<tr>
<td></td>
<td></td>
<td>无论一个类创建了多少个对象，类只拥有类变量的一份拷贝。</td>
</tr>
<tr>
<td></td>
<td></td>
<td>类变量除了被声明为常量外很少使用。</td>
</tr>
</tbody>
</table>
<h3 id="-44"><a class="markdownIt-Anchor" href="#-44">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-oop.html#_4-1-%E5%8F%98%E9%87%8F%E4%BF%AE%E9%A5%B0%E7%AC%A6">#</a>4.1. 变量修饰符</h3>
<ul>
<li>访问级别修饰符 - 如果变量是实例变量或类变量，可以添加访问级别修饰符（public/protected/private）</li>
<li>静态修饰符 - 如果变量是类变量，需要添加 static 修饰</li>
<li>final - 如果变量使用 fianl 修饰符，就表示这是一个常量，不能被修改。</li>
</ul>
<h3 id="-45"><a class="markdownIt-Anchor" href="#-45">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-oop.html#_4-2-%E5%88%9B%E5%BB%BA%E5%AF%B9%E8%B1%A1">#</a>4.2. 创建对象</h3>
<p>对象是根据类创建的。在 Java 中，使用关键字 new 来创建一个新的对象。创建对象需要以下三步：</p>
<ul>
<li><strong>声明</strong>：声明一个对象，包括对象名称和对象类型。</li>
<li><strong>实例化</strong>：使用关键字 new 来创建一个对象。</li>
<li><strong>初始化</strong>：使用 new 创建对象时，会调用构造方法初始化对象。</li>
</ul>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">public class Puppy&#123;
   public Puppy(String name)&#123;
      //这个构造器仅有一个参数：name
      System.out.println("小狗的名字是 : " + name );
   &#125;
   public static void main(String[] args)&#123;
      // 下面的语句将创建一个Puppy对象
      Puppy myPuppy = new Puppy( "tommy" );
   &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-46"><a class="markdownIt-Anchor" href="#-46">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-oop.html#_4-3-%E8%AE%BF%E9%97%AE%E5%AE%9E%E4%BE%8B%E5%8F%98%E9%87%8F%E5%92%8C%E6%96%B9%E6%B3%95">#</a>4.3. 访问实例变量和方法</h3>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">/* 实例化对象 */
ObjectReference = new Constructor();
/* 访问类中的变量 */
ObjectReference.variableName;
/* 访问类中的方法 */
ObjectReference.methodName();<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="-47"><a class="markdownIt-Anchor" href="#-47">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-oop.html#_5-%E8%AE%BF%E9%97%AE%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6">#</a>5. 访问权限控制</h2>
<h3 id="-48"><a class="markdownIt-Anchor" href="#-48">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-oop.html#_5-1-%E4%BB%A3%E7%A0%81%E7%BB%84%E7%BB%87">#</a>5.1. 代码组织</h3>
<p><strong>当编译一个 .java 文件时，在 .java 文件中的每个类都会输出一个与类同名的 .class 文件。</strong></p>
<p>MultiClassDemo.java 示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">MultiClass1</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

<span class="token keyword">class</span> <span class="token class-name">MultiClass2</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

<span class="token keyword">class</span> <span class="token class-name">MultiClass3</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MultiClassDemo</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>执行  <code>javac MultiClassDemo.java</code>  命令，本地会生成 MultiClass1.class、MultiClass2.class、MultiClass3.class、MultiClassDemo.class 四个文件。</p>
<p><strong>Java 可运行程序是由一组 .class 文件打包并压缩成的一个 .jar 文件</strong>。Java 解释器负责这些文件的查找、装载和解释。<strong>Java 类库实际上是一组类文件（.java 文件）。</strong></p>
<ul>
<li><strong>其中每个文件允许有一个 public 类，以及任意数量的非 public 类</strong>。</li>
<li><strong>public 类名必须和 .java 文件名完全相同，包括大小写。</strong></li>
</ul>
<p>程序一般不止一个人编写，会调用系统提供的代码、第三方库中的代码、项目中其他人写的代码等，不同的人因为不同的目的可能定义同样的类名 / 接口名，这就是命名冲突。</p>
<p>Java 中为了解决命名冲突问题，提供了包（ <code>package</code> ）和导入（ <code>import</code> ）机制。</p>
<h4 id="-49"><a class="markdownIt-Anchor" href="#-49">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-oop.html#package">#</a>package</h4>
<p>包（ <code>package</code> ）的原则：</p>
<ul>
<li>包类似于文件夹，文件放在文件夹中，类和接口则放在包中。为了便于组织，文件夹一般是一个<strong>有层次的树形结构</strong>，包也类似。</li>
<li><strong>包名以逗号  <code>.</code>  分隔，表示层次结构。</strong></li>
<li>Java 中命名包名的一个惯例是使用域名作为前缀，因为域名是唯一的，一般按照域名的反序来定义包名，比如，域名是：<a target="_blank" rel="noopener" href="http://apache.org">apache.org</a>，包名就以 org.apache 开头。</li>
<li>** 包名和文件目录结构必须完全匹配。**Java 解释器运行过程如下：
<ul>
<li>找出环境变量 CLASSPATH，作为 .class 文件的根目录。</li>
<li>从根目录开始，获取包名称，并将逗号  <code>.</code>  替换为文件分隔符（反斜杠  <code>/</code> ），通过这个路径名称去查找 Java 类。</li>
</ul>
</li>
</ul>
<h4 id="-50"><a class="markdownIt-Anchor" href="#-50">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-oop.html#import">#</a>import</h4>
<p>同一个包下的类之间互相引用是不需要包名的，可以直接使用。但如果类不在同一个包内，则必须要知道其所在的包，使用有两种方式：</p>
<ul>
<li>通过类的完全限定名</li>
<li>通过 import 将用到的类引入到当前类</li>
</ul>
<p>通过类的完全限定名示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PackageDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> main <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span>args<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过  <code>import</code>  导入其它包的类到当前类：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Date</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PackageDemo2</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>说明：以上两个示例比较起来，显然是  <code>import</code>  方式，代码更加整洁。</p>
</blockquote>
<blockquote>
<p>扩展阅读：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/swiftma/p/5628762.html">https://www.cnblogs.com/swiftma/p/5628762.html</a></p>
</blockquote>
<h3 id="-51"><a class="markdownIt-Anchor" href="#-51">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-oop.html#_5-2-%E8%AE%BF%E9%97%AE%E6%9D%83%E9%99%90%E4%BF%AE%E9%A5%B0%E5%85%B3%E9%94%AE%E5%AD%97">#</a>5.2. 访问权限修饰关键字</h3>
<p>访问权限控制的等级，从最大权限到最小权限依次为：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">public > protected > 包访问权限（没有任何关键字）> private<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li><code>public</code>  - 表示任何类都可以访问；</li>
<li><code>包访问权限</code>  - 包访问权限，没有任何关键字。它表示当前包中的所有其他类都可以访问，但是其它包的类无法访问。</li>
<li><code>protected</code>  - 表示子类可以访问，此外，同一个包内的其他类也可以访问，即使这些类不是子类。</li>
<li><code>private</code>  - 表示其它任何类都无法访问。</li>
</ul>
<h2 id="-52"><a class="markdownIt-Anchor" href="#-52">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-oop.html#_6-%E6%8E%A5%E5%8F%A3">#</a>6. 接口</h2>
<p>接口是对行为的抽象，它是抽象方法的集合，利用接口可以达到 API 定义和实现分离的目的。</p>
<p>接口，不能实例化；不能包含任何非常量成员，任何 field 都是隐含着  <code>public static final</code>  的意义；同时，没有非静态方法实现，也就是说要么是抽象方法，要么是静态方法。</p>
<p>Java 标准类库中，定义了非常多的接口，比如  <code>java.util.List</code> 。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Comparable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">compareTo</span><span class="token punctuation">(</span><span class="token class-name">T</span> o<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h2 id="-53"><a class="markdownIt-Anchor" href="#-53">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-oop.html#_7-%E6%8A%BD%E8%B1%A1%E7%B1%BB">#</a>7. 抽象类</h2>
<p>抽象类是不能实例化的类，用  <code>abstract</code>  关键字修饰  <code>class</code> ，其目的主要是代码重用。除了不能实例化，形式上和一般的 Java 类并没有太大区别，可以有一个或者多个抽象方法，也可以没有抽象方法。抽象类大多用于抽取相关 Java 类的共用方法实现或者是共同成员变量，然后通过继承的方式达到代码复用的目的。</p>
<p>Java 标准库中，比如  <code>collection</code>  框架，很多通用部分就被抽取成为抽象类，例如  <code>java.util.AbstractList</code> 。</p>
<ol>
<li>抽象类不能被实例化 (初学者很容易犯的错)，如果被实例化，就会报错，编译无法通过。只有抽象类的非抽象子类可以创建对象。</li>
<li>抽象类中不一定包含抽象方法，但是有抽象方法的类必定是抽象类。</li>
<li>抽象类中的抽象方法只是声明，不包含方法体，就是不给出方法的具体实现也就是方法的具体功能。</li>
<li>构造方法，类方法（用 static 修饰的方法）不能声明为抽象方法。</li>
<li>抽象类的子类必须给出抽象类中的抽象方法的具体实现，除非该子类也是抽象类。</li>
</ol>
<hr>
<h1 id="深入理解-java-方法"><a class="markdownIt-Anchor" href="#深入理解-java-方法">#</a> 深入理解 Java 方法</h1>
<blockquote>
<p><strong>方法（有的人喜欢叫函数）是一段可重用的代码段。</strong></p>
<p><strong>📦 本文以及示例源码已归档在 <a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/">javacore(opens new window)</a></strong></p>
</blockquote>
<ul>
<li>\1. 方法的使用
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-method.html#11-%E6%96%B9%E6%B3%95%E5%AE%9A%E4%B9%89">1.1. 方法定义</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-method.html#12-%E6%96%B9%E6%B3%95%E7%9A%84%E8%B0%83%E7%94%A8">1.2. 方法的调用</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-method.html#2-%E6%96%B9%E6%B3%95%E5%8F%82%E6%95%B0">2. 方法参数</a></li>
<li>\3. 方法修饰符
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-method.html#31-%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6%E4%BF%AE%E9%A5%B0%E7%AC%A6">3.1. 访问控制修饰符</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-method.html#32-static">3.2. static</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-method.html#33-final">3.3. final</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-method.html#34-default">3.4. default</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-method.html#35-abstract">3.5. abstract</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-method.html#36-synchronized">3.6. synchronized</a></li>
</ul>
</li>
<li>\4. 特殊方法
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-method.html#41-main-%E6%96%B9%E6%B3%95">4.1. main 方法</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-method.html#42-%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95">4.2. 构造方法</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-method.html#43-%E5%8F%98%E5%8F%82%E6%96%B9%E6%B3%95">4.3. 变参方法</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-method.html#44-finalize-%E6%96%B9%E6%B3%95">4.4. finalize () 方法</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-method.html#5-%E8%A6%86%E5%86%99%E5%92%8C%E9%87%8D%E8%BD%BD">5. 覆写和重载</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-method.html#6-%E5%B0%8F%E7%BB%93">6. 小结</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-method.html#7-%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">7. 参考资料</a></li>
</ul>
<h2 id="-54"><a class="markdownIt-Anchor" href="#-54">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-method.html#_1-%E6%96%B9%E6%B3%95%E7%9A%84%E4%BD%BF%E7%94%A8">#</a>1. 方法的使用</h2>
<h3 id="-55"><a class="markdownIt-Anchor" href="#-55">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-method.html#_1-1-%E6%96%B9%E6%B3%95%E5%AE%9A%E4%B9%89">#</a>1.1. 方法定义</h3>
<p>方法定义语法格式：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">[修饰符] 返回值类型 方法名([参数类型 参数名])&#123;
    ...
    方法体
    ...
    return 返回值;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Hello World"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>方法包含一个方法头和一个方法体。下面是一个方法的所有部分：</p>
<ul>
<li><strong>修饰符</strong> - 修饰符是可选的，它告诉编译器如何调用该方法。定义了该方法的访问类型。</li>
<li><strong>返回值类型</strong> - 返回值类型表示方法执行结束后，返回结果的数据类型。如果没有返回值，应设为 void。</li>
<li><strong>方法名</strong> - 是方法的实际名称。方法名和参数表共同构成方法签名。</li>
<li><strong>参数类型</strong> - 参数像是一个占位符。当方法被调用时，传递值给参数。参数列表是指方法的参数类型、顺序和参数的个数。参数是可选的，方法可以不包含任何参数。</li>
<li><strong>方法体</strong> - 方法体包含具体的语句，定义该方法的功能。</li>
<li><strong>return</strong> - 必须返回声明方法时返回值类型相同的数据类型。在 void 方法中，return 语句可有可无，如果要写 return，则只能是  <code>return;</code>  这种形式。</li>
</ul>
<h3 id="-56"><a class="markdownIt-Anchor" href="#-56">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-method.html#_1-2-%E6%96%B9%E6%B3%95%E7%9A%84%E8%B0%83%E7%94%A8">#</a>1.2. 方法的调用</h3>
<p>当程序调用一个方法时，程序的控制权交给了被调用的方法。当被调用方法的返回语句执行或者到达方法体闭括号时候交还控制权给程序。</p>
<p>Java 支持两种调用方法的方式，根据方法是否有返回值来选择。</p>
<ul>
<li>有返回值方法 - 有返回值方法通常被用来给一个变量赋值或代入到运算表达式中进行计算。</li>
</ul>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">int larger = max(30, 40);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>无返回值方法 - 无返回值方法只能是一条语句。</li>
</ul>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">System.out.println("Hello World");<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="-57"><a class="markdownIt-Anchor" href="#-57">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-method.html#%E9%80%92%E5%BD%92%E8%B0%83%E7%94%A8">#</a>递归调用</h4>
<p>Java 支持方法的递归调用（即方法调用自身）。</p>
<blockquote>
<p>🔔 注意：</p>
<ul>
<li>递归方法必须有明确的结束条件。</li>
<li>尽量避免使用递归调用。因为递归调用如果处理不当，可能导致栈溢出。</li>
</ul>
</blockquote>
<p>斐波那契数列（一个典型的递归算法）示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RecursionMethodDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">fib</span><span class="token punctuation">(</span><span class="token keyword">int</span> num<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>num <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">||</span> num <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token function">fib</span><span class="token punctuation">(</span>num <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">fib</span><span class="token punctuation">(</span>num <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token function">fib</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="-58"><a class="markdownIt-Anchor" href="#-58">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-method.html#_2-%E6%96%B9%E6%B3%95%E5%8F%82%E6%95%B0">#</a>2. 方法参数</h2>
<p>在 C/C++ 等编程语言中，方法的参数传递一般有两种形式：</p>
<ul>
<li>值传递 - 值传递的参数被称为形参。值传递时，传入的参数，在方法中的修改，不会在方法外部生效。</li>
<li>引用传递 - 引用传递的参数被称为实参。引用传递时，传入的参数，在方法中的修改，会在方法外部生效。</li>
</ul>
<p>那么，Java 中是怎样的呢？</p>
<p><strong>Java 中只有值传递。</strong></p>
<p>示例一：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MethodParamDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">method</span><span class="token punctuation">(</span><span class="token keyword">int</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        value <span class="token operator">=</span>  value <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token function">method</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"num = ["</span> <span class="token operator">+</span> num <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">method</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"num = ["</span> <span class="token operator">+</span> num <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// Output:</span>
<span class="token comment">// num = [0]</span>
<span class="token comment">// num = [0]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>示例二：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MethodParamDemo2</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">method</span><span class="token punctuation">(</span><span class="token class-name">StringBuilder</span> sb<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token string">"B"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">StringBuilder</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"sb = ["</span> <span class="token operator">+</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">method</span><span class="token punctuation">(</span>sb<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"sb = ["</span> <span class="token operator">+</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token string">"C"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"sb = ["</span> <span class="token operator">+</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// Output:</span>
<span class="token comment">// sb = [A]</span>
<span class="token comment">// sb = [A]</span>
<span class="token comment">// sb = [C]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>说明：</p>
<p>以上两个示例，无论向方法中传入的是基础数据类型，还是引用类型，在方法中修改的值，在外部都未生效。</p>
<p>Java 对于基本数据类型，会直接拷贝值传递到方法中；对于引用数据类型，拷贝当前对象的引用地址，然后把该地址传递过去，所以也是值传递。</p>
<blockquote>
<p>扩展阅读：</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/24556934?refer=dreawer">图解 Java 中的参数传递 (opens new window)</a></p>
</blockquote>
<h2 id="-59"><a class="markdownIt-Anchor" href="#-59">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-method.html#_3-%E6%96%B9%E6%B3%95%E4%BF%AE%E9%A5%B0%E7%AC%A6">#</a>3. 方法修饰符</h2>
<p>前面提到了，Java 方法的修饰符是可选的，它告诉编译器如何调用该方法。定义了该方法的访问类型。</p>
<p>Java 方法有好几个修饰符，让我们一一来认识一下：</p>
<h3 id="-60"><a class="markdownIt-Anchor" href="#-60">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-method.html#_3-1-%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6%E4%BF%AE%E9%A5%B0%E7%AC%A6">#</a>3.1. 访问控制修饰符</h3>
<p>访问权限控制的等级，从最大权限到最小权限依次为：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">public > protected > 包访问权限（没有任何关键字）> private<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li><code>public</code>  - 表示任何类都可以访问；</li>
<li><code>包访问权限</code>  - 包访问权限，没有任何关键字。它表示当前包中的所有其他类都可以访问，但是其它包的类无法访问。</li>
<li><code>protected</code>  - 表示子类可以访问，此外，同一个包内的其他类也可以访问，即使这些类不是子类。</li>
<li><code>private</code>  - 表示其它任何类都无法访问。</li>
</ul>
<h3 id="-61"><a class="markdownIt-Anchor" href="#-61">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-method.html#_3-2-static">#</a>3.2. static</h3>
<p><strong>被  <code>static</code>  修饰的方法被称为静态方法。</strong></p>
<p>静态方法相比于普通的实例方法，主要有以下区别：</p>
<ul>
<li>在外部调用静态方法时，可以使用  <code>类名.方法名</code>  的方式，也可以使用  <code>对象名.方法名</code>  的方式。而实例方法只有后面这种方式。也就是说，<strong>调用静态方法可以无需创建对象</strong>。</li>
<li><strong>静态方法在访问本类的成员时，只允许访问静态成员</strong>（即静态成员变量和静态方法），而不允许访问实例成员变量和实例方法；实例方法则无此限制。</li>
</ul>
<p>静态方法常被用于各种工具类、工厂方法类。</p>
<h3 id="-62"><a class="markdownIt-Anchor" href="#-62">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-method.html#_3-3-final">#</a>3.3. final</h3>
<p>被  <code>final</code>  修饰的方法不能被子类覆写（Override）。</p>
<p>final 方法示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FinalMethodDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Father</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"call Father print()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Son</span> <span class="token keyword">extends</span> <span class="token class-name">Father</span> <span class="token punctuation">&#123;</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"call print()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Father</span> demo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Son</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        demo<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// 编译时会报错</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>说明：</p>
<p>上面示例中，父类 Father 中定义了一个  <code>final</code>  方法  <code>print()</code> ，则其子类不能 Override 这个 final 方法，否则会编译报错。</p>
</blockquote>
<h3 id="-63"><a class="markdownIt-Anchor" href="#-63">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-method.html#_3-4-default">#</a>3.4. default</h3>
<p>JDK8 开始，支持在接口  <code>Interface</code>  中定义  <code>default</code>  方法。<strong> <code>default</code>  方法只能出现在接口  <code>Interface</code>  中</strong>。</p>
<p><strong>接口中被  <code>default</code>  修饰的方法被称为默认方法，实现此接口的类如果没 Override 此方法，则直接继承这个方法，不再强制必须实现此方法。</strong></p>
<p>default 方法语法的出现，是为了既有的成千上万的 Java 类库的类增加新的功能， 且不必对这些类重新进行设计。 举例来说，JDK8 中  <code>Collection</code>  类中有一个非常方便的  <code>stream()</code>  方法，就是被修饰为  <code>default</code> ，Collection 的一大堆 List、Set 子类就直接继承了这个方法 I，不必再为每个子类都注意添加这个方法。</p>
<p><code>default</code>  方法示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultMethodDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">interface</span> <span class="token class-name">MyInterface</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">default</span> <span class="token keyword">void</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Hello World"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>


    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyClass</span> <span class="token keyword">implements</span> <span class="token class-name">MyInterface</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">MyInterface</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        obj<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// Output:</span>
<span class="token comment">// Hello World</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-64"><a class="markdownIt-Anchor" href="#-64">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-method.html#_3-5-abstract">#</a>3.5. abstract</h3>
<p><strong>被  <code>abstract</code>  修饰的方法被称为抽象方法，方法不能有实体。抽象方法只能出现抽象类中。</strong></p>
<p>抽象方法示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AbstractMethodDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">static</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractClass</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteClass</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractClass</span> <span class="token punctuation">&#123;</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">void</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"call print()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">AbstractClass</span> demo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcreteClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        demo<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span>
<span class="token comment">// Outpu:</span>
<span class="token comment">// call print()</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-65"><a class="markdownIt-Anchor" href="#-65">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-method.html#_3-6-synchronized">#</a>3.6. synchronized</h3>
<p><code>synchronized</code>  用于并发编程。<strong>被  <code>synchronized</code>  修饰的方法在一个时刻，只允许一个线程执行。</strong></p>
<p>在 Java 的同步容器（Vector、Stack、HashTable）中，你会见到大量的 synchronized 方法。不过，请记住：在 Java 并发编程中，synchronized 方法并不是一个好的选择，大多数情况下，我们会选择更加轻量级的锁 。</p>
<h2 id="-66"><a class="markdownIt-Anchor" href="#-66">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-method.html#_4-%E7%89%B9%E6%AE%8A%E6%96%B9%E6%B3%95">#</a>4. 特殊方法</h2>
<p>Java 中，有一些较为特殊的方法，分别使用于特殊的场景。</p>
<h3 id="-67"><a class="markdownIt-Anchor" href="#-67">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-method.html#_4-1-main-%E6%96%B9%E6%B3%95">#</a>4.1. main 方法</h3>
<p>Java 中的 main 方法是一种特殊的静态方法，因为所有的 Java 程序都是由  <code>public static void main(String[] args)</code>  方法开始执行。</p>
<p>有很多新手虽然一直用 main 方法，却不知道 main 方法中的 args 有什么用。实际上，这是用来接收接收命令行输入参数的。</p>
<p>示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainMethodDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> arg <span class="token operator">:</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"arg = ["</span> <span class="token operator">+</span> arg <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>依次执行</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">javac MainMethodDemo.java
java MainMethodDemo A B C<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>控制台会打印输出参数：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">arg = [A]
arg = [B]
arg = [C]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="-68"><a class="markdownIt-Anchor" href="#-68">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-method.html#_4-2-%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95">#</a>4.2. 构造方法</h3>
<p>任何类都有构造方法，构造方法的作用就是在初始化类实例时，设置实例的状态。</p>
<p>每个类都有构造方法。如果没有显式地为类定义任何构造方法，Java 编译器将会为该类提供一个默认构造方法。</p>
<p>在创建一个对象的时候，至少要调用一个构造方法。构造方法的名称必须与类同名，一个类可以有多个构造方法。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConstructorMethodDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> name<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setName</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Person</span> person <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">"jack"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"person name is "</span> <span class="token operator">+</span> person<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意，构造方法除了使用 public，也可以使用 private 修饰，这种情况下，类无法调用此构造方法去实例化对象，这常常用于设计模式中的单例模式。</p>
<h3 id="-69"><a class="markdownIt-Anchor" href="#-69">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-method.html#_4-3-%E5%8F%98%E5%8F%82%E6%96%B9%E6%B3%95">#</a>4.3. 变参方法</h3>
<p>JDK5 开始，Java 支持传递同类型的可变参数给一个方法。在方法声明中，在指定参数类型后加一个省略号  <code>...</code> 。一个方法中只能指定一个可变参数，它必须是方法的最后一个参数。任何普通的参数必须在它之前声明。</p>
<p>变参方法示例：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">public class VarargsDemo &#123;
    public static void method(String... params) &#123;
        System.out.println("params.length = " + params.length);
        for (String param : params) &#123;
            System.out.println("params = [" + param + "]");
        &#125;
    &#125;

    public static void main(String[] args) &#123;
        method("red");
        method("red", "yellow");
        method("red", "yellow", "blue");
    &#125;
&#125;
// Output:
// params.length = 1
// params = [red]
// params.length = 2
// params = [red]
// params = [yellow]
// params.length = 3
// params = [red]
// params = [yellow]
// params = [blue]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-70"><a class="markdownIt-Anchor" href="#-70">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-method.html#_4-4-finalize-%E6%96%B9%E6%B3%95">#</a>4.4. finalize () 方法</h3>
<p><code>finalize</code>  在对象被垃圾收集器析构 (回收) 之前调用，用来清除回收对象。</p>
<p><code>finalize</code>  是在  <code>java.lang.Object</code>  里定义的，也就是说每一个对象都有这么个方法。这个方法在 GC 启动，该对象被回收的时候被调用。</p>
<p>finalizer () 通常是不可预测的，也是很危险的，一般情况下是不必要的。使用终结方法会导致行为不稳定、降低性能，以及可移植性问题。</p>
<p><strong>请记住：应该尽量避免使用  <code>finalizer()</code> </strong>。千万不要把它当成是 C/C++ 中的析构函数来用。原因是：<strong>Finalizer 线程会和我们的主线程进行竞争，不过由于它的优先级较低，获取到的 CPU 时间较少，因此它永远也赶不上主线程的步伐。所以最后可能会发生 OutOfMemoryError 异常。</strong></p>
<blockquote>
<p>扩展阅读：</p>
<p>下面两篇文章比较详细的讲述了 finalizer () 可能会造成的问题及原因。</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://www.cnblogs.com/benwu/articles/5812903.html">Java 的 Finalizer 引发的内存溢出 (opens new window)</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/27850176">重载 Finalize 引发的内存泄露 (opens new window)</a></li>
</ul>
</blockquote>
<h2 id="-71"><a class="markdownIt-Anchor" href="#-71">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-method.html#_5-%E8%A6%86%E5%86%99%E5%92%8C%E9%87%8D%E8%BD%BD">#</a>5. 覆写和重载</h2>
<p><strong>覆写（Override）是指子类定义了与父类中同名的方法，但是在方法覆写时必须考虑到访问权限，子类覆写的方法不能拥有比父类更加严格的访问权限。</strong></p>
<p>子类要覆写的方法如果要访问父类的方法，可以使用  <code>super</code>  关键字。</p>
<p>覆写示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MethodOverrideDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Animal</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">move</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"会动"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Dog</span> <span class="token keyword">extends</span> <span class="token class-name">Animal</span> <span class="token punctuation">&#123;</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">move</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">move</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"会跑"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Animal</span> dog <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dog<span class="token punctuation">.</span><span class="token function">move</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// Output:</span>
<span class="token comment">// 会动</span>
<span class="token comment">// 会跑</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>方法的重载（Overload）是指方法名称相同，但参数的类型或参数的个数不同。通过传递参数的个数及类型的不同可以完成不同功能的方法调用。</strong></p>
<blockquote>
<p>🔔 注意：</p>
<p>重载一定是方法的参数不完全相同。如果方法的参数完全相同，仅仅是返回值不同，Java 是无法编译通过的。</p>
</blockquote>
<p>重载示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MethodOverloadDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"x + y = "</span> <span class="token operator">+</span> <span class="token punctuation">(</span>x <span class="token operator">+</span> y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">double</span> x<span class="token punctuation">,</span> <span class="token keyword">double</span> y<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"x + y = "</span> <span class="token operator">+</span> <span class="token punctuation">(</span>x <span class="token operator">+</span> y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">add</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// Output:</span>
<span class="token comment">// x + y = 30</span>
<span class="token comment">// x + y = 3.0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="-72"><a class="markdownIt-Anchor" href="#-72">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-method.html#_6-%E5%B0%8F%E7%BB%93">#</a>6. 小结</h2>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/1553767582595.png" alt="img"></p>
<hr>
<h1 id="深入理解-java-数组"><a class="markdownIt-Anchor" href="#深入理解-java-数组">#</a> 深入理解 Java 数组</h1>
<blockquote>
<p><strong>📦 本文以及示例源码已归档在 <a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/">javacore(opens new window)</a></strong></p>
</blockquote>
<ul>
<li>\1. 简介
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-array.html#11-%E6%95%B0%E7%BB%84%E7%9A%84%E7%89%B9%E6%80%A7">1.1. 数组的特性</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-array.html#12-%E6%95%B0%E7%BB%84%E5%92%8C%E5%AE%B9%E5%99%A8">1.2. 数组和容器</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-array.html#13-java-%E6%95%B0%E7%BB%84%E7%9A%84%E6%9C%AC%E8%B4%A8%E6%98%AF%E5%AF%B9%E8%B1%A1">1.3. Java 数组的本质是对象</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-array.html#14-java-%E6%95%B0%E7%BB%84%E5%92%8C%E5%86%85%E5%AD%98">1.4. Java 数组和内存</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-array.html#2-%E5%A3%B0%E6%98%8E%E6%95%B0%E7%BB%84">2. 声明数组</a></li>
<li>\3. 创建数组
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-array.html#31-%E6%95%B0%E7%BB%84%E7%BB%B4%E5%BA%A6%E7%9A%84%E5%BD%A2%E5%BC%8F">3.1. 数组维度的形式</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-array.html#32-%E6%95%B0%E7%BB%84%E7%BB%B4%E5%BA%A6%E7%9A%84%E5%A4%A7%E5%B0%8F">3.2. 数组维度的大小</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-array.html#4-%E8%AE%BF%E9%97%AE%E6%95%B0%E7%BB%84">4. 访问数组</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-array.html#5-%E6%95%B0%E7%BB%84%E7%9A%84%E5%BC%95%E7%94%A8">5. 数组的引用</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-array.html#6-%E6%B3%9B%E5%9E%8B%E5%92%8C%E6%95%B0%E7%BB%84">6. 泛型和数组</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-array.html#7-%E5%A4%9A%E7%BB%B4%E6%95%B0%E7%BB%84">7. 多维数组</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-array.html#8-arrays-%E7%B1%BB">8. Arrays 类</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-array.html#9-%E5%B0%8F%E7%BB%93">9. 小结</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-array.html#10-%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">10. 参考资料</a></li>
</ul>
<h2 id="-73"><a class="markdownIt-Anchor" href="#-73">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-array.html#_1-%E7%AE%80%E4%BB%8B">#</a>1. 简介</h2>
<h3 id="-74"><a class="markdownIt-Anchor" href="#-74">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-array.html#_1-1-%E6%95%B0%E7%BB%84%E7%9A%84%E7%89%B9%E6%80%A7">#</a>1.1. 数组的特性</h3>
<p>数组对于每一门编程语言来说都是重要的数据结构之一，当然不同语言对数组的实现及处理也不尽相同。几乎所有程序设计语言都支持数组。</p>
<p>数组代表一系列对象或者基本数据类型，所有相同的类型都封装到一起，采用一个统一的标识符名称。</p>
<p><strong>数组的定义和使用需要通过方括号  <code>[]</code> 。</strong></p>
<blockquote>
<p><strong>Java 中，数组是一种引用类型。</strong></p>
<p><strong>Java 中，数组是用来存储固定大小的同类型元素。</strong></p>
</blockquote>
<h3 id="-75"><a class="markdownIt-Anchor" href="#-75">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-array.html#_1-2-%E6%95%B0%E7%BB%84%E5%92%8C%E5%AE%B9%E5%99%A8">#</a>1.2. 数组和容器</h3>
<p>Java 中，既然有了强大的容器，是不是就不需要数组了？</p>
<p>答案是不。</p>
<p>诚然，大多数情况下，应该选择容器存储数据。</p>
<p>但是，数组也不是毫无是处：</p>
<ul>
<li>Java 中，数组是一种效率最高的存储和随机访问对象引用序列的方式。<strong>数组的效率要高于容器</strong>（如  <code>ArrayList</code> ）。</li>
<li><strong>数组可以持有值类型，而容器则不能</strong>（这时，就必须用到包装类）。</li>
</ul>
<h3 id="-76"><a class="markdownIt-Anchor" href="#-76">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-array.html#_1-3-java-%E6%95%B0%E7%BB%84%E7%9A%84%E6%9C%AC%E8%B4%A8%E6%98%AF%E5%AF%B9%E8%B1%A1">#</a>1.3. Java 数组的本质是对象</h3>
<p><strong>Java 数组的本质是对象</strong>。它具有 Java 中其他对象的一些基本特点：封装了一些数据，可以访问属性，也可以调用方法。所以，数组是对象。</p>
<p>如果有两个类 A 和 B，如果 B 继承（extends）了 A，那么 A [] 类型的引用就可以指向 B [] 类型的对象。</p>
<blockquote>
<p>扩展阅读：<a target="_blank" rel="noopener" href="https://blog.csdn.net/zhangjg_blog/article/details/16116613#t1">Java 中数组的特性 (opens new window)</a></p>
<p>如果想要论证 <strong>Java 数组本质是对象</strong>，不妨一读这篇文章。</p>
</blockquote>
<h3 id="-77"><a class="markdownIt-Anchor" href="#-77">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-array.html#_1-4-java-%E6%95%B0%E7%BB%84%E5%92%8C%E5%86%85%E5%AD%98">#</a>1.4. Java 数组和内存</h3>
<p>Java 数组在内存中的存储是这样的：</p>
<p>数组对象（这里可以看成一个指针）存储在栈中。</p>
<p>数组元素存储在堆中。</p>
<p>如下图所示：只有当 JVM 执行  <code>new String[]</code>  时，才会在堆中开辟相应的内存区域。数组对象 array 可以视为一个指针，指向这块内存的存储地址。</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/1552473482942.png" alt="img"></p>
<h2 id="-78"><a class="markdownIt-Anchor" href="#-78">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-array.html#_2-%E5%A3%B0%E6%98%8E%E6%95%B0%E7%BB%84">#</a>2. 声明数组</h2>
<p>声明数组变量的语法如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr1<span class="token punctuation">;</span> <span class="token comment">// 推荐风格</span>
<span class="token keyword">int</span> arr2<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 效果相同</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h2 id="-79"><a class="markdownIt-Anchor" href="#-79">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-array.html#_3-%E5%88%9B%E5%BB%BA%E6%95%B0%E7%BB%84">#</a>3. 创建数组</h2>
<p>Java 语言使用  <code>new</code>  操作符来创建数组。有两种创建数组方式：</p>
<ul>
<li>指定数组维度
<ul>
<li>为数组开辟指定大小的数组维度。</li>
<li>如果数组元素是基础数据类型，会将每个元素设为默认值；如果是引用类型，元素值为  <code>null</code> 。</li>
</ul>
</li>
<li>不指定数组维度
<ul>
<li>用花括号中的实际元素初始化数组，数组大小与元素数相同。</li>
</ul>
</li>
</ul>
<p>示例 1：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ArrayDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 指定数组维度</span>
        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// 不指定数组维度</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"array1 size is "</span> <span class="token operator">+</span> array1<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> item <span class="token operator">:</span> array1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"array2 size is "</span> <span class="token operator">+</span> array1<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> item <span class="token operator">:</span> array2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// Output:</span>
<span class="token comment">// array1 size is 2</span>
<span class="token comment">// 0</span>
<span class="token comment">// 0</span>
<span class="token comment">// array2 size is 2</span>
<span class="token comment">// 1</span>
<span class="token comment">// 2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>💡 <strong>说明</strong> 请注意数组 array1 中的元素虽然没有初始化，但是 length 和指定的数组维度是一样的。这表明<strong>指定数组维度后，无论后面是否初始化数组中的元素，数组都已经开辟了相应的内存</strong>。</p>
<p>数组 array1 中的元素都被设为默认值。</p>
</blockquote>
<p>示例 2：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ArrayDemo2</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">User</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 指定数组维度</span>
        <span class="token class-name">User</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// 不指定数组维度</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"array1: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">User</span> item <span class="token operator">:</span> array1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"array2: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">User</span> item <span class="token operator">:</span> array2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// Output:</span>
<span class="token comment">// array1:</span>
<span class="token comment">// null</span>
<span class="token comment">// null</span>
<span class="token comment">// array2:</span>
<span class="token comment">// io.github.dunwu.javacore.array.ArrayDemo2$User@4141d797</span>
<span class="token comment">// io.github.dunwu.javacore.array.ArrayDemo2$User@68f7aae2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>💡 <strong>说明</strong></p>
<p>请将本例与示例 1 比较，可以发现：如果使用指定数组维度方式创建数组，且数组元素为引用类型，则数组中的元素元素值为  <code>null</code> 。</p>
</blockquote>
<h3 id="-80"><a class="markdownIt-Anchor" href="#-80">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-array.html#_3-1-%E6%95%B0%E7%BB%84%E7%BB%B4%E5%BA%A6%E7%9A%84%E5%BD%A2%E5%BC%8F">#</a>3.1. 数组维度的形式</h3>
<p>创建数组时，指定的数组维度可以有多种形式：</p>
<ul>
<li>数组维度可以是整数、字符。</li>
<li>数组维度可以是整数型、字符型变量。</li>
<li>数组维度可以是计算结果为整数或字符的表达式。</li>
</ul>
<p>示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ArrayDemo3</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> length <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
        <span class="token comment">// 放开被注掉的代码，编译器会报错</span>
        <span class="token comment">// int[] array = new int[4.0];</span>
        <span class="token comment">// int[] array2 = new int["test"];</span>
        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array4 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array5 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span>length <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array6 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token string">'a'</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">// int[] array7 = new int[length + 2.1];</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"array3.length = ["</span> <span class="token operator">+</span> array3<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"array4.length = ["</span> <span class="token operator">+</span> array4<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"array5.length = ["</span> <span class="token operator">+</span> array5<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"array6.length = ["</span> <span class="token operator">+</span> array6<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// Output:</span>
<span class="token comment">// array3.length = [97]</span>
<span class="token comment">// array4.length = [3]</span>
<span class="token comment">// array5.length = [5]</span>
<span class="token comment">// array6.length = [99]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>💡 <strong>说明</strong></p>
<p>当指定的数组维度是字符时，Java 会将其转为整数。如字符  <code>a</code>  的 ASCII 码是 97。</p>
<p>综上，<strong>Java 数组的数组维度可以是常量、变量、表达式，只要转换为整数即可</strong>。</p>
<p>请留意，有些编程语言则不支持这点，如 C/C++ 语言，只允许数组维度是常量。</p>
</blockquote>
<h3 id="-81"><a class="markdownIt-Anchor" href="#-81">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-array.html#_3-2-%E6%95%B0%E7%BB%84%E7%BB%B4%E5%BA%A6%E7%9A%84%E5%A4%A7%E5%B0%8F">#</a>3.2. 数组维度的大小</h3>
<p><strong>数组维度并非没有上限的，如果数值过大，编译时会报错。</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token number">6553612431</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 数组维度过大，编译报错</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>此外，<strong>数组过大，可能会导致栈溢出</strong>。</p>
<h2 id="-82"><a class="markdownIt-Anchor" href="#-82">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-array.html#_4-%E8%AE%BF%E9%97%AE%E6%95%B0%E7%BB%84">#</a>4. 访问数组</h2>
<p><strong>Java 中，可以通过在  <code>[]</code>  中指定下标，访问数组元素，下标位置从 0 开始。</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ArrayDemo4</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> array<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            array<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"array[%d] = %d"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> array<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// Output:</span>
<span class="token comment">// array[0] = 2</span>
<span class="token comment">// array[1] = 3</span>
<span class="token comment">// array[2] = 4</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>💡 <strong>说明</strong></p>
<p>上面的示例中，从 0 开始，使用下标遍历数组 array 的所有元素，为每个元素值加 1 。</p>
</blockquote>
<h2 id="-83"><a class="markdownIt-Anchor" href="#-83">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-array.html#_5-%E6%95%B0%E7%BB%84%E7%9A%84%E5%BC%95%E7%94%A8">#</a>5. 数组的引用</h2>
<p><strong>Java 中，数组类型是一种引用类型</strong>。</p>
<p>因此，它可以作为引用，被 Java 函数<strong>作为函数入参或返回值</strong>。</p>
<p>数组作为函数入参的示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ArrayRefDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">fun</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">:</span> array<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token string">"\t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token function">fun</span><span class="token punctuation">(</span>array<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// Output:</span>
<span class="token comment">// 1	3	5</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>数组作为函数返回值的示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ArrayRefDemo2</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">/**
     * 返回一个数组
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array <span class="token operator">=</span> <span class="token function">fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>array<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// Output:</span>
<span class="token comment">// [1, 3, 5]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="-84"><a class="markdownIt-Anchor" href="#-84">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-array.html#_6-%E6%B3%9B%E5%9E%8B%E5%92%8C%E6%95%B0%E7%BB%84">#</a>6. 泛型和数组</h2>
<p>通常，数组和泛型不能很好地结合。你不能实例化具有参数化类型的数组。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Peel</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Banana</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> peels <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Pell</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Banana</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 这行代码非法</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Java 中不允许直接创建泛型数组。但是，可以通过创建一个类型擦除的数组，然后转型的方式来创建泛型数组。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GenericArrayDemo</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">GenericArray</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">private</span> <span class="token class-name">T</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">GenericArray</span><span class="token punctuation">(</span><span class="token keyword">int</span> num<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            array <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span>num<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token keyword">int</span> index<span class="token punctuation">,</span> <span class="token class-name">T</span> item<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            array<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> item<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">int</span> index<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> array<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token class-name">T</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> array<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>



    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">GenericArray</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> genericArray <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GenericArray</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        genericArray<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        genericArray<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array <span class="token operator">=</span> genericArray<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">deepToString</span><span class="token punctuation">(</span>array<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// Output:</span>
<span class="token comment">// [0, 1, null, null]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>扩展阅读：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/jiangzhaowei/p/7399522.html">https://www.cnblogs.com/jiangzhaowei/p/7399522.html</a></p>
<p>我认为，对于泛型数组的理解，点到为止即可。实际上，真的需要存储泛型，还是使用容器更合适。</p>
</blockquote>
<h2 id="-85"><a class="markdownIt-Anchor" href="#-85">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-array.html#_7-%E5%A4%9A%E7%BB%B4%E6%95%B0%E7%BB%84">#</a>7. 多维数组</h2>
<p>多维数组可以看成是数组的数组，比如二维数组就是一个特殊的一维数组，其每一个元素都是一个一维数组。</p>
<p>Java 可以支持二维数组、三维数组、四维数组、五维数组。。。</p>
<p>但是，以正常人的理解能力，一般也就最多能理解三维数组。所以，请不要做反人类的事，去定义过多维度的数组。</p>
<p>多维数组使用示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MultiArrayDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Integer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> a1 <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 自动装箱</span>
            <span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            <span class="token punctuation">&#123;</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token class-name">Double</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> a2 <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 自动装箱</span>
            <span class="token punctuation">&#123;</span> <span class="token punctuation">&#123;</span><span class="token number">1.1</span><span class="token punctuation">,</span> <span class="token number">2.2</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token number">3.3</span><span class="token punctuation">,</span> <span class="token number">4.4</span><span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            <span class="token punctuation">&#123;</span> <span class="token punctuation">&#123;</span><span class="token number">5.5</span><span class="token punctuation">,</span> <span class="token number">6.6</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token number">7.7</span><span class="token punctuation">,</span> <span class="token number">8.8</span><span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            <span class="token punctuation">&#123;</span> <span class="token punctuation">&#123;</span><span class="token number">9.9</span><span class="token punctuation">,</span> <span class="token number">1.2</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token number">2.3</span><span class="token punctuation">,</span> <span class="token number">3.4</span><span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> a3 <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
            <span class="token punctuation">&#123;</span><span class="token string">"The"</span><span class="token punctuation">,</span> <span class="token string">"Quick"</span><span class="token punctuation">,</span> <span class="token string">"Sly"</span><span class="token punctuation">,</span> <span class="token string">"Fox"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            <span class="token punctuation">&#123;</span><span class="token string">"Jumped"</span><span class="token punctuation">,</span> <span class="token string">"Over"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            <span class="token punctuation">&#123;</span><span class="token string">"The"</span><span class="token punctuation">,</span> <span class="token string">"Lazy"</span><span class="token punctuation">,</span> <span class="token string">"Brown"</span><span class="token punctuation">,</span> <span class="token string">"Dog"</span><span class="token punctuation">,</span> <span class="token string">"and"</span><span class="token punctuation">,</span> <span class="token string">"friend"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"a1: "</span> <span class="token operator">+</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">deepToString</span><span class="token punctuation">(</span>a1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"a2: "</span> <span class="token operator">+</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">deepToString</span><span class="token punctuation">(</span>a2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"a3: "</span> <span class="token operator">+</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">deepToString</span><span class="token punctuation">(</span>a3<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// Output:</span>
<span class="token comment">// a1: [[1, 2, 3], [4, 5, 6]]</span>
<span class="token comment">// a2: [[[1.1, 2.2], [3.3, 4.4]], [[5.5, 6.6], [7.7, 8.8]], [[9.9, 1.2], [2.3, 3.4]]]</span>
<span class="token comment">// a3: [[The, Quick, Sly, Fox], [Jumped, Over], [The, Lazy, Brown, Dog, and, friend]]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="-86"><a class="markdownIt-Anchor" href="#-86">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-array.html#_8-arrays-%E7%B1%BB">#</a>8. Arrays 类</h2>
<p>Java 中，提供了一个很有用的数组工具类：Arrays。</p>
<p>它提供的主要操作有：</p>
<ul>
<li><code>sort</code>  - 排序</li>
<li><code>binarySearch</code>  - 查找</li>
<li><code>equals</code>  - 比较</li>
<li><code>fill</code>  - 填充</li>
<li><code>asList</code>  - 转列表</li>
<li><code>hash</code>  - 哈希</li>
<li><code>toString</code>  - 转字符串</li>
</ul>
<blockquote>
<p>扩展阅读：<a target="_blank" rel="noopener" href="https://juejin.im/post/5a6ade5c518825733e60acb8">https://juejin.im/post/5a6ade5c518825733e60acb8</a></p>
</blockquote>
<h2 id="-87"><a class="markdownIt-Anchor" href="#-87">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-array.html#_9-%E5%B0%8F%E7%BB%93">#</a>9. 小结</h2>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/1553753908349.png" alt="img"></p>
<hr>
<h1 id="深入理解-java-枚举"><a class="markdownIt-Anchor" href="#深入理解-java-枚举">#</a> 深入理解 Java 枚举</h1>
<blockquote>
<p><strong>📦 本文以及示例源码已归档在 <a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/">javacore(opens new window)</a></strong></p>
</blockquote>
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-enum.html#1-%E7%AE%80%E4%BB%8B">1. 简介</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-enum.html#2-%E6%9E%9A%E4%B8%BE%E7%9A%84%E6%9C%AC%E8%B4%A8">2. 枚举的本质</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-enum.html#3-%E6%9E%9A%E4%B8%BE%E7%9A%84%E6%96%B9%E6%B3%95">3. 枚举的方法</a></li>
<li>\4. 枚举的特性
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-enum.html#41-%E5%9F%BA%E6%9C%AC%E7%89%B9%E6%80%A7">4.1. 基本特性</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-enum.html#42-%E6%9E%9A%E4%B8%BE%E5%8F%AF%E4%BB%A5%E6%B7%BB%E5%8A%A0%E6%96%B9%E6%B3%95">4.2. 枚举可以添加方法</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-enum.html#43-%E6%9E%9A%E4%B8%BE%E5%8F%AF%E4%BB%A5%E5%AE%9E%E7%8E%B0%E6%8E%A5%E5%8F%A3">4.3. 枚举可以实现接口</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-enum.html#44-%E6%9E%9A%E4%B8%BE%E4%B8%8D%E5%8F%AF%E4%BB%A5%E7%BB%A7%E6%89%BF">4.4. 枚举不可以继承</a></li>
</ul>
</li>
<li>\5. 枚举的应用
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-enum.html#51-%E7%BB%84%E7%BB%87%E5%B8%B8%E9%87%8F">5.1. 组织常量</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-enum.html#52-switch-%E7%8A%B6%E6%80%81%E6%9C%BA">5.2. switch 状态机</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-enum.html#53-%E9%94%99%E8%AF%AF%E7%A0%81">5.3. 错误码</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-enum.html#54-%E7%BB%84%E7%BB%87%E6%9E%9A%E4%B8%BE">5.4. 组织枚举</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-enum.html#55-%E7%AD%96%E7%95%A5%E6%9E%9A%E4%B8%BE">5.5. 策略枚举</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-enum.html#56-%E6%9E%9A%E4%B8%BE%E5%AE%9E%E7%8E%B0%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F">5.6. 枚举实现单例模式</a></li>
</ul>
</li>
<li>\6. 枚举工具类
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-enum.html#61-enumset">6.1. EnumSet</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-enum.html#62-enummap">6.2. EnumMap</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-enum.html#7-%E5%B0%8F%E7%BB%93">7. 小结</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-enum.html#8-%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">8. 参考资料</a></li>
</ul>
<h2 id="-88"><a class="markdownIt-Anchor" href="#-88">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-enum.html#_1-%E7%AE%80%E4%BB%8B">#</a>1. 简介</h2>
<p><code>enum</code>  的全称为 enumeration， 是 JDK5 中引入的特性。</p>
<p>在 Java 中，被  <code>enum</code>  关键字修饰的类型就是枚举类型。形式如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">enum</span> <span class="token class-name">ColorEn</span> <span class="token punctuation">&#123;</span> RED<span class="token punctuation">,</span> GREEN<span class="token punctuation">,</span> BLUE <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><strong>枚举的好处</strong>：可以将常量组织起来，统一进行管理。</p>
<p><strong>枚举的典型应用场景</strong>：错误码、状态机等。</p>
<h2 id="-89"><a class="markdownIt-Anchor" href="#-89">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-enum.html#_2-%E6%9E%9A%E4%B8%BE%E7%9A%84%E6%9C%AC%E8%B4%A8">#</a>2. 枚举的本质</h2>
<p><code>java.lang.Enum</code>  类声明</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Enum</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span> <span class="token keyword">extends</span> <span class="token class-name">Enum</span><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span><span class="token punctuation">></span></span>
        <span class="token keyword">implements</span> <span class="token class-name">Comparable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span><span class="token punctuation">,</span> <span class="token class-name">Serializable</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>新建一个 ColorEn.java 文件，内容如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">io<span class="token punctuation">.</span>github<span class="token punctuation">.</span>dunwu<span class="token punctuation">.</span>javacore<span class="token punctuation">.</span>enumeration</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">ColorEn</span> <span class="token punctuation">&#123;</span>
    RED<span class="token punctuation">,</span>YELLOW<span class="token punctuation">,</span>BLUE
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>执行  <code>javac ColorEn.java</code>  命令，生成 ColorEn.class 文件。</p>
<p>然后执行  <code>javap ColorEn.class</code>  命令，输出如下内容：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Compiled</span> from <span class="token string">"ColorEn.java"</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token namespace">io<span class="token punctuation">.</span>github<span class="token punctuation">.</span>dunwu<span class="token punctuation">.</span>javacore<span class="token punctuation">.</span>enumeration<span class="token punctuation">.</span></span>ColorEn</span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Enum</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name"><span class="token namespace">io<span class="token punctuation">.</span>github<span class="token punctuation">.</span>dunwu<span class="token punctuation">.</span>javacore<span class="token punctuation">.</span>enumeration<span class="token punctuation">.</span></span>ColorEn</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name"><span class="token namespace">io<span class="token punctuation">.</span>github<span class="token punctuation">.</span>dunwu<span class="token punctuation">.</span>javacore<span class="token punctuation">.</span>enumeration<span class="token punctuation">.</span></span>ColorEn</span> RED<span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name"><span class="token namespace">io<span class="token punctuation">.</span>github<span class="token punctuation">.</span>dunwu<span class="token punctuation">.</span>javacore<span class="token punctuation">.</span>enumeration<span class="token punctuation">.</span></span>ColorEn</span> YELLOW<span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name"><span class="token namespace">io<span class="token punctuation">.</span>github<span class="token punctuation">.</span>dunwu<span class="token punctuation">.</span>javacore<span class="token punctuation">.</span>enumeration<span class="token punctuation">.</span></span>ColorEn</span> BLUE<span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name"><span class="token namespace">io<span class="token punctuation">.</span>github<span class="token punctuation">.</span>dunwu<span class="token punctuation">.</span>javacore<span class="token punctuation">.</span>enumeration<span class="token punctuation">.</span></span>ColorEn</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name"><span class="token namespace">io<span class="token punctuation">.</span>github<span class="token punctuation">.</span>dunwu<span class="token punctuation">.</span>javacore<span class="token punctuation">.</span>enumeration<span class="token punctuation">.</span></span>ColorEn</span> <span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>String</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>💡 说明：</p>
<p>从上面的例子可以看出：</p>
<p><strong>枚举的本质是  <code>java.lang.Enum</code>  的子类。</strong></p>
<p>尽管  <code>enum</code>  看起来像是一种新的数据类型，事实上，<strong>enum 是一种受限制的类，并且具有自己的方法</strong>。枚举这种特殊的类因为被修饰为  <code>final</code> ，所以不能继承其他类。</p>
<p>定义的枚举值，会被默认修饰为  <code>public static final</code>  ，从修饰关键字，即可看出枚举值本质上是静态常量。</p>
</blockquote>
<h2 id="-90"><a class="markdownIt-Anchor" href="#-90">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-enum.html#_3-%E6%9E%9A%E4%B8%BE%E7%9A%84%E6%96%B9%E6%B3%95">#</a>3. 枚举的方法</h2>
<p>在 enum 中，提供了一些基本方法：</p>
<ul>
<li><code>values()</code> ：返回 enum 实例的数组，而且该数组中的元素严格保持在 enum 中声明时的顺序。</li>
<li><code>name()</code> ：返回实例名。</li>
<li><code>ordinal()</code> ：返回实例声明时的次序，从 0 开始。</li>
<li><code>getDeclaringClass()</code> ：返回实例所属的 enum 类型。</li>
<li><code>equals()</code>  ：判断是否为同一个对象。</li>
</ul>
<p>可以使用  <code>==</code>  来比较 <code>enum</code>  实例。</p>
<p>此外， <code>java.lang.Enum</code>  实现了 <code>Comparable</code>  和  <code>Serializable</code>  接口，所以也提供  <code>compareTo()</code>  方法。</p>
<p><strong>例：展示 enum 的基本方法</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EnumMethodDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">enum</span> <span class="token class-name">Color</span> <span class="token punctuation">&#123;</span>RED<span class="token punctuation">,</span> GREEN<span class="token punctuation">,</span> BLUE<span class="token punctuation">;</span><span class="token punctuation">&#125;</span>
    <span class="token keyword">enum</span> <span class="token class-name">Size</span> <span class="token punctuation">&#123;</span>BIG<span class="token punctuation">,</span> MIDDLE<span class="token punctuation">,</span> SMALL<span class="token punctuation">;</span><span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span> args<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"=========== Print all Color ==========="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Color</span> c <span class="token operator">:</span> <span class="token class-name">Color</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>c <span class="token operator">+</span> <span class="token string">" ordinal: "</span> <span class="token operator">+</span> c<span class="token punctuation">.</span><span class="token function">ordinal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"=========== Print all Size ==========="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Size</span> s <span class="token operator">:</span> <span class="token class-name">Size</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s <span class="token operator">+</span> <span class="token string">" ordinal: "</span> <span class="token operator">+</span> s<span class="token punctuation">.</span><span class="token function">ordinal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token class-name">Color</span> green <span class="token operator">=</span> <span class="token class-name">Color</span><span class="token punctuation">.</span>GREEN<span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"green name(): "</span> <span class="token operator">+</span> green<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"green getDeclaringClass(): "</span> <span class="token operator">+</span> green<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"green hashCode(): "</span> <span class="token operator">+</span> green<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"green compareTo Color.GREEN: "</span> <span class="token operator">+</span> green<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span><span class="token class-name">Color</span><span class="token punctuation">.</span>GREEN<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"green equals Color.GREEN: "</span> <span class="token operator">+</span> green<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Color</span><span class="token punctuation">.</span>GREEN<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"green equals Size.MIDDLE: "</span> <span class="token operator">+</span> green<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Size</span><span class="token punctuation">.</span>MIDDLE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"green equals 1: "</span> <span class="token operator">+</span> green<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"green == Color.BLUE: %b\n"</span><span class="token punctuation">,</span> green <span class="token operator">==</span> <span class="token class-name">Color</span><span class="token punctuation">.</span>BLUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>输出</strong></p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">=========== Print all Color ===========
RED ordinal: 0
GREEN ordinal: 1
BLUE ordinal: 2
=========== Print all Size ===========
BIG ordinal: 0
MIDDLE ordinal: 1
SMALL ordinal: 2
green name(): GREEN
green getDeclaringClass(): class org.zp.javase.enumeration.EnumDemo$Color
green hashCode(): 460141958
green compareTo Color.GREEN: 0
green equals Color.GREEN: true
green equals Size.MIDDLE: false
green equals 1: false
green == Color.BLUE: false<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="-91"><a class="markdownIt-Anchor" href="#-91">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-enum.html#_4-%E6%9E%9A%E4%B8%BE%E7%9A%84%E7%89%B9%E6%80%A7">#</a>4. 枚举的特性</h2>
<p>枚举的特性，归结起来就是一句话：</p>
<blockquote>
<p><strong>除了不能继承，基本上可以将  <code>enum</code>  看做一个常规的类</strong>。</p>
</blockquote>
<p>但是这句话需要拆分去理解，让我们细细道来。</p>
<h3 id="-92"><a class="markdownIt-Anchor" href="#-92">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-enum.html#_4-1-%E5%9F%BA%E6%9C%AC%E7%89%B9%E6%80%A7">#</a>4.1. 基本特性</h3>
<p><strong>如果枚举中没有定义方法，也可以在最后一个实例后面加逗号、分号或什么都不加。</strong></p>
<p>如果枚举中没有定义方法，<strong>枚举值默认为从 0 开始的有序数值</strong>。以 Color 枚举类型举例，它的枚举常量依次为  <code>RED：0，GREEN：1，BLUE：2</code> 。</p>
<h3 id="-93"><a class="markdownIt-Anchor" href="#-93">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-enum.html#_4-2-%E6%9E%9A%E4%B8%BE%E5%8F%AF%E4%BB%A5%E6%B7%BB%E5%8A%A0%E6%96%B9%E6%B3%95">#</a>4.2. 枚举可以添加方法</h3>
<p>在概念章节提到了，<strong>枚举值默认为从 0 开始的有序数值</strong> 。那么问题来了：如何为枚举显式的赋值。</p>
<p>（1）<strong>Java 不允许使用  <code>=</code>  为枚举常量赋值</strong></p>
<p>如果你接触过 C/C++，你肯定会很自然的想到赋值符号  <code>=</code>  。在 C/C++ 语言中的 enum，可以用赋值符号 <code>=</code>  显式的为枚举常量赋值；但是 ，很遗憾，<strong>Java 语法中却不允许使用赋值符号  <code>=</code>  为枚举常量赋值</strong>。</p>
<p><strong>例：C/C++ 语言中的枚举声明</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">enum</span> <span class="token punctuation">&#123;</span>
    ONE <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
    TWO<span class="token punctuation">,</span>
    THREE <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span>
    TEN <span class="token operator">=</span> <span class="token number">10</span>
<span class="token punctuation">&#125;</span> Number<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>（2）<strong>枚举可以添加普通方法、静态方法、抽象方法、构造方法</strong></p>
<p>Java 虽然不能直接为实例赋值，但是它有更优秀的解决方案：<strong>为 enum 添加方法来间接实现显式赋值</strong>。</p>
<p>创建  <code>enum</code>  时，可以为其添加多种方法，甚至可以为其添加构造方法。</p>
<p><strong>注意一个细节：如果要为 enum 定义方法，那么必须在 enum 的最后一个实例尾部添加一个分号。此外，在 enum 中，必须先定义实例，不能将字段或方法定义在实例前面。否则，编译器会报错。</strong></p>
<p><strong>例：全面展示如何在枚举中定义普通方法、静态方法、抽象方法、构造方法</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">ErrorCodeEn</span> <span class="token punctuation">&#123;</span>
    <span class="token function">OK</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token string">"成功"</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token function">ERROR_A</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token string">"错误A"</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token function">ERROR_B</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token string">"错误B"</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> code<span class="token punctuation">;</span>

    <span class="token comment">// 构造方法：enum的构造方法只能被声明为private权限或不声明权限</span>
    <span class="token keyword">private</span> <span class="token class-name">ErrorCodeEn</span><span class="token punctuation">(</span><span class="token keyword">int</span> number<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 构造方法</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>code <span class="token operator">=</span> number<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 普通方法</span>
        <span class="token keyword">return</span> code<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token comment">// 普通方法</span>

    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">String</span> <span class="token function">getDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 抽象方法</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span> args<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 静态方法</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ErrorCodeEn</span> s <span class="token operator">:</span> <span class="token class-name">ErrorCodeEn</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"code: "</span> <span class="token operator">+</span> s<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", description: "</span> <span class="token operator">+</span> s<span class="token punctuation">.</span><span class="token function">getDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// Output:</span>
<span class="token comment">// code: 0, description: 成功</span>
<span class="token comment">// code: 100, description: 错误A</span>
<span class="token comment">// code: 200, description: 错误B</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注：上面的例子并不可取，仅仅是为了展示枚举支持定义各种方法。正确的例子情况<a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-enum.html#%E9%94%99%E8%AF%AF%E7%A0%81">错误码示例</a></p>
<h3 id="-94"><a class="markdownIt-Anchor" href="#-94">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-enum.html#_4-3-%E6%9E%9A%E4%B8%BE%E5%8F%AF%E4%BB%A5%E5%AE%9E%E7%8E%B0%E6%8E%A5%E5%8F%A3">#</a>4.3. 枚举可以实现接口</h3>
<p><strong> <code>enum</code>  可以像一般类一样实现接口。</strong></p>
<p>同样是实现上一节中的错误码枚举类，通过实现接口，可以约束它的方法。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">INumberEnum</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> <span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> <span class="token function">getDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">ErrorCodeEn2</span> <span class="token keyword">implements</span> <span class="token class-name">INumberEnum</span> <span class="token punctuation">&#123;</span>
    <span class="token function">OK</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"成功"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">ERROR_A</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token string">"错误A"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">ERROR_B</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">"错误B"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">ErrorCodeEn2</span><span class="token punctuation">(</span><span class="token keyword">int</span> number<span class="token punctuation">,</span> <span class="token class-name">String</span> description<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>code <span class="token operator">=</span> number<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>description <span class="token operator">=</span> description<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> code<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> description<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> code<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> description<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-95"><a class="markdownIt-Anchor" href="#-95">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-enum.html#_4-4-%E6%9E%9A%E4%B8%BE%E4%B8%8D%E5%8F%AF%E4%BB%A5%E7%BB%A7%E6%89%BF">#</a>4.4. 枚举不可以继承</h3>
<p><strong>enum 不可以继承另外一个类，当然，也不能继承另一个 enum 。</strong></p>
<p>因为  <code>enum</code>  实际上都继承自  <code>java.lang.Enum</code>  类，而 Java 不支持多重继承，所以  <code>enum</code>  不能再继承其他类，当然也不能继承另一个  <code>enum</code> 。</p>
<h2 id="-96"><a class="markdownIt-Anchor" href="#-96">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-enum.html#_5-%E6%9E%9A%E4%B8%BE%E7%9A%84%E5%BA%94%E7%94%A8">#</a>5. 枚举的应用</h2>
<h3 id="-97"><a class="markdownIt-Anchor" href="#-97">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-enum.html#_5-1-%E7%BB%84%E7%BB%87%E5%B8%B8%E9%87%8F">#</a>5.1. 组织常量</h3>
<p>在 JDK5 之前，在 Java 中定义常量都是 <code>public static final TYPE a;</code>  这样的形式。有了枚举，你可以将有关联关系的常量组织起来，使代码更加易读、安全，并且还可以使用枚举提供的方法。</p>
<p>下面三种声明方式是等价的：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">enum</span> <span class="token class-name">Color</span> <span class="token punctuation">&#123;</span> RED<span class="token punctuation">,</span> GREEN<span class="token punctuation">,</span> BLUE <span class="token punctuation">&#125;</span>
<span class="token keyword">enum</span> <span class="token class-name">Color</span> <span class="token punctuation">&#123;</span> RED<span class="token punctuation">,</span> GREEN<span class="token punctuation">,</span> BLUE<span class="token punctuation">,</span> <span class="token punctuation">&#125;</span>
<span class="token keyword">enum</span> <span class="token class-name">Color</span> <span class="token punctuation">&#123;</span> RED<span class="token punctuation">,</span> GREEN<span class="token punctuation">,</span> BLUE<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="-98"><a class="markdownIt-Anchor" href="#-98">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-enum.html#_5-2-switch-%E7%8A%B6%E6%80%81%E6%9C%BA">#</a>5.2. switch 状态机</h3>
<p>我们经常使用 switch 语句来写状态机。JDK7 以后，switch 已经支持  <code>int</code> 、 <code>char</code> 、 <code>String</code> 、 <code>enum</code>  类型的参数。这几种类型的参数比较起来，使用枚举的 switch 代码更具有可读性。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StateMachineDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">Signal</span> <span class="token punctuation">&#123;</span>
        GREEN<span class="token punctuation">,</span> YELLOW<span class="token punctuation">,</span> RED
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getTrafficInstruct</span><span class="token punctuation">(</span><span class="token class-name">Signal</span> signal<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> instruct <span class="token operator">=</span> <span class="token string">"信号灯故障"</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>signal<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">case</span> RED<span class="token operator">:</span>
                instruct <span class="token operator">=</span> <span class="token string">"红灯停"</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> YELLOW<span class="token operator">:</span>
                instruct <span class="token operator">=</span> <span class="token string">"黄灯请注意"</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> GREEN<span class="token operator">:</span>
                instruct <span class="token operator">=</span> <span class="token string">"绿灯行"</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> instruct<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">getTrafficInstruct</span><span class="token punctuation">(</span><span class="token class-name">Signal</span><span class="token punctuation">.</span>RED<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// Output:</span>
<span class="token comment">// 红灯停</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-99"><a class="markdownIt-Anchor" href="#-99">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-enum.html#_5-3-%E9%94%99%E8%AF%AF%E7%A0%81">#</a>5.3. 错误码</h3>
<p>枚举常被用于定义程序错误码。下面是一个简单示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ErrorCodeEnumDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">enum</span> <span class="token class-name">ErrorCodeEn</span> <span class="token punctuation">&#123;</span>
        <span class="token function">OK</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"成功"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">ERROR_A</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token string">"错误A"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">ERROR_B</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">"错误B"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">ErrorCodeEn</span><span class="token punctuation">(</span><span class="token keyword">int</span> number<span class="token punctuation">,</span> <span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>code <span class="token operator">=</span> number<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msg <span class="token operator">=</span> msg<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">private</span> <span class="token keyword">int</span> code<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> msg<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> code<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> msg<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token string">"ErrorCodeEn&#123;"</span> <span class="token operator">+</span> <span class="token string">"code="</span> <span class="token operator">+</span> code <span class="token operator">+</span> <span class="token string">", msg='"</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">'\''</span> <span class="token operator">+</span> <span class="token string">'&#125;'</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">toStringAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">StringBuilder</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"ErrorCodeEn All Elements: ["</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ErrorCodeEn</span> code <span class="token operator">:</span> <span class="token class-name">ErrorCodeEn</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>code<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">", "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">ErrorCodeEn</span><span class="token punctuation">.</span><span class="token function">toStringAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ErrorCodeEn</span> s <span class="token operator">:</span> <span class="token class-name">ErrorCodeEn</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// Output:</span>
<span class="token comment">// ErrorCodeEn All Elements: [0, 100, 200, ]</span>
<span class="token comment">// ErrorCodeEn&#123;code=0, msg='成功'&#125;</span>
<span class="token comment">// ErrorCodeEn&#123;code=100, msg='错误A'&#125;</span>
<span class="token comment">// ErrorCodeEn&#123;code=200, msg='错误B'&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-100"><a class="markdownIt-Anchor" href="#-100">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-enum.html#_5-4-%E7%BB%84%E7%BB%87%E6%9E%9A%E4%B8%BE">#</a>5.4. 组织枚举</h3>
<p>可以将类型相近的枚举通过接口或类组织起来，但是一般用接口方式进行组织。</p>
<p>原因是：Java 接口在编译时会自动为 enum 类型加上 <code>public static</code>  修饰符；Java 类在编译时会自动为  <code>enum</code>  类型加上 static 修饰符。看出差异了吗？没错，就是说，在类中组织  <code>enum</code> ，如果你不给它修饰为  <code>public</code> ，那么只能在本包中进行访问。</p>
<p><strong>例：在接口中组织 enum</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EnumInInterfaceDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">INumberEnum</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> <span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> <span class="token function">getDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>


    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Plant</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">enum</span> <span class="token class-name">Vegetable</span> <span class="token keyword">implements</span> <span class="token class-name">INumberEnum</span> <span class="token punctuation">&#123;</span>
            <span class="token function">POTATO</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"土豆"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">TOMATO</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"西红柿"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">Vegetable</span><span class="token punctuation">(</span><span class="token keyword">int</span> number<span class="token punctuation">,</span> <span class="token class-name">String</span> description<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>code <span class="token operator">=</span> number<span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>description <span class="token operator">=</span> description<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token keyword">private</span> <span class="token keyword">int</span> code<span class="token punctuation">;</span>
            <span class="token keyword">private</span> <span class="token class-name">String</span> description<span class="token punctuation">;</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>code<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>description<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>


        <span class="token keyword">enum</span> <span class="token class-name">Fruit</span> <span class="token keyword">implements</span> <span class="token class-name">INumberEnum</span> <span class="token punctuation">&#123;</span>
            <span class="token function">APPLE</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"苹果"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">ORANGE</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"桔子"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">BANANA</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"香蕉"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">Fruit</span><span class="token punctuation">(</span><span class="token keyword">int</span> number<span class="token punctuation">,</span> <span class="token class-name">String</span> description<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>code <span class="token operator">=</span> number<span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>description <span class="token operator">=</span> description<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token keyword">private</span> <span class="token keyword">int</span> code<span class="token punctuation">;</span>
            <span class="token keyword">private</span> <span class="token class-name">String</span> description<span class="token punctuation">;</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>code<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>description<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Plant<span class="token punctuation">.</span>Fruit</span> f <span class="token operator">:</span> <span class="token class-name">Plant<span class="token punctuation">.</span>Fruit</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span><span class="token function">getDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// Output:</span>
<span class="token comment">// 苹果</span>
<span class="token comment">// 桔子</span>
<span class="token comment">// 香蕉</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>例：在类中组织 enum</strong></p>
<p>本例和上例效果相同。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EnumInClassDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">INumberEnum</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> <span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> <span class="token function">getDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Plant2</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">enum</span> <span class="token class-name">Vegetable</span> <span class="token keyword">implements</span> <span class="token class-name">INumberEnum</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 略，与上面完全相同</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">enum</span> <span class="token class-name">Fruit</span> <span class="token keyword">implements</span> <span class="token class-name">INumberEnum</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 略，与上面完全相同</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 略</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// Output:</span>
<span class="token comment">// 土豆</span>
<span class="token comment">// 西红柿</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-101"><a class="markdownIt-Anchor" href="#-101">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-enum.html#_5-5-%E7%AD%96%E7%95%A5%E6%9E%9A%E4%B8%BE">#</a>5.5. 策略枚举</h3>
<p>Effective Java 中展示了一种策略枚举。这种枚举通过枚举嵌套枚举的方式，将枚举常量分类处理。</p>
<p>这种做法虽然没有 switch 语句简洁，但是更加安全、灵活。</p>
<p><strong>例：EffectvieJava 中的策略枚举范例</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">enum</span> <span class="token class-name">PayrollDay</span> <span class="token punctuation">&#123;</span>
    <span class="token function">MONDAY</span><span class="token punctuation">(</span><span class="token class-name">PayType</span><span class="token punctuation">.</span>WEEKDAY<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">TUESDAY</span><span class="token punctuation">(</span><span class="token class-name">PayType</span><span class="token punctuation">.</span>WEEKDAY<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">WEDNESDAY</span><span class="token punctuation">(</span>
            <span class="token class-name">PayType</span><span class="token punctuation">.</span>WEEKDAY<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">THURSDAY</span><span class="token punctuation">(</span><span class="token class-name">PayType</span><span class="token punctuation">.</span>WEEKDAY<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">FRIDAY</span><span class="token punctuation">(</span><span class="token class-name">PayType</span><span class="token punctuation">.</span>WEEKDAY<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">SATURDAY</span><span class="token punctuation">(</span>
            <span class="token class-name">PayType</span><span class="token punctuation">.</span>WEEKEND<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">SUNDAY</span><span class="token punctuation">(</span><span class="token class-name">PayType</span><span class="token punctuation">.</span>WEEKEND<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">PayType</span> payType<span class="token punctuation">;</span>

    <span class="token class-name">PayrollDay</span><span class="token punctuation">(</span><span class="token class-name">PayType</span> payType<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>payType <span class="token operator">=</span> payType<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">double</span> <span class="token function">pay</span><span class="token punctuation">(</span><span class="token keyword">double</span> hoursWorked<span class="token punctuation">,</span> <span class="token keyword">double</span> payRate<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> payType<span class="token punctuation">.</span><span class="token function">pay</span><span class="token punctuation">(</span>hoursWorked<span class="token punctuation">,</span> payRate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 策略枚举</span>
    <span class="token keyword">private</span> <span class="token keyword">enum</span> <span class="token class-name">PayType</span> <span class="token punctuation">&#123;</span>
        WEEKDAY <span class="token punctuation">&#123;</span>
            <span class="token keyword">double</span> <span class="token function">overtimePay</span><span class="token punctuation">(</span><span class="token keyword">double</span> hours<span class="token punctuation">,</span> <span class="token keyword">double</span> payRate<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> hours <span class="token operator">&lt;=</span> HOURS_PER_SHIFT <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token punctuation">(</span>hours <span class="token operator">-</span> HOURS_PER_SHIFT<span class="token punctuation">)</span>
                        <span class="token operator">*</span> payRate <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        WEEKEND <span class="token punctuation">&#123;</span>
            <span class="token keyword">double</span> <span class="token function">overtimePay</span><span class="token punctuation">(</span><span class="token keyword">double</span> hours<span class="token punctuation">,</span> <span class="token keyword">double</span> payRate<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> hours <span class="token operator">*</span> payRate <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> HOURS_PER_SHIFT <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>

        <span class="token keyword">abstract</span> <span class="token keyword">double</span> <span class="token function">overtimePay</span><span class="token punctuation">(</span><span class="token keyword">double</span> hrs<span class="token punctuation">,</span> <span class="token keyword">double</span> payRate<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">double</span> <span class="token function">pay</span><span class="token punctuation">(</span><span class="token keyword">double</span> hoursWorked<span class="token punctuation">,</span> <span class="token keyword">double</span> payRate<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">double</span> basePay <span class="token operator">=</span> hoursWorked <span class="token operator">*</span> payRate<span class="token punctuation">;</span>
            <span class="token keyword">return</span> basePay <span class="token operator">+</span> <span class="token function">overtimePay</span><span class="token punctuation">(</span>hoursWorked<span class="token punctuation">,</span> payRate<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>测试</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"时薪100的人在周五工作8小时的收入："</span> <span class="token operator">+</span> <span class="token class-name">PayrollDay</span><span class="token punctuation">.</span>FRIDAY<span class="token punctuation">.</span><span class="token function">pay</span><span class="token punctuation">(</span><span class="token number">8.0</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"时薪100的人在周六工作8小时的收入："</span> <span class="token operator">+</span> <span class="token class-name">PayrollDay</span><span class="token punctuation">.</span>SATURDAY<span class="token punctuation">.</span><span class="token function">pay</span><span class="token punctuation">(</span><span class="token number">8.0</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="-102"><a class="markdownIt-Anchor" href="#-102">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-enum.html#_5-6-%E6%9E%9A%E4%B8%BE%E5%AE%9E%E7%8E%B0%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F">#</a>5.6. 枚举实现单例模式</h3>
<p>单例模式是最常用的设计模式。</p>
<p>单例模式在并发环境下存在线程安全问题。</p>
<p>为了线程安全问题，传统做法有以下几种：</p>
<ul>
<li>饿汉式加载</li>
<li>懒汉式 synchronize 和双重检查</li>
<li>利用 java 的静态加载机制</li>
</ul>
<p>相比上述的方法，使用枚举也可以实现单例，而且还更加简单：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SingleEnumDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">SingleEn</span> <span class="token punctuation">&#123;</span>

        INSTANCE<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> name<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setName</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">SingleEn</span><span class="token punctuation">.</span>INSTANCE<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"zp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">SingleEn</span><span class="token punctuation">.</span>INSTANCE<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>扩展阅读：<a target="_blank" rel="noopener" href="https://blog.csdn.net/javazejian/article/details/71333103#enumset%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90">深入理解 Java 枚举类型 (enum)(opens new window)</a></p>
<p>这篇文章对于 Java 枚举的特性讲解很仔细，其中对于枚举实现单例和传统单例实现方式说的尤为细致。</p>
</blockquote>
<h2 id="-103"><a class="markdownIt-Anchor" href="#-103">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-enum.html#_6-%E6%9E%9A%E4%B8%BE%E5%B7%A5%E5%85%B7%E7%B1%BB">#</a>6. 枚举工具类</h2>
<p>Java 中提供了两个方便操作 enum 的工具类 —— <code>EnumSet</code>  和  <code>EnumMap</code> 。</p>
<h3 id="-104"><a class="markdownIt-Anchor" href="#-104">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-enum.html#_6-1-enumset">#</a>6.1. EnumSet</h3>
<p><code>EnumSet</code>  是枚举类型的高性能  <code>Set</code>  实现。它要求放入它的枚举常量必须属于同一枚举类型。</p>
<p>主要接口：</p>
<ul>
<li><code>noneOf</code>  - 创建一个具有指定元素类型的空 EnumSet</li>
<li><code>allOf</code>  - 创建一个指定元素类型并包含所有枚举值的 EnumSet</li>
<li><code>range</code>  - 创建一个包括枚举值中指定范围元素的 EnumSet</li>
<li><code>complementOf</code>  - 初始集合包括指定集合的补集</li>
<li><code>of</code>  - 创建一个包括参数中所有元素的 EnumSet</li>
<li><code>copyOf</code>  - 创建一个包含参数容器中的所有元素的 EnumSet</li>
</ul>
<p>示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EnumSetDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"EnumSet展示"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">EnumSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ErrorCodeEn</span><span class="token punctuation">></span></span> errSet <span class="token operator">=</span> <span class="token class-name">EnumSet</span><span class="token punctuation">.</span><span class="token function">allOf</span><span class="token punctuation">(</span><span class="token class-name">ErrorCodeEn</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ErrorCodeEn</span> e <span class="token operator">:</span> errSet<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" : "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">ordinal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-105"><a class="markdownIt-Anchor" href="#-105">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-enum.html#_6-2-enummap">#</a>6.2. EnumMap</h3>
<p><code>EnumMap</code>  是专门为枚举类型量身定做的  <code>Map</code>  实现。虽然使用其它的 Map 实现（如 HashMap）也能完成枚举类型实例到值得映射，但是使用 EnumMap 会更加高效：它只能接收同一枚举类型的实例作为键值，并且由于枚举类型实例的数量相对固定并且有限，所以 EnumMap 使用数组来存放与枚举类型对应的值。这使得 EnumMap 的效率非常高。</p>
<p>主要接口：</p>
<ul>
<li><code>size</code>  - 返回键值对数</li>
<li><code>containsValue</code>  - 是否存在指定的 value</li>
<li><code>containsKey</code>  - 是否存在指定的 key</li>
<li><code>get</code>  - 根据指定 key 获取 value</li>
<li><code>put</code>  - 取出指定的键值对</li>
<li><code>remove</code>  - 删除指定 key</li>
<li><code>putAll</code>  - 批量取出键值对</li>
<li><code>clear</code>  - 清除数据</li>
<li><code>keySet</code>  - 获取 key 集合</li>
<li><code>values</code>  - 返回所有</li>
</ul>
<p>示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EnumMapDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">Signal</span> <span class="token punctuation">&#123;</span>
        GREEN<span class="token punctuation">,</span> YELLOW<span class="token punctuation">,</span> RED
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"EnumMap展示"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">EnumMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Signal</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> errMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EnumMap</span><span class="token punctuation">(</span><span class="token class-name">Signal</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        errMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">Signal</span><span class="token punctuation">.</span>RED<span class="token punctuation">,</span> <span class="token string">"红灯"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        errMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">Signal</span><span class="token punctuation">.</span>YELLOW<span class="token punctuation">,</span> <span class="token string">"黄灯"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        errMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">Signal</span><span class="token punctuation">.</span>GREEN<span class="token punctuation">,</span> <span class="token string">"绿灯"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token punctuation">&lt;</span><span class="token class-name">Signal</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span><span class="token punctuation">></span></span> iter <span class="token operator">=</span> errMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> iter<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Signal</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> entry <span class="token operator">=</span> iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" : "</span> <span class="token operator">+</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>扩展阅读：<a target="_blank" rel="noopener" href="https://blog.csdn.net/javazejian/article/details/71333103#enumset%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90">深入理解 Java 枚举类型 (enum)(opens new window)</a></p>
<p>这篇文章中对 EnumSet 和 EnumMap 原理做了较为详细的介绍。</p>
</blockquote>
<h2 id="-106"><a class="markdownIt-Anchor" href="#-106">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-enum.html#_7-%E5%B0%8F%E7%BB%93">#</a>7. 小结</h2>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/1553002212154.png" alt="img"></p>
<hr>
<h1 id="java-控制语句"><a class="markdownIt-Anchor" href="#java-控制语句">#</a> Java 控制语句</h1>
<blockquote>
<p><strong>📦 本文以及示例源码已归档在 <a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/">javacore(opens new window)</a></strong></p>
<p>Java 控制语句大致可分为三大类：</p>
<ul>
<li>选择语句
<ul>
<li>if, else-if, else</li>
<li>switch</li>
</ul>
</li>
<li>循环语句
<ul>
<li>while</li>
<li>do…while</li>
<li>for</li>
<li>foreach</li>
</ul>
</li>
<li>终端语句
<ul>
<li>break</li>
<li>continue</li>
<li>return</li>
</ul>
</li>
</ul>
</blockquote>
<ul>
<li>\1. 选择语句
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-control-statement.html#11-if-%E8%AF%AD%E5%8F%A5">1.1. if 语句</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-control-statement.html#12-ifelse-%E8%AF%AD%E5%8F%A5">1.2. if…else 语句</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-control-statement.html#13-ifelse-ifelse-%E8%AF%AD%E5%8F%A5">1.3. if…else if…else 语句</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-control-statement.html#14-%E5%B5%8C%E5%A5%97%E7%9A%84-ifelse-%E8%AF%AD%E5%8F%A5">1.4. 嵌套的 if…else 语句</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-control-statement.html#15-switch-%E8%AF%AD%E5%8F%A5">1.5. switch 语句</a></li>
</ul>
</li>
<li>\2. 循环语句
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-control-statement.html#21-while-%E5%BE%AA%E7%8E%AF">2.1. while 循环</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-control-statement.html#22-do-while-%E5%BE%AA%E7%8E%AF">2.2. do while 循环</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-control-statement.html#23-for-%E5%BE%AA%E7%8E%AF">2.3. for 循环</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-control-statement.html#24-foreach-%E5%BE%AA%E7%8E%AF">2.4. foreach 循环</a></li>
</ul>
</li>
<li>\3. 中断语句
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-control-statement.html#31-break-%E5%85%B3%E9%94%AE%E5%AD%97">3.1. break 关键字</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-control-statement.html#32-continue-%E5%85%B3%E9%94%AE%E5%AD%97">3.2. continue 关键字</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-control-statement.html#33-return-%E5%85%B3%E9%94%AE%E5%AD%97">3.3. return 关键字</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-control-statement.html#4-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">4. 最佳实践</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-control-statement.html#5-%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">5. 参考资料</a></li>
</ul>
<h2 id="-107"><a class="markdownIt-Anchor" href="#-107">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-control-statement.html#_1-%E9%80%89%E6%8B%A9%E8%AF%AD%E5%8F%A5">#</a>1. 选择语句</h2>
<h3 id="-108"><a class="markdownIt-Anchor" href="#-108">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-control-statement.html#_1-1-if-%E8%AF%AD%E5%8F%A5">#</a>1.1. if 语句</h3>
<p><code>if</code>  语句会判断括号中的条件是否成立，如果成立则执行  <code>if</code>  语句中的代码块，否则跳过代码块继续执行。</p>
<p><strong>语法</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">if</span><span class="token punctuation">(</span>布尔表达式<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
   <span class="token comment">//如果布尔表达式为true将执行的语句</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><strong>示例</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IfDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span> args<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"这是 if 语句"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// output:</span>
<span class="token comment">// 这是 if 语句</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-109"><a class="markdownIt-Anchor" href="#-109">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-control-statement.html#_1-2-if-else-%E8%AF%AD%E5%8F%A5">#</a>1.2. if…else 语句</h3>
<p><code>if</code>  语句后面可以跟  <code>else</code>  语句，当  <code>if</code>  语句的布尔表达式值为  <code>false</code>  时， <code>else</code>  语句块会被执行。</p>
<p><strong>语法</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">if</span><span class="token punctuation">(</span>布尔表达式<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
   <span class="token comment">//如果布尔表达式的值为true</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
   <span class="token comment">//如果布尔表达式的值为false</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>示例</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IfElseDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span> args<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"这是 if 语句"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"这是 else 语句"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// output:</span>
<span class="token comment">// 这是 else 语句</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-110"><a class="markdownIt-Anchor" href="#-110">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-control-statement.html#_1-3-if-else-if-else-%E8%AF%AD%E5%8F%A5">#</a>1.3. if…else if…else 语句</h3>
<ul>
<li><code>if</code>  语句至多有 1 个  <code>else</code>  语句， <code>else</code>  语句在所有的  <code>else if</code>  语句之后。</li>
<li><code>If</code>  语句可以有若干个  <code>else if</code>  语句，它们必须在  <code>else</code>  语句之前。</li>
<li>一旦其中一个  <code>else if</code>  语句检测为  <code>true</code> ，其他的  <code>else if</code>  以及  <code>else</code>  语句都将跳过执行。</li>
</ul>
<p><strong>语法</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">if</span> <span class="token punctuation">(</span>布尔表达式 <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
   <span class="token comment">//如果布尔表达式 1的值为true执行代码</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>布尔表达式 <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
   <span class="token comment">//如果布尔表达式 2的值为true执行代码</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>布尔表达式 <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
   <span class="token comment">//如果布尔表达式 3的值为true执行代码</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
   <span class="token comment">//如果以上布尔表达式都不为true执行代码</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>示例</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IfElseifElseDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span> args<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"Value of X is 1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"Value of X is 2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"Value of X is 3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"This is else statement"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// output:</span>
<span class="token comment">// Value of X is 3</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-111"><a class="markdownIt-Anchor" href="#-111">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-control-statement.html#_1-4-%E5%B5%8C%E5%A5%97%E7%9A%84-if-else-%E8%AF%AD%E5%8F%A5">#</a>1.4. 嵌套的 if…else 语句</h3>
<p>使用嵌套的  <code>if else</code>  语句是合法的。也就是说你可以在另一个  <code>if</code>  或者  <code>else if</code>  语句中使用  <code>if</code>  或者  <code>else if</code>  语句。</p>
<p><strong>语法</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">if</span> <span class="token punctuation">(</span>布尔表达式 <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
   <span class="token comment">////如果布尔表达式 1的值为true执行代码</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>布尔表达式 <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">////如果布尔表达式 2的值为true执行代码</span>
   <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>示例</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IfNestDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span> args<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> y <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">==</span> <span class="token number">30</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>y <span class="token operator">==</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"X = 30 and Y = 10"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// output:</span>
<span class="token comment">// X = 30 and Y = 10</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-112"><a class="markdownIt-Anchor" href="#-112">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-control-statement.html#_1-5-switch-%E8%AF%AD%E5%8F%A5">#</a>1.5. switch 语句</h3>
<p><code>switch</code>  语句判断一个变量与一系列值中某个值是否相等，每个值称为一个分支。</p>
<p><code>switch</code>  语句有如下规则：</p>
<ul>
<li><code>switch</code>  语句中的变量类型只能为  <code>byte</code> 、 <code>short</code> 、 <code>int</code> 、 <code>char</code>  或者  <code>String</code> 。</li>
<li><code>switch</code>  语句可以拥有多个  <code>case</code>  语句。每个  <code>case</code>  后面跟一个要比较的值和冒号。</li>
<li><code>case</code>  语句中的值的数据类型必须与变量的数据类型相同，而且只能是常量或者字面常量。</li>
<li>当变量的值与  <code>case</code>  语句的值相等时，那么  <code>case</code>  语句之后的语句开始执行，直到  <code>break</code>  语句出现才会跳出  <code>switch</code>  语句。</li>
<li>当遇到  <code>break</code>  语句时， <code>switch</code>  语句终止。程序跳转到  <code>switch</code>  语句后面的语句执行。 <code>case</code>  语句不必须要包含  <code>break</code>  语句。如果没有  <code>break</code>  语句出现，程序会继续执行下一条  <code>case</code>  语句，直到出现  <code>break</code>  语句。</li>
<li><code>switch</code>  语句可以包含一个  <code>default</code>  分支，该分支必须是  <code>switch</code>  语句的最后一个分支。 <code>default</code>  在没有  <code>case</code>  语句的值和变量值相等的时候执行。 <code>default</code>  分支不需要  <code>break</code>  语句。</li>
</ul>
<p><strong>语法</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">switch</span><span class="token punctuation">(</span>expression<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">case</span> value <span class="token operator">:</span>
       <span class="token comment">//语句</span>
       <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">//可选</span>
    <span class="token keyword">case</span> value <span class="token operator">:</span>
       <span class="token comment">//语句</span>
       <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">//可选</span>
    <span class="token comment">//你可以有任意数量的case语句</span>
    <span class="token keyword">default</span> <span class="token operator">:</span> <span class="token comment">//可选</span>
       <span class="token comment">//语句</span>
       <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">//可选，但一般建议加上</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>示例</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SwitchDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span> args<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">char</span> grade <span class="token operator">=</span> <span class="token string">'C'</span><span class="token punctuation">;</span>

        <span class="token keyword">switch</span> <span class="token punctuation">(</span>grade<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">case</span> <span class="token string">'A'</span><span class="token operator">:</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Excellent!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">'B'</span><span class="token operator">:</span>
        <span class="token keyword">case</span> <span class="token string">'C'</span><span class="token operator">:</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Well done"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">'D'</span><span class="token operator">:</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"You passed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">'F'</span><span class="token operator">:</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Better try again"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Invalid grade"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Your grade is "</span> <span class="token operator">+</span> grade<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// output:</span>
<span class="token comment">// Well done</span>
<span class="token comment">// Your grade is C</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="-113"><a class="markdownIt-Anchor" href="#-113">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-control-statement.html#_2-%E5%BE%AA%E7%8E%AF%E8%AF%AD%E5%8F%A5">#</a>2. 循环语句</h2>
<h3 id="-114"><a class="markdownIt-Anchor" href="#-114">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-control-statement.html#_2-1-while-%E5%BE%AA%E7%8E%AF">#</a>2.1. while 循环</h3>
<p>只要布尔表达式为  <code>true</code> ， <code>while</code>  循环体会一直执行下去。</p>
<p><strong>语法</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">while</span><span class="token punctuation">(</span> 布尔表达式 <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//循环内容</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><strong>示例</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WhileDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span> args<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>x <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"value of x : "</span> <span class="token operator">+</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
            x<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// output:</span>
<span class="token comment">// value of x : 10</span>
<span class="token comment">// value of x : 11</span>
<span class="token comment">// value of x : 12</span>
<span class="token comment">// value of x : 13</span>
<span class="token comment">// value of x : 14</span>
<span class="token comment">// value of x : 15</span>
<span class="token comment">// value of x : 16</span>
<span class="token comment">// value of x : 17</span>
<span class="token comment">// value of x : 18</span>
<span class="token comment">// value of x : 19</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-115"><a class="markdownIt-Anchor" href="#-115">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-control-statement.html#_2-2-do-while-%E5%BE%AA%E7%8E%AF">#</a>2.2. do while 循环</h3>
<p>对于  <code>while</code>  语句而言，如果不满足条件，则不能进入循环。但有时候我们需要即使不满足条件，也至少执行一次。</p>
<p><code>do while</code>  循环和  <code>while</code>  循环相似，不同的是， <code>do while</code>  循环至少会执行一次。</p>
<p><strong>语法</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">do</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//代码语句</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>布尔表达式<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>布尔表达式在循环体的后面，所以语句块在检测布尔表达式之前已经执行了。 如果布尔表达式的值为 true，则语句块一直执行，直到布尔表达式的值为 false。</p>
<p><strong>示例</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DoWhileDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span> args<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>

        <span class="token keyword">do</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"value of x : "</span> <span class="token operator">+</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
            x<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>x <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// output:</span>
<span class="token comment">// value of x:10</span>
<span class="token comment">// value of x:11</span>
<span class="token comment">// value of x:12</span>
<span class="token comment">// value of x:13</span>
<span class="token comment">// value of x:14</span>
<span class="token comment">// value of x:15</span>
<span class="token comment">// value of x:16</span>
<span class="token comment">// value of x:17</span>
<span class="token comment">// value of x:18</span>
<span class="token comment">// value of x:19</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-116"><a class="markdownIt-Anchor" href="#-116">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-control-statement.html#_2-3-for-%E5%BE%AA%E7%8E%AF">#</a>2.3. for 循环</h3>
<p>虽然所有循环结构都可以用  <code>while</code>  或者  <code>do while</code>  表示，但 Java 提供了另一种语句 ——  <code>for</code>  循环，使一些循环结构变得更加简单。  <code>for</code>  循环执行的次数是在执行前就确定的。</p>
<p><strong>语法</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">for</span> <span class="token punctuation">(</span>初始化<span class="token punctuation">;</span> 布尔表达式<span class="token punctuation">;</span> 更新<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//代码语句</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<ul>
<li>最先执行初始化步骤。可以声明一种类型，但可初始化一个或多个循环控制变量，也可以是空语句。</li>
<li>然后，检测布尔表达式的值。如果为 true，循环体被执行。如果为 false，循环终止，开始执行循环体后面的语句。</li>
<li>执行一次循环后，更新循环控制变量。</li>
<li>再次检测布尔表达式。循环执行上面的过程。</li>
</ul>
<p><strong>示例</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ForDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span> args<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">;</span> x <span class="token operator">=</span> x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"value of x : "</span> <span class="token operator">+</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// output:</span>
<span class="token comment">// value of x : 10</span>
<span class="token comment">// value of x : 11</span>
<span class="token comment">// value of x : 12</span>
<span class="token comment">// value of x : 13</span>
<span class="token comment">// value of x : 14</span>
<span class="token comment">// value of x : 15</span>
<span class="token comment">// value of x : 16</span>
<span class="token comment">// value of x : 17</span>
<span class="token comment">// value of x : 18</span>
<span class="token comment">// value of x : 19</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-117"><a class="markdownIt-Anchor" href="#-117">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-control-statement.html#_2-4-foreach-%E5%BE%AA%E7%8E%AF">#</a>2.4. foreach 循环</h3>
<p>Java5 引入了一种主要用于数组的增强型 for 循环。</p>
<p><strong>语法</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">for</span> <span class="token punctuation">(</span>声明语句 <span class="token operator">:</span> 表达式<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//代码句子</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><strong>声明语句</strong>：声明新的局部变量，该变量的类型必须和数组元素的类型匹配。其作用域限定在循环语句块，其值与此时数组元素的值相等。</p>
<p><strong>表达式</strong>：表达式是要访问的数组名，或者是返回值为数组的方法。</p>
<p><strong>示例</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ForeachDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span> args<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> numbers <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">50</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> x <span class="token operator">:</span> numbers<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> names <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token string">"James"</span><span class="token punctuation">,</span> <span class="token string">"Larry"</span><span class="token punctuation">,</span> <span class="token string">"Tom"</span><span class="token punctuation">,</span> <span class="token string">"Lacy"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> name <span class="token operator">:</span> names<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// output:</span>
<span class="token comment">// 10,20,30,40,50,</span>
<span class="token comment">// James,Larry,Tom,Lacy,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="-118"><a class="markdownIt-Anchor" href="#-118">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-control-statement.html#_3-%E4%B8%AD%E6%96%AD%E8%AF%AD%E5%8F%A5">#</a>3. 中断语句</h2>
<h3 id="-119"><a class="markdownIt-Anchor" href="#-119">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-control-statement.html#_3-1-break-%E5%85%B3%E9%94%AE%E5%AD%97">#</a>3.1. break 关键字</h3>
<p><code>break</code>  主要用在循环语句或者  <code>switch</code>  语句中，用来跳出整个语句块。</p>
<p><code>break</code>  跳出最里层的循环，并且继续执行该循环下面的语句。</p>
<p><strong>示例</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BreakDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span> args<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> numbers <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">50</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> x <span class="token operator">:</span> numbers<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">==</span> <span class="token number">30</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"break 示例结束"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// output:</span>
<span class="token comment">// 10</span>
<span class="token comment">// 20</span>
<span class="token comment">// break 示例结束</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-120"><a class="markdownIt-Anchor" href="#-120">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-control-statement.html#_3-2-continue-%E5%85%B3%E9%94%AE%E5%AD%97">#</a>3.2. continue 关键字</h3>
<p><code>continue</code>  适用于任何循环控制结构中。作用是让程序立刻跳转到下一次循环的迭代。在  <code>for</code>  循环中， <code>continue</code>  语句使程序立即跳转到更新语句。在  <code>while</code>  或者  <code>do while</code>  循环中，程序立即跳转到布尔表达式的判断语句。</p>
<p><strong>示例</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ContinueDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span> args<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> numbers <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">50</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> x <span class="token operator">:</span> numbers<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">==</span> <span class="token number">30</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// output:</span>
<span class="token comment">// 10</span>
<span class="token comment">// 20</span>
<span class="token comment">// 40</span>
<span class="token comment">// 50</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-121"><a class="markdownIt-Anchor" href="#-121">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-control-statement.html#_3-3-return-%E5%85%B3%E9%94%AE%E5%AD%97">#</a>3.3. return 关键字</h3>
<p>跳出整个函数体，函数体后面的部分不再执行。</p>
<p>示例</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReturnDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span> args<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> numbers <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">50</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> x <span class="token operator">:</span> numbers<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">==</span> <span class="token number">30</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"return 示例结束"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// output:</span>
<span class="token comment">// 10</span>
<span class="token comment">// 20</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>🔔 注意：请仔细体会一下  <code>return</code>  和  <code>break</code>  的区别。</p>
</blockquote>
<h2 id="-122"><a class="markdownIt-Anchor" href="#-122">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-control-statement.html#_4-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">#</a>4. 最佳实践</h2>
<ul>
<li>选择分支特别多的情况下， <code>switch</code>  语句优于  <code>if...else if...else</code>  语句。</li>
<li><code>switch</code>  语句不要吝啬使用  <code>default</code> 。</li>
<li><code>switch</code>  语句中的  <code>default</code>  要放在最后。</li>
<li><code>foreach</code>  循环优先于传统的  <code>for</code>  循环</li>
<li>不要循环遍历容器元素，然后删除特定元素。正确姿势应该是遍历容器的迭代器（ <code>Iterator</code> ），删除元素。</li>
</ul>
<hr>
<h1 id="深入理解-java-异常"><a class="markdownIt-Anchor" href="#深入理解-java-异常">#</a> 深入理解 Java 异常</h1>
<blockquote>
<p><strong>📦 本文以及示例源码已归档在 <a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/">javacore(opens new window)</a></strong></p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/1553752019030.png" alt="img"></p>
<ul>
<li>\1. 异常框架
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-exception.html#11-throwable">1.1. Throwable</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-exception.html#12-error">1.2. Error</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-exception.html#13-exception">1.3. Exception</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-exception.html#14-runtimeexception">1.4. RuntimeException</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-exception.html#2-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BC%82%E5%B8%B8">2. 自定义异常</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-exception.html#3-%E6%8A%9B%E5%87%BA%E5%BC%82%E5%B8%B8">3. 抛出异常</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-exception.html#4-%E6%8D%95%E8%8E%B7%E5%BC%82%E5%B8%B8">4. 捕获异常</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-exception.html#5-%E5%BC%82%E5%B8%B8%E9%93%BE">5. 异常链</a></li>
<li>\6. 异常注意事项
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-exception.html#61-finally-%E8%A6%86%E7%9B%96%E5%BC%82%E5%B8%B8">6.1. finally 覆盖异常</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-exception.html#62-%E8%A6%86%E7%9B%96%E6%8A%9B%E5%87%BA%E5%BC%82%E5%B8%B8%E7%9A%84%E6%96%B9%E6%B3%95">6.2. 覆盖抛出异常的方法</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-exception.html#63-%E5%BC%82%E5%B8%B8%E5%92%8C%E7%BA%BF%E7%A8%8B">6.3. 异常和线程</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-exception.html#7-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">7. 最佳实践</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-exception.html#8-%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">8. 参考资料</a></li>
</ul>
<h2 id="-123"><a class="markdownIt-Anchor" href="#-123">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-exception.html#_1-%E5%BC%82%E5%B8%B8%E6%A1%86%E6%9E%B6">#</a>1. 异常框架</h2>
<h3 id="-124"><a class="markdownIt-Anchor" href="#-124">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-exception.html#_1-1-throwable">#</a>1.1. Throwable</h3>
<p>** <code>Throwable</code>  是 Java 语言中所有错误（ <code>Error</code> ）和异常（ <code>Exception</code> ）的超类。** 在 Java 中只有  <code>Throwable</code>  类型的实例才可以被抛出（ <code>throw</code> ）或者捕获（ <code>catch</code> ），它是异常处理机制的基本组成类型。</p>
<p><code>Throwable</code>  包含了其线程创建时线程执行堆栈的快照，它提供了  <code>printStackTrace()</code>  等接口用于获取堆栈跟踪数据等信息。</p>
<p>主要方法：</p>
<ul>
<li><code>fillInStackTrace</code>  - 用当前的调用栈层次填充  <code>Throwable</code>  对象栈层次，添加到栈层次任何先前信息中。</li>
<li><code>getMessage</code>  - 返回关于发生的异常的详细信息。这个消息在  <code>Throwable</code>  类的构造函数中初始化了。</li>
<li><code>getCause</code>  - 返回一个  <code>Throwable</code>  对象代表异常原因。</li>
<li><code>getStackTrace</code>  - 返回一个包含堆栈层次的数组。下标为 0 的元素代表栈顶，最后一个元素代表方法调用堆栈的栈底。</li>
<li><code>printStackTrace</code>  - 打印  <code>toString()</code>  结果和栈层次到  <code>System.err</code> ，即错误输出流。</li>
<li><code>toString</code>  - 使用  <code>getMessage</code>  的结果返回代表  <code>Throwable</code>  对象的字符串。</li>
</ul>
<h3 id="-125"><a class="markdownIt-Anchor" href="#-125">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-exception.html#_1-2-error">#</a>1.2. Error</h3>
<p><code>Error</code>  是  <code>Throwable</code>  的一个子类。<strong> <code>Error</code>  表示正常情况下，不大可能出现的严重问题</strong>。<strong>编译器不会检查  <code>Error</code> </strong>。绝大部分的 Error 都会导致程序（比如 JVM 自身）处于非正常的、不可恢复状态。既然是非正常情况，所以不便于也不需要捕获，常见的比如 OutOfMemoryError 之类，都是 Error 的子类。</p>
<p>常见  <code>Error</code> ：</p>
<ul>
<li><code>AssertionError</code>  - 断言错误。</li>
<li><code>VirtualMachineError</code>  - 虚拟机错误。</li>
<li><code>UnsupportedClassVersionError</code>  - Java 类版本错误。</li>
<li><code>StackOverflowError</code>  - 栈溢出错误。</li>
<li><code>OutOfMemoryError</code>  - 内存溢出错误。</li>
</ul>
<h3 id="-126"><a class="markdownIt-Anchor" href="#-126">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-exception.html#_1-3-exception">#</a>1.3. Exception</h3>
<p><code>Exception</code>  是  <code>Throwable</code>  的一个子类。** <code>Exception</code>  表示合理的应用程序可能想要捕获的条件。**Exception 是程序正常运行中，可以预料的意外情况，可能并且应该被捕获，进行相应处理。</p>
<p>Exception 又分为可检查（checked）异常和不检查（unchecked）异常，可检查异常在源代码里必须显式地进行捕获处理，这是编译期检查的一部分。</p>
<p>** 编译器会检查  <code>Exception</code>  异常。** 此类异常，要么通过  <code>throws</code>  进行声明抛出，要么通过  <code>try catch</code>  进行捕获处理，否则不能通过编译。</p>
<p>常见  <code>Exception</code> ：</p>
<ul>
<li><code>ClassNotFoundException</code>  - 应用程序试图加载类时，找不到相应的类，抛出该异常。</li>
<li><code>CloneNotSupportedException</code>  - 当调用 Object 类中的 clone 方法克隆对象，但该对象的类无法实现 Cloneable 接口时，抛出该异常。</li>
<li><code>IllegalAccessException</code>  - 拒绝访问一个类的时候，抛出该异常。</li>
<li><code>InstantiationException</code>  - 当试图使用 Class 类中的 newInstance 方法创建一个类的实例，而指定的类对象因为是一个接口或是一个抽象类而无法实例化时，抛出该异常。</li>
<li><code>InterruptedException</code>  - 一个线程被另一个线程中断，抛出该异常。</li>
<li><code>NoSuchFieldException</code>  - 请求的变量不存在。</li>
<li><code>NoSuchMethodException</code>  - 请求的方法不存在。</li>
</ul>
<p>示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExceptionDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Method</span> method <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"toString"</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>试图编译运行时会报错：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Error:(7, 47) java: 未报告的异常错误java.lang.NoSuchMethodException; 必须对其进行捕获或声明以便抛出<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="-127"><a class="markdownIt-Anchor" href="#-127">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-exception.html#_1-4-runtimeexception">#</a>1.4. RuntimeException</h3>
<p><code>RuntimeException</code>  是  <code>Exception</code>  的一个子类。 <code>RuntimeException</code>  是那些可能在 Java 虚拟机正常运行期间抛出的异常的超类。</p>
<p>** 编译器不会检查  <code>RuntimeException</code>  异常。** 当程序中可能出现这类异常时，倘若既没有通过  <code>throws</code>  声明抛出它，也没有用  <code>try catch</code>  语句捕获它，程序还是会编译通过。</p>
<p>示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RuntimeExceptionDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 此处产生了异常</span>
        <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"两个数字相除的结果："</span> <span class="token operator">+</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"----------------------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>运行时输出：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Exception in thread "main" java.lang.ArithmeticException: / by zero
	at io.github.dunwu.javacore.exception.RumtimeExceptionDemo01.main(RumtimeExceptionDemo01.java:6)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>常见  <code>RuntimeException</code> ：</p>
<ul>
<li><code>ArrayIndexOutOfBoundsException</code>  - 用非法索引访问数组时抛出的异常。如果索引为负或大于等于数组大小，则该索引为非法索引。</li>
<li><code>ArrayStoreException</code>  - 试图将错误类型的对象存储到一个对象数组时抛出的异常。</li>
<li><code>ClassCastException</code>  - 当试图将对象强制转换为不是实例的子类时，抛出该异常。</li>
<li><code>IllegalArgumentException</code>  - 抛出的异常表明向方法传递了一个不合法或不正确的参数。</li>
<li><code>IllegalMonitorStateException</code>  - 抛出的异常表明某一线程已经试图等待对象的监视器，或者试图通知其他正在等待对象的监视器而本身没有指定监视器的线程。</li>
<li><code>IllegalStateException</code>  - 在非法或不适当的时间调用方法时产生的信号。换句话说，即 Java 环境或 Java 应用程序没有处于请求操作所要求的适当状态下。</li>
<li><code>IllegalThreadStateException</code>  - 线程没有处于请求操作所要求的适当状态时抛出的异常。</li>
<li><code>IndexOutOfBoundsException</code>  - 指示某排序索引（例如对数组、字符串或向量的排序）超出范围时抛出。</li>
<li><code>NegativeArraySizeException</code>  - 如果应用程序试图创建大小为负的数组，则抛出该异常。</li>
<li><code>NullPointerException</code>  - 当应用程序试图在需要对象的地方使用 null 时，抛出该异常</li>
<li><code>NumberFormatException</code>  - 当应用程序试图将字符串转换成一种数值类型，但该字符串不能转换为适当格式时，抛出该异常。</li>
<li><code>SecurityException</code>  - 由安全管理器抛出的异常，指示存在安全侵犯。</li>
<li><code>StringIndexOutOfBoundsException</code>  - 此异常由 String 方法抛出，指示索引或者为负，或者超出字符串的大小。</li>
<li><code>UnsupportedOperationException</code>  - 当不支持请求的操作时，抛出该异常。</li>
</ul>
<h2 id="-128"><a class="markdownIt-Anchor" href="#-128">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-exception.html#_2-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BC%82%E5%B8%B8">#</a>2. 自定义异常</h2>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/1553752795010.png" alt="img"></p>
<p><strong>自定义一个异常类，只需要继承  <code>Exception</code>  或  <code>RuntimeException</code>  即可。</strong></p>
<p>示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyExceptionDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">MyException</span><span class="token punctuation">(</span><span class="token string">"自定义异常"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyException</span> <span class="token keyword">extends</span> <span class="token class-name">RuntimeException</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">public</span> <span class="token class-name">MyException</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">super</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>输出：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Exception in thread "main" io.github.dunwu.javacore.exception.MyExceptionDemo$MyException: 自定义异常
	at io.github.dunwu.javacore.exception.MyExceptionDemo.main(MyExceptionDemo.java:9)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h2 id="-129"><a class="markdownIt-Anchor" href="#-129">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-exception.html#_3-%E6%8A%9B%E5%87%BA%E5%BC%82%E5%B8%B8">#</a>3. 抛出异常</h2>
<p>如果想在程序中明确地抛出异常，需要用到  <code>throw</code>  和  <code>throws</code>  。</p>
<p>如果一个方法没有捕获一个检查性异常，那么该方法必须使用  <code>throws</code>  关键字来声明。 <code>throws</code>  关键字放在方法签名的尾部。</p>
<p><code>throw</code>  示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThrowDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"抛出一个异常"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>输出：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">java.lang.RuntimeException: 抛出一个异常<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>也可以使用  <code>throw</code>  关键字抛出一个异常，无论它是新实例化的还是刚捕获到的。</p>
<p><code>throws</code>  示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThrowsDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">f1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NoSuchMethodException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchFieldException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Field</span> field <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"digits"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>field <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"反射获取 digits 方法成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name">Method</span> method <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"toString"</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>method <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"反射获取 toString 方法成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">f2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 调用 f1 处，如果不用 try catch ，编译时会报错</span>
            <span class="token function">f1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchMethodException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchFieldException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">f2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>输出：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">反射获取 digits 方法成功
java.lang.NoSuchMethodException: java.lang.String.toString(int)
	at java.lang.Class.getMethod(Class.java:1786)
	at io.github.dunwu.javacore.exception.ThrowsDemo.f1(ThrowsDemo.java:12)
	at io.github.dunwu.javacore.exception.ThrowsDemo.f2(ThrowsDemo.java:21)
	at io.github.dunwu.javacore.exception.ThrowsDemo.main(ThrowsDemo.java:30)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>throw 和 throws 的区别：</p>
<ul>
<li>throws 使用在函数上，throw 使用在函数内。</li>
<li>throws 后面跟异常类，可以跟多个，用逗号区别；throw 后面跟的是异常对象。</li>
</ul>
<h2 id="-130"><a class="markdownIt-Anchor" href="#-130">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-exception.html#_4-%E6%8D%95%E8%8E%B7%E5%BC%82%E5%B8%B8">#</a>4. 捕获异常</h2>
<p><strong>使用 try 和 catch 关键字可以捕获异常</strong>。try catch 代码块放在异常可能发生的地方。</p>
<p>它的语法形式如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 可能会发生异常的代码块</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 捕获并处理try抛出的异常类型Exception</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception2</span> e2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 捕获并处理try抛出的异常类型Exception2</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 无论是否发生异常，都将执行的代码块</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此外，JDK7 以后， <code>catch</code>  多种异常时，也可以像下面这样简化代码：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 可能会发生异常的代码块</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> <span class="token operator">|</span> <span class="token class-name">Exception2</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 捕获并处理try抛出的异常类型</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 无论是否发生异常，都将执行的代码块</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><code>try</code>  - <strong> <code>try</code>  语句用于监听。将要被监听的代码 (可能抛出异常的代码) 放在  <code>try</code>  语句块之内，当  <code>try</code>  语句块内发生异常时，异常就被抛出。</strong></li>
<li><code>catch</code>  -  <code>catch</code>  语句包含要捕获异常类型的声明。当保护代码块中发生一个异常时， <code>try</code>  后面的  <code>catch</code>  块就会被检查。</li>
<li><code>finally</code>  - <strong> <code>finally</code>  语句块总是会被执行，无论是否出现异常。</strong> <code>try catch</code>  语句后不一定非要 <code>finally</code>  语句。 <code>finally</code>  常用于这样的场景：由于 <code>finally</code>  语句块总是会被执行，所以那些在  <code>try</code>  代码块中打开的，并且必须回收的物理资源 (如数据库连接、网络连接和文件)，一般会放在 <code>finally</code>  语句块中释放资源。</li>
<li><code>try</code> 、 <code>catch</code> 、 <code>finally</code>  三个代码块中的局部变量不可共享使用。</li>
<li><code>catch</code>  块尝试捕获异常时，是按照  <code>catch</code>  块的声明顺序从上往下寻找的，一旦匹配，就不会再向下执行。因此，如果同一个  <code>try</code>  块下的多个  <code>catch</code>  异常类型有父子关系，应该将子类异常放在前面，父类异常放在后面。</li>
</ul>
<p>示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TryCatchFinallyDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 此处产生了异常</span>
            <span class="token keyword">int</span> temp <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"两个数字相除的结果："</span> <span class="token operator">+</span> temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"----------------------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ArithmeticException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"出现异常了："</span> <span class="token operator">+</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"不管是否出现异常，都执行此代码"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>运行时输出：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">出现异常了：java.lang.ArithmeticException: / by zero
不管是否出现异常，都执行此代码<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h2 id="-131"><a class="markdownIt-Anchor" href="#-131">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-exception.html#_5-%E5%BC%82%E5%B8%B8%E9%93%BE">#</a>5. 异常链</h2>
<p>异常链是以一个异常对象为参数构造新的异常对象，新的异常对象将包含先前异常的信息。</p>
<p>通过使用异常链，我们可以提高代码的可理解性、系统的可维护性和友好性。</p>
<p>我们有两种方式处理异常，一是  <code>throws</code>  抛出交给上级处理，二是  <code>try…catch</code>  做具体处理。 <code>try…catch</code>  的  <code>catch</code>  块我们可以不需要做任何处理，仅仅只用 throw 这个关键字将我们封装异常信息主动抛出来。然后在通过关键字  <code>throws</code>  继续抛出该方法异常。它的上层也可以做这样的处理，以此类推就会产生一条由异常构成的异常链。</p>
<p>【示例】</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExceptionChainDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyException1</span> <span class="token keyword">extends</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">public</span> <span class="token class-name">MyException1</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">super</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyException2</span> <span class="token keyword">extends</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">public</span> <span class="token class-name">MyException2</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> cause<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">super</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> cause<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">f1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">MyException1</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">MyException1</span><span class="token punctuation">(</span><span class="token string">"出现 MyException1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">f2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">MyException2</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token function">f1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">MyException1</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">MyException2</span><span class="token punctuation">(</span><span class="token string">"出现 MyException2"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">MyException2</span> <span class="token punctuation">&#123;</span>
        <span class="token function">f2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>输出：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Exception in thread "main" io.github.dunwu.javacore.exception.ExceptionChainDemo$MyException2: 出现 MyException2
	at io.github.dunwu.javacore.exception.ExceptionChainDemo.f2(ExceptionChainDemo.java:29)
	at io.github.dunwu.javacore.exception.ExceptionChainDemo.main(ExceptionChainDemo.java:34)
Caused by: io.github.dunwu.javacore.exception.ExceptionChainDemo$MyException1: 出现 MyException1
	at io.github.dunwu.javacore.exception.ExceptionChainDemo.f1(ExceptionChainDemo.java:22)
	at io.github.dunwu.javacore.exception.ExceptionChainDemo.f2(ExceptionChainDemo.java:27)
	... 1 more<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>扩展阅读：<a target="_blank" rel="noopener" href="https://juejin.im/post/5b6d61e55188251b38129f9a#heading-10">https://juejin.im/post/5b6d61e55188251b38129f9a#heading-10</a></p>
<p>这篇文章中对于异常链讲解比较详细。</p>
</blockquote>
<h2 id="-132"><a class="markdownIt-Anchor" href="#-132">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-exception.html#_6-%E5%BC%82%E5%B8%B8%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9">#</a>6. 异常注意事项</h2>
<h3 id="-133"><a class="markdownIt-Anchor" href="#-133">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-exception.html#_6-1-finally-%E8%A6%86%E7%9B%96%E5%BC%82%E5%B8%B8">#</a>6.1. finally 覆盖异常</h3>
<p>Java 异常处理中  <code>finally</code>  中的  <code>return</code>  会覆盖  <code>catch</code>  代码块中的  <code>return</code>  语句和  <code>throw</code>  语句，所以 Java <strong>不建议在  <code>finally</code>  中使用  <code>return</code>  语句</strong>。</p>
<p>此外  <code>finally</code>  中的  <code>throw</code>  语句也会覆盖  <code>catch</code>  代码块中的  <code>return</code>  语句和  <code>throw</code>  语句。</p>
<p>示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FinallyOverrideExceptionDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string">"B"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string">"C"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>输出：C</p>
<h3 id="-134"><a class="markdownIt-Anchor" href="#-134">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-exception.html#_6-2-%E8%A6%86%E7%9B%96%E6%8A%9B%E5%87%BA%E5%BC%82%E5%B8%B8%E7%9A%84%E6%96%B9%E6%B3%95">#</a>6.2. 覆盖抛出异常的方法</h3>
<p>当子类重写父类带有  <code>throws</code>  声明的函数时，其  <code>throws</code>  声明的异常必须在父类异常的可控范围内 —— 用于处理父类的  <code>throws</code>  方法的异常处理器，必须也适用于子类的这个带  <code>throws</code>  方法 。这是为了支持多态。</p>
<p>示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExceptionOverrideDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Father</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Son</span> <span class="token keyword">extends</span> <span class="token class-name">Father</span> <span class="token punctuation">&#123;</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SQLException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Father</span> obj1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Father</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Father</span> obj2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Son</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            obj1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            obj2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>上面的示例编译时会报错，原因在于：</p>
<p>因为 Son 类抛出异常的实质是  <code>SQLException</code> ，而  <code>IOException</code>  无法处理它。那么这里的 try catch 就不能处理 Son 中的异常了。多态就不能实现了。</p>
</blockquote>
<h3 id="-135"><a class="markdownIt-Anchor" href="#-135">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-exception.html#_6-3-%E5%BC%82%E5%B8%B8%E5%92%8C%E7%BA%BF%E7%A8%8B">#</a>6.3. 异常和线程</h3>
<p>如果 Java 程序只有一个线程，那么没有被任何代码处理的异常会导致程序终止。如果 Java 程序是多线程的，那么没有被任何代码处理的异常仅仅会导致异常所在的线程结束。</p>
<h2 id="-136"><a class="markdownIt-Anchor" href="#-136">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-exception.html#_7-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">#</a>7. 最佳实践</h2>
<ul>
<li>对可恢复的情况使用检查性异常（Exception），对编程错误使用运行时异常（RuntimeException）。</li>
<li>优先使用 Java 标准的异常。</li>
<li>抛出与抽象相对应的异常。</li>
<li>在细节消息中包含能捕获失败的信息。</li>
<li>尽可能减少 try 代码块的大小。</li>
<li>尽量缩小异常范围。例如，如果明知尝试捕获的是一个  <code>ArithmeticException</code> ，就应该  <code>catch</code>   <code>ArithmeticException</code> ，而不是  <code>catch</code>  范围较大的  <code>RuntimeException</code> ，甚至是  <code>Exception</code> 。</li>
<li>尽量不要在  <code>finally</code>  块抛出异常或者返回值。</li>
<li>不要忽略异常，一旦捕获异常，就应该处理，而非丢弃。</li>
<li>异常处理效率很低，所以不要用异常进行业务逻辑处理。</li>
<li>各类异常必须要有单独的日志记录，将异常分级，分类管理，因为有的时候仅仅想给第三方运维看到逻辑异常，而不是更细节的信息。</li>
<li>如何对异常进行分类：
<ul>
<li>逻辑异常，这类异常用于描述业务无法按照预期的情况处理下去，属于用户制造的意外。</li>
<li>代码错误，这类异常用于描述开发的代码错误，例如 NPE，ILLARG，都属于程序员制造的 BUG。</li>
<li>专有异常，多用于特定业务场景，用于描述指定作业出现意外情况无法预先处理。</li>
</ul>
</li>
</ul>
<hr>
<h1 id="深入理解-java-泛型"><a class="markdownIt-Anchor" href="#深入理解-java-泛型">#</a> 深入理解 Java 泛型</h1>
<blockquote>
<p><strong>📦 本文以及示例源码已归档在 <a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/">javacore(opens new window)</a></strong></p>
</blockquote>
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-generic.html#1-%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E6%B3%9B%E5%9E%8B">1. 为什么需要泛型</a></li>
<li>\2. 泛型类型
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-generic.html#21-%E6%B3%9B%E5%9E%8B%E7%B1%BB">2.1. 泛型类</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-generic.html#22-%E6%B3%9B%E5%9E%8B%E6%8E%A5%E5%8F%A3">2.2. 泛型接口</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-generic.html#3-%E6%B3%9B%E5%9E%8B%E6%96%B9%E6%B3%95">3. 泛型方法</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-generic.html#4-%E7%B1%BB%E5%9E%8B%E6%93%A6%E9%99%A4">4. 类型擦除</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-generic.html#5-%E6%B3%9B%E5%9E%8B%E5%92%8C%E7%BB%A7%E6%89%BF">5. 泛型和继承</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-generic.html#6-%E7%B1%BB%E5%9E%8B%E8%BE%B9%E7%95%8C">6. 类型边界</a></li>
<li>\7. 类型通配符
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-generic.html#71-%E4%B8%8A%E7%95%8C%E9%80%9A%E9%85%8D%E7%AC%A6">7.1. 上界通配符</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-generic.html#72-%E4%B8%8B%E7%95%8C%E9%80%9A%E9%85%8D%E7%AC%A6">7.2. 下界通配符</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-generic.html#73-%E6%97%A0%E7%95%8C%E9%80%9A%E9%85%8D%E7%AC%A6">7.3. 无界通配符</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-generic.html#74-%E9%80%9A%E9%85%8D%E7%AC%A6%E5%92%8C%E5%90%91%E4%B8%8A%E8%BD%AC%E5%9E%8B">7.4. 通配符和向上转型</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-generic.html#8-%E6%B3%9B%E5%9E%8B%E7%9A%84%E7%BA%A6%E6%9D%9F">8. 泛型的约束</a></li>
<li>\9. 泛型最佳实践
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-generic.html#91-%E6%B3%9B%E5%9E%8B%E5%91%BD%E5%90%8D">9.1. 泛型命名</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-generic.html#92-%E4%BD%BF%E7%94%A8%E6%B3%9B%E5%9E%8B%E7%9A%84%E5%BB%BA%E8%AE%AE">9.2. 使用泛型的建议</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-generic.html#10-%E5%B0%8F%E7%BB%93">10. 小结</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-generic.html#11-%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">11. 参考资料</a></li>
</ul>
<h2 id="-137"><a class="markdownIt-Anchor" href="#-137">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-generic.html#_1-%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E6%B3%9B%E5%9E%8B">#</a>1. 为什么需要泛型</h2>
<p><strong>JDK5 引入了泛型机制</strong>。</p>
<p>为什么需要泛型呢？回答这个问题前，先让我们来看一个示例。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NoGenericsDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">List</span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"abc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">double</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> obj1 <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> obj2 <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> obj3 <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"obj1 = ["</span> <span class="token operator">+</span> obj1 <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"obj2 = ["</span> <span class="token operator">+</span> obj2 <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"obj3 = ["</span> <span class="token operator">+</span> obj3 <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">int</span> num1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> num2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> num3 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"num1 = ["</span> <span class="token operator">+</span> num1 <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"num2 = ["</span> <span class="token operator">+</span> num2 <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"num3 = ["</span> <span class="token operator">+</span> num3 <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// Output:</span>
<span class="token comment">// obj1 = [abc]</span>
<span class="token comment">// obj2 = [18]</span>
<span class="token comment">// obj3 = [[D@47089e5f]</span>
<span class="token comment">// Exception in thread "main" java.lang.ClassCastException: java.lang.String cannot be cast to java.lang.Integer</span>
<span class="token comment">// at io.github.dunwu.javacore.generics.NoGenericsDemo.main(NoGenericsDemo.java:23)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>示例说明：</p>
<p>在上面的示例中， <code>List</code>  容器没有指定存储数据类型，这种情况下，可以向  <code>List</code>  添加任意类型数据，编译器不会做类型检查，而是默默的将所有数据都转为  <code>Object</code> 。</p>
<p>假设，最初我们希望向  <code>List</code>  存储的是整形数据，假设，某个家伙不小心存入了其他数据类型。当你试图从容器中取整形数据时，由于  <code>List</code>  当成  <code>Object</code>  类型来存储，你不得不使用类型强制转换。在运行时，才会发现  <code>List</code>  中数据不存储一致的问题，这就为程序运行带来了很大的风险（无形伤害最为致命）。</p>
</blockquote>
<p>而泛型的出现，解决了类型安全问题。</p>
<p>泛型具有以下优点：</p>
<ul>
<li><strong>编译时的强类型检查</strong></li>
</ul>
<p>泛型要求在声明时指定实际数据类型，Java 编译器在编译时会对泛型代码做强类型检查，并在代码违反类型安全时发出告警。早发现，早治理，把隐患扼杀于摇篮，在编译时发现并修复错误所付出的代价远比在运行时小。</p>
<ul>
<li><strong>避免了类型转换</strong></li>
</ul>
<p>未使用泛型：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">List</span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>使用泛型：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> s <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// no cast</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<ul>
<li><strong>泛型编程可以实现通用算法</strong></li>
</ul>
<p>通过使用泛型，程序员可以实现通用算法，这些算法可以处理不同类型的集合，可以自定义，并且类型安全且易于阅读。</p>
<h2 id="-138"><a class="markdownIt-Anchor" href="#-138">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-generic.html#_2-%E6%B3%9B%E5%9E%8B%E7%B1%BB%E5%9E%8B">#</a>2. 泛型类型</h2>
<p><strong> <code>泛型类型</code> 是被参数化的类或接口。</strong></p>
<h3 id="-139"><a class="markdownIt-Anchor" href="#-139">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-generic.html#_2-1-%E6%B3%9B%E5%9E%8B%E7%B1%BB">#</a>2.1. 泛型类</h3>
<p>泛型类的语法形式：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> name<span class="token generics"><span class="token punctuation">&lt;</span>T1<span class="token punctuation">,</span> T2<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token class-name">Tn</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span> <span class="token comment">/* ... */</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>泛型类的声明和非泛型类的声明类似，除了在类名后面添加了类型参数声明部分。由尖括号（ <code>&lt;&gt;</code> ）分隔的类型参数部分跟在类名后面。它指定类型参数（也称为类型变量）T1，T2，… 和 Tn。</p>
<p>一般将泛型中的类名称为<strong>原型</strong>，而将  <code>&lt;&gt;</code>  指定的参数称为<strong>类型参数</strong>。</p>
<ul>
<li>未应用泛型的类</li>
</ul>
<p>在泛型出现之前，如果一个类想持有一个可以为任意类型的数据，只能使用  <code>Object</code>  做类型转换。示例如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Info</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">private</span> <span class="token class-name">Object</span> value<span class="token punctuation">;</span>

	<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> value<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setValue</span><span class="token punctuation">(</span><span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>单类型参数的泛型类</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Info</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token class-name">T</span> value<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Info</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">Info</span><span class="token punctuation">(</span><span class="token class-name">T</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setValue</span><span class="token punctuation">(</span><span class="token class-name">T</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token string">"Info&#123;"</span> <span class="token operator">+</span> <span class="token string">"value="</span> <span class="token operator">+</span> value <span class="token operator">+</span> <span class="token string">'&#125;'</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GenericsClassDemo01</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Info</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> info <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Info</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        info<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Info</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> info2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Info</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        info2<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span><span class="token string">"xyz"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>info2<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// Output:</span>
<span class="token comment">// 10</span>
<span class="token comment">// xyz</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在上面的例子中，在初始化一个泛型类时，使用  <code>&lt;&gt;</code>  指定了内部具体类型，在编译时就会根据这个类型做强类型检查。</p>
<p>实际上，不使用  <code>&lt;&gt;</code>  指定内部具体类型，语法上也是支持的（不推荐这么做），如下所示：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Info</span> info <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    info<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    info<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span><span class="token string">"abc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>示例说明：</p>
<p>上面的例子，不会产生编译错误，也能正常运行。但这样的调用就失去泛型类型的优势。</p>
</blockquote>
<ul>
<li>多个类型参数的泛型类</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token class-name">K</span> key<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">V</span> value<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">MyMap</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> key<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token string">"MyMap&#123;"</span> <span class="token operator">+</span> <span class="token string">"key="</span> <span class="token operator">+</span> key <span class="token operator">+</span> <span class="token string">", value="</span> <span class="token operator">+</span> value <span class="token operator">+</span> <span class="token string">'&#125;'</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GenericsClassDemo02</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">MyMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"one"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// Output:</span>
<span class="token comment">// MyMap&#123;key=1, value=one&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>泛型类的类型嵌套</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GenericsClassDemo03</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Info</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> info <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Info</span><span class="token punctuation">(</span><span class="token string">"Hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MyMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Info</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span><span class="token punctuation">></span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// Output:</span>
<span class="token comment">// MyMap&#123;key=1, value=Info&#123;value=Hello&#125;&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-140"><a class="markdownIt-Anchor" href="#-140">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-generic.html#_2-2-%E6%B3%9B%E5%9E%8B%E6%8E%A5%E5%8F%A3">#</a>2.2. 泛型接口</h3>
<p>接口也可以声明泛型。</p>
<p>泛型接口语法形式：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Content</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">T</span> <span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>泛型接口有两种实现方式：</p>
<ul>
<li>实现接口的子类明确声明泛型类型</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GenericsInterfaceDemo01</span> <span class="token keyword">implements</span> <span class="token class-name">Content</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> text<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">GenericsInterfaceDemo01</span><span class="token punctuation">(</span><span class="token keyword">int</span> text<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>text <span class="token operator">=</span> text<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> text<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">GenericsInterfaceDemo01</span> demo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GenericsInterfaceDemo01</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>demo<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// Output:</span>
<span class="token comment">// 10</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>实现接口的子类不明确声明泛型类型</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GenericsInterfaceDemo02</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token keyword">implements</span> <span class="token class-name">Content</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token class-name">T</span> text<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">GenericsInterfaceDemo02</span><span class="token punctuation">(</span><span class="token class-name">T</span> text<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>text <span class="token operator">=</span> text<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> text<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">GenericsInterfaceDemo02</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> gen <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GenericsInterfaceDemo02</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token string">"ABC"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>gen<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// Output:</span>
<span class="token comment">// ABC</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="-141"><a class="markdownIt-Anchor" href="#-141">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-generic.html#_3-%E6%B3%9B%E5%9E%8B%E6%96%B9%E6%B3%95">#</a>3. 泛型方法</h2>
<p>泛型方法是引入其自己的类型参数的方法。泛型方法可以是普通方法、静态方法以及构造方法。</p>
<p>泛型方法语法形式如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">T</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token class-name">T</span> obj<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><strong>是否拥有泛型方法，与其所在的类是否是泛型没有关系。</strong></p>
<p>泛型方法的语法包括一个类型参数列表，在尖括号内，它出现在方法的返回类型之前。对于静态泛型方法，类型参数部分必须出现在方法的返回类型之前。类型参数能被用来声明返回值类型，并且能作为泛型方法得到的实际类型参数的占位符。</p>
<p><strong>使用泛型方法的时候，通常不必指明类型参数，因为编译器会为我们找出具体的类型。这称为类型参数推断（type argument inference）。类型推断只对赋值操作有效，其他时候并不起作用</strong>。如果将一个返回类型为 T 的泛型方法调用的结果作为参数，传递给另一个方法，这时编译器并不会执行推断。编译器会认为：调用泛型方法后，其返回值被赋给一个 Object 类型的变量。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GenericsMethodDemo01</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token keyword">void</span> <span class="token function">printClass</span><span class="token punctuation">(</span><span class="token class-name">T</span> obj<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">printClass</span><span class="token punctuation">(</span><span class="token string">"abc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printClass</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// Output:</span>
<span class="token comment">// class java.lang.String</span>
<span class="token comment">// class java.lang.Integer</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>泛型方法中也可以使用可变参数列表</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GenericVarargsMethodDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">makeList</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> ls <span class="token operator">=</span> <span class="token function">makeList</span><span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>ls<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ls <span class="token operator">=</span> <span class="token function">makeList</span><span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">,</span> <span class="token string">"B"</span><span class="token punctuation">,</span> <span class="token string">"C"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>ls<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// Output:</span>
<span class="token comment">// [A]</span>
<span class="token comment">// [A, B, C]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="-142"><a class="markdownIt-Anchor" href="#-142">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-generic.html#_4-%E7%B1%BB%E5%9E%8B%E6%93%A6%E9%99%A4">#</a>4. 类型擦除</h2>
<p>Java 语言引入泛型是为了在编译时提供更严格的类型检查，并支持泛型编程。不同于 C++ 的模板机制，<strong>Java 泛型是使用类型擦除来实现的，使用泛型时，任何具体的类型信息都被擦除了</strong>。</p>
<p>那么，类型擦除做了什么呢？它做了以下工作：</p>
<ul>
<li>把泛型中的所有类型参数替换为 Object，如果指定类型边界，则使用类型边界来替换。因此，生成的字节码仅包含普通的类，接口和方法。</li>
<li>擦除出现的类型声明，即去掉  <code>&lt;&gt;</code>  的内容。比如  <code>T get()</code>  方法声明就变成了  <code>Object get()</code>  ； <code>List&lt;String&gt;</code>  就变成了  <code>List</code> 。如有必要，插入类型转换以保持类型安全。</li>
<li>生成桥接方法以保留扩展泛型类型中的多态性。类型擦除确保不为参数化类型创建新类；因此，泛型不会产生运行时开销。</li>
</ul>
<p>让我们来看一个示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GenericsErasureTypeDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> list1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> list2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>list1<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>list2<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// Output:</span>
<span class="token comment">// class java.util.ArrayList</span>
<span class="token comment">// class java.util.ArrayList</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>示例说明：</p>
<p>上面的例子中，虽然指定了不同的类型参数，但是 list1 和 list2 的类信息却是一样的。</p>
<p>这是因为：<strong>使用泛型时，任何具体的类型信息都被擦除了</strong>。这意味着： <code>ArrayList&lt;Object&gt;</code>  和  <code>ArrayList&lt;String&gt;</code>  在运行时，JVM 将它们视为同一类型。</p>
</blockquote>
<p>Java 泛型的实现方式不太优雅，但这是因为泛型是在 JDK5 时引入的，为了兼容老代码，必须在设计上做一定的折中。</p>
<h2 id="-143"><a class="markdownIt-Anchor" href="#-143">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-generic.html#_5-%E6%B3%9B%E5%9E%8B%E5%92%8C%E7%BB%A7%E6%89%BF">#</a>5. 泛型和继承</h2>
<p><strong>泛型不能用于显式地引用运行时类型的操作之中，例如：转型、instanceof 操作和 new 表达式。因为所有关于参数的类型信息都丢失了</strong>。当你在编写泛型代码时，必须时刻提醒自己，你只是看起来好像拥有有关参数的类型信息而已。</p>
<p>正是由于泛型时基于类型擦除实现的，所以，<strong>泛型类型无法向上转型</strong>。</p>
<blockquote>
<p>向上转型是指用子类实例去初始化父类，这是面向对象中多态的重要表现。</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/1553147778883.png" alt="img"></p>
<p><code>Integer</code>  继承了  <code>Object</code> ； <code>ArrayList</code>  继承了  <code>List</code> ；但是  <code>List&lt;Interger&gt;</code>  却并非继承了  <code>List&lt;Object&gt;</code> 。</p>
<p>这是因为，泛型类并没有自己独有的  <code>Class</code>  类对象。比如：并不存在  <code>List&lt;Object&gt;.class</code>  或是  <code>List&lt;Interger&gt;.class</code> ，Java 编译器会将二者都视为  <code>List.class</code> 。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> list2 <span class="token operator">=</span> list<span class="token punctuation">;</span> <span class="token comment">// Erorr</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h2 id="-144"><a class="markdownIt-Anchor" href="#-144">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-generic.html#_6-%E7%B1%BB%E5%9E%8B%E8%BE%B9%E7%95%8C">#</a>6. 类型边界</h2>
<p>有时您可能希望限制可在参数化类型中用作类型参数的类型。<strong> <code>类型边界</code> 可以对泛型的类型参数设置限制条件</strong>。例如，对数字进行操作的方法可能只想接受  <code>Number</code>  或其子类的实例。</p>
<p>要声明有界类型参数，请列出类型参数的名称，然后是  <code>extends</code>  关键字，后跟其限制类或接口。</p>
<p>类型边界的语法形式如下：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">&lt;T extends XXX><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GenericsExtendsDemo01</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">Comparable</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token class-name">T</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token class-name">T</span> x<span class="token punctuation">,</span> <span class="token class-name">T</span> y<span class="token punctuation">,</span> <span class="token class-name">T</span> z<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">T</span> max <span class="token operator">=</span> x<span class="token punctuation">;</span> <span class="token comment">// 假设x是初始最大值</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            max <span class="token operator">=</span> y<span class="token punctuation">;</span> <span class="token comment">//y 更大</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>z<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            max <span class="token operator">=</span> z<span class="token punctuation">;</span> <span class="token comment">// 现在 z 更大</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> max<span class="token punctuation">;</span> <span class="token comment">// 返回最大对象</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">6.6</span><span class="token punctuation">,</span> <span class="token number">8.8</span><span class="token punctuation">,</span> <span class="token number">7.7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token string">"pear"</span><span class="token punctuation">,</span> <span class="token string">"apple"</span><span class="token punctuation">,</span> <span class="token string">"orange"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// Output:</span>
<span class="token comment">// 5</span>
<span class="token comment">// 8.8</span>
<span class="token comment">// pear</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>示例说明：</p>
<p>上面的示例声明了一个泛型方法，类型参数  <code>T extends Comparable&lt;T&gt;</code>  表明传入方法中的类型必须实现了 Comparable 接口。</p>
</blockquote>
<p>类型边界可以设置多个，语法形式如下：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">&lt;T extends B1 &amp; B2 &amp; B3><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<blockquote>
<p>🔔 注意：extends 关键字后面的第一个类型参数可以是类或接口，其他类型参数只能是接口。</p>
</blockquote>
<p>示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GenericsExtendsDemo02</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* ... */</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">interface</span> <span class="token class-name">B</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* ... */</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">interface</span> <span class="token class-name">C</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* ... */</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> D1 <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">A</span> <span class="token operator">&amp;</span> <span class="token class-name">B</span> <span class="token operator">&amp;</span> <span class="token class-name">C</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span> <span class="token comment">/* ... */</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> D2 <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">B</span> <span class="token operator">&amp;</span> <span class="token class-name">A</span> <span class="token operator">&amp;</span> <span class="token class-name">C</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span> <span class="token comment">/* ... */</span> <span class="token punctuation">&#125;</span> <span class="token comment">// 编译报错</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">E</span> <span class="token keyword">extends</span> <span class="token class-name">A</span> <span class="token keyword">implements</span> <span class="token class-name">B</span><span class="token punctuation">,</span> <span class="token class-name">C</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* ... */</span> <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        D1<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> demo1 <span class="token operator">=</span> <span class="token keyword">new</span> D1<span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>demo1<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        D1<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> demo2 <span class="token operator">=</span> <span class="token keyword">new</span> D1<span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 编译报错</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="-145"><a class="markdownIt-Anchor" href="#-145">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-generic.html#_7-%E7%B1%BB%E5%9E%8B%E9%80%9A%E9%85%8D%E7%AC%A6">#</a>7. 类型通配符</h2>
<p><code>类型通配符</code> 一般是使用  <code>?</code>  代替具体的类型参数。例如  <code>List&lt;?&gt;</code>  在逻辑上是  <code>List&lt;String&gt;</code>  ， <code>List&lt;Integer&gt;</code>  等所有  <code>List&lt;具体类型实参&gt;</code>  的父类。</p>
<h3 id="-146"><a class="markdownIt-Anchor" href="#-146">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-generic.html#_7-1-%E4%B8%8A%E7%95%8C%E9%80%9A%E9%85%8D%E7%AC%A6">#</a>7.1. 上界通配符</h3>
<p>可以使用 ** <code>上界通配符</code>  ** 来缩小类型参数的类型范围。</p>
<p>它的语法形式为： <code>&lt;? extends Number&gt;</code></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GenericsUpperBoundedWildcardDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">double</span> <span class="token function">sumOfList</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Number</span><span class="token punctuation">></span></span> list<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">double</span> s <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Number</span> n <span class="token operator">:</span> list<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            s <span class="token operator">+=</span> n<span class="token punctuation">.</span><span class="token function">doubleValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> s<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> li <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"sum = "</span> <span class="token operator">+</span> <span class="token function">sumOfList</span><span class="token punctuation">(</span>li<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// Output:</span>
<span class="token comment">// sum = 6.0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-147"><a class="markdownIt-Anchor" href="#-147">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-generic.html#_7-2-%E4%B8%8B%E7%95%8C%E9%80%9A%E9%85%8D%E7%AC%A6">#</a>7.2. 下界通配符</h3>
<p>** <code>下界通配符</code>  ** 将未知类型限制为该类型的特定类型或超类类型。</p>
<blockquote>
<p>🔔 注意：<strong>上界通配符和下界通配符不能同时使用</strong>。</p>
</blockquote>
<p>它的语法形式为： <code>&lt;? super Number&gt;</code></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GenericsLowerBoundedWildcardDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">addNumbers</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">Integer</span><span class="token punctuation">></span></span> list<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">addNumbers</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">deepToString</span><span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// Output:</span>
<span class="token comment">// [1, 2, 3, 4, 5]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-148"><a class="markdownIt-Anchor" href="#-148">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-generic.html#_7-3-%E6%97%A0%E7%95%8C%E9%80%9A%E9%85%8D%E7%AC%A6">#</a>7.3. 无界通配符</h3>
<p>无界通配符有两种应用场景：</p>
<ul>
<li>可以使用 Object 类中提供的功能来实现的方法。</li>
<li>使用不依赖于类型参数的泛型类中的方法。</li>
</ul>
<p>语法形式： <code>&lt;?&gt;</code></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GenericsUnboundedWildcardDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">printList</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> list<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Object</span> elem <span class="token operator">:</span> list<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>elem <span class="token operator">+</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> li <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> ls <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"one"</span><span class="token punctuation">,</span> <span class="token string">"two"</span><span class="token punctuation">,</span> <span class="token string">"three"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printList</span><span class="token punctuation">(</span>li<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printList</span><span class="token punctuation">(</span>ls<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// Output:</span>
<span class="token comment">// 1 2 3</span>
<span class="token comment">// one two three</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-149"><a class="markdownIt-Anchor" href="#-149">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-generic.html#_7-4-%E9%80%9A%E9%85%8D%E7%AC%A6%E5%92%8C%E5%90%91%E4%B8%8A%E8%BD%AC%E5%9E%8B">#</a>7.4. 通配符和向上转型</h3>
<p>前面，我们提到：<strong>泛型不能向上转型。但是，我们可以通过使用通配符来向上转型</strong>。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GenericsWildcardDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> intList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Number</span><span class="token punctuation">></span></span> numList <span class="token operator">=</span> intList<span class="token punctuation">;</span>  <span class="token comment">// Error</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Integer</span><span class="token punctuation">></span></span> intList2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Number</span><span class="token punctuation">></span></span> numList2 <span class="token operator">=</span> intList2<span class="token punctuation">;</span>  <span class="token comment">// OK</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>扩展阅读：<a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/tutorial/java/generics/index.html">Oracle 泛型文档 (opens new window)</a></p>
</blockquote>
<h2 id="-150"><a class="markdownIt-Anchor" href="#-150">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-generic.html#_8-%E6%B3%9B%E5%9E%8B%E7%9A%84%E7%BA%A6%E6%9D%9F">#</a>8. 泛型的约束</h2>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/tutorial/java/generics/restrictions.html#instantiate">泛型类型的类型参数不能是值类型 (opens new window)</a></li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Pair</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token punctuation">></span></span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Pair</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 编译错误</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/tutorial/java/generics/restrictions.html#createObjects">不能创建类型参数的实例 (opens new window)</a></li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token keyword">void</span> <span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> list<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">E</span> elem <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">E</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 编译错误</span>
    list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>elem<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/tutorial/java/generics/restrictions.html#createStatic">不能声明类型为类型参数的静态成员 (opens new window)</a></li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MobileDevice</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">T</span> os<span class="token punctuation">;</span> <span class="token comment">// error</span>

    <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/tutorial/java/generics/restrictions.html#cannotCast">类型参数不能使用类型转换或  <code>instanceof</code> (opens new window)</a></li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token keyword">void</span> <span class="token function">rtti</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> list<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>list <span class="token keyword">instanceof</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// 编译错误</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> li <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Number</span><span class="token punctuation">></span></span>  ln <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Number</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> li<span class="token punctuation">;</span>  <span class="token comment">// 编译错误</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/tutorial/java/generics/restrictions.html#createArrays">不能创建类型参数的数组 (opens new window)</a></li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> arrayOfLists <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 编译错误</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/tutorial/java/generics/restrictions.html#cannotCatch">不能创建、catch 或 throw 参数化类型对象 (opens new window)</a></li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// Extends Throwable indirectly</span>
<span class="token keyword">class</span> <span class="token class-name">MathException</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* ... */</span> <span class="token punctuation">&#125;</span>    <span class="token comment">// 编译错误</span>

<span class="token comment">// Extends Throwable directly</span>
<span class="token keyword">class</span> <span class="token class-name">QueueFullException</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* ... */</span> <span class="token comment">// 编译错误</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">Exception</span><span class="token punctuation">,</span> <span class="token class-name">J</span><span class="token punctuation">></span></span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">J</span><span class="token punctuation">></span></span> jobs<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">J</span> job <span class="token operator">:</span> jobs<span class="token punctuation">)</span>
            <span class="token comment">// ...</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">T</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token comment">// compile-time error</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/tutorial/java/generics/restrictions.html#cannotOverload">仅仅是泛型类相同，而类型参数不同的方法不能重载 (opens new window)</a></li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Example</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> strSet<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> intSet<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span> <span class="token comment">// 编译错误</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="-151"><a class="markdownIt-Anchor" href="#-151">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-generic.html#_9-%E6%B3%9B%E5%9E%8B%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">#</a>9. 泛型最佳实践</h2>
<h3 id="-152"><a class="markdownIt-Anchor" href="#-152">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-generic.html#_9-1-%E6%B3%9B%E5%9E%8B%E5%91%BD%E5%90%8D">#</a>9.1. 泛型命名</h3>
<p>泛型一些约定俗成的命名：</p>
<ul>
<li>E - Element</li>
<li>K - Key</li>
<li>N - Number</li>
<li>T - Type</li>
<li>V - Value</li>
<li>S,U,V etc. - 2nd, 3rd, 4th types</li>
</ul>
<h3 id="-153"><a class="markdownIt-Anchor" href="#-153">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-generic.html#_9-2-%E4%BD%BF%E7%94%A8%E6%B3%9B%E5%9E%8B%E7%9A%84%E5%BB%BA%E8%AE%AE">#</a>9.2. 使用泛型的建议</h3>
<ul>
<li>消除类型检查告警</li>
<li>List 优先于数组</li>
<li>优先考虑使用泛型来提高代码通用性</li>
<li>优先考虑泛型方法来限定泛型的范围</li>
<li>利用有限制通配符来提升 API 的灵活性</li>
<li>优先考虑类型安全的异构容器</li>
</ul>
<h2 id="-154"><a class="markdownIt-Anchor" href="#-154">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-generic.html#_10-%E5%B0%8F%E7%BB%93">#</a>10. 小结</h2>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/cs/java/javacore/xmind/Java%E6%B3%9B%E5%9E%8B.svg" alt="img"></p>
<hr>
<h1 id="深入理解-java-反射和动态代理"><a class="markdownIt-Anchor" href="#深入理解-java-反射和动态代理">#</a> 深入理解 Java 反射和动态代理</h1>
<blockquote>
<p><strong>📦 本文以及示例源码已归档在 <a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/">javacore(opens new window)</a></strong></p>
</blockquote>
<ul>
<li>\1. 反射简介
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-reflection.html#11-%E4%BB%80%E4%B9%88%E6%98%AF%E5%8F%8D%E5%B0%84">1.1. 什么是反射</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-reflection.html#12-%E5%8F%8D%E5%B0%84%E7%9A%84%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF">1.2. 反射的应用场景</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-reflection.html#13-%E5%8F%8D%E5%B0%84%E7%9A%84%E7%BC%BA%E7%82%B9">1.3. 反射的缺点</a></li>
</ul>
</li>
<li>\2. 反射机制
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-reflection.html#21-%E7%B1%BB%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B">2.1. 类加载过程</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-reflection.html#22-class-%E5%AF%B9%E8%B1%A1">2.2. Class 对象</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-reflection.html#23-%E6%96%B9%E6%B3%95%E7%9A%84%E5%8F%8D%E5%B0%84%E8%B0%83%E7%94%A8">2.3. 方法的反射调用</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-reflection.html#24-%E5%8F%8D%E5%B0%84%E8%B0%83%E7%94%A8%E7%9A%84%E5%BC%80%E9%94%80">2.4. 反射调用的开销</a></li>
</ul>
</li>
<li>\3. 使用反射
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-reflection.html#31-javalangreflect-%E5%8C%85">3.1. java.lang.reflect 包</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-reflection.html#32-%E8%8E%B7%E5%8F%96-class-%E5%AF%B9%E8%B1%A1">3.2. 获取 Class 对象</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-reflection.html#33-%E5%88%A4%E6%96%AD%E6%98%AF%E5%90%A6%E4%B8%BA%E6%9F%90%E4%B8%AA%E7%B1%BB%E7%9A%84%E5%AE%9E%E4%BE%8B">3.3. 判断是否为某个类的实例</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-reflection.html#34-%E5%88%9B%E5%BB%BA%E5%AE%9E%E4%BE%8B">3.4. 创建实例</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-reflection.html#35-%E5%88%9B%E5%BB%BA%E6%95%B0%E7%BB%84%E5%AE%9E%E4%BE%8B">3.5. 创建数组实例</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-reflection.html#36-field">3.6. Field</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-reflection.html#37-method">3.7. Method</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-reflection.html#38-constructor">3.8. Constructor</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-reflection.html#39-%E7%BB%95%E5%BC%80%E8%AE%BF%E9%97%AE%E9%99%90%E5%88%B6">3.9. 绕开访问限制</a></li>
</ul>
</li>
<li>\4. 动态代理
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-reflection.html#41-%E9%9D%99%E6%80%81%E4%BB%A3%E7%90%86">4.1. 静态代理</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-reflection.html#42-jdk-%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86">4.2. JDK 动态代理</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-reflection.html#43-cglib-%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86">4.3. CGLIB 动态代理</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-reflection.html#5-%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">5. 参考资料</a></li>
</ul>
<h2 id="-155"><a class="markdownIt-Anchor" href="#-155">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-reflection.html#_1-%E5%8F%8D%E5%B0%84%E7%AE%80%E4%BB%8B">#</a>1. 反射简介</h2>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/cs/java/javacore/xmind/Java%E5%8F%8D%E5%B0%84.svg" alt="img"></p>
<h3 id="-156"><a class="markdownIt-Anchor" href="#-156">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-reflection.html#_1-1-%E4%BB%80%E4%B9%88%E6%98%AF%E5%8F%8D%E5%B0%84">#</a>1.1. 什么是反射</h3>
<p>反射 (Reflection) 是 Java 程序开发语言的特征之一，它允许运行中的 Java 程序获取自身的信息，并且可以操作类或对象的内部属性。</p>
<p><strong>通过反射机制，可以在运行时访问 Java 对象的属性，方法，构造方法等。</strong></p>
<h3 id="-157"><a class="markdownIt-Anchor" href="#-157">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-reflection.html#_1-2-%E5%8F%8D%E5%B0%84%E7%9A%84%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF">#</a>1.2. 反射的应用场景</h3>
<p>反射的主要应用场景有：</p>
<ul>
<li><strong>开发通用框架</strong> - 反射最重要的用途就是开发各种通用框架。很多框架（比如 Spring）都是配置化的（比如通过 XML 文件配置 JavaBean、Filter 等），为了保证框架的通用性，它们可能需要根据配置文件加载不同的对象或类，调用不同的方法，这个时候就必须用到反射 —— 运行时动态加载需要加载的对象。</li>
<li><strong>动态代理</strong> - 在切面编程（AOP）中，需要拦截特定的方法，通常，会选择动态代理方式。这时，就需要反射技术来实现了。</li>
<li><strong>注解</strong> - 注解本身仅仅是起到标记作用，它需要利用反射机制，根据注解标记去调用注解解释器，执行行为。如果没有反射机制，注解并不比注释更有用。</li>
<li><strong>可扩展性功能</strong> - 应用程序可以通过使用完全限定名称创建可扩展性对象实例来使用外部的用户定义类。</li>
</ul>
<h3 id="-158"><a class="markdownIt-Anchor" href="#-158">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-reflection.html#_1-3-%E5%8F%8D%E5%B0%84%E7%9A%84%E7%BC%BA%E7%82%B9">#</a>1.3. 反射的缺点</h3>
<ul>
<li><strong>性能开销</strong> - 由于反射涉及动态解析的类型，因此无法执行某些 Java 虚拟机优化。因此，反射操作的性能要比非反射操作的性能要差，应该在性能敏感的应用程序中频繁调用的代码段中避免。</li>
<li><strong>破坏封装性</strong> - 反射调用方法时可以忽略权限检查，因此可能会破坏封装性而导致安全问题。</li>
<li><strong>内部曝光</strong> - 由于反射允许代码执行在非反射代码中非法的操作，例如访问私有字段和方法，所以反射的使用可能会导致意想不到的副作用，这可能会导致代码功能失常并可能破坏可移植性。反射代码打破了抽象，因此可能会随着平台的升级而改变行为。</li>
</ul>
<h2 id="-159"><a class="markdownIt-Anchor" href="#-159">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-reflection.html#_2-%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6">#</a>2. 反射机制</h2>
<h3 id="-160"><a class="markdownIt-Anchor" href="#-160">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-reflection.html#_2-1-%E7%B1%BB%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B">#</a>2.1. 类加载过程</h3>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/1553611895164.png" alt="img"></p>
<p>类加载的完整过程如下：</p>
<ol>
<li>在编译时，Java 编译器编译好  <code>.java</code>  文件之后，在磁盘中产生  <code>.class</code>  文件。 <code>.class</code>  文件是二进制文件，内容是只有 JVM 能够识别的机器码。</li>
<li>JVM 中的类加载器读取字节码文件，取出二进制数据，加载到内存中，解析.class 文件内的信息。类加载器会根据类的全限定名来获取此类的二进制字节流；然后，将字节流所代表的静态存储结构转化为方法区的运行时数据结构；接着，在内存中生成代表这个类的  <code>java.lang.Class</code>  对象。</li>
<li>加载结束后，JVM 开始进行连接阶段（包含验证、准备、初始化）。经过这一系列操作，类的变量会被初始化。</li>
</ol>
<h3 id="-161"><a class="markdownIt-Anchor" href="#-161">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-reflection.html#_2-2-class-%E5%AF%B9%E8%B1%A1">#</a>2.2. Class 对象</h3>
<p>要想使用反射，首先需要获得待操作的类所对应的 Class 对象。<strong>Java 中，无论生成某个类的多少个对象，这些对象都会对应于同一个 Class 对象。这个 Class 对象是由 JVM 生成的，通过它能够获悉整个类的结构</strong>。所以， <code>java.lang.Class</code>  可以视为所有反射 API 的入口点。</p>
<p><strong>反射的本质就是：在运行时，把 Java 类中的各种成分映射成一个个的 Java 对象。</strong></p>
<p>举例来说，假如定义了以下代码：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>步骤说明：</p>
<ol>
<li>JVM 加载方法的时候，遇到  <code>new User()</code> ，JVM 会根据  <code>User</code>  的全限定名去加载  <code>User.class</code>  。</li>
<li>JVM 会去本地磁盘查找  <code>User.class</code>  文件并加载 JVM 内存中。</li>
<li>JVM 通过调用类加载器自动创建这个类对应的  <code>Class</code>  对象，并且存储在 JVM 的方法区。注意：<strong>一个类有且只有一个  <code>Class</code>  对象</strong>。</li>
</ol>
<h3 id="-162"><a class="markdownIt-Anchor" href="#-162">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-reflection.html#_2-3-%E6%96%B9%E6%B3%95%E7%9A%84%E5%8F%8D%E5%B0%84%E8%B0%83%E7%94%A8">#</a>2.3. 方法的反射调用</h3>
<p>方法的反射调用，也就是  <code>Method.invoke</code>  方法。</p>
<p><code>Method.invoke</code>  方法源码：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Method</span> <span class="token keyword">extends</span> <span class="token class-name">Executable</span> <span class="token punctuation">&#123;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">// 权限检查</span>
    <span class="token class-name">MethodAccessor</span> ma <span class="token operator">=</span> methodAccessor<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ma <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      ma <span class="token operator">=</span> <span class="token function">acquireMethodAccessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> ma<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>Method.invoke</code>  方法实际上委派给  <code>MethodAccessor</code>  接口来处理。它有两个已有的具体实现：</p>
<ul>
<li><code>NativeMethodAccessorImpl</code> ：本地方法来实现反射调用</li>
<li><code>DelegatingMethodAccessorImpl</code> ：委派模式来实现反射调用</li>
</ul>
<p>每个  <code>Method</code>  实例的第一次反射调用都会生成一个委派实现（ <code>DelegatingMethodAccessorImpl</code> ），它所委派的具体实现便是一个本地实现（ <code>NativeMethodAccessorImpl</code> ）。本地实现非常容易理解。当进入了 Java 虚拟机内部之后，我们便拥有了  <code>Method</code>  实例所指向方法的具体地址。这时候，反射调用无非就是将传入的参数准备好，然后调用进入目标方法。</p>
<p>【示例】通过抛出异常方式 打印  <code>Method.invoke</code>  调用轨迹</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MethodDemo01</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">target</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string">"#"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> clazz <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"io.github.dunwu.javacore.reflect.MethodDemo01"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Method</span> method <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"target"</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span>
<span class="token comment">// Output:</span>
<span class="token comment">// java.lang.Exception: #0</span>
<span class="token comment">//     at io.github.dunwu.javacore.reflect.MethodDemo01.target(MethodDemo01.java:12)</span>
<span class="token comment">//     at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</span>
<span class="token comment">//     at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>先调用  <code>DelegatingMethodAccessorImpl</code> ；然后调用  <code>NativeMethodAccessorImpl</code> ，最后调用实际方法。</p>
<p>为什么反射调用 <code>DelegatingMethodAccessorImpl</code>  作为中间层，而不是直接交给本地实现？</p>
<p>其实，Java 的反射调用机制还设立了另一种动态生成字节码的实现（下称动态实现），直接使用 invoke 指令来调用目标方法。之所以采用委派实现，便是为了能够在本地实现以及动态实现中切换。动态实现和本地实现相比，其运行效率要快上 20 倍。这是因为动态实现无需经过 Java 到 C++ 再到 Java 的切换，但由于生成字节码十分耗时，仅调用一次的话，反而是本地实现要快上 3 到 4 倍。</p>
<p>考虑到许多反射调用仅会执行一次，Java 虚拟机设置了一个阈值 15（可以通过  <code>-Dsun.reflect.inflationThreshold</code>  来调整），当某个反射调用的调用次数在 15 之下时，采用本地实现；当达到 15 时，便开始动态生成字节码，并将委派实现的委派对象切换至动态实现，这个过程我们称之为 Inflation。</p>
<p>【示例】执行 java -verbose:class MethodDemo02 启动</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MethodDemo02</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">target</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string">"#"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> klass <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"io.github.dunwu.javacore.reflect.MethodDemo02"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Method</span> method <span class="token operator">=</span> klass<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"target"</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>输出内容：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// ...省略</span>
<span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Exception</span><span class="token operator">:</span> #<span class="token number">14</span>
        at <span class="token class-name"><span class="token namespace">io<span class="token punctuation">.</span>github<span class="token punctuation">.</span>dunwu<span class="token punctuation">.</span>javacore<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span>MethodDemo02</span><span class="token punctuation">.</span><span class="token function">target</span><span class="token punctuation">(</span><span class="token class-name">MethodDemo02</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">13</span><span class="token punctuation">)</span>
        at <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span>NativeMethodAccessorImpl</span><span class="token punctuation">.</span><span class="token function">invoke0</span><span class="token punctuation">(</span><span class="token class-name">Native</span> <span class="token class-name">Method</span><span class="token punctuation">)</span>
        at <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span>NativeMethodAccessorImpl</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">NativeMethodAccessorImpl</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">62</span><span class="token punctuation">)</span>
        at <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span>DelegatingMethodAccessorImpl</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">DelegatingMethodAccessorImpl</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">43</span><span class="token punctuation">)</span>
        at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span>Method</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Method</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">498</span><span class="token punctuation">)</span>
        at <span class="token class-name"><span class="token namespace">io<span class="token punctuation">.</span>github<span class="token punctuation">.</span>dunwu<span class="token punctuation">.</span>javacore<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span>MethodDemo02</span><span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">MethodDemo02</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token class-name">Loaded</span> <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span>ClassFileConstants</span> from <span class="token class-name">D</span><span class="token operator">:</span>\<span class="token class-name">Tools</span>\<span class="token class-name">Java</span>\jdk1<span class="token punctuation">.</span><span class="token number">8.0_192</span>\jre\lib\rt<span class="token punctuation">.</span>jar<span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token class-name">Loaded</span> <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span>AccessorGenerator</span> from <span class="token class-name">D</span><span class="token operator">:</span>\<span class="token class-name">Tools</span>\<span class="token class-name">Java</span>\jdk1<span class="token punctuation">.</span><span class="token number">8.0_192</span>\jre\lib\rt<span class="token punctuation">.</span>jar<span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token class-name">Loaded</span> <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span>MethodAccessorGenerator</span> from <span class="token class-name">D</span><span class="token operator">:</span>\<span class="token class-name">Tools</span>\<span class="token class-name">Java</span>\jdk1<span class="token punctuation">.</span><span class="token number">8.0_192</span>\jre\lib\rt<span class="token punctuation">.</span>jar<span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token class-name">Loaded</span> <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span>ByteVectorFactory</span> from <span class="token class-name">D</span><span class="token operator">:</span>\<span class="token class-name">Tools</span>\<span class="token class-name">Java</span>\jdk1<span class="token punctuation">.</span><span class="token number">8.0_192</span>\jre\lib\rt<span class="token punctuation">.</span>jar<span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token class-name">Loaded</span> <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span>ByteVector</span> from <span class="token class-name">D</span><span class="token operator">:</span>\<span class="token class-name">Tools</span>\<span class="token class-name">Java</span>\jdk1<span class="token punctuation">.</span><span class="token number">8.0_192</span>\jre\lib\rt<span class="token punctuation">.</span>jar<span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token class-name">Loaded</span> <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span>ByteVectorImpl</span> from <span class="token class-name">D</span><span class="token operator">:</span>\<span class="token class-name">Tools</span>\<span class="token class-name">Java</span>\jdk1<span class="token punctuation">.</span><span class="token number">8.0_192</span>\jre\lib\rt<span class="token punctuation">.</span>jar<span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token class-name">Loaded</span> <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span>ClassFileAssembler</span> from <span class="token class-name">D</span><span class="token operator">:</span>\<span class="token class-name">Tools</span>\<span class="token class-name">Java</span>\jdk1<span class="token punctuation">.</span><span class="token number">8.0_192</span>\jre\lib\rt<span class="token punctuation">.</span>jar<span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token class-name">Loaded</span> sun<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>UTF8 from <span class="token class-name">D</span><span class="token operator">:</span>\<span class="token class-name">Tools</span>\<span class="token class-name">Java</span>\jdk1<span class="token punctuation">.</span><span class="token number">8.0_192</span>\jre\lib\rt<span class="token punctuation">.</span>jar<span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token class-name">Loaded</span> <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span>Label</span> from <span class="token class-name">D</span><span class="token operator">:</span>\<span class="token class-name">Tools</span>\<span class="token class-name">Java</span>\jdk1<span class="token punctuation">.</span><span class="token number">8.0_192</span>\jre\lib\rt<span class="token punctuation">.</span>jar<span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token class-name">Loaded</span> <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span>Label</span>$<span class="token class-name">PatchInfo</span> from <span class="token class-name">D</span><span class="token operator">:</span>\<span class="token class-name">Tools</span>\<span class="token class-name">Java</span>\jdk1<span class="token punctuation">.</span><span class="token number">8.0_192</span>\jre\lib\rt<span class="token punctuation">.</span>jar<span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token class-name">Loaded</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>ArrayList</span>$<span class="token class-name">Itr</span> from <span class="token class-name">D</span><span class="token operator">:</span>\<span class="token class-name">Tools</span>\<span class="token class-name">Java</span>\jdk1<span class="token punctuation">.</span><span class="token number">8.0_192</span>\jre\lib\rt<span class="token punctuation">.</span>jar<span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token class-name">Loaded</span> <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span>MethodAccessorGenerator</span>$<span class="token number">1</span> from <span class="token class-name">D</span><span class="token operator">:</span>\<span class="token class-name">Tools</span>\<span class="token class-name">Java</span>\jdk1<span class="token punctuation">.</span><span class="token number">8.0_192</span>\jre\lib\rt<span class="token punctuation">.</span>jar<span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token class-name">Loaded</span> <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span>ClassDefiner</span> from <span class="token class-name">D</span><span class="token operator">:</span>\<span class="token class-name">Tools</span>\<span class="token class-name">Java</span>\jdk1<span class="token punctuation">.</span><span class="token number">8.0_192</span>\jre\lib\rt<span class="token punctuation">.</span>jar<span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token class-name">Loaded</span> <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span>ClassDefiner</span>$<span class="token number">1</span> from <span class="token class-name">D</span><span class="token operator">:</span>\<span class="token class-name">Tools</span>\<span class="token class-name">Java</span>\jdk1<span class="token punctuation">.</span><span class="token number">8.0_192</span>\jre\lib\rt<span class="token punctuation">.</span>jar<span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token class-name">Loaded</span> <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span>GeneratedMethodAccessor1</span> from __JVM_DefineClass__<span class="token punctuation">]</span>
<span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Exception</span><span class="token operator">:</span> #<span class="token number">15</span>
        at <span class="token class-name"><span class="token namespace">io<span class="token punctuation">.</span>github<span class="token punctuation">.</span>dunwu<span class="token punctuation">.</span>javacore<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span>MethodDemo02</span><span class="token punctuation">.</span><span class="token function">target</span><span class="token punctuation">(</span><span class="token class-name">MethodDemo02</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">13</span><span class="token punctuation">)</span>
        at <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span>NativeMethodAccessorImpl</span><span class="token punctuation">.</span><span class="token function">invoke0</span><span class="token punctuation">(</span><span class="token class-name">Native</span> <span class="token class-name">Method</span><span class="token punctuation">)</span>
        at <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span>NativeMethodAccessorImpl</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">NativeMethodAccessorImpl</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">62</span><span class="token punctuation">)</span>
        at <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span>DelegatingMethodAccessorImpl</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">DelegatingMethodAccessorImpl</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">43</span><span class="token punctuation">)</span>
        at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span>Method</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Method</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">498</span><span class="token punctuation">)</span>
        at <span class="token class-name"><span class="token namespace">io<span class="token punctuation">.</span>github<span class="token punctuation">.</span>dunwu<span class="token punctuation">.</span>javacore<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span>MethodDemo02</span><span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">MethodDemo02</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token class-name">Loaded</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span>ConcurrentHashMap</span>$<span class="token class-name">ForwardingNode</span> from <span class="token class-name">D</span><span class="token operator">:</span>\<span class="token class-name">Tools</span>\<span class="token class-name">Java</span>\jdk1<span class="token punctuation">.</span><span class="token number">8.0_192</span>\jre\lib\rt<span class="token punctuation">.</span>jar<span class="token punctuation">]</span>
<span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Exception</span><span class="token operator">:</span> #<span class="token number">16</span>
        at <span class="token class-name"><span class="token namespace">io<span class="token punctuation">.</span>github<span class="token punctuation">.</span>dunwu<span class="token punctuation">.</span>javacore<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span>MethodDemo02</span><span class="token punctuation">.</span><span class="token function">target</span><span class="token punctuation">(</span><span class="token class-name">MethodDemo02</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">13</span><span class="token punctuation">)</span>
        at <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span>GeneratedMethodAccessor1</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Unknown</span> <span class="token class-name">Source</span><span class="token punctuation">)</span>
        at <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span>DelegatingMethodAccessorImpl</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">DelegatingMethodAccessorImpl</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">43</span><span class="token punctuation">)</span>
        at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span>Method</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Method</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">498</span><span class="token punctuation">)</span>
        at <span class="token class-name"><span class="token namespace">io<span class="token punctuation">.</span>github<span class="token punctuation">.</span>dunwu<span class="token punctuation">.</span>javacore<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span>MethodDemo02</span><span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">MethodDemo02</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token comment">// ...省略</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到，从第 16 次开始后，都是使用  <code>DelegatingMethodAccessorImpl</code>  ，不再使用本地实现  <code>NativeMethodAccessorImpl</code> 。</p>
<h3 id="-163"><a class="markdownIt-Anchor" href="#-163">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-reflection.html#_2-4-%E5%8F%8D%E5%B0%84%E8%B0%83%E7%94%A8%E7%9A%84%E5%BC%80%E9%94%80">#</a>2.4. 反射调用的开销</h3>
<p>方法的反射调用会带来不少性能开销，原因主要有三个：</p>
<ul>
<li>变长参数方法导致的 Object 数组</li>
<li>基本类型的自动装箱、拆箱</li>
<li>还有最重要的方法内联</li>
</ul>
<p><code>Class.forName</code>  会调用本地方法， <code>Class.getMethod</code>  则会遍历该类的公有方法。如果没有匹配到，它还将遍历父类的公有方法。可想而知，这两个操作都非常费时。</p>
<blockquote>
<p>注意，以  <code>getMethod</code>  为代表的查找方法操作，会返回查找得到结果的一份拷贝。因此，我们应当避免在热点代码中使用返回  <code>Method</code>  数组的  <code>getMethods</code>  或者  <code>getDeclaredMethods</code>  方法，以减少不必要的堆空间消耗。在实践中，我们往往会在应用程序中缓存  <code>Class.forName</code>  和  <code>Class.getMethod</code>  的结果。</p>
</blockquote>
<p>下面只关注反射调用本身的性能开销。</p>
<p>第一，由于 Method.invoke 是一个变长参数方法，在字节码层面它的最后一个参数会是 Object 数组（感兴趣的同学私下可以用 javap 查看）。Java 编译器会在方法调用处生成一个长度为传入参数数量的 Object 数组，并将传入参数一一存储进该数组中。</p>
<p>第二，由于 Object 数组不能存储基本类型，Java 编译器会对传入的基本类型参数进行自动装箱。</p>
<p>这两个操作除了带来性能开销外，还可能占用堆内存，使得 GC 更加频繁。（如果你感兴趣的话，可以用虚拟机参数 -XX:+PrintGC 试试。）那么，如何消除这部分开销呢？</p>
<h2 id="-164"><a class="markdownIt-Anchor" href="#-164">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-reflection.html#_3-%E4%BD%BF%E7%94%A8%E5%8F%8D%E5%B0%84">#</a>3. 使用反射</h2>
<h3 id="-165"><a class="markdownIt-Anchor" href="#-165">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-reflection.html#_3-1-java-lang-reflect-%E5%8C%85">#</a>3.1. java.lang.reflect 包</h3>
<p>Java 中的  <code>java.lang.reflect</code>  包提供了反射功能。 <code>java.lang.reflect</code>  包中的类都没有  <code>public</code>  构造方法。</p>
<p><code>java.lang.reflect</code>  包的核心接口和类如下：</p>
<ul>
<li><code>Member</code>  接口：反映关于单个成员 (字段或方法) 或构造函数的标识信息。</li>
<li><code>Field</code>  类：提供一个类的域的信息以及访问类的域的接口。</li>
<li><code>Method</code>  类：提供一个类的方法的信息以及访问类的方法的接口。</li>
<li><code>Constructor</code>  类：提供一个类的构造函数的信息以及访问类的构造函数的接口。</li>
<li><code>Array</code>  类：该类提供动态地生成和访问 JAVA 数组的方法。</li>
<li><code>Modifier</code>  类：提供了 static 方法和常量，对类和成员访问修饰符进行解码。</li>
<li><code>Proxy</code>  类：提供动态地生成代理类和类实例的静态方法。</li>
</ul>
<h3 id="-166"><a class="markdownIt-Anchor" href="#-166">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-reflection.html#_3-2-%E8%8E%B7%E5%8F%96-class-%E5%AF%B9%E8%B1%A1">#</a>3.2. 获取 Class 对象</h3>
<p>获取  <code>Class</code>  对象的三种方法：</p>
<p>（1）<strong> <code>Class.forName</code>  静态方法</strong></p>
<p>【示例】使用  <code>Class.forName</code>  静态方法获取  <code>Class</code>  对象</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">io<span class="token punctuation">.</span>github<span class="token punctuation">.</span>dunwu<span class="token punctuation">.</span>javacore<span class="token punctuation">.</span>reflect</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReflectClassDemo01</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Class</span> c1 <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"io.github.dunwu.javacore.reflect.ReflectClassDemo01"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>c1<span class="token punctuation">.</span><span class="token function">getCanonicalName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Class</span> c2 <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"[D"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>c2<span class="token punctuation">.</span><span class="token function">getCanonicalName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Class</span> c3 <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"[[Ljava.lang.String;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>c3<span class="token punctuation">.</span><span class="token function">getCanonicalName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">//Output:</span>
<span class="token comment">//io.github.dunwu.javacore.reflect.ReflectClassDemo01</span>
<span class="token comment">//double[]</span>
<span class="token comment">//java.lang.String[][]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>使用类的完全限定名来反射对象的类。常见的应用场景为：在 JDBC 开发中常用此方法加载数据库驱动。</p>
<p>（2）<strong>类名 +  <code>.class</code> </strong></p>
<p>【示例】直接用类名 +  <code>.class</code>  获取  <code>Class</code>  对象</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReflectClassDemo02</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">boolean</span> b<span class="token punctuation">;</span>
        <span class="token comment">// Class c = b.getClass(); // 编译错误</span>
        <span class="token class-name">Class</span> c1 <span class="token operator">=</span> <span class="token keyword">boolean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>c1<span class="token punctuation">.</span><span class="token function">getCanonicalName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Class</span> c2 <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>PrintStream</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>c2<span class="token punctuation">.</span><span class="token function">getCanonicalName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Class</span> c3 <span class="token operator">=</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>c3<span class="token punctuation">.</span><span class="token function">getCanonicalName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">//Output:</span>
<span class="token comment">//boolean</span>
<span class="token comment">//java.io.PrintStream</span>
<span class="token comment">//int[][][]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>（3）<strong> <code>Object</code>  的  <code>getClass</code>  方法</strong></p>
<p><code>Object</code>  类中有  <code>getClass</code>  方法，因为所有类都继承  <code>Object</code>  类。从而调用  <code>Object</code>  类来获取  <code>Class</code>  对象。</p>
<p>【示例】 <code>Object</code>  的  <code>getClass</code>  方法获取  <code>Class</code>  对象</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">io<span class="token punctuation">.</span>github<span class="token punctuation">.</span>dunwu<span class="token punctuation">.</span>javacore<span class="token punctuation">.</span>reflect</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashSet</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Set</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReflectClassDemo03</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">enum</span> <span class="token class-name">E</span> <span class="token punctuation">&#123;</span><span class="token class-name">A</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Class</span> c <span class="token operator">=</span> <span class="token string">"foo"</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">getCanonicalName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Class</span> c2 <span class="token operator">=</span> <span class="token class-name">ReflectClassDemo03<span class="token punctuation">.</span>E<span class="token punctuation">.</span>A</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>c2<span class="token punctuation">.</span><span class="token function">getCanonicalName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token class-name">Class</span> c3 <span class="token operator">=</span> bytes<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>c3<span class="token punctuation">.</span><span class="token function">getCanonicalName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> set <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Class</span> c4 <span class="token operator">=</span> set<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>c4<span class="token punctuation">.</span><span class="token function">getCanonicalName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">//Output:</span>
<span class="token comment">//java.lang.String</span>
<span class="token comment">//io.github.dunwu.javacore.reflect.ReflectClassDemo.E</span>
<span class="token comment">//byte[]</span>
<span class="token comment">//java.util.HashSet</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-167"><a class="markdownIt-Anchor" href="#-167">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-reflection.html#_3-3-%E5%88%A4%E6%96%AD%E6%98%AF%E5%90%A6%E4%B8%BA%E6%9F%90%E4%B8%AA%E7%B1%BB%E7%9A%84%E5%AE%9E%E4%BE%8B">#</a>3.3. 判断是否为某个类的实例</h3>
<p>判断是否为某个类的实例有两种方式：</p>
<ol>
<li><strong>用  <code>instanceof</code>  关键字</strong></li>
<li><strong>用  <code>Class</code>  对象的  <code>isInstance</code>  方法</strong>（它是一个 Native 方法）</li>
</ol>
<p>【示例】</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InstanceofDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ArrayList</span> arrayList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>arrayList <span class="token keyword">instanceof</span> <span class="token class-name">List</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ArrayList is List"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">List</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isInstance</span><span class="token punctuation">(</span>arrayList<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ArrayList is List"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">//Output:</span>
<span class="token comment">//ArrayList is List</span>
<span class="token comment">//ArrayList is List</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-168"><a class="markdownIt-Anchor" href="#-168">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-reflection.html#_3-4-%E5%88%9B%E5%BB%BA%E5%AE%9E%E4%BE%8B">#</a>3.4. 创建实例</h3>
<p>通过反射来创建实例对象主要有两种方式：</p>
<ul>
<li>用  <code>Class</code>  对象的  <code>newInstance</code>  方法。</li>
<li>用  <code>Constructor</code>  对象的  <code>newInstance</code>  方法。</li>
</ul>
<p>【示例】</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NewInstanceDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">IllegalAccessException</span><span class="token punctuation">,</span> <span class="token class-name">InstantiationException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchMethodException</span><span class="token punctuation">,</span> <span class="token class-name">InvocationTargetException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> c1 <span class="token operator">=</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>
        <span class="token class-name">StringBuilder</span> sb <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">StringBuilder</span><span class="token punctuation">)</span> c1<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"aaa"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//获取String所对应的Class对象</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> c2 <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>
        <span class="token comment">//获取String类带一个String参数的构造器</span>
        <span class="token class-name">Constructor</span> constructor <span class="token operator">=</span> c2<span class="token punctuation">.</span><span class="token function">getConstructor</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//根据构造器创建实例</span>
        <span class="token class-name">String</span> str2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> constructor<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token string">"bbb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>str2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">//Output:</span>
<span class="token comment">//aaa</span>
<span class="token comment">//bbb</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-169"><a class="markdownIt-Anchor" href="#-169">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-reflection.html#_3-5-%E5%88%9B%E5%BB%BA%E6%95%B0%E7%BB%84%E5%AE%9E%E4%BE%8B">#</a>3.5. 创建数组实例</h3>
<p>数组在 Java 里是比较特殊的一种类型，它可以赋值给一个对象引用。Java 中，<strong>通过  <code>Array.newInstance</code>  创建数组的实例</strong>。</p>
<p>【示例】利用反射创建数组</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReflectArrayDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> cls <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"java.lang.String"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> array <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//往数组里添加内容</span>
        <span class="token class-name">Array</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"Scala"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Array</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Java"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Array</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"Groovy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Array</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"Scala"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Array</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">"Clojure"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取某一项的内容</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Array</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">//Output:</span>
<span class="token comment">//Scala</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中的 Array 类为  <code>java.lang.reflect.Array</code>  类。我们 <code>Array.newInstance</code>  的原型是：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> componentType<span class="token punctuation">,</span> <span class="token keyword">int</span> length<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> <span class="token class-name">NegativeArraySizeException</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">newArray</span><span class="token punctuation">(</span>componentType<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-170"><a class="markdownIt-Anchor" href="#-170">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-reflection.html#_3-6-field">#</a>3.6. Field</h3>
<p><code>Class</code>  对象提供以下方法获取对象的成员（ <code>Field</code> ）：</p>
<ul>
<li><code>getFiled</code>  - 根据名称获取公有的（public）类成员。</li>
<li><code>getDeclaredField</code>  - 根据名称获取已声明的类成员。但不能得到其父类的类成员。</li>
<li><code>getFields</code>  - 获取所有公有的（public）类成员。</li>
<li><code>getDeclaredFields</code>  - 获取所有已声明的类成员。</li>
</ul>
<p>示例如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReflectFieldDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">class</span> <span class="token class-name">FieldSpy</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">public</span> <span class="token keyword">boolean</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> b <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#123;</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token string">"Alice"</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> list<span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token class-name">T</span> val<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NoSuchFieldException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Field</span> f1 <span class="token operator">=</span> <span class="token class-name">FieldSpy</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getField</span><span class="token punctuation">(</span><span class="token string">"b"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"Type: %s%n"</span><span class="token punctuation">,</span> f1<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Field</span> f2 <span class="token operator">=</span> <span class="token class-name">FieldSpy</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getField</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"Type: %s%n"</span><span class="token punctuation">,</span> f2<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Field</span> f3 <span class="token operator">=</span> <span class="token class-name">FieldSpy</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getField</span><span class="token punctuation">(</span><span class="token string">"list"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"Type: %s%n"</span><span class="token punctuation">,</span> f3<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Field</span> f4 <span class="token operator">=</span> <span class="token class-name">FieldSpy</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getField</span><span class="token punctuation">(</span><span class="token string">"val"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"Type: %s%n"</span><span class="token punctuation">,</span> f4<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">//Output:</span>
<span class="token comment">//Type: class [[Z</span>
<span class="token comment">//Type: class java.lang.String</span>
<span class="token comment">//Type: interface java.util.List</span>
<span class="token comment">//Type: class java.lang.Object</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-171"><a class="markdownIt-Anchor" href="#-171">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-reflection.html#_3-7-method">#</a>3.7. Method</h3>
<p><code>Class</code>  对象提供以下方法获取对象的方法（ <code>Method</code> ）：</p>
<ul>
<li><code>getMethod</code>  - 返回类或接口的特定方法。其中第一个参数为方法名称，后面的参数为方法参数对应 Class 的对象。</li>
<li><code>getDeclaredMethod</code>  - 返回类或接口的特定声明方法。其中第一个参数为方法名称，后面的参数为方法参数对应 Class 的对象。</li>
<li><code>getMethods</code>  - 返回类或接口的所有 public 方法，包括其父类的 public 方法。</li>
<li><code>getDeclaredMethods</code>  - 返回类或接口声明的所有方法，包括 public、protected、默认（包）访问和 private 方法，但不包括继承的方法。</li>
</ul>
<p>获取一个  <code>Method</code>  对象后，可以用  <code>invoke</code>  方法来调用这个方法。</p>
<p><code>invoke</code>  方法的原型为:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">IllegalAccessException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">,</span>
           <span class="token class-name">InvocationTargetException</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>【示例】</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReflectMethodDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">NoSuchMethodException</span><span class="token punctuation">,</span> <span class="token class-name">InvocationTargetException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalAccessException</span> <span class="token punctuation">&#123;</span>

        <span class="token comment">// 返回所有方法</span>
        <span class="token class-name">Method</span><span class="token punctuation">[</span><span class="token punctuation">]</span> methods1 <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getDeclaredMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"System getDeclaredMethods 清单（数量 = "</span> <span class="token operator">+</span> methods1<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token string">"）："</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Method</span> m <span class="token operator">:</span> methods1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// 返回所有 public 方法</span>
        <span class="token class-name">Method</span><span class="token punctuation">[</span><span class="token punctuation">]</span> methods2 <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"System getMethods 清单（数量 = "</span> <span class="token operator">+</span> methods2<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token string">"）："</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Method</span> m <span class="token operator">:</span> methods2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// 利用 Method 的 invoke 方法调用 System.currentTimeMillis()</span>
        <span class="token class-name">Method</span> method <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"currentTimeMillis"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-172"><a class="markdownIt-Anchor" href="#-172">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-reflection.html#_3-8-constructor">#</a>3.8. Constructor</h3>
<p><code>Class</code>  对象提供以下方法获取对象的构造方法（ <code>Constructor</code> ）：</p>
<ul>
<li><code>getConstructor</code>  - 返回类的特定 public 构造方法。参数为方法参数对应 Class 的对象。</li>
<li><code>getDeclaredConstructor</code>  - 返回类的特定构造方法。参数为方法参数对应 Class 的对象。</li>
<li><code>getConstructors</code>  - 返回类的所有 public 构造方法。</li>
<li><code>getDeclaredConstructors</code>  - 返回类的所有构造方法。</li>
</ul>
<p>获取一个  <code>Constructor</code>  对象后，可以用  <code>newInstance</code>  方法来创建类实例。</p>
<p>【示例】</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReflectMethodConstructorDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">NoSuchMethodException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalAccessException</span><span class="token punctuation">,</span> <span class="token class-name">InvocationTargetException</span><span class="token punctuation">,</span> <span class="token class-name">InstantiationException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> constructors1 <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getDeclaredConstructors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"String getDeclaredConstructors 清单（数量 = "</span> <span class="token operator">+</span> constructors1<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token string">"）："</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Constructor</span> c <span class="token operator">:</span> constructors1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> constructors2 <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getConstructors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"String getConstructors 清单（数量 = "</span> <span class="token operator">+</span> constructors2<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token string">"）："</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Constructor</span> c <span class="token operator">:</span> constructors2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"===================="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Constructor</span> constructor <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getConstructor</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>constructor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> str <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> constructor<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token string">"bbb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-173"><a class="markdownIt-Anchor" href="#-173">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-reflection.html#_3-9-%E7%BB%95%E5%BC%80%E8%AE%BF%E9%97%AE%E9%99%90%E5%88%B6">#</a>3.9. 绕开访问限制</h3>
<p>有时候，我们需要通过反射访问私有成员、方法。可以使用  <code>Constructor/Field/Method.setAccessible(true)</code>  来绕开 Java 语言的访问限制。</p>
<h2 id="-174"><a class="markdownIt-Anchor" href="#-174">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-reflection.html#_4-%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86">#</a>4. 动态代理</h2>
<p>动态代理是一种方便运行时动态构建代理、动态处理代理方法调用的机制，很多场景都是利用类似机制做到的，比如用来包装 RPC 调用、面向切面的编程（AOP）。</p>
<p>实现动态代理的方式很多，比如 JDK 自身提供的动态代理，就是主要利用了上面提到的反射机制。还有其他的实现方式，比如利用传说中更高性能的字节码操作机制，类似 ASM、cglib（基于 ASM）、Javassist 等。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/cs/java/javacore/xmind/Java%E4%BB%A3%E7%90%86.svg" alt="img"></p>
<h3 id="-175"><a class="markdownIt-Anchor" href="#-175">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-reflection.html#_4-1-%E9%9D%99%E6%80%81%E4%BB%A3%E7%90%86">#</a>4.1. 静态代理</h3>
<blockquote>
<p>静态代理其实就是指设计模式中的代理模式。</p>
<p><strong>代理模式为其他对象提供一种代理以控制对这个对象的访问。</strong></p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/3101171-6269723ea61527bd.png" alt="img"></p>
<p><strong>Subject</strong> 定义了 RealSubject 和 Proxy 的公共接口，这样就在任何使用 RealSubject 的地方都可以使用 Proxy 。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Subject</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token class-name">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><strong>RealSubject</strong> 定义 Proxy 所代表的真实实体。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">RealSubject</span> <span class="token keyword">extends</span> <span class="token class-name">Subject</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token class-name">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"真实的请求"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>Proxy</strong> 保存一个引用使得代理可以访问实体，并提供一个与 Subject 的接口相同的接口，这样代理就可以用来替代实体。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Proxy</span> <span class="token keyword">extends</span> <span class="token class-name">Subject</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token class-name">RealSubject</span> real<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token class-name">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> real<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            real <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RealSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name"><span class="token namespace">real<span class="token punctuation">.</span></span>Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>说明：</p>
<p>静态代理模式固然在访问无法访问的资源，增强现有的接口业务功能方面有很大的优点，但是大量使用这种静态代理，会使我们系统内的类的规模增大，并且不易维护；并且由于 Proxy 和 RealSubject 的功能本质上是相同的，Proxy 只是起到了中介的作用，这种代理在系统中的存在，导致系统结构比较臃肿和松散。</p>
</blockquote>
<h3 id="-176"><a class="markdownIt-Anchor" href="#-176">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-reflection.html#_4-2-jdk-%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86">#</a>4.2. JDK 动态代理</h3>
<p>为了解决静态代理的问题，就有了创建动态代理的想法：</p>
<p>在运行状态中，需要代理的地方，根据 Subject 和 RealSubject，动态地创建一个 Proxy，用完之后，就会销毁，这样就可以避免了 Proxy 角色的 class 在系统中冗杂的问题了。</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/1553614585028.png" alt="img"></p>
<p>Java 动态代理基于经典代理模式，引入了一个  <code>InvocationHandler</code> ， <code>InvocationHandler</code>  负责统一管理所有的方法调用。</p>
<p>动态代理步骤：</p>
<ol>
<li>获取 RealSubject 上的所有接口列表；</li>
<li>确定要生成的代理类的类名，默认为： <code>com.sun.proxy.$ProxyXXXX</code> ；</li>
<li>根据需要实现的接口信息，在代码中动态创建 该 Proxy 类的字节码；</li>
<li>将对应的字节码转换为对应的 class 对象；</li>
<li>创建  <code>InvocationHandler</code>  实例 handler，用来处理  <code>Proxy</code>  所有方法调用；</li>
<li>Proxy 的 class 对象 以创建的 handler 对象为参数，实例化一个 proxy 对象。</li>
</ol>
<p>从上面可以看出，JDK 动态代理的实现是基于实现接口的方式，使得 Proxy 和 RealSubject 具有相同的功能。</p>
<p>但其实还有一种思路：通过继承。即：让 Proxy 继承 RealSubject，这样二者同样具有相同的功能，Proxy 还可以通过重写 RealSubject 中的方法，来实现多态。CGLIB 就是基于这种思路设计的。</p>
<p>在 Java 的动态代理机制中，有两个重要的类（接口），一个是  <code>InvocationHandler</code>  接口、另一个则是  <code>Proxy</code>  类，这一个类和一个接口是实现我们动态代理所必须用到的。</p>
<h4 id="-177"><a class="markdownIt-Anchor" href="#-177">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-reflection.html#invocationhandler-%E6%8E%A5%E5%8F%A3">#</a>InvocationHandler 接口</h4>
<p><code>InvocationHandler</code>  接口定义：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">InvocationHandler</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> proxy<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">Throwable</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>每一个动态代理类都必须要实现  <code>InvocationHandler</code>  这个接口，并且每个代理类的实例都关联到了一个 Handler，当我们通过代理对象调用一个方法的时候，这个方法的调用就会被转发为由  <code>InvocationHandler</code>  这个接口的  <code>invoke</code>  方法来进行调用。</p>
<p>我们来看看 InvocationHandler 这个接口的唯一一个方法 invoke 方法：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> proxy<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>参数说明：</p>
<ul>
<li><strong>proxy</strong> - 代理的真实对象。</li>
<li><strong>method</strong> - 所要调用真实对象的某个方法的  <code>Method</code>  对象</li>
<li><strong>args</strong> - 所要调用真实对象某个方法时接受的参数</li>
</ul>
<p>如果不是很明白，等下通过一个实例会对这几个参数进行更深的讲解。</p>
<h4 id="-178"><a class="markdownIt-Anchor" href="#-178">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-reflection.html#proxy-%E7%B1%BB">#</a>Proxy 类</h4>
<p><code>Proxy</code>  这个类的作用就是用来动态创建一个代理对象的类，它提供了许多的方法，但是我们用的最多的就是  <code>newProxyInstance</code>  这个方法：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token function">newProxyInstance</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span> loader<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> interfaces<span class="token punctuation">,</span>  <span class="token class-name">InvocationHandler</span> h<span class="token punctuation">)</span>  <span class="token keyword">throws</span> <span class="token class-name">IllegalArgumentException</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这个方法的作用就是得到一个动态的代理对象。</p>
<p>参数说明：</p>
<ul>
<li><strong>loader</strong> - 一个  <code>ClassLoader</code>  对象，定义了由哪个  <code>ClassLoader</code>  对象来对生成的代理对象进行加载。</li>
<li><strong>interfaces</strong> - 一个  <code>Class&lt;?&gt;</code>  对象的数组，表示的是我将要给我需要代理的对象提供一组什么接口，如果我提供了一组接口给它，那么这个代理对象就宣称实现了该接口 (多态)，这样我就能调用这组接口中的方法了</li>
<li><strong>h</strong> - 一个  <code>InvocationHandler</code>  对象，表示的是当我这个动态代理对象在调用方法的时候，会关联到哪一个  <code>InvocationHandler</code>  对象上</li>
</ul>
<h4 id="-179"><a class="markdownIt-Anchor" href="#-179">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-reflection.html#jdk-%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E5%AE%9E%E4%BE%8B">#</a>JDK 动态代理实例</h4>
<p>上面的内容介绍完这两个接口 (类) 以后，我们来通过一个实例来看看我们的动态代理模式是什么样的：</p>
<p>首先我们定义了一个 Subject 类型的接口，为其声明了两个方法：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Subject</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">void</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token class-name">String</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">String</span> <span class="token function">bye</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>接着，定义了一个类来实现这个接口，这个类就是我们的真实对象，RealSubject 类：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RealSubject</span> <span class="token keyword">implements</span> <span class="token class-name">Subject</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token class-name">String</span> str<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Hello  "</span> <span class="token operator">+</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">bye</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Goodbye"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"Over"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>下一步，我们就要定义一个动态代理类了，前面说个，每一个动态代理类都必须要实现 InvocationHandler 这个接口，因此我们这个动态代理类也不例外：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InvocationHandlerDemo</span> <span class="token keyword">implements</span> <span class="token class-name">InvocationHandler</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 这个就是我们要代理的真实对象</span>
    <span class="token keyword">private</span> <span class="token class-name">Object</span> subject<span class="token punctuation">;</span>

    <span class="token comment">// 构造方法，给我们要代理的真实对象赋初值</span>
    <span class="token keyword">public</span> <span class="token class-name">InvocationHandlerDemo</span><span class="token punctuation">(</span><span class="token class-name">Object</span> subject<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>subject <span class="token operator">=</span> subject<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> object<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 在代理真实对象前我们可以添加一些自己的操作</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Before method"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Call Method: "</span> <span class="token operator">+</span> method<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 当代理对象调用真实对象的方法时，其会自动的跳转到代理对象关联的handler对象的invoke方法来进行调用</span>
        <span class="token class-name">Object</span> obj <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>subject<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 在代理真实对象后我们也可以添加一些自己的操作</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"After method"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> obj<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最后，来看看我们的 Client 类：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 我们要代理的真实对象</span>
        <span class="token class-name">Subject</span> realSubject <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RealSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 我们要代理哪个真实对象，就将该对象传进去，最后是通过该真实对象来调用其方法的</span>
        <span class="token class-name">InvocationHandler</span> handler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InvocationHandlerDemo</span><span class="token punctuation">(</span>realSubject<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/*
         * 通过Proxy的newProxyInstance方法来创建我们的代理对象，我们来看看其三个参数
         * 第一个参数 handler.getClass().getClassLoader() ，我们这里使用handler这个类的ClassLoader对象来加载我们的代理对象
         * 第二个参数realSubject.getClass().getInterfaces()，我们这里为代理对象提供的接口是真实对象所实行的接口，表示我要代理的是该真实对象，这样我就能调用这组接口中的方法了
         * 第三个参数handler， 我们这里将这个代理对象关联到了上方的 InvocationHandler 这个对象上
         */</span>
        <span class="token class-name">Subject</span> subject <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Subject</span><span class="token punctuation">)</span><span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span>handler<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> realSubject
                <span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInterfaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>subject<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        subject<span class="token punctuation">.</span><span class="token function">hello</span><span class="token punctuation">(</span><span class="token string">"World"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> result <span class="token operator">=</span> subject<span class="token punctuation">.</span><span class="token function">bye</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Result is: "</span> <span class="token operator">+</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们先来看看控制台的输出：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">com.sun.proxy.$Proxy0
Before method
Call Method: public abstract void io.github.dunwu.javacore.reflect.InvocationHandlerDemo$Subject.hello(java.lang.String)
Hello  World
After method

Before method
Call Method: public abstract java.lang.String io.github.dunwu.javacore.reflect.InvocationHandlerDemo$Subject.bye()
Goodbye
After method

Result is: Over<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们首先来看看  <code>com.sun.proxy.$Proxy0</code>  这东西，我们看到，这个东西是由  <code>System.out.println(subject.getClass().getName());</code>  这条语句打印出来的，那么为什么我们返回的这个代理对象的类名是这样的呢？</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Subject</span> subject <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Subject</span><span class="token punctuation">)</span><span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span>handler<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> realSubject
                <span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInterfaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>可能我以为返回的这个代理对象会是 Subject 类型的对象，或者是 InvocationHandler 的对象，结果却不是，首先我们解释一下<strong>为什么我们这里可以将其转化为 Subject 类型的对象？</strong></p>
<p>原因就是：在 newProxyInstance 这个方法的第二个参数上，我们给这个代理对象提供了一组什么接口，那么我这个代理对象就会实现了这组接口，这个时候我们当然可以将这个代理对象强制类型转化为这组接口中的任意一个，因为这里的接口是 Subject 类型，所以就可以将其转化为 Subject 类型了。</p>
<p><strong>同时我们一定要记住，通过  <code>Proxy.newProxyInstance</code>  创建的代理对象是在 jvm 运行时动态生成的一个对象，它并不是我们的 InvocationHandler 类型，也不是我们定义的那组接口的类型，而是在运行是动态生成的一个对象，并且命名方式都是这样的形式，以 $ 开头，proxy 为中，最后一个数字表示对象的标号</strong>。</p>
<p>接着我们来看看这两句</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">subject.hello("World");
String result = subject.bye();<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>这里是通过代理对象来调用实现的那种接口中的方法，这个时候程序就会跳转到由这个代理对象关联到的 handler 中的 invoke 方法去执行，而我们的这个 handler 对象又接受了一个 RealSubject 类型的参数，表示我要代理的就是这个真实对象，所以此时就会调用 handler 中的 invoke 方法去执行。</p>
<p>我们看到，在真正通过代理对象来调用真实对象的方法的时候，我们可以在该方法前后添加自己的一些操作，同时我们看到我们的这个 method 对象是这样的：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token class-name"><span class="token namespace">io<span class="token punctuation">.</span>github<span class="token punctuation">.</span>dunwu<span class="token punctuation">.</span>javacore<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span>InvocationHandlerDemo</span>$<span class="token class-name">Subject</span><span class="token punctuation">.</span><span class="token function">hello</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>String</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>String</span> <span class="token class-name"><span class="token namespace">io<span class="token punctuation">.</span>github<span class="token punctuation">.</span>dunwu<span class="token punctuation">.</span>javacore<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span>InvocationHandlerDemo</span>$<span class="token class-name">Subject</span><span class="token punctuation">.</span><span class="token function">bye</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>正好就是我们的 Subject 接口中的两个方法，这也就证明了当我通过代理对象来调用方法的时候，起实际就是委托由其关联到的 handler 对象的 invoke 方法中来调用，并不是自己来真实调用，而是通过代理的方式来调用的。</p>
<h4 id="-180"><a class="markdownIt-Anchor" href="#-180">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-reflection.html#jdk-%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E5%B0%8F%E7%BB%93">#</a>JDK 动态代理小结</h4>
<p>代理类与委托类实现同一接口，主要是通过代理类实现  <code>InvocationHandler</code>  并重写  <code>invoke</code>  方法来进行动态代理的，在  <code>invoke</code>  方法中将对方法进行处理。</p>
<p>JDK 动态代理特点：</p>
<ul>
<li>优点：相对于静态代理模式，不需要硬编码接口，代码复用率高。</li>
<li>缺点：强制要求代理类实现  <code>InvocationHandler</code>  接口。</li>
</ul>
<h3 id="-181"><a class="markdownIt-Anchor" href="#-181">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-reflection.html#_4-3-cglib-%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86">#</a>4.3. CGLIB 动态代理</h3>
<p>CGLIB 提供了与 JDK 动态代理不同的方案。很多框架，例如 Spring AOP 中，就使用了 CGLIB 动态代理。</p>
<p>CGLIB 底层，其实是借助了 ASM 这个强大的 Java 字节码框架去进行字节码增强操作。</p>
<p>CGLIB 动态代理的工作步骤：</p>
<ul>
<li>生成代理类的二进制字节码文件；</li>
<li>加载二进制字节码，生成  <code>Class</code>  对象 ( 例如使用  <code>Class.forName()</code>  方法 )；</li>
<li>通过反射机制获得实例构造，并创建代理类对象。</li>
</ul>
<p>CGLIB 动态代理特点：</p>
<p>优点：使用字节码增强，比 JDK 动态代理方式性能高。可以在运行时对类或者是接口进行增强操作，且委托类无需实现接口。</p>
<p>缺点：不能对  <code>final</code>  类以及  <code>final</code>  方法进行代理。</p>
<hr>
<h1 id="深入理解-java-注解"><a class="markdownIt-Anchor" href="#深入理解-java-注解">#</a> 深入理解 Java 注解</h1>
<blockquote>
<p>本文内容基于 JDK8。注解是 JDK5 引入的，后续 JDK 版本扩展了一些内容，本文中没有明确指明版本的注解都是 JDK5 就已经支持的注解。</p>
<p><strong>📦 本文以及示例源码已归档在 <a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/">javacore(opens new window)</a></strong></p>
</blockquote>
<ul>
<li>\1. 简介
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-annotation.html#11-%E6%B3%A8%E8%A7%A3%E7%9A%84%E5%BD%A2%E5%BC%8F">1.1. 注解的形式</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-annotation.html#12-%E4%BB%80%E4%B9%88%E6%98%AF%E6%B3%A8%E8%A7%A3">1.2. 什么是注解</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-annotation.html#13-%E6%B3%A8%E8%A7%A3%E7%9A%84%E4%BD%9C%E7%94%A8">1.3. 注解的作用</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-annotation.html#14-%E6%B3%A8%E8%A7%A3%E7%9A%84%E4%BB%A3%E4%BB%B7">1.4. 注解的代价</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-annotation.html#15-%E6%B3%A8%E8%A7%A3%E7%9A%84%E5%BA%94%E7%94%A8%E8%8C%83%E5%9B%B4">1.5. 注解的应用范围</a></li>
</ul>
</li>
<li>\2. 内置注解
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-annotation.html#21-override">2.1. @Override</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-annotation.html#22-deprecated">2.2. @Deprecated</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-annotation.html#23-suppresswarnnings">2.3. @SuppressWarnnings</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-annotation.html#24-safevarargs">2.4. @SafeVarargs</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-annotation.html#25-functionalinterface">2.5. @FunctionalInterface</a></li>
</ul>
</li>
<li>\3. 元注解
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-annotation.html#31-retention">3.1. @Retention</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-annotation.html#32-documented">3.2. @Documented</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-annotation.html#33-target">3.3. @Target</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-annotation.html#34-inherited">3.4. @Inherited</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-annotation.html#35-repeatable">3.5. @Repeatable</a></li>
</ul>
</li>
<li>\4. 自定义注解
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-annotation.html#41-%E6%B3%A8%E8%A7%A3%E7%9A%84%E5%AE%9A%E4%B9%89">4.1. 注解的定义</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-annotation.html#42-%E6%B3%A8%E8%A7%A3%E5%B1%9E%E6%80%A7">4.2. 注解属性</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-annotation.html#43-%E6%B3%A8%E8%A7%A3%E5%A4%84%E7%90%86%E5%99%A8">4.3. 注解处理器</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-annotation.html#44-%E4%BD%BF%E7%94%A8%E6%B3%A8%E8%A7%A3">4.4. 使用注解</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-annotation.html#5-%E5%B0%8F%E7%BB%93">5. 小结</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-annotation.html#6-%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">6. 参考资料</a></li>
</ul>
<h2 id="-182"><a class="markdownIt-Anchor" href="#-182">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-annotation.html#_1-%E7%AE%80%E4%BB%8B">#</a>1. 简介</h2>
<h3 id="-183"><a class="markdownIt-Anchor" href="#-183">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-annotation.html#_1-1-%E6%B3%A8%E8%A7%A3%E7%9A%84%E5%BD%A2%E5%BC%8F">#</a>1.1. 注解的形式</h3>
<p>Java 中，注解是以  <code>@</code>  字符开始的修饰符。如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">void</span> <span class="token function">mySuperMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>注解可以包含命名或未命名的属性，并且这些属性有值。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Author</span><span class="token punctuation">(</span>
   name <span class="token operator">=</span> <span class="token string">"Benjamin Franklin"</span><span class="token punctuation">,</span>
   date <span class="token operator">=</span> <span class="token string">"3/27/2003"</span>
<span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">MyClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果只有一个名为 value 的属性，那么名称可以省略，如：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>
<span class="token keyword">void</span> <span class="token function">myMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>如果注解没有属性，则称为 <code>标记注解</code> 。如： <code>@Override</code> 。</p>
<h3 id="-184"><a class="markdownIt-Anchor" href="#-184">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-annotation.html#_1-2-%E4%BB%80%E4%B9%88%E6%98%AF%E6%B3%A8%E8%A7%A3">#</a>1.2. 什么是注解</h3>
<p>从本质上来说，<strong>注解是一种标签，其实质上可以视为一种特殊的注释，如果没有解析它的代码，它并不比普通注释强。</strong></p>
<p>解析一个注解往往有两种形式：</p>
<ul>
<li><strong>编译期直接的扫描</strong> - 编译器的扫描指的是编译器在对 java 代码编译字节码的过程中会检测到某个类或者方法被一些注解修饰，这时它就会对于这些注解进行某些处理。这种情况只适用于 JDK 内置的注解类。</li>
<li><strong>运行期的反射</strong> - 如果要自定义注解，Java 编译器无法识别并处理这个注解，它只能根据该注解的作用范围来选择是否编译进字节码文件。如果要处理注解，必须利用反射技术，识别该注解以及它所携带的信息，然后做相应的处理。</li>
</ul>
<h3 id="-185"><a class="markdownIt-Anchor" href="#-185">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-annotation.html#_1-3-%E6%B3%A8%E8%A7%A3%E7%9A%84%E4%BD%9C%E7%94%A8">#</a>1.3. 注解的作用</h3>
<p>注解有许多用途：</p>
<ul>
<li>编译器信息 - 编译器可以使用注解来检测错误或抑制警告。</li>
<li>编译时和部署时的处理 - 程序可以处理注解信息以生成代码，XML 文件等。</li>
<li>运行时处理 - 可以在运行时检查某些注解并处理。</li>
</ul>
<p>作为 Java 程序员，多多少少都曾经历过被各种配置文件（xml、properties）支配的恐惧。过多的配置文件会使得项目难以维护。个人认为，使用注解以减少配置文件或代码，是注解最大的用处。</p>
<h3 id="-186"><a class="markdownIt-Anchor" href="#-186">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-annotation.html#_1-4-%E6%B3%A8%E8%A7%A3%E7%9A%84%E4%BB%A3%E4%BB%B7">#</a>1.4. 注解的代价</h3>
<p>凡事有得必有失，注解技术同样如此。使用注解也有一定的代价：</p>
<ul>
<li>显然，它是一种侵入式编程，那么，自然就存在着增加程序耦合度的问题。</li>
<li>自定义注解的处理需要在运行时，通过反射技术来获取属性。如果注解所修饰的元素是类的非 public 成员，也可以通过反射获取。这就违背了面向对象的封装性。</li>
<li>注解所产生的问题，相对而言，更难以 debug 或定位。</li>
</ul>
<p>但是，正所谓瑕不掩瑜，注解所付出的代价，相较于它提供的功能而言，还是可以接受的。</p>
<h3 id="-187"><a class="markdownIt-Anchor" href="#-187">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-annotation.html#_1-5-%E6%B3%A8%E8%A7%A3%E7%9A%84%E5%BA%94%E7%94%A8%E8%8C%83%E5%9B%B4">#</a>1.5. 注解的应用范围</h3>
<p>注解可以应用于类、字段、方法和其他程序元素的声明。</p>
<p>JDK8 开始，注解的应用范围进一步扩大，以下是新的应用范围：</p>
<p>类实例初始化表达式：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">new</span> <span class="token annotation punctuation">@Interned</span> <span class="token class-name">MyObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>类型转换：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">myString <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">String</span><span class="token punctuation">)</span> str<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>实现接口的声明：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">UnmodifiableList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token keyword">implements</span>
    <span class="token annotation punctuation">@Readonly</span> <span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token annotation punctuation">@Readonly</span> <span class="token class-name">T</span><span class="token operator">></span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>抛出异常声明：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">void</span> <span class="token function">monitorTemperature</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">throws</span> <span class="token annotation punctuation">@Critical</span> <span class="token class-name">TemperatureException</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h2 id="-188"><a class="markdownIt-Anchor" href="#-188">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-annotation.html#_2-%E5%86%85%E7%BD%AE%E6%B3%A8%E8%A7%A3">#</a>2. 内置注解</h2>
<p>JDK 中内置了以下注解：</p>
<ul>
<li><code>@Override</code></li>
<li><code>@Deprecated</code></li>
<li><code>@SuppressWarnnings</code></li>
<li><code>@SafeVarargs</code> （JDK7 引入）</li>
<li><code>@FunctionalInterface</code> （JDK8 引入）</li>
</ul>
<h3 id="-189"><a class="markdownIt-Anchor" href="#-189">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-annotation.html#_2-1-override">#</a>2.1. @Override</h3>
<p><strong><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/api/java/lang/Override.html"> <code>@Override</code>  (opens new window)</a> 用于表明被修饰方法覆写了父类的方法。</strong></p>
<p>如果试图使用  <code>@Override</code>  标记一个实际上并没有覆写父类的方法时，java 编译器会告警。</p>
<p><code>@Override</code>  示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OverrideAnnotationDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token string">"getName"</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>


    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Man</span> <span class="token keyword">extends</span> <span class="token class-name">Person</span> <span class="token punctuation">&#123;</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token string">"override getName"</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">/**
         *  放开下面的注释，编译时会告警
         */</span>
       <span class="token comment">/*
        @Override
        public String getName2() &#123;
            return "override getName2";
        &#125;
        */</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Person</span> per <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Man</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>per<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-190"><a class="markdownIt-Anchor" href="#-190">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-annotation.html#_2-2-deprecated">#</a>2.2. @Deprecated</h3>
<p><strong> <code>@Deprecated</code>  用于标明被修饰的类或类成员、类方法已经废弃、过时，不建议使用。</strong></p>
<p><code>@Deprecated</code>  有一定的<strong>延续性</strong>：如果我们在代码中通过继承或者覆盖的方式使用了过时的类或类成员，即使子类或子方法没有标记为  <code>@Deprecated</code> ，但编译器仍然会告警。</p>
<blockquote>
<p>🔔 注意：  <code>@Deprecated</code>  这个注解类型和 javadoc 中的  <code>@deprecated</code>  这个 tag 是有区别的：前者是 java 编译器识别的；而后者是被 javadoc 工具所识别用来生成文档（包含程序成员为什么已经过时、它应当如何被禁止或者替代的描述）。</p>
</blockquote>
<p><code>@Deprecated</code>  示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DeprecatedAnnotationDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">DeprecatedField</span> <span class="token punctuation">&#123;</span>
        <span class="token annotation punctuation">@Deprecated</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> DEPRECATED_FIELD <span class="token operator">=</span> <span class="token string">"DeprecatedField"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>


    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">DeprecatedMethod</span> <span class="token punctuation">&#123;</span>
        <span class="token annotation punctuation">@Deprecated</span>
        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token string">"DeprecatedMethod"</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>


    <span class="token annotation punctuation">@Deprecated</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">DeprecatedClass</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token string">"DeprecatedClass"</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">DeprecatedField</span><span class="token punctuation">.</span>DEPRECATED_FIELD<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">DeprecatedMethod</span> dm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DeprecatedMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>dm<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token class-name">DeprecatedClass</span> dc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DeprecatedClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>dc<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">//Output:</span>
<span class="token comment">//DeprecatedField</span>
<span class="token comment">//DeprecatedMethod</span>
<span class="token comment">//DeprecatedClass</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-191"><a class="markdownIt-Anchor" href="#-191">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-annotation.html#_2-3-suppresswarnnings">#</a>2.3. @SuppressWarnnings</h3>
<p><strong><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/api/java/lang/SuppressWarnings.html"> <code>@SuppressWarnings</code>  (opens new window)</a> 用于关闭对类、方法、成员编译时产生的特定警告。</strong></p>
<p><code>@SuppressWarning</code>  不是一个标记注解。它有一个类型为  <code>String[]</code>  的数组成员，这个数组中存储的是要关闭的告警类型。对于 javac 编译器来讲，对  <code>-Xlint</code>  选项有效的警告名也同样对  <code>@SuppressWarings</code>  有效，同时编译器会忽略掉无法识别的警告名。</p>
<p><code>@SuppressWarning</code>  示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"rawtypes"</span><span class="token punctuation">,</span> <span class="token string">"unchecked"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SuppressWarningsAnnotationDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">SuppressDemo</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">private</span> <span class="token class-name">T</span> value<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setValue</span><span class="token punctuation">(</span><span class="token class-name">T</span> <span class="token keyword">var</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">var</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"deprecation"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">SuppressDemo</span> d <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SuppressDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        d<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span><span class="token string">"南京"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"地名："</span> <span class="token operator">+</span> d<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>@SuppressWarnings</code>  注解的常见参数值的简单说明：</p>
<ul>
<li><code>deprecation</code>  - 使用了不赞成使用的类或方法时的警告；</li>
<li><code>unchecked</code>  - 执行了未检查的转换时的警告，例如当使用集合时没有用泛型 (Generics) 来指定集合保存的类型；</li>
<li><code>fallthrough</code>  - 当 Switch 程序块直接通往下一种情况而没有 Break 时的警告；</li>
<li><code>path</code>  - 在类路径、源文件路径等中有不存在的路径时的警告；</li>
<li><code>serial</code>  - 当在可序列化的类上缺少 serialVersionUID 定义时的警告；</li>
<li><code>finally</code>  - 任何 finally 子句不能正常完成时的警告；</li>
<li><code>all</code>  - 所有的警告。</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"uncheck"</span><span class="token punctuation">,</span> <span class="token string">"deprecation"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InternalAnnotationDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">/**
     * @SuppressWarnings 标记消除当前类的告警信息
     */</span>
    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"deprecation"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"call method1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">/**
         * @Deprecated 标记当前方法为废弃方法，不建议使用
         */</span>
        <span class="token annotation punctuation">@Deprecated</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"call method2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * @Deprecated 标记当前类为废弃类，不建议使用
     */</span>
    <span class="token annotation punctuation">@Deprecated</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">B</span> <span class="token keyword">extends</span> <span class="token class-name">A</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">/**
         * @Override 标记显示指明当前方法覆写了父类或接口的方法
         */</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">A</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">B</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        obj<span class="token punctuation">.</span><span class="token function">method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        obj<span class="token punctuation">.</span><span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-192"><a class="markdownIt-Anchor" href="#-192">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-annotation.html#_2-4-safevarargs">#</a>2.4. @SafeVarargs</h3>
<p><code>@SafeVarargs</code>  在 JDK7 中引入。</p>
<p><strong><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/api/java/lang/SafeVarargs.html"> <code>@SafeVarargs</code>  (opens new window)</a> 的作用是：告诉编译器，在可变长参数中的泛型是类型安全的。可变长参数是使用数组存储的，而数组和泛型不能很好的混合使用。</strong></p>
<p>简单的说，数组元素的数据类型在编译和运行时都是确定的，而泛型的数据类型只有在运行时才能确定下来。因此，当把一个泛型存储到数组中时，编译器在编译阶段无法确认数据类型是否匹配，因此会给出警告信息；即如果泛型的真实数据类型无法和参数数组的类型匹配，会导致  <code>ClassCastException</code>  异常。</p>
<p><code>@SafeVarargs</code>  注解使用范围：</p>
<ul>
<li><code>@SafeVarargs</code>  注解可以用于构造方法。</li>
<li><code>@SafeVarargs</code>  注解可以用于  <code>static</code>  或  <code>final</code>  方法。</li>
</ul>
<p><code>@SafeVarargs</code>  示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SafeVarargsAnnotationDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">/**
     * 此方法实际上并不安全，不使用此注解，编译时会告警
     */</span>
    <span class="token annotation punctuation">@SafeVarargs</span>
    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">wrongMethod</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> stringLists<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array <span class="token operator">=</span> stringLists<span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> tmpList <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        array<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> tmpList<span class="token punctuation">;</span> <span class="token comment">// 语法错误，但是编译不告警</span>
        <span class="token class-name">String</span> s <span class="token operator">=</span> stringLists<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 运行时报 ClassCastException</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"B"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> list2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">wrongMethod</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> list2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>以上代码，如果不使用  <code>@SafeVarargs</code>  ，编译时会告警</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">[WARNING] /D:/Codes/ZP/Java/javacore/codes/basics/src/main/java/io/github/dunwu/javacore/annotation/SafeVarargsAnnotationDemo.java: 某些输入文件使用了未经检查或不安全的操作。
[WARNING] /D:/Codes/ZP/Java/javacore/codes/basics/src/main/java/io/github/dunwu/javacore/annotation/SafeVarargsAnnotationDemo.java: 有关详细信息, 请使用 -Xlint:unchecked 重新编译。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="-193"><a class="markdownIt-Anchor" href="#-193">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-annotation.html#_2-5-functionalinterface">#</a>2.5. @FunctionalInterface</h3>
<p><code>@FunctionalInterface</code>  在 JDK8 引入。</p>
<p><strong><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/api/java/lang/FunctionalInterface.html"> <code>@FunctionalInterface</code>  (opens new window)</a> 用于指示被修饰的接口是函数式接口。</strong></p>
<p>需要注意的是，如果一个接口符合 &quot;函数式接口&quot; 定义，不加  <code>@FunctionalInterface</code>  也没关系；但如果编写的不是函数式接口，却使用  <code>@FunctionInterface</code> ，那么编译器会报错。</p>
<p>什么是函数式接口？</p>
<p><strong>函数式接口 (Functional Interface) 就是一个有且仅有一个抽象方法，但是可以有多个非抽象方法的接口</strong>。函数式接口可以被隐式转换为 lambda 表达式。</p>
<p>函数式接口的特点：</p>
<ul>
<li>接口有且只能有个一个抽象方法（抽象方法只有方法定义，没有方法体）。</li>
<li>不能在接口中覆写 Object 类中的 public 方法（写了编译器也会报错）。</li>
<li>允许有 default 实现方法。</li>
</ul>
<p>示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FunctionalInterfaceAnnotationDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@FunctionalInterface</span>
    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Func1</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">void</span> <span class="token function">printMessage</span><span class="token punctuation">(</span><span class="token class-name">T</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * @FunctionalInterface 修饰的接口中定义两个抽象方法，编译时会报错
     * @param &lt;T>
     */</span>
    <span class="token comment">/*@FunctionalInterface
    public interface Func2&lt;T> &#123;
        void printMessage(T message);
        void printMessage2(T message);
    &#125;*/</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Func1</span> func1 <span class="token operator">=</span> message <span class="token operator">-></span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        func1<span class="token punctuation">.</span><span class="token function">printMessage</span><span class="token punctuation">(</span><span class="token string">"Hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        func1<span class="token punctuation">.</span><span class="token function">printMessage</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="-194"><a class="markdownIt-Anchor" href="#-194">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-annotation.html#_3-%E5%85%83%E6%B3%A8%E8%A7%A3">#</a>3. 元注解</h2>
<p>JDK 中虽然内置了几个注解，但这远远不能满足开发过程中遇到的千变万化的需求。所以我们需要自定义注解，而这就需要用到元注解。</p>
<p><strong>元注解的作用就是用于定义其它的注解</strong>。</p>
<p>Java 中提供了以下元注解类型：</p>
<ul>
<li><code>@Retention</code></li>
<li><code>@Target</code></li>
<li><code>@Documented</code></li>
<li><code>@Inherited</code> （JDK8 引入）</li>
<li><code>@Repeatable</code> （JDK8 引入）</li>
</ul>
<p>这些类型和它们所支持的类在  <code>java.lang.annotation</code>  包中可以找到。下面我们看一下每个元注解的作用和相应分参数的使用说明。</p>
<h3 id="-195"><a class="markdownIt-Anchor" href="#-195">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-annotation.html#_3-1-retention">#</a>3.1. @Retention</h3>
<p><strong><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/api/java/lang/annotation/Retention.html"> <code>@Retention</code>  (opens new window)</a> 指明了注解的保留级别。</strong></p>
<p><code>@Retention</code>  源码：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Documented</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span>RUNTIME<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span>ANNOTATION_TYPE<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">Retention</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">RetentionPolicy</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>RetentionPolicy</code>  是一个枚举类型，它定义了被  <code>@Retention</code>  修饰的注解所支持的保留级别：</p>
<ul>
<li><code>RetentionPolicy.SOURCE</code>  - 标记的注解仅在源文件中有效，编译器会忽略。</li>
<li><code>RetentionPolicy.CLASS</code>  - 标记的注解在 class 文件中有效，JVM 会忽略。</li>
<li><code>RetentionPolicy.RUNTIME</code>  - 标记的注解在运行时有效。</li>
</ul>
<p><code>@Retention</code>  示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span>FIELD<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span>RUNTIME<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">Column</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">"fieldName"</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">setFuncName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">"setField"</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getFuncName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">"getField"</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">defaultDBValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-196"><a class="markdownIt-Anchor" href="#-196">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-annotation.html#_3-2-documented">#</a>3.2. @Documented</h3>
<p><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/api/java/lang/annotation/Documented.html"> <code>@Documented</code>  (opens new window)</a> 表示无论何时使用指定的注解，都应使用 Javadoc（默认情况下，注释不包含在 Javadoc 中）。更多内容可以参考：<a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/technotes/guides/javadoc/index.html">Javadoc tools page (opens new window)</a>。</p>
<p><code>@Documented</code>  示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span>FIELD<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span>RUNTIME<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Documented</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">Column</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">"fieldName"</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">setFuncName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">"setField"</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getFuncName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">"getField"</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">defaultDBValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-197"><a class="markdownIt-Anchor" href="#-197">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-annotation.html#_3-3-target">#</a>3.3. @Target</h3>
<p><strong><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/api/java/lang/annotation/Target.html"> <code>@Target</code>  (opens new window)</a> 指定注解可以修饰的元素类型。</strong></p>
<p><code>@Target</code>  源码：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Documented</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span>RUNTIME<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span>ANNOTATION_TYPE<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">Target</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">ElementType</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>ElementType</code>  是一个枚举类型，它定义了被  <code>@Target</code>  修饰的注解可以应用的范围：</p>
<ul>
<li><code>ElementType.ANNOTATION_TYPE</code>  - 标记的注解可以应用于注解类型。</li>
<li><code>ElementType.CONSTRUCTOR</code>  - 标记的注解可以应用于构造函数。</li>
<li><code>ElementType.FIELD</code>  - 标记的注解可以应用于字段或属性。</li>
<li><code>ElementType.LOCAL_VARIABLE</code>  - 标记的注解可以应用于局部变量。</li>
<li><code>ElementType.METHOD</code>  - 标记的注解可以应用于方法。</li>
<li><code>ElementType.PACKAGE</code>  - 标记的注解可以应用于包声明。</li>
<li><code>ElementType.PARAMETER</code>  - 标记的注解可以应用于方法的参数。</li>
<li><code>ElementType.TYPE</code>  - 标记的注解可以应用于类的任何元素。</li>
</ul>
<p><code>@Target</code>  示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span>TYPE<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">Table</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">/**
     * 数据表名称注解，默认值为类名称
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">tableName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">"className"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span>FIELD<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">NoDBColumn</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-198"><a class="markdownIt-Anchor" href="#-198">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-annotation.html#_3-4-inherited">#</a>3.4. @Inherited</h3>
<p><strong><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/api/java/lang/annotation/Inherited.html"> <code>@Inherited</code>  (opens new window)</a> 表示注解类型可以被继承（默认情况下不是这样）</strong>。</p>
<p>表示自动继承注解类型。 如果注解类型声明中存在  <code>@Inherited</code>  元注解，则注解所修饰类的所有子类都将会继承此注解。</p>
<blockquote>
<p>🔔 注意： <code>@Inherited</code>  注解类型是被标注过的类的子类所继承。类并不从它所实现的接口继承注解，方法并不从它所覆写的方法继承注解。</p>
<p>此外，当  <code>@Inherited</code>  类型标注的注解的  <code>@Retention</code>  是  <code>RetentionPolicy.RUNTIME</code> ，则反射 API 增强了这种继承性。如果我们使用  <code>java.lang.reflect</code>  去查询一个  <code>@Inherited</code>  类型的注解时，反射代码检查将展开工作：检查类和其父类，直到发现指定的注解类型被发现，或者到达类继承结构的顶层。</p>
</blockquote>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Inherited</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">Greeting</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">FontColor</span><span class="token punctuation">&#123;</span> BULE<span class="token punctuation">,</span>RED<span class="token punctuation">,</span>GREEN<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">FontColor</span> <span class="token function">fontColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token class-name">FontColor</span><span class="token punctuation">.</span>GREEN<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-199"><a class="markdownIt-Anchor" href="#-199">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-annotation.html#_3-5-repeatable">#</a>3.5. @Repeatable</h3>
<p><strong><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/api/java/lang/annotation/Repeatable.html"> <code>@Repeatable</code>  (opens new window)</a> 表示注解可以重复使用。</strong></p>
<p>以 Spring  <code>@Scheduled</code>  为例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span>METHOD<span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span>ANNOTATION_TYPE<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span>RUNTIME<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Documented</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">Schedules</span> <span class="token punctuation">&#123;</span>
	<span class="token class-name">Scheduled</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span>METHOD<span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span>ANNOTATION_TYPE<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span>RUNTIME<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Documented</span>
<span class="token annotation punctuation">@Repeatable</span><span class="token punctuation">(</span><span class="token class-name">Schedules</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">Scheduled</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>应用示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TaskRunner</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Scheduled</span><span class="token punctuation">(</span><span class="token string">"0 0/15 * * * ?"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Scheduled</span><span class="token punctuation">(</span><span class="token string">"0 0 12 * ?"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">task1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="-200"><a class="markdownIt-Anchor" href="#-200">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-annotation.html#_4-%E8%87%AA%E5%AE%9A%E4%B9%89%E6%B3%A8%E8%A7%A3">#</a>4. 自定义注解</h2>
<p>使用  <code>@interface</code>  自定义注解时，自动继承了  <code>java.lang.annotation.Annotation</code>  接口，由编译程序自动完成其他细节。在定义注解时，不能继承其他的注解或接口。 <code>@interface</code>  用来声明一个注解，其中的每一个方法实际上是声明了一个配置参数。方法的名称就是参数的名称，返回值类型就是参数的类型（返回值类型只能是基本类型、Class、String、enum）。可以通过  <code>default</code>  来声明参数的默认值。</p>
<p>这里，我会通过实现一个名为  <code>RegexValid</code>  的正则校验注解工具来展示自定义注解的全步骤。</p>
<h3 id="-201"><a class="markdownIt-Anchor" href="#-201">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-annotation.html#_4-1-%E6%B3%A8%E8%A7%A3%E7%9A%84%E5%AE%9A%E4%B9%89">#</a>4.1. 注解的定义</h3>
<p>注解的语法格式如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> 注解名 <span class="token punctuation">&#123;</span>定义体<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>我们来定义一个注解：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Documented</span>
<span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span>FIELD<span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span>PARAMETER<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span>RUNTIME<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">RegexValid</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>说明：</p>
<p>通过上一节对于元注解 <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-annotation.html#target"> <code>@Target</code> </a>、<a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-annotation.html#retention"> <code>@Retention</code> </a>、<a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-annotation.html#documented"> <code>@Documented</code> </a> 的说明，这里就很容易理解了。</p>
<ul>
<li>上面的代码中定义了一个名为  <code>@RegexValid</code>  的注解。</li>
<li><code>@Documented</code>  表示  <code>@RegexValid</code>  应该使用 javadoc。</li>
<li><code>@Target(&#123;ElementType.FIELD, ElementType.PARAMETER&#125;)</code>  表示  <code>@RegexValid</code>  可以在类成员或方法参数上修饰。</li>
<li>@Retention (RetentionPolicy.RUNTIME) 表示  <code>@RegexValid</code>  在运行时有效。</li>
</ul>
</blockquote>
<p>此时，我们已经定义了一个没有任何属性的注解，如果到此为止，它仅仅是一个标记注解。作为正则工具，没有属性可什么也做不了。接下来，我们将为它添加注解属性。</p>
<h3 id="-202"><a class="markdownIt-Anchor" href="#-202">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-annotation.html#_4-2-%E6%B3%A8%E8%A7%A3%E5%B1%9E%E6%80%A7">#</a>4.2. 注解属性</h3>
<p>注解属性的语法形式如下：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">[访问级别修饰符] [数据类型] 名称() default 默认值;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>例如，我们要定义在注解中定义一个名为 value 的字符串属性，其默认值为空字符串，访问级别为默认级别，那么应该定义如下：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">String value() default "";<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<blockquote>
<p>🔔 注意：<strong>在注解中，我们定义属性时，属性名后面需要加  <code>()</code> </strong>。</p>
</blockquote>
<p>定义注解属性有以下要点：</p>
<ul>
<li><strong>注解属性只能使用  <code>public</code>  或默认访问级别（即不指定访问级别修饰符）修饰</strong>。</li>
<li><strong>注解属性的数据类型有限制要求</strong>。支持的数据类型如下：
<ul>
<li>所有基本数据类型（byte、char、short、int、long、float、double、boolean）</li>
<li>String 类型</li>
<li>Class 类</li>
<li>enum 类型</li>
<li>Annotation 类型</li>
<li>以上所有类型的数组</li>
</ul>
</li>
<li><strong>注解属性必须有确定的值，建议指定默认值</strong>。注解属性只能通过指定默认值或使用注解时指定属性值，相较之下，指定默认值的方式更为可靠。注解属性如果是引用类型，不可以为 null。这个约束使得注解处理器很难判断注解属性是默认值，或是使用注解时所指定的属性值。为此，我们设置默认值时，一般会定义一些特殊的值，例如空字符串或者负数。</li>
<li>如果注解中只有一个属性值，最好将其命名为 value。因为，指定属性名为 value，在使用注解时，指定 value 的值可以不指定属性名称。</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 这两种方式效果相同</span>
<span class="token annotation punctuation">@RegexValid</span><span class="token punctuation">(</span><span class="token string">"^((\\+)?86\\s*)?((13[0-9])|(15([0-3]|[5-9]))|(18[0,2,5-9]))\\d&#123;8&#125;$"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RegexValid</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"^((\\+)?86\\s*)?((13[0-9])|(15([0-3]|[5-9]))|(18[0,2,5-9]))\\d&#123;8&#125;$"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>示例：</p>
<p>了解了注解属性的定义要点，让我们来为  <code>@RegexValid</code>  注解定义几个属性。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Documented</span>
<span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span>FIELD<span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span>PARAMETER<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span>RUNTIME<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">RegexValid</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">enum</span> <span class="token class-name">Policy</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// @formatter:off</span>
        <span class="token function">EMPTY</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">DATE</span><span class="token punctuation">(</span><span class="token string">"^(?:(?!0000)[0-9]&#123;4&#125;([-/.]?)(?:(?:0?[1-9]|1[0-2])\\1(?:0?[1-9]|1[0-9]|2[0-8])|(?:0?[13-9]|1[0-2])\\1"</span>
            <span class="token operator">+</span> <span class="token string">"(?:29|30)|(?:0?[13578]|1[02])\\1(?:31))|(?:[0-9]&#123;2&#125;(?:0[48]|[2468][048]|[13579][26])|"</span>
            <span class="token operator">+</span> <span class="token string">"(?:0[48]|[2468][048]|[13579][26])00)([-/.]?)0?2\\2(?:29))$"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">MAIL</span><span class="token punctuation">(</span><span class="token string">"^[A-Za-z0-9](([_\\.\\-]?[a-zA-Z0-9]+)*)@([A-Za-z0-9]+)(([\\.\\-]?[a-zA-Z0-9]+)*)\\.([A-Za-z]&#123;2,&#125;)$"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// @formatter:on</span>

        <span class="token keyword">private</span> <span class="token class-name">String</span> policy<span class="token punctuation">;</span>

        <span class="token class-name">Policy</span><span class="token punctuation">(</span><span class="token class-name">String</span> policy<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>policy <span class="token operator">=</span> policy<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> policy<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token class-name">String</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">""</span><span class="token punctuation">;</span>
    <span class="token class-name">Policy</span> <span class="token function">policy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token class-name">Policy</span><span class="token punctuation">.</span>EMPTY<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>说明：</p>
<p>在上面的示例代码中，我们定义了两个注解属性： <code>String</code>  类型的 value 属性和  <code>Policy</code>  枚举类型的 policy 属性。 <code>Policy</code>  枚举中定义了几个默认的正则表达式，这是为了直接使用这几个常用表达式去正则校验。考虑到，我们可能需要自己传入一些自定义正则表达式去校验其他场景，所以定义了 value 属性，允许使用者传入正则表达式。</p>
</blockquote>
<p>至此， <code>@RegexValid</code>  的声明已经结束。但是，程序仍不知道如何处理  <code>@RegexValid</code>  这个注解。我们还需要定义注解处理器。</p>
<h3 id="-203"><a class="markdownIt-Anchor" href="#-203">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-annotation.html#_4-3-%E6%B3%A8%E8%A7%A3%E5%A4%84%E7%90%86%E5%99%A8">#</a>4.3. 注解处理器</h3>
<p>如果没有用来读取注解的方法和工作，那么注解也就不会比注释更有用处了。使用注解的过程中，很重要的一部分就是创建于使用注解处理器。JDK5 扩展了反射机制的 API，以帮助程序员快速的构造自定义注解处理器。</p>
<p><strong> <code>java.lang.annotation.Annotation</code>  是一个接口，程序可以通过反射来获取指定程序元素的注解对象，然后通过注解对象来获取注解里面的元数据</strong>。</p>
<p><code>Annotation</code>  接口源码如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Annotation</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">boolean</span> <span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> <span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Annotation</span><span class="token punctuation">></span></span> <span class="token function">annotationType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>除此之外，Java 中支持<strong>注解处理器接口  <code>java.lang.reflect.AnnotatedElement</code> </strong> ，该接口代表程序中可以接受注解的程序元素，该接口主要有如下几个实现类：</p>
<ul>
<li><code>Class</code>  - 类定义</li>
<li><code>Constructor</code>  - 构造器定义</li>
<li><code>Field</code>  - 累的成员变量定义</li>
<li><code>Method</code>  - 类的方法定义</li>
<li><code>Package</code>  - 类的包定义</li>
</ul>
<p><code>java.lang.reflect</code>  包下主要包含一些实现反射功能的工具类。实际上， <code>java.lang.reflect</code>  包所有提供的反射 API 扩充了读取运行时注解信息的能力。当一个注解类型被定义为运行时的注解后，该注解才能是运行时可见，当 class 文件被装载时被保存在 class 文件中的注解才会被虚拟机读取。  <code>AnnotatedElement</code>  接口是所有程序元素（Class、Method 和 Constructor）的父接口，所以程序通过反射获取了某个类的 <code>AnnotatedElement</code>  对象之后，程序就可以调用该对象的如下四个个方法来访问注解信息：</p>
<ul>
<li><code>getAnnotation</code>  - 返回该程序元素上存在的、指定类型的注解，如果该类型注解不存在，则返回 null。</li>
<li><code>getAnnotations</code>  - 返回该程序元素上存在的所有注解。</li>
<li><code>isAnnotationPresent</code>  - 判断该程序元素上是否包含指定类型的注解，存在则返回 true，否则返回 false。</li>
<li><code>getDeclaredAnnotations</code>  - 返回直接存在于此元素上的所有注释。与此接口中的其他方法不同，该方法将忽略继承的注释。（如果没有注释直接存在于此元素上，则返回长度为零的一个数组。）该方法的调用者可以随意修改返回的数组；这不会对其他调用者返回的数组产生任何影响。</li>
</ul>
<p>了解了以上内容，让我们来实现  <code>@RegexValid</code>  的注解处理器：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Field</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>regex<span class="token punctuation">.</span></span><span class="token class-name">Matcher</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>regex<span class="token punctuation">.</span></span><span class="token class-name">Pattern</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RegexValidUtil</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">check</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">boolean</span> result <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token class-name">StringBuilder</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Field</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Field</span> field <span class="token operator">:</span> fields<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 判断成员是否被 @RegexValid 注解所修饰</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>field<span class="token punctuation">.</span><span class="token function">isAnnotationPresent</span><span class="token punctuation">(</span><span class="token class-name">RegexValid</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">RegexValid</span> valid <span class="token operator">=</span> field<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">RegexValid</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 如果 value 为空字符串，说明没有注入自定义正则表达式，改用 policy 属性</span>
                <span class="token class-name">String</span> value <span class="token operator">=</span> valid<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token class-name">RegexValid<span class="token punctuation">.</span>Policy</span> policy <span class="token operator">=</span> valid<span class="token punctuation">.</span><span class="token function">policy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    value <span class="token operator">=</span> policy<span class="token punctuation">.</span><span class="token function">getPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>

                <span class="token comment">// 通过设置 setAccessible(true) 来访问私有成员</span>
                field<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Object</span> fieldObj <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                    fieldObj <span class="token operator">=</span> field<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalAccessException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>fieldObj <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%s 类中的 %s 字段不能为空！"</span><span class="token punctuation">,</span> obj<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> field<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    result <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>fieldObj <span class="token keyword">instanceof</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token class-name">String</span> text <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> fieldObj<span class="token punctuation">;</span>
                        <span class="token class-name">Pattern</span> p <span class="token operator">=</span> <span class="token class-name">Pattern</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">Matcher</span> m <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">matcher</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        result <span class="token operator">=</span> m<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%s 不是合法的 %s ！"</span><span class="token punctuation">,</span> text<span class="token punctuation">,</span> field<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>
                            <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%s 类中的 %s 字段不是字符串类型，不能使用此注解校验！"</span><span class="token punctuation">,</span> obj<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> field<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        result <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>sb<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span>sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>说明：</p>
<p>以上示例中的注解处理器，执行步骤如下：</p>
<ol>
<li>通过 getDeclaredFields 反射方法获取传入对象的所有成员。</li>
<li>遍历成员，使用 isAnnotationPresent 判断成员是否被指定注解所修饰，如果不是，直接跳过。</li>
<li>如果成员被注解所修饰，通过  <code>RegexValid valid = field.getAnnotation(RegexValid.class);</code>  这样的形式获取，注解实例化对象，然后，就可以使用  <code>valid.value()</code>  或  <code>valid.policy()</code>  这样的形式获取注解中设定的属性值。</li>
<li>根据属性值，进行逻辑处理。</li>
</ol>
</blockquote>
<h3 id="-204"><a class="markdownIt-Anchor" href="#-204">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-annotation.html#_4-4-%E4%BD%BF%E7%94%A8%E6%B3%A8%E8%A7%A3">#</a>4.4. 使用注解</h3>
<p>完成了以上工作，我们就可以使用自定义注解了，示例如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RegexValidDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
        <span class="token annotation punctuation">@RegexValid</span><span class="token punctuation">(</span>policy <span class="token operator">=</span> <span class="token class-name">RegexValid<span class="token punctuation">.</span>Policy</span><span class="token punctuation">.</span>DATE<span class="token punctuation">)</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> date<span class="token punctuation">;</span>
        <span class="token annotation punctuation">@RegexValid</span><span class="token punctuation">(</span>policy <span class="token operator">=</span> <span class="token class-name">RegexValid<span class="token punctuation">.</span>Policy</span><span class="token punctuation">.</span>MAIL<span class="token punctuation">)</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> mail<span class="token punctuation">;</span>
        <span class="token annotation punctuation">@RegexValid</span><span class="token punctuation">(</span><span class="token string">"^((\\+)?86\\s*)?((13[0-9])|(15([0-3]|[5-9]))|(18[0,2,5-9]))\\d&#123;8&#125;$"</span><span class="token punctuation">)</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> phone<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">String</span> date<span class="token punctuation">,</span> <span class="token class-name">String</span> mail<span class="token punctuation">,</span> <span class="token class-name">String</span> phone<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>date <span class="token operator">=</span> date<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>mail <span class="token operator">=</span> mail<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>phone <span class="token operator">=</span> phone<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token string">"User&#123;"</span> <span class="token operator">+</span> <span class="token string">"name='"</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">'\''</span> <span class="token operator">+</span> <span class="token string">", date='"</span> <span class="token operator">+</span> date <span class="token operator">+</span> <span class="token string">'\''</span> <span class="token operator">+</span> <span class="token string">", mail='"</span> <span class="token operator">+</span> mail <span class="token operator">+</span> <span class="token string">'\''</span> <span class="token operator">+</span> <span class="token string">", phone='"</span>
                <span class="token operator">+</span> phone <span class="token operator">+</span> <span class="token string">'\''</span> <span class="token operator">+</span> <span class="token string">'&#125;'</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">printDate</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RegexValid</span><span class="token punctuation">(</span>policy <span class="token operator">=</span> <span class="token class-name">RegexValid<span class="token punctuation">.</span>Policy</span><span class="token punctuation">.</span>DATE<span class="token punctuation">)</span> <span class="token class-name">String</span> date<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">"Tom"</span><span class="token punctuation">,</span> <span class="token string">"1990-01-31"</span><span class="token punctuation">,</span> <span class="token string">"xxx@163.com"</span><span class="token punctuation">,</span> <span class="token string">"18612341234"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">User</span> user2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">"Jack"</span><span class="token punctuation">,</span> <span class="token string">"2019-02-29"</span><span class="token punctuation">,</span> <span class="token string">"sadhgs"</span><span class="token punctuation">,</span> <span class="token string">"183xxxxxxxx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">RegexValidUtil</span><span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>user <span class="token operator">+</span> <span class="token string">"正则校验通过"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">RegexValidUtil</span><span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>user2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>user2 <span class="token operator">+</span> <span class="token string">"正则校验通过"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="-205"><a class="markdownIt-Anchor" href="#-205">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/basics/java-annotation.html#_5-%E5%B0%8F%E7%BB%93">#</a>5. 小结</h2>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/cs/java/javacore/xmind/%E6%B3%A8%E8%A7%A3%E7%AE%80%E4%BB%8B.svg" alt="img"></p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/cs/java/javacore/xmind/%E5%85%83%E6%B3%A8%E8%A7%A3.svg" alt="img"></p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/cs/java/javacore/xmind/%E5%86%85%E7%BD%AE%E6%B3%A8%E8%A7%A3.svg" alt="img"></p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/cs/java/javacore/xmind/%E8%87%AA%E5%AE%9A%E4%B9%89%E6%B3%A8%E8%A7%A3.svg" alt="img"></p>
<hr>
<h1 id="java-正则从入门到精通"><a class="markdownIt-Anchor" href="#java-正则从入门到精通">#</a> Java 正则从入门到精通</h1>
<blockquote>
<p><strong>📦 本文以及示例源码已归档在 <a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/">javacore(opens new window)</a></strong></p>
<p>关键词：Pattern、Matcher、捕获与非捕获、反向引用、零宽断言、贪婪与懒惰、元字符、DFA、NFA</p>
</blockquote>
<ul>
<li>\1. 正则简介
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#11-%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%98%AF%E4%BB%80%E4%B9%88">1.1. 正则表达式是什么</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#12-%E5%A6%82%E4%BD%95%E5%AD%A6%E4%B9%A0%E6%AD%A3%E5%88%99">1.2. 如何学习正则</a></li>
</ul>
</li>
<li>\2. 正则工具类
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#21-pattern-%E7%B1%BB">2.1. Pattern 类</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#22-matcher-%E7%B1%BB">2.2. Matcher 类</a></li>
</ul>
</li>
<li>\3. 元字符
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#31-%E5%9F%BA%E6%9C%AC%E5%85%83%E5%AD%97%E7%AC%A6">3.1. 基本元字符</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#32-%E7%AD%89%E4%BB%B7%E5%AD%97%E7%AC%A6">3.2. 等价字符</a></li>
</ul>
</li>
<li>\4. 分组构造
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#41-%E6%8D%95%E8%8E%B7%E4%B8%8E%E9%9D%9E%E6%8D%95%E8%8E%B7">4.1. 捕获与非捕获</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#42-%E5%8F%8D%E5%90%91%E5%BC%95%E7%94%A8">4.2. 反向引用</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#43-%E9%9D%9E%E6%8D%95%E8%8E%B7%E7%BB%84">4.3. 非捕获组</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#44-%E9%9B%B6%E5%AE%BD%E6%96%AD%E8%A8%80">4.4. 零宽断言</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#5-%E8%B4%AA%E5%A9%AA%E4%B8%8E%E6%87%92%E6%83%B0">5. 贪婪与懒惰</a></li>
<li>\6. 正则附录
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#61-%E5%8C%B9%E9%85%8D%E6%AD%A3%E5%88%99%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9A%84%E6%96%B9%E6%B3%95">6.1. 匹配正则字符串的方法</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#62-%E9%80%9F%E6%9F%A5%E5%85%83%E5%AD%97%E7%AC%A6%E5%AD%97%E5%85%B8">6.2. 速查元字符字典</a></li>
</ul>
</li>
<li>\7. 正则实战
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#71-%E6%9C%80%E5%AE%9E%E7%94%A8%E7%9A%84%E6%AD%A3%E5%88%99">7.1. 最实用的正则</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#72-%E7%89%B9%E5%AE%9A%E5%AD%97%E7%AC%A6">7.2. 特定字符</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#73-%E7%89%B9%E5%AE%9A%E6%95%B0%E5%AD%97">7.3. 特定数字</a></li>
</ul>
</li>
<li>\8. 正则表达式的性能
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#81-nfa-%E8%87%AA%E5%8A%A8%E6%9C%BA%E7%9A%84%E5%9B%9E%E6%BA%AF">8.1. NFA 自动机的回溯</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#82-%E5%A6%82%E4%BD%95%E9%81%BF%E5%85%8D%E5%9B%9E%E6%BA%AF">8.2. 如何避免回溯</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#83-%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E7%9A%84%E4%BC%98%E5%8C%96">8.3. 正则表达式的优化</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#9-%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">9. 参考资料</a></li>
</ul>
<h2 id="-206"><a class="markdownIt-Anchor" href="#-206">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#_1-%E6%AD%A3%E5%88%99%E7%AE%80%E4%BB%8B">#</a>1. 正则简介</h2>
<h3 id="-207"><a class="markdownIt-Anchor" href="#-207">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#_1-1-%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%98%AF%E4%BB%80%E4%B9%88">#</a>1.1. 正则表达式是什么</h3>
<p>正则表达式（Regular Expression）是一个用正则符号写出的公式，程序对这个公式进行语法分析，建立一个语法分析树，再根据这个分析树结合正则表达式的引擎生成执行程序（这个执行程序我们把它称作状态机，也叫状态自动机），用于字符匹配。</p>
<h3 id="-208"><a class="markdownIt-Anchor" href="#-208">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#_1-2-%E5%A6%82%E4%BD%95%E5%AD%A6%E4%B9%A0%E6%AD%A3%E5%88%99">#</a>1.2. 如何学习正则</h3>
<p>正则表达式是一个强大的文本匹配工具，但是它的规则很复杂，理解起来较为困难，容易让人望而生畏。</p>
<p>刚接触正则时，我看了一堆正则的语义说明，但是仍然不明所以。后来，我多接触一些正则的应用实例，渐渐有了感觉，再结合语义说明，终有领悟。我觉得正则表达式和武侠修练武功差不多，应该先练招式，再练心法。如果一开始就直接看正则的规则，保证你会懵逼。当你熟悉基本招式（正则基本使用案例）后，也该修炼修炼心法（正则语法）了。真正的高手不能只靠死记硬背那么几招把式。就像张三丰教张无忌太极拳一样，领悟心法，融会贯通，少侠你就可以无招胜有招，成为传说中的绝世高手。</p>
<p><strong>以上闲话可归纳为一句：学习正则应该从实例去理解规则。</strong></p>
<h2 id="-209"><a class="markdownIt-Anchor" href="#-209">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#_2-%E6%AD%A3%E5%88%99%E5%B7%A5%E5%85%B7%E7%B1%BB">#</a>2. 正则工具类</h2>
<p>JDK 中的  <code>java.util.regex</code>  包提供了对正则表达式的支持。</p>
<p><code>java.util.regex</code>  有三个核心类：</p>
<ul>
<li><strong>Pattern 类：</strong> <code>Pattern</code>  是一个正则表达式的编译表示。</li>
<li><strong>Matcher 类：</strong> <code>Matcher</code>  是对输入字符串进行解释和匹配操作的引擎。</li>
<li><strong>PatternSyntaxException：</strong> <code>PatternSyntaxException</code>  是一个非强制异常类，它表示一个正则表达式模式中的语法错误。</li>
</ul>
<p>** 注：** 需要格外注意一点，在 Java 中使用反斜杠 &quot;&quot; 时必须写成  <code>&quot;\\&quot;</code> 。所以本文的代码出现形如  <code>String regex = &quot;\\$\\&#123;.*?\\&#125;&quot;</code>  其实就是  <code>\$\&#123;.\*?\&#125;</code> 。</p>
<h3 id="-210"><a class="markdownIt-Anchor" href="#-210">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#_2-1-pattern-%E7%B1%BB">#</a>2.1. Pattern 类</h3>
<p><code>Pattern</code>  类没有公共构造方法。要创建一个 <code>Pattern</code>  对象，你必须首先调用其<strong>静态方法</strong> <code>compile</code> ，加载正则规则字符串，然后返回一个 Pattern 对象。</p>
<p>与 <code>Pattern</code>  类一样， <code>Matcher</code>  类也没有公共构造方法。你需要调用 <code>Pattern</code>  对象的 <code>matcher</code>  方法来获得一个 <code>Matcher</code>  对象。</p>
<p>【示例】Pattern 和 Matcher 的初始化</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Pattern</span> p <span class="token operator">=</span> <span class="token class-name">Pattern</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>regex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Matcher</span> m <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">matcher</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="-211"><a class="markdownIt-Anchor" href="#-211">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#_2-2-matcher-%E7%B1%BB">#</a>2.2. Matcher 类</h3>
<p><code>Matcher</code>  类可以说是  <code>java.util.regex</code>  中的核心类，它有三类功能：校验、查找、替换。</p>
<h4 id="-212"><a class="markdownIt-Anchor" href="#-212">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#%E6%A0%A1%E9%AA%8C">#</a>校验</h4>
<p>为了校验文本是否与正则规则匹配，Matcher 提供了以下几个返回值为  <code>boolean</code>  的方法。</p>
<table>
<thead>
<tr>
<th><strong>序号</strong></th>
<th><strong>方法及说明</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>**public boolean lookingAt () ** 尝试将从区域开头开始的输入序列与该模式匹配。</td>
</tr>
<tr>
<td>2</td>
<td>**public boolean find () ** 尝试查找与该模式匹配的输入序列的下一个子序列。</td>
</tr>
<tr>
<td>3</td>
<td>**public boolean find (int start）** 重置此匹配器，然后尝试查找匹配该模式、从指定索引开始的输入序列的下一个子序列。</td>
</tr>
<tr>
<td>4</td>
<td>**public boolean matches () ** 尝试将整个区域与模式匹配。</td>
</tr>
</tbody>
</table>
<p>如果你傻傻分不清上面的查找方法有什么区别，那么下面一个例子就可以让你秒懂。</p>
<p>【示例】lookingAt、find、matches</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token function">checkLookingAt</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">,</span> <span class="token string">"helloworld"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">checkLookingAt</span><span class="token punctuation">(</span><span class="token string">"world"</span><span class="token punctuation">,</span> <span class="token string">"helloworld"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">checkFind</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">,</span> <span class="token string">"helloworld"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">checkFind</span><span class="token punctuation">(</span><span class="token string">"world"</span><span class="token punctuation">,</span> <span class="token string">"helloworld"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">,</span> <span class="token string">"helloworld"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"world"</span><span class="token punctuation">,</span> <span class="token string">"helloworld"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"helloworld"</span><span class="token punctuation">,</span> <span class="token string">"helloworld"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">checkLookingAt</span><span class="token punctuation">(</span><span class="token class-name">String</span> regex<span class="token punctuation">,</span> <span class="token class-name">String</span> content<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token class-name">Pattern</span> p <span class="token operator">=</span> <span class="token class-name">Pattern</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>regex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">Matcher</span> m <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">matcher</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token function">lookingAt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>content <span class="token operator">+</span> <span class="token string">"\tlookingAt： "</span> <span class="token operator">+</span> regex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>content <span class="token operator">+</span> <span class="token string">"\tnot lookingAt： "</span> <span class="token operator">+</span> regex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">checkFind</span><span class="token punctuation">(</span><span class="token class-name">String</span> regex<span class="token punctuation">,</span> <span class="token class-name">String</span> content<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token class-name">Pattern</span> p <span class="token operator">=</span> <span class="token class-name">Pattern</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>regex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">Matcher</span> m <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">matcher</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>content <span class="token operator">+</span> <span class="token string">"\tfind： "</span> <span class="token operator">+</span> regex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>content <span class="token operator">+</span> <span class="token string">"\tnot find： "</span> <span class="token operator">+</span> regex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token class-name">String</span> regex<span class="token punctuation">,</span> <span class="token class-name">String</span> content<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token class-name">Pattern</span> p <span class="token operator">=</span> <span class="token class-name">Pattern</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>regex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">Matcher</span> m <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">matcher</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>content <span class="token operator">+</span> <span class="token string">"\tmatches： "</span> <span class="token operator">+</span> regex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>content <span class="token operator">+</span> <span class="token string">"\tnot matches： "</span> <span class="token operator">+</span> regex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>输出：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">helloworld	lookingAt： hello
helloworld	not lookingAt： world
helloworld	find： hello
helloworld	find： world
helloworld	not matches： hello
helloworld	not matches： world
helloworld	matches： helloworld<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>说明</strong></p>
<p><code>regex = &quot;world&quot;</code>  表示的正则规则是以 world 开头的字符串， <code>regex = &quot;hello&quot;</code>  和  <code>regex = &quot;helloworld&quot;</code>  也是同理。</p>
<ul>
<li><code>lookingAt</code>  方法从头部开始，检查 content 字符串是否有子字符串于正则规则匹配。</li>
<li><code>find</code>  方法检查 content 字符串是否有子字符串于正则规则匹配，不管字符串所在位置。</li>
<li><code>matches</code>  方法检查 content 字符串整体是否与正则规则匹配。</li>
</ul>
<h4 id="-213"><a class="markdownIt-Anchor" href="#-213">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#%E6%9F%A5%E6%89%BE">#</a>查找</h4>
<p>为了查找文本匹配正则规则的位置， <code>Matcher</code>  提供了以下方法：</p>
<table>
<thead>
<tr>
<th><strong>序号</strong></th>
<th><strong>方法及说明</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>**public int start () ** 返回以前匹配的初始索引。</td>
</tr>
<tr>
<td>2</td>
<td><strong>public int start(int group)</strong> 返回在以前的匹配操作期间，由给定组所捕获的子序列的初始索引</td>
</tr>
<tr>
<td>3</td>
<td>**public int end ()** 返回最后匹配字符之后的偏移量。</td>
</tr>
<tr>
<td>4</td>
<td>**public int end (int group)** 返回在以前的匹配操作期间，由给定组所捕获子序列的最后字符之后的偏移量。</td>
</tr>
<tr>
<td>5</td>
<td>**public String group ()** 返回前一个符合匹配条件的子序列。</td>
</tr>
<tr>
<td>6</td>
<td>**public String group (int group)** 返回指定的符合匹配条件的子序列。</td>
</tr>
</tbody>
</table>
<p>【示例】使用 start ()、end ()、group () 查找所有匹配正则条件的子序列</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">final</span> <span class="token class-name">String</span> regex <span class="token operator">=</span> <span class="token string">"world"</span><span class="token punctuation">;</span>
	<span class="token keyword">final</span> <span class="token class-name">String</span> content <span class="token operator">=</span> <span class="token string">"helloworld helloworld"</span><span class="token punctuation">;</span>
	<span class="token class-name">Pattern</span> p <span class="token operator">=</span> <span class="token class-name">Pattern</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>regex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">Matcher</span> m <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">matcher</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"content: "</span> <span class="token operator">+</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		i<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"["</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">"th] found"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"start: "</span> <span class="token operator">+</span> m<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"end: "</span> <span class="token operator">+</span> m<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"group: "</span> <span class="token operator">+</span> m<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>输出</strong></p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">content: helloworld helloworld
[1th] found
start: 5, end: 10, group: world
[2th] found
start: 16, end: 21, group: world<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>说明</strong></p>
<p>例子很直白，不言自明了吧。</p>
<h4 id="-214"><a class="markdownIt-Anchor" href="#-214">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#%E6%9B%BF%E6%8D%A2">#</a>替换</h4>
<p>替换方法是替换输入字符串里文本的方法：</p>
<table>
<thead>
<tr>
<th><strong>序号</strong></th>
<th><strong>方法及说明</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>**public Matcher appendReplacement (StringBuffer sb, String replacement)** 实现非终端添加和替换步骤。</td>
</tr>
<tr>
<td>2</td>
<td>**public StringBuffer appendTail (StringBuffer sb)** 实现终端添加和替换步骤。</td>
</tr>
<tr>
<td>3</td>
<td>**public String replaceAll (String replacement) ** 替换模式与给定替换字符串相匹配的输入序列的每个子序列。</td>
</tr>
<tr>
<td>4</td>
<td><strong>public String replaceFirst(String replacement)</strong> 替换模式与给定替换字符串匹配的输入序列的第一个子序列。</td>
</tr>
<tr>
<td>5</td>
<td>**public static String quoteReplacement (String s)** 返回指定字符串的字面替换字符串。这个方法返回一个字符串，就像传递给 Matcher 类的 appendReplacement 方法一个字面字符串一样工作。</td>
</tr>
</tbody>
</table>
<p>【示例】replaceFirst 和 replaceAll</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token class-name">String</span> regex <span class="token operator">=</span> <span class="token string">"can"</span><span class="token punctuation">;</span>
	<span class="token class-name">String</span> replace <span class="token operator">=</span> <span class="token string">"can not"</span><span class="token punctuation">;</span>
	<span class="token class-name">String</span> content <span class="token operator">=</span> <span class="token string">"I can because I think I can."</span><span class="token punctuation">;</span>

	<span class="token class-name">Pattern</span> p <span class="token operator">=</span> <span class="token class-name">Pattern</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>regex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">Matcher</span> m <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">matcher</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"content: "</span> <span class="token operator">+</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"replaceFirst: "</span> <span class="token operator">+</span> m<span class="token punctuation">.</span><span class="token function">replaceFirst</span><span class="token punctuation">(</span>replace<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"replaceAll: "</span> <span class="token operator">+</span> m<span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span>replace<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>输出</strong></p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">content: I can because I think I can.
replaceFirst: I can not because I think I can.
replaceAll: I can not because I think I can not.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><strong>说明</strong></p>
<p>replaceFirst：替换第一个匹配正则规则的子序列。</p>
<p>replaceAll：替换所有匹配正则规则的子序列。</p>
<p>【示例】appendReplacement、appendTail 和 replaceAll</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token class-name">String</span> regex <span class="token operator">=</span> <span class="token string">"can"</span><span class="token punctuation">;</span>
	<span class="token class-name">String</span> replace <span class="token operator">=</span> <span class="token string">"can not"</span><span class="token punctuation">;</span>
	<span class="token class-name">String</span> content <span class="token operator">=</span> <span class="token string">"I can because I think I can."</span><span class="token punctuation">;</span>
	<span class="token class-name">StringBuffer</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">StringBuffer</span> sb2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"content: "</span> <span class="token operator">+</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">Pattern</span> p <span class="token operator">=</span> <span class="token class-name">Pattern</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>regex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">Matcher</span> m <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">matcher</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		m<span class="token punctuation">.</span><span class="token function">appendReplacement</span><span class="token punctuation">(</span>sb<span class="token punctuation">,</span> replace<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"appendReplacement: "</span> <span class="token operator">+</span> sb<span class="token punctuation">)</span><span class="token punctuation">;</span>
	m<span class="token punctuation">.</span><span class="token function">appendTail</span><span class="token punctuation">(</span>sb<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"appendTail: "</span> <span class="token operator">+</span> sb<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>输出</strong></p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">content: I can because I think I can.
appendReplacement: I can not because I think I can not
appendTail: I can not because I think I can not.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><strong>说明</strong></p>
<p>从输出结果可以看出， <code>appendReplacement</code>  和 <code>appendTail</code>  方法组合起来用，功能和 <code>replaceAll</code>  是一样的。</p>
<p>如果你查看 <code>replaceAll</code>  的源码，会发现其内部就是使用 <code>appendReplacement</code>  和 <code>appendTail</code>  方法组合来实现的。</p>
<p>【示例】quoteReplacement 和 replaceAll，解决特殊字符替换问题</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token class-name">String</span> regex <span class="token operator">=</span> <span class="token string">"\\$\\&#123;.*?\\&#125;"</span><span class="token punctuation">;</span>
	<span class="token class-name">String</span> replace <span class="token operator">=</span> <span class="token string">"$&#123;product&#125;"</span><span class="token punctuation">;</span>
	<span class="token class-name">String</span> content <span class="token operator">=</span> <span class="token string">"product is $&#123;productName&#125;."</span><span class="token punctuation">;</span>

	<span class="token class-name">Pattern</span> p <span class="token operator">=</span> <span class="token class-name">Pattern</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>regex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">Matcher</span> m <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">matcher</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">String</span> replaceAll <span class="token operator">=</span> m<span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span>replace<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"content: "</span> <span class="token operator">+</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"replaceAll: "</span> <span class="token operator">+</span> replaceAll<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>输出</strong></p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Exception in thread "main" java.lang.IllegalArgumentException: No group with name &#123;product&#125;
	at java.util.regex.Matcher.appendReplacement(Matcher.java:849)
	at java.util.regex.Matcher.replaceAll(Matcher.java:955)
	at org.zp.notes.javase.regex.RegexDemo.wrongMethod(RegexDemo.java:42)
	at org.zp.notes.javase.regex.RegexDemo.main(RegexDemo.java:18)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:498)
	at com.intellij.rt.execution.application.AppMain.main(AppMain.java:147)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>说明</strong></p>
<p><code>String regex = &quot;\\$\\&#123;.*?\\&#125;&quot;;</code>  表示匹配类似 <code>$&#123;name&#125;</code>  这样的字符串。由于 <code>$</code> 、 <code>&#123;</code>  、 <code>&#125;</code>  都是特殊字符，需要用反义字符 <code>\</code>  来修饰才能被当做一个字符串字符来处理。</p>
<p>上面的例子是想将  <code>$&#123;productName&#125;</code>  替换为  <code>$&#123;product&#125;</code>  ，然而 <code>replaceAll</code>  方法却将传入的字符串中的 <code>$</code>  当做特殊字符来处理了。结果产生异常。</p>
<p>如何解决这个问题？</p>
<p>JDK1.5 引入了 <code>quoteReplacement</code>  方法。它可以用来转换特殊字符。其实源码非常简单，就是判断字符串中如果有 <code>\</code>  或 <code>$</code> ，就为它加一个转义字符 <code>\</code></p>
<p>我们对上面的代码略作调整：</p>
<p><code>m.replaceAll(replace)</code>  改为 <code>m.replaceAll(Matcher.quoteReplacement(replace))</code> ，新代码如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token class-name">String</span> regex <span class="token operator">=</span> <span class="token string">"\\$\\&#123;.*?\\&#125;"</span><span class="token punctuation">;</span>
	<span class="token class-name">String</span> replace <span class="token operator">=</span> <span class="token string">"$&#123;product&#125;"</span><span class="token punctuation">;</span>
	<span class="token class-name">String</span> content <span class="token operator">=</span> <span class="token string">"product is $&#123;productName&#125;."</span><span class="token punctuation">;</span>

	<span class="token class-name">Pattern</span> p <span class="token operator">=</span> <span class="token class-name">Pattern</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>regex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">Matcher</span> m <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">matcher</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">String</span> replaceAll <span class="token operator">=</span> m<span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token class-name">Matcher</span><span class="token punctuation">.</span><span class="token function">quoteReplacement</span><span class="token punctuation">(</span>replace<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"content: "</span> <span class="token operator">+</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"replaceAll: "</span> <span class="token operator">+</span> replaceAll<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>输出</strong></p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">content: product is $&#123;productName&#125;.
replaceAll: product is $&#123;product&#125;.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><strong>说明</strong></p>
<p>字符串中如果有 <code>\</code>  或 <code>$</code> ，不能被正常解析的问题解决。</p>
<h2 id="-215"><a class="markdownIt-Anchor" href="#-215">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#_3-%E5%85%83%E5%AD%97%E7%AC%A6">#</a>3. 元字符</h2>
<p>元字符 (metacharacters) 就是正则表达式中具有特殊意义的专用字符。</p>
<h3 id="-216"><a class="markdownIt-Anchor" href="#-216">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#_3-1-%E5%9F%BA%E6%9C%AC%E5%85%83%E5%AD%97%E7%AC%A6">#</a>3.1. 基本元字符</h3>
<p>正则表达式的元字符难以记忆，很大程度上是因为有很多为了简化表达而出现的等价字符。而实际上最基本的元字符，并没有那么多。对于大部分的场景，基本元字符都可以搞定。让我们从一个个实例出发，由浅入深的去体会正则的奥妙。</p>
<h4 id="-217"><a class="markdownIt-Anchor" href="#-217">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#%E5%A4%9A%E9%80%89">#</a>多选（ <code>|</code> ）</h4>
<p>【示例】匹配一个确定的字符串</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"abc"</span><span class="token punctuation">,</span> <span class="token string">"abc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>如果要匹配一个确定的字符串，非常简单，如例 1 所示。但是，如果你不确定要匹配的字符串，希望有多个选择，怎么办？答案是：使用元字符 <code>|</code>  ，它的含义是或。</p>
<p>【示例】匹配多个可选的字符串</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 测试正则表达式字符：|</span>
<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span><span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"yes|no"</span><span class="token punctuation">,</span> <span class="token string">"yes"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span><span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"yes|no"</span><span class="token punctuation">,</span> <span class="token string">"no"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertFalse</span><span class="token punctuation">(</span><span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"yes|no"</span><span class="token punctuation">,</span> <span class="token string">"right"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 输出</span>
<span class="token comment">// yes	matches： yes|no</span>
<span class="token comment">// no	matches： yes|no</span>
<span class="token comment">// right	not matches： yes|no</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-218"><a class="markdownIt-Anchor" href="#-218">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#%E5%88%86%E7%BB%84">#</a>分组（ <code>()</code> ）</h4>
<p>如果你希望表达式由多个子表达式组成，你可以使用  <code>()</code> 。</p>
<p>【示例】匹配组合字符串</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span><span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"(play|end)(ing|ed)"</span><span class="token punctuation">,</span> <span class="token string">"ended"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span><span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"(play|end)(ing|ed)"</span><span class="token punctuation">,</span> <span class="token string">"ending"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span><span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"(play|end)(ing|ed)"</span><span class="token punctuation">,</span> <span class="token string">"playing"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span><span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"(play|end)(ing|ed)"</span><span class="token punctuation">,</span> <span class="token string">"played"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 输出</span>
<span class="token comment">// ended	matches： (play|end)(ing|ed)</span>
<span class="token comment">// ending	matches： (play|end)(ing|ed)</span>
<span class="token comment">// playing	matches： (play|end)(ing|ed)</span>
<span class="token comment">// played	matches： (play|end)(ing|ed)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-219"><a class="markdownIt-Anchor" href="#-219">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#%E6%8C%87%E5%AE%9A%E5%8D%95%E5%AD%97%E7%AC%A6%E6%9C%89%E6%95%88%E8%8C%83%E5%9B%B4">#</a>指定单字符有效范围（ <code>[]</code> ）</h4>
<p>前面展示了如何匹配字符串，但是很多时候你需要精确的匹配一个字符，这时可以使用 <code>[]</code>  。</p>
<p>【示例】字符在指定范围</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 测试正则表达式字符：[]</span>
<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span><span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"[abc]"</span><span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 字符只能是a、b、c</span>
<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span><span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"[a-z]"</span><span class="token punctuation">,</span> <span class="token string">"m"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 字符只能是a - z</span>
<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span><span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"[A-Z]"</span><span class="token punctuation">,</span> <span class="token string">"O"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 字符只能是A - Z</span>
<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span><span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"[a-zA-Z]"</span><span class="token punctuation">,</span> <span class="token string">"K"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 字符只能是a - z和A - Z</span>
<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span><span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"[a-zA-Z]"</span><span class="token punctuation">,</span> <span class="token string">"k"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span><span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"[0-9]"</span><span class="token punctuation">,</span> <span class="token string">"5"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 字符只能是0 - 9</span>

<span class="token comment">// 输出</span>
<span class="token comment">// b	matches： [abc]</span>
<span class="token comment">// m	matches： [a-z]</span>
<span class="token comment">// O	matches： [A-Z]</span>
<span class="token comment">// K	matches： [a-zA-Z]</span>
<span class="token comment">// k	matches： [a-zA-Z]</span>
<span class="token comment">// 5	matches： [0-9]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-220"><a class="markdownIt-Anchor" href="#-220">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#%E6%8C%87%E5%AE%9A%E5%8D%95%E5%AD%97%E7%AC%A6%E6%97%A0%E6%95%88%E8%8C%83%E5%9B%B4">#</a>指定单字符无效范围（  <code>[^]</code> ）</h4>
<p>【示例】字符不能在指定范围</p>
<p>如果需要匹配一个字符的逆操作，即字符不能在指定范围，可以使用 <code>[^]</code> 。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 测试正则表达式字符：[^]</span>
<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertFalse</span><span class="token punctuation">(</span><span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"[^abc]"</span><span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 字符不能是a、b、c</span>
<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertFalse</span><span class="token punctuation">(</span><span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"[^a-z]"</span><span class="token punctuation">,</span> <span class="token string">"m"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 字符不能是a - z</span>
<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertFalse</span><span class="token punctuation">(</span><span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"[^A-Z]"</span><span class="token punctuation">,</span> <span class="token string">"O"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 字符不能是A - Z</span>
<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertFalse</span><span class="token punctuation">(</span><span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"[^a-zA-Z]"</span><span class="token punctuation">,</span> <span class="token string">"K"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 字符不能是a - z和A - Z</span>
<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertFalse</span><span class="token punctuation">(</span><span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"[^a-zA-Z]"</span><span class="token punctuation">,</span> <span class="token string">"k"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertFalse</span><span class="token punctuation">(</span><span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"[^0-9]"</span><span class="token punctuation">,</span> <span class="token string">"5"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 字符不能是0 - 9</span>

<span class="token comment">// 输出</span>
<span class="token comment">// b	not matches： [^abc]</span>
<span class="token comment">// m	not matches： [^a-z]</span>
<span class="token comment">// O	not matches： [^A-Z]</span>
<span class="token comment">// K	not matches： [^a-zA-Z]</span>
<span class="token comment">// k	not matches： [^a-zA-Z]</span>
<span class="token comment">// 5	not matches： [^0-9]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-221"><a class="markdownIt-Anchor" href="#-221">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#%E9%99%90%E5%88%B6%E5%AD%97%E7%AC%A6%E6%95%B0%E9%87%8F">#</a>限制字符数量（ <code>&#123;&#125;</code> ）</h4>
<p>如果想要控制字符出现的次数，可以使用  <code>&#123;&#125;</code> 。</p>
<table>
<thead>
<tr>
<th>字符</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>&#123;n&#125;</code></td>
<td>n 是一个非负整数。匹配确定的 n 次。</td>
</tr>
<tr>
<td><code>&#123;n,&#125;</code></td>
<td>n 是一个非负整数。至少匹配 n 次。</td>
</tr>
<tr>
<td><code>&#123;n,m&#125;</code></td>
<td>m 和 n 均为非负整数，其中 n &lt;= m。最少匹配 n 次且最多匹配 m 次。</td>
</tr>
</tbody>
</table>
<p>【示例】限制字符出现次数</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// &#123;n&#125;: n 是一个非负整数。匹配确定的 n 次。</span>
<span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"ap&#123;1&#125;"</span><span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"ap&#123;1&#125;"</span><span class="token punctuation">,</span> <span class="token string">"ap"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"ap&#123;1&#125;"</span><span class="token punctuation">,</span> <span class="token string">"app"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"ap&#123;1&#125;"</span><span class="token punctuation">,</span> <span class="token string">"apppppppppp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// &#123;n,&#125;: n 是一个非负整数。至少匹配 n 次。</span>
<span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"ap&#123;1,&#125;"</span><span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"ap&#123;1,&#125;"</span><span class="token punctuation">,</span> <span class="token string">"ap"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"ap&#123;1,&#125;"</span><span class="token punctuation">,</span> <span class="token string">"app"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"ap&#123;1,&#125;"</span><span class="token punctuation">,</span> <span class="token string">"apppppppppp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// &#123;n,m&#125;: m 和 n 均为非负整数，其中 n &lt;= m。最少匹配 n 次且最多匹配 m 次。</span>
<span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"ap&#123;2,5&#125;"</span><span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"ap&#123;2,5&#125;"</span><span class="token punctuation">,</span> <span class="token string">"ap"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"ap&#123;2,5&#125;"</span><span class="token punctuation">,</span> <span class="token string">"app"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"ap&#123;2,5&#125;"</span><span class="token punctuation">,</span> <span class="token string">"apppppppppp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 输出</span>
<span class="token comment">// a	not matches： ap&#123;1&#125;</span>
<span class="token comment">// ap	matches： ap&#123;1&#125;</span>
<span class="token comment">// app	not matches： ap&#123;1&#125;</span>
<span class="token comment">// apppppppppp	not matches： ap&#123;1&#125;</span>
<span class="token comment">// a	not matches： ap&#123;1,&#125;</span>
<span class="token comment">// ap	matches： ap&#123;1,&#125;</span>
<span class="token comment">// app	matches： ap&#123;1,&#125;</span>
<span class="token comment">// apppppppppp	matches： ap&#123;1,&#125;</span>
<span class="token comment">// a	not matches： ap&#123;2,5&#125;</span>
<span class="token comment">// ap	not matches： ap&#123;2,5&#125;</span>
<span class="token comment">// app	matches： ap&#123;2,5&#125;</span>
<span class="token comment">// apppppppppp	not matches： ap&#123;2,5&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-222"><a class="markdownIt-Anchor" href="#-222">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#%E8%BD%AC%E4%B9%89%E5%AD%97%E7%AC%A6">#</a>转义字符（ <code>/</code> ）</h4>
<p>如果想要查找元字符本身，你需要使用转义符，使得正则引擎将其视作一个普通字符，而不是一个元字符去处理。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">* 的转义字符：\*
+ 的转义字符：\+
? 的转义字符：\?
^ 的转义字符：\^
$ 的转义字符：\$
. 的转义字符：\.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果是转义符  <code>\</code>  本身，你需要使用  <code>\\</code>  。</p>
<h4 id="-223"><a class="markdownIt-Anchor" href="#-223">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#%E6%8C%87%E5%AE%9A%E8%A1%A8%E8%BE%BE%E5%BC%8F%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9A%84%E5%BC%80%E5%A7%8B-%E5%92%8C%E7%BB%93%E5%B0%BE">#</a>指定表达式字符串的开始（ <code>^</code> ）和结尾（ <code>$</code> ）</h4>
<p>如果希望匹配的字符串必须以特定字符串开头，可以使用  <code>^</code>  。</p>
<blockquote>
<p>注意：请特别留意，这里的  <code>^</code>  一定要和  <code>[^]</code>  中的  <code>^</code>  区分。</p>
</blockquote>
<p>【示例】限制字符串头部</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span><span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"^app[a-z]&#123;0,&#125;"</span><span class="token punctuation">,</span> <span class="token string">"apple"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 字符串必须以app开头</span>
<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertFalse</span><span class="token punctuation">(</span><span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"^app[a-z]&#123;0,&#125;"</span><span class="token punctuation">,</span> <span class="token string">"aplause"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 输出</span>
<span class="token comment">// apple	matches： ^app[a-z]&#123;0,&#125;</span>
<span class="token comment">// aplause	not matches： ^app[a-z]&#123;0,&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果希望匹配的字符串必须以特定字符串结尾，可以使用  <code>$</code>  。</p>
<p>【示例】限制字符串尾部</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span><span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"[a-z]&#123;0,&#125;ing$"</span><span class="token punctuation">,</span> <span class="token string">"playing"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 字符串必须以ing结尾</span>
<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertFalse</span><span class="token punctuation">(</span><span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"[a-z]&#123;0,&#125;ing$"</span><span class="token punctuation">,</span> <span class="token string">"long"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 输出</span>
<span class="token comment">// playing	matches： [a-z]&#123;0,&#125;ing$</span>
<span class="token comment">// long	not matches： [a-z]&#123;0,&#125;ing$</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-224"><a class="markdownIt-Anchor" href="#-224">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#_3-2-%E7%AD%89%E4%BB%B7%E5%AD%97%E7%AC%A6">#</a>3.2. 等价字符</h3>
<p>等价字符，顾名思义，就是对于基本元字符表达的一种简化（等价字符的功能都可以通过基本元字符来实现）。</p>
<p>在没有掌握基本元字符之前，可以先不用理会，因为很容易把人绕晕。</p>
<p>等价字符的好处在于简化了基本元字符的写法。</p>
<h4 id="-225"><a class="markdownIt-Anchor" href="#-225">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#%E8%A1%A8%E7%A4%BA%E6%9F%90%E4%B8%80%E7%B1%BB%E5%9E%8B%E5%AD%97%E7%AC%A6%E7%9A%84%E7%AD%89%E4%BB%B7%E5%AD%97%E7%AC%A6">#</a>表示某一类型字符的等价字符</h4>
<p>下表中的等价字符都表示某一类型的字符。</p>
<table>
<thead>
<tr>
<th>字符</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong> <code>.</code> </strong></td>
<td>匹配除 “\n” 之外的任何单个字符。</td>
</tr>
<tr>
<td><strong> <code>\d</code> </strong></td>
<td>匹配一个数字字符。等价于 [0-9]。</td>
</tr>
<tr>
<td><strong> <code>\D</code> </strong></td>
<td>匹配一个非数字字符。等价于 [^0-9]。</td>
</tr>
<tr>
<td><strong> <code>\w</code> </strong></td>
<td>匹配包括下划线的任何单词字符。类似但不等价于 “[A-Za-z0-9_]”，这里的单词字符指的是 Unicode 字符集。</td>
</tr>
<tr>
<td><strong> <code>\W</code> </strong></td>
<td>匹配任何非单词字符。</td>
</tr>
<tr>
<td><strong> <code>\s</code> </strong></td>
<td>匹配任何不可见字符，包括空格、制表符、换页符等等。等价于 [\f\n\r\t\v]。</td>
</tr>
<tr>
<td><strong> <code>\S</code> </strong></td>
<td>匹配任何可见字符。等价于 [\f\n\r\t\v]。</td>
</tr>
</tbody>
</table>
<p>【示例】基本等价字符的用法</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 匹配除“\n”之外的任何单个字符</span>
<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span><span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">".&#123;1,&#125;"</span><span class="token punctuation">,</span> <span class="token string">"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789_"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span><span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">".&#123;1,&#125;"</span><span class="token punctuation">,</span> <span class="token string">"~!@#$%^&amp;*()+`-=[]&#123;&#125;;:&lt;>,./?|\\"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertFalse</span><span class="token punctuation">(</span><span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertFalse</span><span class="token punctuation">(</span><span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"[^\n]"</span><span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 匹配一个数字字符。等价于[0-9]</span>
<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span><span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"\\d&#123;1,&#125;"</span><span class="token punctuation">,</span> <span class="token string">"0123456789"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 匹配一个非数字字符。等价于[^0-9]</span>
<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertFalse</span><span class="token punctuation">(</span><span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"\\D&#123;1,&#125;"</span><span class="token punctuation">,</span> <span class="token string">"0123456789"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 匹配包括下划线的任何单词字符。类似但不等价于“[A-Za-z0-9_]”，这里的单词字符指的是Unicode字符集</span>
<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span><span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"\\w&#123;1,&#125;"</span><span class="token punctuation">,</span> <span class="token string">"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789_"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertFalse</span><span class="token punctuation">(</span><span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"\\w&#123;1,&#125;"</span><span class="token punctuation">,</span> <span class="token string">"~!@#$%^&amp;*()+`-=[]&#123;&#125;;:&lt;>,./?|\\"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 匹配任何非单词字符</span>
<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertFalse</span><span class="token punctuation">(</span><span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"\\W&#123;1,&#125;"</span><span class="token punctuation">,</span> <span class="token string">"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789_"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span><span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"\\W&#123;1,&#125;"</span><span class="token punctuation">,</span> <span class="token string">"~!@#$%^&amp;*()+`-=[]&#123;&#125;;:&lt;>,./?|\\"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 匹配任何不可见字符，包括空格、制表符、换页符等等。等价于[ \f\n\r\t\v]</span>
<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span><span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"\\s&#123;1,&#125;"</span><span class="token punctuation">,</span> <span class="token string">" \f\r\n\t"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 匹配任何可见字符。等价于[^ \f\n\r\t\v]</span>
<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertFalse</span><span class="token punctuation">(</span><span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"\\S&#123;1,&#125;"</span><span class="token punctuation">,</span> <span class="token string">" \f\r\n\t"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 输出</span>
<span class="token comment">// ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789_	matches： .&#123;1,&#125;</span>
<span class="token comment">// ~!@#$%^&amp;*()+`-=[]&#123;&#125;;:&lt;>,./?|\\	matches： .&#123;1,&#125;</span>
<span class="token comment">// \n	not matches： .</span>
<span class="token comment">// \n	not matches： [^\n]</span>
<span class="token comment">// 0123456789	matches： \\d&#123;1,&#125;</span>
<span class="token comment">// 0123456789	not matches： \\D&#123;1,&#125;</span>
<span class="token comment">// ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789_	matches： \\w&#123;1,&#125;</span>
<span class="token comment">// ~!@#$%^&amp;*()+`-=[]&#123;&#125;;:&lt;>,./?|\\	not matches： \\w&#123;1,&#125;</span>
<span class="token comment">// ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789_	not matches： \\W&#123;1,&#125;</span>
<span class="token comment">// ~!@#$%^&amp;*()+`-=[]&#123;&#125;;:&lt;>,./?|\\	matches： \\W&#123;1,&#125;</span>
<span class="token comment">// \f\r\n\t	matches： \\s&#123;1,&#125;</span>
<span class="token comment">// \f\r\n\t	not matches： \\S&#123;1,&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-226"><a class="markdownIt-Anchor" href="#-226">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#%E9%99%90%E5%88%B6%E5%AD%97%E7%AC%A6%E6%95%B0%E9%87%8F%E7%9A%84%E7%AD%89%E4%BB%B7%E5%AD%97%E7%AC%A6">#</a>限制字符数量的等价字符</h4>
<p>在基本元字符章节中，已经介绍了限制字符数量的基本元字符 -  <code>&#123;&#125;</code>  。</p>
<p>此外，还有  <code>*</code> 、 <code>+</code> 、 <code>?</code>  这个三个为了简化写法而出现的等价字符，我们来认识一下。</p>
<table>
<thead>
<tr>
<th>字符</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>*</code></td>
<td>匹配前面的子表达式零次或多次。等价于 {0,}。</td>
</tr>
<tr>
<td><code>+</code></td>
<td>匹配前面的子表达式一次或多次。等价于 {1,}。</td>
</tr>
<tr>
<td><code>?</code></td>
<td>匹配前面的子表达式零次或一次。等价于 {0,1}。</td>
</tr>
</tbody>
</table>
<p><strong>案例 限制字符数量的等价字符</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// *: 匹配前面的子表达式零次或多次。* 等价于&#123;0,&#125;。</span>
<span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"ap*"</span><span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"ap*"</span><span class="token punctuation">,</span> <span class="token string">"ap"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"ap*"</span><span class="token punctuation">,</span> <span class="token string">"app"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"ap*"</span><span class="token punctuation">,</span> <span class="token string">"apppppppppp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// +: 匹配前面的子表达式一次或多次。+ 等价于 &#123;1,&#125;。</span>
<span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"ap+"</span><span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"ap+"</span><span class="token punctuation">,</span> <span class="token string">"ap"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"ap+"</span><span class="token punctuation">,</span> <span class="token string">"app"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"ap+"</span><span class="token punctuation">,</span> <span class="token string">"apppppppppp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ?: 匹配前面的子表达式零次或一次。? 等价于 &#123;0,1&#125;。</span>
<span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"ap?"</span><span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"ap?"</span><span class="token punctuation">,</span> <span class="token string">"ap"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"ap?"</span><span class="token punctuation">,</span> <span class="token string">"app"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token string">"ap?"</span><span class="token punctuation">,</span> <span class="token string">"apppppppppp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 输出</span>
<span class="token comment">// a	matches： ap*</span>
<span class="token comment">// ap	matches： ap*</span>
<span class="token comment">// app	matches： ap*</span>
<span class="token comment">// apppppppppp	matches： ap*</span>
<span class="token comment">// a	not matches： ap+</span>
<span class="token comment">// ap	matches： ap+</span>
<span class="token comment">// app	matches： ap+</span>
<span class="token comment">// apppppppppp	matches： ap+</span>
<span class="token comment">// a	matches： ap?</span>
<span class="token comment">// ap	matches： ap?</span>
<span class="token comment">// app	not matches： ap?</span>
<span class="token comment">// apppppppppp	not matches： ap?</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-227"><a class="markdownIt-Anchor" href="#-227">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#%E5%85%83%E5%AD%97%E7%AC%A6%E4%BC%98%E5%85%88%E7%BA%A7%E9%A1%BA%E5%BA%8F">#</a>元字符优先级顺序</h4>
<p>正则表达式从左到右进行计算，并遵循优先级顺序，这与算术表达式非常类似。</p>
<p>下表从最高到最低说明了各种正则表达式运算符的优先级顺序：</p>
<table>
<thead>
<tr>
<th>运算符</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>\</code></td>
<td>转义符</td>
</tr>
<tr>
<td><code>()</code> 、 <code>(?:)</code> 、 <code>(?=)</code> 、 <code>[]</code></td>
<td>括号和中括号</td>
</tr>
<tr>
<td><code>*</code> 、 <code>+</code> 、 <code>?</code> 、 <code>&#123;n&#125;</code> 、 <code>&#123;n,&#125;</code> 、 <code>&#123;n,m&#125;</code></td>
<td>限定符</td>
</tr>
<tr>
<td><code>^</code> 、 <code>$</code> 、 <code>*任何字符</code> 、 <code>任何字符*</code></td>
<td>定位点和序列</td>
</tr>
<tr>
<td><code>|</code></td>
<td>替换</td>
</tr>
</tbody>
</table>
<p>字符具有高于替换运算符的优先级，使得  <code>m|food</code>  匹配  <code>m</code>  或  <code>food</code>  。若要匹配  <code>mood</code>  或  <code>food</code>  ，请使用括号创建子表达式，从而产生  <code>(m|f)ood</code>  。</p>
<h2 id="-228"><a class="markdownIt-Anchor" href="#-228">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#_4-%E5%88%86%E7%BB%84%E6%9E%84%E9%80%A0">#</a>4. 分组构造</h2>
<p>在基本元字符章节，提到了  <code>()</code>  字符可以用来对表达式分组。实际上分组还有更多复杂的用法。</p>
<p>所谓分组构造，是用来描述正则表达式的子表达式，用于捕获字符串中的子字符串。</p>
<h3 id="-229"><a class="markdownIt-Anchor" href="#-229">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#_4-1-%E6%8D%95%E8%8E%B7%E4%B8%8E%E9%9D%9E%E6%8D%95%E8%8E%B7">#</a>4.1. 捕获与非捕获</h3>
<p>下表为分组构造中的捕获和非捕获分类。</p>
<table>
<thead>
<tr>
<th>表达式</th>
<th>描述</th>
<th>捕获或非捕获</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>(exp)</code></td>
<td>匹配的子表达式</td>
<td>捕获</td>
</tr>
<tr>
<td><code>(?&lt;name&gt;exp)</code></td>
<td>命名的反向引用</td>
<td>捕获</td>
</tr>
<tr>
<td><code>(?:exp)</code></td>
<td>非捕获组</td>
<td>非捕获</td>
</tr>
<tr>
<td><code>(?=exp)</code></td>
<td>零宽度正预测先行断言</td>
<td>非捕获</td>
</tr>
<tr>
<td><code>(?!exp)</code></td>
<td>零宽度负预测先行断言</td>
<td>非捕获</td>
</tr>
<tr>
<td><code>(?&lt;=exp)</code></td>
<td>零宽度正回顾后发断言</td>
<td>非捕获</td>
</tr>
<tr>
<td><code>(?&lt;!exp)</code></td>
<td>零宽度负回顾后发断言</td>
<td>非捕获</td>
</tr>
</tbody>
</table>
<blockquote>
<p>注：Java 正则引擎不支持平衡组。</p>
</blockquote>
<h3 id="-230"><a class="markdownIt-Anchor" href="#-230">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#_4-2-%E5%8F%8D%E5%90%91%E5%BC%95%E7%94%A8">#</a>4.2. 反向引用</h3>
<h5 id="-231"><a class="markdownIt-Anchor" href="#-231">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#%E5%B8%A6%E7%BC%96%E5%8F%B7%E7%9A%84%E5%8F%8D%E5%90%91%E5%BC%95%E7%94%A8">#</a>带编号的反向引用</h5>
<p>带编号的反向引用使用以下语法： <code>\number</code></p>
<p>其中<em> number</em> 是正则表达式中捕获组的序号位置。 例如，\4 匹配第四个捕获组的内容。 如果正则表达式模式中未定义<em> number</em>，则将发生分析错误</p>
<p><strong>【示例】匹配重复的单词和紧随每个重复的单词的单词 (不命名子表达式)</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// (\w+)\s\1\W(\w+) 匹配重复的单词和紧随每个重复的单词的单词</span>
<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token string">"(\\w+)\\s\\1\\W(\\w+)"</span><span class="token punctuation">,</span>
		<span class="token string">"He said that that was the the correct answer."</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 输出</span>
<span class="token comment">// regex = (\w+)\s\1\W(\w+), content: He said that that was the the correct answer.</span>
<span class="token comment">// [1th] start: 8, end: 21, group: that that was</span>
<span class="token comment">// [2th] start: 22, end: 37, group: the the correct</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>说明：</p>
<ul>
<li><code>(\w+)</code> ：匹配一个或多个单词字符。</li>
<li><code>\s</code> ：与空白字符匹配。</li>
<li><code>\1</code> ：匹配第一个组，即 (\w+)。</li>
<li><code>\W</code> ：匹配包括空格和标点符号的一个非单词字符。 这样可以防止正则表达式模式匹配从第一个捕获组的单词开头的单词。</li>
</ul>
<h4 id="-232"><a class="markdownIt-Anchor" href="#-232">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#%E5%91%BD%E5%90%8D%E7%9A%84%E5%8F%8D%E5%90%91%E5%BC%95%E7%94%A8">#</a>命名的反向引用</h4>
<p>命名后向引用通过使用下面的语法进行定义： <code>\k&lt;name &gt;</code></p>
<p><strong>【示例】匹配重复的单词和紧随每个重复的单词的单词 (命名子表达式)</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// (?&lt;duplicateWord>\w+)\s\k&lt;duplicateWord>\W(?&lt;nextWord>\w+) 匹配重复的单词和紧随每个重复的单词的单词</span>
<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token string">"(?&lt;duplicateWord>\\w+)\\s\\k&lt;duplicateWord>\\W(?&lt;nextWord>\\w+)"</span><span class="token punctuation">,</span>
		<span class="token string">"He said that that was the the correct answer."</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 输出</span>
<span class="token comment">// regex = (?&lt;duplicateWord>\w+)\s\k&lt;duplicateWord>\W(?&lt;nextWord>\w+), content: He said that that was the the correct answer.</span>
<span class="token comment">// [1th] start: 8, end: 21, group: that that was</span>
<span class="token comment">// [2th] start: 22, end: 37, group: the the correct</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>说明：</p>
<ul>
<li><code>(?&lt;duplicateWord&gt;\w+)</code> ：匹配一个或多个单词字符。 命名此捕获组 duplicateWord。</li>
<li><code>\s</code> : 与空白字符匹配。</li>
<li><code>\k&lt;duplicateWord&gt;</code> ：匹配名为 duplicateWord 的捕获的组。</li>
<li><code>\W</code> ：匹配包括空格和标点符号的一个非单词字符。 这样可以防止正则表达式模式匹配从第一个捕获组的单词开头的单词。</li>
<li><code>(?&lt;nextWord&gt;\w+)</code> ：匹配一个或多个单词字符。 命名此捕获组 nextWord。</li>
</ul>
<h3 id="-233"><a class="markdownIt-Anchor" href="#-233">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#_4-3-%E9%9D%9E%E6%8D%95%E8%8E%B7%E7%BB%84">#</a>4.3. 非捕获组</h3>
<p><code>(?:exp)</code>  表示当一个限定符应用到一个组，但组捕获的子字符串并非所需时，通常会使用非捕获组构造。</p>
<p><strong>【示例】匹配以。结束的语句。</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 匹配由句号终止的语句。</span>
<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token string">"(?:\\b(?:\\w+)\\W*)+\\."</span><span class="token punctuation">,</span> <span class="token string">"This is a short sentence. Never end"</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 输出</span>
<span class="token comment">// regex = (?:\b(?:\w+)\W*)+\., content: This is a short sentence. Never end</span>
<span class="token comment">// [1th] start: 0, end: 25, group: This is a short sentence.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-234"><a class="markdownIt-Anchor" href="#-234">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#_4-4-%E9%9B%B6%E5%AE%BD%E6%96%AD%E8%A8%80">#</a>4.4. 零宽断言</h3>
<p>用于查找在某些内容 (但并不包括这些内容) 之前或之后的东西，也就是说它们像 \b,^,$ 那样用于指定一个位置，这个位置应该满足一定的条件 (即断言)，因此它们也被称为零宽断言。</p>
<table>
<thead>
<tr>
<th>表达式</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>(?=exp)</code></td>
<td>匹配 exp 前面的位置</td>
</tr>
<tr>
<td><code>(?&lt;=exp)</code></td>
<td>匹配 exp 后面的位置</td>
</tr>
<tr>
<td><code>(?!exp)</code></td>
<td>匹配后面跟的不是 exp 的位置</td>
</tr>
<tr>
<td><code>(?&lt;!exp)</code></td>
<td>匹配前面不是 exp 的位置</td>
</tr>
</tbody>
</table>
<h4 id="-235"><a class="markdownIt-Anchor" href="#-235">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#%E5%8C%B9%E9%85%8D-exp-%E5%89%8D%E9%9D%A2%E7%9A%84%E4%BD%8D%E7%BD%AE">#</a>匹配 exp 前面的位置</h4>
<p><code>(?=exp)</code>  表示输入字符串必须匹配<em>子表达式</em>中的正则表达式模式，尽管匹配的子字符串未包含在匹配结果中。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// \b\w+(?=\sis\b) 表示要捕获is之前的单词</span>
<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token string">"\\b\\w+(?=\\sis\\b)"</span><span class="token punctuation">,</span> <span class="token string">"The dog is a Malamute."</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertFalse</span><span class="token punctuation">(</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token string">"\\b\\w+(?=\\sis\\b)"</span><span class="token punctuation">,</span> <span class="token string">"The island has beautiful birds."</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertFalse</span><span class="token punctuation">(</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token string">"\\b\\w+(?=\\sis\\b)"</span><span class="token punctuation">,</span> <span class="token string">"The pitch missed home plate."</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token string">"\\b\\w+(?=\\sis\\b)"</span><span class="token punctuation">,</span> <span class="token string">"Sunday is a weekend day."</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 输出</span>
<span class="token comment">// regex = \b\w+(?=\sis\b), content: The dog is a Malamute.</span>
<span class="token comment">// [1th] start: 4, end: 7, group: dog</span>
<span class="token comment">// regex = \b\w+(?=\sis\b), content: The island has beautiful birds.</span>
<span class="token comment">// not found</span>
<span class="token comment">// regex = \b\w+(?=\sis\b), content: The pitch missed home plate.</span>
<span class="token comment">// not found</span>
<span class="token comment">// regex = \b\w+(?=\sis\b), content: Sunday is a weekend day.</span>
<span class="token comment">// [1th] start: 0, end: 6, group: Sunday</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>说明：</p>
<ul>
<li><code>\b</code> ：在单词边界处开始匹配。</li>
<li><code>\w+</code> ：匹配一个或多个单词字符。</li>
<li><code>(?=\sis\b)</code> ：确定单词字符是否后接空白字符和字符串 “is”，其在单词边界处结束。 如果如此，则匹配成功。</li>
</ul>
<h4 id="-236"><a class="markdownIt-Anchor" href="#-236">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#%E5%8C%B9%E9%85%8D-exp-%E5%90%8E%E9%9D%A2%E7%9A%84%E4%BD%8D%E7%BD%AE">#</a>匹配 exp 后面的位置</h4>
<p><code>(?&lt;=exp)</code>  表示子表达式不得在输入字符串当前位置左侧出现，尽管子表达式未包含在匹配结果中。零宽度正回顾后发断言不会回溯。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// (?&lt;=\b20)\d&#123;2&#125;\b 表示要捕获以20开头的数字的后面部分</span>
<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token string">"(?&lt;=\\b20)\\d&#123;2&#125;\\b"</span><span class="token punctuation">,</span> <span class="token string">"2010 1999 1861 2140 2009"</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 输出</span>
<span class="token comment">// regex = (?&lt;=\b20)\d&#123;2&#125;\b, content: 2010 1999 1861 2140 2009</span>
<span class="token comment">// [1th] start: 2, end: 4, group: 10</span>
<span class="token comment">// [2th] start: 22, end: 24, group: 09</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>说明：</p>
<ul>
<li><code>\d&#123;2&#125;</code> ：匹配两个十进制数字。</li>
<li><code>&#123;?&lt;=\b20)</code> ：如果两个十进制数字的字边界以小数位数 “20” 开头，则继续匹配。</li>
<li><code>\b</code> ：在单词边界处结束匹配。</li>
</ul>
<h4 id="-237"><a class="markdownIt-Anchor" href="#-237">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#%E5%8C%B9%E9%85%8D%E5%90%8E%E9%9D%A2%E8%B7%9F%E7%9A%84%E4%B8%8D%E6%98%AF-exp-%E7%9A%84%E4%BD%8D%E7%BD%AE">#</a>匹配后面跟的不是 exp 的位置</h4>
<p><code>(?!exp)</code>  表示输入字符串不得匹配<em>子表达式</em>中的正则表达式模式，尽管匹配的子字符串未包含在匹配结果中。</p>
<p>【示例】捕获未以 “un” 开头的单词</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// \b(?!un)\w+\b 表示要捕获未以“un”开头的单词</span>
<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token string">"\\b(?!un)\\w+\\b"</span><span class="token punctuation">,</span> <span class="token string">"unite one unethical ethics use untie ultimate"</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 输出</span>
<span class="token comment">// regex = \b(?!un)\w+\b, content: unite one unethical ethics use untie ultimate</span>
<span class="token comment">// [1th] start: 6, end: 9, group: one</span>
<span class="token comment">// [2th] start: 20, end: 26, group: ethics</span>
<span class="token comment">// [3th] start: 27, end: 30, group: use</span>
<span class="token comment">// [4th] start: 37, end: 45, group: ultimate</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>说明：</p>
<ul>
<li><code>\b</code> ：在单词边界处开始匹配。</li>
<li><code>(?!un)</code> ：确定接下来的两个的字符是否为 “un”。 如果没有，则可能匹配。</li>
<li><code>\w+</code> ：匹配一个或多个单词字符。</li>
<li><code>\b</code> ：在单词边界处结束匹配。</li>
</ul>
<h4 id="-238"><a class="markdownIt-Anchor" href="#-238">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#%E5%8C%B9%E9%85%8D%E5%89%8D%E9%9D%A2%E4%B8%8D%E6%98%AF-exp-%E7%9A%84%E4%BD%8D%E7%BD%AE">#</a>匹配前面不是 exp 的位置</h4>
<p><code>(?&lt;!exp)</code>  表示子表达式不得在输入字符串当前位置的左侧出现。 但是，任何不匹配子表达式 的子字符串不包含在匹配结果中。</p>
<p>【示例】捕获任意工作日</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// (?&lt;!(Saturday|Sunday) )\b\w+ \d&#123;1,2&#125;, \d&#123;4&#125;\b 表示要捕获任意工作日（即周一到周五）</span>
<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token string">"(?&lt;!(Saturday|Sunday) )\\b\\w+ \\d&#123;1,2&#125;, \\d&#123;4&#125;\\b"</span><span class="token punctuation">,</span> <span class="token string">"Monday February 1, 2010"</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token string">"(?&lt;!(Saturday|Sunday) )\\b\\w+ \\d&#123;1,2&#125;, \\d&#123;4&#125;\\b"</span><span class="token punctuation">,</span> <span class="token string">"Wednesday February 3, 2010"</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertFalse</span><span class="token punctuation">(</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token string">"(?&lt;!(Saturday|Sunday) )\\b\\w+ \\d&#123;1,2&#125;, \\d&#123;4&#125;\\b"</span><span class="token punctuation">,</span> <span class="token string">"Saturday February 6, 2010"</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertFalse</span><span class="token punctuation">(</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token string">"(?&lt;!(Saturday|Sunday) )\\b\\w+ \\d&#123;1,2&#125;, \\d&#123;4&#125;\\b"</span><span class="token punctuation">,</span> <span class="token string">"Sunday February 7, 2010"</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token string">"(?&lt;!(Saturday|Sunday) )\\b\\w+ \\d&#123;1,2&#125;, \\d&#123;4&#125;\\b"</span><span class="token punctuation">,</span> <span class="token string">"Monday, February 8, 2010"</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 输出</span>
<span class="token comment">// regex = (?&lt;!(Saturday|Sunday) )\b\w+ \d&#123;1,2&#125;, \d&#123;4&#125;\b, content: Monday February 1, 2010</span>
<span class="token comment">// [1th] start: 7, end: 23, group: February 1, 2010</span>
<span class="token comment">// regex = (?&lt;!(Saturday|Sunday) )\b\w+ \d&#123;1,2&#125;, \d&#123;4&#125;\b, content: Wednesday February 3, 2010</span>
<span class="token comment">// [1th] start: 10, end: 26, group: February 3, 2010</span>
<span class="token comment">// regex = (?&lt;!(Saturday|Sunday) )\b\w+ \d&#123;1,2&#125;, \d&#123;4&#125;\b, content: Saturday February 6, 2010</span>
<span class="token comment">// not found</span>
<span class="token comment">// regex = (?&lt;!(Saturday|Sunday) )\b\w+ \d&#123;1,2&#125;, \d&#123;4&#125;\b, content: Sunday February 7, 2010</span>
<span class="token comment">// not found</span>
<span class="token comment">// regex = (?&lt;!(Saturday|Sunday) )\b\w+ \d&#123;1,2&#125;, \d&#123;4&#125;\b, content: Monday, February 8, 2010</span>
<span class="token comment">// [1th] start: 8, end: 24, group: February 8, 2010</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="-239"><a class="markdownIt-Anchor" href="#-239">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#_5-%E8%B4%AA%E5%A9%AA%E4%B8%8E%E6%87%92%E6%83%B0">#</a>5. 贪婪与懒惰</h2>
<p>当正则表达式中包含能接受重复的限定符时，通常的行为是（在使整个表达式能得到匹配的前提下）匹配<strong>尽可能多</strong>的字符。以这个表达式为例：a.*b，它将会匹配最长的以 a 开始，以 b 结束的字符串。如果用它来搜索 aabab 的话，它会匹配整个字符串 aabab。这被称为贪婪匹配。</p>
<p>有时，我们更需要懒惰匹配，也就是匹配<strong>尽可能少</strong>的字符。前面给出的限定符都可以被转化为懒惰匹配模式，只要在它后面加上一个问号？。这样.*? 就意味着匹配任意数量的重复，但是在能使整个匹配成功的前提下使用最少的重复。</p>
<table>
<thead>
<tr>
<th>表达式</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>*?</code></td>
<td>重复任意次，但尽可能少重复</td>
</tr>
<tr>
<td><code>+?</code></td>
<td>重复 1 次或更多次，但尽可能少重复</td>
</tr>
<tr>
<td><code>??</code></td>
<td>重复 0 次或 1 次，但尽可能少重复</td>
</tr>
<tr>
<td><code>&#123;n,m&#125;?</code></td>
<td>重复 n 到 m 次，但尽可能少重复</td>
</tr>
<tr>
<td><code>&#123;n,&#125;?</code></td>
<td>重复 n 次以上，但尽可能少重复</td>
</tr>
</tbody>
</table>
<p>【示例】Java 正则中贪婪与懒惰的示例</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 贪婪匹配</span>
<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token string">"a\\w*b"</span><span class="token punctuation">,</span> <span class="token string">"abaabaaabaaaab"</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 懒惰匹配</span>
<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token string">"a\\w*?b"</span><span class="token punctuation">,</span> <span class="token string">"abaabaaabaaaab"</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token string">"a\\w+?b"</span><span class="token punctuation">,</span> <span class="token string">"abaabaaabaaaab"</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token string">"a\\w??b"</span><span class="token punctuation">,</span> <span class="token string">"abaabaaabaaaab"</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token string">"a\\w&#123;0,4&#125;?b"</span><span class="token punctuation">,</span> <span class="token string">"abaabaaabaaaab"</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token string">"a\\w&#123;3,&#125;?b"</span><span class="token punctuation">,</span> <span class="token string">"abaabaaabaaaab"</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 输出</span>
<span class="token comment">// regex = a\w*b, content: abaabaaabaaaab</span>
<span class="token comment">// [1th] start: 0, end: 14, group: abaabaaabaaaab</span>
<span class="token comment">// regex = a\w*?b, content: abaabaaabaaaab</span>
<span class="token comment">// [1th] start: 0, end: 2, group: ab</span>
<span class="token comment">// [2th] start: 2, end: 5, group: aab</span>
<span class="token comment">// [3th] start: 5, end: 9, group: aaab</span>
<span class="token comment">// [4th] start: 9, end: 14, group: aaaab</span>
<span class="token comment">// regex = a\w+?b, content: abaabaaabaaaab</span>
<span class="token comment">// [1th] start: 0, end: 5, group: abaab</span>
<span class="token comment">// [2th] start: 5, end: 9, group: aaab</span>
<span class="token comment">// [3th] start: 9, end: 14, group: aaaab</span>
<span class="token comment">// regex = a\w??b, content: abaabaaabaaaab</span>
<span class="token comment">// [1th] start: 0, end: 2, group: ab</span>
<span class="token comment">// [2th] start: 2, end: 5, group: aab</span>
<span class="token comment">// [3th] start: 6, end: 9, group: aab</span>
<span class="token comment">// [4th] start: 11, end: 14, group: aab</span>
<span class="token comment">// regex = a\w&#123;0,4&#125;?b, content: abaabaaabaaaab</span>
<span class="token comment">// [1th] start: 0, end: 2, group: ab</span>
<span class="token comment">// [2th] start: 2, end: 5, group: aab</span>
<span class="token comment">// [3th] start: 5, end: 9, group: aaab</span>
<span class="token comment">// [4th] start: 9, end: 14, group: aaaab</span>
<span class="token comment">// regex = a\w&#123;3,&#125;?b, content: abaabaaabaaaab</span>
<span class="token comment">// [1th] start: 0, end: 5, group: abaab</span>
<span class="token comment">// [2th] start: 5, end: 14, group: aaabaaaab</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>说明：</p>
<p>本例中代码展示的是使用不同贪婪或懒惰策略去查找字符串  <code>abaabaaabaaaab</code>  中匹配<strong>以  <code>a</code>  开头，以  <code>b</code>  结尾的所有子字符串</strong>。请从输出结果中，细细体味使用不同的贪婪或懒惰策略，对于匹配子字符串有什么影响。</p>
<h2 id="-240"><a class="markdownIt-Anchor" href="#-240">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#_6-%E6%AD%A3%E5%88%99%E9%99%84%E5%BD%95">#</a>6. 正则附录</h2>
<h3 id="-241"><a class="markdownIt-Anchor" href="#-241">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#_6-1-%E5%8C%B9%E9%85%8D%E6%AD%A3%E5%88%99%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9A%84%E6%96%B9%E6%B3%95">#</a>6.1. 匹配正则字符串的方法</h3>
<p>由于正则表达式中很多元字符本身就是转义字符，在 Java 字符串的规则中不会被显示出来。</p>
<p>为此，可以使用一个工具类 <code>org.apache.commons.lang3.StringEscapeUtils</code>  来做特殊处理，使得转义字符可以打印。这个工具类提供的都是静态方法，从方法命名大致也可以猜出用法，这里不多做说明。</p>
<p>如果你了解 maven，可以直接引入依赖</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.commons<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>commons-lang3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;commons-lang3.version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>【示例】本文为了展示正则匹配规则用到的方法</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">checkMatches</span><span class="token punctuation">(</span><span class="token class-name">String</span> regex<span class="token punctuation">,</span> <span class="token class-name">String</span> content<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token class-name">Pattern</span> p <span class="token operator">=</span> <span class="token class-name">Pattern</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>regex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">Matcher</span> m <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">matcher</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">boolean</span> flag <span class="token operator">=</span> m<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">StringEscapeUtils</span><span class="token punctuation">.</span><span class="token function">escapeJava</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\tmatches： "</span> <span class="token operator">+</span> <span class="token class-name">StringEscapeUtils</span><span class="token punctuation">.</span><span class="token function">escapeJava</span><span class="token punctuation">(</span>regex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">StringEscapeUtils</span><span class="token punctuation">.</span><span class="token function">escapeJava</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\tnot matches： "</span> <span class="token operator">+</span> <span class="token class-name">StringEscapeUtils</span><span class="token punctuation">.</span><span class="token function">escapeJava</span><span class="token punctuation">(</span>regex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> flag<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token class-name">String</span> regex<span class="token punctuation">,</span> <span class="token class-name">String</span> content<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token class-name">Pattern</span> p <span class="token operator">=</span> <span class="token class-name">Pattern</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>regex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">Matcher</span> m <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">matcher</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"regex = "</span> <span class="token operator">+</span> regex <span class="token operator">+</span> <span class="token string">", content: "</span> <span class="token operator">+</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		count<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"["</span> <span class="token operator">+</span> count <span class="token operator">+</span> <span class="token string">"th] "</span> <span class="token operator">+</span> <span class="token string">"start: "</span> <span class="token operator">+</span> m<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", end: "</span> <span class="token operator">+</span> m<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token operator">+</span> <span class="token string">", group: "</span> <span class="token operator">+</span> m<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> count<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"not found"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> count<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-242"><a class="markdownIt-Anchor" href="#-242">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#_6-2-%E9%80%9F%E6%9F%A5%E5%85%83%E5%AD%97%E7%AC%A6%E5%AD%97%E5%85%B8">#</a>6.2. 速查元字符字典</h3>
<p>为了方便快查正则的元字符含义，在本节根据元字符的功能集中罗列正则的各种元字符。</p>
<h4 id="-243"><a class="markdownIt-Anchor" href="#-243">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#%E9%99%90%E5%AE%9A%E7%AC%A6">#</a>限定符</h4>
<table>
<thead>
<tr>
<th>字符</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>*</code></td>
<td>匹配前面的子表达式零次或多次。例如，zo* 能匹配 “z” 以及 “zoo”。* 等价于 {0,}。</td>
</tr>
<tr>
<td><code>+</code></td>
<td>匹配前面的子表达式一次或多次。例如，‘zo+’ 能匹配 “zo” 以及 “zoo”，但不能匹配 “z”。+ 等价于 {1,}。</td>
</tr>
<tr>
<td><code>?</code></td>
<td>匹配前面的子表达式零次或一次。例如，“do (es)?” 可以匹配 “do” 或 “does” 中的 &quot;do&quot; 。? 等价于 {0,1}。</td>
</tr>
<tr>
<td><code>&#123;n&#125;</code></td>
<td>n 是一个非负整数。匹配确定的 n 次。例如，‘o {2}’ 不能匹配 “Bob” 中的 ‘o’，但是能匹配 “food” 中的两个 o。</td>
</tr>
<tr>
<td><code>&#123;n,&#125;</code></td>
<td>n 是一个非负整数。至少匹配 n 次。例如，‘o {2,}’ 不能匹配 “Bob” 中的 ‘o’，但能匹配 “foooood” 中的所有 o。‘o {1,}’ 等价于 ‘o+’。‘o {0,}’ 则等价于 ‘o*’。</td>
</tr>
<tr>
<td><code>&#123;n,m&#125;</code></td>
<td>m 和 n 均为非负整数，其中 n &lt;= m。最少匹配 n 次且最多匹配 m 次。例如，“o {1,3}” 将匹配 “fooooood” 中的前三个 o。‘o {0,1}’ 等价于 ‘o?’。请注意在逗号和两个数之间不能有空格。</td>
</tr>
</tbody>
</table>
<h4 id="-244"><a class="markdownIt-Anchor" href="#-244">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#%E5%AE%9A%E4%BD%8D%E7%AC%A6">#</a>定位符</h4>
<table>
<thead>
<tr>
<th>字符</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>^</code></td>
<td>匹配输入字符串开始的位置。如果设置了 RegExp 对象的 Multiline 属性，^ 还会与 \n 或 \r 之后的位置匹配。</td>
</tr>
<tr>
<td><code>$</code></td>
<td>匹配输入字符串结尾的位置。如果设置了 RegExp 对象的 Multiline 属性，$ 还会与 \n 或 \r 之前的位置匹配。</td>
</tr>
<tr>
<td><code>\b</code></td>
<td>匹配一个字边界，即字与空格间的位置。</td>
</tr>
<tr>
<td><code>\B</code></td>
<td>非字边界匹配。</td>
</tr>
</tbody>
</table>
<h4 id="-245"><a class="markdownIt-Anchor" href="#-245">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#%E9%9D%9E%E6%89%93%E5%8D%B0%E5%AD%97%E7%AC%A6">#</a>非打印字符</h4>
<table>
<thead>
<tr>
<th>字符</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>\cx</code></td>
<td>匹配由 x 指明的控制字符。例如， \cM 匹配一个 Control-M 或回车符。x 的值必须为 A-Z 或 a-z 之一。否则，将 c 视为一个原义的 ‘c’ 字符。</td>
</tr>
<tr>
<td><code>\f</code></td>
<td>匹配一个换页符。等价于 \x0c 和 \cL。</td>
</tr>
<tr>
<td><code>\n</code></td>
<td>匹配一个换行符。等价于 \x0a 和 \cJ。</td>
</tr>
<tr>
<td><code>\r</code></td>
<td>匹配一个回车符。等价于 \x0d 和 \cM。</td>
</tr>
<tr>
<td><code>\s</code></td>
<td>匹配任何空白字符，包括空格、制表符、换页符等等。等价于 [\f\n\r\t\v]。</td>
</tr>
<tr>
<td><code>\S</code></td>
<td>匹配任何非空白字符。等价于 [\f\n\r\t\v]。</td>
</tr>
<tr>
<td><code>\t</code></td>
<td>匹配一个制表符。等价于 \x09 和 \cI。</td>
</tr>
<tr>
<td><code>\v</code></td>
<td>匹配一个垂直制表符。等价于 \x0b 和 \cK。</td>
</tr>
</tbody>
</table>
<h4 id="-246"><a class="markdownIt-Anchor" href="#-246">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#%E5%88%86%E7%BB%84-2">#</a>分组</h4>
<table>
<thead>
<tr>
<th>表达式</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>(exp)</code></td>
<td>匹配的子表达式。() 中的内容就是子表达式。</td>
</tr>
<tr>
<td><code>(?&lt;name&gt;exp)</code></td>
<td>命名的子表达式（反向引用）。</td>
</tr>
<tr>
<td><code>(?:exp)</code></td>
<td>非捕获组，表示当一个限定符应用到一个组，但组捕获的子字符串并非所需时，通常会使用非捕获组构造。</td>
</tr>
<tr>
<td><code>(?=exp)</code></td>
<td>匹配 exp 前面的位置。</td>
</tr>
<tr>
<td><code>(?&lt;=exp)</code></td>
<td>匹配 exp 后面的位置。</td>
</tr>
<tr>
<td><code>(?!exp)</code></td>
<td>匹配后面跟的不是 exp 的位置。</td>
</tr>
<tr>
<td><code>(?&lt;!exp)</code></td>
<td>匹配前面不是 exp 的位置。</td>
</tr>
</tbody>
</table>
<h4 id="-247"><a class="markdownIt-Anchor" href="#-247">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#%E7%89%B9%E6%AE%8A%E7%AC%A6%E5%8F%B7">#</a>特殊符号</h4>
<table>
<thead>
<tr>
<th>字符</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>\</code></td>
<td>将下一个字符标记为或特殊字符、或原义字符、或向后引用、或八进制转义符。例如， ‘n’ 匹配字符 ‘n’。’\n’ 匹配换行符。序列 ‘’ 匹配 “”，而 ‘(’ 则匹配 “(”。</td>
</tr>
<tr>
<td><code>\|</code></td>
<td>指明两项之间的一个选择。</td>
</tr>
<tr>
<td><code>[]</code></td>
<td>匹配方括号范围内的任意一个字符。形式如：[xyz]、[<sup>xyz]、[a-z]、[</sup>a-z]、[x,y,z]</td>
</tr>
</tbody>
</table>
<h2 id="-248"><a class="markdownIt-Anchor" href="#-248">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#_7-%E6%AD%A3%E5%88%99%E5%AE%9E%E6%88%98">#</a>7. 正则实战</h2>
<p>虽然本系列洋洋洒洒的大谈特谈正则表达式。但是我还是要在这里建议，如果一个正则表达式没有经过充分测试，还是要谨慎使用。</p>
<p>正则是把双刃剑，它可以为你节省大量的代码行。但是由于它不易阅读，维护起来可是头疼的哦（你需要一个字符一个字符的去理解）。</p>
<h3 id="-249"><a class="markdownIt-Anchor" href="#-249">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#_7-1-%E6%9C%80%E5%AE%9E%E7%94%A8%E7%9A%84%E6%AD%A3%E5%88%99">#</a>7.1. 最实用的正则</h3>
<h4 id="-250"><a class="markdownIt-Anchor" href="#-250">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#%E6%A0%A1%E9%AA%8C%E4%B8%AD%E6%96%87">#</a>校验中文</h4>
<p>校验字符串中只能有中文字符（不包括中文标点符号）。中文字符的 Unicode 编码范围是  <code>\u4e00</code>  到  <code>\u9fa5</code> 。</p>
<blockquote>
<p>如有兴趣，可以参考<a target="_blank" rel="noopener" href="http://baike.baidu.com/link?url=3xi0vmvCIGKQLJZdn_BYhQ1IDFsoSJMrya6_eOjCBb7A6cRIW-zhZFLC9Yh8wjxU6A_HCfNuP8FBBXU9CN3Wcq"><strong>百度百科 - Unicode</strong> (opens new window)</a>。</p>
</blockquote>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">^[\u4e00-\u9fa5]+$<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li><strong>匹配：</strong> 春眠不觉晓</li>
<li>** 不匹配：** 春眠不觉晓，</li>
</ul>
<h4 id="-251"><a class="markdownIt-Anchor" href="#-251">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#%E6%A0%A1%E9%AA%8C%E8%BA%AB%E4%BB%BD%E8%AF%81%E5%8F%B7%E7%A0%81">#</a>校验身份证号码</h4>
<p>身份证为 15 位或 18 位。15 位是第一代身份证。从 1999 年 10 月 1 日起，全国实行公民身份证号码制度，居民身份证编号由原 15 位升至 18 位。</p>
<ul>
<li><strong>15 位身份证</strong>：由 15 位数字组成。排列顺序从左至右依次为：六位数字地区码；六位数字出生日期；三位顺序号，其中 15 位男为单数，女为双数。</li>
<li><strong>18 位身份证</strong>：由十七位数字本体码和一位数字校验码组成。排列顺序从左至右依次为：六位数字地区码；八位数字出生日期；三位数字顺序码和一位数字校验码（也可能是 X）。</li>
</ul>
<blockquote>
<p>身份证号含义详情请见：<a target="_blank" rel="noopener" href="http://baike.baidu.com/link?url=5mYlYNE0RsSe2D4tydajtiaR8hAm4pPZ0FHSPuQ05N4f6H-i7qPuw7sY5KfNuiOVJWVWZvU4gf3IY-vIcKdP1CU4Fv-9pKmFQB50qGv_hZT2dkGbkd9--8_saY7omV80vEw9ixVeEwda37fHswfmtyU4QSiBG5s3K5K-JnYr1dqNlPu0f3t008UcLh5-wyID"><strong>百度百科 - 居民身份证号码</strong> (opens new window)</a></p>
</blockquote>
<p><strong>地区码（6 位）</strong></p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">(1[1-5]|2[1-3]|3[1-7]|4[1-3]|5[0-4]|6[1-5])\d&#123;4&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><strong>出生日期（8 位）</strong></p>
<p>注：下面的是 18 位身份证的有效出生日期，如果是 15 位身份证，只要将第一个 \d {4} 改为 \d {2} 即可。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">((\d&#123;4&#125;((0[13578]|1[02])(0[1-9]|[12]\d|3[01])|(0[13456789]|1[012])(0[1-9]|[12]\d|30)|02(0[1-9]|1\d|2[0-8])))|([02468][048]|[13579][26])0229)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><strong>15 位有效身份证</strong></p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">^((1[1-5]|2[1-3]|3[1-7]|4[1-3]|5[0-4]|6[1-5])\d&#123;4&#125;)((\d&#123;2&#125;((0[13578]|1[02])(0[1-9]|[12]\d|3[01])|(0[13456789]|1[012])(0[1-9]|[12]\d|30)|02(0[1-9]|1\d|2[0-8])))|([02468][048]|[13579][26])0229)(\d&#123;3&#125;)$<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>** 匹配：**110001700101031</li>
<li>** 不匹配：**110001701501031</li>
</ul>
<p><strong>18 位有效身份证</strong></p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">^((1[1-5]|2[1-3]|3[1-7]|4[1-3]|5[0-4]|6[1-5])\d&#123;4&#125;)((\d&#123;4&#125;((0[13578]|1[02])(0[1-9]|[12]\d|3[01])|(0[13456789]|1[012])(0[1-9]|[12]\d|30)|02(0[1-9]|1\d|2[0-8])))|([02468][048]|[13579][26])0229)(\d&#123;3&#125;(\d|X))$<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>** 匹配：**110001199001010310 | 11000019900101015X</li>
<li>** 不匹配：**990000199001010310 | 110001199013010310</li>
</ul>
<h4 id="-252"><a class="markdownIt-Anchor" href="#-252">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#%E6%A0%A1%E9%AA%8C%E6%9C%89%E6%95%88%E7%94%A8%E6%88%B7%E5%90%8D%E3%80%81%E5%AF%86%E7%A0%81">#</a>校验有效用户名、密码</h4>
<p>** 描述：** 长度为 6-18 个字符，允许输入字母、数字、下划线，首字符必须为字母。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">^[a-zA-Z]\w&#123;5,17&#125;$<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>** 匹配：**he_llo@worl.d.com | <a href="mailto:hel.l-o@wor-ld.museum">hel.l-o@wor-ld.museum</a> | <a href="mailto:h1ello@123.com">h1ello@123.com</a></li>
<li>** 不匹配：**hello@worl_d.com | he&amp;llo@world.co1 | .hello@wor#.co.uk</li>
</ul>
<h4 id="-253"><a class="markdownIt-Anchor" href="#-253">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#%E6%A0%A1%E9%AA%8C%E9%82%AE%E7%AE%B1">#</a>校验邮箱</h4>
<p>** 描述：** 不允许使用 IP 作为域名，如 : <a href="mailto:hello@154.145.68.12">hello@154.145.68.12</a></p>
<p><code>@</code> 符号前的邮箱用户和 <code>.</code>  符号前的域名 (domain) 必须满足以下条件：</p>
<ul>
<li>字符只能是英文字母、数字、下划线 <code>_</code> 、 <code>.</code> 、 <code>-</code>  ；</li>
<li>首字符必须为字母或数字；</li>
<li><code>_</code> 、 <code>.</code> 、 <code>-</code>  不能连续出现。</li>
</ul>
<p>域名的根域只能为字母，且至少为两个字符。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">^[A-Za-z0-9](([_\.\-]?[a-zA-Z0-9]+)*)@([A-Za-z0-9]+)(([\.\-]?[a-zA-Z0-9]+)*)\.([A-Za-z]&#123;2,&#125;)$<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>** 匹配：**he_llo@worl.d.com | <a href="mailto:hel.l-o@wor-ld.museum">hel.l-o@wor-ld.museum</a> | <a href="mailto:h1ello@123.com">h1ello@123.com</a></li>
<li>** 不匹配：**hello@worl_d.com | he&amp;llo@world.co1 | .hello@wor#.co.uk</li>
</ul>
<h4 id="-254"><a class="markdownIt-Anchor" href="#-254">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#%E6%A0%A1%E9%AA%8C-url">#</a>校验 URL</h4>
<p>** 描述：** 校验 URL。支持 http、https、ftp、ftps。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">^(ht|f)(tp|tps)\://[a-zA-Z0-9\-\.]+\.([a-zA-Z]&#123;2,3&#125;)?(/\S*)?$<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>** 匹配：**<a target="_blank" rel="noopener" href="http://google.com/help/me">http://google.com/help/me</a> | <a target="_blank" rel="noopener" href="http://www.google.com/help/me/">http://www.google.com/help/me/</a> | <a target="_blank" rel="noopener" href="https://www.google.com/help.asp">https://www.google.com/help.asp</a> | <a href="ftp://www.google.com">ftp://www.google.com</a> | ftps://google.org</li>
<li>** 不匹配：**<a target="_blank" rel="noopener" href="http://un/www.google.com/index.asp">http://un/www.google.com/index.asp</a></li>
</ul>
<h4 id="-255"><a class="markdownIt-Anchor" href="#-255">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#%E6%A0%A1%E9%AA%8C%E6%97%B6%E9%97%B4">#</a>校验时间</h4>
<p>** 描述：** 校验时间。时、分、秒必须是有效数字，如果数值不是两位数，十位需要补零。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">^([0-1][0-9]|[2][0-3]):([0-5][0-9])$<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>** 匹配：**00:00:00 | 23:59:59 | 17:06:30</li>
<li>** 不匹配：**17:6:30 | 24:16:30</li>
</ul>
<h4 id="-256"><a class="markdownIt-Anchor" href="#-256">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#%E6%A0%A1%E9%AA%8C%E6%97%A5%E6%9C%9F">#</a>校验日期</h4>
<p>** 描述：** 校验日期。日期满足以下条件：</p>
<ul>
<li>格式 yyyy-MM-dd 或 yyyy-M-d</li>
<li>连字符可以没有或是 “-”、“/”、“.” 之一</li>
<li>闰年的二月可以有 29 日；而平年不可以。</li>
<li>一、三、五、七、八、十、十二月为 31 日。四、六、九、十一月为 30 日。</li>
</ul>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">^(?:(?!0000)[0-9]&#123;4&#125;([-/.]?)(?:(?:0?[1-9]|1[0-2])\1(?:0?[1-9]|1[0-9]|2[0-8])|(?:0?[13-9]|1[0-2])\1(?:29|30)|(?:0?[13578]|1[02])\1(?:31))|(?:[0-9]&#123;2&#125;(?:0[48]|[2468][048]|[13579][26])|(?:0[48]|[2468][048]|[13579][26])00)([-/.]?)0?2\2(?:29))$<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>** 匹配：**2016/1/1 | 2016/01/01 | 20160101 | 2016-01-01 | 2016.01.01 | 2000-02-29</li>
<li>** 不匹配：**2001-02-29 | 2016/12/32 | 2016/6/31 | 2016/13/1 | 2016/0/1</li>
</ul>
<h4 id="-257"><a class="markdownIt-Anchor" href="#-257">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#%E6%A0%A1%E9%AA%8C%E4%B8%AD%E5%9B%BD%E6%89%8B%E6%9C%BA%E5%8F%B7%E7%A0%81">#</a>校验中国手机号码</h4>
<p>** 描述：** 中国手机号码正确格式：11 位数字。</p>
<blockquote>
<p>移动有 16 个号段：134、135、136、137、138、139、147、150、151、152、157、158、159、182、187、188。其中 147、157、188 是 3G 号段，其他都是 2G 号段。联通有 7 种号段：130、131、132、155、156、185、186。其中 186 是 3G（WCDMA）号段，其余为 2G 号段。电信有 4 个号段：133、153、180、189。其中 189 是 3G 号段（CDMA2000），133 号段主要用作无线网卡号。总结：13 开头手机号 0-9；15 开头手机号 0-3、5-9；18 开头手机号 0、2、5-9。</p>
<p>此外，中国在国际上的区号为 86，所以手机号开头有 + 86、86 也是合法的。</p>
<p>以上信息来源于 <a target="_blank" rel="noopener" href="http://baike.baidu.com/link?url=Bia2K_f8rGcakOlP4d9m_-DNSgXU5-0NDP0pPavS0ZbhRHQcUFUTbMERjdO4u7cvkpTJaIDeUXq_EXWnMqXMdSuMQDX3NAbZXAlZYl_V18KATWF7y1EFzUyJ62rf3bAN"><strong>百度百科 - 手机号</strong> (opens new window)</a></p>
</blockquote>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">^((\+)?86\s*)?((13[0-9])|(15([0-3]|[5-9]))|(18[0,2,5-9]))\d&#123;8&#125;$<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li><strong>匹配：</strong>+86 18012345678 | 86 18012345678 | 15812345678</li>
<li>** 不匹配：**15412345678 | 12912345678 | 180123456789</li>
</ul>
<h4 id="-258"><a class="markdownIt-Anchor" href="#-258">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#%E6%A0%A1%E9%AA%8C%E4%B8%AD%E5%9B%BD%E5%9B%BA%E8%AF%9D%E5%8F%B7%E7%A0%81">#</a>校验中国固话号码</h4>
<p>** 描述：** 固话号码，必须加区号（以 0 开头）。 3 位有效区号：010、020~029，固话位数为 8 位。 4 位有效区号：03xx 开头到 09xx，固话位数为 7。</p>
<blockquote>
<p>如果想了解更详细的信息，请参考 <a target="_blank" rel="noopener" href="http://baike.baidu.com/link?url=sX8JoxK1ja5uM5pDYvQe27_QsyqAZ_78DLSeEvwjqtG_uXqU6p5Oh7CPbImNbnwu1ClOmD8udgDIswZfYzQIw0z3BYZO3eTplvVDzieuowTYqt7yHGDAqyT7o4vvGhg4"><strong>百度百科 - 电话区号</strong> (opens new window)</a>。</p>
</blockquote>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">^(010|02[0-9])(\s|-)\d&#123;8&#125;|(0[3-9]\d&#123;2&#125;)(\s|-)\d&#123;7&#125;$<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>** 匹配：**010-12345678 | 010 12345678 | 0512-1234567 | 0512 1234567</li>
<li>** 不匹配：**1234567 | 12345678</li>
</ul>
<h4 id="-259"><a class="markdownIt-Anchor" href="#-259">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#%E6%A0%A1%E9%AA%8C-ipv4-%E5%9C%B0%E5%9D%80">#</a>校验 IPv4 地址</h4>
<p>** 描述：**IP 地址是一个 32 位的二进制数，通常被分割为 4 个 “8 位二进制数”（也就是 4 个字节）。IP 地址通常用 “点分十进制” 表示成（a.b.c.d）的形式，其中，a,b,c,d 都是 0~255 之间的十进制整数。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">^([01]?\d\d?|2[0-4]\d|25[0-5])\.([01]?\d\d?|2[0-4]\d|25[0-5])\.([01]?\d\d?|2[0-4]\d|25[0-5])\.([01]?\d\d?|2[0-4]\d|25[0-5])$<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>** 匹配：**0.0.0.0 | 255.255.255.255 | 127.0.0.1</li>
<li>** 不匹配：**10.10.10 | 10.10.10.256</li>
</ul>
<h4 id="-260"><a class="markdownIt-Anchor" href="#-260">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#%E6%A0%A1%E9%AA%8C-ipv6-%E5%9C%B0%E5%9D%80">#</a>校验 IPv6 地址</h4>
<p>** 描述：**IPv6 的 128 位地址通常写成 8 组，每组为四个十六进制数的形式。</p>
<p>IPv6 地址可以表示为以下形式：</p>
<ul>
<li>IPv6 地址</li>
<li>零压缩 IPv6 地址 (<a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc5952#section-2.2">section 2.2 of rfc5952 (opens new window)</a>)</li>
<li>带有本地链接区域索引的 IPv6 地址 (<a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc4007#section-11">section 11 of rfc4007 (opens new window)</a>)</li>
<li>嵌入 IPv4 的 IPv6 地址 (<a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc6052#section-2">section 2 of rfc6052(opens new window)</a></li>
<li>映射 IPv4 的 IPv6 地址 (<a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc2765#section-2.1">section 2.1 of rfc2765 (opens new window)</a>)</li>
<li>翻译 IPv4 的 IPv6 地址 (<a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc2765#section-2.1">section 2.1 of rfc2765 (opens new window)</a>)</li>
</ul>
<blockquote>
<p>显然，IPv6 地址的表示方式很复杂。你也可以参考：</p>
<p><a target="_blank" rel="noopener" href="http://baike.baidu.com/link?url=D3nmh0q_G_ZVmxXFG79mjjNfT4hs9fwjqUgygh-tvhq43KYqx88HV27WEXmoT4nA4iGzXwXMm5L-j50C2gSL5q"><strong>百度百科 - IPv6</strong>(opens new window)</a></p>
<p><a target="_blank" rel="noopener" href="http://stackoverflow.com/questions/53497/regular-expression-that-matches-valid-ipv6-addresses"><strong>Stack overflow 上的 IPv6 正则表达高票答案</strong> (opens new window)</a></p>
</blockquote>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">(([0-9a-fA-F]&#123;1,4&#125;:)&#123;7,7&#125;[0-9a-fA-F]&#123;1,4&#125;|([0-9a-fA-F]&#123;1,4&#125;:)&#123;1,7&#125;:|([0-9a-fA-F]&#123;1,4&#125;:)&#123;1,6&#125;:[0-9a-fA-F]&#123;1,4&#125;|([0-9a-fA-F]&#123;1,4&#125;:)&#123;1,5&#125;(:[0-9a-fA-F]&#123;1,4&#125;)&#123;1,2&#125;|([0-9a-fA-F]&#123;1,4&#125;:)&#123;1,4&#125;(:[0-9a-fA-F]&#123;1,4&#125;)&#123;1,3&#125;|([0-9a-fA-F]&#123;1,4&#125;:)&#123;1,3&#125;(:[0-9a-fA-F]&#123;1,4&#125;)&#123;1,4&#125;|([0-9a-fA-F]&#123;1,4&#125;:)&#123;1,2&#125;(:[0-9a-fA-F]&#123;1,4&#125;)&#123;1,5&#125;|[0-9a-fA-F]&#123;1,4&#125;:((:[0-9a-fA-F]&#123;1,4&#125;)&#123;1,6&#125;)|:((:[0-9a-fA-F]&#123;1,4&#125;)&#123;1,7&#125;|:)|fe80:(:[0-9a-fA-F]&#123;0,4&#125;)&#123;0,4&#125;%[0-9a-zA-Z]&#123;1,&#125;|::(ffff(:0&#123;1,4&#125;)&#123;0,1&#125;:)&#123;0,1&#125;((25[0-5]|(2[0-4]|1&#123;0,1&#125;[0-9])&#123;0,1&#125;[0-9])\.)&#123;3,3&#125;(25[0-5]|(2[0-4]|1&#123;0,1&#125;[0-9])&#123;0,1&#125;[0-9])|([0-9a-fA-F]&#123;1,4&#125;:)&#123;1,4&#125;:((25[0-5]|(2[0-4]|1&#123;0,1&#125;[0-9])&#123;0,1&#125;[0-9])\.)&#123;3,3&#125;(25[0-5]|(2[0-4]|1&#123;0,1&#125;[0-9])&#123;0,1&#125;[0-9]))<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>** 匹配：**1:2:3:4:5:6:7:8 | 1:: | 1::8 | 1::6:7:8 | 1::5:6:7:8 | 1::4:5:6:7:8 | 1::3:4:5:6:7:8 | ::2:3:4:5:6:7:8 | 1:2:3:4:5:6:7:: | 1:2:3:4:5:6::8 | 1:2:3:4:5::8 | 1:2:3:4::8 | 1:2:3::8 | 1:2::8 | 1::8 | ::8 | fe80::7:8%1 | ::255.255.255.255 | 2001:db8:3:4::192.0.2.33 | 64:ff9b::192.0.2.33</li>
<li>** 不匹配：**1.2.3.4.5.6.7.8 | 1::2::3</li>
</ul>
<h3 id="-261"><a class="markdownIt-Anchor" href="#-261">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#_7-2-%E7%89%B9%E5%AE%9A%E5%AD%97%E7%AC%A6">#</a>7.2. 特定字符</h3>
<ul>
<li>匹配长度为 3 的字符串： <code>^.&#123;3&#125;$</code> 。</li>
<li>匹配由 26 个英文字母组成的字符串： <code>^[A-Za-z]+$</code> 。</li>
<li>匹配由 26 个大写英文字母组成的字符串： <code>^[A-Z]+$</code> 。</li>
<li>匹配由 26 个小写英文字母组成的字符串： <code>^[a-z]+$</code> 。</li>
<li>匹配由数字和 26 个英文字母组成的字符串： <code>^[A-Za-z0-9]+$</code> 。</li>
<li>匹配由数字、26 个英文字母或者下划线组成的字符串： <code>^\w+$</code> 。</li>
</ul>
<h3 id="-262"><a class="markdownIt-Anchor" href="#-262">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#_7-3-%E7%89%B9%E5%AE%9A%E6%95%B0%E5%AD%97">#</a>7.3. 特定数字</h3>
<ul>
<li>匹配正整数： <code>^[1-9]\d*$</code></li>
<li>匹配负整数： <code>^-[1-9]\d*$</code></li>
<li>匹配整数： <code>^(-?[1-9]\d*)|0$</code></li>
<li>匹配正浮点数： <code>^[1-9]\d*\.\d+|0\.\d+$</code></li>
<li>匹配负浮点数： <code>^-([1-9]\d*\.\d*|0\.\d*[1-9]\d*)$</code></li>
<li>匹配浮点数： <code>^-?([1-9]\d*\.\d*|0\.\d*[1-9]\d*|0?\.0+|0)$</code></li>
</ul>
<h2 id="-263"><a class="markdownIt-Anchor" href="#-263">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#_8-%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E7%9A%84%E6%80%A7%E8%83%BD">#</a>8. 正则表达式的性能</h2>
<p>目前实现正则表达式引擎的方式有两种：DFA 自动机（Deterministic Final Automata 确定有限状态自动机）和 NFA 自动机（Non deterministic Finite Automaton 非确定有限状态自动机）。对比来看，构造 DFA 自动机的代价远大于 NFA 自动机，但 DFA 自动机的执行效率高于 NFA 自动机。</p>
<p>假设一个字符串的长度是 n，如果用 DFA 自动机作为正则表达式引擎，则匹配的时间复杂度为 O (n)；如果用 NFA 自动机作为正则表达式引擎，由于 NFA 自动机在匹配过程中存在大量的分支和回溯，假设 NFA 的状态数为 s，则该匹配算法的时间复杂度为 O（ns）。</p>
<p>NFA 自动机的优势是支持更多功能。例如，捕获 group、环视、占有优先量词等高级功能。这些功能都是基于子表达式独立进行匹配，因此在编程语言里，使用的正则表达式库都是基于 NFA 实现的。</p>
<h3 id="-264"><a class="markdownIt-Anchor" href="#-264">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#_8-1-nfa-%E8%87%AA%E5%8A%A8%E6%9C%BA%E7%9A%84%E5%9B%9E%E6%BA%AF">#</a>8.1. NFA 自动机的回溯</h3>
<p>用 NFA 自动机实现的比较复杂的正则表达式，在匹配过程中经常会引起回溯问题。大量的回溯会长时间地占用 CPU，从而带来系统性能开销。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">text=“abbc”
regex=“ab&#123;1,3&#125;c”<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>这个例子匹配目的是：匹配以 a 开头，以 c 结尾，中间有 1-3 个 b 字符的字符串。NFA 自动机对其解析的过程是这样的：</p>
<ul>
<li>读取正则表达式第一个匹配符 a 和字符串第一个字符 a 进行比较，a 对 a，匹配。</li>
<li>然后，读取正则表达式第二个匹配符  <code>b&#123;1,3&#125;</code>  和字符串的第二个字符 b 进行比较，匹配。但因为  <code>b&#123;1,3&#125;</code>  表示 1-3 个 b 字符串，NFA 自动机又具有贪婪特性，所以此时不会继续读取正则表达式的下一个匹配符，而是依旧使用  <code>b&#123;1,3&#125;</code>  和字符串的第三个字符 b 进行比较，结果还是匹配。</li>
<li>接着继续使用  <code>b&#123;1,3&#125;</code>  和字符串的第四个字符 c 进行比较，发现不匹配了，此时就会发生回溯，已经读取的字符串第四个字符 c 将被吐出去，指针回到第三个字符 b 的位置。</li>
<li>那么发生回溯以后，匹配过程怎么继续呢？程序会读取正则表达式的下一个匹配符 c，和字符串中的第四个字符 c 进行比较，结果匹配，结束。</li>
</ul>
<h3 id="-265"><a class="markdownIt-Anchor" href="#-265">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#_8-2-%E5%A6%82%E4%BD%95%E9%81%BF%E5%85%8D%E5%9B%9E%E6%BA%AF">#</a>8.2. 如何避免回溯</h3>
<h4 id="-266"><a class="markdownIt-Anchor" href="#-266">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#%E8%B4%AA%E5%A9%AA%E6%A8%A1%E5%BC%8F-greedy">#</a>贪婪模式（Greedy）</h4>
<p>顾名思义，就是在数量匹配中，如果单独使用 +、 ? 、* 或 {min,max} 等量词，正则表达式会匹配尽可能多的内容。</p>
<p>例如，上边那个例子：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">text=“abbc”
regex=“ab&#123;1,3&#125;c”<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>就是在贪婪模式下，NFA 自动机读取了最大的匹配范围，即匹配 3 个 b 字符。匹配发生了一次失败，就引起了一次回溯。如果匹配结果是 “abbbc”，就会匹配成功。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">text=“abbbc”
regex=“ab&#123;1,3&#125;c”<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h4 id="-267"><a class="markdownIt-Anchor" href="#-267">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#%E6%87%92%E6%83%B0%E6%A8%A1%E5%BC%8F-reluctant">#</a>懒惰模式（Reluctant）</h4>
<p>在该模式下，正则表达式会尽可能少地重复匹配字符。如果匹配成功，它会继续匹配剩余的字符串。</p>
<p>例如，在上面例子的字符后面加一个 “？”，就可以开启懒惰模式。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">text=“abc”
regex=“ab&#123;1,3&#125;?c”<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>匹配结果是 “abc”，该模式下 NFA 自动机首先选择最小的匹配范围，即匹配 1 个 b 字符，因此就避免了回溯问题。</p>
<h4 id="-268"><a class="markdownIt-Anchor" href="#-268">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#%E7%8B%AC%E5%8D%A0%E6%A8%A1%E5%BC%8F-possessive">#</a>独占模式（Possessive）</h4>
<p>同贪婪模式一样，独占模式一样会最大限度地匹配更多内容；不同的是，在独占模式下，匹配失败就会结束匹配，不会发生回溯问题。</p>
<p>还是上边的例子，在字符后面加一个 “+”，就可以开启独占模式。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">text=“abbc”
regex=“ab&#123;1,3&#125;+bc”<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>结果是不匹配，结束匹配，不会发生回溯问题。</p>
<blockquote>
<p>讲到这里，你应该非常清楚了，<strong>避免回溯的方法就是：使用懒惰模式和独占模式。</strong></p>
</blockquote>
<h3 id="-269"><a class="markdownIt-Anchor" href="#-269">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#_8-3-%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E7%9A%84%E4%BC%98%E5%8C%96">#</a>8.3. 正则表达式的优化</h3>
<h4 id="-270"><a class="markdownIt-Anchor" href="#-270">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#%E5%B0%91%E7%94%A8%E8%B4%AA%E5%A9%AA%E6%A8%A1%E5%BC%8F-%E5%A4%9A%E7%94%A8%E7%8B%AC%E5%8D%A0%E6%A8%A1%E5%BC%8F">#</a>少用贪婪模式，多用独占模式</h4>
<p>贪婪模式会引起回溯问题，可以使用独占模式来避免回溯。</p>
<h4 id="-271"><a class="markdownIt-Anchor" href="#-271">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#%E5%87%8F%E5%B0%91%E5%88%86%E6%94%AF%E9%80%89%E6%8B%A9">#</a>减少分支选择</h4>
<p>分支选择类型  <code>(X|Y|Z)</code>  的正则表达式会降低性能，我们在开发的时候要尽量减少使用。如果一定要用，我们可以通过以下几种方式来优化：</p>
<ul>
<li>首先，我们需要考虑选择的顺序，将比较常用的选择项放在前面，使它们可以较快地被匹配；</li>
<li>其次，我们可以尝试提取共用模式，例如，将  <code>(abcd|abef)</code>  替换为  <code>ab(cd|ef)</code> ，后者匹配速度较快，因为 NFA 自动机会尝试匹配 ab，如果没有找到，就不会再尝试任何选项；</li>
<li>最后，如果是简单的分支选择类型，我们可以用三次 index 代替  <code>(X|Y|Z)</code> ，如果测试的话，你就会发现三次 index 的效率要比  <code>(X|Y|Z)</code>  高出一些。</li>
</ul>
<h4 id="-272"><a class="markdownIt-Anchor" href="#-272">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-regex.html#%E5%87%8F%E5%B0%91%E6%8D%95%E8%8E%B7%E5%B5%8C%E5%A5%97">#</a>减少捕获嵌套</h4>
<ul>
<li>捕获组是指把正则表达式中，子表达式匹配的内容保存到以数字编号或显式命名的数组中，方便后面引用。一般一个 () 就是一个捕获组，捕获组可以进行嵌套。</li>
<li>非捕获组则是指参与匹配却不进行分组编号的捕获组，其表达式一般由  <code>(?:exp)</code>  组成。</li>
</ul>
<p>在正则表达式中，每个捕获组都有一个编号，编号 0 代表整个匹配到的内容。我们可以看下面的例子：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token class-name">String</span> text <span class="token operator">=</span> <span class="token string">"&lt;input high=\"20\" weight=\"70\">test&lt;/input>"</span><span class="token punctuation">;</span>
	<span class="token class-name">String</span> reg<span class="token operator">=</span><span class="token string">"(&lt;input.*?>)(.*?)(&lt;/input>)"</span><span class="token punctuation">;</span>
	<span class="token class-name">Pattern</span> p <span class="token operator">=</span> <span class="token class-name">Pattern</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>reg<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">Matcher</span> m <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">matcher</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 整个匹配到的内容</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//(&lt;input.*?>)</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//(.*?)</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//(&lt;/input>)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>运行结果：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">&lt;input high=\"20\" weight=\"70\">test&lt;/input>
&lt;input high=\"20\" weight=\"70\">
test
&lt;/input><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果你并不需要获取某一个分组内的文本，那么就使用非捕获分组。例如，使用 “(?:X)” 代替 “(X)”，我们再看下面的例子：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token class-name">String</span> text <span class="token operator">=</span> <span class="token string">"&lt;input high=\"20\" weight=\"70\">test&lt;/input>"</span><span class="token punctuation">;</span>
	<span class="token class-name">String</span> reg<span class="token operator">=</span><span class="token string">"(?:&lt;input.*?>)(.*?)(?:&lt;/input>)"</span><span class="token punctuation">;</span>
	<span class="token class-name">Pattern</span> p <span class="token operator">=</span> <span class="token class-name">Pattern</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>reg<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">Matcher</span> m <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">matcher</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 整个匹配到的内容</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//(.*?)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>运行结果：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">&lt;input high=\"20\" weight=\"70\">test&lt;/input>
test<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>综上可知：减少不需要获取的分组，可以提高正则表达式的性能。</p>
<hr>
<h1 id="java-编码和加密"><a class="markdownIt-Anchor" href="#java-编码和加密">#</a> Java 编码和加密</h1>
<blockquote>
<p><strong>📦 本文以及示例源码已归档在 <a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/">javacore(opens new window)</a></strong></p>
<p>关键词： <code>Base64</code> 、 <code>消息摘要</code> 、 <code>数字签名</code> 、 <code>对称加密</code> 、 <code>非对称加密</code> 、 <code>MD5</code> 、 <code>SHA</code> 、 <code>HMAC</code> 、 <code>AES</code> 、 <code>DES</code> 、 <code>DESede</code> 、 <code>RSA</code></p>
</blockquote>
<ul>
<li>一、Base64 编码
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-crypto.html#base64-%E5%8E%9F%E7%90%86">Base64 原理</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-crypto.html#base64-%E5%BA%94%E7%94%A8">Base64 应用</a></li>
</ul>
</li>
<li>二、消息摘要
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-crypto.html#%E6%B6%88%E6%81%AF%E6%91%98%E8%A6%81%E6%A6%82%E8%BF%B0">消息摘要概述</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-crypto.html#%E6%B6%88%E6%81%AF%E6%91%98%E8%A6%81%E7%89%B9%E7%82%B9">消息摘要特点</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-crypto.html#%E6%B6%88%E6%81%AF%E6%91%98%E8%A6%81%E5%B8%B8%E7%94%A8%E7%AE%97%E6%B3%95">消息摘要常用算法</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-crypto.html#%E6%B6%88%E6%81%AF%E6%91%98%E8%A6%81%E5%BA%94%E7%94%A8">消息摘要应用</a></li>
</ul>
</li>
<li>三、数字签名
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-crypto.html#%E6%95%B0%E5%AD%97%E7%AD%BE%E5%90%8D%E6%A6%82%E8%BF%B0">数字签名概述</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-crypto.html#%E6%95%B0%E5%AD%97%E7%AD%BE%E5%90%8D%E7%AE%97%E6%B3%95%E5%BA%94%E7%94%A8">数字签名算法应用</a></li>
</ul>
</li>
<li>四、对称加密
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-crypto.html#%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86%E6%A6%82%E8%BF%B0">对称加密概述</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-crypto.html#%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86%E5%BA%94%E7%94%A8">对称加密应用</a></li>
</ul>
</li>
<li>五、非对称加密
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-crypto.html#%E9%9D%9E%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86%E6%A6%82%E8%BF%B0">非对称加密概述</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-crypto.html#%E9%9D%9E%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95%E5%BA%94%E7%94%A8">非对称加密算法应用</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-crypto.html#%E5%85%AD%E6%9C%AF%E8%AF%AD">六、术语</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-crypto.html#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">参考资料</a></li>
</ul>
<h2 id="-273"><a class="markdownIt-Anchor" href="#-273">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-crypto.html#%E4%B8%80%E3%80%81base64-%E7%BC%96%E7%A0%81">#</a>一、Base64 编码</h2>
<h3 id="-274"><a class="markdownIt-Anchor" href="#-274">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-crypto.html#base64-%E5%8E%9F%E7%90%86">#</a>Base64 原理</h3>
<p>Base64 内容传送编码是一种以任意 8 位字节序列组合的描述形式，这种形式不易被人直接识别。</p>
<p>Base64 是一种很常见的编码规范，其作用是将二进制序列转换为人类可读的 ASCII 字符序列，常用在需用通过文本协议（比如 HTTP 和 SMTP）来传输二进制数据的情况下。<strong>Base64 并不是加密解密算法</strong>，尽管我们有时也听到使用 Base64 来加密解密的说法，但这里所说的加密与解密实际是指 ** 编码（encode）<strong>和</strong>解码（decode）** 的过程，其变换是非常简单的，仅仅能够避免信息被直接识别。</p>
<p>Base64 算法主要是将给定的字符以字符编码 (如 ASCII 码，UTF-8 码) 对应的十进制数为基准，做编码操作：</p>
<ol>
<li>将给定的字符串以字符为单位，转换为对应的字符编码。</li>
<li>将获得字符编码转换为二进制</li>
<li>对二进制码做分组转换，每 3 个字节为一组，转换为每 4 个 6 位二进制位一组（不足 6 位时低位补 0）。这是一个分组变化的过程，3 个 8 位二进制码和 4 个 6 位二进制码的长度都是 24 位（3<em>8 = 4</em>6 = 24）。</li>
<li>对获得的 4-6 二进制码补位，向 6 位二进制码添加 2 位高位 0，组成 4 个 8 位二进制码。</li>
<li>对获得的 4-8 二进制码转换为十进制码。</li>
<li>将获得的十进制码转换为 Base64 字符表中对应的字符。</li>
</ol>
<p>*<strong>Base64 编码表 *</strong></p>
<table>
<thead>
<tr>
<th><strong>索引</strong></th>
<th><strong>对应字符</strong></th>
<th><strong>索引</strong></th>
<th><strong>对应字符</strong></th>
<th><strong>索引</strong></th>
<th><strong>对应字符</strong></th>
<th><strong>索引</strong></th>
<th><strong>对应字符</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>A</td>
<td>17</td>
<td>R</td>
<td>34</td>
<td>i</td>
<td>51</td>
<td>z</td>
</tr>
<tr>
<td>1</td>
<td>B</td>
<td>18</td>
<td>S</td>
<td>35</td>
<td>j</td>
<td>52</td>
<td>0</td>
</tr>
<tr>
<td>2</td>
<td>C</td>
<td>19</td>
<td>T</td>
<td>36</td>
<td>k</td>
<td>53</td>
<td>1</td>
</tr>
<tr>
<td>3</td>
<td>D</td>
<td>20</td>
<td>U</td>
<td>37</td>
<td>l</td>
<td>54</td>
<td>2</td>
</tr>
<tr>
<td>4</td>
<td>E</td>
<td>21</td>
<td>V</td>
<td>38</td>
<td>m</td>
<td>55</td>
<td>3</td>
</tr>
<tr>
<td>5</td>
<td>F</td>
<td>22</td>
<td>W</td>
<td>39</td>
<td>n</td>
<td>56</td>
<td>4</td>
</tr>
<tr>
<td>6</td>
<td>G</td>
<td>23</td>
<td>X</td>
<td>40</td>
<td>o</td>
<td>57</td>
<td>5</td>
</tr>
<tr>
<td>7</td>
<td>H</td>
<td>24</td>
<td>Y</td>
<td>41</td>
<td>p</td>
<td>58</td>
<td>6</td>
</tr>
<tr>
<td>8</td>
<td>I</td>
<td>25</td>
<td>Z</td>
<td>42</td>
<td>q</td>
<td>59</td>
<td>7</td>
</tr>
<tr>
<td>9</td>
<td>J</td>
<td>26</td>
<td>a</td>
<td>43</td>
<td>r</td>
<td>60</td>
<td>8</td>
</tr>
<tr>
<td>10</td>
<td>K</td>
<td>27</td>
<td>b</td>
<td>44</td>
<td>s</td>
<td>61</td>
<td>9</td>
</tr>
<tr>
<td>11</td>
<td>L</td>
<td>28</td>
<td>c</td>
<td>45</td>
<td>t</td>
<td>62</td>
<td>+</td>
</tr>
<tr>
<td>12</td>
<td>M</td>
<td>29</td>
<td>d</td>
<td>46</td>
<td>u</td>
<td>63</td>
<td>/</td>
</tr>
<tr>
<td>13</td>
<td>N</td>
<td>30</td>
<td>e</td>
<td>47</td>
<td>v</td>
<td></td>
<td></td>
</tr>
<tr>
<td>14</td>
<td>O</td>
<td>31</td>
<td>f</td>
<td>48</td>
<td>w</td>
<td></td>
<td></td>
</tr>
<tr>
<td>15</td>
<td>P</td>
<td>32</td>
<td>g</td>
<td>49</td>
<td>x</td>
<td></td>
<td></td>
</tr>
<tr>
<td>16</td>
<td>Q</td>
<td>33</td>
<td>h</td>
<td>50</td>
<td>y</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="-275"><a class="markdownIt-Anchor" href="#-275">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-crypto.html#base64-%E5%BA%94%E7%94%A8">#</a>Base64 应用</h3>
<p>Base64 编码可用于在 HTTP 环境下传递较长的标识信息。在其他应用程序中，也常常需要把二进制数据编码为适合放在 URL (包括隐藏表单域) 中的形式。此时，采用 Base64 编码具有不可读性，即所编码的数据不会被人用肉眼所直接看到，算是起到一个加密的作用。</p>
<p>然而，<strong>标准的 Base64 并不适合直接放在 URL 里传输</strong>，因为 URL 编码器会把标准 Base64 中的  <code>/</code>  和  <code>+</code>  字符变为形如  <code>%XX</code>  的形式，而这些  <code>%</code>  号在存入数据库时还需要再进行转换，因为 ANSI SQL 中已将  <code>%</code>  号用作通配符。</p>
<p>为解决此问题，可采用一种用于 URL 的改进 Base64 编码，它不仅在末尾填充  <code>=</code>  号，并将标准 Base64 中的 “+” 和 “/” 分别改成了  <code>-</code>  和  <code>_</code> ，这样就免去了在 URL 编解码和数据库存储时所要作的转换，避免了编码信息长度在此过程中的增加，并统一了数据库、表单等处对象标识符的格式。</p>
<p>另有一种用于正则表达式的改进 Base64 变种，它将  <code>+</code>  和  <code>/</code>  改成了  <code>!</code>  和  <code>-</code> ，因为  <code>+</code> ,  <code>*</code>  以及前面在 IRCu 中用到的  <code>[</code>  和  <code>]</code>  在正则表达式中都可能具有特殊含义。</p>
<p>【示例】 <code>java.util.Base64</code>  编码、解码示例</p>
<p><code>Base64.getEncoder()</code>  和  <code>Base64.getDecoder()</code>  提供了的是标准的 Base64 编码、解码方式；</p>
<p><code>Base64.getUrlEncoder()</code>  和  <code>Base64.getUrlDecoder()</code>  提供了 URL 安全的 Base64 编码、解码方式（将  <code>+</code>  和  <code>/</code>  替换为  <code>-</code>  和  <code>_</code> ）。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>charset<span class="token punctuation">.</span></span><span class="token class-name">StandardCharsets</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Base64</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Base64Demo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token string">"https://www.baidu.com"</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"url:"</span> <span class="token operator">+</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 标准的 Base64 编码、解码</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> encoded <span class="token operator">=</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> decoded <span class="token operator">=</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>encoded<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Url Safe Base64 encoded:"</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>encoded<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Url Safe Base64 decoded:"</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>decoded<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// URL 安全的 Base64 编码、解码</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> encoded2 <span class="token operator">=</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getUrlEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> decoded2 <span class="token operator">=</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getUrlDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>encoded2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Base64 encoded:"</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>encoded2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Base64 decoded:"</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>decoded2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>输出：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">url:https://www.baidu.com
Url Safe Base64 encoded:aHR0cHM6Ly93d3cuYmFpZHUuY29t
Url Safe Base64 decoded:https://www.baidu.com
Base64 encoded:aHR0cHM6Ly93d3cuYmFpZHUuY29t
Base64 decoded:https://www.baidu.com<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="-276"><a class="markdownIt-Anchor" href="#-276">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-crypto.html#%E4%BA%8C%E3%80%81%E6%B6%88%E6%81%AF%E6%91%98%E8%A6%81">#</a>二、消息摘要</h2>
<h3 id="-277"><a class="markdownIt-Anchor" href="#-277">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-crypto.html#%E6%B6%88%E6%81%AF%E6%91%98%E8%A6%81%E6%A6%82%E8%BF%B0">#</a>消息摘要概述</h3>
<p><strong>消息摘要，其实就是将需要摘要的数据作为参数，经过哈希函数 (Hash) 的计算，得到的散列值</strong>。</p>
<p>消息摘要是一个唯一对应一个消息或文本的固定长度的值，它由一个单向 Hash 加密函数对消息进行作用而产生。如果消息在途中改变了，则接收者通过对收到消息的新产生的摘要与原摘要比较，就可知道消息是否被改变了。因此消息摘要保证了消息的完整性。消息摘要采用单向 Hash 函数将需加密的明文 &quot;摘要&quot; 成一串密文，这一串密文亦称为数字指纹 (Finger Print)。它有固定的长度，且不同的明文摘要成密文，其结果总是不同的，而同样的明文其摘要必定一致。这样这串摘要便可成为验证明文是否是 &quot;真身&quot; 的 &quot;指纹&quot; 了。</p>
<h3 id="-278"><a class="markdownIt-Anchor" href="#-278">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-crypto.html#%E6%B6%88%E6%81%AF%E6%91%98%E8%A6%81%E7%89%B9%E7%82%B9">#</a>消息摘要特点</h3>
<ul>
<li>唯一性：数据只要有一点改变，那么再通过消息摘要算法得到的摘要也会发生变化。虽然理论上有可能会发生碰撞，但是概率极其低。</li>
<li>不可逆：消息摘要算法的密文无法被解密。</li>
<li>不需要密钥，可使用于分布式网络。</li>
<li>无论输入的明文有多长，计算出来的消息摘要的长度总是固定的。</li>
</ul>
<h3 id="-279"><a class="markdownIt-Anchor" href="#-279">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-crypto.html#%E6%B6%88%E6%81%AF%E6%91%98%E8%A6%81%E5%B8%B8%E7%94%A8%E7%AE%97%E6%B3%95">#</a>消息摘要常用算法</h3>
<p>消息摘要算法包括<strong> MD (Message Digest，消息摘要算法)</strong>、<strong>SHA (Secure Hash Algorithm，安全散列算法)</strong>、**MAC (Message AuthenticationCode，消息认证码算法)** 共 3 大系列，常用于验证数据的完整性，是数字签名算法的核心算法。</p>
<p><strong>MD5</strong> 和<strong> SHA1</strong> 分别是<strong> MD</strong>、<strong>SHA</strong> 算法系列中最有代表性的算法。</p>
<p>如今，MD5 已被发现有许多漏洞，从而不再安全。SHA 算法比 MD 算法的摘要长度更长，也更加安全。</p>
<h3 id="-280"><a class="markdownIt-Anchor" href="#-280">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-crypto.html#%E6%B6%88%E6%81%AF%E6%91%98%E8%A6%81%E5%BA%94%E7%94%A8">#</a>消息摘要应用</h3>
<h4 id="-281"><a class="markdownIt-Anchor" href="#-281">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-crypto.html#md5%E3%80%81sha-%E7%9A%84%E8%8C%83%E4%BE%8B">#</a>MD5、SHA 的范例</h4>
<p>JDK 中使用 MD5 和 SHA 这两种消息摘要的方式基本一致，步骤如下：</p>
<ol>
<li>初始化 MessageDigest 对象</li>
<li>更新要计算的内容</li>
<li>生成摘要</li>
</ol>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span><span class="token class-name">MessageDigest</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Base64</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MessageDigestDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">encode</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> input<span class="token punctuation">,</span> <span class="token class-name">Type</span> type<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 根据类型，初始化消息摘要对象</span>
        <span class="token class-name">MessageDigest</span> md5Digest <span class="token operator">=</span> <span class="token class-name">MessageDigest</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>type<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 更新要计算的内容</span>
        md5Digest<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 完成哈希计算，返回摘要</span>
        <span class="token keyword">return</span> md5Digest<span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">encodeWithBase64</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> input<span class="token punctuation">,</span> <span class="token class-name">Type</span> type<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getUrlEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token function">encode</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">encodeWithBase64String</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> input<span class="token punctuation">,</span> <span class="token class-name">Type</span> type<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getUrlEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encodeToString</span><span class="token punctuation">(</span><span class="token function">encode</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">Type</span> <span class="token punctuation">&#123;</span>
        <span class="token function">MD2</span><span class="token punctuation">(</span><span class="token string">"MD2"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">MD5</span><span class="token punctuation">(</span><span class="token string">"MD5"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">SHA1</span><span class="token punctuation">(</span><span class="token string">"SHA1"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">SHA256</span><span class="token punctuation">(</span><span class="token string">"SHA-256"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">SHA384</span><span class="token punctuation">(</span><span class="token string">"SHA-384"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">SHA512</span><span class="token punctuation">(</span><span class="token string">"SHA-512"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>

        <span class="token class-name">Type</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token string">"Hello World!"</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"MD2: "</span> <span class="token operator">+</span> <span class="token function">encodeWithBase64String</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Type</span><span class="token punctuation">.</span>MD2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"MD5: "</span> <span class="token operator">+</span> <span class="token function">encodeWithBase64String</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Type</span><span class="token punctuation">.</span>MD5<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"SHA1: "</span> <span class="token operator">+</span> <span class="token function">encodeWithBase64String</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Type</span><span class="token punctuation">.</span>SHA1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"SHA256: "</span> <span class="token operator">+</span> <span class="token function">encodeWithBase64String</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Type</span><span class="token punctuation">.</span>SHA256<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"SHA384: "</span> <span class="token operator">+</span> <span class="token function">encodeWithBase64String</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Type</span><span class="token punctuation">.</span>SHA384<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"SHA512: "</span> <span class="token operator">+</span> <span class="token function">encodeWithBase64String</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Type</span><span class="token punctuation">.</span>SHA512<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>【输出】</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">MD2: MV98ZyI_Aft8q0uVEA6HLg==
MD5: 7Qdih1MuhjZehB6Sv8UNjA==
SHA1: Lve95gjOVATpfV8EL5X4nxwjKHE=
SHA256: f4OxZX_x_FO5LcGBSKHWXfwtSx-j1ncoSt3SABJtkGk=
SHA384: v9dsDrvQBv7lg0EFR8GIewKSvnbVgtlsJC0qeScj4_1v0GH51c_RO4-WE1jmrbpK
SHA512: hhhE1nBOhXP-w02WfiC8_vPUJM9IvgTm3AjyvVjHKXQzcQFerYkcw88cnTS0kmS1EHUbH_nlN5N7xGtdb_TsyA==<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-282"><a class="markdownIt-Anchor" href="#-282">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-crypto.html#hmac-%E7%9A%84%E8%8C%83%E4%BE%8B">#</a>HMAC 的范例</h4>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>charset<span class="token punctuation">.</span></span><span class="token class-name">StandardCharsets</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Base64</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span></span><span class="token class-name">Mac</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>spec<span class="token punctuation">.</span></span><span class="token class-name">SecretKeySpec</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HmacMessageDigest</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token string">"Hello World!"</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> salt <span class="token operator">=</span> <span class="token string">"My Salt"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"原文: "</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"HmacMD5: "</span> <span class="token operator">+</span> <span class="token function">encodeWithBase64String</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> salt<span class="token punctuation">,</span> <span class="token class-name">HmacTypeEn<span class="token punctuation">.</span>HmacMD5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"HmacSHA1: "</span> <span class="token operator">+</span> <span class="token function">encodeWithBase64String</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> salt<span class="token punctuation">,</span> <span class="token class-name">HmacTypeEn<span class="token punctuation">.</span>HmacSHA1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"HmacSHA256: "</span> <span class="token operator">+</span> <span class="token function">encodeWithBase64String</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> salt<span class="token punctuation">,</span> <span class="token class-name">HmacTypeEn<span class="token punctuation">.</span>HmacSHA256</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"HmacSHA384: "</span> <span class="token operator">+</span> <span class="token function">encodeWithBase64String</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> salt<span class="token punctuation">,</span> <span class="token class-name">HmacTypeEn<span class="token punctuation">.</span>HmacSHA384</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"HmacSHA512: "</span> <span class="token operator">+</span> <span class="token function">encodeWithBase64String</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> salt<span class="token punctuation">,</span> <span class="token class-name">HmacTypeEn<span class="token punctuation">.</span>HmacSHA512</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">encode</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> plaintext<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> salt<span class="token punctuation">,</span> <span class="token class-name">HmacTypeEn</span> type<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">SecretKeySpec</span> keySpec <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SecretKeySpec</span><span class="token punctuation">(</span>salt<span class="token punctuation">,</span> type<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Mac</span> mac <span class="token operator">=</span> <span class="token class-name">Mac</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>keySpec<span class="token punctuation">.</span><span class="token function">getAlgorithm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mac<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>keySpec<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> mac<span class="token punctuation">.</span><span class="token function">doFinal</span><span class="token punctuation">(</span>plaintext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">encodeWithBase64</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> plaintext<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> salt<span class="token punctuation">,</span> <span class="token class-name">HmacTypeEn</span> type<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getUrlEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token function">encode</span><span class="token punctuation">(</span>plaintext<span class="token punctuation">,</span> salt<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">encodeWithBase64String</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> plaintext<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> salt<span class="token punctuation">,</span> <span class="token class-name">HmacTypeEn</span> type<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getUrlEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encodeToString</span><span class="token punctuation">(</span><span class="token function">encode</span><span class="token punctuation">(</span>plaintext<span class="token punctuation">,</span> salt<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * JDK支持 HmacMD5, HmacSHA1, HmacSHA256, HmacSHA384, HmacSHA512
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">HmacTypeEn</span> <span class="token punctuation">&#123;</span>

        <span class="token class-name">HmacMD5</span><span class="token punctuation">,</span> <span class="token class-name">HmacSHA1</span><span class="token punctuation">,</span> <span class="token class-name">HmacSHA256</span><span class="token punctuation">,</span> <span class="token class-name">HmacSHA384</span><span class="token punctuation">,</span> <span class="token class-name">HmacSHA512</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>输出</strong></p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">原文: Hello World!
HmacMD5: re6BLRsB1Q26SfJTwXZUSQ==
HmacSHA1: CFu8a9H6CbY9C5fo0OmJ2bnuILM=
HmacSHA256: Z1czUqDWWfYYl7qEDJ2sUH6iieHVI7o83dXMl0JYER0=
HmacSHA384: 34mKtRQBOYnwwznmQubjrDk_MsLDGqM2PmgcplZUpLsKNrG_cwfz4bLPJCbBW88b
HmacSHA512: 6n77htTZ_atc04-SsmxhSK3wzh1sAmdudCl0Cb_RZp4DpienG4LZkhXMbq8lcK7XSnz6my_wIpnStDp6PC_-5w==<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="-283"><a class="markdownIt-Anchor" href="#-283">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-crypto.html#%E4%B8%89%E3%80%81%E6%95%B0%E5%AD%97%E7%AD%BE%E5%90%8D">#</a>三、数字签名</h2>
<h3 id="-284"><a class="markdownIt-Anchor" href="#-284">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-crypto.html#%E6%95%B0%E5%AD%97%E7%AD%BE%E5%90%8D%E6%A6%82%E8%BF%B0">#</a>数字签名概述</h3>
<p>数字签名算法可以看做是一种带有密钥的消息摘要算法，并且这种密钥包含了公钥和私钥。也就是说，<strong>数字签名算法是非对称加密算法和消息摘要算法的结合体</strong>。</p>
<p>数字签名算法要求能够验证数据完整性、认证数据来源，并起到抗否认的作用。</p>
<p>数字签名算法包含签名和验证两项操作，遵循私钥签名，公钥验证的方式。</p>
<p>签名时要使用私钥和待签名数据，验证时则需要公钥、签名值和待签名数据，其核心算法主要是消息摘要算法。</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/java-message-digest-process.jpg" alt="img"></p>
<p>数字签名常用算法：<strong>RSA</strong>、<strong>DSA</strong>、<strong>ECDSA</strong></p>
<h3 id="-285"><a class="markdownIt-Anchor" href="#-285">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-crypto.html#%E6%95%B0%E5%AD%97%E7%AD%BE%E5%90%8D%E7%AE%97%E6%B3%95%E5%BA%94%E7%94%A8">#</a>数字签名算法应用</h3>
<h4 id="-286"><a class="markdownIt-Anchor" href="#-286">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-crypto.html#dsa-%E7%9A%84%E8%8C%83%E4%BE%8B">#</a>DSA 的范例</h4>
<p>数字签名有两个流程：签名和验证。</p>
<p>它们的前提都是要有一个公钥、密钥对。</p>
<p>数字签名用私钥为消息计算签名。</p>
<p>【示例】用公钥验证摘要</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DsaCoder</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> KEY_ALGORITHM <span class="token operator">=</span> <span class="token string">"DSA"</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> SIGN_ALGORITHM <span class="token operator">=</span> <span class="token string">"SHA1withDSA"</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * DSA密钥长度默认1024位。 密钥长度必须是64的整数倍，范围在512~1024之间
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> KEY_SIZE <span class="token operator">=</span> <span class="token number">1024</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">KeyPair</span> keyPair<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">DsaCoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>keyPair <span class="token operator">=</span> <span class="token function">initKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token class-name">KeyPair</span> <span class="token function">initKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 初始化密钥对生成器</span>
        <span class="token class-name">KeyPairGenerator</span> keyPairGen <span class="token operator">=</span> <span class="token class-name">KeyPairGenerator</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token class-name">DsaCoder</span><span class="token punctuation">.</span>KEY_ALGORITHM<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 实例化密钥对生成器</span>
        keyPairGen<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span>KEY_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 实例化密钥对</span>
        <span class="token keyword">return</span> keyPairGen<span class="token punctuation">.</span><span class="token function">genKeyPair</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">signature</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> privateKey<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">PKCS8EncodedKeySpec</span> keySpec <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PKCS8EncodedKeySpec</span><span class="token punctuation">(</span>privateKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">KeyFactory</span> keyFactory <span class="token operator">=</span> <span class="token class-name">KeyFactory</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>KEY_ALGORITHM<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PrivateKey</span> key <span class="token operator">=</span> keyFactory<span class="token punctuation">.</span><span class="token function">generatePrivate</span><span class="token punctuation">(</span>keySpec<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Signature</span> signature <span class="token operator">=</span> <span class="token class-name">Signature</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>SIGN_ALGORITHM<span class="token punctuation">)</span><span class="token punctuation">;</span>
        signature<span class="token punctuation">.</span><span class="token function">initSign</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        signature<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> signature<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getPrivateKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> keyPair<span class="token punctuation">.</span><span class="token function">getPrivate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEncoded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">verify</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> publicKey<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> sign<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">X509EncodedKeySpec</span> keySpec <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">X509EncodedKeySpec</span><span class="token punctuation">(</span>publicKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">KeyFactory</span> keyFactory <span class="token operator">=</span> <span class="token class-name">KeyFactory</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>KEY_ALGORITHM<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PublicKey</span> key <span class="token operator">=</span> keyFactory<span class="token punctuation">.</span><span class="token function">generatePublic</span><span class="token punctuation">(</span>keySpec<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Signature</span> signature <span class="token operator">=</span> <span class="token class-name">Signature</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>SIGN_ALGORITHM<span class="token punctuation">)</span><span class="token punctuation">;</span>
        signature<span class="token punctuation">.</span><span class="token function">initVerify</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        signature<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> signature<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>sign<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getPublicKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> keyPair<span class="token punctuation">.</span><span class="token function">getPublic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEncoded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token string">"Hello World"</span><span class="token punctuation">;</span>
        <span class="token class-name">DsaCoder</span> dsa <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DsaCoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> sign <span class="token operator">=</span> dsa<span class="token punctuation">.</span><span class="token function">signature</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dsa<span class="token punctuation">.</span><span class="token function">getPrivateKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> flag <span class="token operator">=</span> dsa<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dsa<span class="token punctuation">.</span><span class="token function">getPublicKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sign<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> result <span class="token operator">=</span> flag <span class="token operator">?</span> <span class="token string">"数字签名匹配"</span> <span class="token operator">:</span> <span class="token string">"数字签名不匹配"</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"数字签名："</span> <span class="token operator">+</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getUrlEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encodeToString</span><span class="token punctuation">(</span>sign<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"验证结果："</span> <span class="token operator">+</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>【输出】</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">数字签名：MCwCFDPUO_VrONl5ST0AWary-MLXJuSCAhRMeMnUVhpizfa2H2M37tne0pUtoA==
验证结果：数字签名匹配<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h2 id="-287"><a class="markdownIt-Anchor" href="#-287">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-crypto.html#%E5%9B%9B%E3%80%81%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86">#</a>四、对称加密</h2>
<h3 id="-288"><a class="markdownIt-Anchor" href="#-288">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-crypto.html#%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86%E6%A6%82%E8%BF%B0">#</a>对称加密概述</h3>
<p>对称加密算法主要有 DES、3DES（TripleDES）、AES、IDEA、RC2、RC4、RC5 和 Blowfish 等。</p>
<p>对称加密算法是应用较早的加密算法，技术成熟。在对称加密算法中，数据发信方将明文（原始数据）和加密密钥（mi yao）一起经过特殊加密算法处理后，使其变成复杂的加密密文发送出去。收信方收到密文后，若想解读原文，则需要使用加密用过的密钥及相同算法的逆算法对密文进行解密，才能使其恢复成可读明文。在对称加密算法中，使用的密钥只有一个，发收信双方都使用这个密钥对数据进行加密和解密，这就要求解密方事先必须知道加密密钥。</p>
<p>对称加密特点：</p>
<ul>
<li>优点：计算量小、加密速度快、加密效率高。</li>
<li>缺点：算法是公开的，安全性得不到保证。</li>
</ul>
<p>通信双方每次使用对称加密算法时，都需要使用其他人不知道的惟一密钥，这会使得通信双方所拥有的密钥数量呈几何级数增长，密钥管理成为用户的负担。对称加密算法在分布式网络系统上使用较为困难，主要是因为密钥管理困难，使用成本较高。</p>
<p>而与公钥、密钥加密算法比起来，对称加密算法能够提供加密和认证却缺乏了签名功能，使得使用范围有所缩小。</p>
<h4 id="-289"><a class="markdownIt-Anchor" href="#-289">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-crypto.html#%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86%E5%8E%9F%E7%90%86">#</a>对称加密原理</h4>
<p>对称加密要求加密与解密使用同一个密钥，解密是加密的逆运算。由于加密、解密使用同一个密钥，这要求通信双方必须在通信前商定该密钥，并妥善保存该密钥。</p>
<p>对称加密体制分为两种：</p>
<p>一种是对明文的单个位（或字节）进行运算，称为流密码，也称为序列密码；</p>
<p>一种是把明文信息划分为不同的组（或块）结构，分别对每个组（或块）进行加密、解密，称为分组密码。</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/symmetric-encryption.png" alt="img"></p>
<p>假设甲乙方作为通信双方。假定甲乙双方在消息传递前已商定加密算法，欲完成一次消息传递需要经过如下步骤。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/cs/java/advanced/symmetric-encryption-progress.png" alt="img"></p>
<h4 id="-290"><a class="markdownIt-Anchor" href="#-290">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-crypto.html#%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F">#</a>对称加密工作模式</h4>
<p>以 DES 算法的工作模式为例，DES 算法根据其加密算法所定义的明文分组的大小（56 位），将数据分割成若干 56 位的加密区块，再以加密区块为单位，分别进行加密处理。如果最后剩下不足一个区块的大小，称之为<strong>短块</strong>。短块的处理方法有填充法、流密码加密法、密文挪用技术。</p>
<p>根据数据加密时每个加密区块见得关联方式来区分，可以分为以下种工作模式：</p>
<p><strong>(1) 电子密码本模式 (Electronic Code Book, ECB)</strong></p>
<p>用途：适合加密密钥，随机数等短数据。例如，安全地传递 DES 密钥，ECB 是最合适的模式。</p>
<p><strong>(2) 密文链接模式 (Cipher Booki Chaining, CBC)</strong></p>
<p>用途：可加密任意长度的数据，适用于计算产生检测数据完整性的消息认证 MAC。</p>
<p><strong>(3) 密文反馈模式 (Cipher Feed Back, CFB)</strong></p>
<p>用途：因错误传播无界，可以用于检查发现明文密文的篡改。</p>
<p><strong>(4) 输出反馈模式 (Output Feed Back, OFB)</strong></p>
<p>用途：使用于加密冗余性较大的数据，比如语音和图像数据。</p>
<p>AES 算法除了以上 4 中模式外，还有一种新的工作模式：</p>
<p><strong>(5) 计数器模式 (Counter, CTR)</strong></p>
<p>用途：适用于各种加密应用。</p>
<p>本文对于各种工作模式的原理展开描述。个人认为，作为工程应用，了解其用途即可。</p>
<h4 id="-291"><a class="markdownIt-Anchor" href="#-291">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-crypto.html#%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86%E5%A1%AB%E5%85%85%E6%96%B9%E6%B3%95">#</a>对称加密填充方法</h4>
<p>Java 中对称加密对于短块的处理，一般是采用填充方式。</p>
<p>常采用的是：NoPadding（不填充）、Zeros 填充（0 填充）、PKCS5Padding 填充。</p>
<p><strong>ZerosPadding</strong></p>
<p>方式：全部填充为 0 的字节</p>
<p>结果如下：</p>
<p>F1 F2 F3 F4 F5 F6 F7 F8 // 第一块</p>
<p>F9 00 00 00 00 00 00 00 // 第二块</p>
<p><strong>PKCS5Padding</strong></p>
<p>方式：每个填充的字节都记录了填充的总字节数</p>
<p>结果如下：</p>
<p>F1 F2 F3 F4 F5 F6 F7 F8 // 第一块</p>
<p>F9 07 07 07 07 07 07 07 // 第二块</p>
<h3 id="-292"><a class="markdownIt-Anchor" href="#-292">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-crypto.html#%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86%E5%BA%94%E7%94%A8">#</a>对称加密应用</h3>
<h4 id="-293"><a class="markdownIt-Anchor" href="#-293">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-crypto.html#%E5%9F%BA%E4%BA%8E%E5%AF%86%E9%92%A5%E5%8A%A0%E5%AF%86%E7%9A%84%E6%B5%81%E7%A8%8B-des%E3%80%81desede%E3%80%81aes-%E5%92%8C-idea">#</a>基于密钥加密的流程（DES、DESede、AES 和 IDEA）</h4>
<p>DES、DESede、AES 和 IDEA 等算法都是基于密钥加密的对称加密算法，它们的实现流程也基本一致。步骤如下：</p>
<p>（1）生成密钥</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">KeyGenerator</span> kg <span class="token operator">=</span> <span class="token class-name">KeyGenerator</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">"DES"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">SecureRandom</span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SecureRandom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
kg<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>random<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">SecretKey</span> secretKey <span class="token operator">=</span> kg<span class="token punctuation">.</span><span class="token function">generateKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>建议使用随机数来初始化密钥的生成。</p>
<p>（2）初始化密码对象</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Cipher</span> cipher <span class="token operator">=</span> <span class="token class-name">Cipher</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">"DES/ECB/PKCS5Padding"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
cipher<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">Cipher</span><span class="token punctuation">.</span>ENCRYPT_MODE<span class="token punctuation">,</span> secretKey<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><code>ENCRYPT_MODE</code> ：加密模式</p>
<p><code>DECRYPT_MODE</code> ：解密模式</p>
<p>（3）执行</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">String plaintext = "Hello World";
byte[] ciphertext = cipher.doFinal(plaintext.getBytes());<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>一个完整的 DES 加密解密范例</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>charset<span class="token punctuation">.</span></span><span class="token class-name">StandardCharsets</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Base64</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>spec<span class="token punctuation">.</span></span><span class="token class-name">IvParameterSpec</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * DES安全编码：是经典的对称加密算法。密钥仅56位，且迭代次数偏少。已被视为并不安全的加密算法。
 *
 * @author Zhang Peng
 * @since 2016年7月14日
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DESCoder</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> KEY_ALGORITHM_DES <span class="token operator">=</span> <span class="token string">"DES"</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> CIPHER_DES_DEFAULT <span class="token operator">=</span> <span class="token string">"DES"</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> CIPHER_DES_ECB_PKCS5PADDING <span class="token operator">=</span> <span class="token string">"DES/ECB/PKCS5Padding"</span><span class="token punctuation">;</span> <span class="token comment">// 算法/模式/补码方式</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> CIPHER_DES_CBC_PKCS5PADDING <span class="token operator">=</span> <span class="token string">"DES/CBC/PKCS5Padding"</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> CIPHER_DES_CBC_NOPADDING <span class="token operator">=</span> <span class="token string">"DES/CBC/NoPadding"</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> SEED <span class="token operator">=</span> <span class="token string">"%%%today is nice***"</span><span class="token punctuation">;</span> <span class="token comment">// 用于生成随机数的种子</span>

    <span class="token keyword">private</span> <span class="token class-name">Key</span> key<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Cipher</span> cipher<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> transformation<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">DESCoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NoSuchAlgorithmException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchPaddingException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchProviderException</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> <span class="token function">initKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>cipher <span class="token operator">=</span> <span class="token class-name">Cipher</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>CIPHER_DES_DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>transformation <span class="token operator">=</span> CIPHER_DES_DEFAULT<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * 根据随机数种子生成一个密钥
     *
     * @return Key
     * @throws NoSuchAlgorithmException
     * @throws NoSuchProviderException
     * @author Zhang Peng
     * @since 2016年7月14日
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Key</span> <span class="token function">initKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NoSuchAlgorithmException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchProviderException</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 根据种子生成一个安全的随机数</span>
        <span class="token class-name">SecureRandom</span> secureRandom <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        secureRandom <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SecureRandom</span><span class="token punctuation">(</span>SEED<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">KeyGenerator</span> keyGen <span class="token operator">=</span> <span class="token class-name">KeyGenerator</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>KEY_ALGORITHM_DES<span class="token punctuation">)</span><span class="token punctuation">;</span>
        keyGen<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>secureRandom<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> keyGen<span class="token punctuation">.</span><span class="token function">generateKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">DESCoder</span><span class="token punctuation">(</span><span class="token class-name">String</span> transformation<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">NoSuchAlgorithmException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchPaddingException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchProviderException</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> <span class="token function">initKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>cipher <span class="token operator">=</span> <span class="token class-name">Cipher</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>transformation<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>transformation <span class="token operator">=</span> transformation<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * 加密
     *
     * @param input 明文
     * @return byte[] 密文
     * @throws InvalidKeyException
     * @throws IllegalBlockSizeException
     * @throws BadPaddingException
     * @throws InvalidAlgorithmParameterException
     * @author Zhang Peng
     * @since 2016年7月20日
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">encrypt</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> input<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InvalidKeyException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalBlockSizeException</span><span class="token punctuation">,</span> <span class="token class-name">BadPaddingException</span><span class="token punctuation">,</span>
        <span class="token class-name">InvalidAlgorithmParameterException</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>transformation<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>CIPHER_DES_CBC_PKCS5PADDING<span class="token punctuation">)</span> <span class="token operator">||</span> transformation<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>CIPHER_DES_CBC_NOPADDING<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            cipher<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">Cipher</span><span class="token punctuation">.</span>ENCRYPT_MODE<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">IvParameterSpec</span><span class="token punctuation">(</span><span class="token function">getIV</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            cipher<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">Cipher</span><span class="token punctuation">.</span>ENCRYPT_MODE<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> cipher<span class="token punctuation">.</span><span class="token function">doFinal</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * 解密
     *
     * @param input 密文
     * @return byte[] 明文
     * @throws InvalidKeyException
     * @throws IllegalBlockSizeException
     * @throws BadPaddingException
     * @throws InvalidAlgorithmParameterException
     * @author Zhang Peng
     * @since 2016年7月20日
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">decrypt</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> input<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InvalidKeyException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalBlockSizeException</span><span class="token punctuation">,</span> <span class="token class-name">BadPaddingException</span><span class="token punctuation">,</span>
        <span class="token class-name">InvalidAlgorithmParameterException</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>transformation<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>CIPHER_DES_CBC_PKCS5PADDING<span class="token punctuation">)</span> <span class="token operator">||</span> transformation<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>CIPHER_DES_CBC_NOPADDING<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            cipher<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">Cipher</span><span class="token punctuation">.</span>DECRYPT_MODE<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">IvParameterSpec</span><span class="token punctuation">(</span><span class="token function">getIV</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            cipher<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">Cipher</span><span class="token punctuation">.</span>DECRYPT_MODE<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> cipher<span class="token punctuation">.</span><span class="token function">doFinal</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getIV</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> iv <span class="token operator">=</span> <span class="token string">"01234567"</span><span class="token punctuation">;</span> <span class="token comment">// IV length: must be 8 bytes long</span>
        <span class="token keyword">return</span> iv<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">DESCoder</span> aes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DESCoder</span><span class="token punctuation">(</span>CIPHER_DES_CBC_PKCS5PADDING<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token string">"Hello World!"</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"原文: "</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> encoded <span class="token operator">=</span> aes<span class="token punctuation">.</span><span class="token function">encrypt</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> encodedBase64 <span class="token operator">=</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getUrlEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encodeToString</span><span class="token punctuation">(</span>encoded<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"密文: "</span> <span class="token operator">+</span> encodedBase64<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> decodedBase64 <span class="token operator">=</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getUrlDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>encodedBase64<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> decoded <span class="token operator">=</span> aes<span class="token punctuation">.</span><span class="token function">decrypt</span><span class="token punctuation">(</span>decodedBase64<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"明文: "</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>decoded<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>输出</strong></p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">原文: Hello World!
密文: TtnEu9ezNQtxFKpmq_37Qw==
明文: Hello World!<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="-294"><a class="markdownIt-Anchor" href="#-294">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-crypto.html#%E5%9F%BA%E4%BA%8E%E5%8F%A3%E4%BB%A4%E5%8A%A0%E5%AF%86%E7%9A%84%E6%B5%81%E7%A8%8B-pbe">#</a>基于口令加密的流程（PBE）</h4>
<p>DES、DESede、AES、IDEA 这几种算法的应用模型几乎如出一辙。</p>
<p>但是，并非所有对称加密算法都是如此。</p>
<p>基于口令加密 (Password Based Encryption, PBE) 是一种基于口令加密的算法。其特点是：口令由用户自己掌管，采用随机数（这里叫做盐）杂凑多重加密等方法保证数据的安全性。</p>
<p>PBE 没有密钥概念，密钥在其他对称加密算法中是经过计算得出的，PBE 则使用口令替代了密钥。</p>
<p>流程：</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/cs/java/advanced/password-based-encryption-progress.png" alt="img"></p>
<p>步骤如下：</p>
<p><strong>（1）产生盐</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">SecureRandom</span> secureRandom <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SecureRandom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> salt <span class="token operator">=</span> secureRandom<span class="token punctuation">.</span><span class="token function">generateSeed</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 盐长度必须为8字节</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><strong>（2）根据密码产生 Key</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">String</span> password <span class="token operator">=</span> <span class="token string">"123456"</span><span class="token punctuation">;</span>
<span class="token class-name">PBEKeySpec</span> keySpec <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PBEKeySpec</span><span class="token punctuation">(</span>password<span class="token punctuation">.</span><span class="token function">toCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">SecretKeyFactory</span> keyFactory <span class="token operator">=</span> <span class="token class-name">SecretKeyFactory</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>KEY_ALGORITHM<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">SecretKey</span> secretKey <span class="token operator">=</span> keyFactory<span class="token punctuation">.</span><span class="token function">generateSecret</span><span class="token punctuation">(</span>keySpec<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>（3）初始化加密或解密对象</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">PBEParameterSpec</span> paramSpec <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PBEParameterSpec</span><span class="token punctuation">(</span>salt<span class="token punctuation">,</span> ITERATION_COUNT<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Cipher</span> cipher <span class="token operator">=</span> <span class="token class-name">Cipher</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>KEY_ALGORITHM<span class="token punctuation">)</span><span class="token punctuation">;</span>
cipher<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">Cipher</span><span class="token punctuation">.</span>ENCRYPT_MODE<span class="token punctuation">,</span> secretKey<span class="token punctuation">,</span> paramSpec<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><strong>（4）执行</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> plaintext <span class="token operator">=</span> <span class="token string">"Hello World"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ciphertext <span class="token operator">=</span> cipher<span class="token punctuation">.</span><span class="token function">doFinal</span><span class="token punctuation">(</span>plaintext<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>（5）完整 PBE 示例</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span><span class="token class-name">Key</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span><span class="token class-name">SecureRandom</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Base64</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span></span><span class="token class-name">Cipher</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span></span><span class="token class-name">SecretKey</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span></span><span class="token class-name">SecretKeyFactory</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>spec<span class="token punctuation">.</span></span><span class="token class-name">PBEKeySpec</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>spec<span class="token punctuation">.</span></span><span class="token class-name">PBEParameterSpec</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 基于口令加密(Password Based Encryption, PBE)，是一种对称加密算法。 其特点是：口令由用户自己掌管，采用随机数（这里叫做盐）杂凑多重加密等方法保证数据的安全性。
 * PBE没有密钥概念，密钥在其他对称加密算法中是经过计算得出的，PBE则使用口令替代了密钥。
 *
 * @author Zhang Peng
 * @since 2016年7月20日
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PBECoder</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> KEY_ALGORITHM <span class="token operator">=</span> <span class="token string">"PBEWITHMD5andDES"</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> ITERATION_COUNT <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Key</span> key<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> salt<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">PBECoder</span><span class="token punctuation">(</span><span class="token class-name">String</span> password<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>salt <span class="token operator">=</span> <span class="token function">initSalt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> <span class="token function">initKey</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">initSalt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">SecureRandom</span> secureRandom <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SecureRandom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> secureRandom<span class="token punctuation">.</span><span class="token function">generateSeed</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 盐长度必须为8字节</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token class-name">Key</span> <span class="token function">initKey</span><span class="token punctuation">(</span><span class="token class-name">String</span> password<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">PBEKeySpec</span> keySpec <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PBEKeySpec</span><span class="token punctuation">(</span>password<span class="token punctuation">.</span><span class="token function">toCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SecretKeyFactory</span> keyFactory <span class="token operator">=</span> <span class="token class-name">SecretKeyFactory</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>KEY_ALGORITHM<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> keyFactory<span class="token punctuation">.</span><span class="token function">generateSecret</span><span class="token punctuation">(</span>keySpec<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">encrypt</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> plaintext<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">PBEParameterSpec</span> paramSpec <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PBEParameterSpec</span><span class="token punctuation">(</span>salt<span class="token punctuation">,</span> ITERATION_COUNT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Cipher</span> cipher <span class="token operator">=</span> <span class="token class-name">Cipher</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>KEY_ALGORITHM<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cipher<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">Cipher</span><span class="token punctuation">.</span>ENCRYPT_MODE<span class="token punctuation">,</span> key<span class="token punctuation">,</span> paramSpec<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> cipher<span class="token punctuation">.</span><span class="token function">doFinal</span><span class="token punctuation">(</span>plaintext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">decrypt</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ciphertext<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">PBEParameterSpec</span> paramSpec <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PBEParameterSpec</span><span class="token punctuation">(</span>salt<span class="token punctuation">,</span> ITERATION_COUNT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Cipher</span> cipher <span class="token operator">=</span> <span class="token class-name">Cipher</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>KEY_ALGORITHM<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cipher<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">Cipher</span><span class="token punctuation">.</span>DECRYPT_MODE<span class="token punctuation">,</span> key<span class="token punctuation">,</span> paramSpec<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> cipher<span class="token punctuation">.</span><span class="token function">doFinal</span><span class="token punctuation">(</span>ciphertext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>

        <span class="token comment">// 产生盐</span>
        <span class="token class-name">SecureRandom</span> secureRandom <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SecureRandom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> salt <span class="token operator">=</span> secureRandom<span class="token punctuation">.</span><span class="token function">generateSeed</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 盐长度必须为8字节</span>

        <span class="token comment">// 产生Key</span>
        <span class="token class-name">String</span> password <span class="token operator">=</span> <span class="token string">"123456"</span><span class="token punctuation">;</span>
        <span class="token class-name">PBEKeySpec</span> keySpec <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PBEKeySpec</span><span class="token punctuation">(</span>password<span class="token punctuation">.</span><span class="token function">toCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SecretKeyFactory</span> keyFactory <span class="token operator">=</span> <span class="token class-name">SecretKeyFactory</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>KEY_ALGORITHM<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SecretKey</span> secretKey <span class="token operator">=</span> keyFactory<span class="token punctuation">.</span><span class="token function">generateSecret</span><span class="token punctuation">(</span>keySpec<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">PBEParameterSpec</span> paramSpec <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PBEParameterSpec</span><span class="token punctuation">(</span>salt<span class="token punctuation">,</span> ITERATION_COUNT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Cipher</span> cipher <span class="token operator">=</span> <span class="token class-name">Cipher</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>KEY_ALGORITHM<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cipher<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">Cipher</span><span class="token punctuation">.</span>ENCRYPT_MODE<span class="token punctuation">,</span> secretKey<span class="token punctuation">,</span> paramSpec<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> plaintext <span class="token operator">=</span> <span class="token string">"Hello World"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ciphertext <span class="token operator">=</span> cipher<span class="token punctuation">.</span><span class="token function">doFinal</span><span class="token punctuation">(</span>plaintext<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>ciphertext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">PBECoder</span> encode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PBECoder</span><span class="token punctuation">(</span><span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token string">"Hello World!"</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ciphertext <span class="token operator">=</span> encode<span class="token punctuation">.</span><span class="token function">encrypt</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> plaintext <span class="token operator">=</span> encode<span class="token punctuation">.</span><span class="token function">decrypt</span><span class="token punctuation">(</span>ciphertext<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"原文："</span> <span class="token operator">+</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"密文："</span> <span class="token operator">+</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getUrlEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encodeToString</span><span class="token punctuation">(</span>ciphertext<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"明文："</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>plaintext<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="-295"><a class="markdownIt-Anchor" href="#-295">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-crypto.html#%E4%BA%94%E3%80%81%E9%9D%9E%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86">#</a>五、非对称加密</h2>
<h3 id="-296"><a class="markdownIt-Anchor" href="#-296">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-crypto.html#%E9%9D%9E%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86%E6%A6%82%E8%BF%B0">#</a>非对称加密概述</h3>
<p>非对称加密常用算法：DH (Diffie-Hellman，密钥交换算法)、RSA</p>
<p>非对称加密算法和对称加密算法的主要差别在于非对称加密算法用于加密和解密的密钥是不同的。一个公开，称为公钥（public key）；一个保密，称为私钥（private key）。因此，非对称加密算法也称为双钥加密算法或公钥加密算法。</p>
<p>非对称加密特点：</p>
<ul>
<li>优点：非对称加密算法解决了对称加密算法的密钥分配问题，并极大地提高了算法安全性。</li>
<li>缺点：算法比对称算法更复杂，因此加密、解密速度都比对称算法慢很多。</li>
</ul>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/asymmetric-encryption.png" alt="img"></p>
<p>非对称加密算法实现机密信息交换的基本过程是：甲方生成一对密钥并将其中的一把作为公用密钥向其它方公开；得到该公用密钥的乙方使用该密钥对机密信息进行加密后再发送给甲方；甲方再用自己保存的另一把专用密钥对加密后的信息进行解密。</p>
<p>另一方面，甲方可以使用乙方的公钥对机密信息进行签名后再发送给乙方；乙方再用自己的私匙对数据进行验证。</p>
<p>甲方只能用其私钥解密，由其公钥加密后的任何信息。 非对称加密算法的保密性比较好，它消除了最终用户交换密钥的需要。</p>
<h3 id="-297"><a class="markdownIt-Anchor" href="#-297">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-crypto.html#%E9%9D%9E%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95%E5%BA%94%E7%94%A8">#</a>非对称加密算法应用</h3>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>charset<span class="token punctuation">.</span></span><span class="token class-name">StandardCharsets</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span>spec<span class="token punctuation">.</span></span><span class="token class-name">PKCS8EncodedKeySpec</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span>spec<span class="token punctuation">.</span></span><span class="token class-name">X509EncodedKeySpec</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Base64</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span></span><span class="token class-name">Cipher</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * RSA安全编码：非对称加密算法。它既可以用来加密、解密，也可以用来做数字签名
 *
 * @author Zhang Peng
 * @since 2016年7月20日
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RSACoder</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> KEY_ALGORITHM <span class="token operator">=</span> <span class="token string">"RSA"</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> SIGN_ALGORITHM <span class="token operator">=</span> <span class="token string">"MD5WithRSA"</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">KeyPair</span> keyPair<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">RSACoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>keyPair <span class="token operator">=</span> <span class="token function">initKeyPair</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token class-name">KeyPair</span> <span class="token function">initKeyPair</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// KeyPairGenerator类用于生成公钥和私钥对，基于RSA算法生成对象</span>
        <span class="token class-name">KeyPairGenerator</span> keyPairGen <span class="token operator">=</span> <span class="token class-name">KeyPairGenerator</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>KEY_ALGORITHM<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 初始化密钥对生成器，密钥大小为1024位</span>
        keyPairGen<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 生成一个密钥对</span>
        <span class="token keyword">return</span> keyPairGen<span class="token punctuation">.</span><span class="token function">genKeyPair</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">encryptByPrivateKey</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> plaintext<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> key<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">PKCS8EncodedKeySpec</span> keySpec <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PKCS8EncodedKeySpec</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">KeyFactory</span> keyFactory <span class="token operator">=</span> <span class="token class-name">KeyFactory</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>KEY_ALGORITHM<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PrivateKey</span> privateKey <span class="token operator">=</span> keyFactory<span class="token punctuation">.</span><span class="token function">generatePrivate</span><span class="token punctuation">(</span>keySpec<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Cipher</span> cipher <span class="token operator">=</span> <span class="token class-name">Cipher</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>keyFactory<span class="token punctuation">.</span><span class="token function">getAlgorithm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cipher<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">Cipher</span><span class="token punctuation">.</span>ENCRYPT_MODE<span class="token punctuation">,</span> privateKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> cipher<span class="token punctuation">.</span><span class="token function">doFinal</span><span class="token punctuation">(</span>plaintext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">decryptByPublicKey</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ciphertext<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> key<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">X509EncodedKeySpec</span> keySpec <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">X509EncodedKeySpec</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">KeyFactory</span> keyFactory <span class="token operator">=</span> <span class="token class-name">KeyFactory</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>KEY_ALGORITHM<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PublicKey</span> publicKey <span class="token operator">=</span> keyFactory<span class="token punctuation">.</span><span class="token function">generatePublic</span><span class="token punctuation">(</span>keySpec<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Cipher</span> cipher <span class="token operator">=</span> <span class="token class-name">Cipher</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>keyFactory<span class="token punctuation">.</span><span class="token function">getAlgorithm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cipher<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">Cipher</span><span class="token punctuation">.</span>DECRYPT_MODE<span class="token punctuation">,</span> publicKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> cipher<span class="token punctuation">.</span><span class="token function">doFinal</span><span class="token punctuation">(</span>ciphertext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">encryptByPublicKey</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> plaintext<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> key<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">X509EncodedKeySpec</span> keySpec <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">X509EncodedKeySpec</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">KeyFactory</span> keyFactory <span class="token operator">=</span> <span class="token class-name">KeyFactory</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>KEY_ALGORITHM<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PublicKey</span> publicKey <span class="token operator">=</span> keyFactory<span class="token punctuation">.</span><span class="token function">generatePublic</span><span class="token punctuation">(</span>keySpec<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Cipher</span> cipher <span class="token operator">=</span> <span class="token class-name">Cipher</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>keyFactory<span class="token punctuation">.</span><span class="token function">getAlgorithm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cipher<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">Cipher</span><span class="token punctuation">.</span>ENCRYPT_MODE<span class="token punctuation">,</span> publicKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> cipher<span class="token punctuation">.</span><span class="token function">doFinal</span><span class="token punctuation">(</span>plaintext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">decryptByPrivateKey</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ciphertext<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> key<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">PKCS8EncodedKeySpec</span> keySpec <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PKCS8EncodedKeySpec</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">KeyFactory</span> keyFactory <span class="token operator">=</span> <span class="token class-name">KeyFactory</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>KEY_ALGORITHM<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PrivateKey</span> privateKey <span class="token operator">=</span> keyFactory<span class="token punctuation">.</span><span class="token function">generatePrivate</span><span class="token punctuation">(</span>keySpec<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Cipher</span> cipher <span class="token operator">=</span> <span class="token class-name">Cipher</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>keyFactory<span class="token punctuation">.</span><span class="token function">getAlgorithm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cipher<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">Cipher</span><span class="token punctuation">.</span>DECRYPT_MODE<span class="token punctuation">,</span> privateKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> cipher<span class="token punctuation">.</span><span class="token function">doFinal</span><span class="token punctuation">(</span>ciphertext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">signature</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> privateKey<span class="token punctuation">,</span> <span class="token class-name">RsaSignTypeEn</span> type<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">PKCS8EncodedKeySpec</span> keySpec <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PKCS8EncodedKeySpec</span><span class="token punctuation">(</span>privateKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">KeyFactory</span> keyFactory <span class="token operator">=</span> <span class="token class-name">KeyFactory</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>KEY_ALGORITHM<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PrivateKey</span> key <span class="token operator">=</span> keyFactory<span class="token punctuation">.</span><span class="token function">generatePrivate</span><span class="token punctuation">(</span>keySpec<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Signature</span> signature <span class="token operator">=</span> <span class="token class-name">Signature</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>type<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        signature<span class="token punctuation">.</span><span class="token function">initSign</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        signature<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> signature<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getPrivateKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> keyPair<span class="token punctuation">.</span><span class="token function">getPrivate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEncoded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">verify</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> publicKey<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> sign<span class="token punctuation">,</span> <span class="token class-name">RsaSignTypeEn</span> type<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">X509EncodedKeySpec</span> keySpec <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">X509EncodedKeySpec</span><span class="token punctuation">(</span>publicKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">KeyFactory</span> keyFactory <span class="token operator">=</span> <span class="token class-name">KeyFactory</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>KEY_ALGORITHM<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PublicKey</span> key <span class="token operator">=</span> keyFactory<span class="token punctuation">.</span><span class="token function">generatePublic</span><span class="token punctuation">(</span>keySpec<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Signature</span> signature <span class="token operator">=</span> <span class="token class-name">Signature</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>type<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        signature<span class="token punctuation">.</span><span class="token function">initVerify</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        signature<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> signature<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>sign<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getPublicKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> keyPair<span class="token punctuation">.</span><span class="token function">getPublic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEncoded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">RsaSignTypeEn</span> <span class="token punctuation">&#123;</span>

        <span class="token class-name">MD2WithRSA</span><span class="token punctuation">,</span>
        <span class="token class-name">MD5WithRSA</span><span class="token punctuation">,</span>
        <span class="token class-name">SHA1WithRSA</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token string">"Hello World!"</span><span class="token punctuation">;</span>
        <span class="token class-name">RSACoder</span> coder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RSACoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 私钥加密，公钥解密</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ciphertext <span class="token operator">=</span> coder<span class="token punctuation">.</span><span class="token function">encryptByPrivateKey</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">,</span> coder<span class="token punctuation">.</span>keyPair<span class="token punctuation">.</span><span class="token function">getPrivate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEncoded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> plaintext <span class="token operator">=</span> coder<span class="token punctuation">.</span><span class="token function">decryptByPublicKey</span><span class="token punctuation">(</span>ciphertext<span class="token punctuation">,</span> coder<span class="token punctuation">.</span>keyPair<span class="token punctuation">.</span><span class="token function">getPublic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEncoded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 公钥加密，私钥解密</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ciphertext2 <span class="token operator">=</span> coder<span class="token punctuation">.</span><span class="token function">encryptByPublicKey</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> coder<span class="token punctuation">.</span>keyPair<span class="token punctuation">.</span><span class="token function">getPublic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEncoded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> plaintext2 <span class="token operator">=</span> coder<span class="token punctuation">.</span><span class="token function">decryptByPrivateKey</span><span class="token punctuation">(</span>ciphertext2<span class="token punctuation">,</span> coder<span class="token punctuation">.</span>keyPair<span class="token punctuation">.</span><span class="token function">getPrivate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEncoded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> sign <span class="token operator">=</span> coder<span class="token punctuation">.</span><span class="token function">signature</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> coder<span class="token punctuation">.</span><span class="token function">getPrivateKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">RsaSignTypeEn<span class="token punctuation">.</span>SHA1WithRSA</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> flag <span class="token operator">=</span> coder<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> coder<span class="token punctuation">.</span><span class="token function">getPublicKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sign<span class="token punctuation">,</span> <span class="token class-name">RsaSignTypeEn<span class="token punctuation">.</span>SHA1WithRSA</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> result <span class="token operator">=</span> flag <span class="token operator">?</span> <span class="token string">"数字签名匹配"</span> <span class="token operator">:</span> <span class="token string">"数字签名不匹配"</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"原文："</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"公钥："</span> <span class="token operator">+</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getUrlEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encodeToString</span><span class="token punctuation">(</span>coder<span class="token punctuation">.</span>keyPair<span class="token punctuation">.</span><span class="token function">getPublic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEncoded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"私钥："</span> <span class="token operator">+</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getUrlEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encodeToString</span><span class="token punctuation">(</span>coder<span class="token punctuation">.</span>keyPair<span class="token punctuation">.</span><span class="token function">getPrivate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEncoded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"============== 私钥加密，公钥解密 =============="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"密文："</span> <span class="token operator">+</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getUrlEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encodeToString</span><span class="token punctuation">(</span>ciphertext<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"明文："</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>plaintext<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"============== 公钥加密，私钥解密 =============="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"密文："</span> <span class="token operator">+</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getUrlEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encodeToString</span><span class="token punctuation">(</span>ciphertext2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"明文："</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>plaintext2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"============== 数字签名 =============="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"数字签名："</span> <span class="token operator">+</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getUrlEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encodeToString</span><span class="token punctuation">(</span>sign<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"验证结果："</span> <span class="token operator">+</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>输出</strong></p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">原文：Hello World!
公钥：MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCzPtRLErTUcYtr8GmIpvbso7FN18thuEq02U21mh7TA4FH4TjvNgOZrZEORYu94dxrPdnrPjh0p62P5pDIjx_dtGlZr0aGWgtTvBbPwAKE4keXyPqv4VV6iXRzyQ2HdOvFOovim5eu0Tu_TxGeNpFfp0pYj2LXCzpsgSrdUPuPmwIDAQAB
私钥：MIICdwIBADANBgkqhkiG9w0BAQEFAASCAmEwggJdAgEAAoGBALM-1EsStNRxi2vwaYim9uyjsU3Xy2G4SrTZTbWaHtMDgUfhOO82A5mtkQ5Fi73h3Gs92es-OHSnrY_mkMiPH920aVmvRoZaC1O8Fs_AAoTiR5fI-q_hVXqJdHPJDYd068U6i-Kbl67RO79PEZ42kV-nSliPYtcLOmyBKt1Q-4-bAgMBAAECgYBJxOXiL8S0WjajKcKFNxIQuh3Sh6lwgkRcwcI1p0RgW-TtDEg-SuCYctJsKTsl3rq0eDQjmOvrNsc7ngygPidCiTdbD1H6m3tLrebBB-wZdXMSWPsHtQJsq4dE0e93mmfysciOP6QExOs0JqVjTyyBSK37LpUcLdalj2IJDtC0gQJBAPfMngZAuIPmXued7PUuWNBuwxnkmdMcs308eC_9vnLLXWhDB9xKMuXCMwqk16MJ6j1FQWtJu62T21yniWWQHIsCQQC5LWqKfRxVukgnBg0Pa95NVWWY01Yttnb125JsLxeKbR97KU4VgBaBcB9TyUdPr9lxAzGFg6Y3A1wfsfukaGsxAkEA1l719oLXHYSWZdmBvTozK14m-qeBS9lwjc9aSmpB8B1u2Vvj2Pd3wLyYW4Tv5-QT-J2JUr-e1TMseqOVgX-CsQJAETRoBq_zFv_0vjNwuTMTd2nsw5M3GY4vZU5eP1Dsxf63gxDmYVcCQEpzjqxPxNaYxEhArJ_7rHbSc1ts_ux4sQJBAIlbGQC4-92foXGzWT80rsqZlMQ8J8Nbjpoo7RUN9tgx60Vkr3xv26Vos77oqdufWlt5IiBZBS9acTA2suav6Qg=
============== 私钥加密，公钥解密 ==============
密文：qn6iGjSJV45EnH21RYRx2UZfMueqplbm1g3VIpBBQBuF63RdHdSgMJsVPAuB__V0rxpPlU3gR6qLyWu1mpaJ-ix_6KogAH64wqTWqPRh7E6aj767rybNpt9JyVlCmmpy9DiqHAUFWtBJDo34q-a7Fhq9c8bWrJ6jnn47IdmzHfU=
明文：Hello World!
============== 公钥加密，私钥解密 ==============
密文：fsz2IFs69d7JDrH-yoe5pi5WKQU1Zml7SDSpPqTZUn6muSCjNp6x312deQCXKMGSeAdMpVeb01yZBfa0MT_6eYJYVseU7Rd6bDf6YIg3AZFC41yh5ITiTvQ-XzxugnppS12sLpXSWg0faa5qjcVZnoTX9p7nHr8n20y4CNMI6Rw=
明文：Hello World!
============== 数字签名 ==============
数字签名：dTtUUlWX1wRQbW1PcA8O6WJcWcrHinEZRXwgLKEwBOm2DpvHnynvV_HYKS-qFE5_4vJQcPGJ2hZqWbfv1VKLHMUWuiXM7VJk70g3g7BF8i8RWbrCDOxgTR77jrEwidpr1PYJzWJVGq_HP36MxInGFLcVh2sN0fu8MppzsXUENZQ=
验证结果：数字签名匹配<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="-298"><a class="markdownIt-Anchor" href="#-298">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-crypto.html#%E5%85%AD%E3%80%81%E6%9C%AF%E8%AF%AD">#</a>六、术语</h2>
<ul>
<li><strong>明文 (Plaintext)</strong>：指待加密信息。明文可以是文本文件、图片文件、二进制数据等。</li>
<li><strong>密文 (Ciphertext)</strong>：指经过加密后的明文。密文通常以文本、二进制等形式存在。</li>
<li><strong>加密 (Encryption)</strong>：指将明文转换为密文的过程。</li>
<li><strong>解密 (Decryption)</strong>：指将密文转换为明文的过程。</li>
<li><strong>加密密钥 (Encryption Key)</strong>：指通过加密算法进行加密操作用的密钥。</li>
<li><strong>解密密钥 (Decryption Key)</strong>：指通过解密算法进行解密操作用的密钥。</li>
<li><strong>信道 (Channel)</strong>：通信的通道，是信号传输的媒介。</li>
</ul>
<hr>
<h1 id="java-本地化"><a class="markdownIt-Anchor" href="#java-本地化">#</a> Java 本地化</h1>
<blockquote>
<p><strong>📦 本文以及示例源码已归档在 <a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/">javacore(opens new window)</a></strong></p>
</blockquote>
<h2 id="-299"><a class="markdownIt-Anchor" href="#-299">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-locale.html#%E8%83%8C%E6%99%AF%E7%9F%A5%E8%AF%86">#</a>背景知识</h2>
<p>通讯的发达，使得世界各地交流越来越紧密。许多的软件产品也要面向世界上不同国家的用户。其中，语言障碍显然是产品在不同语种用户中进行推广的一个重要问题。</p>
<p>本文围绕本地化这一主题，先介绍国际标准的语言编码，然后讲解在 Java 应用中如何去实现本地化。</p>
<h3 id="-300"><a class="markdownIt-Anchor" href="#-300">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-locale.html#%E8%AF%AD%E8%A8%80%E7%BC%96%E7%A0%81%E3%80%81%E5%9B%BD%E5%AE%B6-%E5%9C%B0%E5%8C%BA%E7%BC%96%E7%A0%81">#</a>语言编码、国家 / 地区编码</h3>
<p>做 web 开发的朋友可能多多少少接触过类似 <strong>zh-cn</strong>, <strong>en-us</strong> 这样的编码字样。</p>
<p>这些编码是用来表示指定的国家地区的语言类型的。那么，这些含有特殊含义的编码是如何产生的呢？</p>
<p><a target="_blank" rel="noopener" href="http://www.loc.gov/standards/iso639-2/php/English_list.php"><strong>ISO-639</strong> (opens new window)</a> 标准使用编码定义了国际上常见的语言，每一种语言由两个小写字母表示。</p>
<p><a target="_blank" rel="noopener" href="https://www.iso.org/obp/ui/#iso:std:iso:3166:-2:ed-3:v1:en,fr"><strong>ISO-3166</strong> (opens new window)</a> 标准使用编码定义了国家 / 地区，每个国家 / 地区由两个大写字母表示。</p>
<p>下表列举了一些常见国家、地区的语言编码：</p>
<table>
<thead>
<tr>
<th>国家 / 地区</th>
<th>语言编码</th>
<th>国家 / 地区</th>
<th>语言编码</th>
</tr>
</thead>
<tbody>
<tr>
<td>简体中文 (中国)</td>
<td>zh-cn</td>
<td>繁体中文 (台湾地区)</td>
<td>zh-tw</td>
</tr>
<tr>
<td>繁体中文 (香港)</td>
<td>zh-hk</td>
<td>英语 (香港)</td>
<td>en-hk</td>
</tr>
<tr>
<td>英语 (美国)</td>
<td>en-us</td>
<td>英语 (英国)</td>
<td>en-gb</td>
</tr>
<tr>
<td>英语 (全球)</td>
<td>en-ww</td>
<td>英语 (加拿大)</td>
<td>en-ca</td>
</tr>
<tr>
<td>英语 (澳大利亚)</td>
<td>en-au</td>
<td>英语 (爱尔兰)</td>
<td>en-ie</td>
</tr>
<tr>
<td>英语 (芬兰)</td>
<td>en-fi</td>
<td>芬兰语 (芬兰)</td>
<td>fi-fi</td>
</tr>
<tr>
<td>英语 (丹麦)</td>
<td>en-dk</td>
<td>丹麦语 (丹麦)</td>
<td>da-dk</td>
</tr>
<tr>
<td>英语 (以色列)</td>
<td>en-il</td>
<td>希伯来语 (以色列)</td>
<td>he-il</td>
</tr>
<tr>
<td>英语 (南非)</td>
<td>en-za</td>
<td>英语 (印度)</td>
<td>en-in</td>
</tr>
<tr>
<td>英语 (挪威)</td>
<td>en-no</td>
<td>英语 (新加坡)</td>
<td>en-sg</td>
</tr>
<tr>
<td>英语 (新西兰)</td>
<td>en-nz</td>
<td>英语 (印度尼西亚)</td>
<td>en-id</td>
</tr>
<tr>
<td>英语 (菲律宾)</td>
<td>en-ph</td>
<td>英语 (泰国)</td>
<td>en-th</td>
</tr>
<tr>
<td>英语 (马来西亚)</td>
<td>en-my</td>
<td>英语 (阿拉伯)</td>
<td>en-xa</td>
</tr>
<tr>
<td>韩文 (韩国)</td>
<td>ko-kr</td>
<td>日语 (日本)</td>
<td>ja-jp</td>
</tr>
<tr>
<td>荷兰语 (荷兰)</td>
<td>nl-nl</td>
<td>荷兰语 (比利时)</td>
<td>nl-be</td>
</tr>
<tr>
<td>葡萄牙语 (葡萄牙)</td>
<td>pt-pt</td>
<td>葡萄牙语 (巴西)</td>
<td>pt-br</td>
</tr>
<tr>
<td>法语 (法国)</td>
<td>fr-fr</td>
<td>法语 (卢森堡)</td>
<td>fr-lu</td>
</tr>
<tr>
<td>法语 (瑞士)</td>
<td>fr-ch</td>
<td>法语 (比利时)</td>
<td>fr-be</td>
</tr>
<tr>
<td>法语 (加拿大)</td>
<td>fr-ca</td>
<td>西班牙语 (拉丁美洲)</td>
<td>es-la</td>
</tr>
<tr>
<td>西班牙语 (西班牙)</td>
<td>es-es</td>
<td>西班牙语 (阿根廷)</td>
<td>es-ar</td>
</tr>
<tr>
<td>西班牙语 (美国)</td>
<td>es-us</td>
<td>西班牙语 (墨西哥)</td>
<td>es-mx</td>
</tr>
<tr>
<td>西班牙语 (哥伦比亚)</td>
<td>es-co</td>
<td>西班牙语 (波多黎各)</td>
<td>es-pr</td>
</tr>
<tr>
<td>德语 (德国)</td>
<td>de-de</td>
<td>德语 (奥地利)</td>
<td>de-at</td>
</tr>
<tr>
<td>德语 (瑞士)</td>
<td>de-ch</td>
<td>俄语 (俄罗斯)</td>
<td>ru-ru</td>
</tr>
<tr>
<td>意大利语 (意大利)</td>
<td>it-it</td>
<td>希腊语 (希腊)</td>
<td>el-gr</td>
</tr>
<tr>
<td>挪威语 (挪威)</td>
<td>no-no</td>
<td>匈牙利语 (匈牙利)</td>
<td>hu-hu</td>
</tr>
<tr>
<td>土耳其语 (土耳其)</td>
<td>tr-tr</td>
<td>捷克语 (捷克共和国)</td>
<td>cs-cz</td>
</tr>
<tr>
<td>斯洛文尼亚语</td>
<td>sl-sl</td>
<td>波兰语 (波兰)</td>
<td>pl-pl</td>
</tr>
<tr>
<td>瑞典语 (瑞典)</td>
<td>sv-se</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p><strong>注：由表中可以看出语言、国家 / 地区编码一般都是英文单词的缩写。</strong></p>
<h3 id="-301"><a class="markdownIt-Anchor" href="#-301">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-locale.html#%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81">#</a>字符编码</h3>
<p>在此处，引申一下字符编码的概念。</p>
<p><strong>是不是有了语言、国家 / 地区编码，计算机就可以识别各种语言了？</strong></p>
<p>答案是否。作为程序员，相信每个人都会遇到过这样的情况：期望打印中文，结果输出的却是乱码。</p>
<p>这种情况，往往是因为字符编码的问题。</p>
<p>计算机在设计之初，并没有考虑多个国家，多种不同语言的应用场景。当时定义一种 <code>ASCII</code>  码，将字母、数字和其他符号编号用 7 比特的二进制数来表示。后来，计算机在世界开始普及，为了适应多种文字，出现了多种编码格式，例如中文汉字一般使用的编码格式为 <code>GB2312</code> 、 <code>GBK</code> 。</p>
<p>由此，又产生了一个问题，<strong>不同字符编码之间互相无法识别</strong>。于是，为了一统江湖，出现了  <code>unicode</code>  编码。它为每种语言的每个字符设定了统一并且唯一的二进制编码，以满足跨语言、跨平台的文本转换需求。</p>
<p>有人不禁要问，既然  <code>Unicode</code>  可以支持所有语言的字符，那还要其他字符编码做什么？</p>
<p><code>Unicode</code>  有一个缺点：为了支持所有语言的字符，所以它需要用更多位数去表示，比如  <code>ASCII</code>  表示一个英文字符只需要一个字节，而  <code>Unicode</code>  则需要两个字节。很明显，如果字符数多，这样的效率会很低。</p>
<p>为了解决这个问题，有出现了一些中间格式的字符编码：如  <code>UTF-8</code> 、 <code>UTF-16</code> 、 <code>UTF-32</code>  等（中国的程序员一般使用<strong> UTF-8</strong> 编码）。</p>
<h2 id="-302"><a class="markdownIt-Anchor" href="#-302">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-locale.html#java-%E4%B8%AD%E5%AE%9E%E7%8E%B0%E6%9C%AC%E5%9C%B0%E5%8C%96">#</a>Java 中实现本地化</h2>
<p>本地化的实现原理很简单：</p>
<ol>
<li>先定义好不同语种的模板；</li>
<li>选择语种；</li>
<li>加载指定语种的模板。</li>
</ol>
<p>接下来，本文会按照步骤逐一讲解实现本地化的具体步骤</p>
<h3 id="-303"><a class="markdownIt-Anchor" href="#-303">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-locale.html#%E5%AE%9A%E4%B9%89%E4%B8%8D%E5%90%8C%E8%AF%AD%E7%A7%8D%E7%9A%84%E6%A8%A1%E6%9D%BF">#</a>定义不同语种的模板</h3>
<p><strong>Java 中将多语言文本存储在格式为  <code>properties</code>  的资源文件中。</strong></p>
<p>它必须遵照以下的命名规范：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">&lt;资源名>_&lt;语言代码>_&lt;国家/地区编码>.properties<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>其中，语言编码和国家 / 地区编码都是可选的。</p>
<p>注： <code>&lt;资源名&gt;.properties</code>  命名的本地化资源文件是<strong>默认的资源文件</strong>，即某个本地化类型在系统中找不到对应的资源文件，就采用这个默认的资源文件。</p>
<h4 id="-304"><a class="markdownIt-Anchor" href="#-304">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-locale.html#%E5%AE%9A%E4%B9%89-properties-%E6%96%87%E4%BB%B6">#</a>定义 properties 文件</h4>
<p>在 <code>src/main/resources/locales</code>  路径下定义名为 content 的不同语种资源文件：</p>
<p><strong>content_en_US.properties</strong></p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">helloWorld = HelloWorld!
time = The current time is %s.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><strong>content_zh_CN.properties</strong></p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">helloWorld = \u4e16\u754c\uff0c\u4f60\u597d\uff01
time = \u5f53\u524d\u65f6\u95f4\u662f\u0025\u0073\u3002<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>可以看到：几个资源文件中，定义的 Key 完全一致，只是 Value 是对应语言的字符串。</p>
<p>虽然属性值各不相同，但属性名却是相同的，这样应用程序就可以通过 Locale 对象和属性名精确调用到某个具体的属性值了。</p>
<h4 id="-305"><a class="markdownIt-Anchor" href="#-305">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-locale.html#unicode-%E8%BD%AC%E6%8D%A2%E5%B7%A5%E5%85%B7">#</a>Unicode 转换工具</h4>
<p>上一节中，我们定义的中文资源文件中的属性值都是以 \u 开头的四位 16 进制数。其实，这表示的是一个 Unicode 编码。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">helloWorld = \u4e16\u754c\uff0c\u4f60\u597d\uff01
time = \u5f53\u524d\u65f6\u95f4\u662f\u0025\u0073\u3002<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>本文的字符编码中提到了，为了达到跨编码也正常显示的目的，有必要将非  <code>ASCII</code>  字符转为  <code>Unicode</code>  编码。上面的中文资源文件就是中文转为  <code>Unicode</code>  的结果。</p>
<p>怎么将非  <code>ASCII</code>  字符转为  <code>Unicode</code>  编码呢？</p>
<p>JDK 在 bin 目录下为我们提供了一个转换工具：<strong>native2ascii</strong>。</p>
<p>它可以将中文字符的资源文件转换为  <code>Unicode</code>  代码格式的文件，命令格式如下：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">native2ascii [-reverse] [-encoding 编码] [输入文件 [输出文件]]<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>假设<strong> content_zh_CN.properties</strong> 在  <code>d:\</code>  目录。执行以下命令可以新建一个名为 <strong>content_zh_CN_new.properties</strong> 的文件，其中的内容就中文字符转为  <code>UTF-8</code>  编码格式的结果。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">native2ascii -encoding utf-8 d:\content_zh_CN.properties d:\content_zh_CN_new.properties<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="-306"><a class="markdownIt-Anchor" href="#-306">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-locale.html#%E9%80%89%E6%8B%A9%E8%AF%AD%E7%A7%8D">#</a>选择语种</h3>
<p>定义了多语言资源文件，第二步就是根据本地语种选择模板文件了。</p>
<h4 id="-307"><a class="markdownIt-Anchor" href="#-307">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-locale.html#locale">#</a>Locale</h4>
<p>在 Java 中，一个  <code>java.util.Locale</code>  对象表示了特定的地理、政治和文化地区。需要 Locale 来执行其任务的操作称为语言环境敏感的操作，它使用 Locale 为用户量身定制本地信息。</p>
<p>它有三个构造方法</p>
<p><code>Locale(String language)</code>  ：根据语言编码初始化  <code>Locale(String language, String country)</code>  ：根据语言编码、国家编码初始化  <code>Locale(String language, String country, String variant)</code>  ：根据语言编码、国家编码、变体初始化</p>
<p>此外，Locale 定义了一些常用的 Locale 常量： <code>Locale.ENGLISH</code> 、 <code>Locale.CHINESE</code>  等。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 初始化一个通用英语的locale.</span>
<span class="token class-name">Locale</span> locale1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Locale</span><span class="token punctuation">(</span><span class="token string">"en"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 初始化一个加拿大英语的locale.</span>
<span class="token class-name">Locale</span> locale2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Locale</span><span class="token punctuation">(</span><span class="token string">"en"</span><span class="token punctuation">,</span> <span class="token string">"CA"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 初始化一个美式英语变种硅谷英语的locale</span>
<span class="token class-name">Locale</span> locale3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Locale</span><span class="token punctuation">(</span><span class="token string">"en"</span><span class="token punctuation">,</span> <span class="token string">"US"</span><span class="token punctuation">,</span> <span class="token string">"SiliconValley"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 根据Locale常量初始化一个简体中文</span>
<span class="token class-name">Locale</span> locale4 <span class="token operator">=</span> <span class="token class-name">Locale</span><span class="token punctuation">.</span>SIMPLIFIED_CHINESE<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-308"><a class="markdownIt-Anchor" href="#-308">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-locale.html#%E5%8A%A0%E8%BD%BD%E6%8C%87%E5%AE%9A%E8%AF%AD%E7%A7%8D%E7%9A%84%E6%A8%A1%E6%9D%BF">#</a>加载指定语种的模板</h3>
<h4 id="-309"><a class="markdownIt-Anchor" href="#-309">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-locale.html#resourceboundle">#</a>ResourceBoundle</h4>
<p>Java 为我们提供了用于加载本地化资源文件的工具类： <code>java.util.ResourceBoundle</code> 。</p>
<p><code>ResourceBoundle</code>  提供了多个名为  <code>getBundle</code>  的静态重载方法，这些方法的作用是用来根据资源名、Locale 选择指定语种的资源文件。需要说明的是：  <code>getBundle</code>  方法的第一个参数一般都是 <code>baseName</code>  ，这个参数表示资源文件名。</p>
<p><code>ResourceBoundle</code>  还提供了名为  <code>getString</code>  的方法，用来获取资源文件中 key 对应的 value。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 根据语言+地区编码初始化</span>
    <span class="token class-name">ResourceBundle</span> rbUS <span class="token operator">=</span> <span class="token class-name">ResourceBundle</span><span class="token punctuation">.</span><span class="token function">getBundle</span><span class="token punctuation">(</span><span class="token string">"locales.content"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Locale</span><span class="token punctuation">(</span><span class="token string">"en"</span><span class="token punctuation">,</span> <span class="token string">"US"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 根据Locale常量初始化</span>
    <span class="token class-name">ResourceBundle</span> rbZhCN <span class="token operator">=</span> <span class="token class-name">ResourceBundle</span><span class="token punctuation">.</span><span class="token function">getBundle</span><span class="token punctuation">(</span><span class="token string">"locales.content"</span><span class="token punctuation">,</span> <span class="token class-name">Locale</span><span class="token punctuation">.</span>SIMPLIFIED_CHINESE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取本地系统默认的Locale初始化</span>
    <span class="token class-name">ResourceBundle</span> rbDefault <span class="token operator">=</span> <span class="token class-name">ResourceBundle</span><span class="token punctuation">.</span><span class="token function">getBundle</span><span class="token punctuation">(</span><span class="token string">"locales.content"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ResourceBundle rbDefault =ResourceBundle.getBundle("locales.content", Locale.getDefault()); // 与上行代码等价</span>

    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"us-US:"</span> <span class="token operator">+</span> rbUS<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"helloWorld"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"us-US:"</span> <span class="token operator">+</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>rbUS<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"time"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"08:00"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"zh-CN："</span> <span class="token operator">+</span> rbZhCN<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"helloWorld"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"zh-CN："</span> <span class="token operator">+</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>rbZhCN<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"time"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"08:00"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"default："</span> <span class="token operator">+</span> rbDefault<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"helloWorld"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"default："</span> <span class="token operator">+</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>rbDefault<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"time"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"08:00"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>输出</strong></p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">us-US:HelloWorld!
us-US:The current time is 08:00.
zh-CN：世界，你好！
zh-CN：当前时间是08:00。
default：世界，你好！
default：当前时间是08:00。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注：在加载资源时，如果指定的本地化资源文件不存在，它会尝试按下面的顺序加载其他的资源：本地系统默认本地化对象对应的资源 -&gt; 默认的资源。如果指定错误，Java 会提示找不到资源文件。</p>
<h2 id="-310"><a class="markdownIt-Anchor" href="#-310">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-locale.html#%E6%94%AF%E6%8C%81%E6%9C%AC%E5%9C%B0%E5%8C%96%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB">#</a>支持本地化的工具类</h2>
<p>Java 中也提供了几个支持本地化的格式化工具类。例如： <code>NumberFormat</code> 、 <code>DateFormat</code> 、 <code>MessageFormat</code></p>
<h3 id="-311"><a class="markdownIt-Anchor" href="#-311">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-locale.html#numberformat">#</a>NumberFormat</h3>
<p><code>NumberFormat</code>  是所有数字格式类的基类。它提供格式化和解析数字的接口。它也提供了决定数字所属语言类型的方法。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">double</span> num <span class="token operator">=</span> <span class="token number">123456.78</span><span class="token punctuation">;</span>
	<span class="token class-name">NumberFormat</span> format <span class="token operator">=</span> <span class="token class-name">NumberFormat</span><span class="token punctuation">.</span><span class="token function">getCurrencyInstance</span><span class="token punctuation">(</span><span class="token class-name">Locale</span><span class="token punctuation">.</span>SIMPLIFIED_CHINESE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%f 的本地化（%s）结果: %s"</span><span class="token punctuation">,</span> num<span class="token punctuation">,</span> <span class="token class-name">Locale</span><span class="token punctuation">.</span>SIMPLIFIED_CHINESE<span class="token punctuation">,</span> format<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-312"><a class="markdownIt-Anchor" href="#-312">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-locale.html#dateformat">#</a>DateFormat</h3>
<p>DateFormat 是日期、时间格式化类的抽象类。它支持基于语言习惯的日期、时间格式。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token class-name">Date</span> date <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">DateFormat</span> df <span class="token operator">=</span> <span class="token class-name">DateFormat</span><span class="token punctuation">.</span><span class="token function">getDateInstance</span><span class="token punctuation">(</span><span class="token class-name">DateFormat</span><span class="token punctuation">.</span>MEDIUM<span class="token punctuation">,</span> <span class="token class-name">Locale</span><span class="token punctuation">.</span>ENGLISH<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">DateFormat</span> df2 <span class="token operator">=</span> <span class="token class-name">DateFormat</span><span class="token punctuation">.</span><span class="token function">getDateInstance</span><span class="token punctuation">(</span><span class="token class-name">DateFormat</span><span class="token punctuation">.</span>MEDIUM<span class="token punctuation">,</span> <span class="token class-name">Locale</span><span class="token punctuation">.</span>SIMPLIFIED_CHINESE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%s 的本地化（%s）结果: %s\n"</span><span class="token punctuation">,</span> date<span class="token punctuation">,</span> <span class="token class-name">Locale</span><span class="token punctuation">.</span>SIMPLIFIED_CHINESE<span class="token punctuation">,</span> df<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%s 的本地化（%s）结果: %s\n"</span><span class="token punctuation">,</span> date<span class="token punctuation">,</span> <span class="token class-name">Locale</span><span class="token punctuation">.</span>SIMPLIFIED_CHINESE<span class="token punctuation">,</span> df2<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-313"><a class="markdownIt-Anchor" href="#-313">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/java-locale.html#messageformat">#</a>MessageFormat</h3>
<p>Messageformat 提供一种与语言无关的拼接消息的方式。通过这种拼接方式，将最终呈现返回给使用者。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token class-name">String</span> pattern1 <span class="token operator">=</span> <span class="token string">"&#123;0&#125;，你好！你于  &#123;1&#125; 消费  &#123;2&#125; 元。"</span><span class="token punctuation">;</span>
	<span class="token class-name">String</span> pattern2 <span class="token operator">=</span> <span class="token string">"At &#123;1,time,short&#125; On &#123;1,date,long&#125;，&#123;0&#125; paid &#123;2,number, currency&#125;."</span><span class="token punctuation">;</span>
	<span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> params <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"Jack"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">GregorianCalendar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">8888</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
	<span class="token class-name">String</span> msg1 <span class="token operator">=</span> <span class="token class-name">MessageFormat</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>pattern1<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">MessageFormat</span> mf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageFormat</span><span class="token punctuation">(</span>pattern2<span class="token punctuation">,</span> <span class="token class-name">Locale</span><span class="token punctuation">.</span>US<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">String</span> msg2 <span class="token operator">=</span> mf<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>msg1<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>msg2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<h1 id="jdk8-入门指南"><a class="markdownIt-Anchor" href="#jdk8-入门指南">#</a> JDK8 入门指南</h1>
<blockquote>
<p>JDK8 升级常见问题章节是我个人的经验整理。其他内容基本翻译自 <a target="_blank" rel="noopener" href="https://github.com/winterbe/java8-tutorial">java8-tutorial(opens new window)</a></p>
<p><strong>📦 本文以及示例源码已归档在 <a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/">javacore(opens new window)</a></strong></p>
<p>关键词： <code>Stream</code> 、 <code>lambda</code> 、 <code>Optional</code> 、 <code>@FunctionalInterface</code></p>
</blockquote>
<h2 id="-314"><a class="markdownIt-Anchor" href="#-314">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/jdk8.html#default-methods-for-interfaces-%E6%8E%A5%E5%8F%A3%E7%9A%84%E9%BB%98%E8%AE%A4%E6%96%B9%E6%B3%95">#</a>Default Methods for Interfaces (接口的默认方法)</h2>
<p>Java 8 使我们能够通过使用  <code>default</code>  关键字将非抽象方法实现添加到接口。这个功能也被称为虚拟扩展方法。</p>
<p>这是我们的第一个例子：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">interface</span> <span class="token class-name">Formula</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">double</span> <span class="token function">calculate</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">default</span> <span class="token keyword">double</span> <span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>除了抽象方法  <code>calculate</code>  ，接口  <code>Formula</code>  还定义了默认方法  <code>sqrt</code> 。具体类只需要执行抽象方法计算。默认的方法  <code>sqrt</code>  可以用于开箱即用。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Formula</span> formula <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Formula</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">double</span> <span class="token function">calculate</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token function">sqrt</span><span class="token punctuation">(</span>a <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

formula<span class="token punctuation">.</span><span class="token function">calculate</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 100.0</span>
formula<span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">// 4.0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>Formula</code>  被实现为一个匿名对象。代码非常冗长：用于  <code>sqrt(a * 100)</code>  这样简单的计算的 6 行代码。正如我们将在下一节中看到的，在 Java 8 中实现单个方法对象有更好的方法。</p>
<h2 id="-315"><a class="markdownIt-Anchor" href="#-315">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/jdk8.html#lambda-expressions-lambda-%E8%A1%A8%E8%BE%BE%E5%BC%8F">#</a>Lambda expressions (Lambda 表达式)</h2>
<p>让我们从一个简单的例子来说明如何在以前版本的 Java 中对字符串列表进行排序：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> names <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"peter"</span><span class="token punctuation">,</span> <span class="token string">"anna"</span><span class="token punctuation">,</span> <span class="token string">"mike"</span><span class="token punctuation">,</span> <span class="token string">"xenia"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>names<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Comparator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">compare</span><span class="token punctuation">(</span><span class="token class-name">String</span> a<span class="token punctuation">,</span> <span class="token class-name">String</span> b<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> b<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>静态工具方法  <code>Collections.sort</code>  为了对指定的列表进行排序，接受一个列表和一个比较器。您会发现自己经常需要创建匿名比较器并将其传递给排序方法。</p>
<p>Java 8 使用更简短的 <strong>lambda 表达式</strong>来避免常常创建匿名对象的问题：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>names<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">String</span> a<span class="token punctuation">,</span> <span class="token class-name">String</span> b<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> b<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>如您所见，这段代码比上段代码简洁很多。但是，还可以更加简洁：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>names<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">String</span> a<span class="token punctuation">,</span> <span class="token class-name">String</span> b<span class="token punctuation">)</span> <span class="token operator">-></span> b<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这行代码中，你省去了花括号  <code>&#123;&#125;</code>  和 return 关键字。但是，这还不算完，它还可以再进一步简洁：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">names<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">-></span> b<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>列表现在有一个  <code>sort</code>  方法。此外，java 编译器知道参数类型，所以你可以不指定入参的数据类型。让我们深入探讨如何使用 lambda 表达式。</p>
<h2 id="-316"><a class="markdownIt-Anchor" href="#-316">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/jdk8.html#functional-interfaces-%E5%87%BD%E6%95%B0%E6%8E%A5%E5%8F%A3">#</a>Functional Interfaces (函数接口)</h2>
<p>lambda 表达式如何适应 Java 的类型系统？每个 lambda 对应一个由接口指定的类型。一个所谓的<em>函数接口</em>必须包含一个<strong>抽象方法声明</strong>。该类型的每个 lambda 表达式都将与此抽象方法匹配。由于默认方法不是抽象的，所以你可以自由地添加默认方法到你的函数接口。</p>
<p>只要保证接口仅包含一个抽象方法，就可以使用任意的接口作为 lambda 表达式。为确保您的接口符合要求，您应该添加  <code>@FunctionalInterface</code>  注解。编译器注意到这个注解后，一旦您尝试在接口中添加第二个抽象方法声明，编译器就会抛出编译器错误。</p>
<p>示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@FunctionalInterface</span>
<span class="token keyword">interface</span> <span class="token class-name">Converter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">F</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">T</span> <span class="token function">convert</span><span class="token punctuation">(</span><span class="token class-name">F</span> from<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token class-name">Converter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">></span></span> converter <span class="token operator">=</span> <span class="token punctuation">(</span>from<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>from<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Integer</span> converted <span class="token operator">=</span> converter<span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span><span class="token string">"123"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>converted<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 123</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>请记住，如果  <code>@FunctionalInterface</code>  注解被省略，代码也是有效的。</p>
<h2 id="-317"><a class="markdownIt-Anchor" href="#-317">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/jdk8.html#method-and-constructor-references-%E6%96%B9%E6%B3%95%E5%92%8C%E6%9E%84%E9%80%A0%E5%99%A8%E5%BC%95%E7%94%A8">#</a>Method and Constructor References (方法和构造器引用)</h2>
<p>上面的示例代码可以通过使用静态方法引用进一步简化：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Converter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">></span></span> converter <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token operator">::</span><span class="token function">valueOf</span><span class="token punctuation">;</span>
<span class="token class-name">Integer</span> converted <span class="token operator">=</span> converter<span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span><span class="token string">"123"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>converted<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 123</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>Java 8 允许您通过  <code>::</code>  关键字传递方法或构造函数的引用。上面的例子展示了如何引用一个静态方法。但是我们也可以引用对象方法：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Something</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">String</span> <span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token class-name">Something</span> something <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Something</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Converter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> converter <span class="token operator">=</span> something<span class="token operator">::</span><span class="token function">startsWith</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> converted <span class="token operator">=</span> converter<span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span><span class="token string">"Java"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>converted<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// "J"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们来观察一下  <code>::</code>  关键字是如何作用于构造器的。首先，我们定义一个有多个构造器的示例类。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">String</span> firstName<span class="token punctuation">;</span>
    <span class="token class-name">String</span> lastName<span class="token punctuation">;</span>

    <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

    <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token class-name">String</span> firstName<span class="token punctuation">,</span> <span class="token class-name">String</span> lastName<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>firstName <span class="token operator">=</span> firstName<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>lastName <span class="token operator">=</span> lastName<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>接着，我们指定一个用于创建 Person 对象的 PersonFactory 接口。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">interface</span> <span class="token class-name">PersonFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">P</span> <span class="token keyword">extends</span> <span class="token class-name">Person</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">P</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">String</span> firstName<span class="token punctuation">,</span> <span class="token class-name">String</span> lastName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>我们不是手动实现工厂，而是通过构造引用将所有东西粘合在一起：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">PersonFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Person</span><span class="token punctuation">></span></span> personFactory <span class="token operator">=</span> <span class="token class-name">Person</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">;</span>
<span class="token class-name">Person</span> person <span class="token operator">=</span> personFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"Peter"</span><span class="token punctuation">,</span> <span class="token string">"Parker"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>我们通过  <code>Person::new</code>  来创建一个 Person 构造器的引用。Java 编译器会根据 <code>PersonFactory.create</code>  的签名自动匹配正确的构造器。</p>
<h2 id="-318"><a class="markdownIt-Anchor" href="#-318">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/jdk8.html#lambda-scopes-lambda-%E4%BD%9C%E7%94%A8%E5%9F%9F">#</a>Lambda Scopes (Lambda 作用域)</h2>
<p>从 lambda 表达式访问外部作用域变量与匿名对象非常相似。您可以访问本地外部作用域的常量以及实例的成员变量和静态变量。</p>
<h3 id="-319"><a class="markdownIt-Anchor" href="#-319">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/jdk8.html#accessing-local-variables-%E8%AE%BF%E9%97%AE%E6%9C%AC%E5%9C%B0%E5%8F%98%E9%87%8F">#</a>Accessing local variables (访问本地变量)</h3>
<p>我们可以访问 lambda 表达式作用域外部的常量：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">final</span> <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token class-name">Converter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> stringConverter <span class="token operator">=</span>
        <span class="token punctuation">(</span>from<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>from <span class="token operator">+</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>

stringConverter<span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 3</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>不同于匿名对象的是：这个变量  <code>num</code>  不是一定要被  <code>final</code>  修饰。下面的代码一样合法：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token class-name">Converter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> stringConverter <span class="token operator">=</span>
        <span class="token punctuation">(</span>from<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>from <span class="token operator">+</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>

stringConverter<span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 3</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>但是， <code>num</code>  必须是隐式常量的。下面的代码不能编译通过：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token class-name">Converter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> stringConverter <span class="token operator">=</span>
        <span class="token punctuation">(</span>from<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>from <span class="token operator">+</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
num <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>此外，在 lambda 表达式中对  <code>num</code>  做写操作也是被禁止的。</p>
<h3 id="-320"><a class="markdownIt-Anchor" href="#-320">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/jdk8.html#accessing-fields-and-static-variables-%E8%AE%BF%E9%97%AE%E6%88%90%E5%91%98%E5%8F%98%E9%87%8F%E5%92%8C%E9%9D%99%E6%80%81%E5%8F%98%E9%87%8F">#</a>Accessing fields and static variables (访问成员变量和静态变量)</h3>
<p>与局部变量相比，我们既可以在 lambda 表达式中读写实例的成员变量，也可以读写实例的静态变量。这种行为在匿名对象中是众所周知的。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Lambda4</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">static</span> <span class="token keyword">int</span> outerStaticNum<span class="token punctuation">;</span>
    <span class="token keyword">int</span> outerNum<span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">testScopes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Converter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> stringConverter1 <span class="token operator">=</span> <span class="token punctuation">(</span>from<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
            outerNum <span class="token operator">=</span> <span class="token number">23</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>from<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

        <span class="token class-name">Converter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> stringConverter2 <span class="token operator">=</span> <span class="token punctuation">(</span>from<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
            outerStaticNum <span class="token operator">=</span> <span class="token number">72</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>from<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-321"><a class="markdownIt-Anchor" href="#-321">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/jdk8.html#accessing-default-interface-methods-%E8%AE%BF%E9%97%AE%E9%BB%98%E8%AE%A4%E7%9A%84%E6%8E%A5%E5%8F%A3%E6%96%B9%E6%B3%95">#</a>Accessing Default Interface Methods（访问默认的接口方法）</h3>
<p>还记得第一节的 formula 例子吗？  <code>Formula</code>  接口定义了一个默认方法  <code>sqrt</code> ，它可以被每个 formula 实例（包括匿名对象）访问。这个特性不适用于 lambda 表达式。</p>
<p>默认方法<strong>不能</strong>被 lambda 表达式访问。下面的代码不能编译通过：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Formula</span> formula <span class="token operator">=</span> <span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token function">sqrt</span><span class="token punctuation">(</span>a <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="-322"><a class="markdownIt-Anchor" href="#-322">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/jdk8.html#built-in-functional-interfaces-%E5%86%85%E7%BD%AE%E5%87%BD%E6%95%B0%E6%8E%A5%E5%8F%A3">#</a>Built-in Functional Interfaces (内置函数接口)</h2>
<p>JDK 1.8 API 包含许多内置的功能接口。它们中的一些在较早的 Java 版本（比如  <code>Comparator</code>  或  <code>Runnable</code> ）中是众所周知的。这些现有的接口通过  <code>@FunctionalInterfaceannotation</code>  注解被扩展为支持 Lambda。</p>
<p>但是，Java 8 API 也提供了不少新的函数接口。其中一些新接口在 <a target="_blank" rel="noopener" href="https://code.google.com/p/guava-libraries/">Google Guava (opens new window)</a> 库中是众所周知的。即使您熟悉这个库，也应该密切关注如何通过一些有用的方法扩展来扩展这些接口。</p>
<h3 id="-323"><a class="markdownIt-Anchor" href="#-323">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/jdk8.html#predicates">#</a>Predicates</h3>
<p><code>Predicate</code>  是只有一个参数的布尔值函数。该接口包含各种默认方法，用于将谓词组合成复杂的逻辑术语（与、或、非）</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Predicate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> predicate <span class="token operator">=</span> <span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">-></span> s<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span>

predicate<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">"foo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment">// true</span>
predicate<span class="token punctuation">.</span><span class="token function">negate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">"foo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// false</span>

<span class="token class-name">Predicate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">></span></span> nonNull <span class="token operator">=</span> <span class="token class-name">Objects</span><span class="token operator">::</span><span class="token function">nonNull</span><span class="token punctuation">;</span>
<span class="token class-name">Predicate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">></span></span> isNull <span class="token operator">=</span> <span class="token class-name">Objects</span><span class="token operator">::</span><span class="token function">isNull</span><span class="token punctuation">;</span>

<span class="token class-name">Predicate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> isEmpty <span class="token operator">=</span> <span class="token class-name">String</span><span class="token operator">::</span><span class="token function">isEmpty</span><span class="token punctuation">;</span>
<span class="token class-name">Predicate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> isNotEmpty <span class="token operator">=</span> isEmpty<span class="token punctuation">.</span><span class="token function">negate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-324"><a class="markdownIt-Anchor" href="#-324">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/jdk8.html#functions">#</a>Functions</h3>
<p><code>Function</code>  接受一个参数并产生一个结果。可以使用默认方法将多个函数链接在一起（compose、andThen）。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">></span></span> toInteger <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token operator">::</span><span class="token function">valueOf</span><span class="token punctuation">;</span>
<span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> backToString <span class="token operator">=</span> toInteger<span class="token punctuation">.</span><span class="token function">andThen</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token operator">::</span><span class="token function">valueOf</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

backToString<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token string">"123"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// "123"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-325"><a class="markdownIt-Anchor" href="#-325">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/jdk8.html#suppliers">#</a>Suppliers</h3>
<p><code>Supplier</code>  产生一个泛型结果。与  <code>Function</code>  不同， <code>Supplier</code>  不接受参数。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Person</span><span class="token punctuation">></span></span> personSupplier <span class="token operator">=</span> <span class="token class-name">Person</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">;</span>
personSupplier<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// new Person</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="-326"><a class="markdownIt-Anchor" href="#-326">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/jdk8.html#consumers">#</a>Consumers</h3>
<p>Consumer 表示要在一个输入参数上执行的操作。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Person</span><span class="token punctuation">></span></span> greeter <span class="token operator">=</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Hello, "</span> <span class="token operator">+</span> p<span class="token punctuation">.</span>firstName<span class="token punctuation">)</span><span class="token punctuation">;</span>
greeter<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">"Luke"</span><span class="token punctuation">,</span> <span class="token string">"Skywalker"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="-327"><a class="markdownIt-Anchor" href="#-327">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/jdk8.html#comparators">#</a>Comparators</h3>
<p>比较器在老版本的 Java 中是众所周知的。 Java 8 为接口添加了各种默认方法。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Comparator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Person</span><span class="token punctuation">></span></span> comparator <span class="token operator">=</span> <span class="token punctuation">(</span>p1<span class="token punctuation">,</span> p2<span class="token punctuation">)</span> <span class="token operator">-></span> p1<span class="token punctuation">.</span>firstName<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>p2<span class="token punctuation">.</span>firstName<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Person</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">"John"</span><span class="token punctuation">,</span> <span class="token string">"Doe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Person</span> p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">"Alice"</span><span class="token punctuation">,</span> <span class="token string">"Wonderland"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

comparator<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>p1<span class="token punctuation">,</span> p2<span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment">// > 0</span>
comparator<span class="token punctuation">.</span><span class="token function">reversed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>p1<span class="token punctuation">,</span> p2<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// &lt; 0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="-328"><a class="markdownIt-Anchor" href="#-328">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/jdk8.html#optionals">#</a>Optionals</h2>
<p><code>Optional</code>  不是功能性接口，而是防止  <code>NullPointerException</code>  的好工具。这是下一节的一个重要概念，所以让我们快速看看  <code>Optional</code>  是如何工作的。</p>
<p><code>Optional</code>  是一个简单的容器，其值可以是 null 或非 null。想想一个可能返回一个非空结果的方法，但有时候什么都不返回。不是返回 null，而是返回 Java 8 中的  <code>Optional</code> 。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> optional <span class="token operator">=</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"bam"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

optional<span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">// true</span>
optional<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token comment">// "bam"</span>
optional<span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token string">"fallback"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// "bam"</span>

optional<span class="token punctuation">.</span><span class="token function">ifPresent</span><span class="token punctuation">(</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// "b"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="-329"><a class="markdownIt-Anchor" href="#-329">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/jdk8.html#streams">#</a>Streams</h2>
<p><code>java.util.Stream</code>  表示可以在其上执行一个或多个操作的元素序列。流操作是中间或终端。当终端操作返回一个特定类型的结果时，中间操作返回流本身，所以你可以链接多个方法调用。流在源上创建，例如一个  <code>java.util.Collection</code>  像列表或集合（不支持映射）。流操作既可以按顺序执行，也可以并行执行。</p>
<blockquote>
<p>流是非常强大的，所以，我写了一个独立的 <a target="_blank" rel="noopener" href="http://winterbe.com/posts/2014/07/31/java8-stream-tutorial-examples/">Java8 Streams 教程 (opens new window)</a>。<strong>您还应该查看 Sequent，将其作为 Web 的类似库。</strong></p>
</blockquote>
<p>我们先来看看顺序流如何工作。首先，我们以字符串列表的形式创建一个示例源代码：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> stringCollection <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
stringCollection<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"ddd2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
stringCollection<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"aaa2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
stringCollection<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"bbb1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
stringCollection<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"aaa1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
stringCollection<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"bbb3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
stringCollection<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"ccc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
stringCollection<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"bbb2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
stringCollection<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"ddd1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Java 8 中的集合已被扩展，因此您可以通过调用  <code>Collection.stream()</code>  或 <code>Collection.parallelStream()</code>  来简单地创建流。以下各节介绍最常见的流操作。</p>
<h3 id="-330"><a class="markdownIt-Anchor" href="#-330">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/jdk8.html#filter">#</a>Filter</h3>
<p>过滤器接受一个谓词来过滤流的所有元素。这个操作是中间的，使我们能够调用另一个流操作（ <code>forEach</code> ）的结果。 ForEach 接受一个消费者被执行的过滤流中的每个元素。 ForEach 是一个终端操作。它是无效的，所以我们不能调用另一个流操作。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">stringCollection
    <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">-></span> s<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// "aaa2", "aaa1"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-331"><a class="markdownIt-Anchor" href="#-331">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/jdk8.html#sorted">#</a>Sorted</h3>
<p>排序是一个中间操作，返回流的排序视图。元素按自然顺序排序，除非您传递自定义比较器。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">stringCollection
    <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">sorted</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">-></span> s<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// "aaa1", "aaa2"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>请记住，排序只会创建流的排序视图，而不会操纵支持的集合的排序。  <code>stringCollection</code>  的排序是不变的：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>stringCollection<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// ddd2, aaa2, bbb1, aaa1, bbb3, ccc, bbb2, ddd1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="-332"><a class="markdownIt-Anchor" href="#-332">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/jdk8.html#map">#</a>Map</h3>
<p>中间操作映射通过给定函数将每个元素转换为另一个对象。以下示例将每个字符串转换为大写字母字符串。但是您也可以使用  <code>map</code>  将每个对象转换为另一种类型。结果流的泛型类型取决于您传递给  <code>map</code>  的函数的泛型类型。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">stringCollection
    <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token operator">::</span><span class="token function">toUpperCase</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">sorted</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">-></span> b<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// "DDD2", "DDD1", "CCC", "BBB3", "BBB2", "AAA2", "AAA1"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-333"><a class="markdownIt-Anchor" href="#-333">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/jdk8.html#match">#</a>Match</h3>
<p>可以使用各种匹配操作来检查某个谓词是否与流匹配。所有这些操作都是终端并返回布尔结果。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">boolean</span> anyStartsWithA <span class="token operator">=</span>
    stringCollection
        <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">anyMatch</span><span class="token punctuation">(</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">-></span> s<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>anyStartsWithA<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// true</span>

<span class="token keyword">boolean</span> allStartsWithA <span class="token operator">=</span>
    stringCollection
        <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">allMatch</span><span class="token punctuation">(</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">-></span> s<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>allStartsWithA<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// false</span>

<span class="token keyword">boolean</span> noneStartsWithZ <span class="token operator">=</span>
    stringCollection
        <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">noneMatch</span><span class="token punctuation">(</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">-></span> s<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"z"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>noneStartsWithZ<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-334"><a class="markdownIt-Anchor" href="#-334">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/jdk8.html#count">#</a>Count</h4>
<p>Count 是一个终端操作，返回流中元素的个数。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">long</span> startsWithB <span class="token operator">=</span>
    stringCollection
        <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">-></span> s<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"b"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>startsWithB<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-335"><a class="markdownIt-Anchor" href="#-335">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/jdk8.html#reduce">#</a>Reduce</h3>
<p>该终端操作使用给定的功能对流的元素进行缩减。结果是一个  <code>Optional</code>  持有缩小后的值。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> reduced <span class="token operator">=</span>
    stringCollection
        <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">sorted</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>s1<span class="token punctuation">,</span> s2<span class="token punctuation">)</span> <span class="token operator">-></span> s1 <span class="token operator">+</span> <span class="token string">"#"</span> <span class="token operator">+</span> s2<span class="token punctuation">)</span><span class="token punctuation">;</span>

reduced<span class="token punctuation">.</span><span class="token function">ifPresent</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// "aaa1##aaa2##bbb1##bbb2##bbb3##ccc##ddd1##ddd2"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="-336"><a class="markdownIt-Anchor" href="#-336">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/jdk8.html#parallel-streams">#</a>Parallel Streams</h2>
<p>如上所述，流可以是顺序的也可以是并行的。顺序流上的操作在单个线程上执行，而并行流上的操作在多个线程上同时执行。</p>
<p>以下示例演示了通过使用并行流提高性能是多么容易。</p>
<p>首先，我们创建一个较大的独特元素的列表：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">int</span> max <span class="token operator">=</span> <span class="token number">1000000</span><span class="token punctuation">;</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> values <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>max<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> max<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">UUID</span> uuid <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    values<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>uuid<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>现在我们测量对这个集合进行排序所花费的时间。</p>
<h3 id="-337"><a class="markdownIt-Anchor" href="#-337">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/jdk8.html#sequential-sort">#</a>Sequential Sort</h3>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">long</span> t0 <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">long</span> count <span class="token operator">=</span> values<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sorted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">long</span> t1 <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">long</span> millis <span class="token operator">=</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>NANOSECONDS<span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span>t1 <span class="token operator">-</span> t0<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"sequential sort took: %d ms"</span><span class="token punctuation">,</span> millis<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// sequential sort took: 899 ms</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-338"><a class="markdownIt-Anchor" href="#-338">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/jdk8.html#parallel-sort">#</a>Parallel Sort</h3>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">long</span> t0 <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">long</span> count <span class="token operator">=</span> values<span class="token punctuation">.</span><span class="token function">parallelStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sorted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">long</span> t1 <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">long</span> millis <span class="token operator">=</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>NANOSECONDS<span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span>t1 <span class="token operator">-</span> t0<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"parallel sort took: %d ms"</span><span class="token punctuation">,</span> millis<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// parallel sort took: 472 ms</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如你所见，两个代码段差不多，但是并行排序快了近 50%。你所需做的仅仅是将  <code>stream()</code>  改为  <code>parallelStream()</code>  。</p>
<h2 id="-339"><a class="markdownIt-Anchor" href="#-339">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/jdk8.html#maps">#</a>Maps</h2>
<p>如前所述，map 不直接支持流。Map 接口本身没有可用的  <code>stream()</code>  方法，但是你可以通过  <code>map.keySet().stream()</code>  、  <code>map.values().stream()</code>  和  <code>map.entrySet().stream()</code>  创建指定的流。</p>
<p>此外，map 支持各种新的、有用的方法来处理常见任务。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    map<span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token string">"val"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

map<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> val<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上面的代码应该是自我解释的： <code>putIfAbsent</code>  阻止我们写入额外的空值检查； <code>forEach</code>  接受消费者为 map 的每个值实现操作。</p>
<p>这个例子展示了如何利用函数来计算 map 上的代码：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">map<span class="token punctuation">.</span><span class="token function">computeIfPresent</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>num<span class="token punctuation">,</span> val<span class="token punctuation">)</span> <span class="token operator">-></span> val <span class="token operator">+</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment">// val33</span>

map<span class="token punctuation">.</span><span class="token function">computeIfPresent</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>num<span class="token punctuation">,</span> val<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
map<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// false</span>

map<span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span><span class="token number">23</span><span class="token punctuation">,</span> num <span class="token operator">-></span> <span class="token string">"val"</span> <span class="token operator">+</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
map<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token number">23</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// true</span>

map<span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> num <span class="token operator">-></span> <span class="token string">"bam"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment">// val33</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>接下来，我们学习如何删除给定键的条目，只有当前键映射到给定值时：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">map<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"val3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment">// val33</span>

map<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"val33"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment">// null</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>另一个有用方法：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">map<span class="token punctuation">.</span><span class="token function">getOrDefault</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">,</span> <span class="token string">"not found"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// not found</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>合并一个 map 的 entry 很简单：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">map<span class="token punctuation">.</span><span class="token function">merge</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token string">"val9"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>value<span class="token punctuation">,</span> newValue<span class="token punctuation">)</span> <span class="token operator">-></span> value<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment">// val9</span>

map<span class="token punctuation">.</span><span class="token function">merge</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token string">"concat"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>value<span class="token punctuation">,</span> newValue<span class="token punctuation">)</span> <span class="token operator">-></span> value<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment">// val9concat</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果不存在该键的条目，合并或者将键 / 值放入 map 中；否则将调用合并函数来更改现有值。</p>
<h2 id="-340"><a class="markdownIt-Anchor" href="#-340">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/jdk8.html#date-api">#</a>Date API</h2>
<p>Java 8 在  <code>java.time</code>  包下新增了一个全新的日期和时间 API。新的日期 API 与 <a target="_blank" rel="noopener" href="http://www.joda.org/joda-time/">Joda-Time (opens new window)</a> 库相似，但不一样。以下示例涵盖了此新 API 的最重要部分。</p>
<h3 id="-341"><a class="markdownIt-Anchor" href="#-341">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/jdk8.html#clock">#</a>Clock</h3>
<p><code>Clock</code>  提供对当前日期和时间的访问。 <code>Clock</code>  知道一个时区，可以使用它来代替  <code>System.currentTimeMillis()</code>  ，获取从 <strong>Unix EPOCH</strong> 开始的以毫秒为单位的当前时间。时间线上的某一时刻也由类  <code>Instant</code>  表示。 Instants 可以用来创建遗留的  <code>java.util.Date</code>  对象。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Clock</span> clock <span class="token operator">=</span> <span class="token class-name">Clock</span><span class="token punctuation">.</span><span class="token function">systemDefaultZone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">long</span> millis <span class="token operator">=</span> clock<span class="token punctuation">.</span><span class="token function">millis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Instant</span> instant <span class="token operator">=</span> clock<span class="token punctuation">.</span><span class="token function">instant</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Date</span> legacyDate <span class="token operator">=</span> <span class="token class-name">Date</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>instant<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// legacy java.util.Date</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-342"><a class="markdownIt-Anchor" href="#-342">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/jdk8.html#timezones">#</a>Timezones</h3>
<p>时区由  <code>ZoneId</code>  表示。他们可以很容易地通过静态工厂方法访问。时区定义了某一时刻和当地日期、时间之间转换的重要偏移量。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">ZoneId</span><span class="token punctuation">.</span><span class="token function">getAvailableZoneIds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// prints all available timezone ids</span>

<span class="token class-name">ZoneId</span> zone1 <span class="token operator">=</span> <span class="token class-name">ZoneId</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"Europe/Berlin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">ZoneId</span> zone2 <span class="token operator">=</span> <span class="token class-name">ZoneId</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"Brazil/East"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>zone1<span class="token punctuation">.</span><span class="token function">getRules</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>zone2<span class="token punctuation">.</span><span class="token function">getRules</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ZoneRules[currentStandardOffset=+01:00]</span>
<span class="token comment">// ZoneRules[currentStandardOffset=-03:00]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-343"><a class="markdownIt-Anchor" href="#-343">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/jdk8.html#localtime">#</a>LocalTime</h3>
<p><code>LocalTime</code>  代表没有时区的时间，例如晚上 10 点或 17:30:15。以下示例为上面定义的时区创建两个本地时间。然后我们比较两次，并计算两次之间的小时和分钟的差异。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">LocalTime</span> now1 <span class="token operator">=</span> <span class="token class-name">LocalTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span>zone1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">LocalTime</span> now2 <span class="token operator">=</span> <span class="token class-name">LocalTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span>zone2<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>now1<span class="token punctuation">.</span><span class="token function">isBefore</span><span class="token punctuation">(</span>now2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// false</span>

<span class="token keyword">long</span> hoursBetween <span class="token operator">=</span> <span class="token class-name">ChronoUnit</span><span class="token punctuation">.</span>HOURS<span class="token punctuation">.</span><span class="token function">between</span><span class="token punctuation">(</span>now1<span class="token punctuation">,</span> now2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">long</span> minutesBetween <span class="token operator">=</span> <span class="token class-name">ChronoUnit</span><span class="token punctuation">.</span>MINUTES<span class="token punctuation">.</span><span class="token function">between</span><span class="token punctuation">(</span>now1<span class="token punctuation">,</span> now2<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hoursBetween<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// -3</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>minutesBetween<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// -239</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>LocalTime</code>  带有各种工厂方法，以简化新实例的创建，包括解析时间字符串。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">LocalTime</span> late <span class="token operator">=</span> <span class="token class-name">LocalTime</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">23</span><span class="token punctuation">,</span> <span class="token number">59</span><span class="token punctuation">,</span> <span class="token number">59</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>late<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// 23:59:59</span>

<span class="token class-name">DateTimeFormatter</span> germanFormatter <span class="token operator">=</span>
    <span class="token class-name">DateTimeFormatter</span>
        <span class="token punctuation">.</span><span class="token function">ofLocalizedTime</span><span class="token punctuation">(</span><span class="token class-name">FormatStyle</span><span class="token punctuation">.</span>SHORT<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">withLocale</span><span class="token punctuation">(</span><span class="token class-name">Locale</span><span class="token punctuation">.</span>GERMAN<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">LocalTime</span> leetTime <span class="token operator">=</span> <span class="token class-name">LocalTime</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">"13:37"</span><span class="token punctuation">,</span> germanFormatter<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>leetTime<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 13:37</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-344"><a class="markdownIt-Anchor" href="#-344">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/jdk8.html#localdate">#</a>LocalDate</h3>
<p><code>LocalDate</code>  表示不同的日期，例如：2014 年 3 月 11 日。它是不可变的，并且与  <code>LocalTime</code>  完全类似。该示例演示如何通过加减日、月或年来计算新日期。请记住，每个操作都会返回一个新的实例。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">LocalDate</span> today <span class="token operator">=</span> <span class="token class-name">LocalDate</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">LocalDate</span> tomorrow <span class="token operator">=</span> today<span class="token punctuation">.</span><span class="token function">plus</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">ChronoUnit</span><span class="token punctuation">.</span>DAYS<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">LocalDate</span> yesterday <span class="token operator">=</span> tomorrow<span class="token punctuation">.</span><span class="token function">minusDays</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">LocalDate</span> independenceDay <span class="token operator">=</span> <span class="token class-name">LocalDate</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">2014</span><span class="token punctuation">,</span> <span class="token class-name">Month</span><span class="token punctuation">.</span>JULY<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">DayOfWeek</span> dayOfWeek <span class="token operator">=</span> independenceDay<span class="token punctuation">.</span><span class="token function">getDayOfWeek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>dayOfWeek<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// FRIDAY</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从一个字符串中解析出 LocalDate 对象，和解析 LocalTime 一样的简单：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">DateTimeFormatter</span> germanFormatter <span class="token operator">=</span>
    <span class="token class-name">DateTimeFormatter</span>
        <span class="token punctuation">.</span><span class="token function">ofLocalizedDate</span><span class="token punctuation">(</span><span class="token class-name">FormatStyle</span><span class="token punctuation">.</span>MEDIUM<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">withLocale</span><span class="token punctuation">(</span><span class="token class-name">Locale</span><span class="token punctuation">.</span>GERMAN<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">LocalDate</span> xmas <span class="token operator">=</span> <span class="token class-name">LocalDate</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">"24.12.2014"</span><span class="token punctuation">,</span> germanFormatter<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>xmas<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 2014-12-24</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-345"><a class="markdownIt-Anchor" href="#-345">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/jdk8.html#localdatetime">#</a>LocalDateTime</h3>
<p>LocalDateTime 表示日期时间。它将日期和时间组合成一个实例。  <code>LocalDateTime</code>  是不可变的，其作用类似于  <code>LocalTime</code>  和  <code>LocalDate</code> 。我们可以利用方法去获取日期时间中某个单位的值。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">LocalDateTime</span> sylvester <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">2014</span><span class="token punctuation">,</span> <span class="token class-name">Month</span><span class="token punctuation">.</span>DECEMBER<span class="token punctuation">,</span> <span class="token number">31</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">,</span> <span class="token number">59</span><span class="token punctuation">,</span> <span class="token number">59</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">DayOfWeek</span> dayOfWeek <span class="token operator">=</span> sylvester<span class="token punctuation">.</span><span class="token function">getDayOfWeek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>dayOfWeek<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// WEDNESDAY</span>

<span class="token class-name">Month</span> month <span class="token operator">=</span> sylvester<span class="token punctuation">.</span><span class="token function">getMonth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>month<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// DECEMBER</span>

<span class="token keyword">long</span> minuteOfDay <span class="token operator">=</span> sylvester<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span><span class="token class-name">ChronoField</span><span class="token punctuation">.</span>MINUTE_OF_DAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>minuteOfDay<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 1439</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过一个时区的附加信息可以转为一个实例。这个实例很容易转为 <code>java.util.Date</code>  类型。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Instant</span> instant <span class="token operator">=</span> sylvester
        <span class="token punctuation">.</span><span class="token function">atZone</span><span class="token punctuation">(</span><span class="token class-name">ZoneId</span><span class="token punctuation">.</span><span class="token function">systemDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">toInstant</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Date</span> legacyDate <span class="token operator">=</span> <span class="token class-name">Date</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>instant<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>legacyDate<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// Wed Dec 31 23:59:59 CET 2014</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>日期时间的格式化类似于 Date 或 Time。我们可以使用自定义模式创建格式化程序，而不是使用预定义的格式。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">DateTimeFormatter</span> formatter <span class="token operator">=</span>
    <span class="token class-name">DateTimeFormatter</span>
        <span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span><span class="token string">"MMM dd, yyyy - HH:mm"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">LocalDateTime</span> parsed <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">"Nov 03, 2014 - 07:13"</span><span class="token punctuation">,</span> formatter<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> string <span class="token operator">=</span> formatter<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>parsed<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// Nov 03, 2014 - 07:13</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>不同于  <code>java.text.NumberFormat</code>  ，  <code>DateTimeFormatter</code>  是不可变且<strong>线程安全的</strong> 。</p>
<p>更多关于日期格式化的内容可以参考<a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/api/java/time/format/DateTimeFormatter.html">这里 (opens new window)</a>.</p>
<h2 id="-346"><a class="markdownIt-Anchor" href="#-346">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/jdk8.html#annotations">#</a>Annotations</h2>
<p>Java 8 中的注释是可重复的。让我们直接看一个例子来解决这个问题。</p>
<p>首先，我们定义一个包含实际注释数组的外层注释：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@interface</span> <span class="token class-name">Hints</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Hint</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token annotation punctuation">@Repeatable</span><span class="token punctuation">(</span><span class="token class-name">Hints</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@interface</span> <span class="token class-name">Hint</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">String</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Java8 允许我们通过使用  <code>@Repeatable</code>  注解来引入多个同类型的注解。</p>
<h3 id="-347"><a class="markdownIt-Anchor" href="#-347">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/jdk8.html#variant-1-%E4%BD%BF%E7%94%A8%E5%AE%B9%E5%99%A8%E6%B3%A8%E8%A7%A3-%E8%80%81%E5%A5%97%E8%B7%AF">#</a>Variant 1: 使用容器注解 (老套路)</h3>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Hints</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token annotation punctuation">@Hint</span><span class="token punctuation">(</span><span class="token string">"hint1"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token annotation punctuation">@Hint</span><span class="token punctuation">(</span><span class="token string">"hint2"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="-348"><a class="markdownIt-Anchor" href="#-348">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/jdk8.html#variant-2-%E4%BD%BF%E7%94%A8-repeatable-%E6%B3%A8%E8%A7%A3-%E6%96%B0%E5%A5%97%E8%B7%AF">#</a>Variant 2: 使用 repeatable 注解 (新套路)</h3>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Hint</span><span class="token punctuation">(</span><span class="token string">"hint1"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Hint</span><span class="token punctuation">(</span><span class="token string">"hint2"</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>使用场景 2，Java 编译器隐式地设置了  <code>@Hints</code>  注解。</p>
<p>这对于通过反射来读取注解信息很重要。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Hint</span> hint <span class="token operator">=</span> <span class="token class-name">Person</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">Hint</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hint<span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment">// null</span>

<span class="token class-name">Hints</span> hints1 <span class="token operator">=</span> <span class="token class-name">Person</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">Hints</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hints1<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 2</span>

<span class="token class-name">Hint</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hints2 <span class="token operator">=</span> <span class="token class-name">Person</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getAnnotationsByType</span><span class="token punctuation">(</span><span class="token class-name">Hint</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hints2<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// 2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>尽管，我们从没有在 Person 类上声明  <code>@Hints</code>  注解，但是仍可以通过 <code>getAnnotation(Hints.class)</code>  读取它。然而，更便利的方式是  <code>getAnnotationsByType</code>  ，它可以直接访问所有  <code>@Hint</code>  注解。</p>
<p>此外，Java 8 中的注释使用扩展了两个新的目标：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span>TYPE_PARAMETER<span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span>TYPE_USE<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@interface</span> <span class="token class-name">MyAnnotation</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>水平线以上为 <a target="_blank" rel="noopener" href="https://github.com/winterbe/java8-tutorial">java8-tutorial (opens new window)</a> 翻译内容。</p>
<hr>
<h2 id="-349"><a class="markdownIt-Anchor" href="#-349">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/jdk8.html#jdk8-%E5%8D%87%E7%BA%A7%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98">#</a>JDK8 升级常见问题</h2>
<blockquote>
<p>JDK8 发布很久了，它提供了许多吸引人的新特性，能够提高编程效率。</p>
<p>如果是新的项目，使用 JDK8 当然是最好的选择。但是，对于一些老的项目，升级到 JDK8 则存在一些兼容性问题，是否升级需要酌情考虑。</p>
<p>近期，我在工作中遇到一个任务，将部门所有项目的 JDK 版本升级到 1.8 （老版本大多是 1.6）。在这个过程中，遇到一些问题点，并结合在网上看到的坑，在这里总结一下。</p>
</blockquote>
<h3 id="-350"><a class="markdownIt-Anchor" href="#-350">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/jdk8.html#intellij-%E4%B8%AD%E7%9A%84-jdk-%E7%8E%AF%E5%A2%83%E8%AE%BE%E7%BD%AE">#</a>Intellij 中的 JDK 环境设置</h3>
<h4 id="-351"><a class="markdownIt-Anchor" href="#-351">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/jdk8.html#settings">#</a>Settings</h4>
<p>点击 <strong>File &gt; Settings &gt; Java Compiler</strong></p>
<p>Project bytecode version 选择 1.8</p>
<p>点击 <strong>File &gt; Settings &gt; Build Tools &gt; Maven &gt; Importing</strong></p>
<p>选择 JDK for importer 为 1.8</p>
<h4 id="-352"><a class="markdownIt-Anchor" href="#-352">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/jdk8.html#projcet-settings">#</a>Projcet Settings</h4>
<p><strong>Project SDK</strong> 选择 1.8</p>
<h4 id="-353"><a class="markdownIt-Anchor" href="#-353">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/jdk8.html#application">#</a>Application</h4>
<p>如果 web 应用的启动方式为 Application ，需要修改 JRE</p>
<p>点击 <strong>Run/Debug Configurations &gt; Configuration</strong></p>
<p>选择 JRE 为 1.8</p>
<h3 id="-354"><a class="markdownIt-Anchor" href="#-354">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/jdk8.html#linux-%E7%8E%AF%E5%A2%83%E4%BF%AE%E6%94%B9">#</a>Linux 环境修改</h3>
<h4 id="-355"><a class="markdownIt-Anchor" href="#-355">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/jdk8.html#%E4%BF%AE%E6%94%B9%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F">#</a>修改环境变量</h4>
<p>修改  <code>/etc/profile</code>  中的 <strong>JAVA_HOME</strong>，设置 为 jdk8 所在路径。</p>
<p>修改后，执行  <code>source /etc/profile</code>  生效。</p>
<p>编译、发布脚本中如果有  <code>export JAVA_HOME</code>  ，需要注意，需要使用 jdk8 的路径。</p>
<h4 id="-356"><a class="markdownIt-Anchor" href="#-356">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/jdk8.html#%E4%BF%AE%E6%94%B9-maven">#</a>修改 maven</h4>
<p>settings.xml 中 profile 的激活条件如果是 jdk，需要修改一下 jdk 版本</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>activation</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>jdk</span><span class="token punctuation">></span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>jdk</span><span class="token punctuation">></span></span> <span class="token comment">&lt;!-- 修改为 1.8 --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>activation</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="-357"><a class="markdownIt-Anchor" href="#-357">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/jdk8.html#%E4%BF%AE%E6%94%B9-server">#</a>修改 server</h4>
<p>修改 server 中的 javac 版本，以 resin 为例：</p>
<p>修改 resin 配置文件中的 javac 参数。</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>javac</span> <span class="token attr-name">compiler</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>internal<span class="token punctuation">"</span></span> <span class="token attr-name">args</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>-source 1.8<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="-358"><a class="markdownIt-Anchor" href="#-358">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/jdk8.html#sun-%E5%8C%85%E7%BC%BA%E5%A4%B1%E9%97%AE%E9%A2%98">#</a>sun.* 包缺失问题</h3>
<p>JDK8 不再提供  <code>sun.*</code>  包供开发者使用，因为这些接口不是公共接口，不能保证在所有 Java 兼容的平台上工作。</p>
<p>使用了这些 API 的程序如果要升级到 JDK 1.8 需要寻求替代方案。</p>
<p>虽然，也可以自己导入包含  <code>sun.*</code>  接口 jar 包到 classpath 目录，但这不是一个好的做法。</p>
<p>需要详细了解为什么不要使用  <code>sun.*</code>  ，可以参考官方文档：<a target="_blank" rel="noopener" href="http://www.oracle.com/technetwork/java/faq-sun-packages-142232.html">Why Developers Should Not Write Programs That Call ‘sun’ Packages(opens new window)</a></p>
<h3 id="-359"><a class="markdownIt-Anchor" href="#-359">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/jdk8.html#%E9%BB%98%E8%AE%A4%E5%AE%89%E5%85%A8%E7%AD%96%E7%95%A5%E4%BF%AE%E6%94%B9">#</a>默认安全策略修改</h3>
<p>升级后估计有些小伙伴在使用不安全算法时可能会发生错误，so，支持不安全算法还是有必要的</p>
<p>找到 $JAVA_HOME 下  <code>jre/lib/security/java.security</code>  ，将禁用的算法设置为空： <code>jdk.certpath.disabledAlgorithms=</code>  。</p>
<h3 id="-360"><a class="markdownIt-Anchor" href="#-360">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/jdk8.html#jvm-%E5%8F%82%E6%95%B0%E8%B0%83%E6%95%B4">#</a>JVM 参数调整</h3>
<p>在 jdk8 中，PermSize 相关的参数已经不被使用：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">-XX:MaxPermSize=size

Sets the maximum permanent generation space size (in bytes). This option was deprecated in JDK 8, and superseded by the -XX:MaxMetaspaceSize option.

-XX:PermSize=size

Sets the space (in bytes) allocated to the permanent generation that triggers a garbage collection if it is exceeded. This option was deprecated un JDK 8, and superseded by the -XX:MetaspaceSize option.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>JDK8 中再也没有  <code>PermGen</code>  了。其中的某些部分，如被 intern 的字符串，在 JDK7 中已经移到了普通堆里。<strong>其余结构在 JDK8 中会被移到称作 “Metaspace” 的本机内存区中，该区域在默认情况下会自动生长，也会被垃圾回收。它有两个标记：MetaspaceSize 和 MaxMetaspaceSize。</strong></p>
<p>-XX:MetaspaceSize=size</p>
<blockquote>
<p>Sets the size of the allocated class metadata space that will trigger a garbage collection the first time it is exceeded. This threshold for a garbage collection is increased or decreased depending on the amount of metadata used. The default size depends on the platform.</p>
</blockquote>
<p>-XX:MaxMetaspaceSize=size</p>
<blockquote>
<p>Sets the maximum amount of native memory that can be allocated for class metadata. By default, the size is not limited. The amount of metadata for an application depends on the application itself, other running applications, and the amount of memory available on the system.</p>
</blockquote>
<p>以下示例显示如何将类类元数据的上限设置为 256 MB：</p>
<p>XX:MaxMetaspaceSize=256m</p>
<h3 id="-361"><a class="markdownIt-Anchor" href="#-361">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/jdk8.html#%E5%AD%97%E8%8A%82%E7%A0%81%E9%97%AE%E9%A2%98">#</a>字节码问题</h3>
<p>ASM 5.0 beta 开始支持 JDK8</p>
<p><strong>字节码错误</strong></p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Caused by: java.io.IOException: invalid constant type: 15
	at javassist.bytecode.ConstPool.readOne(ConstPool.java:1113)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<ul>
<li>查找组件用到了 mvel，mvel 为了提高效率进行了字节码优化，正好碰上 JDK8 死穴，所以需要升级。</li>
</ul>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.mvel<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>mvel2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.2.7.Final<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>javassist</li>
</ul>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.javassist<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>javassist<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>3.18.1-GA<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p><strong>注意</strong></p>
<p>有些部署工具不会删除旧版本 jar 包，所以可以尝试手动删除老版本 jar 包。</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="http://asm.ow2.org/history.html">http://asm.ow2.org/history.html</a></p>
<h3 id="-362"><a class="markdownIt-Anchor" href="#-362">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/jdk8.html#java-%E8%BF%9E%E6%8E%A5-redis-%E5%90%AF%E5%8A%A8%E6%8A%A5%E9%94%99-error-redis-clients-jedis-hostandport-cant-resolve-localhost-address">#</a>Java 连接 redis 启动报错 Error redis clients jedis HostAndPort cant resolve localhost address</h3>
<p>错误环境：本地 window 开发环境没有问题。上到 Linux 环境，启动出现问题。 错误信息: Error redis clients jedis HostAndPort cant resolve localhost address</p>
<p>解决办法:</p>
<p>（1）查看 Linux 系统的主机名</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text"># hostname
template<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>（2）查看 /etc/hosts 文件中是否有 127.0.0.1 对应主机名，如果没有则添加</p>
<h3 id="-363"><a class="markdownIt-Anchor" href="#-363">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/advanced/jdk8.html#resin-%E5%AE%B9%E5%99%A8%E6%8C%87%E5%AE%9A-jdk-1-8">#</a>Resin 容器指定 JDK 1.8</h3>
<p>如果 resin 容器原来版本低于 JDK1.8，运行 JDK 1.8 编译的 web app 时，可能会提示错误：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">java.lang.UnsupportedClassVersionError: PR/Sort : Unsupported major.minor version 52.0<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>解决方法就是，使用 JDK 1.8 要重新编译一下。然后，我在部署时出现过编译后仍报错的情况，重启一下服务器后，问题解决，不知是什么原因。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">./configure --prefix=/usr/local/resin  --with-java=/usr/local/jdk1.8.0_121
make &amp; make install<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<hr>
<h1 id="java-容器简介"><a class="markdownIt-Anchor" href="#java-容器简介">#</a> Java 容器简介</h1>
<blockquote>
<p><strong>📦 本文以及示例源码已归档在 <a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/">javacore(opens new window)</a></strong></p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/20200221175550.png" alt="img"></p>
<ul>
<li>\1. 容器简介
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container.html#11-%E6%95%B0%E7%BB%84%E4%B8%8E%E5%AE%B9%E5%99%A8">1.1. 数组与容器</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container.html#12-%E5%AE%B9%E5%99%A8%E6%A1%86%E6%9E%B6">1.2. 容器框架</a></li>
</ul>
</li>
<li>\2. 容器的基本机制
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container.html#21-%E6%B3%9B%E5%9E%8B">2.1. 泛型</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container.html#22-iterable-%E5%92%8C-iterator">2.2. Iterable 和 Iterator</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container.html#23-comparable-%E5%92%8C-comparator">2.3. Comparable 和 Comparator</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container.html#24-cloneable">2.4. Cloneable</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container.html#25-fail-fast">2.5. fail-fast</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container.html#3-%E5%AE%B9%E5%99%A8%E5%92%8C%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8">3. 容器和线程安全</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container.html#4-%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">4. 参考资料</a></li>
</ul>
<h2 id="-364"><a class="markdownIt-Anchor" href="#-364">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container.html#_1-%E5%AE%B9%E5%99%A8%E7%AE%80%E4%BB%8B">#</a>1. 容器简介</h2>
<h3 id="-365"><a class="markdownIt-Anchor" href="#-365">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container.html#_1-1-%E6%95%B0%E7%BB%84%E4%B8%8E%E5%AE%B9%E5%99%A8">#</a>1.1. 数组与容器</h3>
<p>Java 中常用的存储容器就是数组和容器，二者有以下区别：</p>
<ul>
<li>存储大小是否固定
<ul>
<li>数组的<strong>长度固定</strong>；</li>
<li>容器的<strong>长度可变</strong>。</li>
</ul>
</li>
<li>数据类型
<ul>
<li><strong>数组可以存储基本数据类型，也可以存储引用数据类型</strong>；</li>
<li><strong>容器只能存储引用数据类型</strong>，基本数据类型的变量要转换成对应的包装类才能放入容器类中。</li>
</ul>
</li>
</ul>
<blockquote>
<p>💡 不了解什么是基本数据类型、引用数据类型、包装类这些概念，可以参考：<a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/blob/master/docs/basics/java-data-type.md">Java 基本数据类型 (opens new window)</a></p>
</blockquote>
<h3 id="-366"><a class="markdownIt-Anchor" href="#-366">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container.html#_1-2-%E5%AE%B9%E5%99%A8%E6%A1%86%E6%9E%B6">#</a>1.2. 容器框架</h3>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/java-container-structure.png" alt="img"></p>
<p>Java 容器框架主要分为  <code>Collection</code>  和  <code>Map</code>  两种。其中， <code>Collection</code>  又分为  <code>List</code> 、 <code>Set</code>  以及  <code>Queue</code> 。</p>
<ul>
<li>
<pre><code>
  Collection
  <pre class="line-numbers language-none"><code class="language-none">

​	 

	\- 一个独立元素的序列，这些元素都服从一条或者多条规则。
	
	- &#96;List&#96; - 必须按照插入的顺序保存元素。
	- &#96;Set&#96; - 不能有重复的元素。
	- &#96;Queue&#96; - 按照排队规则来确定对象产生的顺序（通常与它们被插入的顺序相同）。

- &#96;Map&#96; - 一组成对的“键值对”对象，允许你使用键来查找值。

## [#](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;container&#x2F;java-container.html#_2-容器的基本机制)2. 容器的基本机制

&gt; Java 的容器具有一定的共性，它们或全部或部分依赖以下技术。所以，学习以下技术点，对于理解 Java 容器的特性和原理有很大的帮助。

### [#](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;container&#x2F;java-container.html#_2-1-泛型)2.1. 泛型

Java 1.5 引入了泛型技术。

Java **容器通过泛型技术来保证其数据的类型安全**。什么是类型安全呢？

举例来说：如果有一个 &#96;List&lt;Object&gt;&#96; 容器，Java **编译器在编译时不会对原始类型进行类型安全检查**，却会对带参数的类型进行检查，通过使用 Object 作为类型，可以告知编译器该方法可以接受任何类型的对象，比如 String 或 Integer。

&#96;&#96;&#96;java
List&lt;Object&gt; list &#x3D; new ArrayList&lt;Object&gt;();
list.add(&quot;123&quot;);
list.add(123);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

</code></pre>
</li>
</ul>
<p>如果没有泛型技术，如示例中的代码那样，容器中就可能存储任意数据类型，这是很危险的行为。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">List&lt;String> list = new ArrayList&lt;String>();
list.add("123");
list.add(123);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>💡 想深入了解 Java 泛型技术的用法和原理可以参考：<a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/blob/master/docs/basics/java-generic.md">深入理解 Java 泛型 (opens new window)</a></p>
</blockquote>
<h3 id="-367"><a class="markdownIt-Anchor" href="#-367">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container.html#_2-2-iterable-%E5%92%8C-iterator">#</a>2.2. Iterable 和 Iterator</h3>
<blockquote>
<p>Iterable 和 Iterator 目的在于遍历访问容器中的元素。</p>
</blockquote>
<p><code>Iterator</code>  接口定义：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">boolean</span> <span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">E</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">default</span> <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span><span class="token string">"remove"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">default</span> <span class="token keyword">void</span> <span class="token function">forEachRemaining</span><span class="token punctuation">(</span><span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">E</span><span class="token punctuation">></span></span> action<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            action<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>Iterable</code>  接口定义：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>

    <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">default</span> <span class="token keyword">void</span> <span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">></span></span> action<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">T</span> t <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            action<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">default</span> <span class="token class-name">Spliterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">spliterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token class-name">Spliterators</span><span class="token punctuation">.</span><span class="token function">spliteratorUnknownSize</span><span class="token punctuation">(</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>Collection</code>  接口扩展了  <code>Iterable</code>  接口。</p>
<p>迭代其实我们可以简单地理解为遍历，是一个标准化遍历各类容器里面的所有对象的接口。它是一个经典的设计模式 —— 迭代器模式（Iterator）。</p>
<p><strong>迭代器模式</strong> - <strong>提供一种方法顺序访问一个聚合对象中各个元素，而又无须暴露该对象的内部表示</strong>。</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/iterator-pattern.png" alt="img"></p>
<p>示例：迭代器遍历</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IteratorDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Iterator</span> it <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-368"><a class="markdownIt-Anchor" href="#-368">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container.html#_2-3-comparable-%E5%92%8C-comparator">#</a>2.3. Comparable 和 Comparator</h3>
<p><code>Comparable</code>  是排序接口。若一个类实现了  <code>Comparable</code>  接口，表示该类的实例可以比较，也就意味着支持排序。实现了  <code>Comparable</code>  接口的类的对象的列表或数组可以通过  <code>Collections.sort</code>  或  <code>Arrays.sort</code>  进行自动排序。</p>
<p><code>Comparable</code>  接口定义：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Comparable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">compareTo</span><span class="token punctuation">(</span><span class="token class-name">T</span> o<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><code>Comparator</code>  是比较接口，我们如果需要控制某个类的次序，而该类本身不支持排序 (即没有实现  <code>Comparable</code>  接口)，那么我们就可以建立一个 “该类的比较器” 来进行排序，这个 “比较器” 只需要实现  <code>Comparator</code>  接口即可。也就是说，我们可以通过实现  <code>Comparator</code>  来新建一个比较器，然后通过这个比较器对类进行排序。</p>
<p><code>Comparator</code>  接口定义：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@FunctionalInterface</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Comparator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">int</span> <span class="token function">compare</span><span class="token punctuation">(</span><span class="token class-name">T</span> o1<span class="token punctuation">,</span> <span class="token class-name">T</span> o2<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">boolean</span> <span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 反转</span>
    <span class="token keyword">default</span> <span class="token class-name">Comparator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">reversed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">reverseOrder</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">default</span> <span class="token class-name">Comparator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">thenComparing</span><span class="token punctuation">(</span><span class="token class-name">Comparator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">></span></span> other<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>other<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">Comparator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token operator">&amp;</span> <span class="token class-name">Serializable</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c2<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token function">compare</span><span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c2<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>res <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> res <span class="token operator">:</span> other<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// thenComparingXXX 方法略</span>

    <span class="token comment">// 静态方法略</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在 Java 容器中，一些可以排序的容器，如  <code>TreeMap</code> 、 <code>TreeSet</code> ，都可以通过传入  <code>Comparator</code> ，来定义内部元素的排序规则。</p>
<h3 id="-369"><a class="markdownIt-Anchor" href="#-369">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container.html#_2-4-cloneable">#</a>2.4. Cloneable</h3>
<p>Java 中 一个类要实现  <code>clone</code>  功能 必须实现  <code>Cloneable</code>  接口，否则在调用  <code>clone()</code>  时会报  <code>CloneNotSupportedException</code>  异常。</p>
<p>Java 中所有类都默认继承  <code>java.lang.Object</code>  类，在  <code>java.lang.Object</code>  类中有一个方法  <code>clone()</code> ，这个方法将返回  <code>Object</code>  对象的一个拷贝。 <code>Object</code>  类里的  <code>clone()</code>  方法仅仅用于浅拷贝（拷贝基本成员属性，对于引用类型仅返回指向改地址的引用）。</p>
<p>如果 Java 类需要深拷贝，需要覆写  <code>clone()</code>  方法。</p>
<h3 id="-370"><a class="markdownIt-Anchor" href="#-370">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container.html#_2-5-fail-fast">#</a>2.5. fail-fast</h3>
<h4 id="-371"><a class="markdownIt-Anchor" href="#-371">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container.html#fail-fast-%E7%9A%84%E8%A6%81%E7%82%B9">#</a>fail-fast 的要点</h4>
<p>Java 容器（如：ArrayList、HashMap、TreeSet 等待）的 javadoc 中常常提到类似的描述：</p>
<blockquote>
<p>注意，迭代器的快速失败行为无法得到保证，因为一般来说，不可能对是否出现不同步并发修改做出任何硬性保证。快速失败（fail-fast）迭代器会尽最大努力抛出  <code>ConcurrentModificationException</code> 。因此，为提高这类迭代器的正确性而编写一个依赖于此异常的程序是错误的做法：迭代器的快速失败行为应该仅用于检测 bug。</p>
</blockquote>
<p>那么，我们不禁要问，什么是 fail-fast，为什么要有 fail-fast 机制？</p>
<p><strong>fail-fast 是 Java 容器的一种错误检测机制</strong>。当多个线程对容器进行结构上的改变的操作时，就可能触发 fail-fast 机制。记住是有可能，而不是一定。</p>
<p>例如：假设存在两个线程（线程 1、线程 2），线程 1 通过  <code>Iterator</code>  在遍历容器 A 中的元素，在某个时候线程 2 修改了容器 A 的结构（是结构上面的修改，而不是简单的修改容器元素的内容），那么这个时候程序就会抛出  <code>ConcurrentModificationException</code>  异常，从而产生 fail-fast 机制。</p>
<p><strong>容器在迭代操作中改变元素个数（添加、删除元素）都可能会导致 fail-fast</strong>。</p>
<p>示例：fail-fast 示例</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FailFastDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> MAX <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAX<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyThreadA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyThreadB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/** 迭代遍历容器所有元素 */</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyThreadA</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> iterator <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">int</span> i <span class="token operator">=</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"MyThreadA 访问元素:"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                    <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

    <span class="token punctuation">&#125;</span>

    <span class="token comment">/** 遍历删除指定范围内的所有偶数 */</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyThreadB</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> MAX<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"MyThreadB 删除元素"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    list<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                i<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>执行后，会抛出  <code>java.util.ConcurrentModificationException</code>  异常。</p>
<h4 id="-372"><a class="markdownIt-Anchor" href="#-372">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container.html#%E8%A7%A3%E5%86%B3-fail-fast">#</a>解决 fail-fast</h4>
<p>fail-fast 有两种解决方案：</p>
<ul>
<li>在遍历过程中所有涉及到改变容器个数的地方全部加上  <code>synchronized</code>  或者直接使用  <code>Collections.synchronizedXXX</code>  容器，这样就可以解决。但是不推荐，因为增删造成的同步锁可能会阻塞遍历操作，影响吞吐。</li>
<li>使用并发容器，如： <code>CopyOnWriterArrayList</code> 。</li>
</ul>
<h2 id="-373"><a class="markdownIt-Anchor" href="#-373">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container.html#_3-%E5%AE%B9%E5%99%A8%E5%92%8C%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8">#</a>3. 容器和线程安全</h2>
<p>为了在并发环境下安全地使用容器，Java 提供了同步容器和并发容器。</p>
<blockquote>
<p>同步容器和并发容器详情请参考：<a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/blob/master/docs/concurrent/5-%E5%90%8C%E6%AD%A5%E5%AE%B9%E5%99%A8%E5%92%8C%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8.md">同步容器和并发容器</a></p>
</blockquote>
<hr>
<h1 id="java-容器之-list"><a class="markdownIt-Anchor" href="#java-容器之-list">#</a> Java 容器之 List</h1>
<blockquote>
<p><strong>📦 本文以及示例源码已归档在 <a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/">javacore(opens new window)</a></strong></p>
<p><code>List</code>  是  <code>Collection</code>  的子接口，其中可以保存各个重复的内容。</p>
</blockquote>
<ul>
<li>\1. List 简介
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-list.html#11-arraylist-%E5%92%8C-linkedlist">1.1. ArrayList 和 LinkedList</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-list.html#12-vector-%E5%92%8C-stack">1.2. Vector 和 Stack</a></li>
</ul>
</li>
<li>\2. ArrayList
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-list.html#21-arraylist-%E8%A6%81%E7%82%B9">2.1. ArrayList 要点</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-list.html#22-arraylist-%E5%8E%9F%E7%90%86">2.2. ArrayList 原理</a></li>
</ul>
</li>
<li>\3. LinkedList
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-list.html#31-linkedlist-%E8%A6%81%E7%82%B9">3.1. LinkedList 要点</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-list.html#32-linkedlist-%E5%8E%9F%E7%90%86">3.2. LinkedList 原理</a></li>
</ul>
</li>
<li>\4. List 常见问题
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-list.html#41-arraysaslist-%E9%97%AE%E9%A2%98%E7%82%B9">4.1. Arrays.asList 问题点</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-list.html#42-listsublist-%E9%97%AE%E9%A2%98%E7%82%B9">4.2. List.subList 问题点</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-list.html#5-%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">5. 参考资料</a></li>
</ul>
<h2 id="-374"><a class="markdownIt-Anchor" href="#-374">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-list.html#_1-list-%E7%AE%80%E4%BB%8B">#</a>1. List 简介</h2>
<p><code>List</code>  是一个接口，它继承于  <code>Collection</code>  的接口。它代表着有序的队列。</p>
<p><code>AbstractList</code>  是一个抽象类，它继承于  <code>AbstractCollection</code> 。 <code>AbstractList</code>  实现了  <code>List</code>  接口中除  <code>size()</code> 、 <code>get(int location)</code>  之外的函数。</p>
<p><code>AbstractSequentialList</code>  是一个抽象类，它继承于  <code>AbstractList</code> 。 <code>AbstractSequentialList</code>  实现了 “链表中，根据 index 索引值操作链表的全部函数”。</p>
<h3 id="-375"><a class="markdownIt-Anchor" href="#-375">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-list.html#_1-1-arraylist-%E5%92%8C-linkedlist">#</a>1.1. ArrayList 和 LinkedList</h3>
<p><code>ArrayList</code> 、 <code>LinkedList</code>  是  <code>List</code>  最常用的实现。</p>
<ul>
<li><code>ArrayList</code>  基于动态数组实现，存在容量限制，当元素数超过最大容量时，会自动扩容； <code>LinkedList</code>  基于双向链表实现，不存在容量限制。</li>
<li><code>ArrayList</code>  随机访问速度较快，随机插入、删除速度较慢； <code>LinkedList</code>  随机插入、删除速度较快，随机访问速度较慢。</li>
<li><code>ArrayList</code>  和  <code>LinkedList</code>  都不是线程安全的。</li>
</ul>
<h3 id="-376"><a class="markdownIt-Anchor" href="#-376">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-list.html#_1-2-vector-%E5%92%8C-stack">#</a>1.2. Vector 和 Stack</h3>
<p><code>Vector</code>  和  <code>Stack</code>  的设计目标是作为线程安全的  <code>List</code>  实现，替代  <code>ArrayList</code> 。</p>
<ul>
<li><code>Vector</code>  -  <code>Vector</code>  和  <code>ArrayList</code>  类似，也实现了  <code>List</code>  接口。但是，  <code>Vector</code>  中的主要方法都是  <code>synchronized</code>  方法，即通过互斥同步方式保证操作的线程安全。</li>
<li><code>Stack</code>  -  <code>Stack</code>  也是一个同步容器，它的方法也用  <code>synchronized</code>  进行了同步，它实际上是继承于  <code>Vector</code>  类。</li>
</ul>
<h2 id="-377"><a class="markdownIt-Anchor" href="#-377">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-list.html#_2-arraylist">#</a>2. ArrayList</h2>
<blockquote>
<p>ArrayList 从数据结构角度来看，可以视为支持动态扩容的线性表。</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/20200221142803.png" alt="img"></p>
<h3 id="-378"><a class="markdownIt-Anchor" href="#-378">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-list.html#_2-1-arraylist-%E8%A6%81%E7%82%B9">#</a>2.1. ArrayList 要点</h3>
<p><code>ArrayList</code>  是一个数组队列，相当于<strong>动态数组</strong>。<strong> <code>ArrayList</code>  默认初始容量大小为  <code>10</code>  ，添加元素时，如果发现容量已满，会自动扩容为原始大小的 1.5 倍</strong>。因此，应该尽量在初始化  <code>ArrayList</code>  时，为其指定合适的初始化容量大小，减少扩容操作产生的性能开销。</p>
<p><code>ArrayList</code>  定义：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span>
        <span class="token keyword">implements</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span><span class="token punctuation">,</span> <span class="token class-name">RandomAccess</span><span class="token punctuation">,</span> <span class="token class-name">Cloneable</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>从 ArrayList 的定义，不难看出 ArrayList 的一些基本特性：</p>
<ul>
<li><code>ArrayList</code>  实现了  <code>List</code>  接口，并继承了  <code>AbstractList</code> ，它支持所有  <code>List</code>  的操作。</li>
<li><code>ArrayList</code>  实现了  <code>RandomAccess</code>  接口，<strong>支持随机访问</strong>。 <code>RandomAccess</code>  是一个标志接口，它意味着 “只要实现该接口的  <code>List</code>  类，都支持快速随机访问”。在  <code>ArrayList</code>  中，我们即可以<strong>通过元素的序号快速获取元素对象</strong>；这就是快速随机访问。</li>
<li><code>ArrayList</code>  实现了  <code>Cloneable</code>  接口，默认为<strong>浅拷贝</strong>。</li>
<li><code>ArrayList</code>  实现了  <code>Serializable</code>  接口，<strong>支持序列化</strong>，能通过序列化方式传输。</li>
<li><code>ArrayList</code>  是<strong>非线程安全</strong>的。</li>
</ul>
<h3 id="-379"><a class="markdownIt-Anchor" href="#-379">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-list.html#_2-2-arraylist-%E5%8E%9F%E7%90%86">#</a>2.2. ArrayList 原理</h3>
<h4 id="-380"><a class="markdownIt-Anchor" href="#-380">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-list.html#arraylist-%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84">#</a>ArrayList 的数据结构</h4>
<p>ArrayList 包含了两个重要的元素： <code>elementData</code>  和  <code>size</code> 。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 默认初始化容量</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> DEFAULT_CAPACITY <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token comment">// 对象数组</span>
<span class="token keyword">transient</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> elementData<span class="token punctuation">;</span>
<span class="token comment">// 数组长度</span>
<span class="token keyword">private</span> <span class="token keyword">int</span> size<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><code>size</code>  - 是动态数组的实际大小。</li>
<li><code>elementData</code>  - 是一个  <code>Object</code>  数组，用于保存添加到  <code>ArrayList</code>  中的元素。</li>
</ul>
<h4 id="-381"><a class="markdownIt-Anchor" href="#-381">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-list.html#arraylist-%E7%9A%84%E5%BA%8F%E5%88%97%E5%8C%96">#</a>ArrayList 的序列化</h4>
<p><code>ArrayList</code>  具有动态扩容特性，因此保存元素的数组不一定都会被使用，那么就没必要全部进行序列化。为此， <code>ArrayList</code>  定制了其序列化方式。具体做法是：</p>
<ul>
<li>存储元素的  <code>Object</code>  数组（即  <code>elementData</code> ）使用  <code>transient</code>  修饰，使得它可以被 Java 序列化所忽略。</li>
<li><code>ArrayList</code>  重写了  <code>writeObject()</code>  和  <code>readObject()</code>  来控制序列化数组中有元素填充那部分内容。</li>
</ul>
<blockquote>
<p>💡 不了解 Java 序列化方式，可以参考：<a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/blob/master/docs/io/java-serialization.md">Java 序列化 (opens new window)</a></p>
</blockquote>
<h4 id="-382"><a class="markdownIt-Anchor" href="#-382">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-list.html#arraylist-%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95">#</a>ArrayList 构造方法</h4>
<p>ArrayList 类实现了三个构造函数：</p>
<ul>
<li>第一个是默认构造方法，ArrayList 会创建一个空数组；</li>
<li>第二个是创建 ArrayList 对象时，传入一个初始化值；</li>
<li>第三个是传入一个集合类型进行初始化。</li>
</ul>
<p>当 ArrayList 新增元素时，如果所存储的元素已经超过其当前容量，它会计算容量后再进行动态扩容。数组的动态扩容会导致整个数组进行一次内存复制。因此，<strong>初始化 ArrayList 时，指定数组初始大小，有助于减少数组的扩容次数，从而提高系统性能</strong>。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 创建一个空数组</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>elementData <span class="token operator">=</span> DEFAULTCAPACITY_EMPTY_ELEMENTDATA<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token keyword">int</span> initialCapacity<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>initialCapacity <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 根据初始化值创建数组大小</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>elementData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span>initialCapacity<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>initialCapacity <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 初始化值为 0 时，创建一个空数组</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>elementData <span class="token operator">=</span> EMPTY_ELEMENTDATA<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Illegal Capacity: "</span><span class="token operator">+</span>
										   initialCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-383"><a class="markdownIt-Anchor" href="#-383">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-list.html#arraylist-%E8%AE%BF%E9%97%AE%E5%85%83%E7%B4%A0">#</a>ArrayList 访问元素</h4>
<p><code>ArrayList</code>  访问元素的实现主要基于以下关键性源码：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 获取第 index 个元素</span>
<span class="token keyword">public</span> <span class="token class-name">E</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">int</span> index<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">rangeCheck</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">elementData</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token class-name">E</span> <span class="token function">elementData</span><span class="token punctuation">(</span><span class="token keyword">int</span> index<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">E</span><span class="token punctuation">)</span> elementData<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实现非常简单，其实就是<strong>通过数组下标访问数组元素，其时间复杂度为 O (1)</strong>，所以很快。</p>
<h4 id="-384"><a class="markdownIt-Anchor" href="#-384">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-list.html#arraylist-%E6%B7%BB%E5%8A%A0%E5%85%83%E7%B4%A0">#</a>ArrayList 添加元素</h4>
<p><code>ArrayList</code>  添加元素有两种方法：一种是添加元素到数组末尾，另外一种是添加元素到任意位置。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 添加元素到数组末尾</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">ensureCapacityInternal</span><span class="token punctuation">(</span>size <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Increments modCount!!</span>
    elementData<span class="token punctuation">[</span>size<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 添加元素到任意位置</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">int</span> index<span class="token punctuation">,</span> <span class="token class-name">E</span> element<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token function">rangeCheckForAdd</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">ensureCapacityInternal</span><span class="token punctuation">(</span>size <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Increments modCount!!</span>
	<span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>elementData<span class="token punctuation">,</span> index<span class="token punctuation">,</span> elementData<span class="token punctuation">,</span> index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>
					 size <span class="token operator">-</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
	elementData<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> element<span class="token punctuation">;</span>
	size<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>两种添加元素方法的<strong>不同点</strong>是：</p>
<ul>
<li>添加元素到任意位置，会导致在<strong>该位置后的所有元素都需要重新排列</strong>；</li>
<li>而添加元素到数组末尾，在没有发生扩容的前提下，是不会有元素复制排序过程的。</li>
</ul>
<p>两种添加元素方法的<strong>共同点</strong>是：添加元素时，会先检查容量大小，<strong>如果发现容量不足，会自动扩容为原始大小的 1.5 倍</strong>。</p>
<p><code>ArrayList</code>  添加元素的实现主要基于以下关键性源码：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">ensureCapacityInternal</span><span class="token punctuation">(</span><span class="token keyword">int</span> minCapacity<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>elementData <span class="token operator">==</span> DEFAULTCAPACITY_EMPTY_ELEMENTDATA<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        minCapacity <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>DEFAULT_CAPACITY<span class="token punctuation">,</span> minCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token function">ensureExplicitCapacity</span><span class="token punctuation">(</span>minCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">ensureExplicitCapacity</span><span class="token punctuation">(</span><span class="token keyword">int</span> minCapacity<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    modCount<span class="token operator">++</span><span class="token punctuation">;</span>

    <span class="token comment">// overflow-conscious code</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>minCapacity <span class="token operator">-</span> elementData<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">grow</span><span class="token punctuation">(</span>minCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">grow</span><span class="token punctuation">(</span><span class="token keyword">int</span> minCapacity<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// overflow-conscious code</span>
    <span class="token keyword">int</span> oldCapacity <span class="token operator">=</span> elementData<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">int</span> newCapacity <span class="token operator">=</span> oldCapacity <span class="token operator">+</span> <span class="token punctuation">(</span>oldCapacity <span class="token operator">>></span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newCapacity <span class="token operator">-</span> minCapacity <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        newCapacity <span class="token operator">=</span> minCapacity<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newCapacity <span class="token operator">-</span> MAX_ARRAY_SIZE <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
        newCapacity <span class="token operator">=</span> <span class="token function">hugeCapacity</span><span class="token punctuation">(</span>minCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// minCapacity is usually close to size, so this is a win:</span>
    elementData <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">copyOf</span><span class="token punctuation">(</span>elementData<span class="token punctuation">,</span> newCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>ArrayList</code>  执行添加元素动作（ <code>add</code>  方法）时，调用  <code>ensureCapacityInternal</code>  方法来保证容量足够。</p>
<ul>
<li>如果容量足够时，将数据作为数组中  <code>size+1</code>  位置上的元素写入，并将  <code>size</code>  自增 1。</li>
<li>如果容量不够时，需要使用  <code>grow</code>  方法进行扩容数组，新容量的大小为  <code>oldCapacity + (oldCapacity &gt;&gt; 1)</code> ，也就是旧容量的 1.5 倍。扩容操作实际上是<strong>调用  <code>Arrays.copyOf()</code>  把原数组拷贝为一个新数组</strong>，因此最好在创建  <code>ArrayList</code>  对象时就指定大概的容量大小，减少扩容操作的次数。</li>
</ul>
<h4 id="-385"><a class="markdownIt-Anchor" href="#-385">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-list.html#arraylist-%E5%88%A0%E9%99%A4%E5%85%83%E7%B4%A0">#</a>ArrayList 删除元素</h4>
<p><code>ArrayList</code>  的删除方法和添加元素到任意位置方法有些相似。</p>
<p><code>ArrayList</code>  在每一次有效的删除操作后，都要进行数组的重组，并且删除的元素位置越靠前，数组重组的开销就越大。具体来说， <code>ArrayList</code>  会 ** 调用  <code>System.arraycopy()</code>  将  <code>index+1</code>  后面的元素都复制到  <code>index</code>  位置上。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">E</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token keyword">int</span> index<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">rangeCheck</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>

    modCount<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token class-name">E</span> oldValue <span class="token operator">=</span> <span class="token function">elementData</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> numMoved <span class="token operator">=</span> size <span class="token operator">-</span> index <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>numMoved <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>elementData<span class="token punctuation">,</span> index<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> elementData<span class="token punctuation">,</span> index<span class="token punctuation">,</span> numMoved<span class="token punctuation">)</span><span class="token punctuation">;</span>
    elementData<span class="token punctuation">[</span><span class="token operator">--</span>size<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// clear to let GC do its work</span>

    <span class="token keyword">return</span> oldValue<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-386"><a class="markdownIt-Anchor" href="#-386">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-list.html#arraylist-%E7%9A%84-fail-fast">#</a>ArrayList 的 Fail-Fast</h4>
<p><code>ArrayList</code>  使用  <code>modCount</code>  来记录结构发生变化的次数。结构发生变化是指添加或者删除至少一个元素的所有操作，或者是调整内部数组的大小，仅仅只是设置元素的值不算结构发生变化。</p>
<p>在进行序列化或者迭代等操作时，需要比较操作前后  <code>modCount</code>  是否改变，如果发生改变， <code>ArrayList</code>  会抛出  <code>ConcurrentModificationException</code> 。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">writeObject</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>ObjectOutputStream</span> s<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>IOException</span><span class="token punctuation">&#123;</span>
    <span class="token comment">// Write out element count, and any hidden stuff</span>
    <span class="token keyword">int</span> expectedModCount <span class="token operator">=</span> modCount<span class="token punctuation">;</span>
    s<span class="token punctuation">.</span><span class="token function">defaultWriteObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Write out size as capacity for behavioural compatibility with clone()</span>
    s<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Write out all elements in the proper order.</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        s<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>elementData<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>modCount <span class="token operator">!=</span> expectedModCount<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentModificationException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="-387"><a class="markdownIt-Anchor" href="#-387">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-list.html#_3-linkedlist">#</a>3. LinkedList</h2>
<blockquote>
<p>LinkedList 从数据结构角度来看，可以视为双链表。</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/20200221142535.png" alt="img"></p>
<h3 id="-388"><a class="markdownIt-Anchor" href="#-388">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-list.html#_3-1-linkedlist-%E8%A6%81%E7%82%B9">#</a>3.1. LinkedList 要点</h3>
<p><code>LinkedList</code>  基于双链表结构实现。由于是双链表，所以<strong>顺序访问会非常高效，而随机访问效率比较低。</strong></p>
<p><code>LinkedList</code>  定义：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span>
    <span class="token keyword">extends</span> <span class="token class-name">AbstractSequentialList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span>
    <span class="token keyword">implements</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span><span class="token punctuation">,</span> <span class="token class-name">Deque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span><span class="token punctuation">,</span> <span class="token class-name">Cloneable</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>从  <code>LinkedList</code>  的定义，可以得出  <code>LinkedList</code>  的一些基本特性：</p>
<ul>
<li><code>LinkedList</code>  实现了  <code>List</code>  接口，并继承了  <code>AbstractSequentialList</code>  ，它支持所有  <code>List</code>  的操作。</li>
<li><code>LinkedList</code>  实现了  <code>Deque</code>  接口，也可以被当作队列（ <code>Queue</code> ）或双端队列（ <code>Deque</code> ）进行操作，此外，也可以用来实现栈。</li>
<li><code>LinkedList</code>  实现了  <code>Cloneable</code>  接口，默认为<strong>浅拷贝</strong>。</li>
<li><code>LinkedList</code>  实现了  <code>Serializable</code>  接口，<strong>支持序列化</strong>。</li>
<li><code>LinkedList</code>  是<strong>非线程安全</strong>的。</li>
</ul>
<h3 id="-389"><a class="markdownIt-Anchor" href="#-389">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-list.html#_3-2-linkedlist-%E5%8E%9F%E7%90%86">#</a>3.2. LinkedList 原理</h3>
<h4 id="-390"><a class="markdownIt-Anchor" href="#-390">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-list.html#linkedlist-%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84">#</a>LinkedList 的数据结构</h4>
<p><strong> <code>LinkedList</code>  内部维护了一个双链表</strong>。</p>
<p><code>LinkedList</code>  通过  <code>Node</code>  类型的头尾指针（ <code>first</code>  和  <code>last</code> ）来访问数据。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 链表长度</span>
<span class="token keyword">transient</span> <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">// 链表头节点</span>
<span class="token keyword">transient</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> first<span class="token punctuation">;</span>
<span class="token comment">// 链表尾节点</span>
<span class="token keyword">transient</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> last<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><code>size</code>  - <strong>表示双链表中节点的个数，初始为 0</strong>。</li>
<li><code>first</code>  和  <code>last</code>  - <strong>分别是双链表的头节点和尾节点</strong>。</li>
</ul>
<p><code>Node</code>  是  <code>LinkedList</code>  的内部类，它表示链表中的元素实例。Node 中包含三个元素：</p>
<ul>
<li><code>prev</code>  是该节点的上一个节点；</li>
<li><code>next</code>  是该节点的下一个节点；</li>
<li><code>item</code>  是该节点所包含的值。</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">E</span> item<span class="token punctuation">;</span>
    <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> next<span class="token punctuation">;</span>
    <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> prev<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-391"><a class="markdownIt-Anchor" href="#-391">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-list.html#linkedlist-%E7%9A%84%E5%BA%8F%E5%88%97%E5%8C%96">#</a>LinkedList 的序列化</h4>
<p><code>LinkedList</code>  与  <code>ArrayList</code>  一样也定制了自身的序列化方式。具体做法是：</p>
<ul>
<li>将  <code>size</code>  （双链表容量大小）、 <code>first</code>  和 <code>last</code>  （双链表的头尾节点）修饰为  <code>transient</code> ，使得它们可以被 Java 序列化所忽略。</li>
<li>重写了  <code>writeObject()</code>  和  <code>readObject()</code>  来控制序列化时，只处理双链表中能被头节点链式引用的节点元素。</li>
</ul>
<h4 id="-392"><a class="markdownIt-Anchor" href="#-392">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-list.html#linkedlist-%E8%AE%BF%E9%97%AE%E5%85%83%E7%B4%A0">#</a>LinkedList 访问元素</h4>
<p><code>LinkedList</code>  访问元素的实现主要基于以下关键性源码：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">E</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">int</span> index<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token function">checkElementIndex</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token function">node</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token function">node</span><span class="token punctuation">(</span><span class="token keyword">int</span> index<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// assert isElementIndex(index);</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&lt;</span> <span class="token punctuation">(</span>size <span class="token operator">>></span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> x <span class="token operator">=</span> first<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> index<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            x <span class="token operator">=</span> x<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
        <span class="token keyword">return</span> x<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> x <span class="token operator">=</span> last<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">></span> index<span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span>
            x <span class="token operator">=</span> x<span class="token punctuation">.</span>prev<span class="token punctuation">;</span>
        <span class="token keyword">return</span> x<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>获取  <code>LinkedList</code>  第 index 个元素的算法是：</p>
<ul>
<li>判断 index 在链表前半部分，还是后半部分。</li>
<li>如果是前半部分，从头节点开始查找；如果是后半部分，从尾结点开始查找。</li>
</ul>
<p><code>LinkedList</code>  这种访问元素的性能是  <code>O(N)</code>  级别的（极端情况下，扫描 N/2 个元素）；相比于  <code>ArrayList</code>  的  <code>O(1)</code> ，显然要慢不少。</p>
<p><strong>推荐使用迭代器遍历  <code>LinkedList</code>  ，不要使用传统的  <code>for</code>  循环</strong>。注：foreach 语法会被编译器转换成迭代器遍历，但是它的遍历过程中不允许修改  <code>List</code>  长度，即不能进行增删操作。</p>
<h4 id="-393"><a class="markdownIt-Anchor" href="#-393">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-list.html#linkedlist-%E6%B7%BB%E5%8A%A0%E5%85%83%E7%B4%A0">#</a>LinkedList 添加元素</h4>
<p><code>LinkedList</code>  有多种添加元素方法：</p>
<ul>
<li><code>add(E e)</code> ：默认添加元素方法（插入尾部）</li>
<li><code>add(int index, E element)</code> ：添加元素到任意位置</li>
<li><code>addFirst(E e)</code> ：在头部添加元素</li>
<li><code>addLast(E e)</code> ：在尾部添加元素</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token function">linkLast</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">int</span> index<span class="token punctuation">,</span> <span class="token class-name">E</span> element<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token function">checkPositionIndex</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">==</span> size<span class="token punctuation">)</span>
		<span class="token function">linkLast</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">else</span>
		<span class="token function">linkBefore</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> <span class="token function">node</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addFirst</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token function">linkFirst</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addLast</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token function">linkLast</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>LinkedList</code>  添加元素的实现主要基于以下关键性源码：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">linkFirst</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">final</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> f <span class="token operator">=</span> first<span class="token punctuation">;</span>
	<span class="token keyword">final</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> newNode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span>
	first <span class="token operator">=</span> newNode<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>f <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
		last <span class="token operator">=</span> newNode<span class="token punctuation">;</span>
	<span class="token keyword">else</span>
		f<span class="token punctuation">.</span>prev <span class="token operator">=</span> newNode<span class="token punctuation">;</span>
	size<span class="token operator">++</span><span class="token punctuation">;</span>
	modCount<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">linkLast</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">final</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> l <span class="token operator">=</span> last<span class="token punctuation">;</span>
	<span class="token keyword">final</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> newNode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> e<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	last <span class="token operator">=</span> newNode<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>l <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
		first <span class="token operator">=</span> newNode<span class="token punctuation">;</span>
	<span class="token keyword">else</span>
		l<span class="token punctuation">.</span>next <span class="token operator">=</span> newNode<span class="token punctuation">;</span>
	size<span class="token operator">++</span><span class="token punctuation">;</span>
	modCount<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">linkBefore</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">,</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> succ<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// assert succ != null;</span>
	<span class="token keyword">final</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> pred <span class="token operator">=</span> succ<span class="token punctuation">.</span>prev<span class="token punctuation">;</span>
	<span class="token keyword">final</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> newNode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>pred<span class="token punctuation">,</span> e<span class="token punctuation">,</span> succ<span class="token punctuation">)</span><span class="token punctuation">;</span>
	succ<span class="token punctuation">.</span>prev <span class="token operator">=</span> newNode<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>pred <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
		first <span class="token operator">=</span> newNode<span class="token punctuation">;</span>
	<span class="token keyword">else</span>
		pred<span class="token punctuation">.</span>next <span class="token operator">=</span> newNode<span class="token punctuation">;</span>
	size<span class="token operator">++</span><span class="token punctuation">;</span>
	modCount<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>算法如下：</p>
<ul>
<li>将新添加的数据包装为  <code>Node</code> ；</li>
<li>如果往头部添加元素，将头指针  <code>first</code>  指向新的  <code>Node</code> ，之前的  <code>first</code>  对象的  <code>prev</code>  指向新的  <code>Node</code> 。</li>
<li>如果是向尾部添加元素，则将尾指针  <code>last</code>  指向新的  <code>Node</code> ，之前的  <code>last</code>  对象的  <code>next</code>  指向新的  <code>Node</code> 。</li>
</ul>
<h4 id="-394"><a class="markdownIt-Anchor" href="#-394">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-list.html#linkedlist-%E5%88%A0%E9%99%A4%E5%85%83%E7%B4%A0">#</a>LinkedList 删除元素</h4>
<p><code>LinkedList</code>  删除元素的实现主要基于以下关键性源码：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>o <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 遍历找到要删除的元素节点</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> x <span class="token operator">=</span> first<span class="token punctuation">;</span> x <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> x <span class="token operator">=</span> x<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>item <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token function">unlink</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 遍历找到要删除的元素节点</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> x <span class="token operator">=</span> first<span class="token punctuation">;</span> x <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> x <span class="token operator">=</span> x<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>o<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token function">unlink</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token class-name">E</span> <span class="token function">unlink</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// assert x != null;</span>
    <span class="token keyword">final</span> <span class="token class-name">E</span> element <span class="token operator">=</span> x<span class="token punctuation">.</span>item<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> next <span class="token operator">=</span> x<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> prev <span class="token operator">=</span> x<span class="token punctuation">.</span>prev<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>prev <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        first <span class="token operator">=</span> next<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        prev<span class="token punctuation">.</span>next <span class="token operator">=</span> next<span class="token punctuation">;</span>
        x<span class="token punctuation">.</span>prev <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>next <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        last <span class="token operator">=</span> prev<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        next<span class="token punctuation">.</span>prev <span class="token operator">=</span> prev<span class="token punctuation">;</span>
        x<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    x<span class="token punctuation">.</span>item <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    size<span class="token operator">--</span><span class="token punctuation">;</span>
    modCount<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> element<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>算法说明：</p>
<ul>
<li>
<p>遍历找到要删除的元素节点，然后调用  <code>unlink</code>  方法删除节点；</p>
</li>
<li>
<pre><code>
  unlink
  <pre class="line-numbers language-none"><code class="language-none">

​	 

	删除节点的方法：
	
	- 如果当前节点有前驱节点，则让前驱节点指向当前节点的下一个节点；否则，让双链表头指针指向下一个节点。
	- 如果当前节点有后继节点，则让后继节点指向当前节点的前一个节点；否则，让双链表尾指针指向上一个节点。

## [#](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;container&#x2F;java-container-list.html#_4-list-常见问题)4. List 常见问题

### [#](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;container&#x2F;java-container-list.html#_4-1-arrays-aslist-问题点)4.1. Arrays.asList 问题点

在业务开发中，我们常常会把原始的数组转换为 &#96;List&#96; 类数据结构，来继续展开各种 &#96;Stream&#96; 操作。通常，我们会使用 &#96;Arrays.asList&#96; 方法可以把数组一键转换为 &#96;List&#96;。

【示例】Arrays.asList 转换基本类型数组

&#96;&#96;&#96;java
int[] arr &#x3D; &#123; 1, 2, 3 &#125;;
List list &#x3D; Arrays.asList(arr);
log.info(&quot;list:&#123;&#125; size:&#123;&#125; class:&#123;&#125;&quot;, list, list.size(), list.get(0).getClass());<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

</code></pre>
</li>
</ul>
<p>【输出】</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">11:26:33.214 [main] INFO io.github.dunwu.javacore.container.list.AsList示例 - list:[[I@ae45eb6] size:1 class:class [I<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>数组元素个数为 3，但转换后的列表个数为 1。</p>
<p>由此可知，  <code>Arrays.asList</code>  第一个问题点：<strong>不能直接使用  <code>Arrays.asList</code>  来转换基本类型数组</strong>。</p>
<p>其原因是： <code>Arrays.asList</code>  方法传入的是一个泛型 T 类型可变参数，最终  <code>int</code>  数组整体作为了一个对象成为了泛型类型 T：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">asList</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> a<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>直接遍历这样的  <code>List</code>  必然会出现 Bug，修复方式有两种，如果使用 Java8 以上版本可以使用  <code>Arrays.stream</code>  方法来转换，否则可以把  <code>int</code>  数组声明为包装类型  <code>Integer</code>  数组：</p>
<p>【示例】转换整型数组为 List 的正确方式</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr1 <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token class-name">List</span> list1 <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>arr1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">boxed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"list:&#123;&#125; size:&#123;&#125; class:&#123;&#125;"</span><span class="token punctuation">,</span> list1<span class="token punctuation">,</span> list1<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> list1<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Integer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr2 <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token class-name">List</span> list2 <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>arr2<span class="token punctuation">)</span><span class="token punctuation">;</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"list:&#123;&#125; size:&#123;&#125; class:&#123;&#125;"</span><span class="token punctuation">,</span> list2<span class="token punctuation">,</span> list2<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> list2<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>【示例】Arrays.asList 转换引用类型数组</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token string">"2"</span><span class="token punctuation">,</span> <span class="token string">"3"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token class-name">List</span> list <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span>
arr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"4"</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"5"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    ex<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"arr:&#123;&#125; list:&#123;&#125;"</span><span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">,</span> list<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>抛出  <code>java.lang.UnsupportedOperationException</code> 。</p>
<p>抛出异常的原因在于  <code>Arrays.asList</code>  第二个问题点：<strong> <code>Arrays.asList</code>  返回的  <code>List</code>  不支持增删操作</strong>。 <code>Arrays.asList</code>  返回的 List 并不是我们期望的  <code>java.util.ArrayList</code> ，而是  <code>Arrays</code>  的内部类  <code>ArrayList</code> 。</p>
<p>查看源码，我们可以发现  <code>Arrays.asList</code>  返回的  <code>ArrayList</code>  继承了  <code>AbstractList</code> ，但是并没有覆写  <code>add</code>  和  <code>remove</code>  方法。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span>
    <span class="token keyword">implements</span> <span class="token class-name">RandomAccess</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">2764017481108945198L</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">E</span><span class="token punctuation">[</span><span class="token punctuation">]</span> a<span class="token punctuation">;</span>

    <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token class-name">E</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        a <span class="token operator">=</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>array<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// ...</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">E</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">int</span> index<span class="token punctuation">,</span> <span class="token class-name">E</span> element<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">E</span> oldValue <span class="token operator">=</span> a<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
        a<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> element<span class="token punctuation">;</span>
        <span class="token keyword">return</span> oldValue<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractCollection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token keyword">implements</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">int</span> index<span class="token punctuation">,</span> <span class="token class-name">E</span> element<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">E</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token keyword">int</span> index<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>Arrays.asList</code>  第三个问题点：<strong>对原始数组的修改会影响到我们获得的那个  <code>List</code> </strong>。 <code>ArrayList</code>  其实是直接使用了原始的数组。</p>
<p>解决方法很简单，重新  <code>new</code>  一个  <code>ArrayList</code>  初始化  <code>Arrays.asList</code>  返回的  <code>List</code>  即可：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token string">"2"</span><span class="token punctuation">,</span> <span class="token string">"3"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token class-name">List</span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
arr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"4"</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"5"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    ex<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"arr:&#123;&#125; list:&#123;&#125;"</span><span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">,</span> list<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-395"><a class="markdownIt-Anchor" href="#-395">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-list.html#_4-2-list-sublist-%E9%97%AE%E9%A2%98%E7%82%B9">#</a>4.2. List.subList 问题点</h3>
<p>List.subList 直接引用了原始的 List，也可以认为是共享 “存储”，而且对原始 List 直接进行结构性修改会导致 SubList 出现异常。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span><span class="token punctuation">></span></span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">oom</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> rawList <span class="token operator">=</span> <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">100000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">boxed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        data<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>rawList<span class="token punctuation">.</span><span class="token function">subList</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>出现 OOM 的原因是，循环中的 1000 个具有 10 万个元素的 List 始终得不到回收，因为它始终被 subList 方法返回的 List 强引用。</p>
<p>解决方法是：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">oomfix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> rawList <span class="token operator">=</span> <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">100000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">boxed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        data<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>rawList<span class="token punctuation">.</span><span class="token function">subList</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>【示例】子 List 强引用原始的 List</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">wrong</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> list <span class="token operator">=</span> <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">boxed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> subList <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">subList</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>subList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    subList<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
    list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        subList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        ex<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>抛出  <code>java.util.ConcurrentModificationException</code> 。</p>
<p>解决方法：</p>
<p>一种是，不直接使用 subList 方法返回的 SubList，而是重新使用 new ArrayList，在构造方法传入 SubList，来构建一个独立的 ArrayList；</p>
<p>另一种是，对于 Java 8 使用 Stream 的 skip 和 limit API 来跳过流中的元素，以及限制流中元素的个数，同样可以达到 SubList 切片的目的。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//方式一：</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> subList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">subList</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//方式二：</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> subList <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">skip</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<h1 id="java-容器之-map"><a class="markdownIt-Anchor" href="#java-容器之-map">#</a> Java 容器之 Map</h1>
<blockquote>
<p><strong>📦 本文以及示例源码已归档在 <a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/">javacore(opens new window)</a></strong></p>
</blockquote>
<ul>
<li>\1. Map 简介
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-map.html#11-map-%E6%9E%B6%E6%9E%84">1.1. Map 架构</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-map.html#12-map-%E6%8E%A5%E5%8F%A3">1.2. Map 接口</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-map.html#13-mapentry-%E6%8E%A5%E5%8F%A3">1.3. Map.Entry 接口</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-map.html#14-abstractmap-%E6%8A%BD%E8%B1%A1%E7%B1%BB">1.4. AbstractMap 抽象类</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-map.html#15-sortedmap-%E6%8E%A5%E5%8F%A3">1.5. SortedMap 接口</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-map.html#16-navigablemap-%E6%8E%A5%E5%8F%A3">1.6. NavigableMap 接口</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-map.html#17-dictionary-%E6%8A%BD%E8%B1%A1%E7%B1%BB">1.7. Dictionary 抽象类</a></li>
</ul>
</li>
<li>\2. HashMap 类
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-map.html#21-hashmap-%E8%A6%81%E7%82%B9">2.1. HashMap 要点</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-map.html#22-hashmap-%E5%8E%9F%E7%90%86">2.2. HashMap 原理</a></li>
</ul>
</li>
<li>\3. LinkedHashMap 类
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-map.html#31-linkedhashmap-%E8%A6%81%E7%82%B9">3.1. LinkedHashMap 要点</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-map.html#32-linkedhashmap-%E8%A6%81%E7%82%B9">3.2. LinkedHashMap 要点</a></li>
</ul>
</li>
<li>\4. TreeMap 类
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-map.html#41-treemap-%E8%A6%81%E7%82%B9">4.1. TreeMap 要点</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-map.html#42-treemap-%E5%8E%9F%E7%90%86">4.2. TreeMap 原理</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-map.html#43-remove-%E6%96%B9%E6%B3%95">4.3. remove 方法</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-map.html#44-treemap-%E7%A4%BA%E4%BE%8B">4.4. TreeMap 示例</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-map.html#5-weakhashmap">5. WeakHashMap</a></li>
<li>\6. 总结
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-map.html#61-map-%E7%AE%80%E4%BB%8B">6.1. Map 简介</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-map.html#62-hashmap">6.2. HashMap</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-map.html#63-%E5%85%B6%E4%BB%96-map">6.3. 其他 Map</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-map.html#7-%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">7. 参考资料</a></li>
</ul>
<h2 id="-396"><a class="markdownIt-Anchor" href="#-396">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-map.html#_1-map-%E7%AE%80%E4%BB%8B">#</a>1. Map 简介</h2>
<h3 id="-397"><a class="markdownIt-Anchor" href="#-397">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-map.html#_1-1-map-%E6%9E%B6%E6%9E%84">#</a>1.1. Map 架构</h3>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/Map-diagrams.png" alt="img"></p>
<p>Map 家族主要成员功能如下：</p>
<ul>
<li><code>Map</code>  是 Map 容器家族的祖先，Map 是一个用于保存键值对 (key-value) 的接口。<strong>Map 中不能包含重复的键；每个键最多只能映射到一个值。</strong></li>
<li><code>AbstractMap</code>  继承了  <code>Map</code>  的抽象类，它实现了  <code>Map</code>  中的核心 API。其它  <code>Map</code>  的实现类可以通过继承  <code>AbstractMap</code>  来减少重复编码。</li>
<li><code>SortedMap</code>  继承了  <code>Map</code>  的接口。 <code>SortedMap</code>  中的内容是排序的键值对，排序的方法是通过实现比较器 ( <code>Comparator</code> ) 完成的。</li>
<li><code>NavigableMap</code>  继承了  <code>SortedMap</code>  的接口。相比于  <code>SortedMap</code> ， <code>NavigableMap</code>  有一系列的 “导航” 方法；如 &quot;获取大于 / 等于某对象的键值对&quot;、“获取小于 / 等于某对象的键值对” 等等。</li>
<li><code>HashMap</code>  继承了  <code>AbstractMap</code> ，但没实现  <code>NavigableMap</code>  接口。 <code>HashMap</code>  的主要作用是储存无序的键值对，而  <code>Hash</code>  也体现了它的查找效率很高。 <code>HashMap</code>  是使用最广泛的  <code>Map</code> 。</li>
<li><code>Hashtable</code>  虽然没有继承  <code>AbstractMap</code> ，但它继承了  <code>Dictionary</code> （ <code>Dictionary</code>  也是键值对的接口），而且也实现  <code>Map</code>  接口。因此， <code>Hashtable</code>  的主要作用是储存无序的键值对。和 HashMap 相比， <code>Hashtable</code>  在它的主要方法中使用  <code>synchronized</code>  关键字修饰，来保证线程安全。但是，由于它的锁粒度太大，非常影响读写速度，所以，现代 Java 程序几乎不会使用  <code>Hashtable</code>  ，如果需要保证线程安全，一般会用  <code>ConcurrentHashMap</code>  来替代。</li>
<li><code>TreeMap</code>  继承了  <code>AbstractMap</code> ，且实现了  <code>NavigableMap</code>  接口。 <code>TreeMap</code>  的主要作用是储存有序的键值对，排序依据根据元素类型的  <code>Comparator</code>  而定。</li>
<li><code>WeakHashMap</code>  继承了  <code>AbstractMap</code> 。 <code>WeakHashMap</code>  的键是<strong>弱引用</strong> （即  <code>WeakReference</code> ），它的主要作用是当 GC 内存不足时，会自动将  <code>WeakHashMap</code>  中的 key 回收，这避免了  <code>WeakHashMap</code>  的内存空间无限膨胀。很明显， <code>WeakHashMap</code>  适用于作为缓存。</li>
</ul>
<h3 id="-398"><a class="markdownIt-Anchor" href="#-398">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-map.html#_1-2-map-%E6%8E%A5%E5%8F%A3">#</a>1.2. Map 接口</h3>
<p>Map 的定义如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Map 是一个用于保存键值对 (key-value) 的接口。<strong>Map 中不能包含重复的键；每个键最多只能映射到一个值。</strong></p>
<p>Map 接口提供三种  <code>Collection</code>  视图，允许以<strong>键集</strong>、<strong>值集</strong>或<strong>键 - 值映射关系集</strong>的形式访问数据。</p>
<p>Map 有些实现类，可以有序的保存元素，如  <code>TreeMap</code> ；另一些实现类则不保证顺序，如  <code>HashMap</code>  类。</p>
<p>Map 的实现类应该提供 2 个 “标准的” 构造方法：</p>
<ul>
<li>void（无参数）构造方法，用于创建空 Map；</li>
<li>带有单个 Map 类型参数的构造方法，用于创建一个与其参数具有相同键 - 值映射关系的新 Map。</li>
</ul>
<p>实际上，后一个构造方法允许用户复制任意 Map，生成所需类的一个等价 Map。尽管无法强制执行此建议（因为接口不能包含构造方法），但是 JDK 中所有通用的 Map 实现都遵从它。</p>
<h3 id="-399"><a class="markdownIt-Anchor" href="#-399">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-map.html#_1-3-map-entry-%E6%8E%A5%E5%8F%A3">#</a>1.3. Map.Entry 接口</h3>
<p><code>Map.Entry</code>  一般用于通过迭代器（ <code>Iterator</code> ）访问问  <code>Map</code> 。</p>
<p><code>Map.Entry</code>  是 Map 中内部的一个接口， <code>Map.Entry</code>  代表了 <strong>键值对</strong> 实体，Map 通过  <code>entrySet()</code>  获取  <code>Map.Entry</code>  集合，从而通过该集合实现对键值对的操作。</p>
<h3 id="-400"><a class="markdownIt-Anchor" href="#-400">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-map.html#_1-4-abstractmap-%E6%8A%BD%E8%B1%A1%E7%B1%BB">#</a>1.4. AbstractMap 抽象类</h3>
<p><code>AbstractMap</code>  的定义如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token keyword">implements</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><code>AbstractMap</code>  抽象类提供了  <code>Map</code>  接口的核心实现，以最大限度地减少实现  <code>Map</code>  接口所需的工作。</p>
<p>要实现不可修改的 Map，编程人员只需扩展此类并提供  <code>entrySet()</code>  方法的实现即可，该方法将返回  <code>Map</code>  的映射关系 Set 视图。通常，返回的 set 将依次在  <code>AbstractSet</code>  上实现。此 Set 不支持  <code>add()</code>  或  <code>remove()</code>  方法，其迭代器也不支持  <code>remove()</code>  方法。</p>
<p>要实现可修改的  <code>Map</code> ，编程人员必须另外重写此类的  <code>put</code>  方法（否则将抛出  <code>UnsupportedOperationException</code> ）， <code>entrySet().iterator()</code>  返回的迭代器也必须另外实现其  <code>remove()</code>  方法。</p>
<h3 id="-401"><a class="markdownIt-Anchor" href="#-401">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-map.html#_1-5-sortedmap-%E6%8E%A5%E5%8F%A3">#</a>1.5. SortedMap 接口</h3>
<p><code>SortedMap</code>  的定义如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SortedMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><code>SortedMap</code>  继承了  <code>Map</code>  ，它是一个有序的  <code>Map</code> 。</p>
<p><code>SortedMap</code>  的排序方式有两种：<strong>自然排序</strong>或者<strong>用户指定比较器</strong>。<strong>插入有序  <code>SortedMap</code>  的所有元素都必须实现  <code>Comparable</code>  接口（或者被指定的比较器所接受）</strong>。</p>
<p>另外，所有  <code>SortedMap</code>  实现类都应该提供 4 个 “标准” 构造方法：</p>
<ol>
<li><code>void</code> （无参数）构造方法，它创建一个空的有序  <code>Map</code> ，按照键的自然顺序进行排序。</li>
<li>带有一个  <code>Comparator</code>  类型参数的构造方法，它创建一个空的有序  <code>Map</code> ，根据指定的比较器进行排序。</li>
<li>带有一个  <code>Map</code>  类型参数的构造方法，它创建一个新的有序  <code>Map</code> ，其键 - 值映射关系与参数相同，按照键的自然顺序进行排序。</li>
<li>带有一个  <code>SortedMap</code>  类型参数的构造方法，它创建一个新的有序  <code>Map</code> ，其键 - 值映射关系和排序方法与输入的有序 Map 相同。无法保证强制实施此建议，因为接口不能包含构造方法。</li>
</ol>
<h3 id="-402"><a class="markdownIt-Anchor" href="#-402">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-map.html#_1-6-navigablemap-%E6%8E%A5%E5%8F%A3">#</a>1.6. NavigableMap 接口</h3>
<p><code>NavigableMap</code>  的定义如下：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">public interface NavigableMap&lt;K,V> extends SortedMap&lt;K,V> &#123; &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><code>NavigableMap</code>  继承了  <code>SortedMap</code>  ，它提供了丰富的查找方法。</p>
<p>NavigableMap 分别提供了获取 “键”、“键 - 值对”、“键集”、“键 - 值对集” 的相关方法。</p>
<p><code>NavigableMap</code>  提供的功能可以分为 4 类：</p>
<ul>
<li>
<p>获取键 - 值对</p>
<ul>
<li><code>lowerEntry</code> 、 <code>floorEntry</code> 、 <code>ceilingEntry</code>  和  <code>higherEntry</code>  方法，它们分别返回与小于、小于等于、大于等于、大于给定键的键关联的 Map.Entry 对象。</li>
<li><code>firstEntry</code> 、 <code>pollFirstEntry</code> 、 <code>lastEntry</code>  和  <code>pollLastEntry</code>  方法，它们返回和 / 或移除最小和最大的映射关系（如果存在），否则返回 null。</li>
</ul>
</li>
<li>
<p>获取键</p>
<p>。这个和第 1 类比较类似。</p>
<ul>
<li><code>lowerKey</code> 、 <code>floorKey</code> 、 <code>ceilingKey</code>  和  <code>higherKey</code>  方法，它们分别返回与小于、小于等于、大于等于、大于给定键的键。</li>
</ul>
</li>
<li>
<p>获取键的集合</p>
<ul>
<li><code>navigableKeySet</code> 、 <code>descendingKeySet</code>  分别获取正序 / 反序的键集。</li>
</ul>
</li>
<li>
<p><strong>获取键 - 值对的子集</strong></p>
</li>
</ul>
<h3 id="-403"><a class="markdownIt-Anchor" href="#-403">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-map.html#_1-7-dictionary-%E6%8A%BD%E8%B1%A1%E7%B1%BB">#</a>1.7. Dictionary 抽象类</h3>
<p><code>Dictionary</code>  的定义如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Dictionary</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><code>Dictionary</code>  是 JDK 1.0 定义的操作键值对的抽象类，它包括了操作键值对的基本方法。</p>
<h2 id="-404"><a class="markdownIt-Anchor" href="#-404">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-map.html#_2-hashmap-%E7%B1%BB">#</a>2. HashMap 类</h2>
<p><code>HashMap</code>  类是最常用的  <code>Map</code> 。</p>
<h3 id="-405"><a class="markdownIt-Anchor" href="#-405">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-map.html#_2-1-hashmap-%E8%A6%81%E7%82%B9">#</a>2.1. HashMap 要点</h3>
<p>从  <code>HashMap</code>  的命名，也可以看出：<strong> <code>HashMap</code>  以散列方式存储键值对</strong>。</p>
<p><strong> <code>HashMap</code>  允许使用空值和空键</strong>。（ <code>HashMap</code>  类大致等同于  <code>Hashtable</code> ，除了它是不同步的并且允许为空值。）这个类不保序；特别是，它的元素顺序可能会随着时间的推移变化。</p>
<p><strong> <code>HashMap</code>  有两个影响其性能的参数：初始容量和负载因子</strong>。</p>
<ul>
<li>容量是哈希表中桶的数量，初始容量就是哈希表创建时的容量。</li>
<li>加载因子是散列表在其容量自动扩容之前被允许的最大饱和量。当哈希表中的 entry 数量超过负载因子和当前容量的乘积时，散列表就会被重新映射（即重建内部数据结构），一般散列表大约是存储桶数量的两倍。</li>
</ul>
<p>通常，默认加载因子（0.75）在时间和空间成本之间提供了良好的平衡。较高的值会减少空间开销，但会增加查找成本（反映在大部分  <code>HashMap</code>  类的操作中，包括  <code>get</code>  和  <code>put</code> ）。在设置初始容量时，应考虑映射中的条目数量及其负载因子，以尽量减少重新运行操作的次数。如果初始容量大于最大入口数除以负载因子，则不会发生重新刷新操作。</p>
<p>如果许多映射要存储在  <code>HashMap</code>  实例中，使用足够大的容量创建映射将允许映射存储的效率高于根据需要执行自动重新散列以增长表。请注意，使用多个具有相同  <code>hashCode()</code>  的密钥是降低任何散列表性能的一个可靠方法。为了改善影响，当键是  <code>Comparable</code>  时，该类可以使用键之间的比较顺序来帮助断开关系。</p>
<p><code>HashMap</code>  不是线程安全的。</p>
<h3 id="-406"><a class="markdownIt-Anchor" href="#-406">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-map.html#_2-2-hashmap-%E5%8E%9F%E7%90%86">#</a>2.2. HashMap 原理</h3>
<h4 id="-407"><a class="markdownIt-Anchor" href="#-407">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-map.html#hashmap-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84">#</a>HashMap 数据结构</h4>
<p><code>HashMap</code>  的核心字段：</p>
<ul>
<li><code>table</code>  -  <code>HashMap</code>  使用一个  <code>Node&lt;K,V&gt;[]</code>  类型的数组  <code>table</code>  来储存元素。</li>
<li><code>size</code>  - 初始容量。 初始为 16，每次容量不够自动扩容</li>
<li><code>loadFactor</code>  - 负载因子。自动扩容之前被允许的最大饱和量，默认 0.75。</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span>
    <span class="token keyword">implements</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">,</span> <span class="token class-name">Cloneable</span><span class="token punctuation">,</span> <span class="token class-name">Serializable</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">// 该表在初次使用时初始化，并根据需要调整大小。分配时，长度总是2的幂。</span>
    <span class="token keyword">transient</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> table<span class="token punctuation">;</span>
    <span class="token comment">// 保存缓存的 entrySet()。请注意，AbstractMap 字段用于 keySet() 和 values()。</span>
    <span class="token keyword">transient</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span><span class="token punctuation">></span></span> entrySet<span class="token punctuation">;</span>
    <span class="token comment">// map 中的键值对数</span>
    <span class="token keyword">transient</span> <span class="token keyword">int</span> size<span class="token punctuation">;</span>
    <span class="token comment">// 这个HashMap被结构修改的次数结构修改是那些改变HashMap中的映射数量或者修改其内部结构（例如，重新散列）的修改。</span>
    <span class="token keyword">transient</span> <span class="token keyword">int</span> modCount<span class="token punctuation">;</span>
    <span class="token comment">// 下一个调整大小的值（容量*加载因子）。</span>
    <span class="token keyword">int</span> threshold<span class="token punctuation">;</span>
    <span class="token comment">// 散列表的加载因子</span>
    <span class="token keyword">final</span> <span class="token keyword">float</span> loadFactor<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-408"><a class="markdownIt-Anchor" href="#-408">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-map.html#hashmap-%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95">#</a>HashMap 构造方法</h4>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 默认加载因子0.75</span>
<span class="token keyword">public</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token keyword">int</span> initialCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 默认加载因子0.75；以 initialCapacity 初始化容量</span>
<span class="token keyword">public</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token keyword">int</span> initialCapacity<span class="token punctuation">,</span> <span class="token keyword">float</span> loadFactor<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 以 initialCapacity 初始化容量；以 loadFactor 初始化加载因子</span>
<span class="token keyword">public</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">V</span><span class="token punctuation">></span></span> m<span class="token punctuation">)</span> <span class="token comment">// 默认加载因子0.75</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-409"><a class="markdownIt-Anchor" href="#-409">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-map.html#put-%E6%96%B9%E6%B3%95%E7%9A%84%E5%AE%9E%E7%8E%B0">#</a>put 方法的实现</h4>
<p>put 方法大致的思路为：</p>
<ul>
<li>对 key 的  <code>hashCode()</code>  做 hash 计算，然后根据 hash 值再计算 Node 的存储位置；</li>
<li>如果没有哈希碰撞，直接放到桶里；如果有哈希碰撞，以链表的形式存在桶后。</li>
<li>如果哈希碰撞导致链表过长 (大于等于  <code>TREEIFY_THRESHOLD</code> ，数值为 8)，就把链表转换成红黑树；</li>
<li>如果节点已经存在就替换旧值</li>
<li>桶数量超过容量 * 负载因子（即 load factor * current capacity），HashMap 调用  <code>resize</code>  自动扩容一倍</li>
</ul>
<p>具体代码的实现如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">V</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">putVal</span><span class="token punctuation">(</span><span class="token function">hash</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// hashcode 无符号位移 16 位</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">hash</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> h<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token punctuation">(</span>h <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>h <span class="token operator">>>></span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">final</span> <span class="token class-name">V</span> <span class="token function">putVal</span><span class="token punctuation">(</span><span class="token keyword">int</span> hash<span class="token punctuation">,</span> <span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">,</span> <span class="token keyword">boolean</span> onlyIfAbsent<span class="token punctuation">,</span>
                   <span class="token keyword">boolean</span> evict<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab<span class="token punctuation">;</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> p<span class="token punctuation">;</span> <span class="token keyword">int</span> n<span class="token punctuation">,</span> i<span class="token punctuation">;</span>
    <span class="token comment">// tab 为空则创建</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tab <span class="token operator">=</span> table<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        n <span class="token operator">=</span> <span class="token punctuation">(</span>tab <span class="token operator">=</span> <span class="token function">resize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token comment">// 计算 index，并对 null 做处理</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p <span class="token operator">=</span> tab<span class="token punctuation">[</span>i <span class="token operator">=</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> hash<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">newNode</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> e<span class="token punctuation">;</span> <span class="token class-name">K</span> k<span class="token punctuation">;</span>
        <span class="token comment">// 节点存在</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>hash <span class="token operator">==</span> hash <span class="token operator">&amp;&amp;</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span>k <span class="token operator">=</span> p<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token operator">||</span> <span class="token punctuation">(</span>key <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            e <span class="token operator">=</span> p<span class="token punctuation">;</span>
        <span class="token comment">// 该链为树</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token keyword">instanceof</span> <span class="token class-name">TreeNode</span><span class="token punctuation">)</span>
            e <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">)</span>p<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putTreeVal</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> tab<span class="token punctuation">,</span> hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 该链为链表</span>
        <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> binCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token operator">++</span>binCount<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">=</span> p<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    p<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token function">newNode</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>binCount <span class="token operator">>=</span> TREEIFY_THRESHOLD <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// -1 for 1st</span>
                        <span class="token function">treeifyBin</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> hash<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>hash <span class="token operator">==</span> hash <span class="token operator">&amp;&amp;</span>
                    <span class="token punctuation">(</span><span class="token punctuation">(</span>k <span class="token operator">=</span> e<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token operator">||</span> <span class="token punctuation">(</span>key <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                p <span class="token operator">=</span> e<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// 写入</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// existing mapping for key</span>
            <span class="token class-name">V</span> oldValue <span class="token operator">=</span> e<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>onlyIfAbsent <span class="token operator">||</span> oldValue <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                e<span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
            <span class="token function">afterNodeAccess</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> oldValue<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token operator">++</span>modCount<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>size <span class="token operator">></span> threshold<span class="token punctuation">)</span>
        <span class="token function">resize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">afterNodeInsertion</span><span class="token punctuation">(</span>evict<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>为什么计算 hash 使用 hashcode 无符号位移 16 位。</p>
<p>假设要添加两个对象 a 和 b，如果数组长度是 16，这时对象 a 和 b 通过公式 (n - 1) &amp; hash 运算，也就是 (16-1)＆a.hashCode 和 (16-1)＆b.hashCode，15 的二进制为 0000000000000000000000000001111，假设对象 A 的 hashCode 为 1000010001110001000001111000000，对象 B 的 hashCode 为 0111011100111000101000010100000，你会发现上述与运算结果都是 0。这样的哈希结果就太让人失望了，很明显不是一个好的哈希算法。</p>
<p>但如果我们将 hashCode 值右移 16 位（h &gt;&gt;&gt; 16 代表无符号右移 16 位），也就是取 int 类型的一半，刚好可以将该二进制数对半切开，并且使用位异或运算（如果两个数对应的位置相反，则结果为 1，反之为 0），这样的话，就能避免上面的情况发生。这就是 hash () 方法的具体实现方式。<strong>简而言之，就是尽量打乱 hashCode 真正参与运算的低 16 位。</strong></p>
<h4 id="-410"><a class="markdownIt-Anchor" href="#-410">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-map.html#get-%E6%96%B9%E6%B3%95%E7%9A%84%E5%AE%9E%E7%8E%B0">#</a>get 方法的实现</h4>
<p>在理解了 put 之后，get 就很简单了。大致思路如下：</p>
<ul>
<li>对 key 的 hashCode () 做 hash 计算，然后根据 hash 值再计算桶的 index</li>
<li>如果桶中的第一个节点命中，直接返回；</li>
<li>如果有冲突，则通过  <code>key.equals(k)</code>  去查找对应的 entry
<ul>
<li>若为树，则在红黑树中通过 key.equals (k) 查找，O (logn)；</li>
<li>若为链表，则在链表中通过 key.equals (k) 查找，O (n)。</li>
</ul>
</li>
</ul>
<p>具体代码的实现如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">V</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> e<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>e <span class="token operator">=</span> <span class="token function">getNode</span><span class="token punctuation">(</span><span class="token function">hash</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> e<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">final</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token function">getNode</span><span class="token punctuation">(</span><span class="token keyword">int</span> hash<span class="token punctuation">,</span> <span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab<span class="token punctuation">;</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> first<span class="token punctuation">,</span> e<span class="token punctuation">;</span> <span class="token keyword">int</span> n<span class="token punctuation">;</span> <span class="token class-name">K</span> k<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tab <span class="token operator">=</span> table<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span>first <span class="token operator">=</span> tab<span class="token punctuation">[</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> hash<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 直接命中</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>first<span class="token punctuation">.</span>hash <span class="token operator">==</span> hash <span class="token operator">&amp;&amp;</span> <span class="token comment">// always check first node</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span>k <span class="token operator">=</span> first<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token operator">||</span> <span class="token punctuation">(</span>key <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> first<span class="token punctuation">;</span>
        <span class="token comment">// 未命中</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">=</span> first<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 在树中 get</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>first <span class="token keyword">instanceof</span> <span class="token class-name">TreeNode</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">)</span>first<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTreeNode</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 在链表中 get</span>
            <span class="token keyword">do</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>hash <span class="token operator">==</span> hash <span class="token operator">&amp;&amp;</span>
                    <span class="token punctuation">(</span><span class="token punctuation">(</span>k <span class="token operator">=</span> e<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token operator">||</span> <span class="token punctuation">(</span>key <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span> e<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-411"><a class="markdownIt-Anchor" href="#-411">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-map.html#hash-%E6%96%B9%E6%B3%95%E7%9A%84%E5%AE%9E%E7%8E%B0">#</a>hash 方法的实现</h4>
<p>HashMap <strong>计算桶下标（index）公式： <code>key.hashCode() ^ (h &gt;&gt;&gt; 16)</code> </strong>。</p>
<p>下面针对这个公式来详细讲解。</p>
<p>在  <code>get</code>  和  <code>put</code>  的过程中，计算下标时，先对  <code>hashCode</code>  进行  <code>hash</code>  操作，然后再通过  <code>hash</code>  值进一步计算下标，如下图所示：</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/cs/java/javacore/container/HashMap-hash.png" alt="img"></p>
<p>在对  <code>hashCode()</code>  计算 hash 时具体实现是这样的：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">hash</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> h<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token punctuation">(</span>h <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>h <span class="token operator">>>></span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到这个方法大概的作用就是：高 16bit 不变，低 16bit 和高 16bit 做了一个异或。</p>
<p>在设计 hash 方法时，因为目前的 table 长度 n 为 2 的幂，而计算下标的时候，是这样实现的 (使用  <code>&amp;</code>  位操作，而非  <code>%</code>  求余)：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> hash<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>设计者认为这方法很容易发生碰撞。为什么这么说呢？不妨思考一下，在 n - 1 为 15 (0x1111) 时，其实散列真正生效的只是低 4bit 的有效位，当然容易碰撞了。</p>
<p>因此，设计者想了一个顾全大局的方法 (综合考虑了速度、作用、质量)，就是把高 16bit 和低 16bit 异或了一下。设计者还解释到因为现在大多数的 hashCode 的分布已经很不错了，就算是发生了碰撞也用 O (logn) 的 tree 去做了。仅仅异或一下，既减少了系统的开销，也不会造成的因为高位没有参与下标的计算 (table 长度比较小时)，从而引起的碰撞。</p>
<p>如果还是产生了频繁的碰撞，会发生什么问题呢？作者注释说，他们使用树来处理频繁的碰撞 (we use trees to handle large sets of collisions in bins)，在 <a target="_blank" rel="noopener" href="http://openjdk.java.net/jeps/180">JEP-180 (opens new window)</a> 中，描述了这个问题：</p>
<blockquote>
<p>Improve the performance of java.util.HashMap under high hash-collision conditions by using balanced trees rather than linked lists to store map entries. Implement the same improvement in the LinkedHashMap class.</p>
</blockquote>
<p>之前已经提过，在获取 HashMap 的元素时，基本分两步：</p>
<ol>
<li>首先根据 hashCode () 做 hash，然后确定 bucket 的 index；</li>
<li>如果 bucket 的节点的 key 不是我们需要的，则通过 keys.equals () 在链中找。</li>
</ol>
<p>在 JDK8 之前的实现中是用链表解决冲突的，在产生碰撞的情况下，进行 get 时，两步的时间复杂度是 O (1)+O (n)。因此，当碰撞很厉害的时候 n 很大，O (n) 的速度显然是影响速度的。</p>
<p>因此在 JDK8 中，利用红黑树替换链表，这样复杂度就变成了 O (1)+O (logn) 了，这样在 n 很大的时候，能够比较理想的解决这个问题，在 JDK8：HashMap 的性能提升一文中有性能测试的结果。</p>
<h4 id="-412"><a class="markdownIt-Anchor" href="#-412">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-map.html#resize-%E7%9A%84%E5%AE%9E%E7%8E%B0">#</a>resize 的实现</h4>
<p>当  <code>put</code>  时，如果发现目前的 bucket 占用程度已经超过了 Load Factor 所希望的比例，那么就会发生 resize。在 resize 的过程，简单的说就是把 bucket 扩充为 2 倍，之后重新计算 index，把节点再放到新的 bucket 中。</p>
<p>当超过限制的时候会 resize，然而又因为我们使用的是 2 次幂的扩展 (指长度扩为原来 2 倍)，所以，元素的位置要么是在原位置，要么是在原位置再移动 2 次幂的位置。</p>
<p>怎么理解呢？例如我们从 16 扩展为 32 时，具体的变化如下所示：</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/HashMap-resize-01.png" alt="img"></p>
<p>因此元素在重新计算 hash 之后，因为 n 变为 2 倍，那么 n-1 的 mask 范围在高位多 1bit (红色)，因此新的 index 就会发生这样的变化：</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/cs/java/javacore/container/HashMap-resize-02.png" alt="img"></p>
<p>因此，我们在扩充 HashMap 的时候，不需要重新计算 hash，只需要看看原来的 hash 值新增的那个 bit 是 1 还是 0 就好了，是 0 的话索引没变，是 1 的话索引变成 “原索引 + oldCap”。可以看看下图为 16 扩充为 32 的 resize 示意图：</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/HashMap-resize-03.png" alt="img"></p>
<p>这个设计确实非常的巧妙，既省去了重新计算 hash 值的时间，而且同时，由于新增的 1bit 是 0 还是 1 可以认为是随机的，因此 resize 的过程，均匀的把之前的冲突的节点分散到新的 bucket 了。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">final</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">resize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> oldTab <span class="token operator">=</span> table<span class="token punctuation">;</span>
    <span class="token keyword">int</span> oldCap <span class="token operator">=</span> <span class="token punctuation">(</span>oldTab <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> oldTab<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">int</span> oldThr <span class="token operator">=</span> threshold<span class="token punctuation">;</span>
    <span class="token keyword">int</span> newCap<span class="token punctuation">,</span> newThr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldCap <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 超过最大值就不再扩充了，就只好随你碰撞去吧</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldCap <span class="token operator">>=</span> MAXIMUM_CAPACITY<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            threshold <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">;</span>
            <span class="token keyword">return</span> oldTab<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// 没超过最大值，就扩充为原来的 2 倍</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>newCap <span class="token operator">=</span> oldCap <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> MAXIMUM_CAPACITY <span class="token operator">&amp;&amp;</span>
                    oldCap <span class="token operator">>=</span> DEFAULT_INITIAL_CAPACITY<span class="token punctuation">)</span>
            newThr <span class="token operator">=</span> oldThr <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// double threshold</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldThr <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// initial capacity was placed in threshold</span>
        newCap <span class="token operator">=</span> oldThr<span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>               <span class="token comment">// zero initial threshold signifies using defaults</span>
        newCap <span class="token operator">=</span> DEFAULT_INITIAL_CAPACITY<span class="token punctuation">;</span>
        newThr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>DEFAULT_LOAD_FACTOR <span class="token operator">*</span> DEFAULT_INITIAL_CAPACITY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 计算新的 resize 上限</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newThr <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">float</span> ft <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>newCap <span class="token operator">*</span> loadFactor<span class="token punctuation">;</span>
        newThr <span class="token operator">=</span> <span class="token punctuation">(</span>newCap <span class="token operator">&lt;</span> MAXIMUM_CAPACITY <span class="token operator">&amp;&amp;</span> ft <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>MAXIMUM_CAPACITY <span class="token operator">?</span>
                    <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>ft <span class="token operator">:</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    threshold <span class="token operator">=</span> newThr<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"rawtypes"</span><span class="token punctuation">,</span><span class="token string">"unchecked"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
        <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> newTab <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">[</span>newCap<span class="token punctuation">]</span><span class="token punctuation">;</span>
    table <span class="token operator">=</span> newTab<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldTab <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 把每个 bucket 都移动到新的 buckets 中</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> oldCap<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> e<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">=</span> oldTab<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                oldTab<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>next <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                    newTab<span class="token punctuation">[</span>e<span class="token punctuation">.</span>hash <span class="token operator">&amp;</span> <span class="token punctuation">(</span>newCap <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">;</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">TreeNode</span><span class="token punctuation">)</span>
                    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">)</span>e<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> newTab<span class="token punctuation">,</span> j<span class="token punctuation">,</span> oldCap<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span> <span class="token punctuation">&#123;</span> <span class="token comment">// preserve order</span>
                    <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> loHead <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> loTail <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                    <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> hiHead <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> hiTail <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                    <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> next<span class="token punctuation">;</span>
                    <span class="token keyword">do</span> <span class="token punctuation">&#123;</span>
                        next <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
                        <span class="token comment">// 原索引</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>hash <span class="token operator">&amp;</span> oldCap<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>loTail <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                                loHead <span class="token operator">=</span> e<span class="token punctuation">;</span>
                            <span class="token keyword">else</span>
                                loTail<span class="token punctuation">.</span>next <span class="token operator">=</span> e<span class="token punctuation">;</span>
                            loTail <span class="token operator">=</span> e<span class="token punctuation">;</span>
                        <span class="token punctuation">&#125;</span>
                        <span class="token comment">// 原索引+oldCap</span>
                        <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>hiTail <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                                hiHead <span class="token operator">=</span> e<span class="token punctuation">;</span>
                            <span class="token keyword">else</span>
                                hiTail<span class="token punctuation">.</span>next <span class="token operator">=</span> e<span class="token punctuation">;</span>
                            hiTail <span class="token operator">=</span> e<span class="token punctuation">;</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">=</span> next<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 原索引放到bucket里</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>loTail <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        loTail<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                        newTab<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> loHead<span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                    <span class="token comment">// 原索引+oldCap放到bucket里</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>hiTail <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        hiTail<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                        newTab<span class="token punctuation">[</span>j <span class="token operator">+</span> oldCap<span class="token punctuation">]</span> <span class="token operator">=</span> hiHead<span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> newTab<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="-413"><a class="markdownIt-Anchor" href="#-413">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-map.html#_3-linkedhashmap-%E7%B1%BB">#</a>3. LinkedHashMap 类</h2>
<h3 id="-414"><a class="markdownIt-Anchor" href="#-414">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-map.html#_3-1-linkedhashmap-%E8%A6%81%E7%82%B9">#</a>3.1. LinkedHashMap 要点</h3>
<p><strong> <code>LinkedHashMap</code>  通过维护一个保存所有条目（Entry）的双向链表，保证了元素迭代的顺序（即插入顺序）</strong>。</p>
<table>
<thead>
<tr>
<th>关注点</th>
<th>结论</th>
</tr>
</thead>
<tbody>
<tr>
<td>是否允许键值对为 null</td>
<td>Key 和 Value 都允许 null</td>
</tr>
<tr>
<td>是否允许重复数据</td>
<td>Key 重复会覆盖、Value 允许重复</td>
</tr>
<tr>
<td>是否有序</td>
<td>按照元素插入顺序存储</td>
</tr>
<tr>
<td>是否线程安全</td>
<td>非线程安全</td>
</tr>
</tbody>
</table>
<h3 id="-415"><a class="markdownIt-Anchor" href="#-415">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-map.html#_3-2-linkedhashmap-%E8%A6%81%E7%82%B9">#</a>3.2. LinkedHashMap 要点</h3>
<h4 id="-416"><a class="markdownIt-Anchor" href="#-416">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-map.html#linkedhashmap-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84">#</a>LinkedHashMap 数据结构</h4>
<p><strong> <code>LinkedHashMap</code>  通过维护一对  <code>LinkedHashMap.Entry&lt;K,V&gt;</code>  类型的头尾指针，以双链表形式，保存所有数据</strong>。</p>
<p>学习过数据结构的双链表，就能理解其元素存储以及访问必然是有序的。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span>
    <span class="token keyword">extends</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span>
    <span class="token keyword">implements</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>

    <span class="token comment">// 双链表的头指针</span>
    <span class="token keyword">transient</span> <span class="token class-name">LinkedHashMap<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> head<span class="token punctuation">;</span>
    <span class="token comment">// 双链表的尾指针</span>
    <span class="token keyword">transient</span> <span class="token class-name">LinkedHashMap<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> tail<span class="token punctuation">;</span>
    <span class="token comment">// 迭代排序方法：true 表示访问顺序；false 表示插入顺序</span>
    <span class="token keyword">final</span> <span class="token keyword">boolean</span> accessOrder<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>LinkedHashMap</code>  继承了  <code>HashMap</code>  的  <code>put</code>  方法，本身没有实现  <code>put</code>  方法。</p>
<h2 id="-417"><a class="markdownIt-Anchor" href="#-417">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-map.html#_4-treemap-%E7%B1%BB">#</a>4. TreeMap 类</h2>
<h3 id="-418"><a class="markdownIt-Anchor" href="#-418">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-map.html#_4-1-treemap-%E8%A6%81%E7%82%B9">#</a>4.1. TreeMap 要点</h3>
<p><code>TreeMap</code>  基于红黑树实现。</p>
<p><code>TreeMap</code>  是有序的。它的排序规则是：根据 map 中的 key 的自然语义顺序或提供的比较器（ <code>Comparator</code> ）的自定义比较顺序。</p>
<p>TreeMap 不是线程安全的。</p>
<h3 id="-419"><a class="markdownIt-Anchor" href="#-419">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-map.html#_4-2-treemap-%E5%8E%9F%E7%90%86">#</a>4.2. TreeMap 原理</h3>
<h4 id="-420"><a class="markdownIt-Anchor" href="#-420">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-map.html#put-%E6%96%B9%E6%B3%95">#</a>put 方法</h4>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">V</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> t <span class="token operator">=</span> root<span class="token punctuation">;</span>
    <span class="token comment">// 如果根节点为 null，插入第一个节点</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">compare</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// type (and possibly null) check</span>

        root <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        size <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        modCount<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">int</span> cmp<span class="token punctuation">;</span>
    <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> parent<span class="token punctuation">;</span>
    <span class="token comment">// split comparator and comparable paths</span>
    <span class="token class-name">Comparator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">K</span><span class="token punctuation">></span></span> cpr <span class="token operator">=</span> comparator<span class="token punctuation">;</span>
    <span class="token comment">// 每个节点的左孩子节点的值小于它；右孩子节点的值大于它</span>
    <span class="token comment">// 如果有比较器，使用比较器进行比较</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cpr <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">do</span> <span class="token punctuation">&#123;</span>
            parent <span class="token operator">=</span> t<span class="token punctuation">;</span>
            cmp <span class="token operator">=</span> cpr<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> t<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cmp <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                t <span class="token operator">=</span> t<span class="token punctuation">.</span>left<span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cmp <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
                t <span class="token operator">=</span> t<span class="token punctuation">.</span>right<span class="token punctuation">;</span>
            <span class="token keyword">else</span>
                <span class="token keyword">return</span> t<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>t <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// 没有比较器，使用 key 的自然顺序进行比较</span>
    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>
            <span class="token class-name">Comparable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">K</span><span class="token punctuation">></span></span> k <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Comparable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">K</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> key<span class="token punctuation">;</span>
        <span class="token keyword">do</span> <span class="token punctuation">&#123;</span>
            parent <span class="token operator">=</span> t<span class="token punctuation">;</span>
            cmp <span class="token operator">=</span> k<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cmp <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                t <span class="token operator">=</span> t<span class="token punctuation">.</span>left<span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cmp <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
                t <span class="token operator">=</span> t<span class="token punctuation">.</span>right<span class="token punctuation">;</span>
            <span class="token keyword">else</span>
                <span class="token keyword">return</span> t<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>t <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// 通过上面的遍历未找到 key 值，则新插入节点</span>
    <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> e <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cmp <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        parent<span class="token punctuation">.</span>left <span class="token operator">=</span> e<span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        parent<span class="token punctuation">.</span>right <span class="token operator">=</span> e<span class="token punctuation">;</span>
    <span class="token comment">// 插入后，为了维持红黑树的平衡需要调整</span>
    <span class="token function">fixAfterInsertion</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    size<span class="token operator">++</span><span class="token punctuation">;</span>
    modCount<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-421"><a class="markdownIt-Anchor" href="#-421">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-map.html#get-%E6%96%B9%E6%B3%95">#</a>get 方法</h4>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">V</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> p <span class="token operator">=</span> <span class="token function">getEntry</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>p<span class="token operator">==</span><span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> p<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">final</span> <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token function">getEntry</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Offload comparator-based version for sake of performance</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>comparator <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token function">getEntryUsingComparator</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>
        <span class="token class-name">Comparable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">K</span><span class="token punctuation">></span></span> k <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Comparable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">K</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> key<span class="token punctuation">;</span>
    <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> p <span class="token operator">=</span> root<span class="token punctuation">;</span>
    <span class="token comment">// 按照二叉树搜索的方式进行搜索，搜到返回</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>p <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> cmp <span class="token operator">=</span> k<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cmp <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            p <span class="token operator">=</span> p<span class="token punctuation">.</span>left<span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cmp <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
            p <span class="token operator">=</span> p<span class="token punctuation">.</span>right<span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token keyword">return</span> p<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-422"><a class="markdownIt-Anchor" href="#-422">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-map.html#_4-3-remove-%E6%96%B9%E6%B3%95">#</a>4.3. remove 方法</h3>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">V</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> p <span class="token operator">=</span> <span class="token function">getEntry</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token class-name">V</span> oldValue <span class="token operator">=</span> p<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
    <span class="token function">deleteEntry</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> oldValue<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">deleteEntry</span><span class="token punctuation">(</span><span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> p<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    modCount<span class="token operator">++</span><span class="token punctuation">;</span>
    size<span class="token operator">--</span><span class="token punctuation">;</span>

    <span class="token comment">// 如果当前节点有左右孩子节点，使用后继节点替换要删除的节点</span>
    <span class="token comment">// If strictly internal, copy successor's element to p and then make p</span>
    <span class="token comment">// point to successor.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>left <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> p<span class="token punctuation">.</span>right <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> s <span class="token operator">=</span> <span class="token function">successor</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
        p<span class="token punctuation">.</span>key <span class="token operator">=</span> s<span class="token punctuation">.</span>key<span class="token punctuation">;</span>
        p<span class="token punctuation">.</span>value <span class="token operator">=</span> s<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
        p <span class="token operator">=</span> s<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token comment">// p has 2 children</span>

    <span class="token comment">// Start fixup at replacement node, if it exists.</span>
    <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> replacement <span class="token operator">=</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>left <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> p<span class="token punctuation">.</span>left <span class="token operator">:</span> p<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>replacement <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 要删除的节点有一个孩子节点</span>
        <span class="token comment">// Link replacement to parent</span>
        replacement<span class="token punctuation">.</span>parent <span class="token operator">=</span> p<span class="token punctuation">.</span>parent<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>parent <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            root <span class="token operator">=</span> replacement<span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> p<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>left<span class="token punctuation">)</span>
            p<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>left  <span class="token operator">=</span> replacement<span class="token punctuation">;</span>
        <span class="token keyword">else</span>
 <span class="token class-name">D</span><span class="token operator">:</span>\codes\zp\java\database\docs\redis\分布式锁<span class="token punctuation">.</span>md           p<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>right <span class="token operator">=</span> replacement<span class="token punctuation">;</span>

        <span class="token comment">// Null out links so they are OK to use by fixAfterDeletion.</span>
        p<span class="token punctuation">.</span>left <span class="token operator">=</span> p<span class="token punctuation">.</span>right <span class="token operator">=</span> p<span class="token punctuation">.</span>parent <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token comment">// Fix replacement</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>color <span class="token operator">==</span> BLACK<span class="token punctuation">)</span>
            <span class="token function">fixAfterDeletion</span><span class="token punctuation">(</span>replacement<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>parent <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// return if we are the only node.</span>
        root <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span> <span class="token comment">//  No children. Use self as phantom replacement and unlink.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>color <span class="token operator">==</span> BLACK<span class="token punctuation">)</span>
            <span class="token function">fixAfterDeletion</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>parent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> p<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>left<span class="token punctuation">)</span>
                p<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>left <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> p<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>right<span class="token punctuation">)</span>
                p<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>right <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            p<span class="token punctuation">.</span>parent <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-423"><a class="markdownIt-Anchor" href="#-423">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-map.html#_4-4-treemap-%E7%A4%BA%E4%BE%8B">#</a>4.4. TreeMap 示例</h3>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TreeMapDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> chars <span class="token operator">=</span> <span class="token string">"A B C D E F G H I J K L M N O P Q R S T U V W X Y Z"</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">TreeMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> treeMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> chars<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            treeMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> chars<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>treeMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Integer</span> low <span class="token operator">=</span> treeMap<span class="token punctuation">.</span><span class="token function">firstKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Integer</span> high <span class="token operator">=</span> treeMap<span class="token punctuation">.</span><span class="token function">lastKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>low<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>high<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> it <span class="token operator">=</span> treeMap<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">6</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> low <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> high <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>low<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>high<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>treeMap<span class="token punctuation">.</span><span class="token function">subMap</span><span class="token punctuation">(</span>low<span class="token punctuation">,</span> high<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>treeMap<span class="token punctuation">.</span><span class="token function">headMap</span><span class="token punctuation">(</span>high<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>treeMap<span class="token punctuation">.</span><span class="token function">tailMap</span><span class="token punctuation">(</span>low<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="-424"><a class="markdownIt-Anchor" href="#-424">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-map.html#_5-weakhashmap">#</a>5. WeakHashMap</h2>
<p>WeakHashMap 的定义如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WeakHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span>
    <span class="token keyword">extends</span> <span class="token class-name">AbstractMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span>
    <span class="token keyword">implements</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>WeakHashMap 继承了 AbstractMap，实现了 Map 接口。</p>
<p>和 HashMap 一样，WeakHashMap 也是一个散列表，它存储的内容也是键值对 (key-value) 映射，而且键和值都可以是 null。</p>
<p>不过 WeakHashMap 的键是<strong>弱键</strong>。在 WeakHashMap 中，当某个键不再被其它对象引用，会被从 WeakHashMap 中被自动移除。更精确地说，对于一个给定的键，其映射的存在并不阻止垃圾回收器对该键的丢弃，这就使该键成为可终止的，被终止，然后被回收。某个键被终止时，它对应的键值对也就从映射中有效地移除了。</p>
<p>这个<strong>弱键</strong>的原理呢？大致上就是，通过 WeakReference 和 ReferenceQueue 实现的。</p>
<p>WeakHashMap 的 key 是<strong>弱键</strong>，即是 WeakReference 类型的；ReferenceQueue 是一个队列，它会保存被 GC 回收的<strong>弱键</strong>。实现步骤是：</p>
<ol>
<li>新建 WeakHashMap，将<strong>键值对</strong>添加到 WeakHashMap 中。实际上，WeakHashMap 是通过数组 table 保存 Entry (键值对)；每一个 Entry 实际上是一个单向链表，即 Entry 是键值对链表。</li>
<li>当某<strong>弱键</strong>不再被其它对象引用，并被 GC 回收时。在 GC 回收该<strong>弱键</strong>时，这个<strong>弱键</strong>也同时会被添加到 ReferenceQueue (queue) 队列中。</li>
<li>当下一次我们需要操作 WeakHashMap 时，会先同步 table 和 queue。table 中保存了全部的键值对，而 queue 中保存被 GC 回收的键值对；同步它们，就是删除 table 中被 GC 回收的键值对。</li>
</ol>
<p>这就是<strong>弱键</strong>如何被自动从 WeakHashMap 中删除的步骤了。</p>
<p>和 HashMap 一样，WeakHashMap 是不同步的。可以使用 Collections.synchronizedMap 方法来构造同步的 WeakHashMap。</p>
<hr>
<h1 id="java-容器之-set"><a class="markdownIt-Anchor" href="#java-容器之-set">#</a> Java 容器之 Set</h1>
<blockquote>
<p><strong>📦 本文以及示例源码已归档在 <a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/">javacore(opens new window)</a></strong></p>
</blockquote>
<ul>
<li>\1. Set 简介
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-set.html#11-set-%E6%8E%A5%E5%8F%A3">1.1. Set 接口</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-set.html#12-sortedset-%E6%8E%A5%E5%8F%A3">1.2. SortedSet 接口</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-set.html#13-navigableset-%E6%8E%A5%E5%8F%A3">1.3. NavigableSet 接口</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-set.html#14-abstractset-%E6%8A%BD%E8%B1%A1%E7%B1%BB">1.4. AbstractSet 抽象类</a></li>
</ul>
</li>
<li>\2. HashSet 类
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-set.html#21-hashset-%E8%A6%81%E7%82%B9">2.1. HashSet 要点</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-set.html#22-hashset-%E5%8E%9F%E7%90%86">2.2. HashSet 原理</a></li>
</ul>
</li>
<li>\3. TreeSet 类
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-set.html#31-treeset-%E8%A6%81%E7%82%B9">3.1. TreeSet 要点</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-set.html#32-treeset-%E6%BA%90%E7%A0%81">3.2. TreeSet 源码</a></li>
</ul>
</li>
<li>\4. LinkedHashSet 类
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-set.html#41-linkedhashset-%E8%A6%81%E7%82%B9">4.1. LinkedHashSet 要点</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-set.html#42-linkedhashset-%E5%8E%9F%E7%90%86">4.2. LinkedHashSet 原理</a></li>
</ul>
</li>
<li>\5. EnumSet 类
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-set.html#51-enumset-%E8%A6%81%E7%82%B9">5.1. EnumSet 要点</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-set.html#6-%E8%A6%81%E7%82%B9%E6%80%BB%E7%BB%93">6. 要点总结</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-set.html#7-%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">7. 参考资料</a></li>
</ul>
<h2 id="-425"><a class="markdownIt-Anchor" href="#-425">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-set.html#_1-set-%E7%AE%80%E4%BB%8B">#</a>1. Set 简介</h2>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/Set-diagrams.png" alt="img"></p>
<p>Set 家族成员简介：</p>
<ul>
<li><code>Set</code>  继承了  <code>Collection</code>  的接口。实际上  <code>Set</code>  就是  <code>Collection</code> ，只是行为略有不同： <code>Set</code>  集合不允许有重复元素。</li>
<li><code>SortedSet</code>  继承了  <code>Set</code>  的接口。 <code>SortedSet</code>  中的内容是排序的唯一值，排序的方法是通过比较器 (Comparator)。</li>
<li><code>NavigableSet</code>  继承了  <code>SortedSet</code>  的接口。它提供了丰富的查找方法：如 &quot;获取大于 / 等于某值的元素&quot;、“获取小于 / 等于某值的元素” 等等。</li>
<li><code>AbstractSet</code>  是一个抽象类，它继承于  <code>AbstractCollection</code> ， <code>AbstractCollection</code>  实现了 Set 中的绝大部分方法，为实现  <code>Set</code>  的实例类提供了便利。</li>
<li><code>HashSet</code>  类依赖于  <code>HashMap</code> ，它实际上是通过  <code>HashMap</code>  实现的。 <code>HashSet</code>  中的元素是无序的、散列的。</li>
<li><code>TreeSet</code>  类依赖于  <code>TreeMap</code> ，它实际上是通过  <code>TreeMap</code>  实现的。 <code>TreeSet</code>  中的元素是有序的，它是按自然排序或者用户指定比较器排序的 Set。</li>
<li><code>LinkedHashSet</code>  是按插入顺序排序的 Set。</li>
<li><code>EnumSet</code>  是只能存放 Emum 枚举类型的 Set。</li>
</ul>
<h3 id="-426"><a class="markdownIt-Anchor" href="#-426">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-set.html#_1-1-set-%E6%8E%A5%E5%8F%A3">#</a>1.1. Set 接口</h3>
<p><code>Set</code>  继承了  <code>Collection</code>  的接口。实际上， <code>Set</code>  就是  <code>Collection</code> ，二者提供的方法完全相同。</p>
<p><code>Set</code>  接口定义如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="-427"><a class="markdownIt-Anchor" href="#-427">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-set.html#_1-2-sortedset-%E6%8E%A5%E5%8F%A3">#</a>1.2. SortedSet 接口</h3>
<p>继承了  <code>Set</code>  的接口。 <code>SortedSet</code>  中的内容是排序的唯一值，排序的方法是通过比较器 (Comparator)。</p>
<p><code>SortedSet</code>  接口定义如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SortedSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><code>SortedSet</code>  接口新扩展的方法：</p>
<ul>
<li><code>comparator</code>  - 返回 Comparator</li>
<li><code>subSet</code>  - 返回指定区间的子集</li>
<li><code>headSet</code>  - 返回小于指定元素的子集</li>
<li><code>tailSet</code>  - 返回大于指定元素的子集</li>
<li><code>first</code>  - 返回第一个元素</li>
<li><code>last</code>  - 返回最后一个元素</li>
<li>spliterator</li>
</ul>
<h3 id="-428"><a class="markdownIt-Anchor" href="#-428">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-set.html#_1-3-navigableset-%E6%8E%A5%E5%8F%A3">#</a>1.3. NavigableSet 接口</h3>
<p><code>NavigableSet</code>  继承了  <code>SortedSet</code> 。它提供了丰富的查找方法。</p>
<p><code>NavigableSet</code>  接口定义如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">NavigableSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">SortedSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><code>NavigableSet</code>  接口新扩展的方法：</p>
<ul>
<li>lower - 返回小于指定值的元素中最接近的元素</li>
<li>higher - 返回大于指定值的元素中最接近的元素</li>
<li>floor - 返回小于或等于指定值的元素中最接近的元素</li>
<li>ceiling - 返回大于或等于指定值的元素中最接近的元素</li>
<li>pollFirst - 检索并移除第一个（最小的）元素</li>
<li>pollLast - 检索并移除最后一个（最大的）元素</li>
<li>descendingSet - 返回反序排列的 Set</li>
<li>descendingIterator - 返回反序排列的 Set 的迭代器</li>
<li>subSet - 返回指定区间的子集</li>
<li>headSet - 返回小于指定元素的子集</li>
<li>tailSet - 返回大于指定元素的子集</li>
</ul>
<h3 id="-429"><a class="markdownIt-Anchor" href="#-429">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-set.html#_1-4-abstractset-%E6%8A%BD%E8%B1%A1%E7%B1%BB">#</a>1.4. AbstractSet 抽象类</h3>
<p><code>AbstractSet</code>  类提供  <code>Set</code>  接口的核心实现，以最大限度地减少实现  <code>Set</code>  接口所需的工作。</p>
<p><code>AbstractSet</code>  抽象类定义如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractCollection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token keyword">implements</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>事实上，主要的实现已经在  <code>AbstractCollection</code>  中完成。</p>
<h2 id="-430"><a class="markdownIt-Anchor" href="#-430">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-set.html#_2-hashset-%E7%B1%BB">#</a>2. HashSet 类</h2>
<p><code>HashSet</code>  类依赖于  <code>HashMap</code> ，它实际上是通过  <code>HashMap</code>  实现的。 <code>HashSet</code>  中的元素是无序的、散列的。</p>
<p><code>HashSet</code>  类定义如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span>
    <span class="token keyword">extends</span> <span class="token class-name">AbstractSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span>
    <span class="token keyword">implements</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span><span class="token punctuation">,</span> <span class="token class-name">Cloneable</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="-431"><a class="markdownIt-Anchor" href="#-431">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-set.html#_2-1-hashset-%E8%A6%81%E7%82%B9">#</a>2.1. HashSet 要点</h3>
<ul>
<li><code>HashSet</code>  通过继承  <code>AbstractSet</code>  实现了  <code>Set</code>  接口中的骨干方法。</li>
<li><code>HashSet</code>  实现了  <code>Cloneable</code> ，所以支持克隆。</li>
<li><code>HashSet</code>  实现了  <code>Serializable</code> ，所以支持序列化。</li>
<li><code>HashSet</code>  中存储的元素是无序的。</li>
<li><code>HashSet</code>  允许 null 值的元素。</li>
<li><code>HashSet</code>  不是线程安全的。</li>
</ul>
<h3 id="-432"><a class="markdownIt-Anchor" href="#-432">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-set.html#_2-2-hashset-%E5%8E%9F%E7%90%86">#</a>2.2. HashSet 原理</h3>
<p><strong> <code>HashSet</code>  是基于  <code>HashMap</code>  实现的。</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// HashSet 的核心，通过维护一个 HashMap 实体来实现 HashSet 方法</span>
<span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> map<span class="token punctuation">;</span>

<span class="token comment">// PRESENT 是用于关联 map 中当前操作元素的一个虚拟值</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> PRESENT <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>
<pre><code>
  HashSet
  <pre class="line-numbers language-none"><code class="language-none">

​	 

	中维护了一个


​	 
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
  HashMap
  <pre class="line-numbers language-none"><code class="language-none">

​	 

	对象 map，
	<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
  HashSet
  <pre class="line-numbers language-none"><code class="language-none">

​	 

	的重要方法，如


​	 
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
  add
  <pre class="line-numbers language-none"><code class="language-none">
、
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
  remove
  <pre class="line-numbers language-none"><code class="language-none">
、
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
  iterator
  <pre class="line-numbers language-none"><code class="language-none">
、
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
  clear
  <pre class="line-numbers language-none"><code class="language-none">
、
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
  size
  <pre class="line-numbers language-none"><code class="language-none">

​	 

	等都是围绕 map 实现的。
	
	- &#96;HashSet&#96; 类中通过定义 &#96;writeObject()&#96; 和 &#96;readObject()&#96; 方法确定了其序列化和反序列化的机制。

- PRESENT 是用于关联 map 中当前操作元素的一个虚拟值。

## [#](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;container&#x2F;java-container-set.html#_3-treeset-类)3. TreeSet 类

&#96;TreeSet&#96; 类依赖于 &#96;TreeMap&#96;，它实际上是通过 &#96;TreeMap&#96; 实现的。&#96;TreeSet&#96; 中的元素是有序的，它是按自然排序或者用户指定比较器排序的 Set。

&#96;TreeSet&#96; 类定义如下：

&#96;&#96;&#96;java
public class TreeSet&lt;E&gt; extends AbstractSet&lt;E&gt;
    implements NavigableSet&lt;E&gt;, Cloneable, java.io.Serializable &#123;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

</code></pre>
</li>
</ul>
<h3 id="-433"><a class="markdownIt-Anchor" href="#-433">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-set.html#_3-1-treeset-%E8%A6%81%E7%82%B9">#</a>3.1. TreeSet 要点</h3>
<ul>
<li><code>TreeSet</code>  通过继承  <code>AbstractSet</code>  实现了  <code>NavigableSet</code>  接口中的骨干方法。</li>
<li><code>TreeSet</code>  实现了  <code>Cloneable</code> ，所以支持克隆。</li>
<li><code>TreeSet</code>  实现了  <code>Serializable</code> ，所以支持序列化。</li>
<li><code>TreeSet</code>  中存储的元素是有序的。排序规则是自然顺序或比较器（ <code>Comparator</code> ）中提供的顺序规则。</li>
<li><code>TreeSet</code>  不是线程安全的。</li>
</ul>
<h3 id="-434"><a class="markdownIt-Anchor" href="#-434">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-set.html#_3-2-treeset-%E6%BA%90%E7%A0%81">#</a>3.2. TreeSet 源码</h3>
<p><strong>TreeSet 是基于 TreeMap 实现的。</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// TreeSet 的核心，通过维护一个 NavigableMap 实体来实现 TreeSet 方法</span>
<span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token class-name">NavigableMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> m<span class="token punctuation">;</span>

<span class="token comment">// PRESENT 是用于关联 map 中当前操作元素的一个虚拟值</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> PRESENT <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><code>TreeSet</code>  中维护了一个  <code>NavigableMap</code>  对象 map（实际上是一个 TreeMap 实例）， <code>TreeSet</code>  的重要方法，如  <code>add</code> 、 <code>remove</code> 、 <code>iterator</code> 、 <code>clear</code> 、 <code>size</code>  等都是围绕 map 实现的。</li>
<li><code>PRESENT</code>  是用于关联  <code>map</code>  中当前操作元素的一个虚拟值。 <code>TreeSet</code>  中的元素都被当成  <code>TreeMap</code>  的 key 存储，而 value 都填的是  <code>PRESENT</code> 。</li>
</ul>
<h2 id="-435"><a class="markdownIt-Anchor" href="#-435">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-set.html#_4-linkedhashset-%E7%B1%BB">#</a>4. LinkedHashSet 类</h2>
<p><code>LinkedHashSet</code>  是按插入顺序排序的 Set。</p>
<p><code>LinkedHashSet</code>  类定义如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span>
    <span class="token keyword">extends</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span>
    <span class="token keyword">implements</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span><span class="token punctuation">,</span> <span class="token class-name">Cloneable</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="-436"><a class="markdownIt-Anchor" href="#-436">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-set.html#_4-1-linkedhashset-%E8%A6%81%E7%82%B9">#</a>4.1. LinkedHashSet 要点</h3>
<ul>
<li><code>LinkedHashSet</code>  通过继承  <code>HashSet</code>  实现了  <code>Set</code>  接口中的骨干方法。</li>
<li><code>LinkedHashSet</code>  实现了  <code>Cloneable</code> ，所以支持克隆。</li>
<li><code>LinkedHashSet</code>  实现了  <code>Serializable</code> ，所以支持序列化。</li>
<li><code>LinkedHashSet</code>  中存储的元素是按照插入顺序保存的。</li>
<li><code>LinkedHashSet</code>  不是线程安全的。</li>
</ul>
<h3 id="-437"><a class="markdownIt-Anchor" href="#-437">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-set.html#_4-2-linkedhashset-%E5%8E%9F%E7%90%86">#</a>4.2. LinkedHashSet 原理</h3>
<p><code>LinkedHashSet</code>  有三个构造方法，无一例外，都是调用父类  <code>HashSet</code>  的构造方法。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">LinkedHashSet</span><span class="token punctuation">(</span><span class="token keyword">int</span> initialCapacity<span class="token punctuation">,</span> <span class="token keyword">float</span> loadFactor<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>initialCapacity<span class="token punctuation">,</span> loadFactor<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">public</span> <span class="token class-name">LinkedHashSet</span><span class="token punctuation">(</span><span class="token keyword">int</span> initialCapacity<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>initialCapacity<span class="token punctuation">,</span> <span class="token number">.75f</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">public</span> <span class="token class-name">LinkedHashSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">.75f</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>需要强调的是：<strong>LinkedHashSet 构造方法实际上调用的是父类 HashSet 的非 public 构造方法。</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">HashSet</span><span class="token punctuation">(</span><span class="token keyword">int</span> initialCapacity<span class="token punctuation">,</span> <span class="token keyword">float</span> loadFactor<span class="token punctuation">,</span> <span class="token keyword">boolean</span> dummy<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>initialCapacity<span class="token punctuation">,</span> loadFactor<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>不同于  <code>HashSet</code>   <code>public</code>  构造方法中初始化的  <code>HashMap</code>  实例，这个构造方法中，初始化了  <code>LinkedHashMap</code>  实例。</p>
<p>也就是说，实际上， <code>LinkedHashSet</code>  维护了一个双链表。由双链表的特性可以知道，它是按照元素的插入顺序保存的。所以，这就是  <code>LinkedHashSet</code>  中存储的元素是按照插入顺序保存的原理。</p>
<h2 id="-438"><a class="markdownIt-Anchor" href="#-438">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-set.html#_5-enumset-%E7%B1%BB">#</a>5. EnumSet 类</h2>
<p><code>EnumSet</code>  类定义如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">EnumSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span> <span class="token keyword">extends</span> <span class="token class-name">Enum</span><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span>
    <span class="token keyword">implements</span> <span class="token class-name">Cloneable</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="-439"><a class="markdownIt-Anchor" href="#-439">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-set.html#_5-1-enumset-%E8%A6%81%E7%82%B9">#</a>5.1. EnumSet 要点</h3>
<ul>
<li><code>EnumSet</code>  继承了  <code>AbstractSet</code> ，所以有  <code>Set</code>  接口中的骨干方法。</li>
<li><code>EnumSet</code>  实现了  <code>Cloneable</code> ，所以支持克隆。</li>
<li><code>EnumSet</code>  实现了  <code>Serializable</code> ，所以支持序列化。</li>
<li><code>EnumSet</code>  通过  <code>&lt;E extends Enum&lt;E&gt;&gt;</code>  限定了存储元素必须是枚举值。</li>
<li><code>EnumSet</code>  没有构造方法，只能通过类中的  <code>static</code>  方法来创建  <code>EnumSet</code>  对象。</li>
<li><code>EnumSet</code>  是有序的。以枚举值在  <code>EnumSet</code>  类中的定义顺序来决定集合元素的顺序。</li>
<li><code>EnumSet</code>  不是线程安全的。</li>
</ul>
<h2 id="-440"><a class="markdownIt-Anchor" href="#-440">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-set.html#_6-%E8%A6%81%E7%82%B9%E6%80%BB%E7%BB%93">#</a>6. 要点总结</h2>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/20200221190717.png" alt="img"></p>
<hr>
<h1 id="java-容器之-queue"><a class="markdownIt-Anchor" href="#java-容器之-queue">#</a> Java 容器之 Queue</h1>
<blockquote>
<p><strong>📦 本文以及示例源码已归档在 <a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/">javacore(opens new window)</a></strong></p>
</blockquote>
<ul>
<li>\1. Queue 简介
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-queue.html#11-queue-%E6%8E%A5%E5%8F%A3">1.1. Queue 接口</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-queue.html#12-abstractqueue-%E6%8A%BD%E8%B1%A1%E7%B1%BB">1.2. AbstractQueue 抽象类</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-queue.html#13-deque-%E6%8E%A5%E5%8F%A3">1.3. Deque 接口</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-queue.html#2-arraydeque">2. ArrayDeque</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-queue.html#3-linkedlist">3. LinkedList</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-queue.html#4-priorityqueue">4. PriorityQueue</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-queue.html#5-%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">5. 参考资料</a></li>
</ul>
<h2 id="-441"><a class="markdownIt-Anchor" href="#-441">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-queue.html#_1-queue-%E7%AE%80%E4%BB%8B">#</a>1. Queue 简介</h2>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/Queue-diagrams.png" alt="img"></p>
<h3 id="-442"><a class="markdownIt-Anchor" href="#-442">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-queue.html#_1-1-queue-%E6%8E%A5%E5%8F%A3">#</a>1.1. Queue 接口</h3>
<p><code>Queue</code>  接口定义如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Queue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="-443"><a class="markdownIt-Anchor" href="#-443">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-queue.html#_1-2-abstractqueue-%E6%8A%BD%E8%B1%A1%E7%B1%BB">#</a>1.2. AbstractQueue 抽象类</h3>
<p><strong> <code>AbstractQueue</code>  类提供  <code>Queue</code>  接口的核心实现</strong>，以最大限度地减少实现  <code>Queue</code>  接口所需的工作。</p>
<p><code>AbstractQueue</code>  抽象类定义如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span>
    <span class="token keyword">extends</span> <span class="token class-name">AbstractCollection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span>
    <span class="token keyword">implements</span> <span class="token class-name">Queue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="-444"><a class="markdownIt-Anchor" href="#-444">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-queue.html#_1-3-deque-%E6%8E%A5%E5%8F%A3">#</a>1.3. Deque 接口</h3>
<p>Deque 接口是 double ended queue 的缩写，即<strong>双端队列</strong>。Deque 继承 Queue 接口，并扩展支持<strong>在队列的两端插入和删除元素</strong>。</p>
<p>所以提供了特定的方法，如:</p>
<ul>
<li>尾部插入时需要的 <a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/9/docs/api/java/util/Deque.html#addLast-E-">addLast(e) (opens new window)</a>、<a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/9/docs/api/java/util/Deque.html#offerLast-E-">offerLast(e) (opens new window)</a>。</li>
<li>尾部删除所需要的 <a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/9/docs/api/java/util/Deque.html#removeLast--">removeLast() (opens new window)</a>、<a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/9/docs/api/java/util/Deque.html#pollLast--">pollLast() (opens new window)</a>。</li>
</ul>
<p>大多数的实现对元素的数量没有限制，但这个接口既支持有容量限制的 deque，也支持没有固定大小限制的。</p>
<h2 id="-445"><a class="markdownIt-Anchor" href="#-445">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-queue.html#_2-arraydeque">#</a>2. ArrayDeque</h2>
<p><code>ArrayDeque</code>  是  <code>Deque</code>  的顺序表实现。</p>
<p><code>ArrayDeque</code>  用一个动态数组实现了栈和队列所需的所有操作。</p>
<h2 id="-446"><a class="markdownIt-Anchor" href="#-446">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-queue.html#_3-linkedlist">#</a>3. LinkedList</h2>
<p><code>LinkedList</code>  是  <code>Deque</code>  的链表实现。</p>
<p>示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LinkedListQueueDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//add()和remove()方法在失败的时候会抛出异常(不推荐)</span>
        <span class="token class-name">Queue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        queue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 入队</span>
        queue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span><span class="token string">"b"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 入队</span>
        queue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span><span class="token string">"c"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 入队</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> q <span class="token operator">:</span> queue<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"==="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"poll="</span> <span class="token operator">+</span> queue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 出队</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> q <span class="token operator">:</span> queue<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"==="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"element="</span> <span class="token operator">+</span> queue<span class="token punctuation">.</span><span class="token function">element</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//返回第一个元素</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> q <span class="token operator">:</span> queue<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"==="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"peek="</span> <span class="token operator">+</span> queue<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//返回第一个元素</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> q <span class="token operator">:</span> queue<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="-447"><a class="markdownIt-Anchor" href="#-447">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/container/java-container-queue.html#_4-priorityqueue">#</a>4. PriorityQueue</h2>
<p><code>PriorityQueue</code>  类定义如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PriorityQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span>
    <span class="token keyword">implements</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><code>PriorityQueue</code>  要点：</p>
<ul>
<li><code>PriorityQueue</code>  实现了  <code>Serializable</code> ，支持序列化。</li>
<li><code>PriorityQueue</code>  类是无界优先级队列。</li>
<li><code>PriorityQueue</code>  中的元素根据自然顺序或  <code>Comparator</code>  提供的顺序排序。</li>
<li><code>PriorityQueue</code>  不接受 null 值元素。</li>
<li><code>PriorityQueue</code>  不是线程安全的。</li>
</ul>
<hr>
<h1 id="java-io-模型"><a class="markdownIt-Anchor" href="#java-io-模型">#</a> Java IO 模型</h1>
<blockquote>
<p><strong>📦 本文以及示例源码已归档在 <a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/">javacore(opens new window)</a></strong></p>
<p>所谓的<strong> I/O，就是计算机内存与外部设备之间拷贝数据的过程</strong>。由于 CPU 访问内存的速度远远高于外部设备，因此 CPU 是先把外部设备的数据读到内存里，然后再进行处理。</p>
<p><strong>关键词： <code>InputStream</code> 、 <code>OutputStream</code> 、 <code>Reader</code> 、 <code>Writer</code> </strong></p>
</blockquote>
<ul>
<li>一、简介
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-io.html#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5">基本概念</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-io.html#bio">BIO</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-io.html#nio">NIO</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-io.html#aio">AIO</a></li>
</ul>
</li>
<li>二、IO 流
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-io.html#%E5%AD%97%E8%8A%82%E6%B5%81">字节流</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-io.html#%E5%AD%97%E7%AC%A6%E6%B5%81">字符流</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-io.html#%E5%AD%97%E8%8A%82%E6%B5%81-vs-%E5%AD%97%E7%AC%A6%E6%B5%81">字节流 vs. 字符流</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-io.html#%E4%B8%89%E4%BC%A0%E7%BB%9F-bio">三、传统 BIO</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-io.html#%E5%9B%9B%E4%BC%AA%E5%BC%82%E6%AD%A5-bio">四、伪异步 BIO</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-io.html#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">参考资料</a></li>
</ul>
<h2 id="-448"><a class="markdownIt-Anchor" href="#-448">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-io.html#unix-i-o-%E6%A8%A1%E5%9E%8B">#</a>UNIX I/O 模型</h2>
<p>UNIX 系统下的 I/O 模型有 5 种：</p>
<ul>
<li>同步阻塞 I/O</li>
<li>同步非阻塞 I/O</li>
<li>I/O 多路复用</li>
<li>信号驱动 I/O</li>
<li>异步 I/O</li>
</ul>
<p>如何去理解 UNIX I/O 模型，大致有以下两个维度：</p>
<ul>
<li>区分同步或异步（synchronous/asynchronous）。简单来说，同步是一种可靠的有序运行机制，当我们进行同步操作时，后续的任务是等待当前调用返回，才会进行下一步；而异步则相反，其他任务不需要等待当前调用返回，通常依靠事件、回调等机制来实现任务间次序关系。</li>
<li>区分阻塞与非阻塞（blocking/non-blocking）。在进行阻塞操作时，当前线程会处于阻塞状态，无法从事其他任务，只有当条件就绪才能继续，比如 ServerSocket 新连接建立完毕，或数据读取、写入操作完成；而非阻塞则是不管 IO 操作是否结束，直接返回，相应操作在后台继续处理。</li>
</ul>
<p>不能一概而论认为同步或阻塞就是低效，具体还要看应用和系统特征。</p>
<p>对于一个网络 I/O 通信过程，比如网络数据读取，会涉及两个对象，一个是调用这个 I/O 操作的用户线程，另外一个就是操作系统内核。一个进程的地址空间分为用户空间和内核空间，用户线程不能直接访问内核空间。</p>
<p>当用户线程发起 I/O 操作后，网络数据读取操作会经历两个步骤：</p>
<ul>
<li><strong>用户线程等待内核将数据从网卡拷贝到内核空间。</strong></li>
<li><strong>内核将数据从内核空间拷贝到用户空间。</strong></li>
</ul>
<p>各种 I/O 模型的区别就是：它们实现这两个步骤的方式是不一样的。</p>
<h3 id="-449"><a class="markdownIt-Anchor" href="#-449">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-io.html#%E5%90%8C%E6%AD%A5%E9%98%BB%E5%A1%9E-i-o">#</a>同步阻塞 I/O</h3>
<p>用户线程发起 read 调用后就阻塞了，让出 CPU。内核等待网卡数据到来，把数据从网卡拷贝到内核空间，接着把数据拷贝到用户空间，再把用户线程叫醒。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20201121163321.jpg" alt="img"></p>
<h3 id="-450"><a class="markdownIt-Anchor" href="#-450">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-io.html#%E5%90%8C%E6%AD%A5%E9%9D%9E%E9%98%BB%E5%A1%9E-i-o">#</a>同步非阻塞 I/O</h3>
<p>用户线程不断的发起 read 调用，数据没到内核空间时，每次都返回失败，直到数据到了内核空间，这一次 read 调用后，在等待数据从内核空间拷贝到用户空间这段时间里，线程还是阻塞的，等数据到了用户空间再把线程叫醒。</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/20201121163344.jpg" alt="img"></p>
<h3 id="-451"><a class="markdownIt-Anchor" href="#-451">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-io.html#i-o-%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8">#</a>I/O 多路复用</h3>
<p>用户线程的读取操作分成两步了，线程先发起 select 调用，目的是问内核数据准备好了吗？等内核把数据准备好了，用户线程再发起 read 调用。在等待数据从内核空间拷贝到用户空间这段时间里，线程还是阻塞的。那为什么叫 I/O 多路复用呢？因为一次 select 调用可以向内核查多个数据通道（Channel）的状态，所以叫多路复用。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20201121163408.jpg" alt="img"></p>
<h3 id="-452"><a class="markdownIt-Anchor" href="#-452">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-io.html#%E4%BF%A1%E5%8F%B7%E9%A9%B1%E5%8A%A8-i-o">#</a>信号驱动 I/O</h3>
<p>首先开启 Socket 的信号驱动 I/O 功能，并安装一个信号处理函数，进程继续运行并不阻塞。当数据准备好时，进程会收到一个 SIGIO 信号，可以在信号处理函数中调用 I/O 操作函数处理数据。<strong>信号驱动式 I/O 模型的优点是我们在数据报到达期间进程不会被阻塞，我们只要等待信号处理函数的通知即可</strong></p>
<h3 id="-453"><a class="markdownIt-Anchor" href="#-453">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-io.html#%E5%BC%82%E6%AD%A5-i-o">#</a>异步 I/O</h3>
<p>用户线程发起 read 调用的同时注册一个回调函数，read 立即返回，等内核将数据准备好后，再调用指定的回调函数完成处理。在这个过程中，用户线程一直没有阻塞。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20201121163428.jpg" alt="img"></p>
<h2 id="-454"><a class="markdownIt-Anchor" href="#-454">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-io.html#java-i-o-%E6%A8%A1%E5%9E%8B">#</a>Java I/O 模型</h2>
<h3 id="-455"><a class="markdownIt-Anchor" href="#-455">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-io.html#bio">#</a>BIO</h3>
<blockquote>
<p>BIO（blocking IO） 即阻塞 IO。指的主要是传统的  <code>java.io</code>  包，它基于流模型实现。</p>
</blockquote>
<h4 id="-456"><a class="markdownIt-Anchor" href="#-456">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-io.html#bio-%E7%AE%80%E4%BB%8B">#</a>BIO 简介</h4>
<p><code>java.io</code>  包提供了我们最熟知的一些 IO 功能，比如 File 抽象、输入输出流等。交互方式是同步、阻塞的方式，也就是说，在读取输入流或者写入输出流时，在读、写动作完成之前，线程会一直阻塞在那里，它们之间的调用是可靠的线性顺序。</p>
<p>很多时候，人们也把 <a target="_blank" rel="noopener" href="http://java.net">java.net</a> 下面提供的部分网络 API，比如  <code>Socket</code> 、 <code>ServerSocket</code> 、 <code>HttpURLConnection</code>  也归类到同步阻塞 IO 类库，因为网络通信同样是 IO 行为。</p>
<p>BIO 的优点是代码比较简单、直观；缺点则是 IO 效率和扩展性存在局限性，容易成为应用性能的瓶颈。</p>
<h4 id="-457"><a class="markdownIt-Anchor" href="#-457">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-io.html#bio-%E7%9A%84%E6%80%A7%E8%83%BD%E7%BC%BA%E9%99%B7">#</a>BIO 的性能缺陷</h4>
<p><strong>BIO 会阻塞进程，不适合高并发场景</strong>。</p>
<p>采用 BIO 的服务端，通常由一个独立的 Acceptor 线程负责监听客户端连接。服务端一般在 <code>while(true)</code>  循环中调用  <code>accept()</code>  方法等待客户端的连接请求，一旦接收到一个连接请求，就可以建立 Socket，并基于这个 Socket 进行读写操作。此时，不能再接收其他客户端连接请求，只能等待当前连接的操作执行完成。</p>
<p>如果要让 <strong>BIO 通信模型</strong> 能够同时处理多个客户端请求，就必须使用多线程（主要原因是 <code>socket.accept()</code> 、 <code>socket.read()</code> 、 <code>socket.write()</code>  涉及的三个主要函数都是同步阻塞的），但会造成不必要的线程开销。不过可以通过 <strong>线程池机制</strong> 改善，线程池还可以让线程的创建和回收成本相对较低。</p>
<p><strong>即使可以用线程池略微优化，但是会消耗宝贵的线程资源，并且在百万级并发场景下也撑不住</strong>。如果并发访问量增加会导致线程数急剧膨胀可能会导致线程堆栈溢出、创建新线程失败等问题，最终导致进程宕机或者僵死，不能对外提供服务。</p>
<h3 id="-458"><a class="markdownIt-Anchor" href="#-458">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-io.html#nio">#</a>NIO</h3>
<blockquote>
<p>NIO（non-blocking IO） 即非阻塞 IO。指的是 Java 1.4 中引入的  <code>java.nio</code>  包。</p>
</blockquote>
<p>为了解决 BIO 的性能问题， Java 1.4 中引入的  <code>java.nio</code>  包。NIO 优化了内存复制以及阻塞导致的严重性能问题。</p>
<p><code>java.nio</code>  包提供了  <code>Channel</code> 、 <code>Selector</code> 、 <code>Buffer</code>  等新的抽象，可以构建多路复用的、同步非阻塞 IO 程序，同时提供了更接近操作系统底层的高性能数据操作方式。</p>
<p>NIO 有哪些性能优化点呢？</p>
<h4 id="-459"><a class="markdownIt-Anchor" href="#-459">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-io.html#%E4%BD%BF%E7%94%A8%E7%BC%93%E5%86%B2%E5%8C%BA%E4%BC%98%E5%8C%96%E8%AF%BB%E5%86%99%E6%B5%81">#</a>使用缓冲区优化读写流</h4>
<p>NIO 与传统 I/O 不同，它是基于块（Block）的，它以块为基本单位处理数据。在 NIO 中，最为重要的两个组件是缓冲区（ <code>Buffer</code> ）和通道（ <code>Channel</code> ）。</p>
<p><code>Buffer</code>  是一块连续的内存块，是 NIO 读写数据的缓冲。 <code>Buffer</code>  可以将文件一次性读入内存再做后续处理，而传统的方式是边读文件边处理数据。 <code>Channel</code>  表示缓冲数据的源头或者目的地，它用于读取缓冲或者写入数据，是访问缓冲的接口。</p>
<h4 id="-460"><a class="markdownIt-Anchor" href="#-460">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-io.html#%E4%BD%BF%E7%94%A8-directbuffer-%E5%87%8F%E5%B0%91%E5%86%85%E5%AD%98%E5%A4%8D%E5%88%B6">#</a>使用 DirectBuffer 减少内存复制</h4>
<p>NIO 还提供了一个可以直接访问物理内存的类  <code>DirectBuffer</code> 。普通的  <code>Buffer</code>  分配的是 JVM 堆内存，而  <code>DirectBuffer</code>  是直接分配物理内存。</p>
<p>数据要输出到外部设备，必须先从用户空间复制到内核空间，再复制到输出设备，而  <code>DirectBuffer</code>  则是直接将步骤简化为从内核空间复制到外部设备，减少了数据拷贝。</p>
<p>这里拓展一点，由于  <code>DirectBuffer</code>  申请的是非 JVM 的物理内存，所以创建和销毁的代价很高。 <code>DirectBuffer</code>  申请的内存并不是直接由 JVM 负责垃圾回收，但在  <code>DirectBuffer</code>  包装类被回收时，会通过 Java 引用机制来释放该内存块。</p>
<h4 id="-461"><a class="markdownIt-Anchor" href="#-461">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-io.html#%E4%BC%98%E5%8C%96-i-o-%E9%81%BF%E5%85%8D%E9%98%BB%E5%A1%9E">#</a>优化 I/O，避免阻塞</h4>
<p>传统 I/O 的数据读写是在用户空间和内核空间来回复制，而内核空间的数据是通过操作系统层面的 I/O 接口从磁盘读取或写入。</p>
<p>NIO 的  <code>Channel</code>  有自己的处理器，可以完成内核空间和磁盘之间的 I/O 操作。在 NIO 中，我们读取和写入数据都要通过  <code>Channel</code> ，由于  <code>Channel</code>  是双向的，所以读、写可以同时进行。</p>
<h3 id="-462"><a class="markdownIt-Anchor" href="#-462">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-io.html#aio">#</a>AIO</h3>
<blockquote>
<p>AIO（Asynchronous IO） 即异步非阻塞 IO，指的是 Java 7 中，对 NIO 有了进一步的改进，也称为 NIO2，引入了异步非阻塞 IO 方式。</p>
</blockquote>
<p>在 Java 7 中，NIO 有了进一步的改进，也就是 NIO 2，引入了异步非阻塞 IO 方式，也有很多人叫它 AIO（Asynchronous IO）。异步 IO 操作基于事件和回调机制，可以简单理解为，应用操作直接返回，而不会阻塞在那里，当后台处理完成，操作系统会通知相应线程进行后续工作。</p>
<h2 id="-463"><a class="markdownIt-Anchor" href="#-463">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-io.html#%E4%BC%A0%E7%BB%9F-io-%E6%B5%81">#</a>传统 IO 流</h2>
<p>流从概念上来说是一个连续的数据流。当程序需要读数据的时候就需要使用输入流读取数据，当需要往外写数据的时候就需要输出流。</p>
<p>BIO 中操作的流主要有两大类，字节流和字符流，两类根据流的方向都可以分为输入流和输出流。</p>
<ul>
<li>字节流
<ul>
<li>输入字节流： <code>InputStream</code></li>
<li>输出字节流： <code>OutputStream</code></li>
</ul>
</li>
<li>字符流
<ul>
<li>输入字符流： <code>Reader</code></li>
<li>输出字符流： <code>Writer</code></li>
</ul>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/20200219130627.png" alt="img"></p>
<h3 id="-464"><a class="markdownIt-Anchor" href="#-464">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-io.html#%E5%AD%97%E8%8A%82%E6%B5%81">#</a>字节流</h3>
<p>字节流主要操作字节数据或二进制对象。</p>
<p>字节流有两个核心抽象类： <code>InputStream</code>  和  <code>OutputStream</code> 。所有的字节流类都继承自这两个抽象类。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200219133627.png" alt="img"></p>
<h4 id="-465"><a class="markdownIt-Anchor" href="#-465">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-io.html#%E6%96%87%E4%BB%B6%E5%AD%97%E8%8A%82%E6%B5%81">#</a>文件字节流</h4>
<p><code>FileOutputStream</code>  和  <code>FileInputStream</code>  提供了读写字节到文件的能力。</p>
<p>文件流操作一般步骤：</p>
<ol>
<li>使用  <code>File</code>  类绑定一个文件。</li>
<li>把  <code>File</code>  对象绑定到流对象上。</li>
<li>进行读或写操作。</li>
<li>关闭流</li>
</ol>
<p><code>FileOutputStream</code>  和  <code>FileInputStream</code>  示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FileStreamDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> FILEPATH <span class="token operator">=</span> <span class="token string">"temp.log"</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token function">write</span><span class="token punctuation">(</span>FILEPATH<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">read</span><span class="token punctuation">(</span>FILEPATH<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">String</span> filepath<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 第1步、使用File类找到一个文件</span>
        <span class="token class-name">File</span> f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>filepath<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 第2步、通过子类实例化父类对象</span>
        <span class="token class-name">OutputStream</span> out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 实例化时，默认为覆盖原文件内容方式；如果添加true参数，则变为对原文件追加内容的方式。</span>
        <span class="token comment">// OutputStream out = new FileOutputStream(f, true);</span>

        <span class="token comment">// 第3步、进行写操作</span>
        <span class="token class-name">String</span> str <span class="token operator">=</span> <span class="token string">"Hello World\n"</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 第4步、关闭输出流</span>
        out<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token class-name">String</span> filepath<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 第1步、使用File类找到一个文件</span>
        <span class="token class-name">File</span> f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>filepath<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 第2步、通过子类实例化父类对象</span>
        <span class="token class-name">InputStream</span> input <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 第3步、进行读操作</span>
        <span class="token comment">// 有三种读取方式，体会其差异</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> f<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> len <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 读取内容</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"读入数据的长度："</span> <span class="token operator">+</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 第4步、关闭输入流</span>
        input<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"内容为：\n"</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-466"><a class="markdownIt-Anchor" href="#-466">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-io.html#%E5%86%85%E5%AD%98%E5%AD%97%E8%8A%82%E6%B5%81">#</a>内存字节流</h4>
<p><code>ByteArrayInputStream</code>  和  <code>ByteArrayOutputStream</code>  是用来完成内存的输入和输出功能。</p>
<p>内存操作流一般在生成一些临时信息时才使用。 如果临时信息保存在文件中，还需要在有效期过后删除文件，这样比较麻烦。</p>
<p><code>ByteArrayInputStream</code>  和  <code>ByteArrayOutputStream</code>  示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ByteArrayStreamDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> str <span class="token operator">=</span> <span class="token string">"HELLOWORLD"</span><span class="token punctuation">;</span> <span class="token comment">// 定义一个字符串，全部由大写字母组成</span>
        <span class="token class-name">ByteArrayInputStream</span> bis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ByteArrayOutputStream</span> bos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 准备从内存ByteArrayInputStream中读取内容</span>
        <span class="token keyword">int</span> temp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>temp <span class="token operator">=</span> bis<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">char</span> c <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> temp<span class="token punctuation">;</span> <span class="token comment">// 读取的数字变为字符</span>
            bos<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">Character</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将字符变为小写</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// 所有的数据就全部都在ByteArrayOutputStream中</span>
        <span class="token class-name">String</span> newStr <span class="token operator">=</span> bos<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 取出内容</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            bis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            bos<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>newStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-467"><a class="markdownIt-Anchor" href="#-467">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-io.html#%E7%AE%A1%E9%81%93%E6%B5%81">#</a>管道流</h4>
<p>管道流的主要作用是可以进行两个线程间的通信。</p>
<p>如果要进行管道通信，则必须把  <code>PipedOutputStream</code>  连接在  <code>PipedInputStream</code>  上。为此， <code>PipedOutputStream</code>  中提供了  <code>connect()</code>  方法。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PipedStreamDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Send</span> s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Receive</span> r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Receive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            s<span class="token punctuation">.</span><span class="token function">getPos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">getPis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 连接管道</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 启动线程</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 启动线程</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Send</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span>

        <span class="token keyword">private</span> <span class="token class-name">PipedOutputStream</span> pos <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token class-name">Send</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            pos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PipedOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 实例化输出流</span>
        <span class="token punctuation">&#125;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">String</span> str <span class="token operator">=</span> <span class="token string">"Hello World!!!"</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                pos<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                pos<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">/**
         * 得到此线程的管道输出流
         */</span>
        <span class="token class-name">PipedOutputStream</span> <span class="token function">getPos</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> pos<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

    <span class="token punctuation">&#125;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Receive</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span>

        <span class="token keyword">private</span> <span class="token class-name">PipedInputStream</span> pis <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token class-name">Receive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            pis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PipedInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                len <span class="token operator">=</span> pis<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                pis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"接收的内容为："</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">/**
         * 得到此线程的管道输入流
         */</span>
        <span class="token class-name">PipedInputStream</span> <span class="token function">getPis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> pis<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-468"><a class="markdownIt-Anchor" href="#-468">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-io.html#%E5%AF%B9%E8%B1%A1%E5%AD%97%E8%8A%82%E6%B5%81">#</a>对象字节流</h4>
<p><strong>ObjectInputStream 和 ObjectOutputStream 是对象输入输出流，一般用于对象序列化。</strong></p>
<p>这里不展开叙述，想了解详细内容和示例可以参考：<a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-serialization.html">Java 序列化</a></p>
<h4 id="-469"><a class="markdownIt-Anchor" href="#-469">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-io.html#%E6%95%B0%E6%8D%AE%E6%93%8D%E4%BD%9C%E6%B5%81">#</a>数据操作流</h4>
<p>数据操作流提供了格式化读入和输出数据的方法，分别为  <code>DataInputStream</code>  和  <code>DataOutputStream</code> 。</p>
<p><code>DataInputStream</code>  和  <code>DataOutputStream</code>  格式化读写数据示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataStreamDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> FILEPATH <span class="token operator">=</span> <span class="token string">"temp.log"</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token function">write</span><span class="token punctuation">(</span>FILEPATH<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">read</span><span class="token punctuation">(</span>FILEPATH<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">String</span> filepath<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 1.使用 File 类绑定一个文件</span>
        <span class="token class-name">File</span> f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>filepath<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2.把 File 对象绑定到流对象上</span>
        <span class="token class-name">DataOutputStream</span> dos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataOutputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3.进行读或写操作</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> names <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token string">"衬衣"</span><span class="token punctuation">,</span> <span class="token string">"手套"</span><span class="token punctuation">,</span> <span class="token string">"围巾"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token keyword">float</span><span class="token punctuation">[</span><span class="token punctuation">]</span> prices <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token number">98.3f</span><span class="token punctuation">,</span> <span class="token number">30.3f</span><span class="token punctuation">,</span> <span class="token number">50.5f</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> names<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            dos<span class="token punctuation">.</span><span class="token function">writeChars</span><span class="token punctuation">(</span>names<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            dos<span class="token punctuation">.</span><span class="token function">writeChar</span><span class="token punctuation">(</span><span class="token string">'\t'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            dos<span class="token punctuation">.</span><span class="token function">writeFloat</span><span class="token punctuation">(</span>prices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            dos<span class="token punctuation">.</span><span class="token function">writeChar</span><span class="token punctuation">(</span><span class="token string">'\t'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            dos<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            dos<span class="token punctuation">.</span><span class="token function">writeChar</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// 4.关闭流</span>
        dos<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token class-name">String</span> filepath<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 1.使用 File 类绑定一个文件</span>
        <span class="token class-name">File</span> f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>filepath<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2.把 File 对象绑定到流对象上</span>
        <span class="token class-name">DataInputStream</span> dis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataInputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3.进行读或写操作</span>
        <span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 接收名称</span>
        <span class="token keyword">float</span> price <span class="token operator">=</span> <span class="token number">0.0f</span><span class="token punctuation">;</span> <span class="token comment">// 接收价格</span>
        <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 接收数量</span>
        <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> temp <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 接收商品名称</span>
        <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 保存读取数据的个数</span>
        <span class="token keyword">char</span> c <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// '\u0000'</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                temp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token number">200</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 开辟空间</span>
                len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c <span class="token operator">=</span> dis<span class="token punctuation">.</span><span class="token function">readChar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token string">'\t'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 接收内容</span>
                    temp<span class="token punctuation">[</span>len<span class="token punctuation">]</span> <span class="token operator">=</span> c<span class="token punctuation">;</span>
                    len<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">// 读取长度加1</span>
                <span class="token punctuation">&#125;</span>
                name <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将字符数组变为String</span>
                price <span class="token operator">=</span> dis<span class="token punctuation">.</span><span class="token function">readFloat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 读取价格</span>
                dis<span class="token punctuation">.</span><span class="token function">readChar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 读取\t</span>
                num <span class="token operator">=</span> dis<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 读取int</span>
                dis<span class="token punctuation">.</span><span class="token function">readChar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 读取\n</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"名称：%s；价格：%5.2f；数量：%d\n"</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> price<span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">EOFException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"结束"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// 4.关闭流</span>
        dis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-470"><a class="markdownIt-Anchor" href="#-470">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-io.html#%E5%90%88%E5%B9%B6%E6%B5%81">#</a>合并流</h4>
<p>合并流的主要功能是将多个  <code>InputStream</code>  合并为一个  <code>InputStream</code>  流。合并流的功能由  <code>SequenceInputStream</code>  完成。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SequenceInputStreamDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>

        <span class="token class-name">InputStream</span> is1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">"temp1.log"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">InputStream</span> is2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">"temp2.log"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SequenceInputStream</span> sis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SequenceInputStream</span><span class="token punctuation">(</span>is1<span class="token punctuation">,</span> is2<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">int</span> temp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 接收内容</span>
        <span class="token class-name">OutputStream</span> os <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">"temp3.logt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>temp <span class="token operator">=</span> sis<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 循环输出</span>
            os<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 保存内容</span>
        <span class="token punctuation">&#125;</span>

        sis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 关闭合并流</span>
        is1<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 关闭输入流1</span>
        is2<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 关闭输入流2</span>
        os<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 关闭输出流</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-471"><a class="markdownIt-Anchor" href="#-471">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-io.html#%E5%AD%97%E7%AC%A6%E6%B5%81">#</a>字符流</h3>
<p>字符流主要操作字符，一个字符等于两个字节。</p>
<p>字符流有两个核心类： <code>Reader</code>  类和  <code>Writer</code>  。所有的字符流类都继承自这两个抽象类。</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/20200219133648.png" alt="img"></p>
<h4 id="-472"><a class="markdownIt-Anchor" href="#-472">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-io.html#%E6%96%87%E4%BB%B6%E5%AD%97%E7%AC%A6%E6%B5%81">#</a>文件字符流</h4>
<p>文件字符流  <code>FileReader</code>  和  <code>FileWriter</code>  可以向文件读写文本数据。</p>
<p><code>FileReader</code>  和  <code>FileWriter</code>  读写文件示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FileReadWriteDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> FILEPATH <span class="token operator">=</span> <span class="token string">"temp.log"</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token function">write</span><span class="token punctuation">(</span>FILEPATH<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"内容为："</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token function">read</span><span class="token punctuation">(</span>FILEPATH<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">String</span> filepath<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 1.使用 File 类绑定一个文件</span>
        <span class="token class-name">File</span> f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>filepath<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2.把 File 对象绑定到流对象上</span>
        <span class="token class-name">Writer</span> out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileWriter</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Writer out = new FileWriter(f, true); // 追加内容方式</span>

        <span class="token comment">// 3.进行读或写操作</span>
        <span class="token class-name">String</span> str <span class="token operator">=</span> <span class="token string">"Hello World!!!\r\n"</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 4.关闭流</span>
        <span class="token comment">// 字符流操作时使用了缓冲区，并在关闭字符流时会强制将缓冲区内容输出</span>
        <span class="token comment">// 如果不关闭流，则缓冲区的内容是无法输出的</span>
        <span class="token comment">// 如果想在不关闭流时，将缓冲区内容输出，可以使用 flush 强制清空缓冲区</span>
        out<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token class-name">String</span> filepath<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 1.使用 File 类绑定一个文件</span>
        <span class="token class-name">File</span> f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>filepath<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2.把 File 对象绑定到流对象上</span>
        <span class="token class-name">Reader</span> input <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3.进行读或写操作</span>
        <span class="token keyword">int</span> temp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 接收每一个内容</span>
        <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 读取内容</span>
        <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> c <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>temp <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 如果不是-1就表示还有内容，可以继续读取</span>
            c<span class="token punctuation">[</span>len<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> temp<span class="token punctuation">;</span>
            len<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"文件字符数为："</span> <span class="token operator">+</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 4.关闭流</span>
        input<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> c<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-473"><a class="markdownIt-Anchor" href="#-473">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-io.html#%E5%AD%97%E8%8A%82%E6%B5%81%E8%BD%AC%E6%8D%A2%E5%AD%97%E7%AC%A6%E6%B5%81">#</a>字节流转换字符流</h4>
<p>我们可以在程序中通过  <code>InputStream</code>  和  <code>Reader</code>  从数据源中读取数据，然后也可以在程序中将数据通过  <code>OutputStream</code>  和  <code>Writer</code>  输出到目标媒介中</p>
<p>使用  <code>InputStreamReader</code>  可以将输入字节流转化为输入字符流；使用 <code>OutputStreamWriter</code>  可以将输出字节流转化为输出字符流。</p>
<p><code>OutputStreamWriter</code>  示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OutputStreamWriterDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">File</span> f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"temp.log"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Writer</span> out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OutputStreamWriter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"hello world!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>InputStreamReader</code>  示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InputStreamReaderDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">File</span> f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"temp.log"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Reader</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> c <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> len <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
        reader<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-474"><a class="markdownIt-Anchor" href="#-474">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-io.html#%E5%AD%97%E8%8A%82%E6%B5%81-vs-%E5%AD%97%E7%AC%A6%E6%B5%81">#</a>字节流 vs. 字符流</h3>
<p>相同点：</p>
<p>字节流和字符流都有  <code>read()</code> 、 <code>write()</code> 、 <code>flush()</code> 、 <code>close()</code>  这样的方法，这决定了它们的操作方式近似。</p>
<p>不同点：</p>
<ul>
<li>数据类型
<ul>
<li>字节流的数据是字节（二进制对象）。主要核心类是  <code>InputStream</code>  类和  <code>OutputStream</code>  类。</li>
<li>字符流的数据是字符，一个字符等于两个字节。主要核心类是  <code>Reader</code>  类和  <code>Writer</code>  类。</li>
</ul>
</li>
<li>缓冲区
<ul>
<li>字节流在操作时本身不会用到缓冲区（内存），是文件直接操作的。</li>
<li>字符流在操作时是使用了缓冲区，通过缓冲区再操作文件。</li>
</ul>
</li>
</ul>
<p>选择：</p>
<p>所有的文件在硬盘或传输时都是以字节方式保存的，例如图片，影音文件等都是按字节方式存储的。字符流无法读写这些文件。</p>
<p>所以，除了纯文本数据文件使用字符流以外，其他文件类型都应该使用字节流方式。</p>
<hr>
<h1 id="java-nio"><a class="markdownIt-Anchor" href="#java-nio">#</a> Java NIO</h1>
<blockquote>
<p><strong>📦 本文以及示例源码已归档在 <a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/">javacore(opens new window)</a></strong></p>
<p>关键词： <code>Channel</code> 、 <code>Buffer</code> 、 <code>Selector</code> 、 <code>非阻塞</code> 、 <code>多路复用</code></p>
</blockquote>
<ul>
<li>一、NIO 简介
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-nio.html#nio-%E5%92%8C-bio-%E7%9A%84%E5%8C%BA%E5%88%AB">NIO 和 BIO 的区别</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-nio.html#nio-%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%B5%81%E7%A8%8B">NIO 的基本流程</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-nio.html#nio-%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6">NIO 核心组件</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-nio.html#%E4%BA%8Cchannel%E9%80%9A%E9%81%93">二、Channel (通道)</a></li>
<li>三、Buffer (缓冲区)
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-nio.html#%E7%BC%93%E5%86%B2%E5%8C%BA%E7%8A%B6%E6%80%81%E5%8F%98%E9%87%8F">缓冲区状态变量</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-nio.html#%E6%96%87%E4%BB%B6-nio-%E7%A4%BA%E4%BE%8B">文件 NIO 示例</a></li>
</ul>
</li>
<li>四、Selector (选择器)
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-nio.html#%E5%88%9B%E5%BB%BA%E9%80%89%E6%8B%A9%E5%99%A8">创建选择器</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-nio.html#%E5%B0%86%E9%80%9A%E9%81%93%E6%B3%A8%E5%86%8C%E5%88%B0%E9%80%89%E6%8B%A9%E5%99%A8%E4%B8%8A">将通道注册到选择器上</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-nio.html#%E7%9B%91%E5%90%AC%E4%BA%8B%E4%BB%B6">监听事件</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-nio.html#%E8%8E%B7%E5%8F%96%E5%88%B0%E8%BE%BE%E7%9A%84%E4%BA%8B%E4%BB%B6">获取到达的事件</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-nio.html#%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF">事件循环</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-nio.html#%E5%A5%97%E6%8E%A5%E5%AD%97-nio-%E7%A4%BA%E4%BE%8B">套接字 NIO 示例</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-nio.html#%E5%86%85%E5%AD%98%E6%98%A0%E5%B0%84%E6%96%87%E4%BB%B6">内存映射文件</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-nio.html#%E4%BA%94nio-vs-bio">五、NIO vs. BIO</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-nio.html#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">参考资料</a></li>
</ul>
<h2 id="-475"><a class="markdownIt-Anchor" href="#-475">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-nio.html#%E4%B8%80%E3%80%81nio-%E7%AE%80%E4%BB%8B">#</a>一、NIO 简介</h2>
<p>NIO 是一种同步非阻塞的 I/O 模型，在 Java 1.4 中引入了 NIO 框架，对应  <code>java.nio</code>  包，提供了  <code>Channel</code>  、 <code>Selector</code> 、 <code>Buffer</code>  等抽象。</p>
<p>NIO 中的 N 可以理解为 Non-blocking，不单纯是 New。它支持面向缓冲的，基于通道的 I/O 操作方法。 NIO 提供了与传统 BIO 模型中的  <code>Socket</code>  和  <code>ServerSocket</code>  相对应的  <code>SocketChannel</code>  和  <code>ServerSocketChannel</code>  两种不同的套接字通道实现，两种通道都支持阻塞和非阻塞两种模式。阻塞模式使用就像传统中的支持一样，比较简单，但是性能和可靠性都不好；非阻塞模式正好与之相反。对于低负载、低并发的应用程序，可以使用同步阻塞 I/O 来提升开发速率和更好的维护性；对于高负载、高并发的（网络）应用，应使用 NIO 的非阻塞模式来开发。</p>
<h3 id="-476"><a class="markdownIt-Anchor" href="#-476">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-nio.html#nio-%E5%92%8C-bio-%E7%9A%84%E5%8C%BA%E5%88%AB">#</a>NIO 和 BIO 的区别</h3>
<h4 id="-477"><a class="markdownIt-Anchor" href="#-477">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-nio.html#non-blocking-io-%E9%9D%9E%E9%98%BB%E5%A1%9E">#</a>Non-blocking IO (非阻塞)</h4>
<p><strong>BIO 是阻塞的，NIO 是非阻塞的</strong>。</p>
<p>BIO 的各种流是阻塞的。这意味着，当一个线程调用  <code>read()</code>  或  <code>write()</code>  时，该线程被阻塞，直到有一些数据被读取，或数据完全写入。在此期间，该线程不能再干其他任何事。</p>
<p>NIO 使我们可以进行非阻塞 IO 操作。比如说，单线程中从通道读取数据到 buffer，同时可以继续做别的事情，当数据读取到 buffer 中后，线程再继续处理数据。写数据也是一样的。另外，非阻塞写也是如此。一个线程请求写入一些数据到某通道，但不需要等待它完全写入，这个线程同时可以去做别的事情。</p>
<h4 id="-478"><a class="markdownIt-Anchor" href="#-478">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-nio.html#buffer-%E7%BC%93%E5%86%B2%E5%8C%BA">#</a>Buffer (缓冲区)</h4>
<p><strong>BIO 面向流 (Stream oriented)，而 NIO 面向缓冲区 (Buffer oriented)</strong>。</p>
<p>Buffer 是一个对象，它包含一些要写入或者要读出的数据。在 NIO 类库中加入 Buffer 对象，体现了 NIO 与 BIO 的一个重要区别。在面向流的 BIO 中可以将数据直接写入或者将数据直接读到 Stream 对象中。虽然 Stream 中也有 Buffer 开头的扩展类，但只是流的包装类，还是从流读到缓冲区，而 NIO 却是直接读到 Buffer 中进行操作。</p>
<p>在 NIO 厍中，所有数据都是用缓冲区处理的。在读取数据时，它是直接读缓冲区中的数据；在写入数据时，写入到缓冲区中。任何时候访问 NIO 中的数据，都是通过缓冲区进行操作。</p>
<p>最常用的缓冲区是 ByteBuffer, 一个 ByteBuffer 提供了一组功能用于操作 byte 数组。除了 ByteBuffer, 还有其他的一些缓冲区，事实上，每一种 Java 基本类型（除了 Boolean 类型）都对应有一种缓冲区。</p>
<h4 id="-479"><a class="markdownIt-Anchor" href="#-479">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-nio.html#channel-%E9%80%9A%E9%81%93">#</a>Channel (通道)</h4>
<p>NIO 通过 Channel（通道） 进行读写。</p>
<p>通道是双向的，可读也可写，而流的读写是单向的。无论读写，通道只能和 Buffer 交互。因为 Buffer，通道可以异步地读写。</p>
<h4 id="-480"><a class="markdownIt-Anchor" href="#-480">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-nio.html#selector-%E9%80%89%E6%8B%A9%E5%99%A8">#</a>Selector (选择器)</h4>
<p>NIO 有选择器，而 IO 没有。</p>
<p>选择器用于使用单个线程处理多个通道。因此，它需要较少的线程来处理这些通道。线程之间的切换对于操作系统来说是昂贵的。 因此，为了提高系统效率选择器是有用的。</p>
<h3 id="-481"><a class="markdownIt-Anchor" href="#-481">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-nio.html#nio-%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%B5%81%E7%A8%8B">#</a>NIO 的基本流程</h3>
<p>通常来说 NIO 中的所有 IO 都是从 Channel（通道） 开始的。</p>
<ul>
<li>从通道进行数据读取 ：创建一个缓冲区，然后请求通道读取数据。</li>
<li>从通道进行数据写入 ：创建一个缓冲区，填充数据，并要求通道写入数据。</li>
</ul>
<h3 id="-482"><a class="markdownIt-Anchor" href="#-482">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-nio.html#nio-%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6">#</a>NIO 核心组件</h3>
<p>NIO 包含下面几个核心的组件：</p>
<ul>
<li><strong>Channel (通道)</strong></li>
<li><strong>Buffer (缓冲区)</strong></li>
<li><strong>Selector (选择器)</strong></li>
</ul>
<h2 id="-483"><a class="markdownIt-Anchor" href="#-483">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-nio.html#%E4%BA%8C%E3%80%81channel-%E9%80%9A%E9%81%93">#</a>二、Channel (通道)</h2>
<p>通道（ <code>Channel</code> ）是对 BIO 中的流的模拟，可以通过它读写数据。</p>
<p>Channel，类似在 Linux 之类操作系统上看到的文件描述符，是 NIO 中被用来支持批量式 IO 操作的一种抽象。</p>
<p>File 或者 Socket，通常被认为是比较高层次的抽象，而 Channel 则是更加操作系统底层的一种抽象，这也使得 NIO 得以充分利用现代操作系统底层机制，获得特定场景的性能优化，例如，DMA（Direct Memory Access）等。不同层次的抽象是相互关联的，我们可以通过 Socket 获取 Channel，反之亦然。</p>
<p>通道与流的不同之处在于：</p>
<ul>
<li><strong>流是单向的</strong> - 一个流只能单纯的负责读或写。</li>
<li><strong>通道是双向的</strong> - 一个通道可以同时用于读写。</li>
</ul>
<p>通道包括以下类型：</p>
<ul>
<li><code>FileChannel</code> ：从文件中读写数据；</li>
<li><code>DatagramChannel</code> ：通过 UDP 读写网络中数据；</li>
<li><code>SocketChannel</code> ：通过 TCP 读写网络中数据；</li>
<li><code>ServerSocketChannel</code> ：可以监听新进来的 TCP 连接，对每一个新进来的连接都会创建一个 SocketChannel。</li>
</ul>
<h2 id="-484"><a class="markdownIt-Anchor" href="#-484">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-nio.html#%E4%B8%89%E3%80%81buffer-%E7%BC%93%E5%86%B2%E5%8C%BA">#</a>三、Buffer (缓冲区)</h2>
<p>NIO 与传统 I/O 不同，它是基于块（Block）的，它以块为基本单位处理数据。 <code>Buffer</code>  是一块连续的内存块，是 NIO 读写数据的缓冲。 <code>Buffer</code>  可以将文件一次性读入内存再做后续处理，而传统的方式是边读文件边处理数据。</p>
<p><strong>向  <code>Channel</code>  读写的数据都必须先置于缓冲区中</strong>。也就是说，不会直接对通道进行读写数据，而是要先经过缓冲区。缓冲区实质上是一个数组，但它不仅仅是一个数组。缓冲区提供了对数据的结构化访问，而且还可以跟踪系统的读 / 写进程。</p>
<p>BIO 和 NIO 已经很好地集成了， <code>java.io.*</code>  已经以 NIO 为基础重新实现了，所以现在它可以利用 NIO 的一些特性。例如， <code>java.io.*</code>  包中的一些类包含以块的形式读写数据的方法，这使得即使在面向流的系统中，处理速度也会更快。</p>
<p>缓冲区包括以下类型：</p>
<ul>
<li><code>ByteBuffer</code></li>
<li><code>CharBuffer</code></li>
<li><code>ShortBuffer</code></li>
<li><code>IntBuffer</code></li>
<li><code>LongBuffer</code></li>
<li><code>FloatBuffer</code></li>
<li><code>DoubleBuffer</code></li>
</ul>
<h3 id="-485"><a class="markdownIt-Anchor" href="#-485">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-nio.html#%E7%BC%93%E5%86%B2%E5%8C%BA%E7%8A%B6%E6%80%81%E5%8F%98%E9%87%8F">#</a>缓冲区状态变量</h3>
<ul>
<li><code>capacity</code> ：最大容量；</li>
<li><code>position</code> ：当前已经读写的字节数；</li>
<li><code>limit</code> ：还可以读写的字节数。</li>
<li><code>mark</code> ：记录上一次 postion 的位置，默认是 0，算是一个便利性的考虑，往往不是必须 的。</li>
</ul>
<p>缓冲区状态变量的改变过程举例：</p>
<ol>
<li>新建一个大小为 8 个字节的缓冲区，此时 position 为 0，而 limit = capacity = 8。capacity 变量不会改变，下面的讨论会忽略它。</li>
<li>从输入通道中读取 5 个字节数据写入缓冲区中，此时 position 移动设置为 5，limit 保持不变。</li>
<li>在将缓冲区的数据写到输出通道之前，需要先调用 flip () 方法，这个方法将 limit 设置为当前 position，并将 position 设置为 0。</li>
<li>从缓冲区中取 4 个字节到输出缓冲中，此时 position 设为 4。</li>
<li>最后需要调用 clear () 方法来清空缓冲区，此时 position 和 limit 都被设置为最初位置。</li>
</ol>
<h3 id="-486"><a class="markdownIt-Anchor" href="#-486">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-nio.html#%E6%96%87%E4%BB%B6-nio-%E7%A4%BA%E4%BE%8B">#</a>文件 NIO 示例</h3>
<p>以下展示了使用 NIO 快速复制文件的实例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">fastCopy</span><span class="token punctuation">(</span><span class="token class-name">String</span> src<span class="token punctuation">,</span> <span class="token class-name">String</span> dist<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">/* 获得源文件的输入字节流 */</span>
    <span class="token class-name">FileInputStream</span> fin <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* 获取输入字节流的文件通道 */</span>
    <span class="token class-name">FileChannel</span> fcin <span class="token operator">=</span> fin<span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* 获取目标文件的输出字节流 */</span>
    <span class="token class-name">FileOutputStream</span> fout <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>dist<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* 获取输出字节流的通道 */</span>
    <span class="token class-name">FileChannel</span> fcout <span class="token operator">=</span> fout<span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* 为缓冲区分配 1024 个字节 */</span>
    <span class="token class-name">ByteBuffer</span> buffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocateDirect</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token comment">/* 从输入通道中读取数据到缓冲区中 */</span>
        <span class="token keyword">int</span> r <span class="token operator">=</span> fcin<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/* read() 返回 -1 表示 EOF */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">/* 切换读写 */</span>
        buffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/* 把缓冲区的内容写入输出文件中 */</span>
        fcout<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/* 清空缓冲区 */</span>
        buffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-487"><a class="markdownIt-Anchor" href="#-487">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-nio.html#directbuffer">#</a>DirectBuffer</h3>
<p>NIO 还提供了一个可以直接访问物理内存的类  <code>DirectBuffer</code> 。普通的  <code>Buffer</code>  分配的是 JVM 堆内存，而  <code>DirectBuffer</code>  是直接分配物理内存。</p>
<p>数据要输出到外部设备，必须先从用户空间复制到内核空间，再复制到输出设备，而  <code>DirectBuffer</code>  则是直接将步骤简化为从内核空间复制到外部设备，减少了数据拷贝。</p>
<p>这里拓展一点，由于  <code>DirectBuffer</code>  申请的是非 JVM 的物理内存，所以创建和销毁的代价很高。 <code>DirectBuffer</code>  申请的内存并不是直接由 JVM 负责垃圾回收，但在  <code>DirectBuffer</code>  包装类被回收时，会通过 Java 引用机制来释放该内存块。</p>
<h2 id="-488"><a class="markdownIt-Anchor" href="#-488">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-nio.html#%E5%9B%9B%E3%80%81selector-%E9%80%89%E6%8B%A9%E5%99%A8">#</a>四、Selector (选择器)</h2>
<p>NIO 常常被叫做非阻塞 IO，主要是因为 NIO 在网络通信中的非阻塞特性被广泛使用。</p>
<p><code>Selector</code>  是 Java NIO 编程的基础。用于检查一个或多个 NIO  <code>Channel</code>  的状态是否处于可读、可写。</p>
<p><strong>NIO 实现了 IO 多路复用中的 Reactor 模型</strong>：</p>
<ul>
<li>一个线程（ <code>Thread</code> ）使用一个<strong>选择器  <code>Selector</code>  通过轮询的方式去监听多个通道  <code>Channel</code>  上的事件（ <code>accpet</code> 、 <code>read</code> ）</strong>，如果某个  <code>Channel</code>  上面发生监听事件，这个  <code>Channel</code>  就处于就绪状态，然后进行 I/O 操作。</li>
<li>通过<strong>配置监听的通道  <code>Channel</code>  为非阻塞</strong>，那么当  <code>Channel</code>  上的 IO 事件还未到达时，就不会进入阻塞状态一直等待，而是继续轮询其它  <code>Channel</code> ，找到 IO 事件已经到达的  <code>Channel</code>  执行。</li>
<li>因为创建和切换线程的开销很大，因此使用<strong>一个线程来处理多个事件</strong>而不是一个线程处理一个事件具有更好的性能。</li>
</ul>
<p>需要注意的是，只有  <code>SocketChannel</code>  才能配置为非阻塞，而  <code>FileChannel</code>  不能，因为  <code>FileChannel</code>  配置非阻塞也没有意义。</p>
<blockquote>
<p>目前操作系统的 I/O 多路复用机制都使用了 epoll，相比传统的 select 机制，epoll 没有最大连接句柄 1024 的限制。所以 Selector 在理论上可以轮询成千上万的客户端。</p>
</blockquote>
<h3 id="-489"><a class="markdownIt-Anchor" href="#-489">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-nio.html#%E5%88%9B%E5%BB%BA%E9%80%89%E6%8B%A9%E5%99%A8">#</a>创建选择器</h3>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Selector</span> selector <span class="token operator">=</span> <span class="token class-name">Selector</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="-490"><a class="markdownIt-Anchor" href="#-490">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-nio.html#%E5%B0%86%E9%80%9A%E9%81%93%E6%B3%A8%E5%86%8C%E5%88%B0%E9%80%89%E6%8B%A9%E5%99%A8%E4%B8%8A">#</a>将通道注册到选择器上</h3>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">ServerSocketChannel</span> ssChannel <span class="token operator">=</span> <span class="token class-name">ServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ssChannel<span class="token punctuation">.</span><span class="token function">configureBlocking</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ssChannel<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>selector<span class="token punctuation">,</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span>OP_ACCEPT<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>通道必须配置为非阻塞模式，否则使用选择器就没有任何意义了，因为如果通道在某个事件上被阻塞，那么服务器就不能响应其它事件，必须等待这个事件处理完毕才能去处理其它事件，显然这和选择器的作用背道而驰。</p>
<p>在将通道注册到选择器上时，还需要指定要注册的具体事件，主要有以下几类：</p>
<ul>
<li><code>SelectionKey.OP_CONNECT</code></li>
<li><code>SelectionKey.OP_ACCEPT</code></li>
<li><code>SelectionKey.OP_READ</code></li>
<li><code>SelectionKey.OP_WRITE</code></li>
</ul>
<p>它们在 SelectionKey 的定义如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> OP_READ <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> OP_WRITE <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> OP_CONNECT <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> OP_ACCEPT <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看出每个事件可以被当成一个位域，从而组成事件集整数。例如：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">int</span> interestSet <span class="token operator">=</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span>OP_READ <span class="token operator">|</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span>OP_WRITE<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="-491"><a class="markdownIt-Anchor" href="#-491">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-nio.html#%E7%9B%91%E5%90%AC%E4%BA%8B%E4%BB%B6">#</a>监听事件</h3>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">int</span> num <span class="token operator">=</span> selector<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>使用  <code>select()</code>  来监听到达的事件，它会一直阻塞直到有至少一个事件到达。</p>
<h3 id="-492"><a class="markdownIt-Anchor" href="#-492">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-nio.html#%E8%8E%B7%E5%8F%96%E5%88%B0%E8%BE%BE%E7%9A%84%E4%BA%8B%E4%BB%B6">#</a>获取到达的事件</h3>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectionKey</span><span class="token punctuation">></span></span> keys <span class="token operator">=</span> selector<span class="token punctuation">.</span><span class="token function">selectedKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectionKey</span><span class="token punctuation">></span></span> keyIterator <span class="token operator">=</span> keys<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span>keyIterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">SelectionKey</span> key <span class="token operator">=</span> keyIterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">isAcceptable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">isReadable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">&#125;</span>
    keyIterator<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-493"><a class="markdownIt-Anchor" href="#-493">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-nio.html#%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF">#</a>事件循环</h3>
<p>因为一次 select () 调用不能处理完所有的事件，并且服务器端有可能需要一直监听事件，因此服务器端处理事件的代码一般会放在一个死循环内。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> num <span class="token operator">=</span> selector<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectionKey</span><span class="token punctuation">></span></span> keys <span class="token operator">=</span> selector<span class="token punctuation">.</span><span class="token function">selectedKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectionKey</span><span class="token punctuation">></span></span> keyIterator <span class="token operator">=</span> keys<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>keyIterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">SelectionKey</span> key <span class="token operator">=</span> keyIterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">isAcceptable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// ...</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">isReadable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// ...</span>
        <span class="token punctuation">&#125;</span>
        keyIterator<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-494"><a class="markdownIt-Anchor" href="#-494">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-nio.html#%E5%A5%97%E6%8E%A5%E5%AD%97-nio-%E7%A4%BA%E4%BE%8B">#</a>套接字 NIO 示例</h3>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NIOServer</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>

        <span class="token class-name">Selector</span> selector <span class="token operator">=</span> <span class="token class-name">Selector</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">ServerSocketChannel</span> ssChannel <span class="token operator">=</span> <span class="token class-name">ServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ssChannel<span class="token punctuation">.</span><span class="token function">configureBlocking</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ssChannel<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>selector<span class="token punctuation">,</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span>OP_ACCEPT<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">ServerSocket</span> serverSocket <span class="token operator">=</span> ssChannel<span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">InetSocketAddress</span> address <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span> <span class="token number">8888</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        serverSocket<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

            selector<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectionKey</span><span class="token punctuation">></span></span> keys <span class="token operator">=</span> selector<span class="token punctuation">.</span><span class="token function">selectedKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectionKey</span><span class="token punctuation">></span></span> keyIterator <span class="token operator">=</span> keys<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">while</span> <span class="token punctuation">(</span>keyIterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

                <span class="token class-name">SelectionKey</span> key <span class="token operator">=</span> keyIterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">isAcceptable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

                    <span class="token class-name">ServerSocketChannel</span> ssChannel1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ServerSocketChannel</span><span class="token punctuation">)</span> key<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">// 服务器会为每个新连接创建一个 SocketChannel</span>
                    <span class="token class-name">SocketChannel</span> sChannel <span class="token operator">=</span> ssChannel1<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    sChannel<span class="token punctuation">.</span><span class="token function">configureBlocking</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">// 这个新连接主要用于从客户端读取数据</span>
                    sChannel<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>selector<span class="token punctuation">,</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span>OP_READ<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">isReadable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

                    <span class="token class-name">SocketChannel</span> sChannel <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SocketChannel</span><span class="token punctuation">)</span> key<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">readDataFromSocketChannel</span><span class="token punctuation">(</span>sChannel<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    sChannel<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>

                keyIterator<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">readDataFromSocketChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> sChannel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>

        <span class="token class-name">ByteBuffer</span> buffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">StringBuilder</span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

            buffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> n <span class="token operator">=</span> sChannel<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            buffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> limit <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> dst <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">char</span><span class="token punctuation">[</span>limit<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> limit<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                dst<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> buffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            data<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>dst<span class="token punctuation">)</span><span class="token punctuation">;</span>
            buffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NIOClient</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Socket</span> socket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Socket</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span> <span class="token number">8888</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">OutputStream</span> out <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token string">"hello world"</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-495"><a class="markdownIt-Anchor" href="#-495">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-nio.html#%E5%86%85%E5%AD%98%E6%98%A0%E5%B0%84%E6%96%87%E4%BB%B6">#</a>内存映射文件</h3>
<p>内存映射文件 I/O 是一种读和写文件数据的方法，它可以比常规的基于流或者基于通道的 I/O 快得多。</p>
<p>向内存映射文件写入可能是危险的，只是改变数组的单个元素这样的简单操作，就可能会直接修改磁盘上的文件。修改数据与将数据保存到磁盘是没有分开的。</p>
<p>下面代码行将文件的前 1024 个字节映射到内存中，map () 方法返回一个 MappedByteBuffer，它是 ByteBuffer 的子类。因此，可以像使用其他任何 ByteBuffer 一样使用新映射的缓冲区，操作系统会在需要时负责执行映射。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">MappedByteBuffer</span> mbb <span class="token operator">=</span> fc<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">FileChannel<span class="token punctuation">.</span>MapMode</span><span class="token punctuation">.</span>READ_WRITE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="-496"><a class="markdownIt-Anchor" href="#-496">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-nio.html#%E4%BA%94%E3%80%81nio-vs-bio">#</a>五、NIO vs. BIO</h2>
<p>BIO 与 NIO 最重要的区别是数据打包和传输的方式：<strong>BIO 以流的方式处理数据，而 NIO 以块的方式处理数据</strong>。</p>
<ul>
<li><strong>面向流的 BIO 一次处理一个字节数据</strong>：一个输入流产生一个字节数据，一个输出流消费一个字节数据。为流式数据创建过滤器非常容易，链接几个过滤器，以便每个过滤器只负责复杂处理机制的一部分。不利的一面是，面向流的 I/O 通常相当慢。</li>
<li><strong>面向块的 NIO 一次处理一个数据块</strong>，按块处理数据比按流处理数据要快得多。但是面向块的 NIO 缺少一些面向流的 BIO 所具有的优雅性和简单性。</li>
</ul>
<p>BIO 模式：</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/20200630212345.png" alt="img"></p>
<p>NIO 模式：</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/20200630212248.png" alt="img"></p>
<hr>
<h1 id="深入理解-java-序列化"><a class="markdownIt-Anchor" href="#深入理解-java-序列化">#</a> 深入理解 Java 序列化</h1>
<blockquote>
<p><strong>📦 本文以及示例源码已归档在 <a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/">javacore(opens new window)</a></strong></p>
<p>*<strong> 关键词： <code>Serializable</code> 、 <code>serialVersionUID</code> 、 <code>transient</code> 、 <code>Externalizable</code> 、 <code>writeObject</code> 、 <code>readObject</code> *</strong></p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/20200630204142.png" alt="img"></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-serialization.html#1-java-%E5%BA%8F%E5%88%97%E5%8C%96%E7%AE%80%E4%BB%8B">1. Java 序列化简介</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-serialization.html#2-java-%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96">2. Java 序列化和反序列化</a></li>
<li>\3. Serializable 接口
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-serialization.html#31-serialversionuid">3.1. serialVersionUID</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-serialization.html#32-%E9%BB%98%E8%AE%A4%E5%BA%8F%E5%88%97%E5%8C%96%E6%9C%BA%E5%88%B6">3.2. 默认序列化机制</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-serialization.html#33-transient">3.3. transient</a></li>
</ul>
</li>
<li>\4. Externalizable 接口
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-serialization.html#41-externalizable-%E6%8E%A5%E5%8F%A3%E7%9A%84%E6%9B%BF%E4%BB%A3%E6%96%B9%E6%B3%95">4.1. Externalizable 接口的替代方法</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-serialization.html#42-readresolve-%E6%96%B9%E6%B3%95">4.2. readResolve () 方法</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-serialization.html#5-java-%E5%BA%8F%E5%88%97%E5%8C%96%E9%97%AE%E9%A2%98">5. Java 序列化问题</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-serialization.html#6-java-%E5%BA%8F%E5%88%97%E5%8C%96%E7%9A%84%E7%BC%BA%E9%99%B7">6. Java 序列化的缺陷</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-serialization.html#7-%E5%BA%8F%E5%88%97%E5%8C%96%E6%8A%80%E6%9C%AF%E9%80%89%E5%9E%8B">7. 序列化技术选型</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-serialization.html#8-%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">8. 参考资料</a></li>
</ul>
<h2 id="-497"><a class="markdownIt-Anchor" href="#-497">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-serialization.html#_1-java-%E5%BA%8F%E5%88%97%E5%8C%96%E7%AE%80%E4%BB%8B">#</a>1. Java 序列化简介</h2>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/1553224129484.png" alt="img"></p>
<ul>
<li><strong>序列化（serialize）</strong> - 序列化是将对象转换为字节流。</li>
<li><strong>反序列化（deserialize）</strong> - 反序列化是将字节流转换为对象。</li>
<li>序列化用途
<ul>
<li>序列化可以将对象的字节序列持久化 —— 保存在内存、文件、数据库中。</li>
<li>在网络上传送对象的字节序列。</li>
<li>RMI (远程方法调用)</li>
</ul>
</li>
</ul>
<blockquote>
<p>🔔 注意：使用 Java 对象序列化，在保存对象时，会把其状态保存为一组字节，在未来，再将这些字节组装成对象。必须注意地是，对象序列化保存的是对象的” 状态”，即它的成员变量。由此可知，<strong>对象序列化不会关注类中的静态变量</strong>。</p>
</blockquote>
<h2 id="-498"><a class="markdownIt-Anchor" href="#-498">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-serialization.html#_2-java-%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96">#</a>2. Java 序列化和反序列化</h2>
<p>Java 通过对象输入输出流来实现序列化和反序列化：</p>
<ul>
<li><code>java.io.ObjectOutputStream</code>  类的  <code>writeObject()</code>  方法可以实现序列化；</li>
<li><code>java.io.ObjectInputStream</code>  类的  <code>readObject()</code>  方法用于实现反序列化。</li>
</ul>
<p>序列化和反序列化示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SerializeDemo01</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">enum</span> <span class="token class-name">Sex</span> <span class="token punctuation">&#123;</span>
        MALE<span class="token punctuation">,</span>
        FEMALE
    <span class="token punctuation">&#125;</span>


    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token class-name">Integer</span> age <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token class-name">Sex</span> sex<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">Integer</span> age<span class="token punctuation">,</span> <span class="token class-name">Sex</span> sex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>sex <span class="token operator">=</span> sex<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token string">"Person&#123;"</span> <span class="token operator">+</span> <span class="token string">"name='"</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">'\''</span> <span class="token operator">+</span> <span class="token string">", age="</span> <span class="token operator">+</span> age <span class="token operator">+</span> <span class="token string">", sex="</span> <span class="token operator">+</span> sex <span class="token operator">+</span> <span class="token string">'&#125;'</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * 序列化
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token class-name">String</span> filename<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">File</span> f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 定义保存路径</span>
        <span class="token class-name">OutputStream</span> out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 文件输出流</span>
        <span class="token class-name">ObjectOutputStream</span> oos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 对象输出流</span>
        oos<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">"Jack"</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token class-name">Sex</span><span class="token punctuation">.</span>MALE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 保存对象</span>
        oos<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * 反序列化
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">deserialize</span><span class="token punctuation">(</span><span class="token class-name">String</span> filename<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">File</span> f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 定义保存路径</span>
        <span class="token class-name">InputStream</span> in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 文件输入流</span>
        <span class="token class-name">ObjectInputStream</span> ois <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 对象输入流</span>
        <span class="token class-name">Object</span> obj <span class="token operator">=</span> ois<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 读取对象</span>
        ois<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        in<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">final</span> <span class="token class-name">String</span> filename <span class="token operator">=</span> <span class="token string">"d:/text.dat"</span><span class="token punctuation">;</span>
        <span class="token function">serialize</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">deserialize</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// Output:</span>
<span class="token comment">// Person&#123;name='Jack', age=30, sex=MALE&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="-499"><a class="markdownIt-Anchor" href="#-499">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-serialization.html#_3-serializable-%E6%8E%A5%E5%8F%A3">#</a>3. Serializable 接口</h2>
<p><strong>被序列化的类必须属于 Enum、Array 和 Serializable 类型其中的任何一种，否则将抛出  <code>NotSerializableException</code>  异常</strong>。这是因为：在序列化操作过程中会对类型进行检查，如果不满足序列化类型要求，就会抛出异常。</p>
<p>【示例】 <code>NotSerializableException</code>  错误</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UnSerializeDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 其他内容略 &#125;</span>
    <span class="token comment">// 其他内容略</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>输出：结果就是出现如下异常信息。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Exception in thread "main" java.io.NotSerializableException:
...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="-500"><a class="markdownIt-Anchor" href="#-500">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-serialization.html#_3-1-serialversionuid">#</a>3.1. serialVersionUID</h3>
<p>请注意  <code>serialVersionUID</code>  字段，你可以在 Java 世界的无数类中看到这个字段。</p>
<p><code>serialVersionUID</code>  有什么作用，如何使用  <code>serialVersionUID</code> ？</p>
<p><strong> <code>serialVersionUID</code>  是 Java 为每个序列化类产生的版本标识</strong>。它可以用来保证在反序列时，发送方发送的和接受方接收的是可兼容的对象。如果接收方接收的类的  <code>serialVersionUID</code>  与发送方发送的  <code>serialVersionUID</code>  不一致，会抛出  <code>InvalidClassException</code> 。</p>
<p>如果可序列化类没有显式声明  <code>serialVersionUID</code> ，则序列化运行时将基于该类的各个方面计算该类的默认  <code>serialVersionUID</code>  值。尽管这样，还是<strong>建议在每一个序列化的类中显式指定  <code>serialVersionUID</code>  的值</strong>。因为不同的 jdk 编译很可能会生成不同的  <code>serialVersionUID</code>  默认值，从而导致在反序列化时抛出  <code>InvalidClassExceptions</code>  异常。</p>
<p><strong> <code>serialVersionUID</code>  字段必须是  <code>static final long</code>  类型</strong>。</p>
<p>我们来举个例子：</p>
<p>（1）有一个可序列化类 Person</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> age<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> address<span class="token punctuation">;</span>
    <span class="token comment">// 构造方法、get、set 方法略</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>（2）开发过程中，对 Person 做了修改，增加了一个字段 email，如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> age<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> address<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> email<span class="token punctuation">;</span>
    <span class="token comment">// 构造方法、get、set 方法略</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>由于这个类和老版本不兼容，我们需要修改版本号：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">2L</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>再次进行反序列化，则会抛出  <code>InvalidClassException</code>  异常。</p>
<p>综上所述，我们大概可以清楚：<strong> <code>serialVersionUID</code>  用于控制序列化版本是否兼容</strong>。若我们认为修改的可序列化类是向后兼容的，则不修改  <code>serialVersionUID</code> 。</p>
<h3 id="-501"><a class="markdownIt-Anchor" href="#-501">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-serialization.html#_3-2-%E9%BB%98%E8%AE%A4%E5%BA%8F%E5%88%97%E5%8C%96%E6%9C%BA%E5%88%B6">#</a>3.2. 默认序列化机制</h3>
<p>如果仅仅只是让某个类实现  <code>Serializable</code>  接口，而没有其它任何处理的话，那么就会使用默认序列化机制。</p>
<p>使用默认机制，在序列化对象时，不仅会序列化当前对象本身，还会对其父类的字段以及该对象引用的其它对象也进行序列化。同样地，这些其它对象引用的另外对象也将被序列化，以此类推。所以，如果一个对象包含的成员变量是容器类对象，而这些容器所含有的元素也是容器类对象，那么这个序列化的过程就会较复杂，开销也较大。</p>
<blockquote>
<p>🔔 注意：这里的父类和引用对象既然要进行序列化，那么它们当然也要满足序列化要求：<strong>被序列化的类必须属于 Enum、Array 和 Serializable 类型其中的任何一种</strong>。</p>
</blockquote>
<h3 id="-502"><a class="markdownIt-Anchor" href="#-502">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-serialization.html#_3-3-transient">#</a>3.3. transient</h3>
<p>在现实应用中，有些时候不能使用默认序列化机制。比如，希望在序列化过程中忽略掉敏感数据，或者简化序列化过程。下面将介绍若干影响序列化的方法。</p>
<p><strong>当某个字段被声明为  <code>transient</code>  后，默认序列化机制就会忽略该字段的内容，该字段的内容在序列化后无法获得访问</strong>。</p>
<p>我们将 SerializeDemo01 示例中的内部类 Person 的 age 字段声明为  <code>transient</code> ，如下所示：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SerializeDemo02</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">transient</span> <span class="token keyword">private</span> <span class="token class-name">Integer</span> age <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token comment">// 其他内容略</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// 其他内容略</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// Output:</span>
<span class="token comment">// name: Jack, age: null, sex: MALE</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从输出结果可以看出，age 字段没有被序列化。</p>
<h2 id="-503"><a class="markdownIt-Anchor" href="#-503">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-serialization.html#_4-externalizable-%E6%8E%A5%E5%8F%A3">#</a>4. Externalizable 接口</h2>
<p>无论是使用  <code>transient</code>  关键字，还是使用  <code>writeObject()</code>  和  <code>readObject()</code>  方法，其实都是基于  <code>Serializable</code>  接口的序列化。</p>
<p>JDK 中提供了另一个序列化接口– <code>Externalizable</code> 。</p>
<p><strong>可序列化类实现  <code>Externalizable</code>  接口之后，基于  <code>Serializable</code>  接口的默认序列化机制就会失效</strong>。</p>
<p>我们来基于 SerializeDemo02 再次做一些改动，代码如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExternalizeDemo01</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token keyword">implements</span> <span class="token class-name">Externalizable</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">transient</span> <span class="token keyword">private</span> <span class="token class-name">Integer</span> age <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token comment">// 其他内容略</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">writeObject</span><span class="token punctuation">(</span><span class="token class-name">ObjectOutputStream</span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
            out<span class="token punctuation">.</span><span class="token function">defaultWriteObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            out<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">readObject</span><span class="token punctuation">(</span><span class="token class-name">ObjectInputStream</span> in<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">&#123;</span>
            in<span class="token punctuation">.</span><span class="token function">defaultReadObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            age <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">writeExternal</span><span class="token punctuation">(</span><span class="token class-name">ObjectOutput</span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">readExternal</span><span class="token punctuation">(</span><span class="token class-name">ObjectInput</span> in<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
     <span class="token comment">// 其他内容略</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// Output:</span>
<span class="token comment">// call Person()</span>
<span class="token comment">// name: null, age: null, sex: null</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从该结果，一方面可以看出 Person 对象中任何一个字段都没有被序列化。另一方面，如果细心的话，还可以发现这此次序列化过程调用了 Person 类的无参构造方法。</p>
<ul>
<li><strong> <code>Externalizable</code>  继承于  <code>Serializable</code> ，它增添了两个方法： <code>writeExternal()</code>  与  <code>readExternal()</code> 。这两个方法在序列化和反序列化过程中会被自动调用，以便执行一些特殊操作</strong>。当使用该接口时，序列化的细节需要由程序员去完成。如上所示的代码，由于  <code>writeExternal()</code>  与  <code>readExternal()</code>  方法未作任何处理，那么该序列化行为将不会保存 / 读取任何一个字段。这也就是为什么输出结果中所有字段的值均为空。</li>
<li>另外，<strong>若使用  <code>Externalizable</code>  进行序列化，当读取对象时，会调用被序列化类的无参构造方法去创建一个新的对象；然后再将被保存对象的字段的值分别填充到新对象中</strong>。这就是为什么在此次序列化过程中 Person 类的无参构造方法会被调用。由于这个原因，实现  <code>Externalizable</code>  接口的类必须要提供一个无参的构造方法，且它的访问权限为  <code>public</code> 。</li>
</ul>
<p>对上述 Person 类作进一步的修改，使其能够对 name 与 age 字段进行序列化，但要忽略掉 gender 字段，如下代码所示：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExternalizeDemo02</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token keyword">implements</span> <span class="token class-name">Externalizable</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">transient</span> <span class="token keyword">private</span> <span class="token class-name">Integer</span> age <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token comment">// 其他内容略</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">writeObject</span><span class="token punctuation">(</span><span class="token class-name">ObjectOutputStream</span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
            out<span class="token punctuation">.</span><span class="token function">defaultWriteObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            out<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">readObject</span><span class="token punctuation">(</span><span class="token class-name">ObjectInputStream</span> in<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">&#123;</span>
            in<span class="token punctuation">.</span><span class="token function">defaultReadObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            age <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">writeExternal</span><span class="token punctuation">(</span><span class="token class-name">ObjectOutput</span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
            out<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            out<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">readExternal</span><span class="token punctuation">(</span><span class="token class-name">ObjectInput</span> in<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">&#123;</span>
            name <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> in<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            age <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
     <span class="token comment">// 其他内容略</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// Output:</span>
<span class="token comment">// call Person()</span>
<span class="token comment">// name: Jack, age: 30, sex: null</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-504"><a class="markdownIt-Anchor" href="#-504">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-serialization.html#_4-1-externalizable-%E6%8E%A5%E5%8F%A3%E7%9A%84%E6%9B%BF%E4%BB%A3%E6%96%B9%E6%B3%95">#</a>4.1. Externalizable 接口的替代方法</h3>
<p>实现  <code>Externalizable</code>  接口可以控制序列化和反序列化的细节。它有一个替代方法：实现  <code>Serializable</code>  接口，并添加  <code>writeObject(ObjectOutputStream out)</code>  与  <code>readObject(ObjectInputStream in)</code>  方法。序列化和反序列化过程中会自动回调这两个方法。</p>
<p>示例如下所示：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SerializeDemo03</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">transient</span> <span class="token keyword">private</span> <span class="token class-name">Integer</span> age <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token comment">// 其他内容略</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">writeObject</span><span class="token punctuation">(</span><span class="token class-name">ObjectOutputStream</span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
            out<span class="token punctuation">.</span><span class="token function">defaultWriteObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            out<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">readObject</span><span class="token punctuation">(</span><span class="token class-name">ObjectInputStream</span> in<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">&#123;</span>
            in<span class="token punctuation">.</span><span class="token function">defaultReadObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            age <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// 其他内容略</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// 其他内容略</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// Output:</span>
<span class="token comment">// name: Jack, age: 30, sex: MALE</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在  <code>writeObject()</code>  方法中会先调用  <code>ObjectOutputStream</code>  中的  <code>defaultWriteObject()</code>  方法，该方法会执行默认的序列化机制，如上节所述，此时会忽略掉 age 字段。然后再调用 writeInt () 方法显示地将 age 字段写入到  <code>ObjectOutputStream</code>  中。readObject () 的作用则是针对对象的读取，其原理与 writeObject () 方法相同。</p>
<blockquote>
<p>🔔 注意： <code>writeObject()</code>  与  <code>readObject()</code>  都是  <code>private</code>  方法，那么它们是如何被调用的呢？毫无疑问，是使用反射。详情可见  <code>ObjectOutputStream</code>  中的  <code>writeSerialData</code>  方法，以及  <code>ObjectInputStream</code>  中的  <code>readSerialData</code>  方法。</p>
</blockquote>
<h3 id="-505"><a class="markdownIt-Anchor" href="#-505">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-serialization.html#_4-2-readresolve-%E6%96%B9%E6%B3%95">#</a>4.2. readResolve () 方法</h3>
<p>当我们使用 Singleton 模式时，应该是期望某个类的实例应该是唯一的，但如果该类是可序列化的，那么情况可能会略有不同。此时对第 2 节使用的 Person 类进行修改，使其实现 Singleton 模式，如下所示：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SerializeDemo04</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">enum</span> <span class="token class-name">Sex</span> <span class="token punctuation">&#123;</span>
        MALE<span class="token punctuation">,</span> FEMALE
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">transient</span> <span class="token keyword">private</span> <span class="token class-name">Integer</span> age <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token class-name">Sex</span> sex<span class="token punctuation">;</span>
        <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Person</span> instatnce <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">"Tom"</span><span class="token punctuation">,</span> <span class="token number">31</span><span class="token punctuation">,</span> <span class="token class-name">Sex</span><span class="token punctuation">.</span>MALE<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"call Person()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">private</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">Integer</span> age<span class="token punctuation">,</span> <span class="token class-name">Sex</span> sex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>sex <span class="token operator">=</span> sex<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Person</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> instatnce<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">writeObject</span><span class="token punctuation">(</span><span class="token class-name">ObjectOutputStream</span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
            out<span class="token punctuation">.</span><span class="token function">defaultWriteObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            out<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">readObject</span><span class="token punctuation">(</span><span class="token class-name">ObjectInputStream</span> in<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">&#123;</span>
            in<span class="token punctuation">.</span><span class="token function">defaultReadObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            age <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token string">"name: "</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">", age: "</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">+</span> <span class="token string">", sex: "</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sex<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * 序列化
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token class-name">String</span> filename<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">File</span> f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 定义保存路径</span>
        <span class="token class-name">OutputStream</span> out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 文件输出流</span>
        <span class="token class-name">ObjectOutputStream</span> oos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 对象输出流</span>
        oos<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">"Jack"</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token class-name">Sex</span><span class="token punctuation">.</span>MALE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 保存对象</span>
        oos<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * 反序列化
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">deserialize</span><span class="token punctuation">(</span><span class="token class-name">String</span> filename<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">File</span> f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 定义保存路径</span>
        <span class="token class-name">InputStream</span> in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 文件输入流</span>
        <span class="token class-name">ObjectInputStream</span> ois <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 对象输入流</span>
        <span class="token class-name">Object</span> obj <span class="token operator">=</span> ois<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 读取对象</span>
        ois<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        in<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>obj <span class="token operator">==</span> <span class="token class-name">Person</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">final</span> <span class="token class-name">String</span> filename <span class="token operator">=</span> <span class="token string">"d:/text.dat"</span><span class="token punctuation">;</span>
        <span class="token function">serialize</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">deserialize</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// Output:</span>
<span class="token comment">// name: Jack, age: null, sex: MALE</span>
<span class="token comment">// false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>值得注意的是，从文件中获取的 Person 对象与 Person 类中的单例对象并不相等。<strong>为了能在单例类中仍然保持序列的特性，可以使用  <code>readResolve()</code>  方法</strong>。在该方法中直接返回 Person 的单例对象。我们在 SerializeDemo04 示例的基础上添加一个  <code>readResolve</code>  方法， 如下所示：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SerializeDemo05</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 其他内容略</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">&#123;</span>

        <span class="token comment">// private void readObject(ObjectInputStream in) throws IOException, ClassNotFoundException &#123;</span>
        <span class="token comment">//     in.defaultReadObject();</span>
        <span class="token comment">//     age = in.readInt();</span>
        <span class="token comment">// &#125;</span>

        <span class="token comment">// 添加此方法</span>
        <span class="token keyword">private</span> <span class="token class-name">Object</span> <span class="token function">readResolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> instatnce<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// 其他内容略</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 其他内容略</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// Output:</span>
<span class="token comment">// name: Tom, age: 31, sex: MALE</span>
<span class="token comment">// true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="-506"><a class="markdownIt-Anchor" href="#-506">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-serialization.html#_5-java-%E5%BA%8F%E5%88%97%E5%8C%96%E9%97%AE%E9%A2%98">#</a>5. Java 序列化问题</h2>
<p>Java 的序列化能保证对象状态的持久保存，但是遇到一些对象结构复杂的情况还是难以处理，这里归纳一下：</p>
<ul>
<li>父类是  <code>Serializable</code> ，所有子类都可以被序列化。</li>
<li>子类是  <code>Serializable</code>  ，父类不是，则子类可以正确序列化，但父类的属性不会被序列化（不报错，数据丢失）。</li>
<li>如果序列化的属性是对象，则这个对象也必须是  <code>Serializable</code>  ，否则报错。</li>
<li>反序列化时，如果对象的属性有修改或删减，则修改的部分属性会丢失，但不会报错。</li>
<li>反序列化时，如果  <code>serialVersionUID</code>  被修改，则反序列化会失败。</li>
</ul>
<h2 id="-507"><a class="markdownIt-Anchor" href="#-507">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-serialization.html#_6-java-%E5%BA%8F%E5%88%97%E5%8C%96%E7%9A%84%E7%BC%BA%E9%99%B7">#</a>6. Java 序列化的缺陷</h2>
<ul>
<li><strong>无法跨语言</strong>：Java 序列化目前只适用基于 Java 语言实现的框架，其它语言大部分都没有使用 Java 的序列化框架，也没有实现 Java 序列化这套协议。因此，如果是两个基于不同语言编写的应用程序相互通信，则无法实现两个应用服务之间传输对象的序列化与反序列化。</li>
<li><strong>容易被攻击</strong>：对象是通过在  <code>ObjectInputStream</code>  上调用  <code>readObject()</code>  方法进行反序列化的，它可以将类路径上几乎所有实现了  <code>Serializable</code>  接口的对象都实例化。这意味着，在反序列化字节流的过程中，该方法可以执行任意类型的代码，这是非常危险的。对于需要长时间进行反序列化的对象，不需要执行任何代码，也可以发起一次攻击。攻击者可以创建循环对象链，然后将序列化后的对象传输到程序中反序列化，这种情况会导致  <code>hashCode</code>  方法被调用次数呈次方爆发式增长，从而引发栈溢出异常。例如下面这个案例就可以很好地说明。</li>
<li><strong>序列化后的流太大</strong>：Java 序列化中使用了  <code>ObjectOutputStream</code>  来实现对象转二进制编码，编码后的数组很大，非常影响存储和传输效率。</li>
<li><strong>序列化性能太差</strong>：Java 的序列化耗时比较大。序列化的速度也是体现序列化性能的重要指标，如果序列化的速度慢，就会影响网络通信的效率，从而增加系统的响应时间。</li>
<li>序列化编程限制：
<ul>
<li>Java 官方的序列化一定<strong>需要实现  <code>Serializable</code>  接口</strong>。</li>
<li>Java 官方的序列化<strong>需要关注  <code>serialVersionUID</code> </strong>。</li>
</ul>
</li>
</ul>
<h2 id="-508"><a class="markdownIt-Anchor" href="#-508">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-serialization.html#_7-%E5%BA%8F%E5%88%97%E5%8C%96%E6%8A%80%E6%9C%AF%E9%80%89%E5%9E%8B">#</a>7. 序列化技术选型</h2>
<p>通过上一章节 ——Java 序列化的缺陷，我们了解到，Java 序列化方式存在许多缺陷。因此，建议使用第三方序列化工具来替代。</p>
<p>当然我们还有更加优秀的一些序列化和反序列化的工具，根据不同的使用场景可以自行选择！</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/apache/thrift">thrift (opens new window)</a>、<a target="_blank" rel="noopener" href="https://github.com/protocolbuffers/protobuf">protobuf (opens new window)</a>- 适用于<strong>对性能敏感，对开发体验要求不高</strong>。</li>
<li><a target="_blank" rel="noopener" href="http://hessian.caucho.com/doc/hessian-overview.xtp">hessian (opens new window)</a>- 适用于<strong>对开发体验敏感，性能有要求</strong>。</li>
<li><a target="_blank" rel="noopener" href="https://github.com/FasterXML/jackson">jackson (opens new window)</a>、<a target="_blank" rel="noopener" href="https://github.com/google/gson">gson (opens new window)</a>、<a target="_blank" rel="noopener" href="https://github.com/alibaba/fastjson">fastjson (opens new window)</a>- 适用于对序列化后的数据要求有<strong>良好的可读性</strong>（转为 json 、xml 形式）。</li>
</ul>
<hr>
<h1 id="java-网络编程"><a class="markdownIt-Anchor" href="#java-网络编程">#</a> Java 网络编程</h1>
<blockquote>
<p><strong>📦 本文以及示例源码已归档在 <a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/">javacore(opens new window)</a></strong></p>
<p><em><strong>关键词： <code>Socket</code> 、 <code>ServerSocket</code> 、 <code>DatagramPacket</code> 、 <code>DatagramSocket</code> </strong></em></p>
<p>网络编程是指编写运行在多个设备（计算机）的程序，这些设备都通过网络连接起来。</p>
<p><code>java.net</code>  包中提供了低层次的网络通信细节。你可以直接使用这些类和接口，来专注于解决问题，而不用关注通信细节。</p>
<p><a target="_blank" rel="noopener" href="http://java.net">java.net</a> 包中提供了两种常见的网络协议的支持：</p>
<ul>
<li><strong>TCP</strong> - TCP 是传输控制协议的缩写，它保障了两个应用程序之间的可靠通信。通常用于互联网协议，被称 TCP/ IP。</li>
<li><strong>UDP</strong> - UDP 是用户数据报协议的缩写，一个无连接的协议。提供了应用程序之间要发送的数据的数据包。</li>
</ul>
</blockquote>
<ul>
<li>Socket 和 ServerSocket
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-net.html#serversocket">ServerSocket</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-net.html#socket">Socket</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-net.html#socket-%E9%80%9A%E4%BF%A1%E7%A4%BA%E4%BE%8B">Socket 通信示例</a></li>
</ul>
</li>
<li>DatagramSocket 和 DatagramPacket
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-net.html#datagramsocket-%E9%80%9A%E4%BF%A1%E7%A4%BA%E4%BE%8B">DatagramSocket 通信示例</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-net.html#inetaddress">InetAddress</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-net.html#url">URL</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-net.html#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">参考资料</a></li>
</ul>
<h2 id="-509"><a class="markdownIt-Anchor" href="#-509">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-net.html#%E4%B8%80%E3%80%81socket-%E5%92%8C-serversocket">#</a>一、Socket 和 ServerSocket</h2>
<p>套接字（Socket）使用 TCP 提供了两台计算机之间的通信机制。 客户端程序创建一个套接字，并尝试连接服务器的套接字。</p>
<p><strong>Java 通过 Socket 和 ServerSocket 实现对 TCP 的支持</strong>。Java 中的 Socket 通信可以简单理解为：<strong> <code>java.net.Socket</code>  代表客户端， <code>java.net.ServerSocket</code>  代表服务端</strong>，二者可以建立连接，然后通信。</p>
<p>以下为 Socket 通信中建立建立的基本流程：</p>
<ul>
<li>服务器实例化一个  <code>ServerSocket</code>  对象，表示服务器绑定一个端口。</li>
<li>服务器调用  <code>ServerSocket</code>  的  <code>accept()</code>  方法，该方法将一直等待，直到客户端连接到服务器的绑定端口（即监听端口）。</li>
<li>服务器监听端口时，客户端实例化一个  <code>Socket</code>  对象，指定服务器名称和端口号来请求连接。</li>
<li><code>Socket</code>  类的构造函数试图将客户端连接到指定的服务器和端口号。如果通信被建立，则在客户端创建一个 Socket 对象能够与服务器进行通信。</li>
<li>在服务器端， <code>accept()</code>  方法返回服务器上一个新的  <code>Socket</code>  引用，该引用连接到客户端的  <code>Socket</code>  。</li>
</ul>
<p>连接建立后，可以通过使用 IO 流进行通信。每一个  <code>Socket</code>  都有一个输出流和一个输入流。客户端的输出流连接到服务器端的输入流，而客户端的输入流连接到服务器端的输出流。</p>
<p>TCP 是一个双向的通信协议，因此数据可以通过两个数据流在同一时间发送，以下是一些类提供的一套完整的有用的方法来实现 sockets。</p>
<h3 id="-510"><a class="markdownIt-Anchor" href="#-510">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-net.html#serversocket">#</a>ServerSocket</h3>
<p>服务器程序通过使用  <code>java.net.ServerSocket</code>  类以获取一个端口，并且监听客户端请求连接此端口的请求。</p>
<h4 id="-511"><a class="markdownIt-Anchor" href="#-511">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-net.html#serversocket-%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95">#</a>ServerSocket 构造方法</h4>
<p><code>ServerSocket</code>  有多个构造方法：</p>
<table>
<thead>
<tr>
<th><strong>方法</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ServerSocket()</code></td>
<td>创建非绑定服务器套接字。</td>
</tr>
<tr>
<td><code>ServerSocket(int port)</code></td>
<td>创建绑定到特定端口的服务器套接字。</td>
</tr>
<tr>
<td><code>ServerSocket(int port, int backlog)</code></td>
<td>利用指定的  <code>backlog</code>  创建服务器套接字并将其绑定到指定的本地端口号。</td>
</tr>
<tr>
<td><code>ServerSocket(int port, int backlog, InetAddress address)</code></td>
<td>使用指定的端口、监听  <code>backlog</code>  和要绑定到的本地 IP 地址创建服务器。</td>
</tr>
</tbody>
</table>
<h4 id="-512"><a class="markdownIt-Anchor" href="#-512">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-net.html#serversocket-%E5%B8%B8%E7%94%A8%E6%96%B9%E6%B3%95">#</a>ServerSocket 常用方法</h4>
<p>创建非绑定服务器套接字。 如果  <code>ServerSocket</code>  构造方法没有抛出异常，就意味着你的应用程序已经成功绑定到指定的端口，并且侦听客户端请求。</p>
<p>这里有一些  <code>ServerSocket</code>  类的常用方法：</p>
<table>
<thead>
<tr>
<th><strong>方法</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>int getLocalPort()</code></td>
<td>返回此套接字在其上侦听的端口。</td>
</tr>
<tr>
<td><code>Socket accept()</code></td>
<td>监听并接受到此套接字的连接。</td>
</tr>
<tr>
<td><code>void setSoTimeout(int timeout)</code></td>
<td>通过指定超时值启用 / 禁用  <code>SO_TIMEOUT</code> ，以毫秒为单位。</td>
</tr>
<tr>
<td><code>void bind(SocketAddress host, int backlog)</code></td>
<td>将  <code>ServerSocket</code>  绑定到特定地址（IP 地址和端口号）。</td>
</tr>
</tbody>
</table>
<h3 id="-513"><a class="markdownIt-Anchor" href="#-513">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-net.html#socket">#</a>Socket</h3>
<p><code>java.net.Socket</code>  类代表客户端和服务器都用来互相沟通的套接字。客户端要获取一个  <code>Socket</code>  对象通过实例化 ，而 服务器获得一个  <code>Socket</code>  对象则通过  <code>accept()</code>  方法 a 的返回值。</p>
<h4 id="-514"><a class="markdownIt-Anchor" href="#-514">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-net.html#socket-%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95">#</a>Socket 构造方法</h4>
<p><code>Socket</code>  类有 5 个构造方法：</p>
<table>
<thead>
<tr>
<th><strong>方法</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Socket()</code></td>
<td>通过系统默认类型的  <code>SocketImpl</code>  创建未连接套接字</td>
</tr>
<tr>
<td><code>Socket(String host, int port)</code></td>
<td>创建一个流套接字并将其连接到指定主机上的指定端口号。</td>
</tr>
<tr>
<td><code>Socket(InetAddress host, int port)</code></td>
<td>创建一个流套接字并将其连接到指定 IP 地址的指定端口号。</td>
</tr>
<tr>
<td><code>Socket(String host, int port, InetAddress localAddress, int localPort)</code></td>
<td>创建一个套接字并将其连接到指定远程主机上的指定远程端口。</td>
</tr>
<tr>
<td><code>Socket(InetAddress host, int port, InetAddress localAddress, int localPort)</code></td>
<td>创建一个套接字并将其连接到指定远程地址上的指定远程端口。</td>
</tr>
</tbody>
</table>
<p>当 Socket 构造方法返回，并没有简单的实例化了一个 Socket 对象，它实际上会尝试连接到指定的服务器和端口。</p>
<h4 id="-515"><a class="markdownIt-Anchor" href="#-515">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-net.html#socket-%E5%B8%B8%E7%94%A8%E6%96%B9%E6%B3%95">#</a>Socket 常用方法</h4>
<p>下面列出了一些感兴趣的方法，注意客户端和服务器端都有一个 Socket 对象，所以无论客户端还是服务端都能够调用这些方法。</p>
<table>
<thead>
<tr>
<th><strong>方法</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>void connect(SocketAddress host, int timeout)</code></td>
<td>将此套接字连接到服务器，并指定一个超时值。</td>
</tr>
<tr>
<td><code>InetAddress getInetAddress()</code></td>
<td>返回套接字连接的地址。</td>
</tr>
<tr>
<td><code>int getPort()</code></td>
<td>返回此套接字连接到的远程端口。</td>
</tr>
<tr>
<td><code>int getLocalPort()</code></td>
<td>返回此套接字绑定到的本地端口。</td>
</tr>
<tr>
<td><code>SocketAddress getRemoteSocketAddress()</code></td>
<td>返回此套接字连接的端点的地址，如果未连接则返回 null。</td>
</tr>
<tr>
<td><code>InputStream getInputStream()</code></td>
<td>返回此套接字的输入流。</td>
</tr>
<tr>
<td><code>OutputStream getOutputStream()</code></td>
<td>返回此套接字的输出流。</td>
</tr>
<tr>
<td><code>void close()</code></td>
<td>关闭此套接字。</td>
</tr>
</tbody>
</table>
<h3 id="-516"><a class="markdownIt-Anchor" href="#-516">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-net.html#socket-%E9%80%9A%E4%BF%A1%E7%A4%BA%E4%BE%8B">#</a>Socket 通信示例</h3>
<p>服务端示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloServer</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Socket 服务端</span>
        <span class="token comment">// 服务器在8888端口上监听</span>
        <span class="token class-name">ServerSocket</span> server <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerSocket</span><span class="token punctuation">(</span><span class="token number">8888</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"服务器运行中，等待客户端连接。"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 得到连接，程序进入到阻塞状态</span>
        <span class="token class-name">Socket</span> client <span class="token operator">=</span> server<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 打印流输出最方便</span>
        <span class="token class-name">PrintStream</span> out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PrintStream</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 向客户端输出信息</span>
        out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"hello world"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        server<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"服务器已向客户端发送消息，退出。"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>客户端示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloClient</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Socket 客户端</span>
        <span class="token class-name">Socket</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Socket</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">8888</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">InputStreamReader</span> inputStreamReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 一次性接收完成</span>
        <span class="token class-name">BufferedReader</span> buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span>inputStreamReader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> str <span class="token operator">=</span> buf<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        buf<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"客户端接收到服务器消息："</span> <span class="token operator">+</span> str <span class="token operator">+</span> <span class="token string">"，退出"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="-517"><a class="markdownIt-Anchor" href="#-517">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-net.html#%E4%BA%8C%E3%80%81datagramsocket-%E5%92%8C-datagrampacket">#</a>二、DatagramSocket 和 DatagramPacket</h2>
<p>Java 通过  <code>DatagramSocket</code>  和  <code>DatagramPacket</code>  实现对 UDP 协议的支持。</p>
<ul>
<li><code>DatagramPacket</code> ：数据包类</li>
<li><code>DatagramSocket</code> ：通信类</li>
</ul>
<p>UDP 服务端示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UDPServer</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 所有异常抛出</span>
        <span class="token class-name">String</span> str <span class="token operator">=</span> <span class="token string">"hello World!!!"</span><span class="token punctuation">;</span>
        <span class="token class-name">DatagramSocket</span> ds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DatagramSocket</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 服务端在3000端口上等待服务器发送信息</span>
        <span class="token class-name">DatagramPacket</span> dp <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">DatagramPacket</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> str<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">InetAddress</span><span class="token punctuation">.</span><span class="token function">getByName</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">9000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 所有的信息使用buf保存</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"发送信息。"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ds<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 发送信息出去</span>
        ds<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>UDP 客户端示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UDPClient</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 所有异常抛出</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 开辟空间，以接收数据</span>
        <span class="token class-name">DatagramSocket</span> ds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DatagramSocket</span><span class="token punctuation">(</span><span class="token number">9000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 客户端在9000端口上等待服务器发送信息</span>
        <span class="token class-name">DatagramPacket</span> dp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DatagramPacket</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 所有的信息使用buf保存</span>
        ds<span class="token punctuation">.</span><span class="token function">receive</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 接收数据</span>
        <span class="token class-name">String</span> str <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>dp<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> dp<span class="token punctuation">.</span><span class="token function">getLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"from "</span> <span class="token operator">+</span> dp<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHostAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"："</span>
            <span class="token operator">+</span> dp<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出内容</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="-518"><a class="markdownIt-Anchor" href="#-518">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-net.html#%E4%B8%89%E3%80%81inetaddress">#</a>三、InetAddress</h2>
<p><code>InetAddress</code>  类表示互联网协议 (IP) 地址。</p>
<p>没有公有的构造函数，只能通过静态方法来创建实例。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">InetAddress</span><span class="token punctuation">.</span><span class="token function">getByName</span><span class="token punctuation">(</span><span class="token class-name">String</span> host<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">InetAddress</span><span class="token punctuation">.</span><span class="token function">getByAddress</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> address<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h2 id="-519"><a class="markdownIt-Anchor" href="#-519">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-net.html#%E5%9B%9B%E3%80%81url">#</a>四、URL</h2>
<p>可以直接从 URL 中读取字节流数据。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>

    <span class="token class-name">URL</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">URL</span><span class="token punctuation">(</span><span class="token string">"http://www.baidu.com"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* 字节流 */</span>
    <span class="token class-name">InputStream</span> is <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">openStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* 字符流 */</span>
    <span class="token class-name">InputStreamReader</span> isr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>is<span class="token punctuation">,</span> <span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* 提供缓存功能 */</span>
    <span class="token class-name">BufferedReader</span> br <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span>isr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">String</span> line<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>line <span class="token operator">=</span> br<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    br<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<h1 id="java-io-工具类"><a class="markdownIt-Anchor" href="#java-io-工具类">#</a> Java IO 工具类</h1>
<blockquote>
<p><strong>📦 本文以及示例源码已归档在 <a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/">javacore(opens new window)</a></strong></p>
<p>*<strong> 关键词： <code>File</code> 、 <code>RandomAccessFile</code> 、 <code>System</code> 、 <code>Scanner</code> *</strong></p>
<p>本文介绍 Java IO 的一些常见工具类的用法和特性。</p>
</blockquote>
<ul>
<li>一、File
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-io-tool.html#createnewfille">createNewFille</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-io-tool.html#mkdir">mkdir</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-io-tool.html#delete">delete</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-io-tool.html#list-%E5%92%8C-listfiles">list 和 listFiles</a></li>
</ul>
</li>
<li>二、RandomAccessFile
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-io-tool.html#randomaccessfile-%E5%86%99%E6%93%8D%E4%BD%9C">RandomAccessFile 写操作</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-io-tool.html#randomaccessfile-%E8%AF%BB%E6%93%8D%E4%BD%9C">RandomAccessFile 读操作</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-io-tool.html#%E4%B8%89system">三、System</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-io-tool.html#%E5%9B%9Bscanner">四、Scanner</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-io-tool.html#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">参考资料</a></li>
</ul>
<h2 id="-520"><a class="markdownIt-Anchor" href="#-520">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-io-tool.html#%E4%B8%80%E3%80%81file">#</a>一、File</h2>
<p><code>File</code>  类是  <code>java.io</code>  包中唯一对文件本身进行操作的类。它可以对文件、目录进行增删查操作。</p>
<h3 id="-521"><a class="markdownIt-Anchor" href="#-521">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-io-tool.html#createnewfille">#</a>createNewFille</h3>
<p><strong>可以使用  <code>createNewFille()</code>  方法创建一个新文件</strong>。</p>
<p>注：</p>
<p>Windows 中使用反斜杠表示目录的分隔符  <code>\</code> 。</p>
<p>Linux 中使用正斜杠表示目录的分隔符  <code>/</code> 。</p>
<p>最好的做法是使用  <code>File.separator</code>  静态常量，可以根据所在操作系统选取对应的分隔符。</p>
<p>【示例】创建文件</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">File</span> f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">boolean</span> flag <span class="token operator">=</span> f<span class="token punctuation">.</span><span class="token function">createNewFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="-522"><a class="markdownIt-Anchor" href="#-522">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-io-tool.html#mkdir">#</a>mkdir</h3>
<p><strong>可以使用  <code>mkdir()</code>  来创建文件夹</strong>，但是如果要创建的目录的父路径不存在，则无法创建成功。</p>
<p>如果要解决这个问题，可以使用  <code>mkdirs()</code> ，当父路径不存在时，会连同上级目录都一并创建。</p>
<p>【示例】创建目录</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">File</span> f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">boolean</span> flag <span class="token operator">=</span> f<span class="token punctuation">.</span><span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="-523"><a class="markdownIt-Anchor" href="#-523">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-io-tool.html#delete">#</a>delete</h3>
<p><strong>可以使用  <code>delete()</code>  来删除文件或目录</strong>。</p>
<p>需要注意的是，如果删除的是目录，且目录不为空，直接用  <code>delete()</code>  删除会失败。</p>
<p>【示例】删除文件或目录</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">File</span> f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">boolean</span> flag <span class="token operator">=</span> f<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="-524"><a class="markdownIt-Anchor" href="#-524">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-io-tool.html#list-%E5%92%8C-listfiles">#</a>list 和 listFiles</h3>
<p><code>File</code>  中给出了两种列出文件夹内容的方法：</p>
<ul>
<li><strong> <code>list()</code> : 列出全部名称，返回一个字符串数组</strong>。</li>
<li><strong> <code>listFiles()</code> : 列出完整的路径，返回一个  <code>File</code>  对象数组</strong>。</li>
</ul>
<p><code>list()</code>  示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">File</span> f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> str<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> f<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><code>listFiles()</code>  示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">File</span> f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">File</span> files<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> f<span class="token punctuation">.</span><span class="token function">listFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h2 id="-525"><a class="markdownIt-Anchor" href="#-525">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-io-tool.html#%E4%BA%8C%E3%80%81randomaccessfile">#</a>二、RandomAccessFile</h2>
<blockquote>
<p>注： <code>RandomAccessFile</code>  类虽然可以实现对文件内容的读写操作，但是比较复杂。所以一般操作文件内容往往会使用字节流或字符流方式。</p>
</blockquote>
<p><code>RandomAccessFile</code>  类是随机读取类，它是一个完全独立的类。</p>
<p>它适用于由大小已知的记录组成的文件，所以我们可以使用  <code>seek()</code>  将记录从一处转移到另一处，然后读取或者修改记录。</p>
<p>文件中记录的大小不一定都相同，只要能够确定哪些记录有多大以及它们在文件中的位置即可。</p>
<h3 id="-526"><a class="markdownIt-Anchor" href="#-526">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-io-tool.html#randomaccessfile-%E5%86%99%E6%93%8D%E4%BD%9C">#</a>RandomAccessFile 写操作</h3>
<p>当用  <code>rw</code>  方式声明  <code>RandomAccessFile</code>  对象时，如果要写入的文件不存在，系统将自行创建。</p>
<p><code>r</code>  为只读； <code>w</code>  为只写； <code>rw</code>  为读写。</p>
<p>【示例】文件随机读写</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RandomAccessFileDemo01</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span> args<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">File</span> f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"d:"</span> <span class="token operator">+</span> <span class="token class-name">File</span><span class="token punctuation">.</span>separator <span class="token operator">+</span> <span class="token string">"test.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 指定要操作的文件</span>
        <span class="token class-name">RandomAccessFile</span> rdf <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 声明RandomAccessFile类的对象</span>
        rdf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RandomAccessFile</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token string">"rw"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 读写模式，如果文件不存在，会自动创建</span>
        <span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> age <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        name <span class="token operator">=</span> <span class="token string">"zhangsan"</span><span class="token punctuation">;</span> <span class="token comment">// 字符串长度为8</span>
        age <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span> <span class="token comment">// 数字的长度为4</span>
        rdf<span class="token punctuation">.</span><span class="token function">writeBytes</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将姓名写入文件之中</span>
        rdf<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将年龄写入文件之中</span>
        name <span class="token operator">=</span> <span class="token string">"lisi    "</span><span class="token punctuation">;</span> <span class="token comment">// 字符串长度为8</span>
        age <span class="token operator">=</span> <span class="token number">31</span><span class="token punctuation">;</span> <span class="token comment">// 数字的长度为4</span>
        rdf<span class="token punctuation">.</span><span class="token function">writeBytes</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将姓名写入文件之中</span>
        rdf<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将年龄写入文件之中</span>
        name <span class="token operator">=</span> <span class="token string">"wangwu  "</span><span class="token punctuation">;</span> <span class="token comment">// 字符串长度为8</span>
        age <span class="token operator">=</span> <span class="token number">32</span><span class="token punctuation">;</span> <span class="token comment">// 数字的长度为4</span>
        rdf<span class="token punctuation">.</span><span class="token function">writeBytes</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将姓名写入文件之中</span>
        rdf<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将年龄写入文件之中</span>
        rdf<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 关闭</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-527"><a class="markdownIt-Anchor" href="#-527">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-io-tool.html#randomaccessfile-%E8%AF%BB%E6%93%8D%E4%BD%9C">#</a>RandomAccessFile 读操作</h3>
<p>读取是直接使用  <code>r</code>  的模式即可，以只读的方式打开文件。</p>
<p>读取时所有的字符串只能按照 byte 数组方式读取出来，而且长度必须和写入时的固定大小相匹配。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RandomAccessFileDemo02</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span> args<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">File</span> f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"d:"</span> <span class="token operator">+</span> <span class="token class-name">File</span><span class="token punctuation">.</span>separator <span class="token operator">+</span> <span class="token string">"test.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 指定要操作的文件</span>
        <span class="token class-name">RandomAccessFile</span> rdf <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token comment">// 声明RandomAccessFile类的对象</span>
        rdf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RandomAccessFile</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 以只读的方式打开文件</span>
        <span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> age <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span> b<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">// 开辟byte数组</span>
        <span class="token comment">// 读取第二个人的信息，意味着要空出第一个人的信息</span>
        rdf<span class="token punctuation">.</span><span class="token function">skipBytes</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 跳过第一个人的信息</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            b<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> rdf<span class="token punctuation">.</span><span class="token function">readByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 读取一个字节</span>
        <span class="token punctuation">&#125;</span>
        name <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 将读取出来的byte数组变为字符串</span>
        age <span class="token operator">=</span> rdf<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 读取数字</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"第二个人的信息 --> 姓名："</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">"；年龄："</span> <span class="token operator">+</span> age<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 读取第一个人的信息</span>
        rdf<span class="token punctuation">.</span><span class="token function">seek</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 指针回到文件的开头</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            b<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> rdf<span class="token punctuation">.</span><span class="token function">readByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 读取一个字节</span>
        <span class="token punctuation">&#125;</span>
        name <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 将读取出来的byte数组变为字符串</span>
        age <span class="token operator">=</span> rdf<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 读取数字</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"第一个人的信息 --> 姓名："</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">"；年龄："</span> <span class="token operator">+</span> age<span class="token punctuation">)</span><span class="token punctuation">;</span>
        rdf<span class="token punctuation">.</span><span class="token function">skipBytes</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 空出第二个人的信息</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            b<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> rdf<span class="token punctuation">.</span><span class="token function">readByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 读取一个字节</span>
        <span class="token punctuation">&#125;</span>
        name <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 将读取出来的byte数组变为字符串</span>
        age <span class="token operator">=</span> rdf<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 读取数字</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"第三个人的信息 --> 姓名："</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">"；年龄："</span> <span class="token operator">+</span> age<span class="token punctuation">)</span><span class="token punctuation">;</span>
        rdf<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// 关闭</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="-528"><a class="markdownIt-Anchor" href="#-528">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-io-tool.html#%E4%B8%89%E3%80%81system">#</a>三、System</h2>
<p><code>System</code>  类中提供了大量的静态方法，可以获取系统相关的信息或系统级操作，其中提供了三个常用于 IO 的静态成员：</p>
<ul>
<li><code>System.out</code>  - 一个 PrintStream 流。System.out 一般会把你写到其中的数据输出到控制台上。System.out 通常仅用在类似命令行工具的控制台程序上。System.out 也经常用于打印程序的调试信息 (尽管它可能并不是获取程序调试信息的最佳方式)。</li>
<li><code>System.err</code>  - 一个 PrintStream 流。System.err 与 System.out 的运行方式类似，但它更多的是用于打印错误文本。一些类似 Eclipse 的程序，为了让错误信息更加显眼，会将错误信息以红色文本的形式通过 System.err 输出到控制台上。</li>
<li><code>System.in</code>  - 一个典型的连接控制台程序和键盘输入的 InputStream 流。通常当数据通过命令行参数或者配置文件传递给命令行 Java 程序的时候，<a target="_blank" rel="noopener" href="http://System.in">System.in</a> 并不是很常用。图形界面程序通过界面传递参数给程序，这是一块单独的 Java IO 输入机制。</li>
</ul>
<p>【示例】重定向  <code>System.out</code>  输出流</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SystemOutDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span> args<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">OutputStream</span> out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">"d:\\test.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PrintStream</span> ps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PrintStream</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">setOut</span><span class="token punctuation">(</span>ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"人生若只如初见，何事秋风悲画扇"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ps<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>【示例】重定向  <code>System.err</code>  输出流</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SystemErrDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span> args<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">OutputStream</span> bos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 实例化</span>
        <span class="token class-name">PrintStream</span> ps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PrintStream</span><span class="token punctuation">(</span>bos<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 实例化</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">setErr</span><span class="token punctuation">(</span>ps<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 输出重定向</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"此处有误"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>bos<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 输出内存中的数据</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>【示例】 <code>System.in</code>  接受控制台输入信息</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SystemInDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span> args<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">InputStream</span> input <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">;</span>
        <span class="token class-name">StringBuffer</span> buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"请输入内容："</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> temp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>temp <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">char</span> c <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> temp<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token string">'\n'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            buf<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"输入的内容为："</span> <span class="token operator">+</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        input<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="-529"><a class="markdownIt-Anchor" href="#-529">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/io/java-io-tool.html#%E5%9B%9B%E3%80%81scanner">#</a>四、Scanner</h2>
<p><strong> <code>Scanner</code>  可以获取用户的输入，并对数据进行校验</strong>。</p>
<p>【示例】校验输入数据是否格式正确</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ScannerDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span> args<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Scanner</span> scan <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scanner</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 从键盘接收数据</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">float</span> f <span class="token operator">=</span> <span class="token number">0.0f</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"输入整数："</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>scan<span class="token punctuation">.</span><span class="token function">hasNextInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 判断输入的是否是整数</span>
            i <span class="token operator">=</span> scan<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 接收整数</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"整数数据："</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"输入的不是整数！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"输入小数："</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>scan<span class="token punctuation">.</span><span class="token function">hasNextFloat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 判断输入的是否是小数</span>
            f <span class="token operator">=</span> scan<span class="token punctuation">.</span><span class="token function">nextFloat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 接收小数</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"小数数据："</span> <span class="token operator">+</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"输入的不是小数！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token class-name">Date</span> date <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> str <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"输入日期（yyyy-MM-dd）："</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>scan<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token string">"^\\d&#123;4&#125;-\\d&#123;2&#125;-\\d&#123;2&#125;$"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 判断</span>
            str <span class="token operator">=</span> scan<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token string">"^\\d&#123;4&#125;-\\d&#123;2&#125;-\\d&#123;2&#125;$"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 接收</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                date <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">"yyyy-MM-dd"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"输入的日期格式错误！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>输出：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">输入整数：20
整数数据：20
输入小数：3.2
小数数据：3.2
输入日期（yyyy-MM-dd）：1988-13-1
输入的日期格式错误！
null<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<h1 id="java-并发简介"><a class="markdownIt-Anchor" href="#java-并发简介">#</a> Java 并发简介</h1>
<blockquote>
<p><strong>关键词</strong>： <code>进程</code> 、 <code>线程</code> 、 <code>安全性</code> 、 <code>活跃性</code> 、 <code>性能</code> 、 <code>死锁</code> 、 <code>饥饿</code> 、 <code>上下文切换</code></p>
<p><strong>摘要</strong>：并发编程并非 Java 语言所独有，而是一种成熟的编程范式，Java 只是用自己的方式实现了并发工作模型。学习 Java 并发编程，应该先熟悉并发的基本概念，然后进一步了解并发的特性以及其特性所面临的问题。掌握了这些，当学习 Java 并发工具时，才会明白它们各自是为了解决什么问题，为什么要这样设计。通过这样由点到面的学习方式，更容易融会贯通，将并发知识形成体系化。</p>
<p><strong>📦 本文以及示例源码已归档在 <a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/">javacore(opens new window)</a></strong></p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200701113445.png" alt="img"></p>
<ul>
<li>\1. 并发概念
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.html#11-%E5%B9%B6%E5%8F%91%E5%92%8C%E5%B9%B6%E8%A1%8C">1.1. 并发和并行</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.html#12-%E5%90%8C%E6%AD%A5%E5%92%8C%E5%BC%82%E6%AD%A5">1.2. 同步和异步</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.html#13-%E9%98%BB%E5%A1%9E%E5%92%8C%E9%9D%9E%E9%98%BB%E5%A1%9E">1.3. 阻塞和非阻塞</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.html#14-%E8%BF%9B%E7%A8%8B%E5%92%8C%E7%BA%BF%E7%A8%8B">1.4. 进程和线程</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.html#15-%E7%AB%9E%E6%80%81%E6%9D%A1%E4%BB%B6%E5%92%8C%E4%B8%B4%E7%95%8C%E5%8C%BA">1.5. 竞态条件和临界区</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.html#16-%E7%AE%A1%E7%A8%8B">1.6. 管程</a></li>
</ul>
</li>
<li>\2. 并发的特点
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.html#21-%E6%8F%90%E5%8D%87%E8%B5%84%E6%BA%90%E5%88%A9%E7%94%A8%E7%8E%87">2.1. 提升资源利用率</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.html#22-%E7%A8%8B%E5%BA%8F%E5%93%8D%E5%BA%94%E6%9B%B4%E5%BF%AB">2.2. 程序响应更快</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.html#23-%E5%B9%B6%E5%8F%91%E7%9A%84%E9%97%AE%E9%A2%98">2.3. 并发的问题</a></li>
</ul>
</li>
<li>\3. 安全性问题
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.html#31-%E7%BC%93%E5%AD%98%E5%AF%BC%E8%87%B4%E7%9A%84%E5%8F%AF%E8%A7%81%E6%80%A7%E9%97%AE%E9%A2%98">3.1. 缓存导致的可见性问题</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.html#32-%E7%BA%BF%E7%A8%8B%E5%88%87%E6%8D%A2%E5%B8%A6%E6%9D%A5%E7%9A%84%E5%8E%9F%E5%AD%90%E6%80%A7%E9%97%AE%E9%A2%98">3.2. 线程切换带来的原子性问题</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.html#33-%E7%BC%96%E8%AF%91%E4%BC%98%E5%8C%96%E5%B8%A6%E6%9D%A5%E7%9A%84%E6%9C%89%E5%BA%8F%E6%80%A7%E9%97%AE%E9%A2%98">3.3. 编译优化带来的有序性问题</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.html#34-%E4%BF%9D%E8%AF%81%E5%B9%B6%E5%8F%91%E5%AE%89%E5%85%A8%E7%9A%84%E6%80%9D%E8%B7%AF">3.4. 保证并发安全的思路</a></li>
</ul>
</li>
<li>\4. 活跃性问题
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.html#41-%E6%AD%BB%E9%94%81deadlock">4.1. 死锁（Deadlock）</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.html#42-%E6%B4%BB%E9%94%81livelock">4.2. 活锁（Livelock）</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.html#43-%E9%A5%A5%E9%A5%BFstarvation">4.3. 饥饿（Starvation）</a></li>
</ul>
</li>
<li>\5. 性能问题
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.html#51-%E4%B8%8A%E4%B8%8B%E6%96%87%E5%88%87%E6%8D%A2">5.1. 上下文切换</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.html#52-%E8%B5%84%E6%BA%90%E9%99%90%E5%88%B6">5.2. 资源限制</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.html#6-%E5%B0%8F%E7%BB%93">6. 小结</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.html#7-%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">7. 参考资料</a></li>
</ul>
<h2 id="-530"><a class="markdownIt-Anchor" href="#-530">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.html#_1-%E5%B9%B6%E5%8F%91%E6%A6%82%E5%BF%B5">#</a>1. 并发概念</h2>
<p>并发编程中有很多术语概念相近，容易让人混淆。本节内容通过对比分析，力求让读者清晰理解其概念以及差异。</p>
<h3 id="-531"><a class="markdownIt-Anchor" href="#-531">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.html#_1-1-%E5%B9%B6%E5%8F%91%E5%92%8C%E5%B9%B6%E8%A1%8C">#</a>1.1. 并发和并行</h3>
<p>并发和并行是最容易让新手费解的概念，那么如何理解二者呢？其最关键的差异在于：是否是<strong>同时</strong>发生：</p>
<ul>
<li><strong>并发</strong>：是指具备处理多个任务的能力，但不一定要同时。</li>
<li><strong>并行</strong>：是指具备同时处理多个任务的能力。</li>
</ul>
<p>下面是我见过最生动的说明，摘自 <a target="_blank" rel="noopener" href="https://www.zhihu.com/question/33515481/answer/58849148">并发与并行的区别是什么？—— 知乎的高票答案 (opens new window)</a>：</p>
<ul>
<li>你吃饭吃到一半，电话来了，你一直到吃完了以后才去接，这就说明你不支持并发也不支持并行。</li>
<li>你吃饭吃到一半，电话来了，你停了下来接了电话，接完后继续吃饭，这说明你支持并发。</li>
<li>你吃饭吃到一半，电话来了，你一边打电话一边吃饭，这说明你支持并行。</li>
</ul>
<h3 id="-532"><a class="markdownIt-Anchor" href="#-532">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.html#_1-2-%E5%90%8C%E6%AD%A5%E5%92%8C%E5%BC%82%E6%AD%A5">#</a>1.2. 同步和异步</h3>
<ul>
<li><strong>同步</strong>：是指在发出一个调用时，在没有得到结果之前，该调用就不返回。但是一旦调用返回，就得到返回值了。</li>
<li><strong>异步</strong>：则是相反，调用在发出之后，这个调用就直接返回了，所以没有返回结果。换句话说，当一个异步过程调用发出后，调用者不会立刻得到结果。而是在调用发出后，被调用者通过状态、通知来通知调用者，或通过回调函数处理这个调用。</li>
</ul>
<p>举例来说明：</p>
<ul>
<li>同步就像是打电话：不挂电话，通话不会结束。</li>
<li>异步就像是发短信：发完短信后，就可以做其他事；当收到回复短信时，手机会通过铃声或振动来提醒。</li>
</ul>
<h3 id="-533"><a class="markdownIt-Anchor" href="#-533">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.html#_1-3-%E9%98%BB%E5%A1%9E%E5%92%8C%E9%9D%9E%E9%98%BB%E5%A1%9E">#</a>1.3. 阻塞和非阻塞</h3>
<p>阻塞和非阻塞关注的是程序在等待调用结果（消息，返回值）时的状态：</p>
<ul>
<li><strong>阻塞</strong>：是指调用结果返回之前，当前线程会被挂起。调用线程只有在得到结果之后才会返回。</li>
<li><strong>非阻塞</strong>：是指在不能立刻得到结果之前，该调用不会阻塞当前线程。</li>
</ul>
<p>举例来说明：</p>
<ul>
<li>阻塞调用就像是打电话，通话不结束，不能放下。</li>
<li>非阻塞调用就像是发短信，发完短信后，就可以做其他事，短信来了，手机会提醒。</li>
</ul>
<h3 id="-534"><a class="markdownIt-Anchor" href="#-534">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.html#_1-4-%E8%BF%9B%E7%A8%8B%E5%92%8C%E7%BA%BF%E7%A8%8B">#</a>1.4. 进程和线程</h3>
<ul>
<li><strong>进程</strong>：进程是具有一定独立功能的程序关于某个数据集合上的一次运行活动。进程是操作系统进行资源分配的基本单位。进程可视为一个正在运行的程序。</li>
<li><strong>线程</strong>：线程是操作系统进行调度的基本单位。</li>
</ul>
<p>进程和线程的差异：</p>
<ul>
<li>一个程序至少有一个进程，一个进程至少有一个线程。</li>
<li>线程比进程划分更细，所以执行开销更小，并发性更高</li>
<li>进程是一个实体，拥有独立的资源；而同一个进程中的多个线程共享进程的资源。</li>
</ul>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/processes-vs-threads.jpg" alt="img"></p>
<p>JVM 在单个进程中运行，JVM 中的线程共享属于该进程的堆。这就是为什么几个线程可以访问同一个对象。线程共享堆并拥有自己的堆栈空间。这是一个线程如何调用一个方法以及它的局部变量是如何保持线程安全的。但是堆不是线程安全的并且为了线程安全必须进行同步。</p>
<h3 id="-535"><a class="markdownIt-Anchor" href="#-535">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.html#_1-5-%E7%AB%9E%E6%80%81%E6%9D%A1%E4%BB%B6%E5%92%8C%E4%B8%B4%E7%95%8C%E5%8C%BA">#</a>1.5. 竞态条件和临界区</h3>
<ul>
<li><strong>竞态条件（Race Condition）</strong>：当两个线程竞争同一资源时，如果对资源的访问顺序敏感，就称存在竞态条件。</li>
<li><strong>临界区（Critical Sections）</strong>：导致竞态条件发生的代码区称作临界区。</li>
</ul>
<h3 id="-536"><a class="markdownIt-Anchor" href="#-536">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.html#_1-6-%E7%AE%A1%E7%A8%8B">#</a>1.6. 管程</h3>
<p>管程（Monitor），是指管理共享变量以及对共享变量的操作过程，让他们支持并发。</p>
<p>Java 采用的是管程技术，synchronized 关键字及 wait ()、notify ()、notifyAll () 这三个方法都是管程的组成部分。而<strong>管程和信号量是等价的，所谓等价指的是用管程能够实现信号量，也能用信号量实现管程</strong>。</p>
<h2 id="-537"><a class="markdownIt-Anchor" href="#-537">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.html#_2-%E5%B9%B6%E5%8F%91%E7%9A%84%E7%89%B9%E7%82%B9">#</a>2. 并发的特点</h2>
<p>技术在进步，CPU、内存、I/O 设备的性能也在不断提高。但是，始终存在一个核心矛盾：<strong>CPU、内存、I/O 设备存在速度差异</strong>。CPU 远快于内存，内存远快于 I/O 设备。</p>
<p>木桶短板理论告诉我们：一只木桶能装多少水，取决于最短的那块木板。同理，程序整体性能取决于最慢的操作（即 I/O 操作），所以单方面提高 CPU、内存的性能是无效的。</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/20201225170052.jpg" alt="img"></p>
<p>为了合理利用 CPU 的高性能，平衡这三者的速度差异，计算机体系机构、操作系统、编译程序都做出了贡献，主要体现为：</p>
<ul>
<li><strong>CPU 增加了缓存</strong>，以均衡与内存的速度差异；</li>
<li><strong>操作系统增加了进程、线程</strong>，以分时复用 CPU，进而均衡 CPU 与 I/O 设备的速度差异；</li>
<li><strong>编译程序优化指令执行次序</strong>，使得缓存能够得到更加合理地利用。</li>
</ul>
<p>其中，进程、线程使得计算机、程序有了并发处理任务的能力。</p>
<p>并发的优点在于：</p>
<ul>
<li>提升资源利用率</li>
<li>程序响应更快</li>
</ul>
<h3 id="-538"><a class="markdownIt-Anchor" href="#-538">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.html#_2-1-%E6%8F%90%E5%8D%87%E8%B5%84%E6%BA%90%E5%88%A9%E7%94%A8%E7%8E%87">#</a>2.1. 提升资源利用率</h3>
<p>想象一下，一个应用程序需要从本地文件系统中读取和处理文件的情景。比方说，从磁盘读取一个文件需要 5 秒，处理一个文件需要 2 秒。处理两个文件则需要：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">5秒读取文件A
2秒处理文件A
5秒读取文件B
2秒处理文件B
---------------------
总共需要14秒<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从磁盘中读取文件的时候，大部分的 CPU 时间用于等待磁盘去读取数据。在这段时间里，CPU 非常的空闲。它可以做一些别的事情。通过改变操作的顺序，就能够更好的使用 CPU 资源。看下面的顺序：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">5秒读取文件A
5秒读取文件B + 2秒处理文件A
2秒处理文件B
---------------------
总共需要12秒<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>CPU 等待第一个文件被读取完。然后开始读取第二个文件。当第二文件在被读取的时候，CPU 会去处理第一个文件。记住，在等待磁盘读取文件的时候，CPU 大 部分时间是空闲的。</p>
<p>总的说来，CPU 能够在等待 IO 的时候做一些其他的事情。这个不一定就是磁盘 IO。它也可以是网络的 IO，或者用户输入。通常情况下，网络和磁盘的 IO 比 CPU 和内存的 IO 慢的多。</p>
<h3 id="-539"><a class="markdownIt-Anchor" href="#-539">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.html#_2-2-%E7%A8%8B%E5%BA%8F%E5%93%8D%E5%BA%94%E6%9B%B4%E5%BF%AB">#</a>2.2. 程序响应更快</h3>
<p>将一个单线程应用程序变成多线程应用程序的另一个常见的目的是实现一个响应更快的应用程序。设想一个服务器应用，它在某一个端口监听进来的请求。当一个请求到来时，它去处理这个请求，然后再返回去监听。</p>
<p>服务器的流程如下所述：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">while</span><span class="token punctuation">(</span>server is active<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    listen <span class="token keyword">for</span> request
    process request
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果一个请求需要占用大量的时间来处理，在这段时间内新的客户端就无法发送请求给服务端。只有服务器在监听的时候，请求才能被接收。另一种设计是，监听线程把请求传递给工作者线程 (worker thread)，然后立刻返回去监听。而工作者线程则能够处理这个请求并发送一个回复给客户端。这种设计如下所述：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">while</span><span class="token punctuation">(</span>server is active<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    listen <span class="token keyword">for</span> request
    hand request <span class="token keyword">to</span> <span class="token namespace">worker</span> thread
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>这种方式，服务端线程迅速地返回去监听。因此，更多的客户端能够发送请求给服务端。这个服务也变得响应更快。</p>
<p>桌面应用也是同样如此。如果你点击一个按钮开始运行一个耗时的任务，这个线程既要执行任务又要更新窗口和按钮，那么在任务执行的过程中，这个应用程序看起来好像没有反应一样。相反，任务可以传递给工作者线程（worker thread)。当工作者线程在繁忙地处理任务的时候，窗口线程可以自由地响应其他用户的请求。当工作者线程完成任务的时候，它发送信号给窗口线程。窗口线程便可以更新应用程序窗口，并显示任务的结果。对用户而言，这种具有工作者线程设计的程序显得响应速度更快。</p>
<h3 id="-540"><a class="markdownIt-Anchor" href="#-540">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.html#_2-3-%E5%B9%B6%E5%8F%91%E7%9A%84%E9%97%AE%E9%A2%98">#</a>2.3. 并发的问题</h3>
<p>任何事物都有利弊，并发也不例外。</p>
<p>我们知道了并发带来的好处：提升资源利用率、程序响应更快，同时也要认识到并发带来的问题，主要有：</p>
<ul>
<li>安全性问题</li>
<li>活跃性问题</li>
<li>性能问题</li>
</ul>
<p>下面会一一讲解。</p>
<h2 id="-541"><a class="markdownIt-Anchor" href="#-541">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.html#_3-%E5%AE%89%E5%85%A8%E6%80%A7%E9%97%AE%E9%A2%98">#</a>3. 安全性问题</h2>
<p>并发最重要的问题是并发安全问题。</p>
<p><strong>并发安全</strong>：是指保证程序的正确性，使得并发处理结果符合预期。</p>
<p>并发安全需要保证几个基本特性：</p>
<ul>
<li><strong>可见性</strong> - 是一个线程修改了某个共享变量，其状态能够立即被其他线程知晓，通常被解释为将线程本地状态反映到主内存上， <code>volatile</code>  就是负责保证可见性的。</li>
<li><strong>原子性</strong> - 简单说就是相关操作不会中途被其他线程干扰，一般通过同步机制（加锁： <code>sychronized</code> 、 <code>Lock</code> ）实现。</li>
<li><strong>有序性</strong> - 是保证线程内串行语义，避免指令重排等。</li>
</ul>
<h3 id="-542"><a class="markdownIt-Anchor" href="#-542">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.html#_3-1-%E7%BC%93%E5%AD%98%E5%AF%BC%E8%87%B4%E7%9A%84%E5%8F%AF%E8%A7%81%E6%80%A7%E9%97%AE%E9%A2%98">#</a>3.1. 缓存导致的可见性问题</h3>
<blockquote>
<p>一个线程对共享变量的修改，另外一个线程能够立刻看到，称为 <strong>可见性</strong>。</p>
</blockquote>
<p>在单核时代，所有的线程都是在一颗 CPU 上执行，CPU 缓存与内存的数据一致性容易解决。因为所有线程都是操作同一个 CPU 的缓存，一个线程对缓存的写，对另外一个线程来说一定是可见的。例如在下面的图中，线程 A 和线程 B 都是操作同一个 CPU 里面的缓存，所以线程 A 更新了变量 V 的值，那么线程 B 之后再访问变量 V，得到的一定是 V 的最新值（线程 A 写过的值）。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200701110313.png" alt="img"></p>
<p>多核时代，每颗 CPU 都有自己的缓存，这时 CPU 缓存与内存的数据一致性就没那么容易解决了，当多个线程在不同的 CPU 上执行时，这些线程操作的是不同的 CPU 缓存。比如下图中，线程 A 操作的是 CPU-1 上的缓存，而线程 B 操作的是 CPU-2 上的缓存，很明显，这个时候线程 A 对变量 V 的操作对于线程 B 而言就不具备可见性了。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200701110431.png" alt="img"></p>
<p>【示例】线程不安全的示例</p>
<p>下面我们再用一段代码来验证一下多核场景下的可见性问题。下面的代码，每执行一次 add10K () 方法，都会循环 10000 次 count+=1 操作。在 calc () 方法中我们创建了两个线程，每个线程调用一次 add10K () 方法，我们来想一想执行 calc () 方法得到的结果应该是多少呢？</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">private</span> <span class="token keyword">long</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">add10K</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>idx<span class="token operator">++</span> <span class="token operator">&lt;</span> <span class="token number">10000</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      count <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">calc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">final</span> <span class="token class-name">Test</span> test <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 创建两个线程，执行 add() 操作</span>
    <span class="token class-name">Thread</span> th1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token punctuation">&#123;</span>
      test<span class="token punctuation">.</span><span class="token function">add10K</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Thread</span> th2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token punctuation">&#123;</span>
      test<span class="token punctuation">.</span><span class="token function">add10K</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 启动两个线程</span>
    th1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    th2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 等待两个线程执行结束</span>
    th1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    th2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> count<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>直觉告诉我们应该是 20000，因为在单线程里调用两次 add10K () 方法，count 的值就是 20000，但实际上 calc () 的执行结果是个 10000 到 20000 之间的随机数。为什么呢？</p>
<p>我们假设线程 A 和线程 B 同时开始执行，那么第一次都会将 count=0 读到各自的 CPU 缓存里，执行完 count+=1 之后，各自 CPU 缓存里的值都是 1，同时写入内存后，我们会发现内存中是 1，而不是我们期望的 2。之后由于各自的 CPU 缓存里都有了 count 的值，两个线程都是基于 CPU 缓存里的 count 值来计算，所以导致最终 count 的值都是小于 20000 的。这就是缓存的可见性问题。</p>
<p>循环 10000 次 count+=1 操作如果改为循环 1 亿次，你会发现效果更明显，最终 count 的值接近 1 亿，而不是 2 亿。如果循环 10000 次，count 的值接近 20000，原因是两个线程不是同时启动的，有一个时差。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200701110615.png" alt="img"></p>
<h3 id="-543"><a class="markdownIt-Anchor" href="#-543">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.html#_3-2-%E7%BA%BF%E7%A8%8B%E5%88%87%E6%8D%A2%E5%B8%A6%E6%9D%A5%E7%9A%84%E5%8E%9F%E5%AD%90%E6%80%A7%E9%97%AE%E9%A2%98">#</a>3.2. 线程切换带来的原子性问题</h3>
<p>由于 IO 太慢，早期的操作系统就发明了多进程，操作系统允许某个进程执行一小段时间（称为 <strong>时间片</strong>）。</p>
<p>在一个时间片内，如果一个进程进行一个 IO 操作，例如读个文件，这个时候该进程可以把自己标记为 “休眠状态” 并出让 CPU 的使用权，待文件读进内存，操作系统会把这个休眠的进程唤醒，唤醒后的进程就有机会重新获得 CPU 的使用权了。</p>
<p>这里的进程在等待 IO 时之所以会释放 CPU 使用权，是为了让 CPU 在这段等待时间里可以做别的事情，这样一来 CPU 的使用率就上来了；此外，如果这时有另外一个进程也读文件，读文件的操作就会排队，磁盘驱动在完成一个进程的读操作后，发现有排队的任务，就会立即启动下一个读操作，这样 IO 的使用率也上来了。</p>
<p>早期的操作系统基于进程来调度 CPU，不同进程间是不共享内存空间的，所以进程要做任务切换就要切换内存映射地址，而一个进程创建的所有线程，都是共享一个内存空间的，所以线程做任务切换成本就很低了。现代的操作系统都基于更轻量的线程来调度，现在我们提到的 “任务切换” 都是指 “线程切换”。</p>
<p>Java 并发程序都是基于多线程的，自然也会涉及到任务切换，也许你想不到，任务切换竟然也是并发编程里诡异 Bug 的源头之一。任务切换的时机大多数是在时间片结束的时候，我们现在基本都使用高级语言编程，高级语言里一条语句往往需要多条 CPU 指令完成，例如上面代码中的  <code>count += 1</code> ，至少需要三条 CPU 指令。</p>
<ul>
<li>指令 1：首先，需要把变量 count 从内存加载到 CPU 的寄存器；</li>
<li>指令 2：之后，在寄存器中执行 +1 操作；</li>
<li>指令 3：最后，将结果写入内存（缓存机制导致可能写入的是 CPU 缓存而不是内存）。</li>
</ul>
<p>操作系统做任务切换，可以发生在任何一条<strong> CPU 指令</strong>执行完，是的，是 CPU 指令，而不是高级语言里的一条语句。对于上面的三条指令来说，我们假设 count=0，如果线程 A 在指令 1 执行完后做线程切换，线程 A 和线程 B 按照下图的序列执行，那么我们会发现两个线程都执行了 count+=1 的操作，但是得到的结果不是我们期望的 2，而是 1。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200701110946.png" alt="img"></p>
<p>我们潜意识里面觉得 count+=1 这个操作是一个不可分割的整体，就像一个原子一样，线程的切换可以发生在 count+=1 之前，也可以发生在 count+=1 之后，但就是不会发生在中间。<strong>我们把一个或者多个操作在 CPU 执行的过程中不被中断的特性称为原子性</strong>。CPU 能保证的原子操作是 CPU 指令级别的，而不是高级语言的操作符，这是违背我们直觉的地方。因此，很多时候我们需要在高级语言层面保证操作的原子性。</p>
<h3 id="-544"><a class="markdownIt-Anchor" href="#-544">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.html#_3-3-%E7%BC%96%E8%AF%91%E4%BC%98%E5%8C%96%E5%B8%A6%E6%9D%A5%E7%9A%84%E6%9C%89%E5%BA%8F%E6%80%A7%E9%97%AE%E9%A2%98">#</a>3.3. 编译优化带来的有序性问题</h3>
<p>那并发编程里还有没有其他有违直觉容易导致诡异 Bug 的技术呢？有的，就是有序性。顾名思义，有序性指的是程序按照代码的先后顺序执行。编译器为了优化性能，有时候会改变程序中语句的先后顺序，例如程序中：“a=6；b=7；” 编译器优化后可能变成 “b=7；a=6；”，在这个例子中，编译器调整了语句的顺序，但是不影响程序的最终结果。不过有时候编译器及解释器的优化可能导致意想不到的 Bug。</p>
<p>在 Java 领域一个经典的案例就是利用双重检查创建单例对象，例如下面的代码：在获取实例 getInstance () 的方法中，我们首先判断 instance 是否为空，如果为空，则锁定 Singleton.class 并再次检查 instance 是否为空，如果还为空则创建 Singleton 的一个实例。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Singleton</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">static</span> <span class="token class-name">Singleton</span> instance<span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token class-name">Singleton</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">synchronized</span><span class="token punctuation">(</span><span class="token class-name">Singleton</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
          instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> instance<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>假设有两个线程 A、B 同时调用 getInstance () 方法，他们会同时发现  <code>instance == null</code>  ，于是同时对 Singleton.class 加锁，此时 JVM 保证只有一个线程能够加锁成功（假设是线程 A），另外一个线程则会处于等待状态（假设是线程 B）；线程 A 会创建一个 Singleton 实例，之后释放锁，锁释放后，线程 B 被唤醒，线程 B 再次尝试加锁，此时是可以加锁成功的，加锁成功后，线程 B 检查  <code>instance == null</code>  时会发现，已经创建过 Singleton 实例了，所以线程 B 不会再创建一个 Singleton 实例。</p>
<p>这看上去一切都很完美，无懈可击，但实际上这个 getInstance () 方法并不完美。问题出在哪里呢？出在 new 操作上，我们以为的 new 操作应该是：</p>
<ol>
<li>分配一块内存 M；</li>
<li>在内存 M 上初始化 Singleton 对象；</li>
<li>然后 M 的地址赋值给 instance 变量。</li>
</ol>
<p>但是实际上优化后的执行路径却是这样的：</p>
<ol>
<li>分配一块内存 M；</li>
<li>将 M 的地址赋值给 instance 变量；</li>
<li>最后在内存 M 上初始化 Singleton 对象。</li>
</ol>
<p>优化后会导致什么问题呢？我们假设线程 A 先执行 getInstance () 方法，当执行完指令 2 时恰好发生了线程切换，切换到了线程 B 上；如果此时线程 B 也执行 getInstance () 方法，那么线程 B 在执行第一个判断时会发现  <code>instance != null</code>  ，所以直接返回 instance，而此时的 instance 是没有初始化过的，如果我们这个时候访问 instance 的成员变量就可能触发空指针异常。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200701111050.png" alt="img"></p>
<h3 id="-545"><a class="markdownIt-Anchor" href="#-545">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.html#_3-4-%E4%BF%9D%E8%AF%81%E5%B9%B6%E5%8F%91%E5%AE%89%E5%85%A8%E7%9A%84%E6%80%9D%E8%B7%AF">#</a>3.4. 保证并发安全的思路</h3>
<h4 id="-546"><a class="markdownIt-Anchor" href="#-546">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.html#%E4%BA%92%E6%96%A5%E5%90%8C%E6%AD%A5-%E9%98%BB%E5%A1%9E%E5%90%8C%E6%AD%A5">#</a>互斥同步（阻塞同步）</h4>
<p>互斥同步是最常见的并发正确性保障手段。</p>
<p><strong>同步是指在多线程并发访问共享数据时，保证共享数据在同一时刻只能被一个线程访问</strong>。</p>
<p>互斥是实现同步的一种手段。临界区（Critical Sections）、互斥量（Mutex）和信号量（Semaphore）都是主要的互斥实现方式。</p>
<p>最典型的案例是使用  <code>synchronized</code>  或  <code>Lock</code>  。</p>
<p><strong>互斥同步最主要的问题是线程阻塞和唤醒所带来的性能问题</strong>，互斥同步属于一种悲观的并发策略，总是认为只要不去做正确的同步措施，那就肯定会出现问题。无论共享数据是否真的会出现竞争，它都要进行加锁（这里讨论的是概念模型，实际上虚拟机会优化掉很大一部分不必要的加锁）、用户态核心态转换、维护锁计数器和检查是否有被阻塞的线程需要唤醒等操作。</p>
<h4 id="-547"><a class="markdownIt-Anchor" href="#-547">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.html#%E9%9D%9E%E9%98%BB%E5%A1%9E%E5%90%8C%E6%AD%A5">#</a>非阻塞同步</h4>
<p>随着硬件指令集的发展，我们可以使用基于冲突检测的乐观并发策略：先进行操作，如果没有其它线程争用共享数据，那操作就成功了，否则采取补偿措施（不断地重试，直到成功为止）。这种乐观的并发策略的许多实现都不需要将线程阻塞，因此这种同步操作称为非阻塞同步。</p>
<p>为什么说乐观锁需要 <strong>硬件指令集的发展</strong> 才能进行？因为需要操作和冲突检测这两个步骤具备原子性。而这点是由硬件来完成，如果再使用互斥同步来保证就失去意义了。</p>
<p>这类乐观锁指令常见的有：</p>
<ul>
<li>测试并设置（Test-and-Set）</li>
<li>获取并增加（Fetch-and-Increment）</li>
<li>交换（Swap）</li>
<li>比较并交换（CAS）</li>
<li>加载链接、条件存储（Load-linked / Store-Conditional）</li>
</ul>
<p>Java 典型应用场景：J.U.C 包中的原子类（基于  <code>Unsafe</code>  类的 CAS 操作）</p>
<h4 id="-548"><a class="markdownIt-Anchor" href="#-548">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.html#%E6%97%A0%E5%90%8C%E6%AD%A5">#</a>无同步</h4>
<p>要保证线程安全，不一定非要进行同步。同步只是保证共享数据争用时的正确性，如果一个方法本来就不涉及共享数据，那么自然无须同步。</p>
<p>Java 中的 <strong>无同步方案</strong> 有：</p>
<ul>
<li><strong>可重入代码</strong> - 也叫纯代码。如果一个方法，它的 <strong>返回结果是可以预测的</strong>，即只要输入了相同的数据，就能返回相同的结果，那它就满足可重入性，当然也是线程安全的。</li>
<li><strong>线程本地存储</strong> - 使用 <strong> <code>ThreadLocal</code>  为共享变量在每个线程中都创建了一个本地副本</strong>，这个副本只能被当前线程访问，其他线程无法访问，那么自然是线程安全的。</li>
</ul>
<h2 id="-549"><a class="markdownIt-Anchor" href="#-549">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.html#_4-%E6%B4%BB%E8%B7%83%E6%80%A7%E9%97%AE%E9%A2%98">#</a>4. 活跃性问题</h2>
<h3 id="-550"><a class="markdownIt-Anchor" href="#-550">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.html#_4-1-%E6%AD%BB%E9%94%81-deadlock">#</a>4.1. 死锁（Deadlock）</h3>
<h4 id="-551"><a class="markdownIt-Anchor" href="#-551">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.html#%E4%BB%80%E4%B9%88%E6%98%AF%E6%AD%BB%E9%94%81">#</a>什么是死锁</h4>
<p>多个线程互相等待对方释放锁。</p>
<p>死锁是当线程进入无限期等待状态时发生的情况，因为所请求的锁被另一个线程持有，而另一个线程又等待第一个线程持有的另一个锁。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/cs/java/javacore/concurrent/deadlock.png" alt="img"></p>
<h4 id="-552"><a class="markdownIt-Anchor" href="#-552">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.html#%E9%81%BF%E5%85%8D%E6%AD%BB%E9%94%81">#</a>避免死锁</h4>
<p>（1）按序加锁</p>
<p>当多个线程需要相同的一些锁，但是按照不同的顺序加锁，死锁就很容易发生。</p>
<p>如果能确保所有的线程都是按照相同的顺序获得锁，那么死锁就不会发生。</p>
<p>按照顺序加锁是一种有效的死锁预防机制。但是，这种方式需要你事先知道所有可能会用到的锁 (译者注：并对这些锁做适当的排序)，但总有些时候是无法预知的。</p>
<p>（2）超时释放锁</p>
<p>另外一个可以避免死锁的方法是在尝试获取锁的时候加一个超时时间，这也就意味着在尝试获取锁的过程中若超过了这个时限该线程则放弃对该锁请求。若一个线程没有在给定的时限内成功获得所有需要的锁，则会进行回退并释放所有已经获得的锁，然后等待一段随机的时间再重试。这段随机的等待时间让其它线程有机会尝试获取相同的这些锁，并且让该应用在没有获得锁的时候可以继续运行 (译者注：加锁超时后可以先继续运行干点其它事情，再回头来重复之前加锁的逻辑)。</p>
<p>（3）死锁检测</p>
<p>死锁检测是一个更好的死锁预防机制，它主要是针对那些不可能实现按序加锁并且锁超时也不可行的场景。</p>
<p>每当一个线程获得了锁，会在线程和锁相关的数据结构中（map、graph 等等）将其记下。除此之外，每当有线程请求锁，也需要记录在这个数据结构中。</p>
<p>当一个线程请求锁失败时，这个线程可以遍历锁的关系图看看是否有死锁发生。</p>
<p>如果检测出死锁，有两种处理手段：</p>
<ul>
<li>释放所有锁，回退，并且等待一段随机的时间后重试。这个和简单的加锁超时类似，不一样的是只有死锁已经发生了才回退，而不会是因为加锁的请求超时了。虽然有回退和等待，但是如果有大量的线程竞争同一批锁，它们还是会重复地死锁（编者注：原因同超时类似，不能从根本上减轻竞争）。</li>
<li>一个更好的方案是给这些线程设置优先级，让一个（或几个）线程回退，剩下的线程就像没发生死锁一样继续保持着它们需要的锁。如果赋予这些线程的优先级是固定不变的，同一批线程总是会拥有更高的优先级。为避免这个问题，可以在死锁发生的时候设置随机的优先级。</li>
</ul>
<h3 id="-553"><a class="markdownIt-Anchor" href="#-553">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.html#_4-2-%E6%B4%BB%E9%94%81-livelock">#</a>4.2. 活锁（Livelock）</h3>
<h4 id="-554"><a class="markdownIt-Anchor" href="#-554">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.html#%E4%BB%80%E4%B9%88%E6%98%AF%E6%B4%BB%E9%94%81">#</a>什么是活锁</h4>
<p>活锁是一个递归的情况，两个或更多的线程会不断重复一个特定的代码逻辑。预期的逻辑通常为其他线程提供机会继续支持’this’线程。</p>
<p>想象这样一个例子：两个人在狭窄的走廊里相遇，二者都很礼貌，试图移到旁边让对方先通过。但是他们最终在没有取得任何进展的情况下左右摇摆，因为他们都在同一时间向相同的方向移动。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/cs/java/javacore/concurrent/livelock.png" alt="img"></p>
<p>如图所示：两个线程想要通过一个 Worker 对象访问共享公共资源的情况，但是当他们看到另一个 Worker（在另一个线程上调用）也是 “活动的” 时，它们会尝试将该资源交给其他工作者并等待为它完成。如果最初我们让两名工作人员都活跃起来，他们将会面临活锁问题。</p>
<h4 id="-555"><a class="markdownIt-Anchor" href="#-555">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.html#%E9%81%BF%E5%85%8D%E6%B4%BB%E9%94%81">#</a>避免活锁</h4>
<p>解决 “<strong>活锁</strong>” 的方案很简单，谦让时，尝试等待一个随机的时间就可以了。由于等待的时间是随机的，所以同时相撞后再次相撞的概率就很低了。“等待一个随机时间” 的方案虽然很简单，却非常有效，Raft 这样知名的分布式一致性算法中也用到了它。</p>
<h3 id="-556"><a class="markdownIt-Anchor" href="#-556">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.html#_4-3-%E9%A5%A5%E9%A5%BF-starvation">#</a>4.3. 饥饿（Starvation）</h3>
<h4 id="-557"><a class="markdownIt-Anchor" href="#-557">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.html#%E4%BB%80%E4%B9%88%E6%98%AF%E9%A5%A5%E9%A5%BF">#</a>什么是饥饿</h4>
<ul>
<li>高优先级线程吞噬所有的低优先级线程的 CPU 时间。</li>
<li>线程被永久堵塞在一个等待进入同步块的状态，因为其他线程总是能在它之前持续地对该同步块进行访问。</li>
<li>线程在等待一个本身 (在其上调用 wait ()) 也处于永久等待完成的对象，因为其他线程总是被持续地获得唤醒。</li>
</ul>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/cs/java/javacore/concurrent/starvation-and-fairness.png" alt="img"></p>
<p>饥饿问题最经典的例子就是哲学家问题。如图所示：有五个哲学家用餐，每个人要获得两把叉子才可以就餐。当 2、4 就餐时，1、3、5 永远无法就餐，只能看着盘中的美食饥饿的等待着。</p>
<h4 id="-558"><a class="markdownIt-Anchor" href="#-558">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.html#%E8%A7%A3%E5%86%B3%E9%A5%A5%E9%A5%BF">#</a>解决饥饿</h4>
<p>Java 不可能实现 100% 的公平性，我们依然可以通过同步结构在线程间实现公平性的提高。</p>
<p>有三种方案：</p>
<ul>
<li>保证资源充足</li>
<li>公平地分配资源</li>
<li>避免持有锁的线程长时间执行</li>
</ul>
<p>这三个方案中，方案一和方案三的适用场景比较有限，因为很多场景下，资源的稀缺性是没办法解决的，持有锁的线程执行的时间也很难缩短。倒是方案二的适用场景相对来说更多一些。</p>
<p>那如何公平地分配资源呢？在并发编程里，主要是使用<strong>公平锁</strong>。所谓公平锁，是一种先来后到的方案，线程的等待是有顺序的，排在等待队列前面的线程会优先获得资源。</p>
<h2 id="-559"><a class="markdownIt-Anchor" href="#-559">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.html#_5-%E6%80%A7%E8%83%BD%E9%97%AE%E9%A2%98">#</a>5. 性能问题</h2>
<p>并发执行一定比串行执行快吗？线程越多执行越快吗？</p>
<p>答案是：<strong>并发不一定比串行快</strong>。因为有创建线程和线程上下文切换的开销。</p>
<h3 id="-560"><a class="markdownIt-Anchor" href="#-560">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.html#_5-1-%E4%B8%8A%E4%B8%8B%E6%96%87%E5%88%87%E6%8D%A2">#</a>5.1. 上下文切换</h3>
<h4 id="-561"><a class="markdownIt-Anchor" href="#-561">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.html#%E4%BB%80%E4%B9%88%E6%98%AF%E4%B8%8A%E4%B8%8B%E6%96%87%E5%88%87%E6%8D%A2">#</a>什么是上下文切换？</h4>
<p>当 CPU 从执行一个线程切换到执行另一个线程时，CPU 需要保存当前线程的本地数据，程序指针等状态，并加载下一个要执行的线程的本地数据，程序指针等。这个开关被称为 “上下文切换”。</p>
<h4 id="-562"><a class="markdownIt-Anchor" href="#-562">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.html#%E5%87%8F%E5%B0%91%E4%B8%8A%E4%B8%8B%E6%96%87%E5%88%87%E6%8D%A2%E7%9A%84%E6%96%B9%E6%B3%95">#</a>减少上下文切换的方法</h4>
<ul>
<li>无锁并发编程 - 多线程竞争锁时，会引起上下文切换，所以多线程处理数据时，可以用一些办法来避免使用锁，如将数据的 ID 按照 Hash 算法取模分段，不同的线程处理不同段的数据。</li>
<li>CAS 算法 - Java 的 Atomic 包使用 CAS 算法来更新数据，而不需要加锁。</li>
<li>使用最少线程 - 避免创建不需要的线程，比如任务很少，但是创建了很多线程来处理，这样会造成大量线程都处于等待状态。</li>
<li>使用协程 - 在单线程里实现多任务的调度，并在单线程里维持多个任务间的切换。</li>
</ul>
<h3 id="-563"><a class="markdownIt-Anchor" href="#-563">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.html#_5-2-%E8%B5%84%E6%BA%90%E9%99%90%E5%88%B6">#</a>5.2. 资源限制</h3>
<h4 id="-564"><a class="markdownIt-Anchor" href="#-564">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.html#%E4%BB%80%E4%B9%88%E6%98%AF%E8%B5%84%E6%BA%90%E9%99%90%E5%88%B6">#</a>什么是资源限制</h4>
<p>资源限制是指在进行并发编程时，程序的执行速度受限于计算机硬件资源或软件资源。</p>
<h4 id="-565"><a class="markdownIt-Anchor" href="#-565">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.html#%E8%B5%84%E6%BA%90%E9%99%90%E5%88%B6%E5%BC%95%E5%8F%91%E7%9A%84%E9%97%AE%E9%A2%98">#</a>资源限制引发的问题</h4>
<p>在并发编程中，将代码执行速度加快的原则是将代码中串行执行的部分变成并发执行，但是如果将某段串行的代码并发执行，因为受限于资源，仍然在串行执行，这时候程序不仅不会加快执行，反而会更慢，因为增加了上下文切换和资源调度的时间。</p>
<h4 id="-566"><a class="markdownIt-Anchor" href="#-566">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.html#%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3%E8%B5%84%E6%BA%90%E9%99%90%E5%88%B6%E7%9A%84%E9%97%AE%E9%A2%98">#</a>如何解决资源限制的问题</h4>
<p>在资源限制情况下进行并发编程，根据不同的资源限制调整程序的并发度。</p>
<ul>
<li>对于硬件资源限制，可以考虑使用集群并行执行程序。</li>
<li>对于软件资源限制，可以考虑使用资源池将资源复用。</li>
</ul>
<h2 id="-567"><a class="markdownIt-Anchor" href="#-567">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.html#_6-%E5%B0%8F%E7%BB%93">#</a>6. 小结</h2>
<p>并发编程可以总结为三个核心问题：分工、同步、互斥。</p>
<ul>
<li><strong>分工</strong>：是指如何高效地拆解任务并分配给线程。</li>
<li><strong>同步</strong>：是指线程之间如何协作。</li>
<li><strong>互斥</strong>：是指保证同一时刻只允许一个线程访问共享资源。</li>
</ul>
<hr>
<h1 id="java-线程基础"><a class="markdownIt-Anchor" href="#java-线程基础">#</a> Java 线程基础</h1>
<blockquote>
<p><strong>📦 本文以及示例源码已归档在 <a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/">javacore(opens new window)</a></strong></p>
<p><strong>关键词： <code>Thread</code> 、 <code>Runnable</code> 、 <code>Callable</code> 、 <code>Future</code> 、 <code>wait</code> 、 <code>notify</code> 、 <code>notifyAll</code> 、 <code>join</code> 、 <code>sleep</code> 、 <code>yeild</code> 、 <code>线程状态</code> 、 <code>线程通信</code> </strong></p>
</blockquote>
<ul>
<li>\1. 线程简介
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80.html#11-%E4%BB%80%E4%B9%88%E6%98%AF%E8%BF%9B%E7%A8%8B">1.1. 什么是进程</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80.html#12-%E4%BB%80%E4%B9%88%E6%98%AF%E7%BA%BF%E7%A8%8B">1.2. 什么是线程</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80.html#13-%E8%BF%9B%E7%A8%8B%E5%92%8C%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%8C%BA%E5%88%AB">1.3. 进程和线程的区别</a></li>
</ul>
</li>
<li>\2. 创建线程
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80.html#21-thread">2.1. Thread</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80.html#22-runnable">2.2. Runnable</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80.html#23-callablefuturefuturetask">2.3. Callable、Future、FutureTask</a></li>
</ul>
</li>
<li>\3. 线程基本用法
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80.html#31-%E7%BA%BF%E7%A8%8B%E4%BC%91%E7%9C%A0">3.1. 线程休眠</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80.html#32-%E7%BA%BF%E7%A8%8B%E7%A4%BC%E8%AE%A9">3.2. 线程礼让</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80.html#33-%E7%BB%88%E6%AD%A2%E7%BA%BF%E7%A8%8B">3.3. 终止线程</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80.html#34-%E5%AE%88%E6%8A%A4%E7%BA%BF%E7%A8%8B">3.4. 守护线程</a></li>
</ul>
</li>
<li>\4. 线程通信
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80.html#41-waitnotifynotifyall">4.1. wait/notify/notifyAll</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80.html#42-join">4.2. join</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80.html#43-%E7%AE%A1%E9%81%93">4.3. 管道</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80.html#5-%E7%BA%BF%E7%A8%8B%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F">5. 线程生命周期</a></li>
<li>\6. 线程常见问题
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80.html#61-sleepyieldjoin-%E6%96%B9%E6%B3%95%E6%9C%89%E4%BB%80%E4%B9%88%E5%8C%BA%E5%88%AB">6.1. sleep、yield、join 方法有什么区别</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80.html#62-%E4%B8%BA%E4%BB%80%E4%B9%88-sleep-%E5%92%8C-yield-%E6%96%B9%E6%B3%95%E6%98%AF%E9%9D%99%E6%80%81%E7%9A%84">6.2. 为什么 sleep 和 yield 方法是静态的</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80.html#63-java-%E7%BA%BF%E7%A8%8B%E6%98%AF%E5%90%A6%E6%8C%89%E7%85%A7%E7%BA%BF%E7%A8%8B%E4%BC%98%E5%85%88%E7%BA%A7%E4%B8%A5%E6%A0%BC%E6%89%A7%E8%A1%8C">6.3. Java 线程是否按照线程优先级严格执行</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80.html#64-%E4%B8%80%E4%B8%AA%E7%BA%BF%E7%A8%8B%E4%B8%A4%E6%AC%A1%E8%B0%83%E7%94%A8-start%E6%96%B9%E6%B3%95%E4%BC%9A%E6%80%8E%E6%A0%B7">6.4. 一个线程两次调用 start () 方法会怎样</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80.html#65-start-%E5%92%8C-run-%E6%96%B9%E6%B3%95%E6%9C%89%E4%BB%80%E4%B9%88%E5%8C%BA%E5%88%AB">6.5.  <code>start</code>  和  <code>run</code>  方法有什么区别</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80.html#66-%E5%8F%AF%E4%BB%A5%E7%9B%B4%E6%8E%A5%E8%B0%83%E7%94%A8-thread-%E7%B1%BB%E7%9A%84-run-%E6%96%B9%E6%B3%95%E4%B9%88">6.6. 可以直接调用  <code>Thread</code>  类的  <code>run</code>  方法么</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80.html#7-%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">7. 参考资料</a></li>
</ul>
<h2 id="-568"><a class="markdownIt-Anchor" href="#-568">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80.html#_1-%E7%BA%BF%E7%A8%8B%E7%AE%80%E4%BB%8B">#</a>1. 线程简介</h2>
<h3 id="-569"><a class="markdownIt-Anchor" href="#-569">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80.html#_1-1-%E4%BB%80%E4%B9%88%E6%98%AF%E8%BF%9B%E7%A8%8B">#</a>1.1. 什么是进程</h3>
<p>简言之，<strong>进程可视为一个正在运行的程序</strong>。它是系统运行程序的基本单位，因此进程是动态的。进程是具有一定独立功能的程序关于某个数据集合上的一次运行活动。进程是操作系统进行资源分配的基本单位。</p>
<h3 id="-570"><a class="markdownIt-Anchor" href="#-570">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80.html#_1-2-%E4%BB%80%E4%B9%88%E6%98%AF%E7%BA%BF%E7%A8%8B">#</a>1.2. 什么是线程</h3>
<p>线程是操作系统进行调度的基本单位。线程也叫轻量级进程（Light Weight Process），在一个进程里可以创建多个线程，这些线程都拥有各自的计数器、堆栈和局部变量等属性，并且能够访问共享的内存变量。</p>
<h3 id="-571"><a class="markdownIt-Anchor" href="#-571">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80.html#_1-3-%E8%BF%9B%E7%A8%8B%E5%92%8C%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%8C%BA%E5%88%AB">#</a>1.3. 进程和线程的区别</h3>
<ul>
<li>一个程序至少有一个进程，一个进程至少有一个线程。</li>
<li>线程比进程划分更细，所以执行开销更小，并发性更高。</li>
<li>进程是一个实体，拥有独立的资源；而同一个进程中的多个线程共享进程的资源。</li>
</ul>
<h2 id="-572"><a class="markdownIt-Anchor" href="#-572">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80.html#_2-%E5%88%9B%E5%BB%BA%E7%BA%BF%E7%A8%8B">#</a>2. 创建线程</h2>
<p>创建线程有三种方式：</p>
<ul>
<li>继承  <code>Thread</code>  类</li>
<li>实现  <code>Runnable</code>  接口</li>
<li>实现  <code>Callable</code>  接口</li>
</ul>
<h3 id="-573"><a class="markdownIt-Anchor" href="#-573">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80.html#_2-1-thread">#</a>2.1. Thread</h3>
<p>通过继承  <code>Thread</code>  类创建线程的步骤：</p>
<ol>
<li>定义  <code>Thread</code>  类的子类，并覆写该类的  <code>run</code>  方法。 <code>run</code>  方法的方法体就代表了线程要完成的任务，因此把  <code>run</code>  方法称为执行体。</li>
<li>创建  <code>Thread</code>  子类的实例，即创建了线程对象。</li>
<li>调用线程对象的  <code>start</code>  方法来启动该线程。</li>
</ol>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 实例化对象</span>
        <span class="token class-name">MyThread</span> tA <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span><span class="token string">"Thread 线程-A"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MyThread</span> tB <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span><span class="token string">"Thread 线程-B"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 调用线程主体</span>
        tA<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tB<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyThread</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">&#123;</span>

        <span class="token keyword">private</span> <span class="token keyword">int</span> ticket <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>

        <span class="token class-name">MyThread</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">super</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>ticket <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" 卖出了第 "</span> <span class="token operator">+</span> ticket <span class="token operator">+</span> <span class="token string">" 张票"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                ticket<span class="token operator">--</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-574"><a class="markdownIt-Anchor" href="#-574">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80.html#_2-2-runnable">#</a>2.2. Runnable</h3>
<p><strong>实现  <code>Runnable</code>  接口优于继承  <code>Thread</code>  类</strong>，因为：</p>
<ul>
<li>Java 不支持多重继承，所有的类都只允许继承一个父类，但可以实现多个接口。如果继承了  <code>Thread</code>  类就无法继承其它类，这不利于扩展。</li>
<li>类可能只要求可执行就行，继承整个  <code>Thread</code>  类开销过大。</li>
</ul>
<p>通过实现  <code>Runnable</code>  接口创建线程的步骤：</p>
<ol>
<li>定义  <code>Runnable</code>  接口的实现类，并覆写该接口的  <code>run</code>  方法。该  <code>run</code>  方法的方法体同样是该线程的线程执行体。</li>
<li>创建  <code>Runnable</code>  实现类的实例，并以此实例作为  <code>Thread</code>  的 target 来创建  <code>Thread</code>  对象，该  <code>Thread</code>  对象才是真正的线程对象。</li>
<li>调用线程对象的  <code>start</code>  方法来启动该线程。</li>
</ol>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RunnableDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 实例化对象</span>
        <span class="token class-name">Thread</span> tA <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Runnable 线程-A"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> tB <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Runnable 线程-B"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 调用线程主体</span>
        tA<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tB<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyThread</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span>

        <span class="token keyword">private</span> <span class="token keyword">int</span> ticket <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>ticket <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" 卖出了第 "</span> <span class="token operator">+</span> ticket <span class="token operator">+</span> <span class="token string">" 张票"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                ticket<span class="token operator">--</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-575"><a class="markdownIt-Anchor" href="#-575">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80.html#_2-3-callable%E3%80%81future%E3%80%81futuretask">#</a>2.3. Callable、Future、FutureTask</h3>
<p><strong>继承 Thread 类和实现 Runnable 接口这两种创建线程的方式都没有返回值</strong>。所以，线程执行完后，无法得到执行结果。但如果期望得到执行结果该怎么做？</p>
<p>为了解决这个问题，Java 1.5 后，提供了  <code>Callable</code>  接口和  <code>Future</code>  接口，通过它们，可以在线程执行结束后，返回执行结果。</p>
<h4 id="-576"><a class="markdownIt-Anchor" href="#-576">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80.html#callable">#</a>Callable</h4>
<p>Callable 接口只声明了一个方法，这个方法叫做 call ()：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">/**
     * Computes a result, or throws an exception if unable to do so.
     *
     * @return computed result
     * @throws Exception if unable to compute a result
     */</span>
    <span class="token class-name">V</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>那么怎么使用 Callable 呢？一般情况下是配合 ExecutorService 来使用的，在 ExecutorService 接口中声明了若干个 submit 方法的重载版本：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">submit</span><span class="token punctuation">(</span><span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> task<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">submit</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> task<span class="token punctuation">,</span> <span class="token class-name">T</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> <span class="token function">submit</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> task<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>第一个 submit 方法里面的参数类型就是 Callable。</p>
<h4 id="-577"><a class="markdownIt-Anchor" href="#-577">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80.html#future">#</a>Future</h4>
<p>Future 就是对于具体的 Callable 任务的执行结果进行取消、查询是否完成、获取结果。必要时可以通过 get 方法获取执行结果，该方法会阻塞直到任务返回结果。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">boolean</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> mayInterruptIfRunning<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> <span class="token function">isCancelled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> <span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">V</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">;</span>
    <span class="token class-name">V</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">TimeoutException</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-578"><a class="markdownIt-Anchor" href="#-578">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80.html#futuretask">#</a>FutureTask</h4>
<p>FutureTask 类实现了 RunnableFuture 接口，RunnableFuture 继承了 Runnable 接口和 Future 接口。</p>
<p>所以，FutureTask 既可以作为 Runnable 被线程执行，又可以作为 Future 得到 Callable 的返回值。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FutureTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token keyword">implements</span> <span class="token class-name">RunnableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">public</span> <span class="token class-name">FutureTask</span><span class="token punctuation">(</span><span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">></span></span> callable<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token class-name">FutureTask</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> runnable<span class="token punctuation">,</span> <span class="token class-name">V</span> result<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">RunnableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">Runnable</span><span class="token punctuation">,</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>事实上，FutureTask 是 Future 接口的一个唯一实现类。</p>
<h4 id="-579"><a class="markdownIt-Anchor" href="#-579">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80.html#callable-future-futuretask-%E7%A4%BA%E4%BE%8B">#</a>Callable + Future + FutureTask 示例</h4>
<p>通过实现  <code>Callable</code>  接口创建线程的步骤：</p>
<ol>
<li>创建  <code>Callable</code>  接口的实现类，并实现  <code>call</code>  方法。该  <code>call</code>  方法将作为线程执行体，并且有返回值。</li>
<li>创建  <code>Callable</code>  实现类的实例，使用  <code>FutureTask</code>  类来包装  <code>Callable</code>  对象，该  <code>FutureTask</code>  对象封装了该  <code>Callable</code>  对象的  <code>call</code>  方法的返回值。</li>
<li>使用  <code>FutureTask</code>  对象作为  <code>Thread</code>  对象的 target 创建并启动新线程。</li>
<li>调用  <code>FutureTask</code>  对象的  <code>get</code>  方法来获得线程执行结束后的返回值。</li>
</ol>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CallableDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">></span></span> callable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">FutureTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">></span></span> future <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FutureTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>callable<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>future<span class="token punctuation">,</span> <span class="token string">"Callable 线程"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"任务耗时："</span> <span class="token operator">+</span> <span class="token punctuation">(</span>future<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000000</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"毫秒"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> <span class="token operator">|</span> <span class="token class-name">ExecutionException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyThread</span> <span class="token keyword">implements</span> <span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>

        <span class="token keyword">private</span> <span class="token keyword">int</span> ticket <span class="token operator">=</span> <span class="token number">10000</span><span class="token punctuation">;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">long</span> begin <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>ticket <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" 卖出了第 "</span> <span class="token operator">+</span> ticket <span class="token operator">+</span> <span class="token string">" 张票"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                ticket<span class="token operator">--</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token keyword">long</span> end <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>end <span class="token operator">-</span> begin<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="-580"><a class="markdownIt-Anchor" href="#-580">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80.html#_3-%E7%BA%BF%E7%A8%8B%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95">#</a>3. 线程基本用法</h2>
<p>线程（ <code>Thread</code> ）基本方法清单：</p>
<table>
<thead>
<tr>
<th>方法</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>run</code></td>
<td>线程的执行实体。</td>
</tr>
<tr>
<td><code>start</code></td>
<td>线程的启动方法。</td>
</tr>
<tr>
<td><code>currentThread</code></td>
<td>返回对当前正在执行的线程对象的引用。</td>
</tr>
<tr>
<td><code>setName</code></td>
<td>设置线程名称。</td>
</tr>
<tr>
<td><code>getName</code></td>
<td>获取线程名称。</td>
</tr>
<tr>
<td><code>setPriority</code></td>
<td>设置线程优先级。Java 中的线程优先级的范围是 [1,10]，一般来说，高优先级的线程在运行时会具有优先权。可以通过  <code>thread.setPriority(Thread.MAX_PRIORITY)</code>  的方式设置，默认优先级为 5。</td>
</tr>
<tr>
<td><code>getPriority</code></td>
<td>获取线程优先级。</td>
</tr>
<tr>
<td><code>setDaemon</code></td>
<td>设置线程为守护线程。</td>
</tr>
<tr>
<td><code>isDaemon</code></td>
<td>判断线程是否为守护线程。</td>
</tr>
<tr>
<td><code>isAlive</code></td>
<td>判断线程是否启动。</td>
</tr>
<tr>
<td><code>interrupt</code></td>
<td>中断另一个线程的运行状态。</td>
</tr>
<tr>
<td><code>interrupted</code></td>
<td>测试当前线程是否已被中断。通过此方法可以清除线程的中断状态。换句话说，如果要连续调用此方法两次，则第二次调用将返回 false（除非当前线程在第一次调用清除其中断状态之后且在第二次调用检查其状态之前再次中断）。</td>
</tr>
<tr>
<td><code>join</code></td>
<td>可以使一个线程强制运行，线程强制运行期间，其他线程无法运行，必须等待此线程完成之后才可以继续执行。</td>
</tr>
<tr>
<td><code>Thread.sleep</code></td>
<td>静态方法。将当前正在执行的线程休眠。</td>
</tr>
<tr>
<td><code>Thread.yield</code></td>
<td>静态方法。将当前正在执行的线程暂停，让其他线程执行。</td>
</tr>
</tbody>
</table>
<h3 id="-581"><a class="markdownIt-Anchor" href="#-581">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80.html#_3-1-%E7%BA%BF%E7%A8%8B%E4%BC%91%E7%9C%A0">#</a>3.1. 线程休眠</h3>
<p><strong>使用  <code>Thread.sleep</code>  方法可以使得当前正在执行的线程进入休眠状态。</strong></p>
<p>使用  <code>Thread.sleep</code>  需要向其传入一个整数值，这个值表示线程将要休眠的毫秒数。</p>
<p><code>Thread.sleep</code>  方法可能会抛出  <code>InterruptedException</code> ，因为异常不能跨线程传播回  <code>main</code>  中，因此必须在本地进行处理。线程中抛出的其它异常也同样需要在本地进行处理。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadSleepDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span><span class="token string">"线程A"</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span><span class="token string">"线程B"</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span><span class="token string">"线程C"</span><span class="token punctuation">,</span> <span class="token number">1500</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyThread</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span>

        <span class="token comment">/** 线程名称 */</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>

        <span class="token comment">/** 休眠时间 */</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> time<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">int</span> time<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>time <span class="token operator">=</span> time<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// 休眠指定的时间</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>time<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">"休眠"</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>time <span class="token operator">+</span> <span class="token string">"毫秒。"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-582"><a class="markdownIt-Anchor" href="#-582">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80.html#_3-2-%E7%BA%BF%E7%A8%8B%E7%A4%BC%E8%AE%A9">#</a>3.2. 线程礼让</h3>
<p><code>Thread.yield</code>  方法的调用声明了当前线程已经完成了生命周期中最重要的部分，可以切换给其它线程来执行 。</p>
<p>该方法只是对线程调度器的一个建议，而且也只是建议具有相同优先级的其它线程可以运行。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadYieldDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">MyThread</span> t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token string">"线程A"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token string">"线程B"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyThread</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"运行，i = "</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"线程礼让："</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token keyword">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-583"><a class="markdownIt-Anchor" href="#-583">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80.html#_3-3-%E7%BB%88%E6%AD%A2%E7%BA%BF%E7%A8%8B">#</a>3.3. 终止线程</h3>
<blockquote>
<p><strong> <code>Thread</code>  中的  <code>stop</code>  方法有缺陷，已废弃</strong>。</p>
<p>使用  <code>Thread.stop</code>  停止线程会导致它解锁所有已锁定的监视器（由于未经检查的  <code>ThreadDeath</code>  异常会在堆栈中传播，这是自然的结果）。 如果先前由这些监视器保护的任何对象处于不一致状态，则损坏的对象将对其他线程可见，从而可能导致任意行为。</p>
<p>stop () 方法会真的杀死线程，不给线程喘息的机会，如果线程持有 ReentrantLock 锁，被 stop () 的线程并不会自动调用 ReentrantLock 的 unlock () 去释放锁，那其他线程就再也没机会获得 ReentrantLock 锁，这实在是太危险了。所以该方法就不建议使用了，类似的方法还有 suspend () 和 resume () 方法，这两个方法同样也都不建议使用了，所以这里也就不多介绍了。 <code>Thread.stop</code>  的许多用法应由仅修改某些变量以指示目标线程应停止运行的代码代替。 目标线程应定期检查此变量，如果该变量指示要停止运行，则应按有序方式从其运行方法返回。如果目标线程等待很长时间（例如，在条件变量上），则应使用中断方法来中断等待。</p>
</blockquote>
<p>当一个线程运行时，另一个线程可以直接通过  <code>interrupt</code>  方法中断其运行状态。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadInterruptDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">MyThread</span> mt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 实例化Runnable子类对象</span>
        <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>mt<span class="token punctuation">,</span> <span class="token string">"线程"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 实例化Thread对象</span>
        t<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 启动线程</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 线程休眠2秒</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"3、main线程休眠被终止"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        t<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 中断线程执行</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyThread</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"1、进入run()方法"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 线程休眠10秒</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"2、已经完成了休眠"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"3、MyThread线程休眠被终止"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">// 返回调用处</span>
            <span class="token punctuation">&#125;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"4、run()方法正常结束"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果一个线程的  <code>run</code>  方法执行一个无限循环，并且没有执行  <code>sleep</code>  等会抛出  <code>InterruptedException</code>  的操作，那么调用线程的  <code>interrupt</code>  方法就无法使线程提前结束。</p>
<p>但是调用  <code>interrupt</code>  方法会设置线程的中断标记，此时调用  <code>interrupted</code>  方法会返回  <code>true</code> 。因此可以在循环体中使用  <code>interrupted</code>  方法来判断线程是否处于中断状态，从而提前结束线程。</p>
<p>安全地终止线程有两种方法：</p>
<ul>
<li>定义  <code>volatile</code>  标志位，在  <code>run</code>  方法中使用标志位控制线程终止</li>
<li>使用  <code>interrupt</code>  方法和  <code>Thread.interrupted</code>  方法配合使用来控制线程终止</li>
</ul>
<p>【示例】使用  <code>volatile</code>  标志位控制线程终止</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadStopDemo2</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">MyTask</span> task <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> <span class="token string">"MyTask"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        task<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyTask</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span>

        <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">long</span> count <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" 线程启动"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>count<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" 线程终止"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">/**
         * 通过 volatile 标志位来控制线程终止
         */</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>【示例】使用  <code>interrupt</code>  方法和  <code>Thread.interrupted</code>  方法配合使用来控制线程终止</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadStopDemo3</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">MyTask</span> task <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> <span class="token string">"MyTask"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        thread<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyTask</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span>

        <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">long</span> count <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" 线程启动"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 通过 Thread.interrupted 和 interrupt 配合来控制线程终止</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>count<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" 线程终止"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-584"><a class="markdownIt-Anchor" href="#-584">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80.html#_3-4-%E5%AE%88%E6%8A%A4%E7%BA%BF%E7%A8%8B">#</a>3.4. 守护线程</h3>
<p>什么是守护线程？</p>
<ul>
<li><strong>守护线程（Daemon Thread）是在后台执行并且不会阻止 JVM 终止的线程</strong>。<strong>当所有非守护线程结束时，程序也就终止，同时会杀死所有守护线程</strong>。</li>
<li>与守护线程（Daemon Thread）相反的，叫用户线程（User Thread），也就是非守护线程。</li>
</ul>
<p>为什么需要守护线程？</p>
<ul>
<li>守护线程的优先级比较低，用于为系统中的其它对象和线程提供服务。典型的应用就是垃圾回收器。</li>
</ul>
<p>如何使用守护线程？</p>
<ul>
<li>
<p>可以使用  <code>isDaemon</code>  方法判断线程是否为守护线程。</p>
</li>
<li>
<p>可以使用</p>
</li>
</ul>
<p>​</p>
<pre><code><pre class="line-numbers language-none"><code class="language-none">setDaemon<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</code></pre>
<p>​</p>
<pre><code>方法设置线程为守护线程。

- 正在运行的用户线程无法设置为守护线程，所以 `setDaemon` 必须在 `thread.start` 方法之前设置，否则会抛出 `llegalThreadStateException` 异常；
- 一个守护线程创建的子线程依然是守护线程。
- 不要认为所有的应用都可以分配给守护线程来进行服务，比如读写操作或者计算逻辑。
</code></pre>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadDaemonDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"线程"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t<span class="token punctuation">.</span><span class="token function">setDaemon</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 此线程在后台运行</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"线程 t 是否是守护进程："</span> <span class="token operator">+</span> t<span class="token punctuation">.</span><span class="token function">isDaemon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 启动线程</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyThread</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"在运行。"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>参考阅读：<a target="_blank" rel="noopener" href="https://blog.csdn.net/shimiso/article/details/8964414">Java 中守护线程的总结 (opens new window)</a></p>
</blockquote>
<h2 id="-585"><a class="markdownIt-Anchor" href="#-585">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80.html#_4-%E7%BA%BF%E7%A8%8B%E9%80%9A%E4%BF%A1">#</a>4. 线程通信</h2>
<blockquote>
<p>当多个线程可以一起工作去解决某个问题时，如果某些部分必须在其它部分之前完成，那么就需要对线程进行协调。</p>
</blockquote>
<h3 id="-586"><a class="markdownIt-Anchor" href="#-586">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80.html#_4-1-wait-notify-notifyall">#</a>4.1. wait/notify/notifyAll</h3>
<ul>
<li><code>wait</code>  -  <code>wait</code>  会自动释放当前线程占有的对象锁，并请求操作系统挂起当前线程，<strong>让线程从  <code>Running</code>  状态转入  <code>Waiting</code>  状态</strong>，等待  <code>notify</code>  /  <code>notifyAll</code>  来唤醒。如果没有释放锁，那么其它线程就无法进入对象的同步方法或者同步控制块中，那么就无法执行  <code>notify</code>  或者  <code>notifyAll</code>  来唤醒挂起的线程，造成死锁。</li>
<li><code>notify</code>  - 唤醒一个正在  <code>Waiting</code>  状态的线程，并让它拿到对象锁，具体唤醒哪一个线程由 JVM 控制 。</li>
<li><code>notifyAll</code>  - 唤醒所有正在  <code>Waiting</code>  状态的线程，接下来它们需要竞争对象锁。</li>
</ul>
<blockquote>
<p>注意：</p>
<ul>
<li><strong> <code>wait</code> 、 <code>notify</code> 、 <code>notifyAll</code>  都是  <code>Object</code>  类中的方法</strong>，而非  <code>Thread</code> 。</li>
<li><strong> <code>wait</code> 、 <code>notify</code> 、 <code>notifyAll</code>  只能用在  <code>synchronized</code>  方法或者  <code>synchronized</code>  代码块中使用，否则会在运行时抛出  <code>IllegalMonitorStateException</code> </strong>。</li>
</ul>
<p>为什么  <code>wait</code> 、 <code>notify</code> 、 <code>notifyAll</code>  不定义在  <code>Thread</code>  中？为什么  <code>wait</code> 、 <code>notify</code> 、 <code>notifyAll</code>  要配合  <code>synchronized</code>  使用？</p>
<p>首先，需要了解几个基本知识点：</p>
<ul>
<li>每一个 Java 对象都有一个与之对应的 <strong>监视器（monitor）</strong></li>
<li>每一个监视器里面都有一个 <strong>对象锁</strong> 、一个 <strong>等待队列</strong>、一个 <strong>同步队列</strong></li>
</ul>
<p>了解了以上概念，我们回过头来理解前面两个问题。</p>
<p>为什么这几个方法不定义在  <code>Thread</code>  中？</p>
<p>由于每个对象都拥有对象锁，让当前线程等待某个对象锁，自然应该基于这个对象（ <code>Object</code> ）来操作，而非使用当前线程（ <code>Thread</code> ）来操作。因为当前线程可能会等待多个线程的锁，如果基于线程（ <code>Thread</code> ）来操作，就非常复杂了。</p>
<p>为什么  <code>wait</code> 、 <code>notify</code> 、 <code>notifyAll</code>  要配合  <code>synchronized</code>  使用？</p>
<p>如果调用某个对象的  <code>wait</code>  方法，当前线程必须拥有这个对象的对象锁，因此调用  <code>wait</code>  方法必须在  <code>synchronized</code>  方法和  <code>synchronized</code>  代码块中。</p>
</blockquote>
<p>生产者、消费者模式是  <code>wait</code> 、 <code>notify</code> 、 <code>notifyAll</code>  的一个经典使用案例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadWaitNotifyDemo02</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> QUEUE_SIZE <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">PriorityQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PriorityQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>QUEUE_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">new</span> <span class="token class-name">Producer</span><span class="token punctuation">(</span><span class="token string">"生产者A"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Producer</span><span class="token punctuation">(</span><span class="token string">"生产者B"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Consumer</span><span class="token punctuation">(</span><span class="token string">"消费者A"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Consumer</span><span class="token punctuation">(</span><span class="token string">"消费者B"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Consumer</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">&#123;</span>

        <span class="token class-name">Consumer</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">super</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>queue<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">while</span> <span class="token punctuation">(</span>queue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"队列空，等待数据"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            queue<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            queue<span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span>
                    queue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 每次移走队首元素</span>
                    queue<span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" 从队列取走一个元素，队列当前有："</span> <span class="token operator">+</span> queue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"个元素"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Producer</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">&#123;</span>

        <span class="token class-name">Producer</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">super</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>queue<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">while</span> <span class="token punctuation">(</span>queue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> QUEUE_SIZE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"队列满，等待有空余空间"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            queue<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            queue<span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span>
                    queue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 每次插入一个元素</span>
                    queue<span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" 向队列取中插入一个元素，队列当前有："</span> <span class="token operator">+</span> queue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"个元素"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-587"><a class="markdownIt-Anchor" href="#-587">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80.html#_4-2-join">#</a>4.2. join</h3>
<p>在线程操作中，可以使用  <code>join</code>  方法让一个线程强制运行，线程强制运行期间，其他线程无法运行，必须等待此线程完成之后才可以继续执行。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadJoinDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">MyThread</span> mt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 实例化Runnable子类对象</span>
        <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>mt<span class="token punctuation">,</span> <span class="token string">"mythread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 实例化Thread对象</span>
        t<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 启动线程</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">50</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">></span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                    t<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 线程强制运行</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Main 线程运行 --> "</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyThread</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">50</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" 运行，i = "</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 取得当前线程的名字</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-588"><a class="markdownIt-Anchor" href="#-588">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80.html#_4-3-%E7%AE%A1%E9%81%93">#</a>4.3. 管道</h3>
<p>管道输入 / 输出流和普通的文件输入 / 输出流或者网络输入 / 输出流不同之处在于，它主要用于线程之间的数据传输，而传输的媒介为内存。 管道输入 / 输出流主要包括了如下 4 种具体实现： <code>PipedOutputStream</code> 、 <code>PipedInputStream</code> 、 <code>PipedReader</code>  和  <code>PipedWriter</code> ，前两种面向字节，而后两种面向字符。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Piped</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">PipedWriter</span> out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PipedWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PipedReader</span> in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PipedReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 将输出流和输入流进行连接，否则在使用时会抛出IOException</span>
        out<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> printThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Print</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"PrintThread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        printThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> receive <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>receive <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                out<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>receive<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
            out<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Print</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span>

        <span class="token keyword">private</span> <span class="token class-name">PipedReader</span> in<span class="token punctuation">;</span>

        <span class="token class-name">Print</span><span class="token punctuation">(</span><span class="token class-name">PipedReader</span> in<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>in <span class="token operator">=</span> in<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">int</span> receive <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>receive <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> receive<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="-589"><a class="markdownIt-Anchor" href="#-589">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80.html#_5-%E7%BA%BF%E7%A8%8B%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F">#</a>5. 线程生命周期</h2>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/20210102103928.png" alt="img"></p>
<p><code>java.lang.Thread.State</code>  中定义了 <strong>6</strong> 种不同的线程状态，在给定的一个时刻，线程只能处于其中的一个状态。</p>
<p>以下是各状态的说明，以及状态间的联系：</p>
<ul>
<li>
<p><strong>新建（New）</strong> - 尚未调用  <code>start</code>  方法的线程处于此状态。此状态意味着：<strong>创建的线程尚未启动</strong>。</p>
</li>
<li>
<p><strong>就绪（Runnable）</strong> - 已经调用了  <code>start</code>  方法的线程处于此状态。此状态意味着：<strong>线程已经在 JVM 中运行</strong>。但是在操作系统层面，它可能处于运行状态，也可能等待资源调度（例如处理器资源），资源调度完成就进入运行状态。所以该状态的可运行是指可以被运行，具体有没有运行要看底层操作系统的资源调度。</p>
</li>
<li>
<p><strong>阻塞（Blocked）</strong> - 此状态意味着：<strong>线程处于被阻塞状态</strong>。表示线程在等待  <code>synchronized</code>  的隐式锁（Monitor lock）。 <code>synchronized</code>  修饰的方法、代码块同一时刻只允许一个线程执行，其他线程只能等待，即处于阻塞状态。当占用  <code>synchronized</code>  隐式锁的线程释放锁，并且等待的线程获得  <code>synchronized</code>  隐式锁时，就又会从  <code>BLOCKED</code>  转换到  <code>RUNNABLE</code>  状态。</p>
</li>
<li>
<p><strong>等待（Waiting）</strong> - 此状态意味着：<strong>线程无限期等待，直到被其他线程显式地唤醒</strong>。 阻塞和等待的区别在于，阻塞是被动的，它是在等待获取  <code>synchronized</code>  的隐式锁。而等待是主动的，通过调用  <code>Object.wait</code>  等方法进入。</p>
<table>
<thead>
<tr>
<th>进入方法</th>
<th>退出方法</th>
</tr>
</thead>
<tbody>
<tr>
<td>没有设置 Timeout 参数的  <code>Object.wait</code>  方法</td>
<td><code>Object.notify</code>  /  <code>Object.notifyAll</code></td>
</tr>
<tr>
<td>没有设置 Timeout 参数的  <code>Thread.join</code>  方法</td>
<td>被调用的线程执行完毕</td>
</tr>
</tbody>
</table>
<p>|  <code>LockSupport.park</code>  方法（Java 并发包中的锁，都是基于它实现的） |  <code>LockSupport.unpark</code>                  |</p>
</li>
<li>
<p><strong>定时等待（Timed waiting）</strong> - 此状态意味着：<strong>无需等待其它线程显式地唤醒，在一定时间之后会被系统自动唤醒</strong>。</p>
<table>
<thead>
<tr>
<th>进入方法</th>
<th>退出方法</th>
</tr>
</thead>
</table>
<p>|  <code>Thread.sleep</code>  方法                                          | 时间结束                                        |<br>
| 获得  <code>synchronized</code>  隐式锁的线程，调用设置了 Timeout 参数的  <code>Object.wait</code>  方法 | 时间结束 /  <code>Object.notify</code>  /  <code>Object.notifyAll</code>  |<br>
| 设置了 Timeout 参数的  <code>Thread.join</code>  方法                     | 时间结束 / 被调用的线程执行完毕                 |<br>
|  <code>LockSupport.parkNanos</code>  方法                                 |  <code>LockSupport.unpark</code>                             |<br>
|  <code>LockSupport.parkUntil</code>  方法                                 |  <code>LockSupport.unpark</code>                             |</p>
</li>
<li>
<p><strong>终止 (Terminated)</strong> - 线程执行完  <code>run</code>  方法，或者因异常退出了  <code>run</code>  方法。此状态意味着：线程结束了生命周期。</p>
</li>
</ul>
<h2 id="-590"><a class="markdownIt-Anchor" href="#-590">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80.html#_6-%E7%BA%BF%E7%A8%8B%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98">#</a>6. 线程常见问题</h2>
<h3 id="-591"><a class="markdownIt-Anchor" href="#-591">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80.html#_6-1-sleep%E3%80%81yield%E3%80%81join-%E6%96%B9%E6%B3%95%E6%9C%89%E4%BB%80%E4%B9%88%E5%8C%BA%E5%88%AB">#</a>6.1. sleep、yield、join 方法有什么区别</h3>
<ul>
<li>
<pre><code>
  yield
  <pre class="line-numbers language-none"><code class="language-none">

​	 

	方法
	
	- &#96;yield&#96; 方法会 **让线程从 &#96;Running&#96; 状态转入 &#96;Runnable&#96; 状态**。
	- 当调用了 &#96;yield&#96; 方法后，只有**与当前线程相同或更高优先级的&#96;Runnable&#96; 状态线程才会获得执行的机会**。

- &#96;&#96;&#96;

	sleep<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


</code></pre>
</li>
</ul>
<p>​</p>
<pre><code>方法

- `sleep` 方法会 **让线程从 `Running` 状态转入 `Waiting` 状态**。
- `sleep` 方法需要指定等待的时间，**超过等待时间后，JVM 会将线程从 `Waiting` 状态转入 `Runnable` 状态**。
- 当调用了 `sleep` 方法后，**无论什么优先级的线程都可以得到执行机会**。
- `sleep` 方法不会释放“锁标志”，也就是说如果有 `synchronized` 同步块，其他线程仍然不能访问共享数据。
</code></pre>
<ul>
<li>
<pre><code>
  join
  <pre class="line-numbers language-none"><code class="language-none">	
	- &#96;join&#96; 方法会 **让线程从 &#96;Running&#96; 状态转入 &#96;Waiting&#96; 状态**。
	- 当调用了 &#96;join&#96; 方法后，**当前线程必须等待调用 &#96;join&#96; 方法的线程结束后才能继续执行**。

### [#](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java线程基础.html#_6-2-为什么-sleep-和-yield-方法是静态的)6.2. 为什么 sleep 和 yield 方法是静态的

&#96;Thread&#96; 类的 &#96;sleep&#96; 和 &#96;yield&#96; 方法将处理 &#96;Running&#96; 状态的线程。

所以在其他处于非 &#96;Running&#96; 状态的线程上执行这两个方法是没有意义的。这就是为什么这些方法是静态的。它们可以在当前正在执行的线程中工作，并避免程序员错误的认为可以在其他非运行线程调用这些方法。

### [#](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java线程基础.html#_6-3-java-线程是否按照线程优先级严格执行)6.3. Java 线程是否按照线程优先级严格执行

即使设置了线程的优先级，也**无法保证高优先级的线程一定先执行**。

原因在于线程优先级依赖于操作系统的支持，然而，不同的操作系统支持的线程优先级并不相同，不能很好的和 Java 中线程优先级一一对应。

### [#](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java线程基础.html#_6-4-一个线程两次调用-start-方法会怎样)6.4. 一个线程两次调用 start()方法会怎样

Java 的线程是不允许启动两次的，第二次调用必然会抛出 IllegalThreadStateException，这是一种运行时异常，多次调用 start 被认为是编程错误。

### [#](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java线程基础.html#_6-5-start-和-run-方法有什么区别)6.5. &#96;start&#96; 和 &#96;run&#96; 方法有什么区别

- &#96;run&#96; 方法是线程的执行体。
- &#96;start&#96; 方法会启动线程，然后 JVM 会让这个线程去执行 &#96;run&#96; 方法。

### [#](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java线程基础.html#_6-6-可以直接调用-thread-类的-run-方法么)6.6. 可以直接调用 &#96;Thread&#96; 类的 &#96;run&#96; 方法么

- 可以。但是如果直接调用 &#96;Thread&#96; 的 &#96;run&#96; 方法，它的行为就会和普通的方法一样。
- 为了在新的线程中执行我们的代码，必须使用 &#96;Thread&#96; 的 &#96;start&#96; 方法。



---

# Java 并发核心机制

&gt; **📦 本文以及示例源码已归档在 [javacore(opens new window)](https:&#x2F;&#x2F;github.com&#x2F;dunwu&#x2F;javacore&#x2F;)**
&gt;
&gt; Java 对于并发的支持主要汇聚在 &#96;java.util.concurrent&#96;，即 J.U.C。而 J.U.C 的核心是 &#96;AQS&#96;。

- [1. J.U.C 简介](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java并发核心机制.html#1-juc-简介)
- \2. synchronized
	- [2.1. synchronized 的应用](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java并发核心机制.html#21-synchronized-的应用)
	- [2.2. synchronized 的原理](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java并发核心机制.html#22-synchronized-的原理)
	- [2.3. synchronized 的优化](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java并发核心机制.html#23-synchronized-的优化)
	- [2.4. synchronized 的误区](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java并发核心机制.html#24-synchronized-的误区)
- \3. volatile
	- [3.1. volatile 的要点](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java并发核心机制.html#31-volatile-的要点)
	- [3.2. volatile 的应用](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java并发核心机制.html#32-volatile-的应用)
	- [3.3. volatile 的原理](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java并发核心机制.html#33-volatile-的原理)
	- [3.4. volatile 的问题](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java并发核心机制.html#34-volatile-的问题)
- \4. CAS
	- [4.1. CAS 的要点](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java并发核心机制.html#41-cas-的要点)
	- [4.2. CAS 的应用](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java并发核心机制.html#42-cas-的应用)
	- [4.3. CAS 的原理](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java并发核心机制.html#43-cas-的原理)
	- [4.4. CAS 的问题](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java并发核心机制.html#44-cas-的问题)
- \5. ThreadLocal
	- [5.1. ThreadLocal 的应用](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java并发核心机制.html#51-threadlocal-的应用)
	- [5.2. ThreadLocal 的原理](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java并发核心机制.html#52-threadlocal-的原理)
	- [5.3. ThreadLocal 的误区](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java并发核心机制.html#53-threadlocal-的误区)
	- [5.4. InheritableThreadLocal](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java并发核心机制.html#54-inheritablethreadlocal)
- [6. 参考资料](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java并发核心机制.html#6-参考资料)

## [#](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java并发核心机制.html#_1-j-u-c-简介)1. J.U.C 简介

Java 的 &#96;java.util.concurrent&#96; 包（简称 J.U.C）中提供了大量并发工具类，是 Java 并发能力的主要体现（注意，不是全部，有部分并发能力的支持在其他包中）。从功能上，大致可以分为：

- 原子类 - 如：&#96;AtomicInteger&#96;、&#96;AtomicIntegerArray&#96;、&#96;AtomicReference&#96;、&#96;AtomicStampedReference&#96; 等。
- 锁 - 如：&#96;ReentrantLock&#96;、&#96;ReentrantReadWriteLock&#96; 等。
- 并发容器 - 如：&#96;ConcurrentHashMap&#96;、&#96;CopyOnWriteArrayList&#96;、&#96;CopyOnWriteArraySet&#96; 等。
- 阻塞队列 - 如：&#96;ArrayBlockingQueue&#96;、&#96;LinkedBlockingQueue&#96; 等。
- 非阻塞队列 - 如： &#96;ConcurrentLinkedQueue&#96; 、&#96;LinkedTransferQueue&#96; 等。
- &#96;Executor&#96; 框架（线程池）- 如：&#96;ThreadPoolExecutor&#96;、&#96;Executors&#96; 等。

我个人理解，Java 并发框架可以分为以下层次。

![img](https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;dunwu&#x2F;images&#x2F;dev&#x2F;cs&#x2F;java&#x2F;javacore&#x2F;concurrent&#x2F;java-concurrent-basic-mechanism.png)

由 Java 并发框架图不难看出，J.U.C 包中的工具类是基于 &#96;synchronized&#96;、&#96;volatile&#96;、&#96;CAS&#96;、&#96;ThreadLocal&#96; 这样的并发核心机制打造的。所以，要想深入理解 J.U.C 工具类的特性、为什么具有这样那样的特性，就必须先理解这些核心机制。

## [#](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java并发核心机制.html#_2-synchronized)2. synchronized

&gt; &#96;synchronized&#96; 是 Java 中的关键字，是 **利用锁的机制来实现互斥同步的**。
&gt;
&gt; **&#96;synchronized&#96; 可以保证在同一个时刻，只有一个线程可以执行某个方法或者某个代码块**。
&gt;
&gt; 如果不需要 &#96;Lock&#96; 、&#96;ReadWriteLock&#96; 所提供的高级同步特性，应该优先考虑使用 &#96;synchronized&#96; ，理由如下：
&gt;
&gt; - Java 1.6 以后，&#96;synchronized&#96; 做了大量的优化，其性能已经与 &#96;Lock&#96; 、&#96;ReadWriteLock&#96; 基本上持平。从趋势来看，Java 未来仍将继续优化 &#96;synchronized&#96; ，而不是 &#96;ReentrantLock&#96; 。
&gt; - &#96;ReentrantLock&#96; 是 Oracle JDK 的 API，在其他版本的 JDK 中不一定支持；而 &#96;synchronized&#96; 是 JVM 的内置特性，所有 JDK 版本都提供支持。

### [#](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java并发核心机制.html#_2-1-synchronized-的应用)2.1. synchronized 的应用

&#96;synchronized&#96; 有 3 种应用方式：

- **同步实例方法** - 对于普通同步方法，锁是当前实例对象
- **同步静态方法** - 对于静态同步方法，锁是当前类的 &#96;Class&#96; 对象
- **同步代码块** - 对于同步方法块，锁是 &#96;synchonized&#96; 括号里配置的对象

&gt; 说明：
&gt;
&gt; 类似 &#96;Vector&#96;、&#96;Hashtable&#96; 这类同步类，就是使用 &#96;synchonized&#96; 修饰其重要方法，来保证其线程安全。
&gt;
&gt; 事实上，这类同步容器也非绝对的线程安全，当执行迭代器遍历，根据条件删除元素这种场景下，就可能出现线程不安全的情况。此外，Java 1.6 针对 &#96;synchonized&#96; 进行优化前，由于阻塞，其性能不高。
&gt;
&gt; 综上，这类同步容器，在现代 Java 程序中，已经渐渐不用了。

#### [#](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java并发核心机制.html#同步实例方法)同步实例方法

❌ 错误示例 - 未同步的示例

&#96;&#96;&#96;java
public class NoSynchronizedDemo implements Runnable &#123;

    public static final int MAX &#x3D; 100000;

    private static int count &#x3D; 0;

    public static void main(String[] args) throws InterruptedException &#123;
        NoSynchronizedDemo instance &#x3D; new NoSynchronizedDemo();
        Thread t1 &#x3D; new Thread(instance);
        Thread t2 &#x3D; new Thread(instance);
        t1.start();
        t2.start();
        t1.join();
        t2.join();
        System.out.println(count);
    &#125;

    @Override
    public void run() &#123;
        for (int i &#x3D; 0; i &lt; MAX; i++) &#123;
            increase();
        &#125;
    &#125;

    public void increase() &#123;
        count++;
    &#125;

&#125;
&#x2F;&#x2F; 输出结果: 小于 200000 的随机数字<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

</code></pre>
</li>
</ul>
<p>Java 实例方法同步是同步在拥有该方法的对象上。这样，每个实例其方法同步都同步在不同的对象上，即该方法所属的实例。只有一个线程能够在实例方法同步块中运行。如果有多个实例存在，那么一个线程一次可以在一个实例同步块中执行操作。一个实例一个线程。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SynchronizedDemo</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MAX <span class="token operator">=</span> <span class="token number">100000</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">SynchronizedDemo</span> instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SynchronizedDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
        t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAX<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">increase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * synchronized 修饰普通方法
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">increase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        count<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>【示例】错误示例</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Account</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">private</span> <span class="token keyword">int</span> balance<span class="token punctuation">;</span>
  <span class="token comment">// 转账</span>
  <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">transfer</span><span class="token punctuation">(</span>
      <span class="token class-name">Account</span> target<span class="token punctuation">,</span> <span class="token keyword">int</span> amt<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>balance <span class="token operator">></span> amt<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>balance <span class="token operator">-=</span> amt<span class="token punctuation">;</span>
      target<span class="token punctuation">.</span>balance <span class="token operator">+=</span> amt<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这段代码中，临界区内有两个资源，分别是转出账户的余额 this.balance 和转入账户的余额 target.balance，并且用的是一把锁 this，符合我们前面提到的，多个资源可以用一把锁来保护，这看上去完全正确呀。真的是这样吗？可惜，这个方案仅仅是看似正确，为什么呢？</p>
<p>问题就出在 this 这把锁上，this 这把锁可以保护自己的余额 this.balance，却保护不了别人的余额 target.balance，就像你不能用自家的锁来保护别人家的资产，也不能用自己的票来保护别人的座位一样。</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/20200701135257.png" alt="img"></p>
<p>应该保证使用的<strong>锁能覆盖所有受保护资源</strong>。</p>
<p>【示例】正确姿势</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Account</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">private</span> <span class="token class-name">Object</span> lock；
  <span class="token keyword">private</span> <span class="token keyword">int</span> balance<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token class-name">Account</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 创建 Account 时传入同一个 lock 对象</span>
  <span class="token keyword">public</span> <span class="token class-name">Account</span><span class="token punctuation">(</span><span class="token class-name">Object</span> lock<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>lock <span class="token operator">=</span> lock<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">// 转账</span>
  <span class="token keyword">void</span> <span class="token function">transfer</span><span class="token punctuation">(</span><span class="token class-name">Account</span> target<span class="token punctuation">,</span> <span class="token keyword">int</span> amt<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token comment">// 此处检查所有对象共享的锁</span>
    <span class="token keyword">synchronized</span><span class="token punctuation">(</span>lock<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>balance <span class="token operator">></span> amt<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>balance <span class="token operator">-=</span> amt<span class="token punctuation">;</span>
        target<span class="token punctuation">.</span>balance <span class="token operator">+=</span> amt<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个办法确实能解决问题，但是有点小瑕疵，它要求在创建 Account 对象的时候必须传入同一个对象，如果创建 Account 对象时，传入的 lock 不是同一个对象，那可就惨了，会出现锁自家门来保护他家资产的荒唐事。在真实的项目场景中，创建 Account 对象的代码很可能分散在多个工程中，传入共享的 lock 真的很难。</p>
<p>上面的方案缺乏实践的可行性，我们需要更好的方案。还真有，就是<strong>用 Account.class 作为共享的锁</strong>。Account.class 是所有 Account 对象共享的，而且这个对象是 Java 虚拟机在加载 Account 类的时候创建的，所以我们不用担心它的唯一性。使用 Account.class 作为共享的锁，我们就无需在创建 Account 对象时传入了，代码更简单。</p>
<p>【示例】正确姿势</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Account</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">private</span> <span class="token keyword">int</span> balance<span class="token punctuation">;</span>
  <span class="token comment">// 转账</span>
  <span class="token keyword">void</span> <span class="token function">transfer</span><span class="token punctuation">(</span><span class="token class-name">Account</span> target<span class="token punctuation">,</span> <span class="token keyword">int</span> amt<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">synchronized</span><span class="token punctuation">(</span><span class="token class-name">Account</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>balance <span class="token operator">></span> amt<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>balance <span class="token operator">-=</span> amt<span class="token punctuation">;</span>
        target<span class="token punctuation">.</span>balance <span class="token operator">+=</span> amt<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-592"><a class="markdownIt-Anchor" href="#-592">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6.html#%E5%90%8C%E6%AD%A5%E9%9D%99%E6%80%81%E6%96%B9%E6%B3%95">#</a>同步静态方法</h4>
<p>静态方法的同步是指同步在该方法所在的类对象上。因为在 JVM 中一个类只能对应一个类对象，所以同时只允许一个线程执行同一个类中的静态同步方法。</p>
<p>对于不同类中的静态同步方法，一个线程可以执行每个类中的静态同步方法而无需等待。不管类中的哪个静态同步方法被调用，一个类只能由一个线程同时执行。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SynchronizedDemo2</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MAX <span class="token operator">=</span> <span class="token number">100000</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">SynchronizedDemo2</span> instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SynchronizedDemo2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
        t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAX<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">increase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * synchronized 修饰静态方法
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">increase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        count<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-593"><a class="markdownIt-Anchor" href="#-593">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6.html#%E5%90%8C%E6%AD%A5%E4%BB%A3%E7%A0%81%E5%9D%97">#</a>同步代码块</h4>
<p>有时你不需要同步整个方法，而是同步方法中的一部分。Java 可以对方法的一部分进行同步。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@ThreadSafe</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SynchronizedDemo05</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MAX <span class="token operator">=</span> <span class="token number">100000</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">SynchronizedDemo05</span> instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SynchronizedDemo05</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
        t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAX<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">increase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * synchronized 修饰代码块
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">increase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            count<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意 Java 同步块构造器用括号将对象括起来。在上例中，使用了  <code>this</code> ，即为调用  <code>increase</code>  方法的实例本身。用括号括起来的对象叫做监视器对象。一次只有一个线程能够在同步于同一个监视器对象的 Java 方法内执行。</p>
<p>如果是静态方法，就不能用 this 对象作为监视器对象了，而是使用  <code>Class</code>  对象，如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SynchronizedDemo3</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MAX <span class="token operator">=</span> <span class="token number">100000</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">SynchronizedDemo3</span> instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SynchronizedDemo3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
        t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAX<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">increase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * synchronized 修饰代码块
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">increase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">SynchronizedDemo3</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            count<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-594"><a class="markdownIt-Anchor" href="#-594">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6.html#_2-2-synchronized-%E7%9A%84%E5%8E%9F%E7%90%86">#</a>2.2. synchronized 的原理</h3>
<p><strong> <code>synchronized</code>  代码块是由一对  <code>monitorenter</code>  和  <code>monitorexit</code>  指令实现的， <code>Monitor</code>  对象是同步的基本实现单元</strong>。在 Java 6 之前， <code>Monitor</code>  的实现完全是依靠操作系统内部的互斥锁，因为需要进行用户态到内核态的切换，所以同步操作是一个无差别的重量级操作。</p>
<p>如果  <code>synchronized</code>  明确制定了对象参数，那就是这个对象的引用；如果没有明确指定，那就根据  <code>synchronized</code>  修饰的是实例方法还是静态方法，去对对应的对象实例或  <code>Class</code>  对象来作为锁对象。</p>
<p><code>synchronized</code>  同步块对同一线程来说是可重入的，不会出现锁死问题。</p>
<p><code>synchronized</code>  同步块是互斥的，即已进入的线程执行完成前，会阻塞其他试图进入的线程。</p>
<p>【示例】</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token class-name">Object</span> lock<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>lock<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      lock<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">// 上面的 Java 代码将编译为下面的字节码</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Object</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Code</span><span class="token operator">:</span>
       <span class="token number">0</span><span class="token operator">:</span> aload_1
       <span class="token number">1</span><span class="token operator">:</span> dup
       <span class="token number">2</span><span class="token operator">:</span> astore_2
       <span class="token number">3</span><span class="token operator">:</span> monitorenter
       <span class="token number">4</span><span class="token operator">:</span> aload_1
       <span class="token number">5</span><span class="token operator">:</span> invokevirtual java<span class="token operator">/</span>lang<span class="token operator">/</span><span class="token class-name">Object</span><span class="token punctuation">.</span>hashCode<span class="token operator">:</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token class-name">I</span>
       <span class="token number">8</span><span class="token operator">:</span> pop
       <span class="token number">9</span><span class="token operator">:</span> aload_2
      <span class="token number">10</span><span class="token operator">:</span> monitorexit
      <span class="token number">11</span><span class="token operator">:</span> <span class="token keyword">goto</span>          <span class="token number">19</span>
      <span class="token number">14</span><span class="token operator">:</span> astore_3
      <span class="token number">15</span><span class="token operator">:</span> aload_2
      <span class="token number">16</span><span class="token operator">:</span> monitorexit
      <span class="token number">17</span><span class="token operator">:</span> aload_3
      <span class="token number">18</span><span class="token operator">:</span> athrow
      <span class="token number">19</span><span class="token operator">:</span> <span class="token keyword">return</span>
    <span class="token class-name">Exception</span> table<span class="token operator">:</span>
       from    <span class="token keyword">to</span>  <span class="token namespace">target</span> type
           <span class="token number">4</span>    <span class="token number">11</span>    <span class="token number">14</span>   any
          <span class="token number">14</span>    <span class="token number">17</span>    <span class="token number">14</span>   any<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-595"><a class="markdownIt-Anchor" href="#-595">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6.html#%E5%90%8C%E6%AD%A5%E4%BB%A3%E7%A0%81%E5%9D%97-2">#</a>同步代码块</h4>
<p><code>synchronized</code>  在修饰同步代码块时，是由  <code>monitorenter</code>  和  <code>monitorexit</code>  指令来实现同步的。进入  <code>monitorenter</code>  指令后，线程将持有  <code>Monitor</code>  对象，退出  <code>monitorenter</code>  指令后，线程将释放该  <code>Monitor</code>  对象。</p>
<h4 id="-596"><a class="markdownIt-Anchor" href="#-596">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6.html#%E5%90%8C%E6%AD%A5%E6%96%B9%E6%B3%95">#</a>同步方法</h4>
<p><code>synchronized</code>  修饰同步方法时，会设置一个  <code>ACC_SYNCHRONIZED</code>  标志。当方法调用时，调用指令将会检查该方法是否被设置  <code>ACC_SYNCHRONIZED</code>  访问标志。如果设置了该标志，执行线程将先持有  <code>Monitor</code>  对象，然后再执行方法。在该方法运行期间，其它线程将无法获取到该  <code>Mointor</code>  对象，当方法执行完成后，再释放该  <code>Monitor</code>  对象。</p>
<h4 id="-597"><a class="markdownIt-Anchor" href="#-597">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6.html#monitor">#</a>Monitor</h4>
<p>每个对象实例都会有一个  <code>Monitor</code> ， <code>Monitor</code>  可以和对象一起创建、销毁。 <code>Monitor</code>  是由  <code>ObjectMonitor</code>  实现，而  <code>ObjectMonitor</code>  是由 C++ 的  <code>ObjectMonitor.hpp</code>  文件实现。</p>
<p>当多个线程同时访问一段同步代码时，多个线程会先被存放在 EntryList 集合中，处于 block 状态的线程，都会被加入到该列表。接下来当线程获取到对象的 Monitor 时，Monitor 是依靠底层操作系统的 Mutex Lock 来实现互斥的，线程申请 Mutex 成功，则持有该 Mutex，其它线程将无法获取到该 Mutex。</p>
<p>如果线程调用 wait () 方法，就会释放当前持有的 Mutex，并且该线程会进入 WaitSet 集合中，等待下一次被唤醒。如果当前线程顺利执行完方法，也将释放 Mutex。</p>
<h3 id="-598"><a class="markdownIt-Anchor" href="#-598">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6.html#_2-3-synchronized-%E7%9A%84%E4%BC%98%E5%8C%96">#</a>2.3. synchronized 的优化</h3>
<blockquote>
<p><strong>Java 1.6 以后， <code>synchronized</code>  做了大量的优化，其性能已经与  <code>Lock</code>  、 <code>ReadWriteLock</code>  基本上持平</strong>。</p>
</blockquote>
<h4 id="-599"><a class="markdownIt-Anchor" href="#-599">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6.html#java-%E5%AF%B9%E8%B1%A1%E5%A4%B4">#</a>Java 对象头</h4>
<p>在 JDK1.6 JVM 中，对象实例在堆内存中被分为了三个部分：对象头、实例数据和对齐填充。其中 Java 对象头由 Mark Word、指向类的指针以及数组长度三部分组成。</p>
<p>Mark Word 记录了对象和锁有关的信息。Mark Word 在 64 位 JVM 中的长度是 64bit，我们可以一起看下 64 位 JVM 的存储结构是怎么样的。如下图所示：</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/20200629191250.png" alt="img"></p>
<p>锁升级功能主要依赖于 Mark Word 中的锁标志位和是否偏向锁标志位， <code>synchronized</code>  同步锁就是从偏向锁开始的，随着竞争越来越激烈，偏向锁升级到轻量级锁，最终升级到重量级锁。</p>
<p>Java 1.6 引入了偏向锁和轻量级锁，从而让  <code>synchronized</code>  拥有了四个状态：</p>
<ul>
<li><strong>无锁状态（unlocked）</strong></li>
<li><strong>偏向锁状态（biasble）</strong></li>
<li><strong>轻量级锁状态（lightweight locked）</strong></li>
<li><strong>重量级锁状态（inflated）</strong></li>
</ul>
<p>当 JVM 检测到不同的竞争状况时，会自动切换到适合的锁实现。</p>
<p>当没有竞争出现时，默认会使用偏向锁。JVM 会利用 CAS 操作（compare and swap），在对象头上的 Mark Word 部分设置线程 ID，以表示这个对象偏向于当前线程，所以并不涉及真正的互斥锁。这样做的假设是基于在很多应用场景中，大部分对象生命周期中最多会被一个线程锁定，使用偏斜锁可以降低无竞争开销。</p>
<p>如果有另外的线程试图锁定某个已经被偏斜过的对象，JVM 就需要撤销（revoke）偏向锁，并切换到轻量级锁实现。轻量级锁依赖 CAS 操作 Mark Word 来试图获取锁，如果重试成功，就使用普通的轻量级锁；否则，进一步升级为重量级锁。</p>
<h4 id="-600"><a class="markdownIt-Anchor" href="#-600">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6.html#%E5%81%8F%E5%90%91%E9%94%81">#</a>偏向锁</h4>
<p>偏向锁的思想是偏向于<strong>第一个获取锁对象的线程，这个线程在之后获取该锁就不再需要进行同步操作，甚至连 CAS 操作也不再需要</strong>。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200604105151.png" alt="img"></p>
<h4 id="-601"><a class="markdownIt-Anchor" href="#-601">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6.html#%E8%BD%BB%E9%87%8F%E7%BA%A7%E9%94%81">#</a>轻量级锁</h4>
<p><strong>轻量级锁</strong>是相对于传统的重量级锁而言，它 <strong>使用 CAS 操作来避免重量级锁使用互斥量的开销</strong>。对于绝大部分的锁，在整个同步周期内都是不存在竞争的，因此也就不需要都使用互斥量进行同步，可以先采用 CAS 操作进行同步，如果 CAS 失败了再改用互斥量进行同步。</p>
<p>当尝试获取一个锁对象时，如果锁对象标记为  <code>0|01</code> ，说明锁对象的锁未锁定（unlocked）状态。此时虚拟机在当前线程的虚拟机栈中创建 Lock Record，然后使用 CAS 操作将对象的 Mark Word 更新为 Lock Record 指针。如果 CAS 操作成功了，那么线程就获取了该对象上的锁，并且对象的 Mark Word 的锁标记变为 00，表示该对象处于轻量级锁状态。</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/20200604105248.png" alt="img"></p>
<h4 id="-602"><a class="markdownIt-Anchor" href="#-602">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6.html#%E9%94%81%E6%B6%88%E9%99%A4-%E9%94%81%E7%B2%97%E5%8C%96">#</a>锁消除 / 锁粗化</h4>
<p>除了锁升级优化，Java 还使用了编译器对锁进行优化。</p>
<p><strong>（1）锁消除</strong></p>
<p><strong>锁消除是指对于被检测出不可能存在竞争的共享数据的锁进行消除</strong>。</p>
<p>JIT 编译器在动态编译同步块的时候，借助了一种被称为逃逸分析的技术，来判断同步块使用的锁对象是否只能够被一个线程访问，而没有被发布到其它线程。</p>
<p>确认是的话，那么 JIT 编译器在编译这个同步块的时候不会生成 synchronized 所表示的锁的申请与释放的机器码，即消除了锁的使用。在 Java7 之后的版本就不需要手动配置了，该操作可以自动实现。</p>
<p>对于一些看起来没有加锁的代码，其实隐式的加了很多锁。例如下面的字符串拼接代码就隐式加了锁：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">concatString</span><span class="token punctuation">(</span><span class="token class-name">String</span> s1<span class="token punctuation">,</span> <span class="token class-name">String</span> s2<span class="token punctuation">,</span> <span class="token class-name">String</span> s3<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> s1 <span class="token operator">+</span> s2 <span class="token operator">+</span> s3<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><code>String</code>  是一个不可变的类，编译器会对 String 的拼接自动优化。在 Java 1.5 之前，会转化为  <code>StringBuffer</code>  对象的连续  <code>append()</code>  操作：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">concatString</span><span class="token punctuation">(</span><span class="token class-name">String</span> s1<span class="token punctuation">,</span> <span class="token class-name">String</span> s2<span class="token punctuation">,</span> <span class="token class-name">String</span> s3<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">StringBuffer</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>s3<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>每个  <code>append()</code>  方法中都有一个同步块。虚拟机观察变量 sb，很快就会发现它的动态作用域被限制在  <code>concatString()</code>  方法内部。也就是说，sb 的所有引用永远不会逃逸到  <code>concatString()</code>  方法之外，其他线程无法访问到它，因此可以进行消除。</p>
<p><strong>（2）锁粗化</strong></p>
<p>锁粗化同理，就是在 JIT 编译器动态编译时，如果发现几个相邻的同步块使用的是同一个锁实例，那么 JIT 编译器将会把这几个同步块合并为一个大的同步块，从而避免一个线程 “反复申请、释放同一个锁 “所带来的性能开销。</p>
<p>如果<strong>一系列的连续操作都对同一个对象反复加锁和解锁</strong>，频繁的加锁操作就会导致性能损耗。</p>
<p>上一节的示例代码中连续的  <code>append()</code>  方法就属于这类情况。如果<strong>虚拟机探测到由这样的一串零碎的操作都对同一个对象加锁，将会把加锁的范围扩展（粗化）到整个操作序列的外部</strong>。对于上一节的示例代码就是扩展到第一个  <code>append()</code>  操作之前直至最后一个  <code>append()</code>  操作之后，这样只需要加锁一次就可以了。</p>
<h4 id="-603"><a class="markdownIt-Anchor" href="#-603">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6.html#%E8%87%AA%E6%97%8B%E9%94%81">#</a>自旋锁</h4>
<p>互斥同步进入阻塞状态的开销都很大，应该尽量避免。在许多应用中，共享数据的锁定状态只会持续很短的一段时间。自旋锁的思想是让一个线程在请求一个共享数据的锁时执行忙循环（自旋）一段时间，如果在这段时间内能获得锁，就可以避免进入阻塞状态。</p>
<p>自旋锁虽然能避免进入阻塞状态从而减少开销，但是它需要进行忙循环操作占用 CPU 时间，它只适用于共享数据的锁定状态很短的场景。</p>
<p>在 Java 1.6 中引入了自适应的自旋锁。自适应意味着自旋的次数不再固定了，而是由前一次在同一个锁上的自旋次数及锁的拥有者的状态来决定。</p>
<h3 id="-604"><a class="markdownIt-Anchor" href="#-604">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6.html#_2-4-synchronized-%E7%9A%84%E8%AF%AF%E5%8C%BA">#</a>2.4. synchronized 的误区</h3>
<blockquote>
<p>示例摘自：<a target="_blank" rel="noopener" href="https://time.geekbang.org/column/intro/100047701">《Java 业务开发常见错误 100 例》(opens new window)</a></p>
</blockquote>
<h4 id="-605"><a class="markdownIt-Anchor" href="#-605">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6.html#synchronized-%E4%BD%BF%E7%94%A8%E8%8C%83%E5%9B%B4%E4%B8%8D%E5%BD%93%E5%AF%BC%E8%87%B4%E7%9A%84%E9%94%99%E8%AF%AF">#</a>synchronized 使用范围不当导致的错误</h4>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Interesting</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">volatile</span> <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">volatile</span> <span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Interesting</span> interesting <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Interesting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> interesting<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> interesting<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"add start"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            a<span class="token operator">++</span><span class="token punctuation">;</span>
            b<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"add done"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">compare</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"compare start"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//a始终等于b吗？</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">&lt;</span> b<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"a:&#123;&#125;,b:&#123;&#125;,&#123;&#125;"</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> a <span class="token operator">></span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//最后的a>b应该始终是false吗？</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"compare done"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>【输出】</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">16:05:25.541 [Thread-0] INFO io.github.dunwu.javacore.concurrent.sync.synchronized使用范围不当 - add start
16:05:25.544 [Thread-0] INFO io.github.dunwu.javacore.concurrent.sync.synchronized使用范围不当 - add done
16:05:25.544 [Thread-1] INFO io.github.dunwu.javacore.concurrent.sync.synchronized使用范围不当 - compare start
16:05:25.544 [Thread-1] INFO io.github.dunwu.javacore.concurrent.sync.synchronized使用范围不当 - compare done<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>之所以出现这种错乱，是因为两个线程是交错执行 add 和 compare 方法中的业务逻辑，而且这些业务逻辑不是原子性的：a++ 和 b++ 操作中可以穿插在 compare 方法的比较代码中；更需要注意的是，a&lt;b 这种比较操作在字节码层面是加载 a、加载 b 和比较三步，代码虽然是一行但也不是原子性的。</p>
<p>所以，正确的做法应该是，为 add 和 compare 都加上方法锁，确保 add 方法执行时，compare 无法读取 a 和 b：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">public synchronized void add()
public synchronized void compare()<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>所以，使用锁解决问题之前一定要理清楚，我们要保护的是什么逻辑，多线程执行的情况又是怎样的。</p>
<h4 id="-606"><a class="markdownIt-Anchor" href="#-606">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6.html#synchronized-%E4%BF%9D%E6%8A%A4%E5%AF%B9%E8%B1%A1%E4%B8%8D%E5%AF%B9%E5%AF%BC%E8%87%B4%E7%9A%84%E9%94%99%E8%AF%AF">#</a>synchronized 保护对象不对导致的错误</h4>
<p>加锁前要清楚锁和被保护的对象是不是一个层面的。</p>
<p>静态字段属于类，类级别的锁才能保护；而非静态字段属于类实例，实例级别的锁就可以保护。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token keyword">synchronized</span>错误使用示例<span class="token number">2</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">synchronized</span>错误使用示例<span class="token number">2</span> demo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">synchronized</span>错误使用示例<span class="token function">2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>demo<span class="token punctuation">.</span><span class="token function">wrong</span><span class="token punctuation">(</span><span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>demo<span class="token punctuation">.</span><span class="token function">right</span><span class="token punctuation">(</span><span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">wrong</span><span class="token punctuation">(</span><span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Data</span><span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>i <span class="token operator">-></span> <span class="token keyword">new</span> <span class="token class-name">Data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">wrong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Data</span><span class="token punctuation">.</span><span class="token function">getCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">right</span><span class="token punctuation">(</span><span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Data</span><span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>i <span class="token operator">-></span> <span class="token keyword">new</span> <span class="token class-name">Data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">right</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Data</span><span class="token punctuation">.</span><span class="token function">getCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Data</span> <span class="token punctuation">&#123;</span>

        <span class="token annotation punctuation">@Getter</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> locker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> counter<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">wrong</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            counter<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">right</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>locker<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                counter<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>wrong 方法中试图对一个静态对象加对象级别的 synchronized 锁，并不能保证线程安全。</p>
<h4 id="-607"><a class="markdownIt-Anchor" href="#-607">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6.html#%E9%94%81%E7%B2%92%E5%BA%A6%E5%AF%BC%E8%87%B4%E7%9A%84%E9%97%AE%E9%A2%98">#</a>锁粒度导致的问题</h4>
<p>要尽可能的缩小加锁的范围，这可以提高并发吞吐。</p>
<p>如果精细化考虑了锁应用范围后，性能还无法满足需求的话，我们就要考虑另一个维度的粒度问题了，即：区分读写场景以及资源的访问冲突，考虑使用悲观方式的锁还是乐观方式的锁。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token keyword">synchronized</span>锁粒度不当 <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Demo</span> demo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        demo<span class="token punctuation">.</span><span class="token function">wrong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        demo<span class="token punctuation">.</span><span class="token function">right</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Demo</span> <span class="token punctuation">&#123;</span>

        <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">slow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">wrong</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">long</span> begin <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>i <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token function">slow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    data<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"took:&#123;&#125;"</span><span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> begin<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> data<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">right</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">long</span> begin <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>i <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
                <span class="token function">slow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    data<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"took:&#123;&#125;"</span><span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> begin<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> data<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="-608"><a class="markdownIt-Anchor" href="#-608">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6.html#_3-volatile">#</a>3. volatile</h2>
<h3 id="-609"><a class="markdownIt-Anchor" href="#-609">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6.html#_3-1-volatile-%E7%9A%84%E8%A6%81%E7%82%B9">#</a>3.1. volatile 的要点</h3>
<p><code>volatile</code>  是轻量级的  <code>synchronized</code> ，它在多处理器开发中保证了共享变量的 “可见性”。</p>
<p>被  <code>volatile</code>  修饰的变量，具备以下特性：</p>
<ul>
<li><strong>线程可见性</strong> - 保证了不同线程对这个变量进行操作时的可见性，即一个线程修改了某个共享变量，另外一个线程能读到这个修改的值。</li>
<li><strong>禁止指令重排序</strong></li>
<li><strong>不保证原子性</strong></li>
</ul>
<p>我们知道，线程安全需要具备：可见性、原子性、顺序性。 <code>volatile</code>  不保证原子性，所以决定了它不能彻底地保证线程安全。</p>
<h3 id="-610"><a class="markdownIt-Anchor" href="#-610">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6.html#_3-2-volatile-%E7%9A%84%E5%BA%94%E7%94%A8">#</a>3.2. volatile 的应用</h3>
<p>如果  <code>volatile</code>  变量修饰符使用恰当的话，它比  <code>synchronized</code>  的使用和执行成本更低，因为它不会引起线程上下文的切换和调度。但是，<strong> <code>volatile</code>  无法替代  <code>synchronized</code>  ，因为  <code>volatile</code>  无法保证操作的原子性</strong>。</p>
<p>通常来说，<strong>使用  <code>volatile</code>  必须具备以下 2 个条件</strong>：</p>
<ul>
<li><strong>对变量的写操作不依赖于当前值</strong></li>
<li><strong>该变量没有包含在具有其他变量的表达式中</strong></li>
</ul>
<p>【示例】状态标记量</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">volatile</span> <span class="token keyword">boolean</span> flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>flag<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>【示例】双重锁实现线程安全的单例模式</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Singleton</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">static</span> <span class="token class-name">Singleton</span> instance <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Singleton</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>instance<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">Singleton</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>instance<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span>
                    instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> instance<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-611"><a class="markdownIt-Anchor" href="#-611">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6.html#_3-3-volatile-%E7%9A%84%E5%8E%9F%E7%90%86">#</a>3.3. volatile 的原理</h3>
<p>观察加入 volatile 关键字和没有加入 volatile 关键字时所生成的汇编代码发现，<strong>加入  <code>volatile</code>  关键字时，会多出一个  <code>lock</code>  前缀指令</strong>。<strong> <code>lock</code>  前缀指令实际上相当于一个内存屏障</strong>（也成内存栅栏），内存屏障会提供 3 个功能：</p>
<ul>
<li>它确保指令重排序时不会把其后面的指令排到内存屏障之前的位置，也不会把前面的指令排到内存屏障的后面；即在执行到内存屏障这句指令时，在它前面的操作已经全部完成；</li>
<li>它会强制将对缓存的修改操作立即写入主存；</li>
<li>如果是写操作，它会导致其他 CPU 中对应的缓存行无效。</li>
</ul>
<h3 id="-612"><a class="markdownIt-Anchor" href="#-612">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6.html#_3-4-volatile-%E7%9A%84%E9%97%AE%E9%A2%98">#</a>3.4. volatile 的问题</h3>
<p><code>volatile</code>  的要点中，已经提到，<strong> <code>volatile</code>  不保证原子性，所以 volatile 并不能保证线程安全</strong>。</p>
<p>那么，如何做到线程安全呢？有两种方案：</p>
<ul>
<li><code>volatile</code>  +  <code>synchronized</code>  - 可以参考：【示例】双重锁实现线程安全的单例模式</li>
<li>使用原子类替代  <code>volatile</code></li>
</ul>
<h2 id="-613"><a class="markdownIt-Anchor" href="#-613">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6.html#_4-cas">#</a>4. CAS</h2>
<h3 id="-614"><a class="markdownIt-Anchor" href="#-614">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6.html#_4-1-cas-%E7%9A%84%E8%A6%81%E7%82%B9">#</a>4.1. CAS 的要点</h3>
<p>互斥同步是最常见的并发正确性保障手段。</p>
<p><strong>互斥同步最主要的问题是线程阻塞和唤醒所带来的性能问题</strong>，因此互斥同步也被称为阻塞同步。互斥同步属于一种悲观的并发策略，总是认为只要不去做正确的同步措施，那就肯定会出现问题。无论共享数据是否真的会出现竞争，它都要进行加锁（这里讨论的是概念模型，实际上虚拟机会优化掉很大一部分不必要的加锁）、用户态核心态转换、维护锁计数器和检查是否有被阻塞的线程需要唤醒等操作。</p>
<p>随着硬件指令集的发展，我们可以使用基于冲突检测的乐观并发策略：先进行操作，如果没有其它线程争用共享数据，那操作就成功了，否则采取补偿措施（不断地重试，直到成功为止）。这种乐观的并发策略的许多实现都不需要将线程阻塞，因此这种同步操作称为非阻塞同步。</p>
<p>为什么说乐观锁需要 <strong>硬件指令集的发展</strong> 才能进行？因为需要操作和冲突检测这两个步骤具备原子性。而这点是由硬件来完成，如果再使用互斥同步来保证就失去意义了。硬件支持的原子性操作最典型的是：CAS。</p>
<p><strong>CAS（Compare and Swap），字面意思为比较并交换。CAS 有 3 个操作数，分别是：内存值 M，期望值 E，更新值 U。当且仅当内存值 M 和期望值 E 相等时，将内存值 M 修改为 U，否则什么都不做</strong>。</p>
<h3 id="-615"><a class="markdownIt-Anchor" href="#-615">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6.html#_4-2-cas-%E7%9A%84%E5%BA%94%E7%94%A8">#</a>4.2. CAS 的应用</h3>
<p><strong>CAS 只适用于线程冲突较少的情况</strong>。</p>
<p>CAS 的典型应用场景是：</p>
<ul>
<li>原子类</li>
<li>自旋锁</li>
</ul>
<h4 id="-616"><a class="markdownIt-Anchor" href="#-616">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6.html#%E5%8E%9F%E5%AD%90%E7%B1%BB">#</a>原子类</h4>
<blockquote>
<p>原子类是 CAS 在 Java 中最典型的应用。</p>
</blockquote>
<p>我们先来看一个常见的代码片段。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">if</span><span class="token punctuation">(</span>a<span class="token operator">==</span>b<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    a<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>如果  <code>a++</code>  执行前， a 的值被修改了怎么办？还能得到预期值吗？出现该问题的原因是在并发环境下，以上代码片段不是原子操作，随时可能被其他线程所篡改。</p>
<p>解决这种问题的最经典方式是应用原子类的  <code>incrementAndGet</code>  方法。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AtomicIntegerDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ExecutorService</span> executorService <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">AtomicInteger</span> count <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            executorService<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    count<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        executorService<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        executorService<span class="token punctuation">.</span><span class="token function">awaitTermination</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Final Count is : "</span> <span class="token operator">+</span> count<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>J.U.C 包中提供了  <code>AtomicBoolean</code> 、 <code>AtomicInteger</code> 、 <code>AtomicLong</code>  分别针对  <code>Boolean</code> 、 <code>Integer</code> 、 <code>Long</code>  执行原子操作，操作和上面的示例大体相似，不做赘述。</p>
<h4 id="-617"><a class="markdownIt-Anchor" href="#-617">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6.html#%E8%87%AA%E6%97%8B%E9%94%81-2">#</a>自旋锁</h4>
<p>利用原子类（本质上是 CAS），可以实现自旋锁。</p>
<p>所谓自旋锁，是指线程反复检查锁变量是否可用，直到成功为止。由于线程在这一过程中保持执行，因此是一种忙等待。一旦获取了自旋锁，线程会一直保持该锁，直至显式释放自旋锁。</p>
<p>示例：非线程安全示例</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AtomicReferenceDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> ticket <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ExecutorService</span> executorService <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            executorService<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        executorService<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyThread</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>ticket <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" 卖出了第 "</span> <span class="token operator">+</span> ticket <span class="token operator">+</span> <span class="token string">" 张票"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                ticket<span class="token operator">--</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>输出结果：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">pool-1-thread-2 卖出了第 10 张票
pool-1-thread-1 卖出了第 10 张票
pool-1-thread-3 卖出了第 10 张票
pool-1-thread-1 卖出了第 8 张票
pool-1-thread-2 卖出了第 9 张票
pool-1-thread-1 卖出了第 6 张票
pool-1-thread-3 卖出了第 7 张票
pool-1-thread-1 卖出了第 4 张票
pool-1-thread-2 卖出了第 5 张票
pool-1-thread-1 卖出了第 2 张票
pool-1-thread-3 卖出了第 3 张票
pool-1-thread-2 卖出了第 1 张票<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>很明显，出现了重复售票的情况。</p>
<p>【示例】使用自旋锁来保证线程安全</p>
<p>可以通过自旋锁这种非阻塞同步来保证线程安全，下面使用  <code>AtomicReference</code>  来实现一个自旋锁。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AtomicReferenceDemo2</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> ticket <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">threadSafeDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">threadSafeDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">SpinLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpinLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ExecutorService</span> executorService <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            executorService<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span>lock<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        executorService<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">SpinLock</span> <span class="token punctuation">&#123;</span>

        <span class="token keyword">private</span> <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Thread</span><span class="token punctuation">></span></span> atomicReference <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Thread</span> current <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>atomicReference<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> current<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Thread</span> current <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            atomicReference<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

    <span class="token punctuation">&#125;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyThread</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span>

        <span class="token keyword">private</span> <span class="token class-name">SpinLock</span> lock<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span><span class="token class-name">SpinLock</span> lock<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>lock <span class="token operator">=</span> lock<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>ticket <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ticket <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" 卖出了第 "</span> <span class="token operator">+</span> ticket <span class="token operator">+</span> <span class="token string">" 张票"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    ticket<span class="token operator">--</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>输出结果：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">pool-1-thread-2 卖出了第 10 张票
pool-1-thread-1 卖出了第 9 张票
pool-1-thread-3 卖出了第 8 张票
pool-1-thread-2 卖出了第 7 张票
pool-1-thread-3 卖出了第 6 张票
pool-1-thread-1 卖出了第 5 张票
pool-1-thread-2 卖出了第 4 张票
pool-1-thread-1 卖出了第 3 张票
pool-1-thread-3 卖出了第 2 张票
pool-1-thread-1 卖出了第 1 张票<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-618"><a class="markdownIt-Anchor" href="#-618">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6.html#_4-3-cas-%E7%9A%84%E5%8E%9F%E7%90%86">#</a>4.3. CAS 的原理</h3>
<p>Java 主要利用  <code>Unsafe</code>  这个类提供的 CAS 操作。 <code>Unsafe</code>  的 CAS 依赖的是 JVM 针对不同的操作系统实现的硬件指令 <strong> <code>Atomic::cmpxchg</code> </strong>。 <code>Atomic::cmpxchg</code>  的实现使用了汇编的 CAS 操作，并使用 CPU 提供的  <code>lock</code>  信号保证其原子性。</p>
<h3 id="-619"><a class="markdownIt-Anchor" href="#-619">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6.html#_4-4-cas-%E7%9A%84%E9%97%AE%E9%A2%98">#</a>4.4. CAS 的问题</h3>
<p>一般情况下，CAS 比锁性能更高。因为 CAS 是一种非阻塞算法，所以其避免了线程阻塞和唤醒的等待时间。</p>
<p>但是，事物总会有利有弊，CAS 也存在三大问题：</p>
<ul>
<li>ABA 问题</li>
<li>循环时间长开销大</li>
<li>只能保证一个共享变量的原子性</li>
</ul>
<h4 id="-620"><a class="markdownIt-Anchor" href="#-620">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6.html#aba-%E9%97%AE%E9%A2%98">#</a>ABA 问题</h4>
<p><strong>如果一个变量初次读取的时候是 A 值，它的值被改成了 B，后来又被改回为 A，那 CAS 操作就会误认为它从来没有被改变过</strong>。</p>
<p>J.U.C 包提供了一个带有标记的<strong>原子引用类  <code>AtomicStampedReference</code>  来解决这个问题</strong>，它可以通过控制变量值的版本来保证 CAS 的正确性。大部分情况下 ABA 问题不会影响程序并发的正确性，如果需要解决 ABA 问题，改用<strong>传统的互斥同步可能会比原子类更高效</strong>。</p>
<h4 id="-621"><a class="markdownIt-Anchor" href="#-621">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6.html#%E5%BE%AA%E7%8E%AF%E6%97%B6%E9%97%B4%E9%95%BF%E5%BC%80%E9%94%80%E5%A4%A7">#</a>循环时间长开销大</h4>
<p><strong>自旋 CAS （不断尝试，直到成功为止）如果长时间不成功，会给 CPU 带来非常大的执行开销</strong>。</p>
<p>如果 JVM 能支持处理器提供的  <code>pause</code>  指令那么效率会有一定的提升， <code>pause</code>  指令有两个作用：</p>
<ul>
<li>它可以延迟流水线执行指令（de-pipeline）, 使 CPU 不会消耗过多的执行资源，延迟的时间取决于具体实现的版本，在一些处理器上延迟时间是零。</li>
<li>它可以避免在退出循环的时候因内存顺序冲突（memory order violation）而引起 CPU 流水线被清空（CPU pipeline flush），从而提高 CPU 的执行效率。</li>
</ul>
<p>比较花费 CPU 资源，即使没有任何用也会做一些无用功。</p>
<h4 id="-622"><a class="markdownIt-Anchor" href="#-622">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6.html#%E5%8F%AA%E8%83%BD%E4%BF%9D%E8%AF%81%E4%B8%80%E4%B8%AA%E5%85%B1%E4%BA%AB%E5%8F%98%E9%87%8F%E7%9A%84%E5%8E%9F%E5%AD%90%E6%80%A7">#</a>只能保证一个共享变量的原子性</h4>
<p>当对一个共享变量执行操作时，我们可以使用循环 CAS 的方式来保证原子操作，但是对多个共享变量操作时，循环 CAS 就无法保证操作的原子性，这个时候就可以用锁。</p>
<p>或者有一个取巧的办法，就是把多个共享变量合并成一个共享变量来操作。比如有两个共享变量  <code>i ＝ 2, j = a</code> ，合并一下  <code>ij=2a</code> ，然后用 CAS 来操作  <code>ij</code> 。从 Java 1.5 开始 JDK 提供了  <code>AtomicReference</code>  类来保证引用对象之间的原子性，你可以把多个变量放在一个对象里来进行 CAS 操作。</p>
<h2 id="-623"><a class="markdownIt-Anchor" href="#-623">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6.html#_5-threadlocal">#</a>5. ThreadLocal</h2>
<blockquote>
<p><strong> <code>ThreadLocal</code>  是一个存储线程本地副本的工具类</strong>。</p>
<p>要保证线程安全，不一定非要进行同步。同步只是保证共享数据争用时的正确性，如果一个方法本来就不涉及共享数据，那么自然无须同步。</p>
<p>Java 中的 <strong>无同步方案</strong> 有：</p>
<ul>
<li><strong>可重入代码</strong> - 也叫纯代码。如果一个方法，它的 <strong>返回结果是可以预测的</strong>，即只要输入了相同的数据，就能返回相同的结果，那它就满足可重入性，当然也是线程安全的。</li>
<li><strong>线程本地存储</strong> - 使用 <strong> <code>ThreadLocal</code>  为共享变量在每个线程中都创建了一个本地副本</strong>，这个副本只能被当前线程访问，其他线程无法访问，那么自然是线程安全的。</li>
</ul>
</blockquote>
<h3 id="-624"><a class="markdownIt-Anchor" href="#-624">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6.html#_5-1-threadlocal-%E7%9A%84%E5%BA%94%E7%94%A8">#</a>5.1. ThreadLocal 的应用</h3>
<p><code>ThreadLocal</code>  的方法：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">T</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">></span></span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">></span></span> <span class="token function">withInitial</span><span class="token punctuation">(</span><span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">S</span><span class="token punctuation">></span></span> supplier<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>说明：</p>
<ul>
<li><code>get</code>  - 用于获取  <code>ThreadLocal</code>  在当前线程中保存的变量副本。</li>
<li><code>set</code>  - 用于设置当前线程中变量的副本。</li>
<li><code>remove</code>  - 用于删除当前线程中变量的副本。如果此线程局部变量随后被当前线程读取，则其值将通过调用其  <code>initialValue</code>  方法重新初始化，除非其值由中间线程中的当前线程设置。 这可能会导致当前线程中多次调用  <code>initialValue</code>  方法。</li>
<li><code>initialValue</code>  - 为 ThreadLocal 设置默认的  <code>get</code>  初始值，需要重写  <code>initialValue</code>  方法 。</li>
</ul>
</blockquote>
<p><code>ThreadLocal</code>  常用于防止对可变的单例（Singleton）变量或全局变量进行共享。典型应用场景有：管理数据库连接、Session。</p>
<p>【示例】数据库连接</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Connection</span><span class="token punctuation">></span></span> connectionHolder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Connection</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Connection</span> <span class="token function">initialValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token class-name">DriverManager</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span>DB_URL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Connection</span> <span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> connectionHolder<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>【示例】Session 管理</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Session</span><span class="token punctuation">></span></span> sessionHolder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Session</span> <span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Session</span> session <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Session</span><span class="token punctuation">)</span> sessionHolder<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>session <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            session <span class="token operator">=</span> <span class="token function">createSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sessionHolder<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> session<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>【示例】完整使用  <code>ThreadLocal</code>  示例</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadLocalDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> threadLocal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token class-name">Integer</span> <span class="token function">initialValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ExecutorService</span> executorService <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            executorService<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        executorService<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyThread</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">int</span> count <span class="token operator">=</span> threadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                    count<span class="token operator">++</span><span class="token punctuation">;</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
            threadLocal<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
            threadLocal<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" : "</span> <span class="token operator">+</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>全部输出 count = 10</p>
<h3 id="-625"><a class="markdownIt-Anchor" href="#-625">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6.html#_5-2-threadlocal-%E7%9A%84%E5%8E%9F%E7%90%86">#</a>5.2. ThreadLocal 的原理</h3>
<h4 id="-626"><a class="markdownIt-Anchor" href="#-626">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6.html#%E5%AD%98%E5%82%A8%E7%BB%93%E6%9E%84">#</a>存储结构</h4>
<p><strong> <code>Thread</code>  类中维护着一个  <code>ThreadLocal.ThreadLocalMap</code>  类型的成员</strong>  <code>threadLocals</code> 。这个成员就是用来存储当前线程独占的变量副本。</p>
<p><code>ThreadLocalMap</code>  是  <code>ThreadLocal</code>  的内部类，它维护着一个  <code>Entry</code>  数组，<strong> <code>Entry</code>  继承了  <code>WeakReference</code> </strong> ，所以是弱引用。  <code>Entry</code>  用于保存键值对，其中：</p>
<ul>
<li><code>key</code>  是  <code>ThreadLocal</code>  对象；</li>
<li><code>value</code>  是传递进来的对象（变量副本）。</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Thread</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// ...</span>
    <span class="token class-name">ThreadLocal<span class="token punctuation">.</span>ThreadLocalMap</span> threadLocals <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ThreadLocalMap</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Entry</span> <span class="token keyword">extends</span> <span class="token class-name">WeakReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ThreadLocal</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
        <span class="token comment">/** The value associated with this ThreadLocal. */</span>
        <span class="token class-name">Object</span> value<span class="token punctuation">;</span>

        <span class="token class-name">Entry</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> k<span class="token punctuation">,</span> <span class="token class-name">Object</span> v<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">super</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>
            value <span class="token operator">=</span> v<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-627"><a class="markdownIt-Anchor" href="#-627">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6.html#%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3-hash-%E5%86%B2%E7%AA%81">#</a>如何解决 Hash 冲突</h4>
<p><code>ThreadLocalMap</code>  虽然是类似  <code>Map</code>  结构的数据结构，但它并没有实现  <code>Map</code>  接口。它不支持  <code>Map</code>  接口中的  <code>next</code>  方法，这意味着  <code>ThreadLocalMap</code>  中解决 Hash 冲突的方式并非 <strong>拉链表</strong> 方式。</p>
<p>实际上，<strong> <code>ThreadLocalMap</code>  采用线性探测的方式来解决 Hash 冲突</strong>。所谓线性探测，就是根据初始 key 的 hashcode 值确定元素在 table 数组中的位置，如果发现这个位置上已经被其他的 key 值占用，则利用固定的算法寻找一定步长的下个位置，依次判断，直至找到能够存放的位置。</p>
<h4 id="-628"><a class="markdownIt-Anchor" href="#-628">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6.html#%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%E9%97%AE%E9%A2%98">#</a>内存泄漏问题</h4>
<p><code>ThreadLocalMap</code>  的  <code>Entry</code>  继承了  <code>WeakReference</code> ，所以它的 <strong>key （ <code>ThreadLocal</code>  对象）是弱引用，而 value （变量副本）是强引用</strong>。</p>
<ul>
<li>如果  <code>ThreadLocal</code>  对象没有外部强引用来引用它，那么  <code>ThreadLocal</code>  对象会在下次 GC 时被回收。</li>
<li>此时， <code>Entry</code>  中的 key 已经被回收，但是 value 由于是强引用不会被垃圾收集器回收。如果创建  <code>ThreadLocal</code>  的线程一直持续运行，那么 value 就会一直得不到回收，产生<strong>内存泄露</strong>。</li>
</ul>
<p>那么如何避免内存泄漏呢？方法就是：<strong>使用  <code>ThreadLocal</code>  的  <code>set</code>  方法后，显示的调用  <code>remove</code>  方法</strong> 。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> threadLocal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    threadLocal<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"xxx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
    threadLocal<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-629"><a class="markdownIt-Anchor" href="#-629">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6.html#_5-3-threadlocal-%E7%9A%84%E8%AF%AF%E5%8C%BA">#</a>5.3. ThreadLocal 的误区</h3>
<blockquote>
<p>示例摘自：<a target="_blank" rel="noopener" href="https://time.geekbang.org/column/intro/100047701">《Java 业务开发常见错误 100 例》(opens new window)</a></p>
</blockquote>
<p>ThreadLocal 适用于变量在线程间隔离，而在方法或类间共享的场景。</p>
<p>前文提到，ThreadLocal 是线程隔离的，那么是不是使用 ThreadLocal 就一定高枕无忧呢？</p>
<h4 id="-630"><a class="markdownIt-Anchor" href="#-630">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6.html#threadlocal-%E9%94%99%E8%AF%AF%E6%A1%88%E4%BE%8B">#</a>ThreadLocal 错误案例</h4>
<p>使用 Spring Boot 创建一个 Web 应用程序，使用 ThreadLocal 存放一个 Integer 的值，来暂且代表需要在线程中保存的用户信息，这个值初始是 null。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> currentUser <span class="token operator">=</span> <span class="token class-name">ThreadLocal</span><span class="token punctuation">.</span><span class="token function">withInitial</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"wrong"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">wrong</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> userId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//设置用户信息之前先查询一次ThreadLocal中的用户信息</span>
    <span class="token class-name">String</span> before <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> currentUser<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//设置用户信息到ThreadLocal</span>
    currentUser<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//设置用户信息之后再查询一次ThreadLocal中的用户信息</span>
    <span class="token class-name">String</span> after <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> currentUser<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//汇总输出两次查询结果</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"before"</span><span class="token punctuation">,</span> before<span class="token punctuation">)</span><span class="token punctuation">;</span>
    result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"after"</span><span class="token punctuation">,</span> after<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>【预期】从代码逻辑来看，我们预期第一次获取的值始终应该是 null。</p>
<p>【实际】</p>
<p>为了方便复现，将 Tomcat 工作线程设为 1：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">server.tomcat.max-threads=1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>当访问 id = 1 时，符合预期</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/20200731111854.png" alt="img"></p>
<p>当访问 id = 2 时，before 的应答不是 null，而是 1，不符合预期。</p>
<p><img src="C:/%5CUsers%5Czp%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200731111921591.png" alt="image-20200731111921591"></p>
<p>【分析】实际情况和预期存在偏差。Spring Boot 程序运行在 Tomcat 中，执行程序的线程是 Tomcat 的工作线程，而 Tomcat 的工作线程是基于线程池的。<strong>线程池会重用固定的几个线程，一旦线程重用，那么很可能首次从</strong> <strong>ThreadLocal 获取的值是之前其他用户的请求遗留的值。这时，ThreadLocal 中的用户信息就是其他用户的信息</strong>。</p>
<p><strong>并不能认为没有显式开启多线程就不会有线程安全问题</strong>。使用类似 ThreadLocal 工具来存放一些数据时，需要特别注意在代码运行完后，显式地去清空设置的数据。</p>
<h4 id="-631"><a class="markdownIt-Anchor" href="#-631">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6.html#threadlocal-%E9%94%99%E8%AF%AF%E6%A1%88%E4%BE%8B%E4%BF%AE%E6%AD%A3">#</a>ThreadLocal 错误案例修正</h4>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"right"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">right</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> userId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">String</span> before <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> currentUser<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    currentUser<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> after <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> currentUser<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"before"</span><span class="token punctuation">,</span> before<span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"after"</span><span class="token punctuation">,</span> after<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//在finally代码块中删除ThreadLocal中的数据，确保数据不串</span>
        currentUser<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-632"><a class="markdownIt-Anchor" href="#-632">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6.html#_5-4-inheritablethreadlocal">#</a>5.4. InheritableThreadLocal</h3>
<p><code>InheritableThreadLocal</code>  类是  <code>ThreadLocal</code>  类的子类。</p>
<p><code>ThreadLocal</code>  中每个线程拥有它自己独占的数据。与  <code>ThreadLocal</code>  不同的是， <code>InheritableThreadLocal</code>  允许一个线程以及该线程创建的所有子线程都可以访问它保存的数据。</p>
<blockquote>
<p>原理参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/ni357103403/article/details/51970748">Java 多线程：InheritableThreadLocal 实现原理</a></p>
</blockquote>
<hr>
<h1 id="深入理解-java-并发锁"><a class="markdownIt-Anchor" href="#深入理解-java-并发锁">#</a> 深入理解 Java 并发锁</h1>
<blockquote>
<p><strong>📦 本文以及示例源码已归档在 <a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/">javacore(opens new window)</a></strong></p>
<p>本文先阐述 Java 中各种锁的概念。</p>
<p>然后，介绍锁的核心实现 AQS。</p>
<p>然后，重点介绍 Lock 和 Condition 两个接口及其实现。并发编程有两个核心问题：同步和互斥。</p>
<p><strong>互斥</strong>，即同一时刻只允许一个线程访问共享资源；</p>
<p><strong>同步</strong>，即线程之间如何通信、协作。</p>
<p>这两大问题，管程（ <code>sychronized</code> ）都是能够解决的。<strong>J.U.C 包还提供了 Lock 和 Condition 两个接口来实现管程，其中 Lock 用于解决互斥问题，Condition 用于解决同步问题</strong>。</p>
</blockquote>
<ul>
<li>\1. 并发锁简介
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#11-%E5%8F%AF%E9%87%8D%E5%85%A5%E9%94%81">1.1. 可重入锁</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#12-%E5%85%AC%E5%B9%B3%E9%94%81%E4%B8%8E%E9%9D%9E%E5%85%AC%E5%B9%B3%E9%94%81">1.2. 公平锁与非公平锁</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#13-%E7%8B%AC%E4%BA%AB%E9%94%81%E4%B8%8E%E5%85%B1%E4%BA%AB%E9%94%81">1.3. 独享锁与共享锁</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#14-%E6%82%B2%E8%A7%82%E9%94%81%E4%B8%8E%E4%B9%90%E8%A7%82%E9%94%81">1.4. 悲观锁与乐观锁</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#15-%E5%81%8F%E5%90%91%E9%94%81%E8%BD%BB%E9%87%8F%E7%BA%A7%E9%94%81%E9%87%8D%E9%87%8F%E7%BA%A7%E9%94%81">1.5. 偏向锁、轻量级锁、重量级锁</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#16-%E5%88%86%E6%AE%B5%E9%94%81">1.6. 分段锁</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#17-%E6%98%BE%E7%A4%BA%E9%94%81%E5%92%8C%E5%86%85%E7%BD%AE%E9%94%81">1.7. 显示锁和内置锁</a></li>
</ul>
</li>
<li>\2. Lock 和 Condition
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#21-%E4%B8%BA%E4%BD%95%E5%BC%95%E5%85%A5-lock-%E5%92%8C-condition">2.1. 为何引入 Lock 和 Condition</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#22-lock-%E6%8E%A5%E5%8F%A3">2.2. Lock 接口</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#23-condition">2.3. Condition</a></li>
</ul>
</li>
<li>\3. ReentrantLock
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#31-reentrantlock-%E7%9A%84%E7%89%B9%E6%80%A7">3.1. ReentrantLock 的特性</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#32-reentrantlock-%E7%9A%84%E7%94%A8%E6%B3%95">3.2. ReentrantLock 的用法</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#33-reentrantlock-%E7%9A%84%E5%8E%9F%E7%90%86">3.3. ReentrantLock 的原理</a></li>
</ul>
</li>
<li>\4. ReentrantReadWriteLock
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#41-reentrantreadwritelock-%E7%9A%84%E7%89%B9%E6%80%A7">4.1. ReentrantReadWriteLock 的特性</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#42-reentrantreadwritelock-%E7%9A%84%E7%94%A8%E6%B3%95">4.2. ReentrantReadWriteLock 的用法</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#43-reentrantreadwritelock-%E7%9A%84%E5%8E%9F%E7%90%86">4.3. ReentrantReadWriteLock 的原理</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#5-stampedlock">5. StampedLock</a></li>
<li>\6. AQS
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#61-aqs-%E7%9A%84%E8%A6%81%E7%82%B9">6.1. AQS 的要点</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#62-aqs-%E7%9A%84%E5%BA%94%E7%94%A8">6.2. AQS 的应用</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#63-aqs-%E7%9A%84%E5%8E%9F%E7%90%86">6.3. AQS 的原理</a></li>
</ul>
</li>
<li>\7. 死锁
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#71-%E4%BB%80%E4%B9%88%E6%98%AF%E6%AD%BB%E9%94%81">7.1. 什么是死锁</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#72-%E5%A6%82%E4%BD%95%E5%AE%9A%E4%BD%8D%E6%AD%BB%E9%94%81">7.2. 如何定位死锁</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#73-%E5%A6%82%E4%BD%95%E9%81%BF%E5%85%8D%E6%AD%BB%E9%94%81">7.3. 如何避免死锁</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#8-%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">8. 参考资料</a></li>
</ul>
<h2 id="-633"><a class="markdownIt-Anchor" href="#-633">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#_1-%E5%B9%B6%E5%8F%91%E9%94%81%E7%AE%80%E4%BB%8B">#</a>1. 并发锁简介</h2>
<p>确保线程安全最常见的做法是利用锁机制（ <code>Lock</code> 、 <code>sychronized</code> ）来对共享数据做互斥同步，这样在同一个时刻，只有一个线程可以执行某个方法或者某个代码块，那么操作必然是原子性的，线程安全的。</p>
<p>在工作、面试中，经常会听到各种五花八门的锁，听的人云里雾里。锁的概念术语很多，它们是针对不同的问题所提出的，通过简单的梳理，也不难理解。</p>
<h3 id="-634"><a class="markdownIt-Anchor" href="#-634">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#_1-1-%E5%8F%AF%E9%87%8D%E5%85%A5%E9%94%81">#</a>1.1. 可重入锁</h3>
<p><strong>可重入锁，顾名思义，指的是线程可以重复获取同一把锁</strong>。即同一个线程在外层方法获取了锁，在进入内层方法会自动获取锁。</p>
<p><strong>可重入锁可以在一定程度上避免死锁</strong>。</p>
<ul>
<li><strong> <code>ReentrantLock</code>  、 <code>ReentrantReadWriteLock</code>  是可重入锁</strong>。这点，从其命名也不难看出。</li>
<li><strong> <code>synchronized</code>  也是一个可重入锁</strong>。</li>
</ul>
<p>【示例】 <code>synchronized</code>  的可重入示例</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">setA</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">setB</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上面的代码就是一个典型场景：如果使用的锁不是可重入锁的话， <code>setB</code>  可能不会被当前线程执行，从而造成死锁。</p>
<p>【示例】 <code>ReentrantLock</code>  的可重入示例</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Task</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> value<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Lock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Task</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 获取锁</span>
        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> value<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 保证锁能释放</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 获取锁</span>
        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 注意：此处已经成功获取锁，进入 get 方法后，又尝试获取锁，</span>
            <span class="token comment">// 如果锁不是可重入的，会导致死锁</span>
            value <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 保证锁能释放</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-635"><a class="markdownIt-Anchor" href="#-635">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#_1-2-%E5%85%AC%E5%B9%B3%E9%94%81%E4%B8%8E%E9%9D%9E%E5%85%AC%E5%B9%B3%E9%94%81">#</a>1.2. 公平锁与非公平锁</h3>
<ul>
<li><strong>公平锁</strong> - 公平锁是指 <strong>多线程按照申请锁的顺序来获取锁</strong>。</li>
<li><strong>非公平锁</strong> - 非公平锁是指 <strong>多线程不按照申请锁的顺序来获取锁</strong> 。这就可能会出现优先级反转（后来者居上）或者饥饿现象（某线程总是抢不过别的线程，导致始终无法执行）。</li>
</ul>
<p>公平锁为了保证线程申请顺序，势必要付出一定的性能代价，因此其吞吐量一般低于非公平锁。</p>
<p>公平锁与非公平锁 在 Java 中的典型实现：</p>
<ul>
<li><strong> <code>synchronized</code>  只支持非公平锁</strong>。</li>
<li><strong> <code>ReentrantLock</code>  、 <code>ReentrantReadWriteLock</code> ，默认是非公平锁，但支持公平锁</strong>。</li>
</ul>
<h3 id="-636"><a class="markdownIt-Anchor" href="#-636">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#_1-3-%E7%8B%AC%E4%BA%AB%E9%94%81%E4%B8%8E%E5%85%B1%E4%BA%AB%E9%94%81">#</a>1.3. 独享锁与共享锁</h3>
<p>独享锁与共享锁是一种广义上的说法，从实际用途上来看，也常被称为互斥锁与读写锁。</p>
<ul>
<li><strong>独享锁</strong> - 独享锁是指 <strong>锁一次只能被一个线程所持有</strong>。</li>
<li><strong>共享锁</strong> - 共享锁是指 <strong>锁可被多个线程所持有</strong>。</li>
</ul>
<p>独享锁与共享锁在 Java 中的典型实现：</p>
<ul>
<li><strong> <code>synchronized</code>  、 <code>ReentrantLock</code>  只支持独享锁</strong>。</li>
<li><strong> <code>ReentrantReadWriteLock</code>  其写锁是独享锁，其读锁是共享锁</strong>。读锁是共享锁使得并发读是非常高效的，读写，写读 ，写写的过程是互斥的。</li>
</ul>
<h3 id="-637"><a class="markdownIt-Anchor" href="#-637">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#_1-4-%E6%82%B2%E8%A7%82%E9%94%81%E4%B8%8E%E4%B9%90%E8%A7%82%E9%94%81">#</a>1.4. 悲观锁与乐观锁</h3>
<p>乐观锁与悲观锁不是指具体的什么类型的锁，而是<strong>处理并发同步的策略</strong>。</p>
<ul>
<li><strong>悲观锁</strong> - 悲观锁对于并发采取悲观的态度，认为：<strong>不加锁的并发操作一定会出问题</strong>。<strong>悲观锁适合写操作频繁的场景</strong>。</li>
<li><strong>乐观锁</strong> - 乐观锁对于并发采取乐观的态度，认为：<strong>不加锁的并发操作也没什么问题。对于同一个数据的并发操作，是不会发生修改的</strong>。在更新数据的时候，会采用不断尝试更新的方式更新数据。<strong>乐观锁适合读多写少的场景</strong>。</li>
</ul>
<p>悲观锁与乐观锁在 Java 中的典型实现：</p>
<ul>
<li>悲观锁在 Java 中的应用就是通过使用  <code>synchronized</code>  和  <code>Lock</code>  显示加锁来进行互斥同步，这是一种阻塞同步。</li>
<li>乐观锁在 Java 中的应用就是采用  <code>CAS</code>  机制（ <code>CAS</code>  操作通过  <code>Unsafe</code>  类提供，但这个类不直接暴露为 API，所以都是间接使用，如各种原子类）。</li>
</ul>
<h3 id="-638"><a class="markdownIt-Anchor" href="#-638">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#_1-5-%E5%81%8F%E5%90%91%E9%94%81%E3%80%81%E8%BD%BB%E9%87%8F%E7%BA%A7%E9%94%81%E3%80%81%E9%87%8D%E9%87%8F%E7%BA%A7%E9%94%81">#</a>1.5. 偏向锁、轻量级锁、重量级锁</h3>
<p>所谓轻量级锁与重量级锁，指的是锁控制粒度的粗细。显然，控制粒度越细，阻塞开销越小，并发性也就越高。</p>
<p>Java 1.6 以前，重量级锁一般指的是  <code>synchronized</code>  ，而轻量级锁指的是  <code>volatile</code> 。</p>
<p>Java 1.6 以后，针对  <code>synchronized</code>  做了大量优化，引入 4 种锁状态： 无锁状态、偏向锁、轻量级锁和重量级锁。锁可以单向的从偏向锁升级到轻量级锁，再从轻量级锁升级到重量级锁 。</p>
<ul>
<li><strong>偏向锁</strong> - 偏向锁是指一段同步代码一直被一个线程所访问，那么该线程会自动获取锁。降低获取锁的代价。</li>
<li><strong>轻量级锁</strong> - 是指当锁是偏向锁的时候，被另一个线程所访问，偏向锁就会升级为轻量级锁，其他线程会通过自旋的形式尝试获取锁，不会阻塞，提高性能。</li>
<li><strong>重量级锁</strong> - 是指当锁为轻量级锁的时候，另一个线程虽然是自旋，但自旋不会一直持续下去，当自旋一定次数的时候，还没有获取到锁，就会进入阻塞，该锁膨胀为重量级锁。重量级锁会让其他申请的线程进入阻塞，性能降低。</li>
</ul>
<h3 id="-639"><a class="markdownIt-Anchor" href="#-639">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#_1-6-%E5%88%86%E6%AE%B5%E9%94%81">#</a>1.6. 分段锁</h3>
<p>分段锁其实是一种锁的设计，并不是具体的一种锁。所谓分段锁，就是把锁的对象分成多段，每段独立控制，使得锁粒度更细，减少阻塞开销，从而提高并发性。这其实很好理解，就像高速公路上的收费站，如果只有一个收费口，那所有的车只能排成一条队缴费；如果有多个收费口，就可以分流了。</p>
<p><code>Hashtable</code>  使用  <code>synchronized</code>  修饰方法来保证线程安全性，那么面对线程的访问，Hashtable 就会锁住整个对象，所有的其它线程只能等待，这种阻塞方式的吞吐量显然很低。</p>
<p>Java 1.7 以前的  <code>ConcurrentHashMap</code>  就是分段锁的典型案例。 <code>ConcurrentHashMap</code>  维护了一个  <code>Segment</code>  数组，一般称为分段桶。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">final</span> <span class="token class-name">Segment</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> segments<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>当有线程访问  <code>ConcurrentHashMap</code>  的数据时， <code>ConcurrentHashMap</code>  会先根据 hashCode 计算出数据在哪个桶（即哪个 Segment），然后锁住这个  <code>Segment</code> 。</p>
<h3 id="-640"><a class="markdownIt-Anchor" href="#-640">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#_1-7-%E6%98%BE%E7%A4%BA%E9%94%81%E5%92%8C%E5%86%85%E7%BD%AE%E9%94%81">#</a>1.7. 显示锁和内置锁</h3>
<p>Java 1.5 之前，协调对共享对象的访问时可以使用的机制只有  <code>synchronized</code>  和  <code>volatile</code> 。这两个都属于内置锁，即锁的申请和释放都是由 JVM 所控制。</p>
<p>Java 1.5 之后，增加了新的机制： <code>ReentrantLock</code> 、 <code>ReentrantReadWriteLock</code>  ，这类锁的申请和释放都可以由程序所控制，所以常被称为显示锁。</p>
<blockquote>
<p>💡  <code>synchronized</code>  的用法和原理可以参考：<a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/blob/master/docs/concurrent/Java%E5%B9%B6%E5%8F%91%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6.md#%E4%BA%8Csynchronized">Java 并发基础机制 - synchronized (opens new window)</a>。</p>
<p>🔔 注意：如果不需要  <code>ReentrantLock</code> 、 <code>ReentrantReadWriteLock</code>  所提供的高级同步特性，<strong>应该优先考虑使用  <code>synchronized</code> </strong> 。理由如下：</p>
<ul>
<li>Java 1.6 以后， <code>synchronized</code>  做了大量的优化，其性能已经与  <code>ReentrantLock</code> 、 <code>ReentrantReadWriteLock</code>  基本上持平。</li>
<li>从趋势来看，Java 未来更可能会优化  <code>synchronized</code>  ，而不是  <code>ReentrantLock</code> 、 <code>ReentrantReadWriteLock</code>  ，因为  <code>synchronized</code>  是 JVM 内置属性，它能执行一些优化。</li>
<li><code>ReentrantLock</code> 、 <code>ReentrantReadWriteLock</code>  申请和释放锁都是由程序控制，如果使用不当，可能造成死锁，这是很危险的。</li>
</ul>
</blockquote>
<p>以下对比一下显示锁和内置锁的差异：</p>
<ul>
<li>主动获取锁和释放锁
<ul>
<li><code>synchronized</code>  不能主动获取锁和释放锁。获取锁和释放锁都是 JVM 控制的。</li>
<li><code>ReentrantLock</code>  可以主动获取锁和释放锁。（如果忘记释放锁，就可能产生死锁）。</li>
</ul>
</li>
<li>响应中断
<ul>
<li><code>synchronized</code>  不能响应中断。</li>
<li><code>ReentrantLock</code>  可以响应中断。</li>
</ul>
</li>
<li>超时机制
<ul>
<li><code>synchronized</code>  没有超时机制。</li>
<li><code>ReentrantLock</code>  有超时机制。 <code>ReentrantLock</code>  可以设置超时时间，超时后自动释放锁，避免一直等待。</li>
</ul>
</li>
<li>支持公平锁
<ul>
<li><code>synchronized</code>  只支持非公平锁。</li>
<li><code>ReentrantLock</code>  支持非公平锁和公平锁。</li>
</ul>
</li>
<li>是否支持共享
<ul>
<li>被  <code>synchronized</code>  修饰的方法或代码块，只能被一个线程访问（独享）。如果这个线程被阻塞，其他线程也只能等待</li>
<li><code>ReentrantLock</code>  可以基于  <code>Condition</code>  灵活的控制同步条件。</li>
</ul>
</li>
<li>是否支持读写分离
<ul>
<li><code>synchronized</code>  不支持读写锁分离；</li>
<li><code>ReentrantReadWriteLock</code>  支持读写锁，从而使阻塞读写的操作分开，有效提高并发性。</li>
</ul>
</li>
</ul>
<h2 id="-641"><a class="markdownIt-Anchor" href="#-641">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#_2-lock-%E5%92%8C-condition">#</a>2. Lock 和 Condition</h2>
<h3 id="-642"><a class="markdownIt-Anchor" href="#-642">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#_2-1-%E4%B8%BA%E4%BD%95%E5%BC%95%E5%85%A5-lock-%E5%92%8C-condition">#</a>2.1. 为何引入 Lock 和 Condition</h3>
<p>并发编程领域，有两大核心问题：一个是<strong>互斥</strong>，即同一时刻只允许一个线程访问共享资源；另一个是<strong>同步</strong>，即线程之间如何通信、协作。这两大问题，管程都是能够解决的。<strong>Java SDK 并发包通过 Lock 和 Condition 两个接口来实现管程，其中 Lock 用于解决互斥问题，Condition 用于解决同步问题</strong>。</p>
<p>synchronized 是管程的一种实现，既然如此，何必再提供 Lock 和 Condition。</p>
<p>JDK 1.6 以前，synchronized 还没有做优化，性能远低于 Lock。但是，性能不是引入 Lock 的最重要因素。真正关键在于：synchronized 使用不当，可能会出现死锁。</p>
<p>synchronized 无法通过<strong>破坏不可抢占条件</strong>来避免死锁。原因是 synchronized 申请资源的时候，如果申请不到，线程直接进入阻塞状态了，而线程进入阻塞状态，啥都干不了，也释放不了线程已经占有的资源。</p>
<p>与内置锁  <code>synchronized</code>  不同的是，<strong> <code>Lock</code>  提供了一组无条件的、可轮询的、定时的以及可中断的锁操作</strong>，所有获取锁、释放锁的操作都是显式的操作。</p>
<ul>
<li><strong>能够响应中断</strong>。synchronized 的问题是，持有锁 A 后，如果尝试获取锁 B 失败，那么线程就进入阻塞状态，一旦发生死锁，就没有任何机会来唤醒阻塞的线程。但如果阻塞状态的线程能够响应中断信号，也就是说当我们给阻塞的线程发送中断信号的时候，能够唤醒它，那它就有机会释放曾经持有的锁 A。这样就破坏了不可抢占条件了。</li>
<li><strong>支持超时</strong>。如果线程在一段时间之内没有获取到锁，不是进入阻塞状态，而是返回一个错误，那这个线程也有机会释放曾经持有的锁。这样也能破坏不可抢占条件。</li>
<li><strong>非阻塞地获取锁</strong>。如果尝试获取锁失败，并不进入阻塞状态，而是直接返回，那这个线程也有机会释放曾经持有的锁。这样也能破坏不可抢占条件。</li>
</ul>
<h3 id="-643"><a class="markdownIt-Anchor" href="#-643">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#_2-2-lock-%E6%8E%A5%E5%8F%A3">#</a>2.2. Lock 接口</h3>
<p><code>Lock</code>  的接口定义如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Lock</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token keyword">long</span> time<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Condition</span> <span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><code>lock()</code>  - 获取锁。</li>
<li><code>unlock()</code>  - 释放锁。</li>
<li><code>tryLock()</code>  - 尝试获取锁，仅在调用时锁未被另一个线程持有的情况下，才获取该锁。</li>
<li><code>tryLock(long time, TimeUnit unit)</code>  - 和  <code>tryLock()</code>  类似，区别仅在于限定时间，如果限定时间内未获取到锁，视为失败。</li>
<li><code>lockInterruptibly()</code>  - 锁未被另一个线程持有，且线程没有被中断的情况下，才能获取锁。</li>
<li><code>newCondition()</code>  - 返回一个绑定到  <code>Lock</code>  对象上的  <code>Condition</code>  实例。</li>
</ul>
<h3 id="-644"><a class="markdownIt-Anchor" href="#-644">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#_2-3-condition">#</a>2.3. Condition</h3>
<p><strong>Condition 实现了管程模型里面的条件变量</strong>。</p>
<p>前文中提过  <code>Lock</code>  接口中 有一个  <code>newCondition()</code>  方法用于返回一个绑定到  <code>Lock</code>  对象上的  <code>Condition</code>  实例。 <code>Condition</code>  是什么？有什么作用？本节将一一讲解。</p>
<p>在单线程中，一段代码的执行可能依赖于某个状态，如果不满足状态条件，代码就不会被执行（典型的场景，如： <code>if ... else ...</code> ）。在并发环境中，当一个线程判断某个状态条件时，其状态可能是由于其他线程的操作而改变，这时就需要有一定的协调机制来确保在同一时刻，数据只能被一个线程锁修改，且修改的数据状态被所有线程所感知。</p>
<p>Java 1.5 之前，主要是利用  <code>Object</code>  类中的  <code>wait</code> 、 <code>notify</code> 、 <code>notifyAll</code>  配合  <code>synchronized</code>  来进行线程间通信（如果不了解其特性，可以参考：<a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/#/concurrent/java-thread?id=waitnotifynotifyall">Java 线程基础 - wait/notify/notifyAll (opens new window)</a>）。</p>
<p><code>wait</code> 、 <code>notify</code> 、 <code>notifyAll</code>  需要配合  <code>synchronized</code>  使用，不适用于  <code>Lock</code> 。而使用  <code>Lock</code>  的线程，彼此间通信应该使用  <code>Condition</code>  。这可以理解为，什么样的锁配什么样的钥匙。<strong>内置锁（ <code>synchronized</code> ）配合内置条件队列（ <code>wait</code> 、 <code>notify</code> 、 <code>notifyAll</code>  ），显式锁（ <code>Lock</code> ）配合显式条件队列（ <code>Condition</code>  ）</strong>。</p>
<h4 id="-645"><a class="markdownIt-Anchor" href="#-645">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#condition-%E7%9A%84%E7%89%B9%E6%80%A7">#</a>Condition 的特性</h4>
<p><code>Condition</code>  接口定义如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Condition</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">void</span> <span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">awaitUninterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> <span class="token function">awaitNanos</span><span class="token punctuation">(</span><span class="token keyword">long</span> nanosTimeout<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> <span class="token function">await</span><span class="token punctuation">(</span><span class="token keyword">long</span> time<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> <span class="token function">awaitUntil</span><span class="token punctuation">(</span><span class="token class-name">Date</span> deadline<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">signalAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中， <code>await</code> 、 <code>signal</code> 、 <code>signalAll</code>  与  <code>wait</code> 、 <code>notify</code> 、 <code>notifyAll</code>  相对应，功能也相似。除此以外， <code>Condition</code>  相比内置条件队列（  <code>wait</code> 、 <code>notify</code> 、 <code>notifyAll</code>  ），提供了更为丰富的功能：</p>
<ul>
<li>每个锁（ <code>Lock</code> ）上可以存在多个  <code>Condition</code> ，这意味着锁的状态条件可以有多个。</li>
<li>支持公平的或非公平的队列操作。</li>
<li>支持可中断的条件等待，相关方法： <code>awaitUninterruptibly()</code>  。</li>
<li>支持可定时的等待，相关方法： <code>awaitNanos(long)</code>  、 <code>await(long, TimeUnit)</code> 、 <code>awaitUntil(Date)</code> 。</li>
</ul>
<h4 id="-646"><a class="markdownIt-Anchor" href="#-646">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#condition-%E7%9A%84%E7%94%A8%E6%B3%95">#</a>Condition 的用法</h4>
<p>这里以  <code>Condition</code>  来实现一个消费者、生产者模式。</p>
<blockquote>
<p>🔔 注意：事实上，解决此类问题使用  <code>CountDownLatch</code> 、 <code>Semaphore</code>  等工具更为便捷、安全。想了解详情，可以参考 <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/#/concurrent/java-concurrent-tools">Java 并发工具类 (opens new window)</a>。</p>
</blockquote>
<p>产品类</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Message</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Lock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Condition</span> producedMsg <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Condition</span> consumedMsg <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> message<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> state<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> end<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">consume</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//lock</span>
        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// no new message wait for new message</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>state<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> producedMsg<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>

            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"consume message : "</span> <span class="token operator">+</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            state <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token comment">// message consumed, notify waiting thread</span>
            consumedMsg<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ie<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Thread interrupted - viewMessage"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">produce</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// last message not consumed, wait for it be consumed</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> consumedMsg<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>

            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"produce msg: "</span> <span class="token operator">+</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>message <span class="token operator">=</span> message<span class="token punctuation">;</span>
            state <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token comment">// new message added, notify waiting thread</span>
            producedMsg<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ie<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Thread interrupted - publishMessage"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> end<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setEnd</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> end<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>end <span class="token operator">=</span> end<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>消费者</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">MessageConsumer</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token class-name">Message</span> message<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">MessageConsumer</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        message <span class="token operator">=</span> msg<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>message<span class="token punctuation">.</span><span class="token function">isEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> message<span class="token punctuation">.</span><span class="token function">consume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>生产者</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">MessageProducer</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token class-name">Message</span> message<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">MessageProducer</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        message <span class="token operator">=</span> msg<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">produce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">produce</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> msgs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        msgs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"Begin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        msgs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"Msg1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        msgs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"Msg2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> msg <span class="token operator">:</span> msgs<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            message<span class="token punctuation">.</span><span class="token function">produce</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        message<span class="token punctuation">.</span><span class="token function">produce</span><span class="token punctuation">(</span><span class="token string">"End"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        message<span class="token punctuation">.</span><span class="token function">setEnd</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>测试</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LockConditionDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Message</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MessageProducer</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MessageConsumer</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="-647"><a class="markdownIt-Anchor" href="#-647">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#_3-reentrantlock">#</a>3. ReentrantLock</h2>
<p><code>ReentrantLock</code>  类是  <code>Lock</code>  接口的具体实现，与内置锁  <code>synchronized</code>  相同的是，它是一个<strong>可重入锁</strong>。</p>
<h3 id="-648"><a class="markdownIt-Anchor" href="#-648">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#_3-1-reentrantlock-%E7%9A%84%E7%89%B9%E6%80%A7">#</a>3.1. ReentrantLock 的特性</h3>
<p><code>ReentrantLock</code>  的特性如下：</p>
<ul>
<li>
<p><strong> <code>ReentrantLock</code>  提供了与  <code>synchronized</code>  相同的互斥性、内存可见性和可重入性</strong>。</p>
</li>
<li>
<p><code>ReentrantLock</code>  <strong>支持公平锁和非公平锁</strong>（默认）两种模式。</p>
</li>
<li>
<pre><code>
  ReentrantLock
  <pre class="line-numbers language-none"><code class="language-none">

​	 

	实现了


​	 
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
  Lock
  <pre class="line-numbers language-none"><code class="language-none">

​	 

	接口，支持了


​	 
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
  synchronized
  <pre class="line-numbers language-none"><code class="language-none">

​	 

	所不具备的
	
	灵活性
	
	。
	
	- &#96;synchronized&#96; 无法中断一个正在等待获取锁的线程
	- &#96;synchronized&#96; 无法在请求获取一个锁时无休止地等待

### [#](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java锁.html#_3-2-reentrantlock-的用法)3.2. ReentrantLock 的用法

前文了解了 &#96;ReentrantLock&#96; 的特性，接下来，我们要讲述其具体用法。

#### [#](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java锁.html#reentrantlock-的构造方法)ReentrantLock 的构造方法

&#96;ReentrantLock&#96; 有两个构造方法：

&#96;&#96;&#96;java
public ReentrantLock() &#123;&#125;
public ReentrantLock(boolean fair) &#123;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

</code></pre>
</li>
<li>
<p><code>ReentrantLock()</code>  - 默认构造方法会初始化一个<strong>非公平锁（NonfairSync）</strong>；</p>
</li>
<li>
<p><code>ReentrantLock(boolean)</code>  -  <code>new ReentrantLock(true)</code>  会初始化一个<strong>公平锁（FairSync）</strong>。</p>
</li>
</ul>
<h4 id="-649"><a class="markdownIt-Anchor" href="#-649">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#lock-%E5%92%8C-unlock-%E6%96%B9%E6%B3%95">#</a>lock 和 unlock 方法</h4>
<ul>
<li><code>lock()</code>  - <strong>无条件获取锁</strong>。如果当前线程无法获取锁，则当前线程进入休眠状态不可用，直至当前线程获取到锁。如果该锁没有被另一个线程持有，则获取该锁并立即返回，将锁的持有计数设置为 1。</li>
<li><code>unlock()</code>  - 用于<strong>释放锁</strong>。</li>
</ul>
<blockquote>
<p>🔔 注意：请务必牢记，获取锁操作 <strong> <code>lock()</code>  必须在  <code>try catch</code>  块中进行，并且将释放锁操作  <code>unlock()</code>  放在  <code>finally</code>  块中进行，以保证锁一定被被释放，防止死锁的发生</strong>。</p>
</blockquote>
<p>示例： <code>ReentrantLock</code>  的基本操作</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReentrantLockDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Task</span> task <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MyThread</span> tA <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span><span class="token string">"Thread-A"</span><span class="token punctuation">,</span> task<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MyThread</span> tB <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span><span class="token string">"Thread-B"</span><span class="token punctuation">,</span> task<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MyThread</span> tC <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span><span class="token string">"Thread-C"</span><span class="token punctuation">,</span> task<span class="token punctuation">)</span><span class="token punctuation">;</span>
        tA<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tB<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tC<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyThread</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">&#123;</span>

        <span class="token keyword">private</span> <span class="token class-name">Task</span> task<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">Task</span> task<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">super</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>task <span class="token operator">=</span> task<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            task<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

    <span class="token punctuation">&#125;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Task</span> <span class="token punctuation">&#123;</span>

        <span class="token keyword">private</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>lock<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">// 查询当前线程 hold 住此锁的次数</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"\t holdCount: "</span> <span class="token operator">+</span> lock<span class="token punctuation">.</span><span class="token function">getHoldCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">// 查询正等待获取此锁的线程数</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"\t queuedLength: "</span> <span class="token operator">+</span> lock<span class="token punctuation">.</span><span class="token function">getQueueLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">// 是否为公平锁</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"\t isFair: "</span> <span class="token operator">+</span> lock<span class="token punctuation">.</span><span class="token function">isFair</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">// 是否被锁住</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"\t isLocked: "</span> <span class="token operator">+</span> lock<span class="token punctuation">.</span><span class="token function">isLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">// 是否被当前线程持有锁</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"\t isHeldByCurrentThread: "</span> <span class="token operator">+</span> lock<span class="token punctuation">.</span><span class="token function">isHeldByCurrentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
                lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>输出结果：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span>ReentrantLock</span><span class="token annotation punctuation">@64fcd88a</span><span class="token punctuation">[</span><span class="token class-name">Locked</span> by thread <span class="token class-name">Thread</span><span class="token operator">-</span><span class="token class-name">A</span><span class="token punctuation">]</span>
	 holdCount<span class="token operator">:</span> <span class="token number">1</span>
	 queuedLength<span class="token operator">:</span> <span class="token number">2</span>
	 isFair<span class="token operator">:</span> <span class="token boolean">false</span>
	 isLocked<span class="token operator">:</span> <span class="token boolean">true</span>
	 isHeldByCurrentThread<span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span>ReentrantLock</span><span class="token annotation punctuation">@64fcd88a</span><span class="token punctuation">[</span><span class="token class-name">Locked</span> by thread <span class="token class-name">Thread</span><span class="token operator">-</span><span class="token class-name">C</span><span class="token punctuation">]</span>
	 holdCount<span class="token operator">:</span> <span class="token number">1</span>
	 queuedLength<span class="token operator">:</span> <span class="token number">1</span>
	 isFair<span class="token operator">:</span> <span class="token boolean">false</span>
	 isLocked<span class="token operator">:</span> <span class="token boolean">true</span>
	 isHeldByCurrentThread<span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token comment">// ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-650"><a class="markdownIt-Anchor" href="#-650">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#trylock-%E6%96%B9%E6%B3%95">#</a>tryLock 方法</h4>
<p>与无条件获取锁相比，tryLock 有更完善的容错机制。</p>
<ul>
<li><code>tryLock()</code>  - <strong>可轮询获取锁</strong>。如果成功，则返回 true；如果失败，则返回 false。也就是说，这个方法<strong>无论成败都会立即返回</strong>，获取不到锁（锁已被其他线程获取）时不会一直等待。</li>
<li><code>tryLock(long, TimeUnit)</code>  - <strong>可定时获取锁</strong>。和  <code>tryLock()</code>  类似，区别仅在于这个方法在<strong>获取不到锁时会等待一定的时间</strong>，在时间期限之内如果还获取不到锁，就返回 false。如果如果一开始拿到锁或者在等待期间内拿到了锁，则返回 true。</li>
</ul>
<p>示例： <code>ReentrantLock</code>  的  <code>tryLock()</code>  操作</p>
<p>修改上个示例中的  <code>execute()</code>  方法</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
               <span class="token comment">// 略...</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" 获取锁失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>示例： <code>ReentrantLock</code>  的  <code>tryLock(long, TimeUnit)</code>  操作</p>
<p>修改上个示例中的  <code>execute()</code>  方法</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">// 略...</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
                lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" 获取锁失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" 获取锁超时"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-651"><a class="markdownIt-Anchor" href="#-651">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#lockinterruptibly-%E6%96%B9%E6%B3%95">#</a>lockInterruptibly 方法</h4>
<ul>
<li>
<pre><code>
  lockInterruptibly()
  <pre class="line-numbers language-none"><code class="language-none">

​	 

	\-


​	 

	可中断获取锁
	
	。可中断获取锁可以在获得锁的同时保持对中断的响应。可中断获取锁比其它获取锁的方式稍微复杂一些，需要两个


​	 
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
  try-catch
  <pre class="line-numbers language-none"><code class="language-none">

​	 

	块（如果在获取锁的操作中抛出了


​	 
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
  InterruptedException
  <pre class="line-numbers language-none"><code class="language-none">

​	 

	，那么可以使用标准的


​	 
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
  try-finally
  <pre class="line-numbers language-none"><code class="language-none">

​	 

	加锁模式）。
	
	- 举例来说：假设有两个线程同时通过 &#96;lock.lockInterruptibly()&#96; 获取某个锁时，若线程 A 获取到了锁，则线程 B 只能等待。若此时对线程 B 调用 &#96;threadB.interrupt()&#96; 方法能够中断线程 B 的等待过程。由于 &#96;lockInterruptibly()&#96; 的声明中抛出了异常，所以 &#96;lock.lockInterruptibly()&#96; 必须放在 &#96;try&#96; 块中或者在调用 &#96;lockInterruptibly()&#96; 的方法外声明抛出 &#96;InterruptedException&#96;。

&gt; 🔔 注意：当一个线程获取了锁之后，是不会被 &#96;interrupt()&#96; 方法中断的。单独调用 &#96;interrupt()&#96; 方法不能中断正在运行状态中的线程，只能中断阻塞状态中的线程。因此当通过 &#96;lockInterruptibly()&#96; 方法获取某个锁时，如果未获取到锁，只有在等待的状态下，才可以响应中断。

示例：&#96;ReentrantLock&#96; 的 &#96;lockInterruptibly()&#96; 操作

修改上个示例中的 &#96;execute()&#96; 方法

&#96;&#96;&#96;java
public void execute() &#123;
    try &#123;
        lock.lockInterruptibly();

        for (int i &#x3D; 0; i &lt; 3; i++) &#123;
            &#x2F;&#x2F; 略...
        &#125;
    &#125; catch (InterruptedException e) &#123;
        System.out.println(Thread.currentThread().getName() + &quot;被中断&quot;);
        e.printStackTrace();
    &#125; finally &#123;
        lock.unlock();
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

</code></pre>
</li>
</ul>
<h4 id="-652"><a class="markdownIt-Anchor" href="#-652">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#newcondition-%E6%96%B9%E6%B3%95">#</a>newCondition 方法</h4>
<p><code>newCondition()</code>  - 返回一个绑定到  <code>Lock</code>  对象上的  <code>Condition</code>  实例。 <code>Condition</code>  的特性和具体方法请阅读下文 <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#%E4%BA%94condition"> <code>Condition</code> </a>。</p>
<h3 id="-653"><a class="markdownIt-Anchor" href="#-653">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#_3-3-reentrantlock-%E7%9A%84%E5%8E%9F%E7%90%86">#</a>3.3. ReentrantLock 的原理</h3>
<h4 id="-654"><a class="markdownIt-Anchor" href="#-654">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#reentrantlock-%E7%9A%84%E5%8F%AF%E8%A7%81%E6%80%A7">#</a>ReentrantLock 的可见性</h4>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">class X &#123;
  private final Lock rtl =
  new ReentrantLock();
  int value;
  public void addOne() &#123;
    // 获取锁
    rtl.lock();
    try &#123;
      value+=1;
    &#125; finally &#123;
      // 保证锁能释放
      rtl.unlock();
    &#125;
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ReentrantLock，内部持有一个 volatile 的成员变量 state，获取锁的时候，会读写 state 的值；解锁的时候，也会读写 state 的值（简化后的代码如下面所示）。也就是说，在执行 value+=1 之前，程序先读写了一次 volatile 变量 state，在执行 value+=1 之后，又读写了一次 volatile 变量 state。根据相关的 Happens-Before 规则：</p>
<ol>
<li><strong>顺序性规则</strong>：对于线程 T1，value+=1 Happens-Before 释放锁的操作 unlock ()；</li>
<li><strong>volatile 变量规则</strong>：由于 state = 1 会先读取 state，所以线程 T1 的 unlock () 操作 Happens-Before 线程 T2 的 lock () 操作；</li>
<li><strong>传递性规则</strong>：线程 T1 的 value+=1 Happens-Before 线程 T2 的 lock () 操作。</li>
</ol>
<h4 id="-655"><a class="markdownIt-Anchor" href="#-655">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#reentrantlock-%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84">#</a>ReentrantLock 的数据结构</h4>
<p>阅读  <code>ReentrantLock</code>  的源码，可以发现它有一个核心字段：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Sync</span> sync<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li><code>sync</code>  - 内部抽象类  <code>ReentrantLock.Sync</code>  对象， <code>Sync</code>  继承自 AQS。它有两个子类：</li>
<li><code>ReentrantLock.FairSync</code>  - 公平锁。</li>
<li><code>ReentrantLock.NonfairSync</code>  - 非公平锁。</li>
</ul>
<p>查看源码可以发现， <code>ReentrantLock</code>  实现  <code>Lock</code>  接口其实是调用  <code>ReentrantLock.FairSync</code>  或  <code>ReentrantLock.NonfairSync</code>  中各自的实现，这里不一一列举。</p>
<h4 id="-656"><a class="markdownIt-Anchor" href="#-656">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#reentrantlock-%E7%9A%84%E8%8E%B7%E5%8F%96%E9%94%81%E5%92%8C%E9%87%8A%E6%94%BE%E9%94%81">#</a>ReentrantLock 的获取锁和释放锁</h4>
<p>ReentrantLock 获取锁和释放锁的接口，从表象看，是调用  <code>ReentrantLock.FairSync</code>  或  <code>ReentrantLock.NonfairSync</code>  中各自的实现；从本质上看，是基于 AQS 的实现。</p>
<p>仔细阅读源码很容易发现：</p>
<ul>
<li><code>void lock()</code>  调用 Sync 的 lock () 方法。</li>
<li><code>void lockInterruptibly()</code>  直接调用 AQS 的 <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#%E8%8E%B7%E5%8F%96%E5%8F%AF%E4%B8%AD%E6%96%AD%E7%9A%84%E7%8B%AC%E5%8D%A0%E9%94%81">获取可中断的独占锁</a> 方法  <code>lockInterruptibly()</code> 。</li>
<li><code>boolean tryLock()</code>  调用 Sync 的  <code>nonfairTryAcquire()</code>  。</li>
<li><code>boolean tryLock(long time, TimeUnit unit)</code>  直接调用 AQS 的 <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#%E8%8E%B7%E5%8F%96%E8%B6%85%E6%97%B6%E7%AD%89%E5%BE%85%E5%BC%8F%E7%9A%84%E7%8B%AC%E5%8D%A0%E9%94%81">获取超时等待式的独占锁</a> 方法  <code>tryAcquireNanos(int arg, long nanosTimeout)</code> 。</li>
<li><code>void unlock()</code>  直接调用 AQS 的 <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#%E9%87%8A%E6%94%BE%E7%8B%AC%E5%8D%A0%E9%94%81">释放独占锁</a> 方法  <code>release(int arg)</code>  。</li>
</ul>
<p>直接调用 AQS 接口的方法就不再赘述了，其原理在 [AQS 的原理](#AQS 的原理) 中已经用很大篇幅进行过讲解。</p>
<p><code>nonfairTryAcquire</code>  方法源码如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 公平锁和非公平锁都会用这个方法区尝试获取锁</span>
<span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">nonfairTryAcquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> acquires<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">final</span> <span class="token class-name">Thread</span> current <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> acquires<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
         <span class="token comment">// 如果同步状态为0，将其设为 acquires，并设置当前线程为排它线程</span>
            <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">==</span> <span class="token function">getExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> nextc <span class="token operator">=</span> c <span class="token operator">+</span> acquires<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nextc <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// overflow</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"Maximum lock count exceeded"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setState</span><span class="token punctuation">(</span>nextc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>处理流程很简单：</p>
<ul>
<li>如果同步状态为 0，设置同步状态设为 acquires，并设置当前线程为排它线程，然后返回 true，获取锁成功。</li>
<li>如果同步状态不为 0 且当前线程为排它线程，设置同步状态为当前状态值 + acquires 值，然后返回 true，获取锁成功。</li>
<li>否则，返回 false，获取锁失败。</li>
</ul>
<h4 id="-657"><a class="markdownIt-Anchor" href="#-657">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#%E5%85%AC%E5%B9%B3%E9%94%81%E5%92%8C%E9%9D%9E%E5%85%AC%E5%B9%B3%E9%94%81">#</a>公平锁和非公平锁</h4>
<p>ReentrantLock 这个类有两个构造函数，一个是无参构造函数，一个是传入 fair 参数的构造函数。fair 参数代表的是锁的公平策略，如果传入 true 就表示需要构造一个公平锁，反之则表示要构造一个非公平锁。</p>
<p>锁都对应着一个等待队列，如果一个线程没有获得锁，就会进入等待队列，当有线程释放锁的时候，就需要从等待队列中唤醒一个等待的线程。如果是公平锁，唤醒的策略就是谁等待的时间长，就唤醒谁，很公平；如果是非公平锁，则不提供这个公平保证，有可能等待时间短的线程反而先被唤醒。</p>
<p>lock 方法在公平锁和非公平锁中的实现：</p>
<p>二者的区别仅在于申请非公平锁时，如果同步状态为 0，尝试将其设为 1，如果成功，直接将当前线程置为排它线程；否则和公平锁一样，调用 AQS 获取独占锁方法  <code>acquire</code> 。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 非公平锁实现</span>
<span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 如果同步状态为0，将其设为1，并设置当前线程为排它线程</span>
        <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
    <span class="token comment">// 调用 AQS 获取独占锁方法 acquire</span>
        <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 公平锁实现</span>
<span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 调用 AQS 获取独占锁方法 acquire</span>
    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="-658"><a class="markdownIt-Anchor" href="#-658">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#_4-reentrantreadwritelock">#</a>4. ReentrantReadWriteLock</h2>
<p><code>ReadWriteLock</code>  适用于<strong>读多写少的场景</strong>。</p>
<p><code>ReentrantReadWriteLock</code>  类是  <code>ReadWriteLock</code>  接口的具体实现，它是一个可重入的读写锁。 <code>ReentrantReadWriteLock</code>  维护了一对读写锁，将读写锁分开，有利于提高并发效率。</p>
<p>读写锁，并不是 Java 语言特有的，而是一个广为使用的通用技术，所有的读写锁都遵守以下三条基本原则：</p>
<ul>
<li>允许多个线程同时读共享变量；</li>
<li>只允许一个线程写共享变量；</li>
<li>如果一个写线程正在执行写操作，此时禁止读线程读共享变量。</li>
</ul>
<p>读写锁与互斥锁的一个重要区别就是<strong>读写锁允许多个线程同时读共享变量</strong>，而互斥锁是不允许的，这是读写锁在读多写少场景下性能优于互斥锁的关键。但<strong>读写锁的写操作是互斥的</strong>，当一个线程在写共享变量的时候，是不允许其他线程执行写操作和读操作。</p>
<h3 id="-659"><a class="markdownIt-Anchor" href="#-659">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#_4-1-reentrantreadwritelock-%E7%9A%84%E7%89%B9%E6%80%A7">#</a>4.1. ReentrantReadWriteLock 的特性</h3>
<p>ReentrantReadWriteLock 的特性如下：</p>
<ul>
<li><strong> <code>ReentrantReadWriteLock</code>  适用于读多写少的场景</strong>。如果是写多读少的场景，由于  <code>ReentrantReadWriteLock</code>  其内部实现比  <code>ReentrantLock</code>  复杂，性能可能反而要差一些。如果存在这样的问题，需要具体问题具体分析。由于  <code>ReentrantReadWriteLock</code>  的读写锁（ <code>ReadLock</code> 、 <code>WriteLock</code> ）都实现了  <code>Lock</code>  接口，所以要替换为  <code>ReentrantLock</code>  也较为容易。</li>
<li><code>ReentrantReadWriteLock</code>  实现了  <code>ReadWriteLock</code>  接口，支持了  <code>ReentrantLock</code>  所不具备的读写锁分离。 <code>ReentrantReadWriteLock</code>  维护了一对读写锁（ <code>ReadLock</code> 、 <code>WriteLock</code> ）。将读写锁分开，有利于提高并发效率。 <code>ReentrantReadWriteLock</code>  的加锁策略是：<strong>允许多个读操作并发执行，但每次只允许一个写操作</strong>。</li>
<li><code>ReentrantReadWriteLock</code>  为读写锁都提供了可重入的加锁语义。</li>
<li><code>ReentrantReadWriteLock</code>  支持公平锁和非公平锁（默认）两种模式。</li>
</ul>
<p><code>ReadWriteLock</code>  接口定义如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ReadWriteLock</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Lock</span> <span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Lock</span> <span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><code>readLock</code>  - 返回用于读操作的锁（ <code>ReadLock</code> ）。</li>
<li><code>writeLock</code>  - 返回用于写操作的锁（ <code>WriteLock</code> ）。</li>
</ul>
<p>在读写锁和写入锁之间的交互可以采用多种实现方式， <code>ReadWriteLock</code>  的一些可选实现包括：</p>
<ul>
<li><strong>释放优先</strong> - 当一个写入操作释放写锁，并且队列中同时存在读线程和写线程，那么应该优先选择读线程、写线程，还是最先发出请求的线程？</li>
<li><strong>读线程插队</strong> - 如果锁是由读线程持有，但有写线程正在等待，那么新到达的读线程能否立即获得访问权，还是应该在写线程后面等待？如果允许读线程插队到写线程之前，那么将提高并发性，但可能造成线程饥饿问题。</li>
<li><strong>重入性</strong> - 读锁和写锁是否是可重入的？</li>
<li><strong>降级</strong> - 如果一个线程持有写入锁，那么它能否在不释放该锁的情况下获得读锁？这可能会使得写锁被降级为读锁，同时不允许其他写线程修改被保护的资源。</li>
<li><strong>升级</strong> - 读锁能否优先于其他正在等待的读线程和写线程而升级为一个写锁？在大多数的读写锁实现中并不支持升级，因为如果没有显式的升级操作，那么很容易造成死锁。</li>
</ul>
<h3 id="-660"><a class="markdownIt-Anchor" href="#-660">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#_4-2-reentrantreadwritelock-%E7%9A%84%E7%94%A8%E6%B3%95">#</a>4.2. ReentrantReadWriteLock 的用法</h3>
<p>前文了解了  <code>ReentrantReadWriteLock</code>  的特性，接下来，我们要讲述其具体用法。</p>
<h4 id="-661"><a class="markdownIt-Anchor" href="#-661">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#reentrantreadwritelock-%E7%9A%84%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95">#</a>ReentrantReadWriteLock 的构造方法</h4>
<p><code>ReentrantReadWriteLock</code>  和  <code>ReentrantLock</code>  一样，也有两个构造方法，且用法相似。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">ReentrantReadWriteLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token keyword">public</span> <span class="token class-name">ReentrantReadWriteLock</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> fair<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<ul>
<li><code>ReentrantReadWriteLock()</code>  - 默认构造方法会初始化一个<strong>非公平锁（NonfairSync）</strong>。在非公平的锁中，线程获得锁的顺序是不确定的。写线程降级为读线程是可以的，但读线程升级为写线程是不可以的（这样会导致死锁）。</li>
<li><code>ReentrantReadWriteLock(boolean)</code>  -  <code>new ReentrantLock(true)</code>  会初始化一个<strong>公平锁（FairSync）</strong>。对于公平锁，等待时间最长的线程将优先获得锁。如果这个锁是读线程持有，则另一个线程请求写锁，那么其他读线程都不能获得读锁，直到写线程释放写锁。</li>
</ul>
<h4 id="-662"><a class="markdownIt-Anchor" href="#-662">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#reentrantreadwritelock-%E7%9A%84%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B">#</a>ReentrantReadWriteLock 的使用实例</h4>
<p>在 <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#reentrantreadwritelock-%E7%9A%84%E7%89%B9%E6%80%A7"> <code>ReentrantReadWriteLock</code>  的特性</a> 中已经介绍过， <code>ReentrantReadWriteLock</code>  的读写锁（ <code>ReadLock</code> 、 <code>WriteLock</code> ）都实现了  <code>Lock</code>  接口，所以其各自独立的使用方式与  <code>ReentrantLock</code>  一样，这里不再赘述。</p>
<p><code>ReentrantReadWriteLock</code>  与  <code>ReentrantLock</code>  用法上的差异，主要在于读写锁的配合使用。本文以一个典型使用场景来进行讲解。</p>
<p>【示例】基于  <code>ReadWriteLock</code>  实现一个简单的泛型无界缓存</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 简单的无界缓存实现
 * &lt;p>
 * 使用 WeakHashMap 存储键值对。WeakHashMap 中存储的对象是弱引用，JVM GC 时会自动清除没有被引用的弱引用对象。
 */</span>
<span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">UnboundedCache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">></span></span> cacheMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ReadWriteLock</span> cacheLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantReadWriteLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">V</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        cacheLock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">V</span> value<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            value <span class="token operator">=</span> cacheMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> log <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%s 读数据 %s:%s"</span><span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
            cacheLock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">V</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        cacheLock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            cacheMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> log <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%s 写入数据 %s:%s"</span><span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
            cacheLock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">V</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        cacheLock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> cacheMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
            cacheLock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        cacheLock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>cacheMap<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
            cacheLock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>说明：</p>
<ul>
<li>使用  <code>WeakHashMap</code>  而不是  <code>HashMap</code>  来存储键值对。 <code>WeakHashMap</code>  中存储的对象是弱引用，JVM GC 时会自动清除没有被引用的弱引用对象。</li>
<li>向  <code>Map</code>  写数据前加写锁，写完后，释放写锁。</li>
<li>向  <code>Map</code>  读数据前加读锁，读完后，释放读锁。</li>
</ul>
<p>测试其线程安全性：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * @author &lt;a href="mailto:forbreak@163.com">Zhang Peng&lt;/a>
 * @since 2020-01-01
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReentrantReadWriteLockDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">static</span> <span class="token class-name">UnboundedCache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">></span></span> cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UnboundedCache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ExecutorService</span> executorService <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newCachedThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            executorService<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        executorService<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/** 线程任务每次向缓存中写入 3 个随机值，key 固定 */</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyThread</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Random</span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>说明：示例中，通过线程池启动 20 个并发任务。任务每次向缓存中写入 3 个随机值，key 固定；然后主线程每次固定读取缓存中第一个 key 的值。</p>
<p>输出结果：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">main 读数据 0:null
pool-1-thread-1 写入数据 0:16
pool-1-thread-1 写入数据 1:58
pool-1-thread-1 写入数据 2:50
main 读数据 0:16
pool-1-thread-1 写入数据 0:85
pool-1-thread-1 写入数据 1:76
pool-1-thread-1 写入数据 2:46
pool-1-thread-2 写入数据 0:21
pool-1-thread-2 写入数据 1:41
pool-1-thread-2 写入数据 2:63
main 读数据 0:21
main 读数据 0:21
// ...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-663"><a class="markdownIt-Anchor" href="#-663">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#_4-3-reentrantreadwritelock-%E7%9A%84%E5%8E%9F%E7%90%86">#</a>4.3. ReentrantReadWriteLock 的原理</h3>
<p>前面了解了  <code>ReentrantLock</code>  的原理，理解  <code>ReentrantReadWriteLock</code>  就容易多了。</p>
<h4 id="-664"><a class="markdownIt-Anchor" href="#-664">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#reentrantreadwritelock-%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84">#</a>ReentrantReadWriteLock 的数据结构</h4>
<p>阅读 ReentrantReadWriteLock 的源码，可以发现它有三个核心字段：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** Inner class providing readlock */</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ReentrantReadWriteLock<span class="token punctuation">.</span>ReadLock</span> readerLock<span class="token punctuation">;</span>
<span class="token comment">/** Inner class providing writelock */</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ReentrantReadWriteLock<span class="token punctuation">.</span>WriteLock</span> writerLock<span class="token punctuation">;</span>
<span class="token comment">/** Performs all synchronization mechanics */</span>
<span class="token keyword">final</span> <span class="token class-name">Sync</span> sync<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token class-name">ReentrantReadWriteLock<span class="token punctuation">.</span>WriteLock</span> <span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> writerLock<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
<span class="token keyword">public</span> <span class="token class-name">ReentrantReadWriteLock<span class="token punctuation">.</span>ReadLock</span>  <span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> readerLock<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><code>sync</code>  - 内部类  <code>ReentrantReadWriteLock.Sync</code>  对象。与  <code>ReentrantLock</code>  类似，它有两个子类： <code>ReentrantReadWriteLock.FairSync</code>  和  <code>ReentrantReadWriteLock.NonfairSync</code>  ，分别表示公平锁和非公平锁的实现。</li>
<li><code>readerLock</code>  - 内部类  <code>ReentrantReadWriteLock.ReadLock</code>  对象，这是一把读锁。</li>
<li><code>writerLock</code>  - 内部类  <code>ReentrantReadWriteLock.WriteLock</code>  对象，这是一把写锁。</li>
</ul>
<h4 id="-665"><a class="markdownIt-Anchor" href="#-665">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#reentrantreadwritelock-%E7%9A%84%E8%8E%B7%E5%8F%96%E9%94%81%E5%92%8C%E9%87%8A%E6%94%BE%E9%94%81">#</a>ReentrantReadWriteLock 的获取锁和释放锁</h4>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ReadLock</span> <span class="token keyword">implements</span> <span class="token class-name">Lock</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">// 调用 AQS 获取共享锁方法</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        sync<span class="token punctuation">.</span><span class="token function">acquireShared</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 调用 AQS 释放共享锁方法</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        sync<span class="token punctuation">.</span><span class="token function">releaseShared</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">WriteLock</span> <span class="token keyword">implements</span> <span class="token class-name">Lock</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">// 调用 AQS 获取独占锁方法</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        sync<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 调用 AQS 释放独占锁方法</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        sync<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="-666"><a class="markdownIt-Anchor" href="#-666">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#_5-stampedlock">#</a>5. StampedLock</h2>
<p>ReadWriteLock 支持两种模式：一种是读锁，一种是写锁。而 StampedLock 支持三种模式，分别是：<strong>写锁</strong>、<strong>悲观读锁</strong>和<strong>乐观读</strong>。其中，写锁、悲观读锁的语义和 ReadWriteLock 的写锁、读锁的语义非常类似，允许多个线程同时获取悲观读锁，但是只允许一个线程获取写锁，写锁和悲观读锁是互斥的。不同的是：StampedLock 里的写锁和悲观读锁加锁成功之后，都会返回一个 stamp；然后解锁的时候，需要传入这个 stamp。</p>
<blockquote>
<p>注意这里，用的是 “乐观读” 这个词，而不是 “乐观读锁”，是要提醒你，<strong>乐观读这个操作是无锁的</strong>，所以相比较 ReadWriteLock 的读锁，乐观读的性能更好一些。</p>
</blockquote>
<p>StampedLock 的性能之所以比 ReadWriteLock 还要好，其关键是 <strong>StampedLock 支持乐观读</strong>的方式。</p>
<ul>
<li>ReadWriteLock 支持多个线程同时读，但是当多个线程同时读的时候，所有的写操作会被阻塞；</li>
<li>而 StampedLock 提供的乐观读，是允许一个线程获取写锁的，也就是说不是所有的写操作都被阻塞。</li>
</ul>
<p>对于读多写少的场景 StampedLock 性能很好，简单的应用场景基本上可以替代 ReadWriteLock，但是<strong> StampedLock 的功能仅仅是 ReadWriteLock 的子集</strong>，在使用的时候，还是有几个地方需要注意一下。</p>
<ul>
<li><strong>StampedLock 不支持重入</strong></li>
<li>StampedLock 的悲观读锁、写锁都不支持条件变量。</li>
<li>如果线程阻塞在 StampedLock 的 readLock () 或者 writeLock () 上时，此时调用该阻塞线程的 interrupt () 方法，会导致 CPU 飙升。<strong>使用 StampedLock 一定不要调用中断操作，如果需要支持中断功能，一定使用可中断的悲观读锁 readLockInterruptibly () 和写锁 writeLockInterruptibly ()</strong>。</li>
</ul>
<p>【示例】StampedLock 阻塞时，调用 interrupt () 导致 CPU 飙升</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">final</span> <span class="token class-name">StampedLock</span> lock
  <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StampedLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Thread</span> T1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token punctuation">&#123;</span>
  <span class="token comment">// 获取写锁</span>
  lock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 永远阻塞在此处，不释放写锁</span>
  <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">park</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
T1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 保证 T1 获取写锁</span>
<span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Thread</span> T2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>
  <span class="token comment">// 阻塞在悲观读锁</span>
  lock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
T2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 保证 T2 阻塞在读锁</span>
<span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 中断线程 T2</span>
<span class="token comment">// 会导致线程 T2 所在 CPU 飙升</span>
T2<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
T2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>【示例】StampedLock 读模板：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">final</span> <span class="token class-name">StampedLock</span> sl <span class="token operator">=</span>
  <span class="token keyword">new</span> <span class="token class-name">StampedLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 乐观读</span>
<span class="token keyword">long</span> stamp <span class="token operator">=</span>
  sl<span class="token punctuation">.</span><span class="token function">tryOptimisticRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 读入方法局部变量</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment">// 校验 stamp</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sl<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token comment">// 升级为悲观读锁</span>
  stamp <span class="token operator">=</span> sl<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 读入方法局部变量</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 释放悲观读锁</span>
    sl<span class="token punctuation">.</span><span class="token function">unlockRead</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// 使用方法局部变量执行业务操作</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>【示例】StampedLock 写模板：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">long</span> stamp <span class="token operator">=</span> sl<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 写共享变量</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
  sl<span class="token punctuation">.</span><span class="token function">unlockWrite</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="-667"><a class="markdownIt-Anchor" href="#-667">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#_6-aqs">#</a>6. AQS</h2>
<blockquote>
<p><code>AbstractQueuedSynchronizer</code> （简称 <strong>AQS</strong>）是<strong>队列同步器</strong>，顾名思义，其主要作用是处理同步。它是并发锁和很多同步工具类的实现基石（如  <code>ReentrantLock</code> 、 <code>ReentrantReadWriteLock</code> 、 <code>CountDownLatch</code> 、 <code>Semaphore</code> 、 <code>FutureTask</code>  等）。</p>
</blockquote>
<h3 id="-668"><a class="markdownIt-Anchor" href="#-668">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#_6-1-aqs-%E7%9A%84%E8%A6%81%E7%82%B9">#</a>6.1. AQS 的要点</h3>
<p><strong>AQS 提供了对独享锁与共享锁的支持</strong>。</p>
<p>在  <code>java.util.concurrent.locks</code>  包中的相关锁（常用的有  <code>ReentrantLock</code> 、  <code>ReadWriteLock</code> ）都是基于 AQS 来实现。这些锁都没有直接继承 AQS，而是定义了一个  <code>Sync</code>  类去继承 AQS。为什么要这样呢？因为锁面向的是使用用户，而同步器面向的则是线程控制，那么在锁的实现中聚合同步器而不是直接继承 AQS 就可以很好的隔离二者所关注的事情。</p>
<h3 id="-669"><a class="markdownIt-Anchor" href="#-669">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#_6-2-aqs-%E7%9A%84%E5%BA%94%E7%94%A8">#</a>6.2. AQS 的应用</h3>
<p><strong>AQS 提供了对独享锁与共享锁的支持</strong>。</p>
<h4 id="-670"><a class="markdownIt-Anchor" href="#-670">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#%E7%8B%AC%E4%BA%AB%E9%94%81-api">#</a>独享锁 API</h4>
<p>获取、释放独享锁的主要 API 如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">acquireInterruptibly</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">tryAcquireNanos</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">,</span> <span class="token keyword">long</span> nanosTimeout<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">release</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>
<p><code>acquire</code>  - 获取独占锁。</p>
</li>
<li>
<p><code>acquireInterruptibly</code>  - 获取可中断的独占锁。</p>
</li>
<li>
<pre><code>
  tryAcquireNanos
  <pre class="line-numbers language-none"><code class="language-none">

​	 

	\- 尝试在指定时间内获取可中断的独占锁。在以下三种情况下回返回：
	
	- 在超时时间内，当前线程成功获取了锁；
	- 当前线程在超时时间内被中断；
	- 超时时间结束，仍未获得锁返回 false。

- &#96;release&#96; - 释放独占锁。

#### [#](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java锁.html#共享锁-api)共享锁 API

获取、释放共享锁的主要 API 如下：

&#96;&#96;&#96;java
public final void acquireShared(int arg)
public final void acquireSharedInterruptibly(int arg)
public final boolean tryAcquireSharedNanos(int arg, long nanosTimeout)
public final boolean releaseShared(int arg)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

</code></pre>
</li>
<li>
<p><code>acquireShared</code>  - 获取共享锁。</p>
</li>
<li>
<p><code>acquireSharedInterruptibly</code>  - 获取可中断的共享锁。</p>
</li>
<li>
<p><code>tryAcquireSharedNanos</code>  - 尝试在指定时间内获取可中断的共享锁。</p>
</li>
<li>
<p><code>release</code>  - 释放共享锁。</p>
</li>
</ul>
<h3 id="-671"><a class="markdownIt-Anchor" href="#-671">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#_6-3-aqs-%E7%9A%84%E5%8E%9F%E7%90%86">#</a>6.3. AQS 的原理</h3>
<blockquote>
<p>ASQ 原理要点：</p>
<ul>
<li>AQS 使用一个整型的  <code>volatile</code>  变量来 <strong>维护同步状态</strong>。状态的意义由子类赋予。</li>
<li>AQS 维护了一个 FIFO 的双链表，用来存储获取锁失败的线程。</li>
</ul>
<p>AQS 围绕同步状态提供两种基本操作 “获取” 和 “释放”，并提供一系列判断和处理方法，简单说几点：</p>
<ul>
<li>state 是独占的，还是共享的；</li>
<li>state 被获取后，其他线程需要等待；</li>
<li>state 被释放后，唤醒等待线程；</li>
<li>线程等不及时，如何退出等待。</li>
</ul>
<p>至于线程是否可以获得 state，如何释放 state，就不是 AQS 关心的了，要由子类具体实现。</p>
</blockquote>
<h4 id="-672"><a class="markdownIt-Anchor" href="#-672">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E9%94%81.html#aqs-%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84">#</a>AQS 的数据结构</h4>
<p>阅读 AQS 的源码，可以发现：AQS 继承自  <code>AbstractOwnableSynchronize</code> 。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractQueuedSynchronizer</span>
    <span class="token keyword">extends</span> <span class="token class-name">AbstractOwnableSynchronizer</span>
    <span class="token keyword">implements</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">/** 等待队列的队头，懒加载。只能通过 setHead 方法修改。 */</span>
    <span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token keyword">volatile</span> <span class="token class-name">Node</span> head<span class="token punctuation">;</span>
    <span class="token comment">/** 等待队列的队尾，懒加载。只能通过 enq 方法添加新的等待节点。*/</span>
    <span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token keyword">volatile</span> <span class="token class-name">Node</span> tail<span class="token punctuation">;</span>
    <span class="token comment">/** 同步状态 */</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> state<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>
<pre><code>
  state
  <pre class="line-numbers language-none"><code class="language-none">

​	 

	\- AQS 使用一个整型的


​	 
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
  volatile
  <pre class="line-numbers language-none"><code class="language-none">

​	 

	变量来


​	 

	维护同步状态
	
	。
	
	- 这个整数状态的意义由子类来赋予，如&#96;ReentrantLock&#96; 中该状态值表示所有者线程已经重复获取该锁的次数，&#96;Semaphore&#96; 中该状态值表示剩余的许可数量。

- &#96;head&#96; 和 &#96;tail&#96; - AQS **维护了一个 &#96;Node&#96; 类型（AQS 的内部类）的双链表来完成同步状态的管理**。这个双链表是一个双向的 FIFO 队列，通过 &#96;head&#96; 和 &#96;tail&#96; 指针进行访问。当 **有线程获取锁失败后，就被添加到队列末尾**。

![img](https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;HarryQu1229&#x2F;image-host&#x2F;main&#x2F;notes-img&#x2F;aqs_1.png)

再来看一下 &#96;Node&#96; 的源码

&#96;&#96;&#96;java
static final class Node &#123;
    &#x2F;** 该等待同步的节点处于共享模式 *&#x2F;
    static final Node SHARED &#x3D; new Node();
    &#x2F;** 该等待同步的节点处于独占模式 *&#x2F;
    static final Node EXCLUSIVE &#x3D; null;

    &#x2F;** 线程等待状态，状态值有: 0、1、-1、-2、-3 *&#x2F;
    volatile int waitStatus;
    static final int CANCELLED &#x3D;  1;
    static final int SIGNAL    &#x3D; -1;
    static final int CONDITION &#x3D; -2;
    static final int PROPAGATE &#x3D; -3;

    &#x2F;** 前驱节点 *&#x2F;
    volatile Node prev;
    &#x2F;** 后继节点 *&#x2F;
    volatile Node next;
    &#x2F;** 等待锁的线程 *&#x2F;
    volatile Thread thread;

  	&#x2F;** 和节点是否共享有关 *&#x2F;
    Node nextWaiter;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

</code></pre>
</li>
</ul>
<p>很显然，Node 是一个双链表结构。</p>
<ul>
<li>
<pre><code>
  waitStatus
  <pre class="line-numbers language-none"><code class="language-none">

​	 

	\-


​	 
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
  Node
  <pre class="line-numbers language-none"><code class="language-none">

​	 

	使用一个整型的


​	 
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
  volatile
  <pre class="line-numbers language-none"><code class="language-none">

​	 

	变量来 维护 AQS 同步队列中线程节点的状态。
	<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
  waitStatus
  <pre class="line-numbers language-none"><code class="language-none">

​	 

	有五个状态值：
	
	- &#96;CANCELLED(1)&#96; - 此状态表示：该节点的线程可能由于超时或被中断而 **处于被取消(作废)状态**，一旦处于这个状态，表示这个节点应该从等待队列中移除。
	- &#96;SIGNAL(-1)&#96; - 此状态表示：**后继节点会被挂起**，因此在当前节点释放锁或被取消之后，必须唤醒(&#96;unparking&#96;)其后继结点。
	- &#96;CONDITION(-2)&#96; - 此状态表示：该节点的线程 **处于等待条件状态**，不会被当作是同步队列上的节点，直到被唤醒(&#96;signal&#96;)，设置其值为 0，再重新进入阻塞状态。
	- &#96;PROPAGATE(-3)&#96; - 此状态表示：下一个 &#96;acquireShared&#96; 应无条件传播。
	- 0 - 非以上状态。

#### [#](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java锁.html#独占锁的获取和释放)独占锁的获取和释放

##### [#](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java锁.html#获取独占锁)获取独占锁

AQS 中使用 &#96;acquire(int arg)&#96; 方法获取独占锁，其大致流程如下：

1. 先尝试获取同步状态，如果获取同步状态成功，则结束方法，直接返回。
2. 如果获取同步状态不成功，AQS 会不断尝试利用 CAS 操作将当前线程插入等待同步队列的队尾，直到成功为止。
3. 接着，不断尝试为等待队列中的线程节点获取独占锁。

![img](https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;dunwu&#x2F;images&#x2F;dev&#x2F;cs&#x2F;java&#x2F;javacore&#x2F;concurrent&#x2F;aqs_2.png)

![img](https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;HarryQu1229&#x2F;image-host&#x2F;main&#x2F;notes-img&#x2F;aqs_3.png)

详细流程可以用下图来表示，请结合源码来理解（一图胜千言）：

![img](https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;HarryQu1229&#x2F;image-host&#x2F;main&#x2F;notes-img&#x2F;aqs_4.png)

##### [#](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java锁.html#释放独占锁)释放独占锁

AQS 中使用 &#96;release(int arg)&#96; 方法释放独占锁，其大致流程如下：

1. 先尝试获取解锁线程的同步状态，如果获取同步状态不成功，则结束方法，直接返回。
2. 如果获取同步状态成功，AQS 会尝试唤醒当前线程节点的后继节点。

##### [#](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java锁.html#获取可中断的独占锁)获取可中断的独占锁

AQS 中使用 &#96;acquireInterruptibly(int arg)&#96; 方法获取可中断的独占锁。

&#96;acquireInterruptibly(int arg)&#96; 实现方式**相较于获取独占锁方法（ &#96;acquire&#96;）非常相似**，区别仅在于它会**通过 &#96;Thread.interrupted&#96; 检测当前线程是否被中断**，如果是，则立即抛出中断异常（&#96;InterruptedException&#96;）。

##### [#](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java锁.html#获取超时等待式的独占锁)获取超时等待式的独占锁

AQS 中使用 &#96;tryAcquireNanos(int arg)&#96; 方法获取超时等待的独占锁。

doAcquireNanos 的实现方式 **相较于获取独占锁方法（ &#96;acquire&#96;）非常相似**，区别在于它会根据超时时间和当前时间计算出截止时间。在获取锁的流程中，会不断判断是否超时，如果超时，直接返回 false；如果没超时，则用 &#96;LockSupport.parkNanos&#96; 来阻塞当前线程。

#### [#](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java锁.html#共享锁的获取和释放)共享锁的获取和释放

##### [#](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java锁.html#获取共享锁)获取共享锁

AQS 中使用 &#96;acquireShared(int arg)&#96; 方法获取共享锁。

&#96;acquireShared&#96; 方法和 &#96;acquire&#96; 方法的逻辑很相似，区别仅在于自旋的条件以及节点出队的操作有所不同。

成功获得共享锁的条件如下：

- &#96;tryAcquireShared(arg)&#96; 返回值大于等于 0 （这意味着共享锁的 permit 还没有用完）。
- 当前节点的前驱节点是头结点。

##### [#](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java锁.html#释放共享锁)释放共享锁

AQS 中使用 &#96;releaseShared(int arg)&#96; 方法释放共享锁。

&#96;releaseShared&#96; 首先会尝试释放同步状态，如果成功，则解锁一个或多个后继线程节点。释放共享锁和释放独享锁流程大体相似，区别在于：

对于独享模式，如果需要 SIGNAL，释放仅相当于调用头节点的 &#96;unparkSuccessor&#96;。

##### [#](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java锁.html#获取可中断的共享锁)获取可中断的共享锁

AQS 中使用 &#96;acquireSharedInterruptibly(int arg)&#96; 方法获取可中断的共享锁。

&#96;acquireSharedInterruptibly&#96; 方法与 &#96;acquireInterruptibly&#96; 几乎一致，不再赘述。

##### [#](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java锁.html#获取超时等待式的共享锁)获取超时等待式的共享锁

AQS 中使用 &#96;tryAcquireSharedNanos(int arg)&#96; 方法获取超时等待式的共享锁。

&#96;tryAcquireSharedNanos&#96; 方法与 &#96;tryAcquireNanos&#96; 几乎一致，不再赘述。

## [#](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java锁.html#_7-死锁)7. 死锁

### [#](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java锁.html#_7-1-什么是死锁)7.1. 什么是死锁

死锁是一种特定的程序状态，在实体之间，由于循环依赖导致彼此一直处于等待之中，没有任何个体可以继续前进。死锁不仅仅是在线程之间会发生，存在资源独占的进程之间同样也 可能出现死锁。通常来说，我们大多是聚焦在多线程场景中的死锁，指两个或多个线程之间，由于互相持有对方需要的锁，而永久处于阻塞的状态。

### [#](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java锁.html#_7-2-如何定位死锁)7.2. 如何定位死锁

定位死锁最常见的方式就是利用 jstack 等工具获取线程栈，然后定位互相之间的依赖关系，进而找到死锁。如果是比较明显的死锁，往往 jstack 等就能直接定位，类似 JConsole 甚至可以在图形界面进行有限的死锁检测。

如果我们是开发自己的管理工具，需要用更加程序化的方式扫描服务进程、定位死锁，可以考虑使用 Java 提供的标准管理 API，&#96;ThreadMXBean&#96;，其直接就提供了 &#96;findDeadlockedThreads()&#96; 方法用于定位。

### [#](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java锁.html#_7-3-如何避免死锁)7.3. 如何避免死锁

基本上死锁的发生是因为：

- 互斥，类似 Java 中 Monitor 都是独占的。
- 长期保持互斥，在使用结束之前，不会释放，也不能被其他线程抢占。
- 循环依赖，多个个体之间出现了锁的循环依赖，彼此依赖上一环释放锁。

由此，我们可以分析出避免死锁的思路和方法。

（1）避免一个线程同时获取多个锁。

避免一个线程在锁内同时占用多个资源，尽量保证每个锁只占用一个资源。

尝试使用定时锁 &#96;lock.tryLock(timeout)&#96;，避免锁一直不能释放。

对于数据库锁，加锁和解锁必须在一个数据库连接中里，否则会出现解锁失败的情况



---

# Java 原子变量类

&gt; **📦 本文以及示例源码已归档在 [javacore(opens new window)](https:&#x2F;&#x2F;github.com&#x2F;dunwu&#x2F;javacore&#x2F;)**

- \1. 原子变量类简介
	- [1.1. 为何需要原子变量类](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java原子类.html#11-为何需要原子变量类)
	- [1.2. 原子变量类的作用](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java原子类.html#12-原子变量类的作用)
- \2. 基本类型
	- [2.1. **&#96;AtomicInteger&#96; 用法**](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java原子类.html#21-atomicinteger-用法)
	- [2.2. **&#96;AtomicInteger&#96; 实现**](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java原子类.html#22-atomicinteger-实现)
- [3. 引用类型](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java原子类.html#3-引用类型)
- [4. 数组类型](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java原子类.html#4-数组类型)
- [5. 属性更新器类型](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java原子类.html#5-属性更新器类型)
- [6. 原子化的累加器](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java原子类.html#6-原子化的累加器)
- [7. 参考资料](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java原子类.html#7-参考资料)

## [#](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java原子类.html#_1-原子变量类简介)1. 原子变量类简介

### [#](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java原子类.html#_1-1-为何需要原子变量类)1.1. 为何需要原子变量类

保证线程安全是 Java 并发编程必须要解决的重要问题。Java 从原子性、可见性、有序性这三大特性入手，确保多线程的数据一致性。

- 确保线程安全最常见的做法是利用锁机制（&#96;Lock&#96;、&#96;sychronized&#96;）来对共享数据做互斥同步，这样在同一个时刻，只有一个线程可以执行某个方法或者某个代码块，那么操作必然是原子性的，线程安全的。互斥同步最主要的问题是线程阻塞和唤醒所带来的性能问题。
- &#96;volatile&#96; 是轻量级的锁（自然比普通锁性能要好），它保证了共享变量在多线程中的可见性，但无法保证原子性。所以，它只能在一些特定场景下使用。
- 为了兼顾原子性以及锁带来的性能问题，Java 引入了 CAS （主要体现在 &#96;Unsafe&#96; 类）来实现非阻塞同步（也叫乐观锁）。并基于 CAS ，提供了一套原子工具类。

### [#](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java原子类.html#_1-2-原子变量类的作用)1.2. 原子变量类的作用

原子变量类 **比锁的粒度更细，更轻量级**，并且对于在多处理器系统上实现高性能的并发代码来说是非常关键的。原子变量将发生竞争的范围缩小到单个变量上。

原子变量类相当于一种泛化的 &#96;volatile&#96; 变量，能够**支持原子的、有条件的读&#x2F;改&#x2F;写操**作。

原子类在内部使用 CAS 指令（基于硬件的支持）来实现同步。这些指令通常比锁更快。

原子变量类可以分为 4 组：

- 基本类型
	- &#96;AtomicBoolean&#96; - 布尔类型原子类
	- &#96;AtomicInteger&#96; - 整型原子类
	- &#96;AtomicLong&#96; - 长整型原子类
- 引用类型
	- &#96;AtomicReference&#96; - 引用类型原子类
	- &#96;AtomicMarkableReference&#96; - 带有标记位的引用类型原子类
	- &#96;AtomicStampedReference&#96; - 带有版本号的引用类型原子类
- 数组类型
	- &#96;AtomicIntegerArray&#96; - 整形数组原子类
	- &#96;AtomicLongArray&#96; - 长整型数组原子类
	- &#96;AtomicReferenceArray&#96; - 引用类型数组原子类
- 属性更新器类型
	- &#96;AtomicIntegerFieldUpdater&#96; - 整型字段的原子更新器。
	- &#96;AtomicLongFieldUpdater&#96; - 长整型字段的原子更新器。
	- &#96;AtomicReferenceFieldUpdater&#96; - 原子更新引用类型里的字段。

&gt; 这里不对 CAS、volatile、互斥同步做深入探讨。如果想了解更多细节，不妨参考：[Java 并发核心机制(opens new window)](https:&#x2F;&#x2F;github.com&#x2F;dunwu&#x2F;javacore&#x2F;blob&#x2F;master&#x2F;docs&#x2F;concurrent&#x2F;Java并发核心机制.md)

## [#](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java原子类.html#_2-基本类型)2. 基本类型

这一类型的原子类是针对 Java 基本类型进行操作。

- &#96;AtomicBoolean&#96; - 布尔类型原子类
- &#96;AtomicInteger&#96; - 整型原子类
- &#96;AtomicLong&#96; - 长整型原子类

以上类都支持 CAS（[compare-and-swap (opens new window)](https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Compare-and-swap)）技术，此外，&#96;AtomicInteger&#96;、&#96;AtomicLong&#96; 还支持算术运算。

&gt; 💡 提示：
&gt;
&gt; 虽然 Java 只提供了 &#96;AtomicBoolean&#96; 、&#96;AtomicInteger&#96;、&#96;AtomicLong&#96;，但是可以模拟其他基本类型的原子变量。要想模拟其他基本类型的原子变量，可以将 &#96;short&#96; 或 &#96;byte&#96; 等类型与 &#96;int&#96; 类型进行转换，以及使用 &#96;Float.floatToIntBits&#96; 、&#96;Double.doubleToLongBits&#96; 来转换浮点数。
&gt;
&gt; 由于 &#96;AtomicBoolean&#96;、&#96;AtomicInteger&#96;、&#96;AtomicLong&#96; 实现方式、使用方式都相近，所以本文仅针对 &#96;AtomicInteger&#96; 进行介绍。

### [#](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java原子类.html#_2-1-atomicinteger-用法)2.1. **&#96;AtomicInteger&#96; 用法**

&#96;&#96;&#96;java
public final int get() &#x2F;&#x2F; 获取当前值
public final int getAndSet(int newValue) &#x2F;&#x2F; 获取当前值，并设置新值
public final int getAndIncrement()&#x2F;&#x2F; 获取当前值，并自增
public final int getAndDecrement() &#x2F;&#x2F; 获取当前值，并自减
public final int getAndAdd(int delta) &#x2F;&#x2F; 获取当前值，并加上预期值
boolean compareAndSet(int expect, int update) &#x2F;&#x2F; 如果输入值（update）等于预期值，将该值设置为输入值
public final void lazySet(int newValue) &#x2F;&#x2F; 最终设置为 newValue，使用 lazySet 设置之后可能导致其他线程在之后的一小段时间内还是可以读到旧的值。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

</code></pre>
</li>
</ul>
<p><code>AtomicInteger</code>  使用示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AtomicIntegerDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ExecutorService</span> executorService <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">AtomicInteger</span> count <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            executorService<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" count="</span> <span class="token operator">+</span> count<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                count<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        executorService<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        executorService<span class="token punctuation">.</span><span class="token function">awaitTermination</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Final Count is : "</span> <span class="token operator">+</span> count<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-673"><a class="markdownIt-Anchor" href="#-673">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%8E%9F%E5%AD%90%E7%B1%BB.html#_2-2-atomicinteger-%E5%AE%9E%E7%8E%B0">#</a>2.2. <strong> <code>AtomicInteger</code>  实现</strong></h3>
<p>阅读  <code>AtomicInteger</code>  源码，可以看到如下定义：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Unsafe</span> unsafe <span class="token operator">=</span> <span class="token class-name">Unsafe</span><span class="token punctuation">.</span><span class="token function">getUnsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> valueOffset<span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
		valueOffset <span class="token operator">=</span> unsafe<span class="token punctuation">.</span>objectFieldOffset
			<span class="token punctuation">(</span><span class="token class-name">AtomicInteger</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"value"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> value<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>说明：</p>
<ul>
<li><code>value</code>  - value 属性使用  <code>volatile</code>  修饰，使得对 value 的修改在并发环境下对所有线程可见。</li>
<li><code>valueOffset</code>  - value 属性的偏移量，通过这个偏移量可以快速定位到 value 字段，这个是实现 AtomicInteger 的关键。</li>
<li><code>unsafe</code>  - Unsafe 类型的属性，它为  <code>AtomicInteger</code>  提供了 CAS 操作。</li>
</ul>
</blockquote>
<h2 id="-674"><a class="markdownIt-Anchor" href="#-674">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%8E%9F%E5%AD%90%E7%B1%BB.html#_3-%E5%BC%95%E7%94%A8%E7%B1%BB%E5%9E%8B">#</a>3. 引用类型</h2>
<p>Java 数据类型分为 <strong>基本数据类型</strong> 和 <strong>引用数据类型</strong> 两大类（不了解 Java 数据类型划分可以参考： <a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/blob/master/docs/basics/java-data-type.md">Java 基本数据类型 (opens new window)</a>）。</p>
<p>上一节中提到了针对基本数据类型的原子类，那么如果想针对引用类型做原子操作怎么办？Java 也提供了相关的原子类：</p>
<ul>
<li><code>AtomicReference</code>  - 引用类型原子类</li>
<li><code>AtomicMarkableReference</code>  - 带有标记位的引用类型原子类</li>
<li><code>AtomicStampedReference</code>  - 带有版本号的引用类型原子类</li>
</ul>
<blockquote>
<p><code>AtomicStampedReference</code>  类在引用类型原子类中，彻底地解决了 ABA 问题，其它的 CAS 能力与另外两个类相近，所以最具代表性。因此，本节只针对  <code>AtomicStampedReference</code>  进行说明。</p>
</blockquote>
<p>示例：基于  <code>AtomicReference</code>  实现一个简单的自旋锁</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AtomicReferenceDemo2</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> ticket <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">threadSafeDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">threadSafeDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">SpinLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpinLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ExecutorService</span> executorService <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            executorService<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span>lock<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        executorService<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * 基于 &#123;@link AtomicReference&#125; 实现的简单自旋锁
     */</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">SpinLock</span> <span class="token punctuation">&#123;</span>

        <span class="token keyword">private</span> <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Thread</span><span class="token punctuation">></span></span> atomicReference <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Thread</span> current <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>atomicReference<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> current<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Thread</span> current <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            atomicReference<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * 利用自旋锁 &#123;@link SpinLock&#125; 并发处理数据
     */</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyThread</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span>

        <span class="token keyword">private</span> <span class="token class-name">SpinLock</span> lock<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span><span class="token class-name">SpinLock</span> lock<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>lock <span class="token operator">=</span> lock<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>ticket <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ticket <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" 卖出了第 "</span> <span class="token operator">+</span> ticket <span class="token operator">+</span> <span class="token string">" 张票"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    ticket<span class="token operator">--</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>原子类的实现基于 CAS 机制，而 CAS 存在 ABA 问题（不了解 ABA 问题，可以参考：<a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/blob/master/docs/concurrent/Java%E5%B9%B6%E5%8F%91%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6.md#cas-%E7%9A%84%E9%97%AE%E9%A2%98">Java 并发基础机制 - CAS 的问题 (opens new window)</a>）。正是为了解决 ABA 问题，才有了  <code>AtomicMarkableReference</code>  和  <code>AtomicStampedReference</code> 。</p>
<p><code>AtomicMarkableReference</code>  使用一个布尔值作为标记，修改时在 true /false 之间切换。这种策略不能根本上解决 ABA 问题，但是可以降低 ABA 发生的几率。常用于缓存或者状态描述这样的场景。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AtomicMarkableReferenceDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> INIT_TEXT <span class="token operator">=</span> <span class="token string">"abc"</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>

        <span class="token keyword">final</span> <span class="token class-name">AtomicMarkableReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> amr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicMarkableReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>INIT_TEXT<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">ExecutorService</span> executorService <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            executorService<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>

                    <span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>amr<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>INIT_TEXT<span class="token punctuation">,</span> name<span class="token punctuation">,</span> amr<span class="token punctuation">.</span><span class="token function">isMarked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">!</span>amr<span class="token punctuation">.</span><span class="token function">isMarked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" 修改了对象！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"新的对象为："</span> <span class="token operator">+</span> amr<span class="token punctuation">.</span><span class="token function">getReference</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        executorService<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        executorService<span class="token punctuation">.</span><span class="token function">awaitTermination</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong> <code>AtomicStampedReference</code>  使用一个整型值做为版本号，每次更新前先比较版本号，如果一致，才进行修改</strong>。通过这种策略，可以根本上解决 ABA 问题。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AtomicStampedReferenceDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> INIT_REF <span class="token operator">=</span> <span class="token string">"pool-1-thread-3"</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">AtomicStampedReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> asr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicStampedReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>INIT_REF<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"初始对象为："</span> <span class="token operator">+</span> asr<span class="token punctuation">.</span><span class="token function">getReference</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">ExecutorService</span> executorService <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            executorService<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        executorService<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        executorService<span class="token punctuation">.</span><span class="token function">awaitTermination</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyThread</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token keyword">final</span> <span class="token keyword">int</span> stamp <span class="token operator">=</span> asr<span class="token punctuation">.</span><span class="token function">getStamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>asr<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>INIT_REF<span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stamp<span class="token punctuation">,</span> stamp <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" 修改了对象！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"新的对象为："</span> <span class="token operator">+</span> asr<span class="token punctuation">.</span><span class="token function">getReference</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="-675"><a class="markdownIt-Anchor" href="#-675">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%8E%9F%E5%AD%90%E7%B1%BB.html#_4-%E6%95%B0%E7%BB%84%E7%B1%BB%E5%9E%8B">#</a>4. 数组类型</h2>
<p>Java 提供了以下针对数组的原子类：</p>
<ul>
<li><code>AtomicIntegerArray</code>  - 整形数组原子类</li>
<li><code>AtomicLongArray</code>  - 长整型数组原子类</li>
<li><code>AtomicReferenceArray</code>  - 引用类型数组原子类</li>
</ul>
<p>已经有了针对基本类型和引用类型的原子类，为什么还要提供针对数组的原子类呢？</p>
<p>数组类型的原子类为 <strong>数组元素</strong> 提供了  <code>volatile</code>  类型的访问语义，这是普通数组所不具备的特性 ——<strong> <code>volatile</code>  类型的数组仅在数组引用上具有  <code>volatile</code>  语义</strong>。</p>
<p>示例： <code>AtomicIntegerArray</code>  使用示例（ <code>AtomicLongArray</code>  、 <code>AtomicReferenceArray</code>  使用方式也类似）</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AtomicIntegerArrayDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">AtomicIntegerArray</span> atomicIntegerArray <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicIntegerArray</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arguments<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Init Values: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> atomicIntegerArray<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            atomicIntegerArray<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>atomicIntegerArray<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Compare</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        t1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Final Values: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> atomicIntegerArray<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>atomicIntegerArray<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Increment</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> atomicIntegerArray<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">int</span> value <span class="token operator">=</span> atomicIntegerArray<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", index = "</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">", value = "</span> <span class="token operator">+</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

    <span class="token punctuation">&#125;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Compare</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> atomicIntegerArray<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">boolean</span> swapped <span class="token operator">=</span> atomicIntegerArray<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>swapped<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" swapped, index = "</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">", value = 3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="-676"><a class="markdownIt-Anchor" href="#-676">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%8E%9F%E5%AD%90%E7%B1%BB.html#_5-%E5%B1%9E%E6%80%A7%E6%9B%B4%E6%96%B0%E5%99%A8%E7%B1%BB%E5%9E%8B">#</a>5. 属性更新器类型</h2>
<p>更新器类支持基于反射机制的更新字段值的原子操作。</p>
<ul>
<li><code>AtomicIntegerFieldUpdater</code>  - 整型字段的原子更新器。</li>
<li><code>AtomicLongFieldUpdater</code>  - 长整型字段的原子更新器。</li>
<li><code>AtomicReferenceFieldUpdater</code>  - 原子更新引用类型里的字段。</li>
</ul>
<p>这些类的使用有一定限制：</p>
<ul>
<li>因为对象的属性修改类型原子类都是抽象类，所以每次使用都必须使用静态方法  <code>newUpdater()</code>  创建一个更新器，并且需要设置想要更新的类和属性。</li>
<li>字段必须是  <code>volatile</code>  类型的；</li>
<li>不能作用于静态变量（ <code>static</code> ）；</li>
<li>不能作用于常量（ <code>final</code> ）；</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AtomicReferenceFieldUpdaterDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">static</span> <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">"begin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token class-name">AtomicReferenceFieldUpdater</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> updater <span class="token operator">=</span>
        <span class="token class-name">AtomicReferenceFieldUpdater</span><span class="token punctuation">.</span><span class="token function">newUpdater</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ExecutorService</span> executorService <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            executorService<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        executorService<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyThread</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>updater<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token string">"begin"</span><span class="token punctuation">,</span> <span class="token string">"end"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                    <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" 已修改 name = "</span> <span class="token operator">+</span> user<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" 已被其他线程修改"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

    <span class="token punctuation">&#125;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">&#123;</span>

        <span class="token keyword">volatile</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> name<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token class-name">User</span> <span class="token function">setName</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="-677"><a class="markdownIt-Anchor" href="#-677">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%8E%9F%E5%AD%90%E7%B1%BB.html#_6-%E5%8E%9F%E5%AD%90%E5%8C%96%E7%9A%84%E7%B4%AF%E5%8A%A0%E5%99%A8">#</a>6. 原子化的累加器</h2>
<p><code>DoubleAccumulator</code> 、 <code>DoubleAdder</code> 、 <code>LongAccumulator</code>  和  <code>LongAdder</code> ，这四个类仅仅用来执行累加操作，相比原子化的基本数据类型，速度更快，但是不支持  <code>compareAndSet()</code>  方法。如果你仅仅需要累加操作，使用原子化的累加器性能会更好，代价就是会消耗更多的内存空间。</p>
<p><code>LongAdder</code>  内部由一个  <code>base</code>  变量和一个  <code>cell[]</code>  数组组成。</p>
<ul>
<li>当只有一个写线程，没有竞争的情况下， <code>LongAdder</code>  会直接使用  <code>base</code>  变量作为原子操作变量，通过 CAS 操作修改变量；</li>
<li>当有多个写线程竞争的情况下，除了占用  <code>base</code>  变量的一个写线程之外，其它各个线程会将修改的变量写入到自己的槽  <code>cell[]</code>  数组中。</li>
</ul>
<p>我们可以发现， <code>LongAdder</code>  在操作后的返回值只是一个近似准确的数值，但是  <code>LongAdder</code>  最终返回的是一个准确的数值， 所以在一些对实时性要求比较高的场景下， <code>LongAdder</code>  并不能取代  <code>AtomicInteger</code>  或  <code>AtomicLong</code> 。</p>
<hr>
<h1 id="java-并发和容器"><a class="markdownIt-Anchor" href="#java-并发和容器">#</a> Java 并发和容器</h1>
<blockquote>
<p><strong>📦 本文以及示例源码已归档在 <a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/">javacore(opens new window)</a></strong></p>
</blockquote>
<ul>
<li>\1. 同步容器
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%92%8C%E5%AE%B9%E5%99%A8.html#11-%E5%90%8C%E6%AD%A5%E5%AE%B9%E5%99%A8%E7%AE%80%E4%BB%8B">1.1. 同步容器简介</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%92%8C%E5%AE%B9%E5%99%A8.html#12-%E5%90%8C%E6%AD%A5%E5%AE%B9%E5%99%A8%E7%9A%84%E9%97%AE%E9%A2%98">1.2. 同步容器的问题</a></li>
</ul>
</li>
<li>\2. 并发容器简介
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%92%8C%E5%AE%B9%E5%99%A8.html#21-%E5%B9%B6%E5%8F%91%E5%9C%BA%E6%99%AF%E4%B8%8B%E7%9A%84-map">2.1. 并发场景下的 Map</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%92%8C%E5%AE%B9%E5%99%A8.html#22-%E5%B9%B6%E5%8F%91%E5%9C%BA%E6%99%AF%E4%B8%8B%E7%9A%84-list">2.2. 并发场景下的 List</a></li>
</ul>
</li>
<li>\3. Map
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%92%8C%E5%AE%B9%E5%99%A8.html#31-concurrenthashmap">3.1. ConcurrentHashMap</a></li>
</ul>
</li>
<li>\4. List
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%92%8C%E5%AE%B9%E5%99%A8.html#41-copyonwritearraylist">4.1. CopyOnWriteArrayList</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%92%8C%E5%AE%B9%E5%99%A8.html#5-set">5. Set</a></li>
<li>\6. Queue
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%92%8C%E5%AE%B9%E5%99%A8.html#61-blockingqueue">6.1. BlockingQueue</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%92%8C%E5%AE%B9%E5%99%A8.html#62-priorityblockingqueue-%E7%B1%BB">6.2. PriorityBlockingQueue 类</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%92%8C%E5%AE%B9%E5%99%A8.html#63-arrayblockingqueue-%E7%B1%BB">6.3. ArrayBlockingQueue 类</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%92%8C%E5%AE%B9%E5%99%A8.html#64-linkedblockingqueue-%E7%B1%BB">6.4. LinkedBlockingQueue 类</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%92%8C%E5%AE%B9%E5%99%A8.html#65-synchronousqueue-%E7%B1%BB">6.5. SynchronousQueue 类</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%92%8C%E5%AE%B9%E5%99%A8.html#66-concurrentlinkeddeque-%E7%B1%BB">6.6. ConcurrentLinkedDeque 类</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%92%8C%E5%AE%B9%E5%99%A8.html#67-queue-%E7%9A%84%E5%B9%B6%E5%8F%91%E5%BA%94%E7%94%A8">6.7. Queue 的并发应用</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%92%8C%E5%AE%B9%E5%99%A8.html#7-%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">7. 参考资料</a></li>
</ul>
<h2 id="-678"><a class="markdownIt-Anchor" href="#-678">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%92%8C%E5%AE%B9%E5%99%A8.html#_1-%E5%90%8C%E6%AD%A5%E5%AE%B9%E5%99%A8">#</a>1. 同步容器</h2>
<h3 id="-679"><a class="markdownIt-Anchor" href="#-679">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%92%8C%E5%AE%B9%E5%99%A8.html#_1-1-%E5%90%8C%E6%AD%A5%E5%AE%B9%E5%99%A8%E7%AE%80%E4%BB%8B">#</a>1.1. 同步容器简介</h3>
<p>在 Java 中，同步容器主要包括 2 类：</p>
<ul>
<li>
<pre><code>
  Vector
  <pre class="line-numbers language-none"><code class="language-none">
、
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
  Stack
  <pre class="line-numbers language-none"><code class="language-none">
、
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
  Hashtable
  <pre class="line-numbers language-none"><code class="language-none">	
	- &#96;Vector&#96; - &#96;Vector&#96; 实现了 &#96;List&#96; 接口。&#96;Vector&#96; 实际上就是一个数组，和 &#96;ArrayList&#96; 类似。但是 &#96;Vector&#96; 中的方法都是 &#96;synchronized&#96; 方法，即进行了同步措施。
	- &#96;Stack&#96; - &#96;Stack&#96; 也是一个同步容器，它的方法也用 &#96;synchronized&#96; 进行了同步，它实际上是继承于 &#96;Vector&#96; 类。
	- &#96;Hashtable&#96;- &#96;Hashtable&#96; 实现了 &#96;Map&#96; 接口，它和 &#96;HashMap&#96; 很相似，但是 &#96;Hashtable&#96; 进行了同步处理，而 &#96;HashMap&#96; 没有。

- &#96;Collections&#96; 类中提供的静态工厂方法创建的类（由 &#96;Collections.synchronizedXXX&#96; 等方法）

### [#](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java并发和容器.html#_1-2-同步容器的问题)1.2. 同步容器的问题

同步容器的同步原理就是在其 &#96;get&#96;、&#96;set&#96;、&#96;size&#96; 等主要方法上用 &#96;synchronized&#96; 修饰。 **&#96;synchronized&#96; 可以保证在同一个时刻，只有一个线程可以执行某个方法或者某个代码块**。

&gt; 想详细了解 &#96;synchronized&#96; 用法和原理可以参考：[Java 并发核心机制(opens new window)](https:&#x2F;&#x2F;github.com&#x2F;dunwu&#x2F;javacore&#x2F;blob&#x2F;master&#x2F;docs&#x2F;concurrent&#x2F;Java并发核心机制.md)

#### [#](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java并发和容器.html#性能问题)性能问题

&#96;synchronized&#96; 的互斥同步会产生阻塞和唤醒线程的开销。显然，这种方式比没有使用 &#96;synchronized&#96; 的容器性能要差很多。

&gt; 注：尤其是在 Java 1.6 没有对 &#96;synchronized&#96; 进行优化前，阻塞开销很高。

#### [#](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java并发和容器.html#安全问题)安全问题

同步容器真的绝对安全吗？

其实也未必。在做复合操作（非原子操作）时，仍然需要加锁来保护。常见复合操作如下：

- **迭代**：反复访问元素，直到遍历完全部元素；
- **跳转**：根据指定顺序寻找当前元素的下一个（下 n 个）元素；
- **条件运算**：例如若没有则添加等；

❌ 不安全的示例

&#96;&#96;&#96;java
public class VectorDemo &#123;

    static Vector&lt;Integer&gt; vector &#x3D; new Vector&lt;&gt;();

    public static void main(String[] args) &#123;
        while (true) &#123;
            vector.clear();

            for (int i &#x3D; 0; i &lt; 10; i++) &#123;
                vector.add(i);
            &#125;

            Thread thread1 &#x3D; new Thread() &#123;
                @Override
                public void run() &#123;
                    for (int i &#x3D; 0; i &lt; vector.size(); i++) &#123;
                        vector.remove(i);
                    &#125;
                &#125;
            &#125;;

            Thread thread2 &#x3D; new Thread() &#123;
                @Override
                public void run() &#123;
                    for (int i &#x3D; 0; i &lt; vector.size(); i++) &#123;
                        vector.get(i);
                    &#125;
                &#125;
            &#125;;

            thread1.start();
            thread2.start();

            while (Thread.activeCount() &gt; 10) &#123;
                System.out.println(&quot;同时存在 10 个以上线程，退出&quot;);
                return;
            &#125;
        &#125;
    &#125;

&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

</code></pre>
</li>
</ul>
<p>以上程序执行时可能会出现数组越界错误。</p>
<p><code>Vector</code>  是线程安全的，那为什么还会报这个错？</p>
<p>这是因为，对于 Vector，虽然能保证每一个时刻只能有一个线程访问它，但是不排除这种可能：</p>
<p>当某个线程在某个时刻执行这句时：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>vector<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
    vector<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>假若此时 vector 的 size 方法返回的是 10，i 的值为 9</p>
<p>然后另外一个线程执行了这句：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>vector<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
    vector<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>将下标为 9 的元素删除了。</p>
<p>那么通过 get 方法访问下标为 9 的元素肯定就会出问题了。</p>
<p>✔ 安全示例</p>
<p>因此为了保证线程安全，必须在方法调用端做额外的同步措施，如下面所示：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">VectorDemo2</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">static</span> <span class="token class-name">Vector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> vector <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                vector<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token class-name">Thread</span> thread1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">VectorDemo2</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token comment">//进行额外的同步</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> vector<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                            vector<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

            <span class="token class-name">Thread</span> thread2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">VectorDemo2</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> vector<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                            vector<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

            thread1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            thread2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">activeCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"同时存在 10 个以上线程，退出"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>ConcurrentModificationException</code>  异常</p>
<p>在对  <code>Vector</code>  等容器并发地进行迭代修改时，会报  <code>ConcurrentModificationException</code>  异常，关于这个异常将会在后续文章中讲述。</p>
<p>但是在并发容器中不会出现这个问题。</p>
<h2 id="-680"><a class="markdownIt-Anchor" href="#-680">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%92%8C%E5%AE%B9%E5%99%A8.html#_2-%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8%E7%AE%80%E4%BB%8B">#</a>2. 并发容器简介</h2>
<p>同步容器将所有对容器状态的访问都串行化，以保证线程安全性，这种策略会严重降低并发性。</p>
<p>Java 1.5 后提供了多种并发容器，<strong>使用并发容器来替代同步容器，可以极大地提高伸缩性并降低风险</strong>。</p>
<p>J.U.C 包中提供了几个非常有用的并发容器作为线程安全的容器：</p>
<table>
<thead>
<tr>
<th>并发容器</th>
<th>对应的普通容器</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ConcurrentHashMap</code></td>
<td><code>HashMap</code></td>
<td>Java 1.8 之前采用分段锁机制细化锁粒度，降低阻塞，从而提高并发性；Java 1.8 之后基于 CAS 实现。</td>
</tr>
<tr>
<td><code>ConcurrentSkipListMap</code></td>
<td><code>SortedMap</code></td>
<td>基于跳表实现的</td>
</tr>
<tr>
<td><code>CopyOnWriteArrayList</code></td>
<td><code>ArrayList</code></td>
<td></td>
</tr>
<tr>
<td><code>CopyOnWriteArraySet</code></td>
<td><code>Set</code></td>
<td>基于  <code>CopyOnWriteArrayList</code>  实现。</td>
</tr>
<tr>
<td><code>ConcurrentSkipListSet</code></td>
<td><code>SortedSet</code></td>
<td>基于  <code>ConcurrentSkipListMap</code>  实现。</td>
</tr>
<tr>
<td><code>ConcurrentLinkedQueue</code></td>
<td><code>Queue</code></td>
<td>线程安全的无界队列。底层采用单链表。支持 FIFO。</td>
</tr>
<tr>
<td><code>ConcurrentLinkedDeque</code></td>
<td><code>Deque</code></td>
<td>线程安全的无界双端队列。底层采用双向链表。支持 FIFO 和 FILO。</td>
</tr>
<tr>
<td><code>ArrayBlockingQueue</code></td>
<td><code>Queue</code></td>
<td>数组实现的阻塞队列。</td>
</tr>
<tr>
<td><code>LinkedBlockingQueue</code></td>
<td><code>Queue</code></td>
<td>链表实现的阻塞队列。</td>
</tr>
<tr>
<td><code>LinkedBlockingDeque</code></td>
<td><code>Deque</code></td>
<td>双向链表实现的双端阻塞队列。</td>
</tr>
</tbody>
</table>
<p>J.U.C 包中提供的并发容器命名一般分为三类：</p>
<ul>
<li>
<pre><code>
  Concurrent
  <pre class="line-numbers language-none"><code class="language-none">	
	- 这类型的锁竞争相对于 &#96;CopyOnWrite&#96; 要高一些，但写操作代价要小一些。
	- 此外，&#96;Concurrent&#96; 往往提供了较低的遍历一致性，即：当利用迭代器遍历时，如果容器发生修改，迭代器仍然可以继续进行遍历。代价就是，在获取容器大小 &#96;size()&#96; ，容器是否为空等方法，不一定完全精确，但这是为了获取并发吞吐量的设计取舍，可以理解。与之相比，如果是使用同步容器，就会出现 &#96;fail-fast&#96; 问题，即：检测到容器在遍历过程中发生了修改，则抛出 &#96;ConcurrentModificationException&#96;，不再继续遍历。

- &#96;CopyOnWrite&#96; - 一个线程写，多个线程读。读操作时不加锁，写操作时通过在副本上加锁保证并发安全，空间开销较大。

- &#96;Blocking&#96; - 内部实现一般是基于锁，提供阻塞队列的能力。

❌ 错误示例，产生 &#96;ConcurrentModificationException&#96; 异常：

&#96;&#96;&#96;java
public void removeKeys(Map&lt;String, Object&gt; map, final String... keys) &#123;
    map.keySet().removeIf(key -&gt; ArrayUtil.contains(keys, key));
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

</code></pre>
</li>
</ul>
<p>❌ 错误示例，产生  <code>ConcurrentModificationException</code>  异常：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token function">removeKeys</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> map<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> keys<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">K</span> key <span class="token operator">:</span> keys<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		map<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> map<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-681"><a class="markdownIt-Anchor" href="#-681">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%92%8C%E5%AE%B9%E5%99%A8.html#_2-1-%E5%B9%B6%E5%8F%91%E5%9C%BA%E6%99%AF%E4%B8%8B%E7%9A%84-map">#</a>2.1. 并发场景下的 Map</h3>
<p>如果对数据有强一致要求，则需使用  <code>Hashtable</code> ；在大部分场景通常都是弱一致性的情况下，使用  <code>ConcurrentHashMap</code>  即可；如果数据量在千万级别，且存在大量增删改操作，则可以考虑使用  <code>ConcurrentSkipListMap</code> 。</p>
<h3 id="-682"><a class="markdownIt-Anchor" href="#-682">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%92%8C%E5%AE%B9%E5%99%A8.html#_2-2-%E5%B9%B6%E5%8F%91%E5%9C%BA%E6%99%AF%E4%B8%8B%E7%9A%84-list">#</a>2.2. 并发场景下的 List</h3>
<p>读多写少用  <code>CopyOnWriteArrayList</code> 。</p>
<p>写多读少用  <code>ConcurrentLinkedQueue</code>  ，但由于是无界的，要有容量限制，避免无限膨胀，导致内存溢出。</p>
<h2 id="-683"><a class="markdownIt-Anchor" href="#-683">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%92%8C%E5%AE%B9%E5%99%A8.html#_3-map">#</a>3. Map</h2>
<p>Map 接口的两个实现是 ConcurrentHashMap 和 ConcurrentSkipListMap，它们从应用的角度来看，主要区别在于<strong> ConcurrentHashMap 的 key 是无序的，而 ConcurrentSkipListMap 的 key 是有序的</strong>。所以如果你需要保证 key 的顺序，就只能使用 ConcurrentSkipListMap。</p>
<p>使用 ConcurrentHashMap 和 ConcurrentSkipListMap 需要注意的地方是，它们的 key 和 value 都不能为空，否则会抛出 <code>NullPointerException</code>  这个运行时异常。</p>
<h3 id="-684"><a class="markdownIt-Anchor" href="#-684">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%92%8C%E5%AE%B9%E5%99%A8.html#_3-1-concurrenthashmap">#</a>3.1. ConcurrentHashMap</h3>
<p><code>ConcurrentHashMap</code>  是线程安全的  <code>HashMap</code>  ，用于替代  <code>Hashtable</code> 。</p>
<h4 id="-685"><a class="markdownIt-Anchor" href="#-685">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%92%8C%E5%AE%B9%E5%99%A8.html#concurrenthashmap-%E7%9A%84%E7%89%B9%E6%80%A7">#</a> <code>ConcurrentHashMap</code>  的特性</h4>
<p><code>ConcurrentHashMap</code>   <code>实现了</code>   <code>ConcurrentMap</code>  接口，而  <code>ConcurrentMap</code>  接口扩展了  <code>Map</code>  接口。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span>
    <span class="token keyword">implements</span> <span class="token class-name">ConcurrentMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">,</span> <span class="token class-name">Serializable</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>ConcurrentHashMap</code>  的实现包含了  <code>HashMap</code>  所有的基本特性，如：数据结构、读写策略等。</p>
<p><code>ConcurrentHashMap</code>  没有实现对  <code>Map</code>  加锁以提供独占访问。因此无法通过在客户端加锁的方式来创建新的原子操作。但是，一些常见的复合操作，如：“若没有则添加”、“若相等则移除”、“若相等则替换”，都已经实现为原子操作，并且是围绕  <code>ConcurrentMap</code>  的扩展接口而实现。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ConcurrentMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>

    <span class="token comment">// 仅当 K 没有相应的映射值才插入</span>
    <span class="token class-name">V</span> <span class="token function">putIfAbsent</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 仅当 K 被映射到 V 时才移除</span>
    <span class="token keyword">boolean</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 仅当 K 被映射到 oldValue 时才替换为 newValue</span>
    <span class="token keyword">boolean</span> <span class="token function">replace</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> oldValue<span class="token punctuation">,</span> <span class="token class-name">V</span> newValue<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 仅当 K 被映射到某个值时才替换为 newValue</span>
    <span class="token class-name">V</span> <span class="token function">replace</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>不同于  <code>Hashtable</code> ， <code>ConcurrentHashMap</code>  提供的迭代器不会抛出  <code>ConcurrentModificationException</code> ，因此不需要在迭代过程中对容器加锁。</p>
<blockquote>
<p>🔔 注意：一些需要对整个  <code>Map</code>  进行计算的方法，如  <code>size</code>  和  <code>isEmpty</code>  ，由于返回的结果在计算时可能已经过期，所以<strong>并非实时的精确值</strong>。这是一种策略上的权衡，在并发环境下，这类方法由于总在不断变化，所以获取其实时精确值的意义不大。 <code>ConcurrentHashMap</code>  弱化这类方法，以换取更重要操作（如： <code>get</code> 、 <code>put</code> 、 <code>containesKey</code> 、 <code>remove</code>  等）的性能。</p>
</blockquote>
<h4 id="-686"><a class="markdownIt-Anchor" href="#-686">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%92%8C%E5%AE%B9%E5%99%A8.html#concurrenthashmap-%E7%9A%84%E7%94%A8%E6%B3%95">#</a>ConcurrentHashMap 的用法</h4>
<p>示例：不会出现  <code>ConcurrentModificationException</code></p>
<p><code>ConcurrentHashMap</code>  的基本操作与  <code>HashMap</code>  的用法基本一样。不同于  <code>HashMap</code> 、 <code>Hashtable</code> ， <code>ConcurrentHashMap</code>  提供的迭代器不会抛出  <code>ConcurrentModificationException</code> ，因此不需要在迭代过程中对容器加锁。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcurrentHashMapDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>

        <span class="token comment">// HashMap 在并发迭代访问时会抛出 ConcurrentModificationException 异常</span>
        <span class="token comment">// Map&lt;Integer, Character> map = new HashMap&lt;>();</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Character</span><span class="token punctuation">></span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Thread</span> wthread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"写操作线程开始执行"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">26</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token string">'a'</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> rthread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"读操作线程开始执行"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span> key <span class="token operator">:</span> map<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>key <span class="token operator">+</span> <span class="token string">" - "</span> <span class="token operator">+</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        wthread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rthread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-687"><a class="markdownIt-Anchor" href="#-687">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%92%8C%E5%AE%B9%E5%99%A8.html#concurrenthashmap-%E7%9A%84%E5%8E%9F%E7%90%86">#</a>ConcurrentHashMap 的原理</h4>
<blockquote>
<p><code>ConcurrentHashMap</code>  一直在演进，尤其在 Java 1.7 和 Java 1.8，其数据结构和并发机制有很大的差异。</p>
</blockquote>
<ul>
<li>Java 1.7
<ul>
<li>数据结构：<strong>数组＋单链表</strong></li>
<li>并发机制：采用分段锁机制细化锁粒度，降低阻塞，从而提高并发性。</li>
</ul>
</li>
<li>Java 1.8
<ul>
<li>数据结构：<strong>数组＋单链表＋红黑树</strong></li>
<li>并发机制：取消分段锁，之后基于 CAS + synchronized 实现。</li>
</ul>
</li>
</ul>
<h5 id="-688"><a class="markdownIt-Anchor" href="#-688">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%92%8C%E5%AE%B9%E5%99%A8.html#java-1-7-%E7%9A%84%E5%AE%9E%E7%8E%B0">#</a>Java 1.7 的实现</h5>
<p>分段锁，是将内部进行分段（Segment），里面是  <code>HashEntry</code>  数组，和  <code>HashMap</code>  类似，哈希相同的条目也是以链表形式存放。  <code>HashEntry</code>  内部使用  <code>volatile</code>  的  <code>value</code>  字段来保证可见性，也利用了不可变对象的机制，以改进利用  <code>Unsafe</code>  提供的底层能力，比如 volatile access，去直接完成部分操作，以最优化性能，毕竟  <code>Unsafe</code>  中的很多操作都是 JVM intrinsic 优化过的。</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/20200605214405.png" alt="img"></p>
<p>在进行并发写操作时， <code>ConcurrentHashMap</code>  会获取可重入锁（ <code>ReentrantLock</code> ），以保证数据一致性。所以，在并发修改期间，相应  <code>Segment</code>  是被锁定的。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">></span></span>
        <span class="token keyword">implements</span> <span class="token class-name">ConcurrentMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">,</span> <span class="token class-name">Serializable</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">// 将整个hashmap分成几个小的map，每个segment都是一个锁；与hashtable相比，这么设计的目的是对于put, remove等操作，可以减少并发冲突，对</span>
    <span class="token comment">// 不属于同一个片段的节点可以并发操作，大大提高了性能</span>
    <span class="token keyword">final</span> <span class="token class-name">Segment</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> segments<span class="token punctuation">;</span>

    <span class="token comment">// 本质上Segment类就是一个小的hashmap，里面table数组存储了各个节点的数据，继承了ReentrantLock, 可以作为互拆锁使用</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Segment</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">ReentrantLock</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">transient</span> <span class="token keyword">volatile</span> <span class="token class-name">HashEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> table<span class="token punctuation">;</span>
        <span class="token keyword">transient</span> <span class="token keyword">int</span> count<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 基本节点，存储Key， Value值</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">HashEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> hash<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">K</span> key<span class="token punctuation">;</span>
        <span class="token keyword">volatile</span> <span class="token class-name">V</span> value<span class="token punctuation">;</span>
        <span class="token keyword">volatile</span> <span class="token class-name">HashEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> next<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="-689"><a class="markdownIt-Anchor" href="#-689">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%92%8C%E5%AE%B9%E5%99%A8.html#java-1-8-%E7%9A%84%E5%AE%9E%E7%8E%B0">#</a>Java 1.8 的实现</h5>
<ul>
<li>数据结构改进：与 HashMap 一样，将原先 <strong>数组＋单链表</strong> 的数据结构，变更为 <strong>数组＋单链表＋红黑树</strong> 的结构。当出现哈希冲突时，数据会存入数组指定桶的单链表，当链表长度达到 8，则将其转换为红黑树结构，这样其查询的时间复杂度可以降低到 $$O (logN)$$，以改进性能。</li>
<li>并发机制改进：
<ul>
<li>取消 segments 字段，<strong>直接采用  <code>transient volatile HashEntry&lt;K,V&gt;[] table</code>  保存数据，采用 table 数组元素作为锁，从而实现了对每一行数据进行加锁，进一步减少并发冲突的概率</strong>。</li>
<li>使用 CAS +  <code>sychronized</code>  操作，在特定场景进行无锁并发操作。使用 Unsafe、LongAdder 之类底层手段，进行极端情况的优化。现代 JDK 中，synchronized 已经被不断优化，可以不再过分担心性能差异，另外，相比于 ReentrantLock，它可以减少内存消耗，这是个非常大的优势。</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">final</span> <span class="token class-name">V</span> <span class="token function">putVal</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">,</span> <span class="token keyword">boolean</span> onlyIfAbsent<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> value <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> hash <span class="token operator">=</span> <span class="token function">spread</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> binCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab <span class="token operator">=</span> table<span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> f<span class="token punctuation">;</span> <span class="token keyword">int</span> n<span class="token punctuation">,</span> i<span class="token punctuation">,</span> fh<span class="token punctuation">;</span>
        <span class="token comment">// 如果table为空，初始化；否则，根据hash值计算得到数组索引i，如果tab[i]为空，直接新建节点Node即可。注：tab[i]实质为链表或者红黑树的首节点。</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tab <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            tab <span class="token operator">=</span> <span class="token function">initTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>f <span class="token operator">=</span> <span class="token function">tabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> i <span class="token operator">=</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> hash<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">casTabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
                         <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>                   <span class="token comment">// no lock when adding to empty bin</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// 如果tab[i]不为空并且hash值为MOVED，说明该链表正在进行transfer操作，返回扩容完成后的table。</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fh <span class="token operator">=</span> f<span class="token punctuation">.</span>hash<span class="token punctuation">)</span> <span class="token operator">==</span> MOVED<span class="token punctuation">)</span>
            tab <span class="token operator">=</span> <span class="token function">helpTransfer</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">V</span> oldVal <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token comment">// 针对首个节点进行加锁操作，而不是segment，进一步减少线程冲突</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token operator">==</span> f<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>fh <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        binCount <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> e <span class="token operator">=</span> f<span class="token punctuation">;</span><span class="token punctuation">;</span> <span class="token operator">++</span>binCount<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                            <span class="token class-name">K</span> ek<span class="token punctuation">;</span>
                            <span class="token comment">// 如果在链表中找到值为key的节点e，直接设置e.val = value即可。</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>hash <span class="token operator">==</span> hash <span class="token operator">&amp;&amp;</span>
                                <span class="token punctuation">(</span><span class="token punctuation">(</span>ek <span class="token operator">=</span> e<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token operator">||</span>
                                 <span class="token punctuation">(</span>ek <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>ek<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                oldVal <span class="token operator">=</span> e<span class="token punctuation">.</span>val<span class="token punctuation">;</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>onlyIfAbsent<span class="token punctuation">)</span>
                                    e<span class="token punctuation">.</span>val <span class="token operator">=</span> value<span class="token punctuation">;</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>
                            <span class="token punctuation">&#125;</span>
                            <span class="token comment">// 如果没有找到值为key的节点，直接新建Node并加入链表即可。</span>
                            <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> pred <span class="token operator">=</span> e<span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                pred<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span>
                                                          value<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>
                            <span class="token punctuation">&#125;</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span>
                    <span class="token comment">// 如果首节点为TreeBin类型，说明为红黑树结构，执行putTreeVal操作。</span>
                    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>f <span class="token keyword">instanceof</span> <span class="token class-name">TreeBin</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> p<span class="token punctuation">;</span>
                        binCount <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">TreeBin</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">)</span>f<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putTreeVal</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span>
                                                       value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                            oldVal <span class="token operator">=</span> p<span class="token punctuation">.</span>val<span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>onlyIfAbsent<span class="token punctuation">)</span>
                                p<span class="token punctuation">.</span>val <span class="token operator">=</span> value<span class="token punctuation">;</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>binCount <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// 如果节点数>＝8，那么转换链表结构为红黑树结构。</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>binCount <span class="token operator">>=</span> TREEIFY_THRESHOLD<span class="token punctuation">)</span>
                    <span class="token function">treeifyBin</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVal <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span> oldVal<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// 计数增加1，有可能触发transfer操作(扩容)。</span>
    <span class="token function">addCount</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> binCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-690"><a class="markdownIt-Anchor" href="#-690">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%92%8C%E5%AE%B9%E5%99%A8.html#concurrenthashmap-%E7%9A%84%E5%AE%9E%E6%88%98">#</a>ConcurrentHashMap 的实战</h4>
<blockquote>
<p>示例摘自：<a target="_blank" rel="noopener" href="https://time.geekbang.org/column/intro/100047701">《Java 业务开发常见错误 100 例》(opens new window)</a></p>
</blockquote>
<h5 id="-691"><a class="markdownIt-Anchor" href="#-691">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%92%8C%E5%AE%B9%E5%99%A8.html#concurrenthashmap-%E9%94%99%E8%AF%AF%E7%A4%BA%E4%BE%8B">#</a>ConcurrentHashMap 错误示例</h5>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//线程个数</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> THREAD_COUNT <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token comment">//总元素数量</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> ITEM_COUNT <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">></span></span> concurrentHashMap <span class="token operator">=</span> <span class="token function">getData</span><span class="token punctuation">(</span>ITEM_COUNT <span class="token operator">-</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//初始900个元素</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"init size:"</span> <span class="token operator">+</span> concurrentHashMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ForkJoinPool</span> forkJoinPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">(</span>THREAD_COUNT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//使用线程池并发处理逻辑</span>
    forkJoinPool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>i <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//查询还需要补充多少个元素</span>
        <span class="token keyword">int</span> gap <span class="token operator">=</span> ITEM_COUNT <span class="token operator">-</span> concurrentHashMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"gap size:"</span> <span class="token operator">+</span> gap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//补充元素</span>
        concurrentHashMap<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span><span class="token function">getData</span><span class="token punctuation">(</span>gap<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//等待所有任务完成</span>
    forkJoinPool<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    forkJoinPool<span class="token punctuation">.</span><span class="token function">awaitTermination</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>HOURS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//最后元素个数会是1000吗？</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"finish size:"</span> <span class="token operator">+</span> concurrentHashMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">></span></span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token class-name">LongStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">boxed</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>
            <span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toConcurrentMap</span><span class="token punctuation">(</span>
                i <span class="token operator">-></span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                i <span class="token operator">-></span> i<span class="token punctuation">,</span>
                <span class="token punctuation">(</span>o1<span class="token punctuation">,</span> o2<span class="token punctuation">)</span> <span class="token operator">-></span> o1<span class="token punctuation">,</span>
                <span class="token class-name">ConcurrentHashMap</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>初始大小 900 符合预期，还需要填充 100 个元素。</p>
<p>预期结果为 1000 个元素，实际大于 1000 个元素。</p>
<p>【分析】</p>
<p>ConcurrentHashMap 对外提供的方法或能力的限制：</p>
<ul>
<li>使用了 ConcurrentHashMap，不代表对它的多个操作之间的状态是一致的，是没有其他线程在操作它的，如果需要确保需要手动加锁。</li>
<li>诸如 size、isEmpty 和 containsValue 等聚合方法，在并发情况下可能会反映 ConcurrentHashMap 的中间状态。因此在并发情况下，这些方法的返回值只能用作参考，而不能用于流程控制。显然，利用 size 方法计算差异值，是一个流程控制。</li>
<li>诸如 putAll 这样的聚合方法也不能确保原子性，在 putAll 的过程中去获取数据可能会获取到部分数据。</li>
</ul>
<h5 id="-692"><a class="markdownIt-Anchor" href="#-692">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%92%8C%E5%AE%B9%E5%99%A8.html#concurrenthashmap-%E9%94%99%E8%AF%AF%E7%A4%BA%E4%BE%8B%E4%BF%AE%E6%AD%A3-1-0-%E7%89%88">#</a>ConcurrentHashMap 错误示例修正 1.0 版</h5>
<p>通过 synchronized 加锁，当然可以保证数据一致性，但是牺牲了 ConcurrentHashMap 的性能，没哟真正发挥出 ConcurrentHashMap 的特性。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//线程个数</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> THREAD_COUNT <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token comment">//总元素数量</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> ITEM_COUNT <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">></span></span> concurrentHashMap <span class="token operator">=</span> <span class="token function">getData</span><span class="token punctuation">(</span>ITEM_COUNT <span class="token operator">-</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//初始900个元素</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"init size:"</span> <span class="token operator">+</span> concurrentHashMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ForkJoinPool</span> forkJoinPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">(</span>THREAD_COUNT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//使用线程池并发处理逻辑</span>
    forkJoinPool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>i <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//查询还需要补充多少个元素</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>concurrentHashMap<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">int</span> gap <span class="token operator">=</span> ITEM_COUNT <span class="token operator">-</span> concurrentHashMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"gap size:"</span> <span class="token operator">+</span> gap<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//补充元素</span>
            concurrentHashMap<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span><span class="token function">getData</span><span class="token punctuation">(</span>gap<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//等待所有任务完成</span>
    forkJoinPool<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    forkJoinPool<span class="token punctuation">.</span><span class="token function">awaitTermination</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>HOURS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//最后元素个数会是1000吗？</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"finish size:"</span> <span class="token operator">+</span> concurrentHashMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">></span></span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token class-name">LongStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">boxed</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>
            <span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toConcurrentMap</span><span class="token punctuation">(</span>
                i <span class="token operator">-></span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                i <span class="token operator">-></span> i<span class="token punctuation">,</span>
                <span class="token punctuation">(</span>o1<span class="token punctuation">,</span> o2<span class="token punctuation">)</span> <span class="token operator">-></span> o1<span class="token punctuation">,</span>
                <span class="token class-name">ConcurrentHashMap</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="-693"><a class="markdownIt-Anchor" href="#-693">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%92%8C%E5%AE%B9%E5%99%A8.html#concurrenthashmap-%E9%94%99%E8%AF%AF%E7%A4%BA%E4%BE%8B%E4%BF%AE%E6%AD%A3-2-0-%E7%89%88">#</a>ConcurrentHashMap 错误示例修正 2.0 版</h5>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//循环次数</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> LOOP_COUNT <span class="token operator">=</span> <span class="token number">10000000</span><span class="token punctuation">;</span>
<span class="token comment">//线程个数</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> THREAD_COUNT <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token comment">//总元素数量</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> ITEM_COUNT <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">StopWatch</span> stopWatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StopWatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    stopWatch<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">"normaluse"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">></span></span> normaluse <span class="token operator">=</span> <span class="token function">normaluse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    stopWatch<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>normaluse<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> ITEM_COUNT<span class="token punctuation">,</span> <span class="token string">"normaluse size error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>normaluse<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">mapToLong</span><span class="token punctuation">(</span>aLong <span class="token operator">-></span> aLong<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token operator">::</span><span class="token function">sum</span><span class="token punctuation">)</span> <span class="token operator">==</span> LOOP_COUNT
        <span class="token punctuation">,</span> <span class="token string">"normaluse count error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    stopWatch<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">"gooduse"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">></span></span> gooduse <span class="token operator">=</span> <span class="token function">gooduse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    stopWatch<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>gooduse<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> ITEM_COUNT<span class="token punctuation">,</span> <span class="token string">"gooduse size error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>gooduse<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">mapToLong</span><span class="token punctuation">(</span>l <span class="token operator">-></span> l<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token operator">::</span><span class="token function">sum</span><span class="token punctuation">)</span> <span class="token operator">==</span> LOOP_COUNT
        <span class="token punctuation">,</span> <span class="token string">"gooduse count error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>stopWatch<span class="token punctuation">.</span><span class="token function">prettyPrint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">></span></span> <span class="token function">normaluse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">></span></span> freqs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>ITEM_COUNT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ForkJoinPool</span> forkJoinPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">(</span>THREAD_COUNT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    forkJoinPool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> LOOP_COUNT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>i <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token string">"item"</span> <span class="token operator">+</span> <span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>ITEM_COUNT<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>freqs<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>freqs<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    freqs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> freqs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                    freqs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    forkJoinPool<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    forkJoinPool<span class="token punctuation">.</span><span class="token function">awaitTermination</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>HOURS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> freqs<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">></span></span> <span class="token function">gooduse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">LongAdder</span><span class="token punctuation">></span></span> freqs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>ITEM_COUNT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ForkJoinPool</span> forkJoinPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">(</span>THREAD_COUNT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    forkJoinPool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> LOOP_COUNT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>i <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token string">"item"</span> <span class="token operator">+</span> <span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>ITEM_COUNT<span class="token punctuation">)</span><span class="token punctuation">;</span>
            freqs<span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> k <span class="token operator">-></span> <span class="token keyword">new</span> <span class="token class-name">LongAdder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    forkJoinPool<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    forkJoinPool<span class="token punctuation">.</span><span class="token function">awaitTermination</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>HOURS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> freqs<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toMap</span><span class="token punctuation">(</span>
            e <span class="token operator">-></span> e<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            e <span class="token operator">-></span> e<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">longValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="-694"><a class="markdownIt-Anchor" href="#-694">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%92%8C%E5%AE%B9%E5%99%A8.html#_4-list">#</a>4. List</h2>
<h3 id="-695"><a class="markdownIt-Anchor" href="#-695">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%92%8C%E5%AE%B9%E5%99%A8.html#_4-1-copyonwritearraylist">#</a>4.1. CopyOnWriteArrayList</h3>
<p><code>CopyOnWriteArrayList</code>  是线程安全的  <code>ArrayList</code> 。 <code>CopyOnWrite</code>  字面意思为<strong>写的时候会将共享变量新复制一份</strong>出来。复制的好处在于<strong>读操作是无锁的</strong>（也就是无阻塞）。</p>
<p>CopyOnWriteArrayList <strong>仅适用于写操作非常少的场景</strong>，而且能够容忍读写的短暂不一致。如果读写比例均衡或者有大量写操作的话，使用 CopyOnWriteArrayList 的性能会非常糟糕。</p>
<h4 id="-696"><a class="markdownIt-Anchor" href="#-696">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%92%8C%E5%AE%B9%E5%99%A8.html#copyonwritearraylist-%E5%8E%9F%E7%90%86">#</a>CopyOnWriteArrayList 原理</h4>
<p>CopyOnWriteArrayList 内部维护了一个数组，成员变量 array 就指向这个内部数组，所有的读操作都是基于 array 进行的，如下图所示，迭代器 Iterator 遍历的就是 array 数组。</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/20200702204541.png" alt="img"></p>
<ul>
<li>lock - 执行写时复制操作，需要使用可重入锁加锁</li>
<li>array - 对象数组，用于存放元素</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** The lock protecting all mutators */</span>
<span class="token keyword">final</span> <span class="token keyword">transient</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/** The array, accessed only via getArray/setArray. */</span>
<span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token keyword">volatile</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/CopyOnWriteArrayList.png" alt="img"></p>
<p>（1）读操作</p>
<p>在  <code>CopyOnWriteAarrayList</code>  中，读操作不同步，因为它们在内部数组的快照上工作，所以多个迭代器可以同时遍历而不会相互阻塞（图 1,2,4）。</p>
<p>CopyOnWriteArrayList 的读操作是不用加锁的，性能很高。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">E</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">int</span> index<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token function">getArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">private</span> <span class="token class-name">E</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> index<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">E</span><span class="token punctuation">)</span> a<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>（2）写操作</p>
<p>所有的写操作都是同步的。他们在备份数组（图 3）的副本上工作。写操作完成后，后备阵列将被替换为复制的阵列，并释放锁定。支持数组变得易变，所以替换数组的调用是原子（图 5）。</p>
<p>写操作后创建的迭代器将能够看到修改的结构（图 6,7）。</p>
<p>写时复制集合返回的迭代器不会抛出  <code>ConcurrentModificationException</code> ，因为它们在数组的快照上工作，并且无论后续的修改（2,4）如何，都会像迭代器创建时那样完全返回元素。</p>
<p><strong>添加操作</strong> - 添加的逻辑很简单，先将原容器 copy 一份，然后在新副本上执行写操作，之后再切换引用。当然此过程是要加锁的。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//ReentrantLock加锁，保证线程安全</span>
    <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">;</span>
    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> elements <span class="token operator">=</span> <span class="token function">getArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> len <span class="token operator">=</span> elements<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
        <span class="token comment">//拷贝原容器，长度为原容器长度加一</span>
        <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> newElements <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">copyOf</span><span class="token punctuation">(</span>elements<span class="token punctuation">,</span> len <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//在新副本上执行添加操作</span>
        newElements<span class="token punctuation">[</span>len<span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">;</span>
        <span class="token comment">//将原容器引用指向新副本</span>
        <span class="token function">setArray</span><span class="token punctuation">(</span>newElements<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//解锁</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>删除操作</strong> - 删除操作同理，将除要删除元素之外的其他元素拷贝到新副本中，然后切换引用，将原容器引用指向新副本。同属写操作，需要加锁。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">E</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token keyword">int</span> index<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//加锁</span>
    <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">;</span>
    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> elements <span class="token operator">=</span> <span class="token function">getArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> len <span class="token operator">=</span> elements<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
        <span class="token class-name">E</span> oldValue <span class="token operator">=</span> <span class="token function">get</span><span class="token punctuation">(</span>elements<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> numMoved <span class="token operator">=</span> len <span class="token operator">-</span> index <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>numMoved <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token comment">//如果要删除的是列表末端数据，拷贝前len-1个数据到新副本上，再切换引用</span>
            <span class="token function">setArray</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">copyOf</span><span class="token punctuation">(</span>elements<span class="token punctuation">,</span> len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//否则，将除要删除元素之外的其他元素拷贝到新副本中，并切换引用</span>
            <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> newElements <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span>len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>elements<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> newElements<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>elements<span class="token punctuation">,</span> index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> newElements<span class="token punctuation">,</span> index<span class="token punctuation">,</span>
                              numMoved<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">setArray</span><span class="token punctuation">(</span>newElements<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> oldValue<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//解锁</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-697"><a class="markdownIt-Anchor" href="#-697">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%92%8C%E5%AE%B9%E5%99%A8.html#copyonwritearraylist-%E7%A4%BA%E4%BE%8B">#</a>CopyOnWriteArrayList 示例</h4>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CopyOnWriteArrayListDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ReadTask</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> list<span class="token punctuation">;</span>

        <span class="token class-name">ReadTask</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> list<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>list <span class="token operator">=</span> list<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> str <span class="token operator">:</span> list<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">WriteTask</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> list<span class="token punctuation">;</span>
        <span class="token keyword">int</span> index<span class="token punctuation">;</span>

        <span class="token class-name">WriteTask</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> list<span class="token punctuation">,</span> <span class="token keyword">int</span> index<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>list <span class="token operator">=</span> list<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>index <span class="token operator">=</span> index<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            list<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
            list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token string">"write_"</span> <span class="token operator">+</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> NUM <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
        <span class="token comment">// ArrayList 在并发迭代访问时会抛出 ConcurrentModificationException 异常</span>
        <span class="token comment">// List&lt;String> list = new ArrayList&lt;>();</span>
        <span class="token class-name">CopyOnWriteArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CopyOnWriteArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NUM<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"main_"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name">ExecutorService</span> executorService <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span>NUM<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NUM<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            executorService<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ReadTask</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            executorService<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WriteTask</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        executorService<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">new</span> <span class="token class-name">CopyOnWriteArrayListDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-698"><a class="markdownIt-Anchor" href="#-698">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%92%8C%E5%AE%B9%E5%99%A8.html#copyonwritearraylist-%E5%AE%9E%E6%88%98">#</a>CopyOnWriteArrayList 实战</h4>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WrongCopyOnWriteList</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">testRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">testWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Map</span> <span class="token function">testWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> copyOnWriteArrayList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CopyOnWriteArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> synchronizedList <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">synchronizedList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">StopWatch</span> stopWatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StopWatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> loopCount <span class="token operator">=</span> <span class="token number">100000</span><span class="token punctuation">;</span>
        stopWatch<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">"Write:copyOnWriteArrayList"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> loopCount<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>__ <span class="token operator">-></span> copyOnWriteArrayList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>loopCount<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stopWatch<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stopWatch<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">"Write:synchronizedList"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> loopCount<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>__ <span class="token operator">-></span> synchronizedList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>loopCount<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stopWatch<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>stopWatch<span class="token punctuation">.</span><span class="token function">prettyPrint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"copyOnWriteArrayList"</span><span class="token punctuation">,</span> copyOnWriteArrayList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"synchronizedList"</span><span class="token punctuation">,</span> synchronizedList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">addAll</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> list<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        list<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">boxed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Map</span> <span class="token function">testRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> copyOnWriteArrayList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CopyOnWriteArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> synchronizedList <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">synchronizedList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">addAll</span><span class="token punctuation">(</span>copyOnWriteArrayList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">addAll</span><span class="token punctuation">(</span>synchronizedList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">StopWatch</span> stopWatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StopWatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> loopCount <span class="token operator">=</span> <span class="token number">1000000</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> count <span class="token operator">=</span> copyOnWriteArrayList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stopWatch<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">"Read:copyOnWriteArrayList"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> loopCount<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>__ <span class="token operator">-></span> copyOnWriteArrayList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stopWatch<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stopWatch<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">"Read:synchronizedList"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> loopCount<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>__ <span class="token operator">-></span> synchronizedList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stopWatch<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>stopWatch<span class="token punctuation">.</span><span class="token function">prettyPrint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"copyOnWriteArrayList"</span><span class="token punctuation">,</span> copyOnWriteArrayList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"synchronizedList"</span><span class="token punctuation">,</span> synchronizedList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>读性能差不多是写性能的一百倍。</p>
<h2 id="-699"><a class="markdownIt-Anchor" href="#-699">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%92%8C%E5%AE%B9%E5%99%A8.html#_5-set">#</a>5. Set</h2>
<p>Set 接口的两个实现是 CopyOnWriteArraySet 和 ConcurrentSkipListSet，使用场景可以参考前面讲述的 CopyOnWriteArrayList 和 ConcurrentSkipListMap，它们的原理都是一样的。</p>
<h2 id="-700"><a class="markdownIt-Anchor" href="#-700">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%92%8C%E5%AE%B9%E5%99%A8.html#_6-queue">#</a>6. Queue</h2>
<p>Java 并发包里面 Queue 这类并发容器是最复杂的，你可以从以下两个维度来分类。一个维度是<strong>阻塞与非阻塞</strong>，所谓阻塞指的是：<strong>当队列已满时，入队操作阻塞；当队列已空时，出队操作阻塞</strong>。另一个维度是<strong>单端与双端</strong>，单端指的是只能队尾入队，队首出队；而双端指的是队首队尾皆可入队出队。Java 并发包里<strong>阻塞队列都用 Blocking 关键字标识，单端队列使用 Queue 标识，双端队列使用 Deque 标识</strong>。</p>
<h3 id="-701"><a class="markdownIt-Anchor" href="#-701">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%92%8C%E5%AE%B9%E5%99%A8.html#_6-1-blockingqueue">#</a>6.1. BlockingQueue</h3>
<p><code>BlockingQueue</code>  顾名思义，是一个<strong>阻塞队列</strong>。<strong> <code>BlockingQueue</code>  基本都是基于锁实现</strong>。在  <code>BlockingQueue</code>  中，<strong>当队列已满时，入队操作阻塞；当队列已空时，出队操作阻塞</strong>。</p>
<p><code>BlockingQueue</code>  接口定义如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">Queue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>核心 API：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 获取并移除队列头结点，如果必要，其会等待直到队列出现元素</span>
<span class="token class-name">E</span> <span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">;</span>
<span class="token comment">// 插入元素，如果队列已满，则等待直到队列出现空闲空间</span>
<span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>BlockingQueue</code>  对插入操作、移除操作、获取元素操作提供了四种不同的方法用于不同的场景中使用：</p>
<ul>
<li>抛出异常；</li>
<li>返回特殊值（ <code>null</code>  或  <code>true</code> / <code>false</code> ，取决于具体的操作）；</li>
<li>阻塞等待此操作，直到这个操作成功；</li>
<li>阻塞等待此操作，直到成功或者超时指定时间。</li>
</ul>
<p>总结如下：</p>
<table>
<thead>
<tr>
<th></th>
<th><strong>Throws exception</strong></th>
<th><strong>Special value</strong></th>
<th><strong>Blocks</strong></th>
<th><strong>Times out</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>Insert</td>
<td>add(e)</td>
<td>offer(e)</td>
<td>put(e)</td>
<td>offer(e, time, unit)</td>
</tr>
<tr>
<td>Remove</td>
<td>remove()</td>
<td>poll()</td>
<td>take()</td>
<td>poll(time, unit)</td>
</tr>
<tr>
<td>Examine</td>
<td>element()</td>
<td>peek()</td>
<td><strong>not applicable</strong></td>
<td><strong>not applicable</strong></td>
</tr>
</tbody>
</table>
<p><code>BlockingQueue</code>  的各个实现类都遵循了这些规则。</p>
<p><code>BlockingQueue</code>  不接受  <code>null</code>  值元素。</p>
<p>JDK 提供了以下阻塞队列：</p>
<ul>
<li><code>ArrayBlockingQueue</code>  - 一个由<strong>数组结构组成的有界阻塞队列</strong>。</li>
<li><code>LinkedBlockingQueue</code>  - 一个由<strong>链表结构组成的有界阻塞队列</strong>。</li>
<li><code>PriorityBlockingQueue</code>  - 一个<strong>支持优先级排序的无界阻塞队列</strong>。</li>
<li><code>SynchronousQueue</code>  - 一个<strong>不存储元素的阻塞队列</strong>。</li>
<li><code>DelayQueue</code>  - 一个使用优先级队列实现的无界阻塞队列。</li>
<li><code>LinkedTransferQueue</code>  - 一个<strong>由链表结构组成的无界阻塞队列</strong>。</li>
</ul>
<p><code>BlockingQueue</code>  基本都是基于锁实现。</p>
<h3 id="-702"><a class="markdownIt-Anchor" href="#-702">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%92%8C%E5%AE%B9%E5%99%A8.html#_6-2-priorityblockingqueue-%E7%B1%BB">#</a>6.2. PriorityBlockingQueue 类</h3>
<p><code>PriorityBlockingQueue</code>  类定义如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PriorityBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span>
    <span class="token keyword">implements</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h4 id="-703"><a class="markdownIt-Anchor" href="#-703">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%92%8C%E5%AE%B9%E5%99%A8.html#priorityblockingqueue-%E8%A6%81%E7%82%B9">#</a>PriorityBlockingQueue 要点</h4>
<ul>
<li><code>PriorityBlockingQueue</code>  可以视为  <code>PriorityQueue</code>  的线程安全版本。</li>
<li><code>PriorityBlockingQueue</code>  实现了  <code>BlockingQueue</code> ，也是一个阻塞队列。</li>
<li><code>PriorityBlockingQueue</code>  实现了  <code>Serializable</code> ，支持序列化。</li>
<li><code>PriorityBlockingQueue</code>  不接受  <code>null</code>  值元素。</li>
<li><code>PriorityBlockingQueue</code>  的插入操作  <code>put</code>  方法不会 block，因为它是无界队列（take 方法在队列为空的时候会阻塞）。</li>
</ul>
<h4 id="-704"><a class="markdownIt-Anchor" href="#-704">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%92%8C%E5%AE%B9%E5%99%A8.html#priorityblockingqueue-%E5%8E%9F%E7%90%86">#</a>PriorityBlockingQueue 原理</h4>
<p><code>PriorityBlockingQueue</code>  有两个重要成员：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> queue<span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<ul>
<li><code>queue</code>  是一个  <code>Object</code>  数组，用于保存  <code>PriorityBlockingQueue</code>  的元素。</li>
<li>而可重入锁  <code>lock</code>  则用于在执行插入、删除操作时，保证这个方法在当前线程释放锁之前，其他线程不能访问。</li>
</ul>
<p><code>PriorityBlockingQueue</code>  的容量虽然有初始化大小，但是不限制大小，如果当前容量已满，插入新元素时会自动扩容。</p>
<h3 id="-705"><a class="markdownIt-Anchor" href="#-705">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%92%8C%E5%AE%B9%E5%99%A8.html#_6-3-arrayblockingqueue-%E7%B1%BB">#</a>6.3. ArrayBlockingQueue 类</h3>
<p><code>ArrayBlockingQueue</code>  是由数组结构组成的<strong>有界阻塞队列</strong>。</p>
<h4 id="-706"><a class="markdownIt-Anchor" href="#-706">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%92%8C%E5%AE%B9%E5%99%A8.html#arrayblockingqueue-%E8%A6%81%E7%82%B9">#</a>ArrayBlockingQueue 要点</h4>
<p><code>ArrayBlockingQueue</code>  类定义如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span>
        <span class="token keyword">implements</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 数组的大小就决定了队列的边界，所以初始化时必须指定容量</span>
    <span class="token keyword">public</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token punctuation">(</span><span class="token keyword">int</span> capacity<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">//... &#125;</span>
    <span class="token keyword">public</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token punctuation">(</span><span class="token keyword">int</span> capacity<span class="token punctuation">,</span> <span class="token keyword">boolean</span> fair<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">//... &#125;</span>
    <span class="token keyword">public</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token punctuation">(</span><span class="token keyword">int</span> capacity<span class="token punctuation">,</span> <span class="token keyword">boolean</span> fair<span class="token punctuation">,</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">E</span><span class="token punctuation">></span></span> c<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">//... &#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>说明：</p>
<ul>
<li><code>ArrayBlockingQueue</code>  实现了  <code>BlockingQueue</code> ，也是一个阻塞队列。</li>
<li><code>ArrayBlockingQueue</code>  实现了  <code>Serializable</code> ，支持序列化。</li>
<li><code>ArrayBlockingQueue</code>  是基于数组实现的有界阻塞队列。所以初始化时必须指定容量。</li>
</ul>
<h4 id="-707"><a class="markdownIt-Anchor" href="#-707">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%92%8C%E5%AE%B9%E5%99%A8.html#arrayblockingqueue-%E5%8E%9F%E7%90%86">#</a>ArrayBlockingQueue 原理</h4>
<p><code>ArrayBlockingQueue</code>  的重要成员如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 用于存放元素的数组</span>
<span class="token keyword">final</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> items<span class="token punctuation">;</span>
<span class="token comment">// 下一次读取操作的位置</span>
<span class="token keyword">int</span> takeIndex<span class="token punctuation">;</span>
<span class="token comment">// 下一次写入操作的位置</span>
<span class="token keyword">int</span> putIndex<span class="token punctuation">;</span>
<span class="token comment">// 队列中的元素数量</span>
<span class="token keyword">int</span> count<span class="token punctuation">;</span>

<span class="token comment">// 以下几个就是控制并发用的同步器</span>
<span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock<span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Condition</span> notEmpty<span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Condition</span> notFull<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>ArrayBlockingQueue</code>  内部以  <code>final</code>  的数组保存数据，数组的大小就决定了队列的边界。</p>
<p><code>ArrayBlockingQueue</code>  实现并发同步的原理就是，读操作和写操作都需要获取到 AQS 独占锁才能进行操作。</p>
<ul>
<li>如果队列为空，这个时候读操作的线程进入到读线程队列排队，等待写线程写入新的元素，然后唤醒读线程队列的第一个等待线程。</li>
<li>如果队列已满，这个时候写操作的线程进入到写线程队列排队，等待读线程将队列元素移除，然后唤醒写线程队列的第一个等待线程。</li>
</ul>
<p>对于  <code>ArrayBlockingQueue</code> ，我们可以在构造的时候指定以下三个参数：</p>
<ul>
<li>队列容量，其限制了队列中最多允许的元素个数；</li>
<li>指定独占锁是公平锁还是非公平锁。非公平锁的吞吐量比较高，公平锁可以保证每次都是等待最久的线程获取到锁；</li>
<li>可以指定用一个集合来初始化，将此集合中的元素在构造方法期间就先添加到队列中。</li>
</ul>
<h3 id="-708"><a class="markdownIt-Anchor" href="#-708">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%92%8C%E5%AE%B9%E5%99%A8.html#_6-4-linkedblockingqueue-%E7%B1%BB">#</a>6.4. LinkedBlockingQueue 类</h3>
<p><code>LinkedBlockingQueue</code>  是由链表结构组成的有界阻塞队列。容易被误解为无边界，但其实其行为和内部代码都是基于有界的逻辑实现的，只不过如果我们没有在创建队列时就指定容量，那么其容量限制就自动被设置为  <code>Integer.MAX_VALUE</code> ，成为了无界队列。</p>
<h4 id="-709"><a class="markdownIt-Anchor" href="#-709">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%92%8C%E5%AE%B9%E5%99%A8.html#linkedblockingqueue-%E8%A6%81%E7%82%B9">#</a>LinkedBlockingQueue 要点</h4>
<p><code>LinkedBlockingQueue</code>  类定义如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span>
        <span class="token keyword">implements</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<ul>
<li><code>LinkedBlockingQueue</code>  实现了  <code>BlockingQueue</code> ，也是一个阻塞队列。</li>
<li><code>LinkedBlockingQueue</code>  实现了  <code>Serializable</code> ，支持序列化。</li>
<li><code>LinkedBlockingQueue</code>  是基于单链表实现的阻塞队列，可以当做无界队列也可以当做有界队列来使用。</li>
<li><code>LinkedBlockingQueue</code>  中元素按照插入顺序保存（FIFO）。</li>
</ul>
<h4 id="-710"><a class="markdownIt-Anchor" href="#-710">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%92%8C%E5%AE%B9%E5%99%A8.html#linkedblockingqueue-%E5%8E%9F%E7%90%86">#</a>LinkedBlockingQueue 原理</h4>
<p><code>LinkedBlockingQueue</code>  中的重要数据结构：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 队列容量</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> capacity<span class="token punctuation">;</span>
<span class="token comment">// 队列中的元素数量</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicInteger</span> count <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 队头</span>
<span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> head<span class="token punctuation">;</span>
<span class="token comment">// 队尾</span>
<span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> last<span class="token punctuation">;</span>

<span class="token comment">// take, poll, peek 等读操作的方法需要获取到这个锁</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> takeLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 如果读操作的时候队列是空的，那么等待 notEmpty 条件</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Condition</span> notEmpty <span class="token operator">=</span> takeLock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// put, offer 等写操作的方法需要获取到这个锁</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> putLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 如果写操作的时候队列是满的，那么等待 notFull 条件</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Condition</span> notFull <span class="token operator">=</span> putLock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里用了两对  <code>Lock</code>  和  <code>Condition</code> ，简单介绍如下：</p>
<ul>
<li><code>takeLock</code>  和  <code>notEmpty</code>  搭配：如果要获取（take）一个元素，需要获取  <code>takeLock</code>  锁，但是获取了锁还不够，如果队列此时为空，还需要队列不为空（ <code>notEmpty</code> ）这个条件（ <code>Condition</code> ）。</li>
<li><code>putLock</code>  需要和  <code>notFull</code>  搭配：如果要插入（put）一个元素，需要获取  <code>putLock</code>  锁，但是获取了锁还不够，如果队列此时已满，还需要队列不是满的（notFull）这个条件（ <code>Condition</code> ）。</li>
</ul>
<h3 id="-711"><a class="markdownIt-Anchor" href="#-711">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%92%8C%E5%AE%B9%E5%99%A8.html#_6-5-synchronousqueue-%E7%B1%BB">#</a>6.5. SynchronousQueue 类</h3>
<p>SynchronousQueue 是<strong>不存储元素的阻塞队列</strong>。每个删除操作都要等待插入操作，反之每个插入操作也都要等待删除动作。那么这个队列的容量是多少呢？是 1 吗？其实不是的，其内部容量是 0。</p>
<p><code>SynchronousQueue</code>  定义如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SynchronousQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span>
    <span class="token keyword">implements</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><code>SynchronousQueue</code>  这个类，在线程池的实现类  <code>ScheduledThreadPoolExecutor</code>  中得到了应用。</p>
<p><code>SynchronousQueue</code>  的队列其实是虚的，即队列容量为 0。数据必须从某个写线程交给某个读线程，而不是写到某个队列中等待被消费。</p>
<p><code>SynchronousQueue</code>  中不能使用 peek 方法（在这里这个方法直接返回 null），peek 方法的语义是只读取不移除，显然，这个方法的语义是不符合 SynchronousQueue 的特征的。</p>
<p><code>SynchronousQueue</code>  也不能被迭代，因为根本就没有元素可以拿来迭代的。</p>
<p>虽然  <code>SynchronousQueue</code>  间接地实现了 Collection 接口，但是如果你将其当做 Collection 来用的话，那么集合是空的。</p>
<p>当然， <code>SynchronousQueue</code>  也不允许传递 null 值的（并发包中的容器类好像都不支持插入 null 值，因为 null 值往往用作其他用途，比如用于方法的返回值代表操作失败）。</p>
<h3 id="-712"><a class="markdownIt-Anchor" href="#-712">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%92%8C%E5%AE%B9%E5%99%A8.html#_6-6-concurrentlinkeddeque-%E7%B1%BB">#</a>6.6. ConcurrentLinkedDeque 类</h3>
<p><code>Deque</code>  的侧重点是支持对队列头尾都进行插入和删除，所以提供了特定的方法，如:</p>
<ul>
<li>尾部插入时需要的  <code>addLast(e)</code> 、 <code>offerLast(e)</code> 。</li>
<li>尾部删除所需要的  <code>removeLast()</code> 、 <code>pollLast()</code> 。</li>
</ul>
<h3 id="-713"><a class="markdownIt-Anchor" href="#-713">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%92%8C%E5%AE%B9%E5%99%A8.html#_6-7-queue-%E7%9A%84%E5%B9%B6%E5%8F%91%E5%BA%94%E7%94%A8">#</a>6.7. Queue 的并发应用</h3>
<p>Queue 被广泛使用在生产者 - 消费者场景。而在并发场景，利用  <code>BlockingQueue</code>  的阻塞机制，可以减少很多并发协调工作。</p>
<p>这么多并发 Queue 的实现，如何选择呢？</p>
<ul>
<li>考虑应用场景中对队列边界的要求。 <code>ArrayBlockingQueue</code>  是有明确的容量限制的，而  <code>LinkedBlockingQueue</code>  则取决于我们是否在创建时指定， <code>SynchronousQueue</code>  则干脆不能缓存任何元素。</li>
<li>从空间利用角度，数组结构的  <code>ArrayBlockingQueue</code>  要比  <code>LinkedBlockingQueue</code>  紧凑，因为其不需要创建所谓节点，但是其初始分配阶段就需要一段连续的空间，所以初始内存需求更大。</li>
<li>通用场景中， <code>LinkedBlockingQueue</code>  的吞吐量一般优于  <code>ArrayBlockingQueue</code> ，因为它实现了更加细粒度的锁操作。</li>
<li><code>ArrayBlockingQueue</code>  实现比较简单，性能更好预测，属于表现稳定的 “选手”。</li>
<li>可能令人意外的是，很多时候  <code>SynchronousQueue</code>  的性能表现，往往大大超过其他实现，尤其是在队列元素较小的场景。</li>
</ul>
<hr>
<h1 id="java-线程池"><a class="markdownIt-Anchor" href="#java-线程池">#</a> Java 线程池</h1>
<blockquote>
<p><strong>📦 本文以及示例源码已归档在 <a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/">javacore(opens new window)</a></strong></p>
</blockquote>
<ul>
<li>\1. 简介
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E6%B1%A0.html#11-%E4%BB%80%E4%B9%88%E6%98%AF%E7%BA%BF%E7%A8%8B%E6%B1%A0">1.1. 什么是线程池</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E6%B1%A0.html#12-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E7%94%A8%E7%BA%BF%E7%A8%8B%E6%B1%A0">1.2. 为什么要用线程池</a></li>
</ul>
</li>
<li>\2. Executor 框架
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E6%B1%A0.html#21-%E6%A0%B8%E5%BF%83-api-%E6%A6%82%E8%BF%B0">2.1. 核心 API 概述</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E6%B1%A0.html#22-executor">2.2. Executor</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E6%B1%A0.html#23-executorservice">2.3. ExecutorService</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E6%B1%A0.html#24-scheduledexecutorservice">2.4. ScheduledExecutorService</a></li>
</ul>
</li>
<li>\3. ThreadPoolExecutor
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E6%B1%A0.html#31-%E9%87%8D%E8%A6%81%E5%AD%97%E6%AE%B5">3.1. 重要字段</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E6%B1%A0.html#32-%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95">3.2. 构造方法</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E6%B1%A0.html#33-execute-%E6%96%B9%E6%B3%95">3.3. execute 方法</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E6%B1%A0.html#34-%E5%85%B6%E4%BB%96%E9%87%8D%E8%A6%81%E6%96%B9%E6%B3%95">3.4. 其他重要方法</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E6%B1%A0.html#35-%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B">3.5. 使用示例</a></li>
</ul>
</li>
<li>\4. Executors
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E6%B1%A0.html#41-newsinglethreadexecutor">4.1. newSingleThreadExecutor</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E6%B1%A0.html#42-newfixedthreadpool">4.2. newFixedThreadPool</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E6%B1%A0.html#43-newcachedthreadpool">4.3. newCachedThreadPool</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E6%B1%A0.html#44-newschedulethreadpool">4.4. newScheduleThreadPool</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E6%B1%A0.html#45-newworkstealingpool">4.5. newWorkStealingPool</a></li>
</ul>
</li>
<li>\5. 线程池最佳实践
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E6%B1%A0.html#51-%E8%AE%A1%E7%AE%97%E7%BA%BF%E7%A8%8B%E6%95%B0%E9%87%8F">5.1. 计算线程数量</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E6%B1%A0.html#52-%E5%BB%BA%E8%AE%AE%E4%BD%BF%E7%94%A8%E6%9C%89%E7%95%8C%E9%98%BB%E5%A1%9E%E9%98%9F%E5%88%97">5.2. 建议使用有界阻塞队列</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E6%B1%A0.html#53-%E9%87%8D%E8%A6%81%E4%BB%BB%E5%8A%A1%E5%BA%94%E8%AF%A5%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8B%92%E7%BB%9D%E7%AD%96%E7%95%A5">5.3. 重要任务应该自定义拒绝策略</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E6%B1%A0.html#6-%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">6. 参考资料</a></li>
</ul>
<h2 id="-714"><a class="markdownIt-Anchor" href="#-714">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E6%B1%A0.html#_1-%E7%AE%80%E4%BB%8B">#</a>1. 简介</h2>
<h3 id="-715"><a class="markdownIt-Anchor" href="#-715">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E6%B1%A0.html#_1-1-%E4%BB%80%E4%B9%88%E6%98%AF%E7%BA%BF%E7%A8%8B%E6%B1%A0">#</a>1.1. 什么是线程池</h3>
<p>线程池是一种多线程处理形式，处理过程中将任务添加到队列，然后在创建线程后自动启动这些任务。</p>
<h3 id="-716"><a class="markdownIt-Anchor" href="#-716">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E6%B1%A0.html#_1-2-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E7%94%A8%E7%BA%BF%E7%A8%8B%E6%B1%A0">#</a>1.2. 为什么要用线程池</h3>
<p>如果并发请求数量很多，但每个线程执行的时间很短，就会出现频繁的创建和销毁线程。如此一来，会大大降低系统的效率，可能频繁创建和销毁线程的时间、资源开销要大于实际工作的所需。</p>
<p>正是由于这个问题，所以有必要引入线程池。使用 <strong>线程池的好处</strong> 有以下几点：</p>
<ul>
<li><strong>降低资源消耗</strong> - 通过重复利用已创建的线程降低线程创建和销毁造成的消耗。</li>
<li><strong>提高响应速度</strong> - 当任务到达时，任务可以不需要等到线程创建就能立即执行。</li>
<li><strong>提高线程的可管理性</strong> - 线程是稀缺资源，如果无限制的创建，不仅会消耗系统资源，还会降低系统的稳定性，使用线程池可以进行统一的分配，调优和监控。但是要做到合理的利用线程池，必须对其原理了如指掌。</li>
</ul>
<h2 id="-717"><a class="markdownIt-Anchor" href="#-717">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E6%B1%A0.html#_2-executor-%E6%A1%86%E6%9E%B6">#</a>2. Executor 框架</h2>
<blockquote>
<p>Executor 框架是一个根据一组执行策略调用，调度，执行和控制的异步任务的框架，目的是提供一种将” 任务提交” 与” 任务如何运行” 分离开来的机制。</p>
</blockquote>
<h3 id="-718"><a class="markdownIt-Anchor" href="#-718">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E6%B1%A0.html#_2-1-%E6%A0%B8%E5%BF%83-api-%E6%A6%82%E8%BF%B0">#</a>2.1. 核心 API 概述</h3>
<p>Executor 框架核心 API 如下：</p>
<ul>
<li>
<p><code>Executor</code>  - 运行任务的简单接口。</p>
</li>
<li>
<pre><code>
  ExecutorService
  <pre class="line-numbers language-none"><code class="language-none">

​	 

	\- 扩展了


​	 
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
  Executor
  <pre class="line-numbers language-none"><code class="language-none">

​	 

	接口。扩展能力：
	
	- 支持有返回值的线程；
	- 支持管理线程的生命周期。

- &#96;ScheduledExecutorService&#96; - 扩展了 &#96;ExecutorService&#96; 接口。扩展能力：支持定期执行任务。

- &#96;AbstractExecutorService&#96; - &#96;ExecutorService&#96; 接口的默认实现。

- &#96;ThreadPoolExecutor&#96; - Executor 框架最核心的类，它继承了 &#96;AbstractExecutorService&#96; 类。

- &#96;ScheduledThreadPoolExecutor&#96; - &#96;ScheduledExecutorService&#96; 接口的实现，一个可定时调度任务的线程池。

- &#96;Executors&#96; - 可以通过调用 &#96;Executors&#96; 的静态工厂方法来创建线程池并返回一个 &#96;ExecutorService&#96; 对象。

![img](https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;HarryQu1229&#x2F;image-host&#x2F;main&#x2F;notes-img&#x2F;exexctor-uml.png)

### [#](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java线程池.html#_2-2-executor)2.2. Executor

&#96;Executor&#96; 接口中只定义了一个 &#96;execute&#96; 方法，用于接收一个 &#96;Runnable&#96; 对象。

&#96;&#96;&#96;java
public interface Executor &#123;
    void execute(Runnable command);
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

</code></pre>
</li>
</ul>
<h3 id="-719"><a class="markdownIt-Anchor" href="#-719">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E6%B1%A0.html#_2-3-executorservice">#</a>2.3. ExecutorService</h3>
<p><code>ExecutorService</code>  接口继承了  <code>Executor</code>  接口，它还提供了  <code>invokeAll</code> 、 <code>invokeAny</code> 、 <code>shutdown</code> 、 <code>submit</code>  等方法。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ExecutorService</span> <span class="token keyword">extends</span> <span class="token class-name">Executor</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">void</span> <span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">></span></span> <span class="token function">shutdownNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">boolean</span> <span class="token function">isShutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">boolean</span> <span class="token function">isTerminated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">boolean</span> <span class="token function">awaitTermination</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">;</span>

    <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">submit</span><span class="token punctuation">(</span><span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> task<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">submit</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> task<span class="token punctuation">,</span> <span class="token class-name">T</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> <span class="token function">submit</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> task<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Future</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">invokeAll</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Callable</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span><span class="token punctuation">></span></span> tasks<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">;</span>

    <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Future</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">invokeAll</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Callable</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span><span class="token punctuation">></span></span> tasks<span class="token punctuation">,</span>
                                  <span class="token keyword">long</span> timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">;</span>

    <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">T</span> <span class="token function">invokeAny</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Callable</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span><span class="token punctuation">></span></span> tasks<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">;</span>

    <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">T</span> <span class="token function">invokeAny</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Callable</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span><span class="token punctuation">></span></span> tasks<span class="token punctuation">,</span>
                    <span class="token keyword">long</span> timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">TimeoutException</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从其支持的方法定义，不难看出：相比于  <code>Executor</code>  接口， <code>ExecutorService</code>  接口主要的扩展是：</p>
<ul>
<li>支持有返回值的线程 -  <code>sumbit</code> 、 <code>invokeAll</code> 、 <code>invokeAny</code>  方法中都支持传入 <code>Callable</code>  对象。</li>
<li>支持管理线程生命周期 -  <code>shutdown</code> 、 <code>shutdownNow</code> 、 <code>isShutdown</code>  等方法。</li>
</ul>
<h3 id="-720"><a class="markdownIt-Anchor" href="#-720">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E6%B1%A0.html#_2-4-scheduledexecutorservice">#</a>2.4. ScheduledExecutorService</h3>
<p><code>ScheduledExecutorService</code>  接口扩展了  <code>ExecutorService</code>  接口。</p>
<p>它除了支持前面两个接口的所有能力以外，还支持定时调度线程。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ScheduledExecutorService</span> <span class="token keyword">extends</span> <span class="token class-name">ExecutorService</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token class-name">ScheduledFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> command<span class="token punctuation">,</span>
                                       <span class="token keyword">long</span> delay<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token class-name">ScheduledFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">></span></span> callable<span class="token punctuation">,</span>
                                           <span class="token keyword">long</span> delay<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ScheduledFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> <span class="token function">scheduleAtFixedRate</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> command<span class="token punctuation">,</span>
                                                  <span class="token keyword">long</span> initialDelay<span class="token punctuation">,</span>
                                                  <span class="token keyword">long</span> period<span class="token punctuation">,</span>
                                                  <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ScheduledFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> <span class="token function">scheduleWithFixedDelay</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> command<span class="token punctuation">,</span>
                                                     <span class="token keyword">long</span> initialDelay<span class="token punctuation">,</span>
                                                     <span class="token keyword">long</span> delay<span class="token punctuation">,</span>
                                                     <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其扩展的接口提供以下能力：</p>
<ul>
<li><code>schedule</code>  方法可以在指定的延时后执行一个  <code>Runnable</code>  或者  <code>Callable</code>  任务。</li>
<li><code>scheduleAtFixedRate</code>  方法和  <code>scheduleWithFixedDelay</code>  方法可以按照指定时间间隔，定期执行任务。</li>
</ul>
<h2 id="-721"><a class="markdownIt-Anchor" href="#-721">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E6%B1%A0.html#_3-threadpoolexecutor">#</a>3. ThreadPoolExecutor</h2>
<p><code>java.uitl.concurrent.ThreadPoolExecutor</code>  类是  <code>Executor</code>  框架中最核心的类。所以，本文将着重讲述一下这个类。</p>
<h3 id="-722"><a class="markdownIt-Anchor" href="#-722">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E6%B1%A0.html#_3-1-%E9%87%8D%E8%A6%81%E5%AD%97%E6%AE%B5">#</a>3.1. 重要字段</h3>
<p><code>ThreadPoolExecutor</code>  有以下重要字段：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicInteger</span> ctl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token function">ctlOf</span><span class="token punctuation">(</span>RUNNING<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> COUNT_BITS <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span>SIZE <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> CAPACITY   <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> COUNT_BITS<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">// runState is stored in the high-order bits</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> RUNNING    <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> COUNT_BITS<span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SHUTDOWN   <span class="token operator">=</span>  <span class="token number">0</span> <span class="token operator">&lt;&lt;</span> COUNT_BITS<span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> STOP       <span class="token operator">=</span>  <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> COUNT_BITS<span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> TIDYING    <span class="token operator">=</span>  <span class="token number">2</span> <span class="token operator">&lt;&lt;</span> COUNT_BITS<span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> TERMINATED <span class="token operator">=</span>  <span class="token number">3</span> <span class="token operator">&lt;&lt;</span> COUNT_BITS<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>参数说明：</p>
<ul>
<li>
<pre><code>
  ctl
  <pre class="line-numbers language-none"><code class="language-none">

​	 

	\-


​	 

	用于控制线程池的运行状态和线程池中的有效线程数量
	
	。它包含两部分的信息：
	
	- 线程池的运行状态 (&#96;runState&#96;)
	- 线程池内有效线程的数量 (&#96;workerCount&#96;)
	- 可以看到，&#96;ctl&#96; 使用了 &#96;Integer&#96; 类型来保存，高 3 位保存 &#96;runState&#96;，低 29 位保存 &#96;workerCount&#96;。&#96;COUNT_BITS&#96; 就是 29，&#96;CAPACITY&#96; 就是 1 左移 29 位减 1（29 个 1），这个常量表示 &#96;workerCount&#96; 的上限值，大约是 5 亿。

- 运行状态 - 线程池一共有五种运行状态：

	- &#96;RUNNING&#96; - **运行状态**。接受新任务，并且也能处理阻塞队列中的任务。

	- &#96;&#96;&#96;
	
		SHUTDOWN<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
  

  ​	 

  	\-

  
  ​	 
  
  	关闭状态
  	
  	。不接受新任务，但可以处理阻塞队列中的任务。
  	
  	- 在线程池处于 `RUNNING` 状态时，调用 `shutdown` 方法会使线程池进入到该状态。
  	- `finalize` 方法在执行过程中也会调用 `shutdown` 方法进入该状态。
  
  - `STOP` - **停止状态**。不接受新任务，也不处理队列中的任务。会中断正在处理任务的线程。在线程池处于 `RUNNING` 或 `SHUTDOWN` 状态时，调用 `shutdownNow` 方法会使线程池进入到该状态。
  
  - `TIDYING` - **整理状态**。如果所有的任务都已终止了，`workerCount` (有效线程数) 为 0，线程池进入该状态后会调用 `terminated` 方法进入 `TERMINATED` 状态。
  
  - ```
  
  	TERMINATED
  	<pre class="line-numbers language-none"><code class="language-none">

​	 

	\-


​	 

	已终止状态
	
	。在


​	 
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
  	terminated
  	<pre class="line-numbers language-none"><code class="language-none">

​	 

	方法执行完后进入该状态。默认


​	 
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
  	terminated
  	<pre class="line-numbers language-none"><code class="language-none">

​	 

	方法中什么也没有做。进入


​	 
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
  	TERMINATED
  	<pre class="line-numbers language-none"><code class="language-none">	
	
	​	 
	
		的条件如下：
		
		- 线程池不是 &#96;RUNNING&#96; 状态；
		- 线程池状态不是 &#96;TIDYING&#96; 状态或 &#96;TERMINATED&#96; 状态；
		- 如果线程池状态是 &#96;SHUTDOWN&#96; 并且 &#96;workerQueue&#96; 为空；
		- &#96;workerCount&#96; 为 0；
		- 设置 &#96;TIDYING&#96; 状态成功。

![img](https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;dunwu&#x2F;images&#x2F;dev&#x2F;cs&#x2F;java&#x2F;javacore&#x2F;concurrent&#x2F;java-thread-pool_2.png)

### [#](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;concurrent&#x2F;Java线程池.html#_3-2-构造方法)3.2. 构造方法

&#96;ThreadPoolExecutor&#96; 有四个构造方法，前三个都是基于第四个实现。第四个构造方法定义如下：

&#96;&#96;&#96;java
public ThreadPoolExecutor(int corePoolSize,
                              int maximumPoolSize,
                              long keepAliveTime,
                              TimeUnit unit,
                              BlockingQueue&lt;Runnable&gt; workQueue,
                              ThreadFactory threadFactory,
                              RejectedExecutionHandler handler) &#123;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

</code></pre>
</li>
</ul>
<p>参数说明：</p>
<ul>
<li>
<pre><code>
  corePoolSize
  <pre class="line-numbers language-none"><code class="language-none">

​	 

	\-


​	 

	核心线程数量
	
	。当有新任务通过


​	 
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
  execute
  <pre class="line-numbers language-none"><code class="language-none">

​	 

	方法提交时 ，线程池会执行以下判断：
	
	- 如果运行的线程数少于 &#96;corePoolSize&#96;，则创建新线程来处理任务，即使线程池中的其他线程是空闲的。
	- 如果线程池中的线程数量大于等于 &#96;corePoolSize&#96; 且小于 &#96;maximumPoolSize&#96;，则只有当 &#96;workQueue&#96; 满时才创建新的线程去处理任务；
	- 如果设置的 &#96;corePoolSize&#96; 和 &#96;maximumPoolSize&#96; 相同，则创建的线程池的大小是固定的。这时如果有新任务提交，若 &#96;workQueue&#96; 未满，则将请求放入 &#96;workQueue&#96; 中，等待有空闲的线程去从 &#96;workQueue&#96; 中取任务并处理；
	- 如果运行的线程数量大于等于 &#96;maximumPoolSize&#96;，这时如果 &#96;workQueue&#96; 已经满了，则使用 &#96;handler&#96; 所指定的策略来处理任务；
	- 所以，任务提交时，判断的顺序为 &#96;corePoolSize&#96; &#x3D;&gt; &#96;workQueue&#96; &#x3D;&gt; &#96;maximumPoolSize&#96;。

- &#96;&#96;&#96;

	maximumPoolSize<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


</code></pre>
</li>
</ul>
<p>​</p>
<pre><code>\-
</code></pre>
<p>​</p>
<pre><code>最大线程数量

。

- 如果队列满了，并且已创建的线程数小于最大线程数，则线程池会再创建新的线程执行任务。
- 值得注意的是：如果使用了无界的任务队列这个参数就没什么效果。
</code></pre>
<ul>
<li>
<pre><code>
  keepAliveTime
  <pre class="line-numbers language-none"><code class="language-none">	
	：
	
	线程保持活动的时间
	
	。
	
	- 当线程池中的线程数量大于 &#96;corePoolSize&#96; 的时候，如果这时没有新的任务提交，核心线程外的线程不会立即销毁，而是会等待，直到等待的时间超过了 &#96;keepAliveTime&#96;。
	- 所以，如果任务很多，并且每个任务执行的时间比较短，可以调大这个时间，提高线程的利用率。

- &#96;unit&#96; - **&#96;keepAliveTime&#96; 的时间单位**。有 7 种取值。可选的单位有天（DAYS），小时（HOURS），分钟（MINUTES），毫秒(MILLISECONDS)，微秒(MICROSECONDS, 千分之一毫秒)和毫微秒(NANOSECONDS, 千分之一微秒)。

- &#96;&#96;&#96;

	workQueue<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


</code></pre>
</li>
</ul>
<p>​</p>
<pre><code>\-
</code></pre>
<p>​</p>
<pre><code>等待执行的任务队列

。用于保存等待执行的任务的阻塞队列。 可以选择以下几个阻塞队列。

- ```
	ArrayBlockingQueue
	<pre class="line-numbers language-none"><code class="language-none">

​		 

		\-


​		 

		有界阻塞队列
	
		。
	
		- 此队列是**基于数组的先进先出队列（FIFO）**。
		- 此队列创建时必须指定大小。
	
	- &#96;&#96;&#96;
		LinkedBlockingQueue<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</code></pre>
<p>​</p>
<pre><code>	\-
</code></pre>
<p>​</p>
<pre><code>	无界阻塞队列

	。

	- 此队列是**基于链表的先进先出队列（FIFO）**。
	- 如果创建时没有指定此队列大小，则默认为 `Integer.MAX_VALUE`。
	- 吞吐量通常要高于 `ArrayBlockingQueue`。
	- 使用 `LinkedBlockingQueue` 意味着： `maximumPoolSize` 将不起作用，线程池能创建的最大线程数为 `corePoolSize`，因为任务等待队列是无界队列。
	- `Executors.newFixedThreadPool` 使用了这个队列。

- ```
	SynchronousQueue
	<pre class="line-numbers language-none"><code class="language-none">

​		 

		\-


​		 

		不会保存提交的任务，而是将直接新建一个线程来执行新来的任务
	
		。
	
		- 每个插入操作必须等到另一个线程调用移除操作，否则插入操作一直处于阻塞状态。
		- 吞吐量通常要高于 &#96;LinkedBlockingQueue&#96;。
		- &#96;Executors.newCachedThreadPool&#96; 使用了这个队列。
	
	- &#96;PriorityBlockingQueue&#96; - **具有优先级的无界阻塞队列**。

- &#96;threadFactory&#96; - **线程工厂**。可以通过线程工厂给每个创建出来的线程设置更有意义的名字。

- &#96;&#96;&#96;

	handler<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</code></pre>
<p>​</p>
<pre><code>\-
</code></pre>
<p>​</p>
<pre><code>饱和策略

。它是
</code></pre>
<p>​</p>
<pre><code><pre class="line-numbers language-none"><code class="language-none">RejectedExecutionHandler<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</code></pre>
<p>​</p>
<pre><code>类型的变量。当队列和线程池都满了，说明线程池处于饱和状态，那么必须采取一种策略处理提交的新任务。线程池支持以下策略：

- `AbortPolicy` - 丢弃任务并抛出异常。这也是默认策略。
- `DiscardPolicy` - 丢弃任务，但不抛出异常。
- `DiscardOldestPolicy` - 丢弃队列最前面的任务，然后重新尝试执行任务（重复此过程）。
- `CallerRunsPolicy` - 直接调用 `run` 方法并且阻塞执行。
- 如果以上策略都不能满足需要，也可以通过实现 `RejectedExecutionHandler` 接口来定制处理策略。如记录日志或持久化不能处理的任务。
</code></pre>
<h3 id="-723"><a class="markdownIt-Anchor" href="#-723">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E6%B1%A0.html#_3-3-execute-%E6%96%B9%E6%B3%95">#</a>3.3. execute 方法</h3>
<p>默认情况下，创建线程池之后，线程池中是没有线程的，需要提交任务之后才会创建线程。</p>
<p>提交任务可以使用  <code>execute</code>  方法，它是  <code>ThreadPoolExecutor</code>  的核心方法，通过这个方法可以<strong>向线程池提交一个任务，交由线程池去执行</strong>。</p>
<p><code>execute</code>  方法工作流程如下：</p>
<ol>
<li>如果  <code>workerCount &lt; corePoolSize</code> ，则创建并启动一个线程来执行新提交的任务；</li>
<li>如果  <code>workerCount &gt;= corePoolSize</code> ，且线程池内的阻塞队列未满，则将任务添加到该阻塞队列中；</li>
<li>如果  <code>workerCount &gt;= corePoolSize &amp;&amp; workerCount &lt; maximumPoolSize</code> ，且线程池内的阻塞队列已满，则创建并启动一个线程来执行新提交的任务；</li>
<li>如果 <code>workerCount &gt;= maximumPoolSize</code> ，并且线程池内的阻塞队列已满，则根据拒绝策略来处理该任务，默认的处理方式是直接抛异常。</li>
</ol>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/java-thread-pool_1.png" alt="img"></p>
<h3 id="-724"><a class="markdownIt-Anchor" href="#-724">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E6%B1%A0.html#_3-4-%E5%85%B6%E4%BB%96%E9%87%8D%E8%A6%81%E6%96%B9%E6%B3%95">#</a>3.4. 其他重要方法</h3>
<p>在  <code>ThreadPoolExecutor</code>  类中还有一些重要的方法：</p>
<ul>
<li>
<p><code>submit</code>  - 类似于  <code>execute</code> ，但是针对的是有返回值的线程。 <code>submit</code>  方法是在  <code>ExecutorService</code>  中声明的方法，在  <code>AbstractExecutorService</code>  就已经有了具体的实现。 <code>ThreadPoolExecutor</code>  直接复用  <code>AbstractExecutorService</code>  的  <code>submit</code>  方法。</p>
</li>
<li>
<pre><code>
  shutdown
  <pre class="line-numbers language-none"><code class="language-none">

​	 

	\- 不会立即终止线程池，而是要等所有任务缓存队列中的任务都执行完后才终止，但再也不会接受新的任务。
	
	- 将线程池切换到 &#96;SHUTDOWN&#96; 状态；
	- 并调用 &#96;interruptIdleWorkers&#96; 方法请求中断所有空闲的 worker；
	- 最后调用 &#96;tryTerminate&#96; 尝试结束线程池。

- &#96;&#96;&#96;

	shutdownNow<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


</code></pre>
</li>
</ul>
<p>​</p>
<pre><code>\- 立即终止线程池，并尝试打断正在执行的任务，并且清空任务缓存队列，返回尚未执行的任务。与
</code></pre>
<p>​</p>
<pre><code><pre class="line-numbers language-none"><code class="language-none">shutdown<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</code></pre>
<p>​</p>
<pre><code>方法类似，不同的地方在于：

- 设置状态为 `STOP`；
- 中断所有工作线程，无论是否是空闲的；
- 取出阻塞队列中没有被执行的任务并返回。
</code></pre>
<ul>
<li>
<p><code>isShutdown</code>  - 调用了  <code>shutdown</code>  或  <code>shutdownNow</code>  方法后， <code>isShutdown</code>  方法就会返回 true。</p>
</li>
<li>
<p><code>isTerminaed</code>  - 当所有的任务都已关闭后，才表示线程池关闭成功，这时调用  <code>isTerminaed</code>  方法会返回 true。</p>
</li>
<li>
<p><code>setCorePoolSize</code>  - 设置核心线程数大小。</p>
</li>
<li>
<p><code>setMaximumPoolSize</code>  - 设置最大线程数大小。</p>
</li>
<li>
<p><code>getTaskCount</code>  - 线程池已经执行的和未执行的任务总数；</p>
</li>
<li>
<p><code>getCompletedTaskCount</code>  - 线程池已完成的任务数量，该值小于等于  <code>taskCount</code> ；</p>
</li>
<li>
<p><code>getLargestPoolSize</code>  - 线程池曾经创建过的最大线程数量。通过这个数据可以知道线程池是否满过，也就是达到了  <code>maximumPoolSize</code> ；</p>
</li>
<li>
<p><code>getPoolSize</code>  - 线程池当前的线程数量；</p>
</li>
<li>
<p><code>getActiveCount</code>  - 当前线程池中正在执行任务的线程数量。</p>
</li>
</ul>
<h3 id="-725"><a class="markdownIt-Anchor" href="#-725">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E6%B1%A0.html#_3-5-%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B">#</a>3.5. 使用示例</h3>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadPoolExecutorDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ThreadPoolExecutor</span> threadPoolExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">defaultThreadFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor<span class="token punctuation">.</span>AbortPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            threadPoolExecutor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> info <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"线程池中线程数目：%s，队列中等待执行的任务数目：%s，已执行玩别的任务数目：%s"</span><span class="token punctuation">,</span>
                threadPoolExecutor<span class="token punctuation">.</span><span class="token function">getPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                threadPoolExecutor<span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                threadPoolExecutor<span class="token punctuation">.</span><span class="token function">getCompletedTaskCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        threadPoolExecutor<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyThread</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" 执行"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="-726"><a class="markdownIt-Anchor" href="#-726">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E6%B1%A0.html#_4-executors">#</a>4. Executors</h2>
<p>JDK 的  <code>Executors</code>  类中提供了几种具有代表性的线程池，这些线程池 <strong>都是基于  <code>ThreadPoolExecutor</code>  的定制化实现</strong>。</p>
<p>在实际使用线程池的场景中，我们往往不是直接使用  <code>ThreadPoolExecutor</code>  ，而是使用 JDK 中提供的具有代表性的线程池实例。</p>
<h3 id="-727"><a class="markdownIt-Anchor" href="#-727">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E6%B1%A0.html#_4-1-newsinglethreadexecutor">#</a>4.1. newSingleThreadExecutor</h3>
<p><strong>创建一个单线程的线程池</strong>。</p>
<p>只会创建唯一的工作线程来执行任务，保证所有任务按照指定顺序 (FIFO, LIFO, 优先级) 执行。 <strong>如果这个唯一的线程因为异常结束，那么会有一个新的线程来替代它</strong> 。</p>
<p>单工作线程最大的特点是：<strong>可保证顺序地执行各个任务</strong>。</p>
<p>示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SingleThreadExecutorDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ExecutorService</span> executorService <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newSingleThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            executorService<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" 执行"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        executorService<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-728"><a class="markdownIt-Anchor" href="#-728">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E6%B1%A0.html#_4-2-newfixedthreadpool">#</a>4.2. newFixedThreadPool</h3>
<p><strong>创建一个固定大小的线程池</strong>。</p>
<p><strong>每次提交一个任务就会新创建一个工作线程，如果工作线程数量达到线程池最大线程数，则将提交的任务存入到阻塞队列中</strong>。</p>
<p><code>FixedThreadPool</code>  是一个典型且优秀的线程池，它具有线程池提高程序效率和节省创建线程时所耗的开销的优点。但是，在线程池空闲时，即线程池中没有可运行任务时，它不会释放工作线程，还会占用一定的系统资源。</p>
<p>示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FixedThreadPoolDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ExecutorService</span> executorService <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            executorService<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" 执行"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        executorService<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-729"><a class="markdownIt-Anchor" href="#-729">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E6%B1%A0.html#_4-3-newcachedthreadpool">#</a>4.3. newCachedThreadPool</h3>
<p><strong>创建一个可缓存的线程池</strong>。</p>
<ul>
<li>如果线程池大小超过处理任务所需要的线程数，就会回收部分空闲的线程；</li>
<li>如果长时间没有往线程池中提交任务，即如果工作线程空闲了指定的时间（默认为 1 分钟），则该工作线程将自动终止。终止后，如果你又提交了新的任务，则线程池重新创建一个工作线程。</li>
<li>此线程池不会对线程池大小做限制，线程池大小完全依赖于操作系统（或者说 JVM）能够创建的最大线程大小。 因此，使用  <code>CachedThreadPool</code>  时，一定要注意控制任务的数量，否则，由于大量线程同时运行，很有会造成系统瘫痪。</li>
</ul>
<p>示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CachedThreadPoolDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ExecutorService</span> executorService <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newCachedThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            executorService<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" 执行"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        executorService<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-730"><a class="markdownIt-Anchor" href="#-730">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E6%B1%A0.html#_4-4-newschedulethreadpool">#</a>4.4. newScheduleThreadPool</h3>
<p>创建一个大小无限的线程池。此线程池支持定时以及周期性执行任务的需求。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ScheduledThreadPoolDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">scheduleAtFixedRate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ScheduledExecutorService</span> executorService <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newScheduledThreadPool</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            executorService<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" 执行"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        executorService<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">scheduleAtFixedRate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ScheduledExecutorService</span> executorService <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newScheduledThreadPool</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            executorService<span class="token punctuation">.</span><span class="token function">scheduleAtFixedRate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" 执行"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        executorService<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-731"><a class="markdownIt-Anchor" href="#-731">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E6%B1%A0.html#_4-5-newworkstealingpool">#</a>4.5. newWorkStealingPool</h3>
<p>Java 8 才引入。</p>
<p>其内部会构建  <code>ForkJoinPool</code> ，利用 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Work_stealing">Work-Stealing (opens new window)</a> 算法，并行地处理任务，不保证处理顺序。</p>
<h2 id="-732"><a class="markdownIt-Anchor" href="#-732">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E6%B1%A0.html#_5-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">#</a>5. 线程池最佳实践</h2>
<h3 id="-733"><a class="markdownIt-Anchor" href="#-733">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E6%B1%A0.html#_5-1-%E8%AE%A1%E7%AE%97%E7%BA%BF%E7%A8%8B%E6%95%B0%E9%87%8F">#</a>5.1. 计算线程数量</h3>
<p>一般多线程执行的任务类型可以分为 CPU 密集型和 I/O 密集型，根据不同的任务类型，我们计算线程数的方法也不一样。</p>
<p>**CPU 密集型任务：** 这种任务消耗的主要是 CPU 资源，可以将线程数设置为 N（CPU 核心数）+1，比 CPU 核心数多出来的一个线程是为了防止线程偶发的缺页中断，或者其它原因导致的任务暂停而带来的影响。一旦任务暂停，CPU 就会处于空闲状态，而在这种情况下多出来的一个线程就可以充分利用 CPU 的空闲时间。</p>
<p>**I/O 密集型任务：** 这种任务应用起来，系统会用大部分的时间来处理 I/O 交互，而线程在处理 I/O 的时间段内不会占用 CPU 来处理，这时就可以将 CPU 交出给其它线程使用。因此在 I/O 密集型任务的应用中，我们可以多配置一些线程，具体的计算方法是 2N。</p>
<h3 id="-734"><a class="markdownIt-Anchor" href="#-734">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E6%B1%A0.html#_5-2-%E5%BB%BA%E8%AE%AE%E4%BD%BF%E7%94%A8%E6%9C%89%E7%95%8C%E9%98%BB%E5%A1%9E%E9%98%9F%E5%88%97">#</a>5.2. 建议使用有界阻塞队列</h3>
<p>不建议使用  <code>Executors</code>  的最重要的原因是： <code>Executors</code>  提供的很多方法默认使用的都是无界的  <code>LinkedBlockingQueue</code> ，高负载情境下，无界队列很容易导致 OOM，而 OOM 会导致所有请求都无法处理，这是致命问题。所以<strong>强烈建议使用有界队列</strong>。</p>
<p>《阿里巴巴 Java 开发手册》中提到，禁止使用这些方法来创建线程池，而应该手动  <code>new ThreadPoolExecutor</code>  来创建线程池。制订这条规则是因为容易导致生产事故，最典型的就是  <code>newFixedThreadPool</code>  和  <code>newCachedThreadPool</code> ，可能因为资源耗尽导致 OOM 问题。</p>
<p>【示例】 <code>newFixedThreadPool</code>  OOM</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">ThreadPoolExecutor</span> threadPool <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">)</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">printStats</span><span class="token punctuation">(</span>threadPool<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100000000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	threadPool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
		<span class="token class-name">String</span> payload <span class="token operator">=</span> <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1000000</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">mapToObj</span><span class="token punctuation">(</span>__ <span class="token operator">-></span> <span class="token string">"a"</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">joining</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
			<span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>HOURS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token punctuation">&#125;</span>
		log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

threadPool<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
threadPool<span class="token punctuation">.</span><span class="token function">awaitTermination</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>HOURS<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>newFixedThreadPool</code>  使用的工作队列是  <code>LinkedBlockingQueue</code>  ，而默认构造方法的  <code>LinkedBlockingQueue</code>  是一个  <code>Integer.MAX_VALUE</code>  长度的队列，可以认为是无界的。如果任务较多并且执行较慢的话，队列可能会快速积压，撑爆内存导致 OOM。</p>
<p>【示例】 <code>newCachedThreadPool</code>  OOM</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">ThreadPoolExecutor</span> threadPool <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">)</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newCachedThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">printStats</span><span class="token punctuation">(</span>threadPool<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100000000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	threadPool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
		<span class="token class-name">String</span> payload <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
			<span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>HOURS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token punctuation">&#125;</span>
		log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
threadPool<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
threadPool<span class="token punctuation">.</span><span class="token function">awaitTermination</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>HOURS<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>newCachedThreadPool</code>  的最大线程数是  <code>Integer.MAX_VALUE</code> ，可以认为是没有上限的，而其工作队列  <code>SynchronousQueue</code>  是一个没有存储空间的阻塞队列。这意味着，只要有请求到来，就必须找到一条工作线程来处理，如果当前没有空闲的线程就再创建一条新的。</p>
<p>如果大量的任务进来后会创建大量的线程。我们知道线程是需要分配一定的内存空间作为线程栈的，比如 1MB，因此无限制创建线程必然会导致 OOM。</p>
<h3 id="-735"><a class="markdownIt-Anchor" href="#-735">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E7%BA%BF%E7%A8%8B%E6%B1%A0.html#_5-3-%E9%87%8D%E8%A6%81%E4%BB%BB%E5%8A%A1%E5%BA%94%E8%AF%A5%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8B%92%E7%BB%9D%E7%AD%96%E7%95%A5">#</a>5.3. 重要任务应该自定义拒绝策略</h3>
<p>使用有界队列，当任务过多时，线程池会触发执行拒绝策略，线程池默认的拒绝策略会 throw  <code>RejectedExecutionException</code>  这是个运行时异常，对于运行时异常编译器并不强制  <code>catch</code>  它，所以开发人员很容易忽略。因此<strong>默认拒绝策略要慎重使用</strong>。如果线程池处理的任务非常重要，建议自定义自己的拒绝策略；并且在实际工作中，自定义的拒绝策略往往和降级策略配合使用。</p>
<hr>
<h1 id="java-并发工具类"><a class="markdownIt-Anchor" href="#java-并发工具类">#</a> Java 并发工具类</h1>
<blockquote>
<p><strong>📦 本文以及示例源码已归档在 <a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/">javacore(opens new window)</a></strong></p>
<p>JDK 的  <code>java.util.concurrent</code>  包（即 J.U.C）中提供了几个非常有用的并发工具类。</p>
</blockquote>
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%B7%A5%E5%85%B7%E7%B1%BB.html#1-countdownlatch">1. CountDownLatch</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%B7%A5%E5%85%B7%E7%B1%BB.html#2-cyclicbarrier">2. CyclicBarrier</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%B7%A5%E5%85%B7%E7%B1%BB.html#3-semaphore">3. Semaphore</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%B7%A5%E5%85%B7%E7%B1%BB.html#4-%E6%80%BB%E7%BB%93">4. 总结</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%B7%A5%E5%85%B7%E7%B1%BB.html#5-%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">5. 参考资料</a></li>
</ul>
<h2 id="-736"><a class="markdownIt-Anchor" href="#-736">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%B7%A5%E5%85%B7%E7%B1%BB.html#_1-countdownlatch">#</a>1. CountDownLatch</h2>
<blockquote>
<p>字面意思为 <strong>递减计数锁</strong>。用于<strong>控制一个线程等待多个线程</strong>。</p>
<p><code>CountDownLatch</code>  维护一个计数器 count，表示需要等待的事件数量。 <code>countDown</code>  方法递减计数器，表示有一个事件已经发生。调用  <code>await</code>  方法的线程会一直阻塞直到计数器为零，或者等待中的线程中断，或者等待超时。</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/cs/java/javacore/concurrent/CountDownLatch.png" alt="img"></p>
<p><code>CountDownLatch</code>  是基于 AQS ( <code>AbstractQueuedSynchronizer</code> ) 实现的。</p>
<p><code>CountDownLatch</code>  唯一的构造方法：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 初始化计数器</span>
<span class="token keyword">public</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>说明：</p>
<ul>
<li>count 为统计值。</li>
</ul>
<p><code>CountDownLatch</code>  的重要方法：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">await</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>说明：</p>
<ul>
<li><code>await()</code>  - 调用  <code>await()</code>  方法的线程会被挂起，它会等待直到 count 值为 0 才继续执行。</li>
<li><code>await(long timeout, TimeUnit unit)</code>  - 和  <code>await()</code>  类似，只不过等待一定的时间后 count 值还没变为 0 的话就会继续执行</li>
<li><code>countDown()</code>  - 将统计值 count 减 1</li>
</ul>
<p>示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CountDownLatchDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">final</span> <span class="token class-name">CountDownLatch</span> latch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span>latch<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span>latch<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"等待2个子线程执行完毕..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            latch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"2个子线程已经执行完毕"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"继续执行主线程"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyThread</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span>

        <span class="token keyword">private</span> <span class="token class-name">CountDownLatch</span> latch<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span><span class="token class-name">CountDownLatch</span> latch<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>latch <span class="token operator">=</span> latch<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"子线程"</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"正在执行"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"子线程"</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"执行完毕"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            latch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="-737"><a class="markdownIt-Anchor" href="#-737">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%B7%A5%E5%85%B7%E7%B1%BB.html#_2-cyclicbarrier">#</a>2. CyclicBarrier</h2>
<blockquote>
<p>字面意思是 <strong>循环栅栏</strong>。<strong> <code>CyclicBarrier</code>  可以让一组线程等待至某个状态（遵循字面意思，不妨称这个状态为栅栏）之后再全部同时执行</strong>。之所以叫循环栅栏是因为：<strong>当所有等待线程都被释放以后， <code>CyclicBarrier</code>  可以被重用</strong>。</p>
<p><code>CyclicBarrier</code>  维护一个计数器 count。每次执行  <code>await</code>  方法之后，count 加 1，直到计数器的值和设置的值相等，等待的所有线程才会继续执行。</p>
</blockquote>
<p><code>CyclicBarrier</code>  是基于  <code>ReentrantLock</code>  和  <code>Condition</code>  实现的。</p>
<p><code>CyclicBarrier</code>  应用场景： <code>CyclicBarrier</code>  在并行迭代算法中非常有用。</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/CyclicBarrier.png" alt="img"></p>
<p><code>CyclicBarrier</code>  提供了 2 个构造方法</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">CyclicBarrier</span><span class="token punctuation">(</span><span class="token keyword">int</span> parties<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token keyword">public</span> <span class="token class-name">CyclicBarrier</span><span class="token punctuation">(</span><span class="token keyword">int</span> parties<span class="token punctuation">,</span> <span class="token class-name">Runnable</span> barrierAction<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<blockquote>
<p>说明：</p>
<ul>
<li><code>parties</code>  -  <code>parties</code>  数相当于一个阈值，当有  <code>parties</code>  数量的线程在等待时，  <code>CyclicBarrier</code>  处于栅栏状态。</li>
<li><code>barrierAction</code>  - 当  <code>CyclicBarrier</code>  处于栅栏状态时执行的动作。</li>
</ul>
</blockquote>
<p><code>CyclicBarrier</code>  的重要方法：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">BrokenBarrierException</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">await</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span>
               <span class="token class-name">BrokenBarrierException</span><span class="token punctuation">,</span>
               <span class="token class-name">TimeoutException</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token comment">// 将屏障重置为初始状态</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>说明：</p>
<ul>
<li><code>await()</code>  - 等待调用  <code>await()</code>  的线程数达到屏障数。如果当前线程是最后一个到达的线程，并且在构造函数中提供了非空屏障操作，则当前线程在允许其他线程继续之前运行该操作。如果在屏障动作期间发生异常，那么该异常将在当前线程中传播并且屏障被置于断开状态。</li>
<li><code>await(long timeout, TimeUnit unit)</code>  - 相比于  <code>await()</code>  方法，这个方法让这些线程等待至一定的时间，如果还有线程没有到达栅栏状态就直接让到达栅栏状态的线程执行后续任务。</li>
<li><code>reset()</code>  - 将屏障重置为初始状态。</li>
</ul>
</blockquote>
<p>示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CyclicBarrierDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token class-name">N</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">CyclicBarrier</span> barrier <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CyclicBarrier</span><span class="token punctuation">(</span><span class="token class-name">N</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"当前线程"</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token class-name">N</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">MyThread</span> myThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span>barrier<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>myThread<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyThread</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span>

        <span class="token keyword">private</span> <span class="token class-name">CyclicBarrier</span> cyclicBarrier<span class="token punctuation">;</span>

        <span class="token class-name">MyThread</span><span class="token punctuation">(</span><span class="token class-name">CyclicBarrier</span> cyclicBarrier<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>cyclicBarrier <span class="token operator">=</span> cyclicBarrier<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"线程"</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"正在写入数据..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 以睡眠来模拟写入数据操作</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"线程"</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"写入数据完毕，等待其他线程写入完毕"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                cyclicBarrier<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> <span class="token operator">|</span> <span class="token class-name">BrokenBarrierException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="-738"><a class="markdownIt-Anchor" href="#-738">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%B7%A5%E5%85%B7%E7%B1%BB.html#_3-semaphore">#</a>3. Semaphore</h2>
<blockquote>
<p>字面意思为 <strong>信号量</strong>。 <code>Semaphore</code>  用来控制某段代码块的并发数。</p>
<p><code>Semaphore</code>  管理着一组虚拟的许可（permit），permit 的初始数量可通过构造方法来指定。每次执行  <code>acquire</code>  方法可以获取一个 permit，如果没有就等待；而  <code>release</code>  方法可以释放一个 permit。</p>
</blockquote>
<p><code>Semaphore</code>  应用场景：</p>
<ul>
<li><code>Semaphore</code>  可以用于实现资源池，如数据库连接池。</li>
<li><code>Semaphore</code>  可以用于将任何一种容器变成有界阻塞容器。</li>
</ul>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/Semaphore.png" alt="img"></p>
<p><code>Semaphore</code>  提供了 2 个构造方法：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 参数 permits 表示许可数目，即同时可以允许多少线程进行访问</span>
<span class="token keyword">public</span> <span class="token class-name">Semaphore</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token keyword">permits</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token comment">// 参数 fair 表示是否是公平的，即等待时间越久的越先获取许可</span>
<span class="token keyword">public</span> <span class="token class-name">Semaphore</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token keyword">permits</span><span class="token punctuation">,</span> <span class="token keyword">boolean</span> fair<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>说明：</p>
<ul>
<li><code>permits</code>  - 初始化固定数量的 permit，并且默认为非公平模式。</li>
<li><code>fair</code>  - 设置是否为公平模式。所谓公平，是指等待久的优先获取 permit。</li>
</ul>
</blockquote>
<p><code>Semaphore</code>  的重要方法：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 获取 1 个许可</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token comment">//获取 permits 个许可</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token keyword">permits</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token comment">// 释放 1 个许可</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token comment">//释放 permits 个许可</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">release</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token keyword">permits</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>说明：</p>
<ul>
<li><code>acquire()</code>  - 获取 1 个 permit。</li>
<li><code>acquire(int permits)</code>  - 获取 permits 数量的 permit。</li>
<li><code>release()</code>  - 释放 1 个 permit。</li>
<li><code>release(int permits)</code>  - 释放 permits 数量的 permit。</li>
</ul>
<p>示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SemaphoreDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> THREAD_COUNT <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ExecutorService</span> threadPool <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span>THREAD_COUNT<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Semaphore</span> semaphore <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Semaphore</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> THREAD_COUNT<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            threadPool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                        semaphore<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"save data"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        semaphore<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        threadPool<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="-739"><a class="markdownIt-Anchor" href="#-739">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%B9%B6%E5%8F%91%E5%B7%A5%E5%85%B7%E7%B1%BB.html#_4-%E6%80%BB%E7%BB%93">#</a>4. 总结</h2>
<ul>
<li><code>CountDownLatch</code>  和 <code>CyclicBarrier</code>  都能够实现线程之间的等待，只不过它们侧重点不同：
<ul>
<li><code>CountDownLatch</code>  一般用于某个线程 A 等待若干个其他线程执行完任务之后，它才执行；</li>
<li><code>CyclicBarrier</code>  一般用于一组线程互相等待至某个状态，然后这一组线程再同时执行；</li>
<li>另外， <code>CountDownLatch</code>  是不可以重用的，而  <code>CyclicBarrier</code>  是可以重用的。</li>
</ul>
</li>
<li><code>Semaphore</code>  其实和锁有点类似，它一般用于控制对某组资源的访问权限。</li>
</ul>
<hr>
<h1 id="java-内存模型"><a class="markdownIt-Anchor" href="#java-内存模型">#</a> Java 内存模型</h1>
<blockquote>
<p><strong>关键词</strong>： <code>JMM</code> 、 <code>volatile</code> 、 <code>synchronized</code> 、 <code>final</code> 、 <code>Happens-Before</code> 、 <code>内存屏障</code></p>
<p><strong>摘要</strong>：Java 内存模型（Java Memory Model），简称 <strong>JMM</strong>。Java 内存模型的目标是为了解决由可见性和有序性导致的并发安全问题。Java 内存模型通过 <strong>屏蔽各种硬件和操作系统的内存访问差异，以实现让 Java 程序在各种平台下都能达到一致的内存访问效果</strong>。</p>
<p><strong>📦 本文以及示例源码已归档在 <a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/">javacore(opens new window)</a></strong></p>
</blockquote>
<ul>
<li>\1. 物理内存模型
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B.html#11-%E7%A1%AC%E4%BB%B6%E5%A4%84%E7%90%86%E6%95%88%E7%8E%87">1.1. 硬件处理效率</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B.html#12-%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7">1.2. 缓存一致性</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B.html#13-%E4%BB%A3%E7%A0%81%E4%B9%B1%E5%BA%8F%E6%89%A7%E8%A1%8C%E4%BC%98%E5%8C%96">1.3. 代码乱序执行优化</a></li>
</ul>
</li>
<li>\2. Java 内存模型
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B.html#21-%E4%B8%BB%E5%86%85%E5%AD%98%E5%92%8C%E5%B7%A5%E4%BD%9C%E5%86%85%E5%AD%98">2.1. 主内存和工作内存</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B.html#22-jmm-%E5%86%85%E5%AD%98%E6%93%8D%E4%BD%9C%E7%9A%84%E9%97%AE%E9%A2%98">2.2. JMM 内存操作的问题</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B.html#23-%E5%86%85%E5%AD%98%E9%97%B4%E4%BA%A4%E4%BA%92%E6%93%8D%E4%BD%9C">2.3. 内存间交互操作</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B.html#24-%E5%B9%B6%E5%8F%91%E5%AE%89%E5%85%A8%E7%89%B9%E6%80%A7">2.4. 并发安全特性</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B.html#3-happens-before">3. Happens-Before</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B.html#4-%E5%86%85%E5%AD%98%E5%B1%8F%E9%9A%9C">4. 内存屏障</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B.html#5-volatile">5. volatile</a></li>
<li>\6. synchronized
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B.html#61-long-%E5%92%8C-double-%E5%8F%98%E9%87%8F%E7%9A%84%E7%89%B9%E6%AE%8A%E8%A7%84%E5%88%99">6.1. long 和 double 变量的特殊规则</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B.html#62-final-%E5%9E%8B%E9%87%8F%E7%9A%84%E7%89%B9%E6%AE%8A%E8%A7%84%E5%88%99">6.2. final 型量的特殊规则</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B.html#7-%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">7. 参考资料</a></li>
</ul>
<h2 id="-740"><a class="markdownIt-Anchor" href="#-740">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B.html#_1-%E7%89%A9%E7%90%86%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B">#</a>1. 物理内存模型</h2>
<p>物理机遇到的并发问题与虚拟机中的情况有不少相似之处，物理机对并发的处理方案对于虚拟机的实现也有相当大的参考意义。</p>
<h3 id="-741"><a class="markdownIt-Anchor" href="#-741">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B.html#_1-1-%E7%A1%AC%E4%BB%B6%E5%A4%84%E7%90%86%E6%95%88%E7%8E%87">#</a>1.1. 硬件处理效率</h3>
<p>物理内存的第一个问题是：硬件处理效率。</p>
<ul>
<li>绝大多数的运算任务都不可能只靠处理器 “计算” 就能完成，处理器至少需要与<strong>内存交互</strong>，如读取运算数据、存储运算结果，这个 I/O 操作是很难消除的（无法仅靠寄存器完成所有运算任务）。</li>
<li><strong>由于计算机的存储设备与处理器的运算速度有几个数量级的差距</strong> ，这种速度上的矛盾，会降低硬件的处理效率。所以，现代计算机都不得不 <strong>加入高速缓存（Cache） 来作为内存和处理器之间的缓冲</strong>。将需要用到的数据复制到缓存中，让运算能快速进行，当运算结束后再从缓存同步会内存中，这样处理器就无需等待缓慢的内存读写了。</li>
</ul>
<h3 id="-742"><a class="markdownIt-Anchor" href="#-742">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B.html#_1-2-%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7">#</a>1.2. 缓存一致性</h3>
<p>高速缓存解决了 <strong>硬件效率问题</strong>，但是引入了一个新的问题：<strong>缓存一致性（Cache Coherence）</strong>。</p>
<p>在多处理器系统中，每个处理器都有自己的高速缓存，而它们又共享同一主内存。当多个处理器的运算任务都涉及同一块主内存区域时，将可能导致各自的缓存数据不一致。</p>
<p>为了解决缓存一致性问题，<strong>需要各个处理器访问缓存时都遵循一些协议，在读写时要根据协议来进行操作</strong>。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20210102230327.png" alt="img"></p>
<h3 id="-743"><a class="markdownIt-Anchor" href="#-743">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B.html#_1-3-%E4%BB%A3%E7%A0%81%E4%B9%B1%E5%BA%8F%E6%89%A7%E8%A1%8C%E4%BC%98%E5%8C%96">#</a>1.3. 代码乱序执行优化</h3>
<p><strong>除了高速缓存以外，为了使得处理器内部的运算单元尽量被充分利用</strong>，处理器可能会对输入代码进行乱序执行（Out-Of-Order Execution）优化。处理器会在计算之后将乱序执行的结果重组，<strong>保证该结果与顺序执行的结果是一致的</strong>，但不保证程序中各个语句计算的先后顺序与输入代码中的顺序一致。</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/20210102223609.png" alt="img"></p>
<p>乱序执行技术是处理器为提高运算速度而做出违背代码原有顺序的优化。</p>
<ul>
<li><strong>单核</strong>环境下，处理器保证做出的优化不会导致执行结果远离预期目标，但在多核环境下却并非如此。</li>
<li><strong>多核</strong>环境下， 如果存在一个核的计算任务依赖另一个核的计算任务的中间结果，而且对相关数据读写没做任何防护措施，那么其顺序性并不能靠代码的先后顺序来保证。</li>
</ul>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20210102224144.png" alt="img"></p>
<h2 id="-744"><a class="markdownIt-Anchor" href="#-744">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B.html#_2-java-%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B">#</a>2. Java 内存模型</h2>
<p><strong> <code>内存模型</code> </strong> 这个概念。我们可以理解为：<strong>在特定的操作协议下，对特定的内存或高速缓存进行读写访问的过程抽象</strong>。不同架构的物理计算机可以有不一样的内存模型，JVM 也有自己的内存模型。</p>
<p>JVM 中试图定义一种 Java 内存模型（Java Memory Model, JMM）来<strong>屏蔽各种硬件和操作系统的内存访问差异</strong>，以实现让 Java 程序 <strong>在各种平台下都能达到一致的内存访问效果</strong>。</p>
<p>在 <a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/blob/master/docs/concurrent/Java%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B.md">Java 并发简介 (opens new window)</a> 中已经介绍了，并发安全需要满足可见性、有序性、原子性。其中，导致可见性的原因是缓存，导致有序性的原因是编译优化。那解决可见性、有序性最直接的办法就是<strong>禁用缓存和编译优化</strong> 。但这么做，性能就堪忧了。</p>
<p>合理的方案应该是<strong>按需禁用缓存以及编译优化</strong>。那么，如何做到呢？，Java 内存模型规范了 JVM 如何提供按需禁用缓存和编译优化的方法。具体来说，这些方法包括 <strong>volatile</strong>、<strong>synchronized</strong> 和 <strong>final</strong> 三个关键字，以及 <strong>Happens-Before 规则</strong>。</p>
<h3 id="-745"><a class="markdownIt-Anchor" href="#-745">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B.html#_2-1-%E4%B8%BB%E5%86%85%E5%AD%98%E5%92%8C%E5%B7%A5%E4%BD%9C%E5%86%85%E5%AD%98">#</a>2.1. 主内存和工作内存</h3>
<p>JMM 的主要目标是 <strong>定义程序中各个变量的访问规则，即在虚拟机中将变量存储到内存和从内存中取出变量这样的底层细节</strong>。此处的变量（Variables）与 Java 编程中所说的变量有所区别，它包括了实例字段、静态字段和构成数值对象的元素，但不包括局部变量与方法参数，因为后者是线程私有的，不会被共享，自然就不会存在竞争问题。为了获得较好的执行效能，JMM 并没有限制执行引擎使用处理器的特定寄存器或缓存来和主存进行交互，也没有限制即使编译器进行调整代码执行顺序这类优化措施。</p>
<p>JMM 规定了<strong>所有的变量都存储在主内存（Main Memory）中</strong>。</p>
<p>每条线程还有自己的工作内存（Working Memory），<strong>工作内存中保留了该线程使用到的变量的主内存的副本</strong>。工作内存是 JMM 的一个抽象概念，并不真实存在，它涵盖了缓存，写缓冲区，寄存器以及其他的硬件和编译器优化。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20210102225839.png" alt="img"></p>
<p>线程对变量的所有操作都必须在工作内存中进行，而不能直接读写主内存中的变量。不同的线程间也无法直接访问对方工作内存中的变量，<strong>线程间变量值的传递均需要通过主内存来完成</strong>。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20210102225657.png" alt="img"></p>
<blockquote>
<p>说明：</p>
<p>这里说的主内存、工作内存与 Java 内存区域中的堆、栈、方法区等不是同一个层次的内存划分。</p>
</blockquote>
<h3 id="-746"><a class="markdownIt-Anchor" href="#-746">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B.html#_2-2-jmm-%E5%86%85%E5%AD%98%E6%93%8D%E4%BD%9C%E7%9A%84%E9%97%AE%E9%A2%98">#</a>2.2. JMM 内存操作的问题</h3>
<p>类似于物理内存模型面临的问题，JMM 存在以下两个问题：</p>
<ul>
<li>
<p><strong>工作内存数据一致性</strong> - 各个线程操作数据时会保存使用到的主内存中的共享变量副本，当多个线程的运算任务都涉及同一个共享变量时，将导致各自的的共享变量副本不一致。如果真的发生这种情况，数据同步回主内存以谁的副本数据为准？ Java 内存模型主要通过一系列的数据同步协议、规则来保证数据的一致性。</p>
</li>
<li>
<p>指令重排序优化</p>
</li>
</ul>
<p>​</p>
<pre><code>\- Java 中重排序通常是编译器或运行时环境为了优化程序性能而采取的对指令进行重新排序执行的一种手段。重排序分为两类：

编译期重排序和运行期重排序

，分别对应编译时和运行时环境。 同样的，指令重排序不是随意重排序，它需要满足以下两个条件：

- 在单线程环境下不能改变程序运行的结果。即时编译器（和处理器）需要保证程序能够遵守 `as-if-serial` 属性。通俗地说，就是在单线程情况下，要给程序一个顺序执行的假象。即经过重排序的执行结果要与顺序执行的结果保持一致。
- 存在数据依赖关系的不允许重排序。
- 多线程环境下，如果线程处理逻辑之间存在依赖关系，有可能因为指令重排序导致运行结果与预期不同。
</code></pre>
<h3 id="-747"><a class="markdownIt-Anchor" href="#-747">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B.html#_2-3-%E5%86%85%E5%AD%98%E9%97%B4%E4%BA%A4%E4%BA%92%E6%93%8D%E4%BD%9C">#</a>2.3. 内存间交互操作</h3>
<p>JMM 定义了 8 个操作来完成主内存和工作内存之间的交互操作。JVM 实现时必须保证下面介绍的每种操作都是 <strong>原子的</strong>（对于 double 和 long 型的变量来说，load、store、read、和 write 操作在某些平台上允许有例外 ）。</p>
<ul>
<li><code>lock</code>  (锁定) - 作用于<strong>主内存</strong>的变量，它把一个变量标识为一条线程独占的状态。</li>
<li><code>unlock</code>  (解锁) - 作用于<strong>主内存</strong>的变量，它把一个处于锁定状态的变量释放出来，释放后的变量才可以被其他线程锁定。</li>
<li><code>read</code>  (读取) - 作用于<strong>主内存</strong>的变量，它把一个变量的值从主内存<strong>传输</strong>到线程的工作内存中，以便随后的  <code>load</code>  动作使用。</li>
<li><code>write</code>  (写入) - 作用于<strong>主内存</strong>的变量，它把 store 操作从工作内存中得到的变量的值放入主内存的变量中。</li>
<li><code>load</code>  (载入) - 作用于<strong>工作内存</strong>的变量，它把 read 操作从主内存中得到的变量值放入工作内存的变量副本中。</li>
<li><code>use</code>  (使用) - 作用于<strong>工作内存</strong>的变量，它把工作内存中一个变量的值传递给执行引擎，每当虚拟机遇到一个需要使用到变量的值得字节码指令时就会执行这个操作。</li>
<li><code>assign</code>  (赋值) - 作用于<strong>工作内存</strong>的变量，它把一个从执行引擎接收到的值赋给工作内存的变量，每当虚拟机遇到一个给变量赋值的字节码指令时执行这个操作。</li>
<li><code>store</code>  (存储) - 作用于<strong>工作内存</strong>的变量，它把工作内存中一个变量的值传送到主内存中，以便随后  <code>write</code>  操作使用。</li>
</ul>
<p>如果要把一个变量从主内存中复制到工作内存，就<strong>需要按序执行  <code>read</code>  和  <code>load</code>  操作</strong>；如果把变量从工作内存中同步回主内存中，就<strong>需要按序执行  <code>store</code>  和  <code>write</code>  操作</strong>。但 Java 内存模型只要求上述操作必须按顺序执行，而没有保证必须是连续执行。</p>
<p>JMM 还规定了上述 8 种基本操作，需要满足以下规则：</p>
<ul>
<li><strong>read 和 load 必须成对出现</strong>；<strong>store 和 write 必须成对出现</strong>。即不允许一个变量从主内存读取了但工作内存不接受，或从工作内存发起回写了但主内存不接受的情况出现。</li>
<li><strong>不允许一个线程丢弃它的最近 assign 的操作</strong>，即变量在工作内存中改变了之后必须把变化同步到主内存中。</li>
<li><strong>不允许一个线程无原因的（没有发生过任何 assign 操作）把数据从工作内存同步回主内存中</strong>。</li>
<li>一个新的变量只能在主内存中诞生，不允许在工作内存中直接使用一个未被初始化（load 或 assign ）的变量。换句话说，就是对一个变量实施 use 和 store 操作之前，必须先执行过了 load 或 assign 操作。</li>
<li>一个变量在同一个时刻只允许一条线程对其进行 lock 操作，但 lock 操作可以被同一条线程重复执行多次，多次执行 lock 后，只有执行相同次数的 unlock 操作，变量才会被解锁。所以 <strong>lock 和 unlock 必须成对出现</strong>。</li>
<li>如果对一个变量执行 lock 操作，将会清空工作内存中此变量的值，在执行引擎使用这个变量前，需要重新执行 load 或 assign 操作初始化变量的值。</li>
<li>如果一个变量事先没有被 lock 操作锁定，则不允许对它执行 unlock 操作，也不允许去 unlock 一个被其他线程锁定的变量。</li>
<li>对一个变量执行 unlock 操作之前，必须先把此变量同步到主内存中（执行 store 和 write 操作）</li>
</ul>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/20210102230708.png" alt="img"></p>
<h3 id="-748"><a class="markdownIt-Anchor" href="#-748">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B.html#_2-4-%E5%B9%B6%E5%8F%91%E5%AE%89%E5%85%A8%E7%89%B9%E6%80%A7">#</a>2.4. 并发安全特性</h3>
<p>上文介绍了 Java 内存交互的 8 种基本操作，它们遵循 Java 内存三大特性：原子性、可见性、有序性。</p>
<p>而这三大特性，归根结底，是为了实现多线程的 <strong>数据一致性</strong>，使得程序在多线程并发，指令重排序优化的环境中能如预期运行。</p>
<h4 id="-749"><a class="markdownIt-Anchor" href="#-749">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B.html#%E5%8E%9F%E5%AD%90%E6%80%A7">#</a>原子性</h4>
<p><strong>原子性即一个操作或者多个操作，要么全部执行（执行的过程不会被任何因素打断），要么就都不执行</strong>。即使在多个线程一起执行的时候，一个操作一旦开始，就不会被其他线程所干扰。</p>
<p>在 Java 中，为了保证原子性，提供了两个高级的字节码指令  <code>monitorenter</code>  和  <code>monitorexit</code> 。这两个字节码，在 Java 中对应的关键字就是  <code>synchronized</code> 。</p>
<p>因此，在 Java 中可以使用  <code>synchronized</code>  来保证方法和代码块内的操作是原子性的。</p>
<h4 id="-750"><a class="markdownIt-Anchor" href="#-750">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B.html#%E5%8F%AF%E8%A7%81%E6%80%A7">#</a>可见性</h4>
<p><strong>可见性是指当多个线程访问同一个变量时，一个线程修改了这个变量的值，其他线程能够立即看得到修改的值</strong>。</p>
<p>JMM 是通过 <strong>&quot; 变量修改后将新值同步回主内存</strong>， <strong>变量读取前从主内存刷新变量值 &quot;</strong> 这种依赖主内存作为传递媒介的方式来实现的。</p>
<p>Java 实现多线程可见性的方式有：</p>
<ul>
<li><code>volatile</code></li>
<li><code>synchronized</code></li>
<li><code>final</code></li>
</ul>
<h4 id="-751"><a class="markdownIt-Anchor" href="#-751">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B.html#%E6%9C%89%E5%BA%8F%E6%80%A7">#</a>有序性</h4>
<p>有序性规则表现在以下两种场景：线程内和线程间</p>
<ul>
<li>线程内 - 从某个线程的角度看方法的执行，指令会按照一种叫 “串行”（ <code>as-if-serial</code> ）的方式执行，此种方式已经应用于顺序编程语言。</li>
<li>线程间 - 这个线程 “观察” 到其他线程并发地执行非同步的代码时，由于指令重排序优化，任何代码都有可能交叉执行。唯一起作用的约束是：对于同步方法，同步块（ <code>synchronized</code>  关键字修饰）以及  <code>volatile</code>  字段的操作仍维持相对有序。</li>
</ul>
<p>在 Java 中，可以使用  <code>synchronized</code>  和  <code>volatile</code>  来保证多线程之间操作的有序性。实现方式有所区别：</p>
<ul>
<li><code>volatile</code>  关键字会禁止指令重排序。</li>
<li><code>synchronized</code>  关键字通过互斥保证同一时刻只允许一条线程操作。</li>
</ul>
<h2 id="-752"><a class="markdownIt-Anchor" href="#-752">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B.html#_3-happens-before">#</a>3. Happens-Before</h2>
<p>JMM 为程序中所有的操作定义了一个偏序关系，称之为 <strong> <code>先行发生原则（Happens-Before）</code> </strong>。</p>
<p><strong>Happens-Before</strong> 是指 <strong>前面一个操作的结果对后续操作是可见的</strong>。</p>
<p><strong>Happens-Before</strong> 非常重要，它是判断数据是否存在竞争、线程是否安全的主要依据，依靠这个原则，我们可以通过几条规则一揽子地解决并发环境下两个操作间是否可能存在冲突的所有问题。</p>
<ul>
<li><strong>程序次序规则</strong> - 一个线程内，按照代码顺序，书写在前面的操作先行发生于书写在后面的操作。</li>
<li><strong>锁定规则</strong> - 一个  <code>unLock</code>  操作先行发生于后面对同一个锁的  <code>lock</code>  操作。</li>
<li><strong>volatile 变量规则</strong> - 对一个  <code>volatile</code>  变量的写操作先行发生于后面对这个变量的读操作。</li>
<li><strong>线程启动规则</strong> -  <code>Thread</code>  对象的  <code>start()</code>  方法先行发生于此线程的每个一个动作。</li>
<li><strong>线程终止规则</strong> - 线程中所有的操作都先行发生于线程的终止检测，我们可以通过  <code>Thread.join()</code>  方法结束、 <code>Thread.isAlive()</code>  的返回值手段检测到线程已经终止执行。</li>
<li><strong>线程中断规则</strong> - 对线程  <code>interrupt()</code>  方法的调用先行发生于被中断线程的代码检测到中断事件的发生，可以通过  <code>Thread.interrupted()</code>  方法检测到是否有中断发生。</li>
<li><strong>对象终结规则</strong> - 一个对象的初始化完成先行发生于它的  <code>finalize()</code>  方法的开始。</li>
<li><strong>传递性</strong> - 如果操作 A 先行发生于 操作 B，而操作 B 又 先行发生于 操作 C，则可以得出操作 A 先行发生于 操作 C。</li>
</ul>
<h2 id="-753"><a class="markdownIt-Anchor" href="#-753">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B.html#_4-%E5%86%85%E5%AD%98%E5%B1%8F%E9%9A%9C">#</a>4. 内存屏障</h2>
<p>Java 中如何保证底层操作的有序性和可见性？可以通过内存屏障（memory barrier）。</p>
<p>内存屏障是被插入两个 CPU 指令之间的一种指令，用来禁止处理器指令发生重排序（像屏障一样），从而保障<strong>有序性</strong>的。另外，为了达到屏障的效果，它也会使处理器写入、读取值之前，将主内存的值写入高速缓存，清空无效队列，从而保障<strong>可见性</strong>。</p>
<p>举个例子：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Store1;
Store2;
Load1;
StoreLoad;  //内存屏障
Store3;
Load2;
Load3;
复制代码<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>对于上面的一组 CPU 指令（Store 表示写入指令，Load 表示读取指令），StoreLoad 屏障之前的 Store 指令无法与 StoreLoad 屏障之后的 Load 指令进行交换位置，即<strong>重排序</strong>。但是 StoreLoad 屏障之前和之后的指令是可以互换位置的，即 Store1 可以和 Store2 互换，Load2 可以和 Load3 互换。</p>
<p>常见有 4 种屏障</p>
<ul>
<li><code>LoadLoad</code>  屏障 - 对于这样的语句  <code>Load1; LoadLoad; Load2</code> ，在 Load2 及后续读取操作要读取的数据被访问前，保证 Load1 要读取的数据被读取完毕。</li>
<li><code>StoreStore</code>  屏障 - 对于这样的语句  <code>Store1; StoreStore; Store2</code> ，在 Store2 及后续写入操作执行前，保证 Store1 的写入操作对其它处理器可见。</li>
<li><code>LoadStore</code>  屏障 - 对于这样的语句  <code>Load1; LoadStore; Store2</code> ，在 Store2 及后续写入操作被执行前，保证 Load1 要读取的数据被读取完毕。</li>
<li><code>StoreLoad</code>  屏障 - 对于这样的语句  <code>Store1; StoreLoad; Load2</code> ，在 Load2 及后续所有读取操作执行前，保证 Store1 的写入对所有处理器可见。它的开销是四种屏障中最大的（冲刷写缓冲器，清空无效化队列）。在大多数处理器的实现中，这个屏障是个万能屏障，兼具其它三种内存屏障的功能。</li>
</ul>
<p>Java 中对内存屏障的使用在一般的代码中不太容易见到，常见的有  <code>volatile</code>  和  <code>synchronized</code>  关键字修饰的代码块 (后面再展开介绍)，还可以通过  <code>Unsafe</code>  这个类来使用内存屏障。</p>
<h2 id="-754"><a class="markdownIt-Anchor" href="#-754">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B.html#_5-volatile">#</a>5. volatile</h2>
<p><code>volatile</code>  是 JVM 提供的 <strong>最轻量级的同步机制</strong>。</p>
<p><code>volatile</code>  的中文意思是不稳定的，易变的，用  <code>volatile</code>  修饰变量是为了保证变量在多线程中的可见性。</p>
<h4 id="-755"><a class="markdownIt-Anchor" href="#-755">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B.html#volatile-%E5%8F%98%E9%87%8F%E7%9A%84%E7%89%B9%E6%80%A7">#</a>volatile 变量的特性</h4>
<p><code>volatile</code>  变量具有两种特性：</p>
<ul>
<li>保证变量对所有线程的可见性。</li>
<li>禁止进行指令重排序</li>
</ul>
<h5 id="-756"><a class="markdownIt-Anchor" href="#-756">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B.html#%E4%BF%9D%E8%AF%81%E5%8F%98%E9%87%8F%E5%AF%B9%E6%89%80%E6%9C%89%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%8F%AF%E8%A7%81%E6%80%A7">#</a>保证变量对所有线程的可见性</h5>
<p>这里的可见性是指当一条线程修改了 volatile 变量的值，新值对于其他线程来说是可以立即得知的。而普通变量不能做到这一点，普通变量的值在线程间传递均需要通过主内存来完成。</p>
<p><strong>线程写 volatile 变量的过程：</strong></p>
<ol>
<li>改变线程工作内存中 volatile 变量副本的值</li>
<li>将改变后的副本的值从工作内存刷新到主内存</li>
</ol>
<p><strong>线程读 volatile 变量的过程：</strong></p>
<ol>
<li>从主内存中读取 volatile 变量的最新值到线程的工作内存中</li>
<li>从工作内存中读取 volatile 变量的副本</li>
</ol>
<blockquote>
<p>注意：<strong>保证可见性不等同于 volatile 变量保证并发操作的安全性</strong></p>
<p>在不符合以下两点的场景中，仍然要通过枷锁来保证原子性：</p>
<ul>
<li>运算结果并不依赖变量的当前值，或者能够确保只有单一的线程修改变量的值。</li>
<li>变量不需要与其他状态变量共同参与不变约束。</li>
</ul>
</blockquote>
<p>但是如果多个线程同时把更新后的变量值同时刷新回主内存，可能导致得到的值不是预期结果：</p>
<p>举个例子： 定义  <code>volatile int count = 0</code> ，2 个线程同时执行 count++ 操作，每个线程都执行 500 次，最终结果小于 1000，原因是每个线程执行 count++ 需要以下 3 个步骤：</p>
<ol>
<li>线程从主内存读取最新的 count 的值</li>
<li>执行引擎把 count 值加 1，并赋值给线程工作内存</li>
<li>线程工作内存把 count 值保存到主内存 有可能某一时刻 2 个线程在步骤 1 读取到的值都是 100，执行完步骤 2 得到的值都是 101，最后刷新了 2 次 101 保存到主内存。</li>
</ol>
<h5 id="-757"><a class="markdownIt-Anchor" href="#-757">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B.html#%E8%AF%AD%E4%B9%89-2-%E7%A6%81%E6%AD%A2%E8%BF%9B%E8%A1%8C%E6%8C%87%E4%BB%A4%E9%87%8D%E6%8E%92%E5%BA%8F">#</a>语义 2 禁止进行指令重排序</h5>
<p>具体一点解释，禁止重排序的规则如下：</p>
<ul>
<li>当程序执行到  <code>volatile</code>  变量的读操作或者写操作时，在其前面的操作的更改肯定全部已经进行，且结果已经对后面的操作可见；在其后面的操作肯定还没有进行；</li>
<li>在进行指令优化时，不能将在对  <code>volatile</code>  变量访问的语句放在其后面执行，也不能把  <code>volatile</code>  变量后面的语句放到其前面执行。</li>
</ul>
<p>普通的变量仅仅会保证该方法的执行过程中所有依赖赋值结果的地方都能获取到正确的结果，而不能保证赋值操作的顺序与程序代码中的执行顺序一致。</p>
<p>举个例子：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">volatile</span> <span class="token keyword">boolean</span> initialized <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

<span class="token comment">// 下面代码线程A中执行</span>
<span class="token comment">// 读取配置信息，当读取完成后将initialized设置为true以通知其他线程配置可用</span>
<span class="token function">doSomethingReadConfg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
initialized <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

<span class="token comment">// 下面代码线程B中执行</span>
<span class="token comment">// 等待initialized 为true，代表线程A已经把配置信息初始化完成</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>initialized<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
     <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// 使用线程A初始化好的配置信息</span>
<span class="token function">doSomethingWithConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
复制代码<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上面代码中如果定义 initialized 变量时没有使用 volatile 修饰，就有可能会由于指令重排序的优化，导致线程 A 中最后一句代码 “initialized = true” 在 “doSomethingReadConfg ()” 之前被执行，这样会导致线程 B 中使用配置信息的代码就可能出现错误，而 volatile 关键字就禁止重排序的语义可以避免此类情况发生。</p>
<h4 id="-758"><a class="markdownIt-Anchor" href="#-758">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B.html#volatile-%E7%9A%84%E5%8E%9F%E7%90%86">#</a>volatile 的原理</h4>
<p>具体实现方式是在编译期生成字节码时，会在指令序列中增加内存屏障来保证，下面是基于保守策略的 JMM 内存屏障插入策略：</p>
<ul>
<li>在每个 volatile 写操作的前面插入一个 StoreStore 屏障。 该屏障除了保证了屏障之前的写操作和该屏障之后的写操作不能重排序，还会保证了 volatile 写操作之前，任何的读写操作都会先于 volatile 被提交。</li>
<li>在每个 volatile 写操作的后面插入一个 StoreLoad 屏障。 该屏障除了使 volatile 写操作不会与之后的读操作重排序外，还会刷新处理器缓存，使 volatile 变量的写更新对其他线程可见。</li>
<li>在每个 volatile 读操作的后面插入一个 LoadLoad 屏障。 该屏障除了使 volatile 读操作不会与之前的写操作发生重排序外，还会刷新处理器缓存，使 volatile 变量读取的为最新值。</li>
<li>在每个 volatile 读操作的后面插入一个 LoadStore 屏障。 该屏障除了禁止了 volatile 读操作与其之后的任何写操作进行重排序，还会刷新处理器缓存，使其他线程 volatile 变量的写更新对 volatile 读操作的线程可见。</li>
</ul>
<h4 id="-759"><a class="markdownIt-Anchor" href="#-759">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B.html#volatile-%E7%9A%84%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF">#</a>volatile 的使用场景</h4>
<p>总结起来，就是 “一次写入，到处读取”，某一线程负责更新变量，其他线程只读取变量 (不更新变量)，并根据变量的新值执行相应逻辑。例如状态标志位更新，观察者模型变量值发布。</p>
<h2 id="-760"><a class="markdownIt-Anchor" href="#-760">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B.html#_6-synchronized">#</a>6. synchronized</h2>
<h3 id="-761"><a class="markdownIt-Anchor" href="#-761">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B.html#_6-1-long-%E5%92%8C-double-%E5%8F%98%E9%87%8F%E7%9A%84%E7%89%B9%E6%AE%8A%E8%A7%84%E5%88%99">#</a>6.1. long 和 double 变量的特殊规则</h3>
<p>JMM 要求 lock、unlock、read、load、assign、use、store、write 这 8 种操作都具有原子性，但是对于 64 位的数据类型（long 和 double），在模型中特别定义相对宽松的规定：允许虚拟机将没有被  <code>volatile</code>  修饰的 64 位数据的读写操作分为 2 次 32 位的操作来进行，即允许虚拟机可选择不保证 64 位数据类型的 load、store、read 和 write 这 4 个操作的原子性。由于这种非原子性，有可能导致其他线程读到同步未完成的 “32 位的半个变量” 的值。</p>
<p>不过实际开发中，Java 内存模型强烈建议虚拟机把 64 位数据的读写实现为具有原子性，目前各种平台下的商用虚拟机都选择把 64 位数据的读写操作作为原子操作来对待，因此我们在编写代码时一般不需要把用到的 long 和 double 变量专门声明为 volatile。</p>
<h3 id="-762"><a class="markdownIt-Anchor" href="#-762">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/concurrent/Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B.html#_6-2-final-%E5%9E%8B%E9%87%8F%E7%9A%84%E7%89%B9%E6%AE%8A%E8%A7%84%E5%88%99">#</a>6.2. final 型量的特殊规则</h3>
<p>我们知道，final 成员变量必须在声明的时候初始化或者在构造器中初始化，否则就会报编译错误。 final 关键字的可见性是指：被 final 修饰的字段在声明时或者构造器中，一旦初始化完成，那么在其他线程无须同步就能正确看见 final 字段的值。这是因为一旦初始化完成，final 变量的值立刻回写到主内存。</p>
<hr>
<h1 id="vm-体系结构"><a class="markdownIt-Anchor" href="#vm-体系结构">#</a> VM 体系结构</h1>
<blockquote>
<p>JVM 能跨平台工作，主要是由于 JVM 屏蔽了与各个计算机平台相关的软件、硬件之间的差异。</p>
</blockquote>
<ul>
<li>\1. JVM 简介
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-architecture.html#11-%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84">1.1. 计算机体系结构</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-architecture.html#12-jvm-%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84%E7%AE%80%E4%BB%8B">1.2. JVM 体系结构简介</a></li>
</ul>
</li>
<li>\2. Hotspot 架构
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-architecture.html#21-hotspot-%E5%85%B3%E9%94%AE%E7%BB%84%E4%BB%B6">2.1. Hotspot 关键组件</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-architecture.html#22-%E6%80%A7%E8%83%BD%E6%8C%87%E6%A0%87">2.2. 性能指标</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-architecture.html#3-%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">3. 参考资料</a></li>
</ul>
<h2 id="-763"><a class="markdownIt-Anchor" href="#-763">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-architecture.html#_1-jvm-%E7%AE%80%E4%BB%8B">#</a>1. JVM 简介</h2>
<h3 id="-764"><a class="markdownIt-Anchor" href="#-764">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-architecture.html#_1-1-%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84">#</a>1.1. 计算机体系结构</h3>
<p>真实的计算机体系结构的核心部分包含：</p>
<ul>
<li>指令集</li>
<li>计算单元（CPU）</li>
<li>寻址方式</li>
<li>寄存器</li>
<li>存储单元</li>
</ul>
<h3 id="-765"><a class="markdownIt-Anchor" href="#-765">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-architecture.html#_1-2-jvm-%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84%E7%AE%80%E4%BB%8B">#</a>1.2. JVM 体系结构简介</h3>
<p>JVM 体系结构与计算机体系结构相似，它的核心部分包含：</p>
<ul>
<li>JVM 指令集</li>
<li>类加载器</li>
<li>执行引擎 - 相当于 JVM 的 CPU</li>
<li>内存区 - JVM 的存储</li>
<li>本地方法调用 - 调用 C/C++ 实现的本地方法</li>
</ul>
<h2 id="-766"><a class="markdownIt-Anchor" href="#-766">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-architecture.html#_2-hotspot-%E6%9E%B6%E6%9E%84">#</a>2. Hotspot 架构</h2>
<p>Hotspot 是最流行的 JVM。</p>
<p>Java 虚拟机的主要组件，包括<strong>类加载器</strong>、<strong>运行时数据区</strong>和<strong>执行引擎</strong>。</p>
<p>Hotspot 虚拟机拥有一个架构，它支持强大特性和能力的基础平台，支持实现高性能和强大的可伸缩性的能力。举个例子，Hotspot 虚拟机 JIT 编译器生成动态的优化，换句话说，它们在 Java 应用执行期做出优化，为底层系统架构生成高性能的本地机器指令。另外，经过它的运行时环境和多线程垃圾回收成熟的进化和连续的设计， Hotspot 虚拟机在高可用计算系统上产出了高伸缩性。</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/jvm-hotspot-architecture.png" alt="img"></p>
<h3 id="-767"><a class="markdownIt-Anchor" href="#-767">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-architecture.html#_2-1-hotspot-%E5%85%B3%E9%94%AE%E7%BB%84%E4%BB%B6">#</a>2.1. Hotspot 关键组件</h3>
<p>Java 虚拟机有三个组件关注着什么时候进行性能优化，堆空间是对象所存储的地方，这个区域被启动时选择的垃圾回收器管理，大部分调优选项与调整堆大小和根据你的情况选择最适当的垃圾收集器相关。即时编译器对性能也有很大的影响，但是使用新版本的 Java 虚拟机时很少需要调整。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/cs/java/javacore/jvm/jvm-hotspot-key-components.png" alt="img"></p>
<h3 id="-768"><a class="markdownIt-Anchor" href="#-768">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-architecture.html#_2-2-%E6%80%A7%E8%83%BD%E6%8C%87%E6%A0%87">#</a>2.2. 性能指标</h3>
<p>Java 虚拟机的性能指标主要有两点：</p>
<ul>
<li>停顿时间</li>
</ul>
<p>​</p>
<pre><code>\- 响应延迟是指一个应用回应一个请求的速度有多快。对关注响应能力的应用来说，长暂停时间是不可接受的，重点是在短的时间周期内能做出响应。

- 桌面 UI 响应事件的速度
- 网站返回网页的速度
- 数据查询返回的速度
</code></pre>
<ul>
<li>吞吐量</li>
</ul>
<p>​</p>
<pre><code>\- 吞吐量关注在特定的时间周期内一个应用的工作量的最大值。对关注吞吐量的应用来说长暂停时间是可以接受的。由于高吞吐量的应用关注的基准在更长周期时间上，所以快速响应时间不在考虑之内。

- 给定时间内完成事务的数量
- 一小时内批处理程序完成的工作数量
- 一小时内数据查询完成的数量
</code></pre>
<hr>
<h1 id="java-内存管理"><a class="markdownIt-Anchor" href="#java-内存管理">#</a> Java 内存管理</h1>
<blockquote>
<p><strong>📦 本文以及示例源码已归档在 <a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/">javacore(opens new window)</a></strong></p>
</blockquote>
<ul>
<li>\1. 内存简介
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-memory.html#11-%E7%89%A9%E7%90%86%E5%86%85%E5%AD%98%E5%92%8C%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98">1.1. 物理内存和虚拟内存</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-memory.html#12-%E5%86%85%E6%A0%B8%E7%A9%BA%E9%97%B4%E5%92%8C%E7%94%A8%E6%88%B7%E7%A9%BA%E9%97%B4">1.2. 内核空间和用户空间</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-memory.html#13-%E4%BD%BF%E7%94%A8%E5%86%85%E5%AD%98%E7%9A%84-java-%E7%BB%84%E4%BB%B6">1.3. 使用内存的 Java 组件</a></li>
</ul>
</li>
<li>\2. 运行时数据区域
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-memory.html#21-%E7%A8%8B%E5%BA%8F%E8%AE%A1%E6%95%B0%E5%99%A8">2.1. 程序计数器</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-memory.html#22-java-%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%A0%88">2.2. Java 虚拟机栈</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-memory.html#23-%E6%9C%AC%E5%9C%B0%E6%96%B9%E6%B3%95%E6%A0%88">2.3. 本地方法栈</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-memory.html#24-java-%E5%A0%86">2.4. Java 堆</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-memory.html#25-%E6%96%B9%E6%B3%95%E5%8C%BA">2.5. 方法区</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-memory.html#26-%E8%BF%90%E8%A1%8C%E6%97%B6%E5%B8%B8%E9%87%8F%E6%B1%A0">2.6. 运行时常量池</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-memory.html#27-%E7%9B%B4%E6%8E%A5%E5%86%85%E5%AD%98">2.7. 直接内存</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-memory.html#28-java-%E5%86%85%E5%AD%98%E5%8C%BA%E5%9F%9F%E5%AF%B9%E6%AF%94">2.8. Java 内存区域对比</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-memory.html#3-jvm-%E8%BF%90%E8%A1%8C%E5%8E%9F%E7%90%86">3. JVM 运行原理</a></li>
<li>\4. OutOfMemoryError
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-memory.html#41-%E4%BB%80%E4%B9%88%E6%98%AF-outofmemoryerror">4.1. 什么是 OutOfMemoryError</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-memory.html#42-%E5%A0%86%E7%A9%BA%E9%97%B4%E6%BA%A2%E5%87%BA">4.2. 堆空间溢出</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-memory.html#43-gc-%E5%BC%80%E9%94%80%E8%B6%85%E8%BF%87%E9%99%90%E5%88%B6">4.3. GC 开销超过限制</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-memory.html#44-%E6%B0%B8%E4%B9%85%E4%BB%A3%E7%A9%BA%E9%97%B4%E4%B8%8D%E8%B6%B3">4.4. 永久代空间不足</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-memory.html#45-%E5%85%83%E6%95%B0%E6%8D%AE%E5%8C%BA%E7%A9%BA%E9%97%B4%E4%B8%8D%E8%B6%B3">4.5. 元数据区空间不足</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-memory.html#46-%E6%97%A0%E6%B3%95%E6%96%B0%E5%BB%BA%E6%9C%AC%E5%9C%B0%E7%BA%BF%E7%A8%8B">4.6. 无法新建本地线程</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-memory.html#47-%E7%9B%B4%E6%8E%A5%E5%86%85%E5%AD%98%E6%BA%A2%E5%87%BA">4.7. 直接内存溢出</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-memory.html#5-stackoverflowerror">5. StackOverflowError</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-memory.html#6-%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">6. 参考资料</a></li>
</ul>
<h2 id="-769"><a class="markdownIt-Anchor" href="#-769">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-memory.html#_1-%E5%86%85%E5%AD%98%E7%AE%80%E4%BB%8B">#</a>1. 内存简介</h2>
<h3 id="-770"><a class="markdownIt-Anchor" href="#-770">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-memory.html#_1-1-%E7%89%A9%E7%90%86%E5%86%85%E5%AD%98%E5%92%8C%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98">#</a>1.1. 物理内存和虚拟内存</h3>
<p>所谓物理内存就是通常所说的 RAM（随机存储器）。</p>
<p>虚拟内存使得多个进程在同时运行时可以共享物理内存，这里的共享只是空间上共享，在逻辑上彼此仍然是隔离的。</p>
<h3 id="-771"><a class="markdownIt-Anchor" href="#-771">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-memory.html#_1-2-%E5%86%85%E6%A0%B8%E7%A9%BA%E9%97%B4%E5%92%8C%E7%94%A8%E6%88%B7%E7%A9%BA%E9%97%B4">#</a>1.2. 内核空间和用户空间</h3>
<p>一个计算通常有固定大小的内存空间，但是程序并不能使用全部的空间。因为这些空间被划分为内核空间和用户空间，而程序只能使用用户空间的内存。</p>
<h3 id="-772"><a class="markdownIt-Anchor" href="#-772">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-memory.html#_1-3-%E4%BD%BF%E7%94%A8%E5%86%85%E5%AD%98%E7%9A%84-java-%E7%BB%84%E4%BB%B6">#</a>1.3. 使用内存的 Java 组件</h3>
<p>Java 启动后，作为一个进程运行在操作系统中。</p>
<p>有哪些 Java 组件需要占用内存呢？</p>
<ul>
<li>堆内存：Java 堆、类和类加载器</li>
<li>栈内存：线程</li>
<li>本地内存：NIO、JNI</li>
</ul>
<h2 id="-773"><a class="markdownIt-Anchor" href="#-773">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-memory.html#_2-%E8%BF%90%E8%A1%8C%E6%97%B6%E6%95%B0%E6%8D%AE%E5%8C%BA%E5%9F%9F">#</a>2. 运行时数据区域</h2>
<p>JVM 在执行 Java 程序的过程中会把它所管理的内存划分为若干个不同的数据区域。这些区域都有各自的用途，以及创建和销毁的时间，有的区域随着虚拟机进程的启动而存在，有些区域则依赖用户线程的启动和结束而建立和销毁。如下图所示：</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/jvm-memory-runtime-data-area.png" alt="img"></p>
<h3 id="-774"><a class="markdownIt-Anchor" href="#-774">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-memory.html#_2-1-%E7%A8%8B%E5%BA%8F%E8%AE%A1%E6%95%B0%E5%99%A8">#</a>2.1. 程序计数器</h3>
<p><strong> <code>程序计数器（Program Counter Register）</code> </strong> 是一块较小的内存空间，它可以看做是<strong>当前线程所执行的字节码的行号指示器</strong>。例如，分支、循环、跳转、异常、线程恢复等都依赖于计数器。</p>
<p>当执行的线程数量超过 CPU 数量时，线程之间会根据时间片轮询争夺 CPU 资源。如果一个线程的时间片用完了，或者是其它原因导致这个线程的 CPU 资源被提前抢夺，那么这个退出的线程就需要单独的一个程序计数器，来记录下一条运行的指令，从而在线程切换后能恢复到正确的执行位置。各条线程间的计数器互不影响，独立存储，我们称这类内存区域为 “线程私有” 的内存。</p>
<ul>
<li>如果线程正在执行的是一个 Java 方法，这个计数器记录的是正在执行的虚拟机字节码指令的地址；</li>
<li>如果正在执行的是 Native 方法，这个计数器值则为空（Undefined）。</li>
</ul>
<blockquote>
<p>🔔 注意：此内存区域是唯一一个在 JVM 中没有规定任何  <code>OutOfMemoryError</code>  情况的区域。</p>
</blockquote>
<h3 id="-775"><a class="markdownIt-Anchor" href="#-775">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-memory.html#_2-2-java-%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%A0%88">#</a>2.2. Java 虚拟机栈</h3>
<p><strong> <code>Java 虚拟机栈（Java Virtual Machine Stacks）</code> </strong> 也<strong>是线程私有的，它的生命周期与线程相同</strong>。</p>
<p>每个 Java 方法在执行的同时都会创建一个栈帧（Stack Frame）用于存储 <strong>局部变量表</strong>、<strong>操作数栈</strong>、<strong>常量池引用</strong> 等信息。每一个方法从调用直至执行完成的过程，就对应着一个栈帧在 Java 虚拟机栈中入栈和出栈的过程。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/cs/java/javacore/jvm/jvm-stack.png!w640" alt="img"></p>
<ul>
<li><strong>局部变量表</strong> - 32 位变量槽，存放了编译期可知的各种基本数据类型、对象引用、 <code>ReturnAddress</code>  类型。</li>
<li><strong>操作数栈</strong> - 基于栈的执行引擎，虚拟机把操作数栈作为它的工作区，大多数指令都要从这里弹出数据、执行运算，然后把结果压回操作数栈。</li>
<li><strong>动态链接</strong> - 每个栈帧都包含一个指向运行时常量池（方法区的一部分）中该栈帧所属方法的引用。持有这个引用是为了支持方法调用过程中的动态连接。Class 文件的常量池中有大量的符号引用，字节码中的方法调用指令就以常量池中指向方法的符号引用为参数。这些符号引用一部分会在类加载阶段或第一次使用的时候转化为直接引用，这种转化称为静态解析。另一部分将在每一次的运行期间转化为直接应用，这部分称为动态链接。</li>
<li><strong>方法出口</strong> - 返回方法被调用的位置，恢复上层方法的局部变量和操作数栈，如果无返回值，则把它压入调用者的操作数栈。</li>
</ul>
<blockquote>
<p>🔔 注意：</p>
<p>该区域可能抛出以下异常：</p>
<ul>
<li>如果线程请求的栈深度超过最大值，就会抛出  <code>StackOverflowError</code>  异常；</li>
<li>如果虚拟机栈进行动态扩展时，无法申请到足够内存，就会抛出  <code>OutOfMemoryError</code>  异常。</li>
</ul>
<p>💡 提示：</p>
<p>可以通过  <code>-Xss</code>  这个虚拟机参数来指定一个程序的 Java 虚拟机栈内存大小：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">java <span class="token operator">-</span><span class="token class-name">Xss</span><span class="token operator">=</span><span class="token number">512</span>M <span class="token class-name">HackTheJava</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</blockquote>
<h3 id="-776"><a class="markdownIt-Anchor" href="#-776">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-memory.html#_2-3-%E6%9C%AC%E5%9C%B0%E6%96%B9%E6%B3%95%E6%A0%88">#</a>2.3. 本地方法栈</h3>
<p><strong> <code>本地方法栈（Native Method Stack）</code> </strong> 与虚拟机栈的作用相似。</p>
<p>二者的区别在于：<strong>虚拟机栈为 Java 方法服务；本地方法栈为 Native 方法服务</strong>。本地方法并不是用 Java 实现的，而是由 C 语言实现的。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/cs/java/javacore/jvm/jvm-native-method-stack.gif!w640" alt="img"></p>
<blockquote>
<p>🔔 注意：本地方法栈也会抛出  <code>StackOverflowError</code>  异常和  <code>OutOfMemoryError</code>  异常。</p>
</blockquote>
<h3 id="-777"><a class="markdownIt-Anchor" href="#-777">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-memory.html#_2-4-java-%E5%A0%86">#</a>2.4. Java 堆</h3>
<p><strong> <code>Java 堆（Java Heap）</code>  的作用就是存放对象实例，几乎所有的对象实例都是在这里分配内存</strong>。</p>
<p>Java 堆是垃圾收集的主要区域（因此也被叫做 &quot;GC 堆&quot;）。现代的垃圾收集器基本都是采用<strong>分代收集算法</strong>，该算法的思想是针对不同的对象采取不同的垃圾回收算法。</p>
<p>因此虚拟机把 Java 堆分成以下三块：</p>
<ul>
<li><code>新生代（Young Generation）</code>
<ul>
<li><code>Eden</code>  - Eden 和 Survivor 的比例为 8:1</li>
<li><code>From Survivor</code></li>
<li><code>To Survivor</code></li>
</ul>
</li>
<li><strong> <code>老年代（Old Generation）</code> </strong></li>
<li><strong> <code>永久代（Permanent Generation）</code> </strong></li>
</ul>
<p>当一个对象被创建时，它首先进入新生代，之后有可能被转移到老年代中。新生代存放着大量的生命很短的对象，因此新生代在三个区域中垃圾回收的频率最高。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/cs/java/javacore/jvm/jvm-heap.gif!w640" alt="img"></p>
<blockquote>
<p>🔔 注意：Java 堆不需要连续内存，并且可以动态扩展其内存，扩展失败会抛出  <code>OutOfMemoryError</code>  异常。</p>
<p>💡 提示：可以通过  <code>-Xms</code>  和  <code>-Xmx</code>  两个虚拟机参数来指定一个程序的 Java 堆内存大小，第一个参数设置初始值，第二个参数设置最大值。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">java <span class="token operator">-</span><span class="token class-name">Xms</span><span class="token operator">=</span><span class="token number">1</span>M <span class="token operator">-</span><span class="token class-name">Xmx</span><span class="token operator">=</span><span class="token number">2</span>M <span class="token class-name">HackTheJava</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</blockquote>
<h3 id="-778"><a class="markdownIt-Anchor" href="#-778">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-memory.html#_2-5-%E6%96%B9%E6%B3%95%E5%8C%BA">#</a>2.5. 方法区</h3>
<p>方法区（Method Area）也被称为永久代。<strong>方法区用于存放已被加载的类信息、常量、静态变量、即时编译器编译后的代码等数据</strong>。</p>
<p>对这块区域进行垃圾回收的主要目标是对常量池的回收和对类的卸载，但是一般比较难实现。</p>
<blockquote>
<p>🔔 注意：和 Java 堆一样不需要连续的内存，并且可以动态扩展，动态扩展失败一样会抛出  <code>OutOfMemoryError</code>  异常。</p>
<p>💡 提示：</p>
<ul>
<li>JDK 1.7 之前，HotSpot 虚拟机把它当成永久代来进行垃圾回收。可通过参数  <code>-XX:PermSize</code>  和  <code>-XX:MaxPermSize</code>  设置。</li>
<li>JDK 1.8 之后，取消了永久代，用 ** <code>metaspace（元数据）</code> ** 区替代。可通过参数  <code>-XX:MaxMetaspaceSize</code>  设置。</li>
</ul>
</blockquote>
<h3 id="-779"><a class="markdownIt-Anchor" href="#-779">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-memory.html#_2-6-%E8%BF%90%E8%A1%8C%E6%97%B6%E5%B8%B8%E9%87%8F%E6%B1%A0">#</a>2.6. 运行时常量池</h3>
<p><strong> <code>运行时常量池（Runtime Constant Pool）</code>  是方法区的一部分</strong>，Class 文件中除了有类的版本、字段、方法、接口等描述信息，还有一项信息是常量池（Constant Pool Table），<strong>用于存放编译器生成的各种字面量和符号引用</strong>，这部分内容会在类加载后被放入这个区域。</p>
<ul>
<li><strong>字面量</strong> - 文本字符串、声明为  <code>final</code>  的常量值等。</li>
<li><strong>符号引用</strong> - 类和接口的完全限定名（Fully Qualified Name）、字段的名称和描述符（Descriptor）、方法的名称和描述符。</li>
</ul>
<p>除了在编译期生成的常量，还允许动态生成，例如  <code>String</code>  类的  <code>intern()</code> 。这部分常量也会被放入运行时常量池。</p>
<blockquote>
<p>🔔 注意：当常量池无法再申请到内存时会抛出  <code>OutOfMemoryError</code>  异常。</p>
</blockquote>
<h3 id="-780"><a class="markdownIt-Anchor" href="#-780">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-memory.html#_2-7-%E7%9B%B4%E6%8E%A5%E5%86%85%E5%AD%98">#</a>2.7. 直接内存</h3>
<p>直接内存（Direct Memory）并不是虚拟机运行时数据区的一部分，也不是 JVM 规范中定义的内存区域。</p>
<p>在 JDK 1.4 中新加入了 NIO 类，它可以使用 Native 函数库直接分配堆外内存，然后通过一个存储在 Java 堆里的  <code>DirectByteBuffer</code>  对象作为这块内存的引用进行操作。这样能在一些场景中显著提高性能，因为避免了在 Java 堆和 Native 堆中来回复制数据。</p>
<blockquote>
<p>🔔 注意：直接内存这部分也被频繁的使用，且也可能导致  <code>OutOfMemoryError</code>  异常。</p>
<p>💡 提示：直接内存容量可通过  <code>-XX:MaxDirectMemorySize</code>  指定，如果不指定，则默认与 Java 堆最大值（ <code>-Xmx</code>  指定）一样。</p>
</blockquote>
<h3 id="-781"><a class="markdownIt-Anchor" href="#-781">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-memory.html#_2-8-java-%E5%86%85%E5%AD%98%E5%8C%BA%E5%9F%9F%E5%AF%B9%E6%AF%94">#</a>2.8. Java 内存区域对比</h3>
<table>
<thead>
<tr>
<th>内存区域</th>
<th>内存作用范围</th>
<th>异常</th>
</tr>
</thead>
<tbody>
<tr>
<td>程序计数器</td>
<td>线程私有</td>
<td>无</td>
</tr>
<tr>
<td>Java 虚拟机栈</td>
<td>线程私有</td>
<td><code>StackOverflowError</code>  和  <code>OutOfMemoryError</code></td>
</tr>
<tr>
<td>本地方法栈</td>
<td>线程私有</td>
<td><code>StackOverflowError</code>  和  <code>OutOfMemoryError</code></td>
</tr>
<tr>
<td>Java 堆</td>
<td>线程共享</td>
<td><code>OutOfMemoryError</code></td>
</tr>
<tr>
<td>方法区</td>
<td>线程共享</td>
<td><code>OutOfMemoryError</code></td>
</tr>
<tr>
<td>运行时常量池</td>
<td>线程共享</td>
<td><code>OutOfMemoryError</code></td>
</tr>
<tr>
<td>直接内存</td>
<td>非运行时数据区</td>
<td><code>OutOfMemoryError</code></td>
</tr>
</tbody>
</table>
<h2 id="-782"><a class="markdownIt-Anchor" href="#-782">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-memory.html#_3-jvm-%E8%BF%90%E8%A1%8C%E5%8E%9F%E7%90%86">#</a>3. JVM 运行原理</h2>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JVMCase</span> <span class="token punctuation">&#123;</span>

	<span class="token comment">// 常量</span>
	<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> MAN_SEX_TYPE <span class="token operator">=</span> <span class="token string">"man"</span><span class="token punctuation">;</span>

	<span class="token comment">// 静态变量</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> WOMAN_SEX_TYPE <span class="token operator">=</span> <span class="token string">"woman"</span><span class="token punctuation">;</span>

	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

		<span class="token class-name">Student</span> stu <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		stu<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"nick"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		stu<span class="token punctuation">.</span><span class="token function">setSexType</span><span class="token punctuation">(</span>MAN_SEX_TYPE<span class="token punctuation">)</span><span class="token punctuation">;</span>
		stu<span class="token punctuation">.</span><span class="token function">setAge</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token class-name">JVMCase</span> jvmcase <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JVMCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 调用静态方法</span>
		<span class="token function">print</span><span class="token punctuation">(</span>stu<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 调用非静态方法</span>
		jvmcase<span class="token punctuation">.</span><span class="token function">sayHello</span><span class="token punctuation">(</span>stu<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>


	<span class="token comment">// 常规静态方法</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token class-name">Student</span> stu<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"name: "</span> <span class="token operator">+</span> stu<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"; sex:"</span> <span class="token operator">+</span> stu<span class="token punctuation">.</span><span class="token function">getSexType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"; age:"</span> <span class="token operator">+</span> stu<span class="token punctuation">.</span><span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>


	<span class="token comment">// 非静态方法</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token class-name">Student</span> stu<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>stu<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"say: hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">&#123;</span>
	<span class="token class-name">String</span> name<span class="token punctuation">;</span>
	<span class="token class-name">String</span> sexType<span class="token punctuation">;</span>
	<span class="token keyword">int</span> age<span class="token punctuation">;</span>

	<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> name<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setName</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getSexType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> sexType<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setSexType</span><span class="token punctuation">(</span><span class="token class-name">String</span> sexType<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>sexType <span class="token operator">=</span> sexType<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> age<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAge</span><span class="token punctuation">(</span><span class="token keyword">int</span> age<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>运行以上代码时，JVM 处理过程如下：</p>
<p>（1）JVM 向操作系统申请内存，JVM 第一步就是通过配置参数或者默认配置参数向操作系统申请内存空间，根据内存大小找到具体的内存分配表，然后把内存段的起始地址和终止地址分配给 JVM，接下来 JVM 就进行内部分配。</p>
<p>（2）JVM 获得内存空间后，会根据配置参数分配堆、栈以及方法区的内存大小。</p>
<p>（3）class 文件加载、验证、准备以及解析，其中准备阶段会为类的静态变量分配内存，初始化为系统的初始值（这部分我在第 21 讲还会详细介绍）。</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/20200630094250.png" alt="img"></p>
<p>（4）完成上一个步骤后，将会进行最后一个初始化阶段。在这个阶段中，JVM 首先会执行构造器  <code>&lt;clinit&gt;</code>  方法，编译器会在  <code>.java</code>  文件被编译成  <code>.class</code>  文件时，收集所有类的初始化代码，包括静态变量赋值语句、静态代码块、静态方法，收集在一起成为  <code>&lt;clinit&gt;()</code>  方法。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200630094329.png" alt="img"></p>
<p>（5）执行方法。启动 main 线程，执行 main 方法，开始执行第一行代码。此时堆内存中会创建一个 student 对象，对象引用 student 就存放在栈中。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200630094651.png" alt="img"></p>
<p>（6）此时再次创建一个 JVMCase 对象，调用 sayHello 非静态方法，sayHello 方法属于对象 JVMCase，此时 sayHello 方法入栈，并通过栈中的 student 引用调用堆中的 Student 对象；之后，调用静态方法 print，print 静态方法属于 JVMCase 类，是从静态方法中获取，之后放入到栈中，也是通过 student 引用调用堆中的 student 对象。</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/20200630094714.png" alt="img"></p>
<h2 id="-783"><a class="markdownIt-Anchor" href="#-783">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-memory.html#_4-outofmemoryerror">#</a>4. OutOfMemoryError</h2>
<h3 id="-784"><a class="markdownIt-Anchor" href="#-784">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-memory.html#_4-1-%E4%BB%80%E4%B9%88%E6%98%AF-outofmemoryerror">#</a>4.1. 什么是 OutOfMemoryError</h3>
<p><code>OutOfMemoryError</code>  简称为 OOM。Java 中对 OOM 的解释是，没有空闲内存，并且垃圾收集器也无法提供更多内存。通俗的解释是：JVM 内存不足了。</p>
<p>在 JVM 规范中，<strong>除了程序计数器区域外，其他运行时区域都可能发生  <code>OutOfMemoryError</code>  异常（简称 OOM）</strong>。</p>
<p>下面逐一介绍 OOM 发生场景。</p>
<h3 id="-785"><a class="markdownIt-Anchor" href="#-785">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-memory.html#_4-2-%E5%A0%86%E7%A9%BA%E9%97%B4%E6%BA%A2%E5%87%BA">#</a>4.2. 堆空间溢出</h3>
<p><code>java.lang.OutOfMemoryError: Java heap space</code>  这个错误意味着：<strong>堆空间溢出</strong>。</p>
<p>更细致的说法是：Java 堆内存已经达到  <code>-Xmx</code>  设置的最大值。Java 堆用于存储对象实例，只要不断地创建对象，并且保证 GC Roots 到对象之间有可达路径来避免垃圾收集器回收这些对象，那么当堆空间到达最大容量限制后就会产生 OOM。</p>
<p>堆空间溢出有可能是 ** <code>内存泄漏（Memory Leak）</code> ** 或 <strong> <code>内存溢出（Memory Overflow）</code> </strong> 。需要使用 jstack 和 jmap 生成 threaddump 和 heapdump，然后用内存分析工具（如：MAT）进行分析。</p>
<h4 id="-786"><a class="markdownIt-Anchor" href="#-786">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-memory.html#java-heap-space-%E5%88%86%E6%9E%90%E6%AD%A5%E9%AA%A4">#</a>Java heap space 分析步骤</h4>
<ol>
<li>使用  <code>jmap</code>  或  <code>-XX:+HeapDumpOnOutOfMemoryError</code>  获取堆快照。</li>
<li>使用内存分析工具（visualvm、mat、jProfile 等）对堆快照文件进行分析。</li>
<li>根据分析图，重点是确认内存中的对象是否是必要的，分清究竟是是内存泄漏（Memory Leak）还是内存溢出（Memory Overflow）。</li>
</ol>
<h4 id="-787"><a class="markdownIt-Anchor" href="#-787">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-memory.html#%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F">#</a>内存泄漏</h4>
<p><strong>内存泄漏是指由于疏忽或错误造成程序未能释放已经不再使用的内存的情况</strong>。</p>
<p>内存泄漏并非指内存在物理上的消失，而是应用程序分配某段内存后，由于设计错误，失去了对该段内存的控制，因而造成了内存的浪费。内存泄漏随着被执行的次数不断增加，最终会导致内存溢出。</p>
<p>内存泄漏常见场景：</p>
<ul>
<li>静态容器
<ul>
<li>声明为静态（ <code>static</code> ）的  <code>HashMap</code> 、 <code>Vector</code>  等集合</li>
<li>通俗来讲 A 中有 B，当前只把 B 设置为空，A 没有设置为空，回收时 B 无法回收。因为被 A 引用。</li>
</ul>
</li>
<li>监听器
<ul>
<li>监听器被注册后释放对象时没有删除监听器</li>
</ul>
</li>
<li>物理连接
<ul>
<li>各种连接池建立了连接，必须通过  <code>close()</code>  关闭链接</li>
</ul>
</li>
<li>内部类和外部模块等的引用
<ul>
<li>发现它的方式同内存溢出，可再加个实时观察</li>
<li><code>jstat -gcutil 7362 2500 70</code></li>
</ul>
</li>
</ul>
<p>重点关注：</p>
<ul>
<li><code>FGC</code>  — 从应用程序启动到采样时发生 Full GC 的次数。</li>
<li><code>FGCT</code>  — 从应用程序启动到采样时 Full GC 所用的时间（单位秒）。</li>
<li><code>FGC</code>  次数越多， <code>FGCT</code>  所需时间越多，越有可能存在内存泄漏。</li>
</ul>
<p>如果是内存泄漏，可以进一步查看泄漏对象到 GC Roots 的对象引用链。这样就能找到泄漏对象是怎样与 GC Roots 关联并导致 GC 无法回收它们的。掌握了这些原因，就可以较准确的定位出引起内存泄漏的代码。</p>
<p>导致内存泄漏的常见原因是使用容器，且不断向容器中添加元素，但没有清理，导致容器内存不断膨胀。</p>
<p>【示例】</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 内存泄漏示例
 * 错误现象：java.lang.OutOfMemoryError: Java heap space
 * VM Args：-verbose:gc -Xms10M -Xmx10M -XX:+HeapDumpOnOutOfMemoryError
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HeapOutOfMemoryDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OomObject</span><span class="token punctuation">></span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">OomObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">OomObject</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-788"><a class="markdownIt-Anchor" href="#-788">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-memory.html#%E5%86%85%E5%AD%98%E6%BA%A2%E5%87%BA">#</a>内存溢出</h4>
<p>如果不存在内存泄漏，即内存中的对象确实都必须存活着，则应当检查虚拟机的堆参数（ <code>-Xmx</code>  和  <code>-Xms</code> ），与机器物理内存进行对比，看看是否可以调大。并从代码上检查是否存在某些对象生命周期过长、持有时间过长的情况，尝试减少程序运行期的内存消耗。</p>
<p>【示例】</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 堆溢出示例
 * &lt;p>
 * 错误现象：java.lang.OutOfMemoryError: Java heap space
 * &lt;p>
 * VM Args：-verbose:gc -Xms10M -Xmx10M
 *
 * @author &lt;a href="mailto:forbreak@163.com">Zhang Peng&lt;/a>
 * @since 2019-06-25
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HeapOutOfMemoryDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Double</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Double</span><span class="token punctuation">[</span><span class="token number">999999999</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"array length = ["</span> <span class="token operator">+</span> array<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>执行  <code>java -verbose:gc -Xms10M -Xmx10M -XX:+HeapDumpOnOutOfMemoryError io.github.dunwu.javacore.jvm.memory.HeapMemoryLeakMemoryErrorDemo</code></p>
<p>上面的例子是一个极端的例子，试图创建一个维度很大的数组，堆内存无法分配这么大的内存，从而报错： <code>Java heap space</code> 。</p>
<p>但如果在现实中，代码并没有问题，仅仅是因为堆内存不足，可以通过  <code>-Xms</code>  和  <code>-Xmx</code>  适当调整堆内存大小。</p>
<h3 id="-789"><a class="markdownIt-Anchor" href="#-789">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-memory.html#_4-3-gc-%E5%BC%80%E9%94%80%E8%B6%85%E8%BF%87%E9%99%90%E5%88%B6">#</a>4.3. GC 开销超过限制</h3>
<p><code>java.lang.OutOfMemoryError: GC overhead limit exceeded</code>  这个错误，官方给出的定义是：<strong>超过  <code>98%</code>  的时间用来做 GC 并且回收了不到  <code>2%</code>  的堆内存时会抛出此异常</strong>。这意味着，发生在 GC 占用大量时间为释放很小空间的时候发生的，是一种保护机制。导致异常的原因：一般是因为堆太小，没有足够的内存。</p>
<p>【示例】</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * GC overhead limit exceeded 示例
 * 错误现象：java.lang.OutOfMemoryError: GC overhead limit exceeded
 * 发生在GC占用大量时间为释放很小空间的时候发生的，是一种保护机制。导致异常的原因：一般是因为堆太小，没有足够的内存。
 * 官方对此的定义：超过98%的时间用来做GC并且回收了不到2%的堆内存时会抛出此异常。
 * VM Args: -Xms10M -Xmx10M
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GcOverheadLimitExceededDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Double</span><span class="token punctuation">></span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">double</span> d <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>d<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>【处理】</p>
<p>与 <strong>Java heap space</strong> 错误处理方法类似，先判断是否存在内存泄漏。如果有，则修正代码；如果没有，则通过  <code>-Xms</code>  和  <code>-Xmx</code>  适当调整堆内存大小。</p>
<h3 id="-790"><a class="markdownIt-Anchor" href="#-790">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-memory.html#_4-4-%E6%B0%B8%E4%B9%85%E4%BB%A3%E7%A9%BA%E9%97%B4%E4%B8%8D%E8%B6%B3">#</a>4.4. 永久代空间不足</h3>
<p>【错误】</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">java.lang.OutOfMemoryError: PermGen space<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>【原因】</p>
<p>Perm （永久代）空间主要用于存放  <code>Class</code>  和 Meta 信息，包括类的名称和字段，带有方法字节码的方法，常量池信息，与类关联的对象数组和类型数组以及即时编译器优化。GC 在主程序运行期间不会对永久代空间进行清理，默认是 64M 大小。</p>
<p>根据上面的定义，可以得出 <strong>PermGen 大小要求取决于加载的类的数量以及此类声明的大小</strong>。因此，可以说造成该错误的主要原因是永久代中装入了太多的类或太大的类。</p>
<p>在 JDK8 之前的版本中，可以通过  <code>-XX:PermSize</code>  和  <code>-XX:MaxPermSize</code>  设置永久代空间大小，从而限制方法区大小，并间接限制其中常量池的容量。</p>
<h4 id="-791"><a class="markdownIt-Anchor" href="#-791">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-memory.html#%E5%88%9D%E5%A7%8B%E5%8C%96%E6%97%B6%E6%B0%B8%E4%B9%85%E4%BB%A3%E7%A9%BA%E9%97%B4%E4%B8%8D%E8%B6%B3">#</a>初始化时永久代空间不足</h4>
<p>【示例】</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 永久代内存空间不足示例
 * &lt;p>
 * 错误现象：
 * &lt;ul>
 * &lt;li>java.lang.OutOfMemoryError: PermGen space (JDK8 以前版本)&lt;/li>
 * &lt;li>java.lang.OutOfMemoryError: Metaspace (JDK8 及以后版本)&lt;/li>
 * &lt;/ul>
 * VM Args:
 * &lt;ul>
 * &lt;li>-Xmx100M -XX:MaxPermSize=16M (JDK8 以前版本)&lt;/li>
 * &lt;li>-Xmx100M -XX:MaxMetaspaceSize=16M (JDK8 及以后版本)&lt;/li>
 * &lt;/ul>
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PermOutOfMemoryErrorDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100_000_000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">generate</span><span class="token punctuation">(</span><span class="token string">"eu.plumbr.demo.Generated"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Class</span> <span class="token function">generate</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ClassPool</span> pool <span class="token operator">=</span> <span class="token class-name">ClassPool</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> pool<span class="token punctuation">.</span><span class="token function">makeClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在此示例中，源代码遍历循环并在运行时生成类。javassist 库正在处理类生成的复杂性。</p>
<h4 id="-792"><a class="markdownIt-Anchor" href="#-792">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-memory.html#%E9%87%8D%E9%83%A8%E7%BD%B2%E6%97%B6%E6%B0%B8%E4%B9%85%E4%BB%A3%E7%A9%BA%E9%97%B4%E4%B8%8D%E8%B6%B3">#</a>重部署时永久代空间不足</h4>
<p>对于更复杂，更实际的示例，让我们逐步介绍一下在应用程序重新部署期间发生的 Permgen 空间错误。重新部署应用程序时，你希望垃圾回收会摆脱引用所有先前加载的类的加载器，并被加载新类的类加载器取代。</p>
<p>不幸的是，许多第三方库以及对线程，JDBC 驱动程序或文件系统句柄等资源的不良处理使得无法卸载以前使用的类加载器。反过来，这意味着在每次重新部署期间，所有先前版本的类仍将驻留在 PermGen 中，从而在每次重新部署期间生成数十兆的垃圾。</p>
<p>让我们想象一个使用 JDBC 驱动程序连接到关系数据库的示例应用程序。启动应用程序时，初始化代码将加载 JDBC 驱动程序以连接到数据库。对应于规范，JDBC 驱动程序向 java.sql.DriverManager 进行注册。该注册包括将对驱动程序实例的引用存储在 DriverManager 的静态字段中。</p>
<p>现在，当从应用程序服务器取消部署应用程序时，java.sql.DriverManager 仍将保留该引用。我们最终获得了对驱动程序类的实时引用，而驱动程序类又保留了用于加载应用程序的 java.lang.Classloader 实例的引用。反过来，这意味着垃圾回收算法无法回收空间。</p>
<p>而且该 java.lang.ClassLoader 实例仍引用应用程序的所有类，通常在 PermGen 中占据数十兆字节。这意味着只需少量重新部署即可填充通常大小的 PermGen。</p>
<h4 id="-793"><a class="markdownIt-Anchor" href="#-793">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-memory.html#permgen-space-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88">#</a>PermGen space 解决方案</h4>
<p>（1）解决初始化时的  <code>OutOfMemoryError</code></p>
<p>在应用程序启动期间触发由于 PermGen 耗尽导致的  <code>OutOfMemoryError</code>  时，解决方案很简单。该应用程序仅需要更多空间才能将所有类加载到 PermGen 区域，因此我们只需要增加其大小即可。为此，更改你的应用程序启动配置并添加（或增加，如果存在） <code>-XX:MaxPermSize</code>  参数，类似于以下示例：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">java -XX:MaxPermSize=512m com.yourcompany.YourClass<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>上面的配置将告诉 JVM，PermGen 可以增长到 512MB。</p>
<p>清理应用程序中  <code>WEB-INF/lib</code>  下的 jar，用不上的 jar 删除掉，多个应用公共的 jar 移动到 Tomcat 的 lib 目录，减少重复加载。</p>
<p>🔔 注意： <code>-XX:PermSize</code>  一般设为 64M</p>
<p>（2）解决重新部署时的  <code>OutOfMemoryError</code></p>
<p>重新部署应用程序后立即发生 OutOfMemoryError 时，应用程序会遭受类加载器泄漏的困扰。在这种情况下，解决问题的最简单，继续进行堆转储分析–使用类似于以下命令的重新部署后进行堆转储：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">jmap -dump:format=b,file=dump.hprof &lt;process-id><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>然后使用你最喜欢的堆转储分析器打开转储（Eclipse MAT 是一个很好的工具）。在分析器中可以查找重复的类，尤其是那些正在加载应用程序类的类。从那里，你需要进行所有类加载器的查找，以找到当前活动的类加载器。</p>
<p>对于非活动类加载器，你需要通过从非活动类加载器收集到 GC 根的最短路径来确定阻止它们被垃圾收集的引用。有了此信息，你将找到根本原因。如果根本原因是在第三方库中，则可以进入 Google/StackOverflow 查看是否是已知问题以获取补丁 / 解决方法。</p>
<p>（3）解决运行时  <code>OutOfMemoryError</code></p>
<p>第一步是检查是否允许 GC 从 PermGen 卸载类。在这方面，标准的 JVM 相当保守 - 类是天生的。因此，一旦加载，即使没有代码在使用它们，类也会保留在内存中。当应用程序动态创建许多类并且长时间不需要生成的类时，这可能会成为问题。在这种情况下，允许 JVM 卸载类定义可能会有所帮助。这可以通过在启动脚本中仅添加一个配置参数来实现：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">-XX:+CMSClassUnloadingEnabled<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>默认情况下，此选项设置为 false，因此要启用此功能，你需要在 Java 选项中显式设置。如果启用 CMSClassUnloadingEnabled，GC 也会扫描 PermGen 并删除不再使用的类。请记住，只有同时使用 UseConcMarkSweepGC 时此选项才起作用。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">-XX:+UseConcMarkSweepGC<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>在确保可以卸载类并且问题仍然存在之后，你应该继续进行堆转储分析–使用类似于以下命令的方法进行堆转储：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">jmap -dump:file=dump.hprof,format=b &lt;process-id><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>然后，使用你最喜欢的堆转储分析器（例如 Eclipse MAT）打开转储，然后根据已加载的类数查找最昂贵的类加载器。从此类加载器中，你可以继续提取已加载的类，并按实例对此类进行排序，以使可疑对象排在首位。</p>
<p>然后，对于每个可疑者，就需要你手动将根本原因追溯到生成此类的应用程序代码。</p>
<h3 id="-794"><a class="markdownIt-Anchor" href="#-794">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-memory.html#_4-5-%E5%85%83%E6%95%B0%E6%8D%AE%E5%8C%BA%E7%A9%BA%E9%97%B4%E4%B8%8D%E8%B6%B3">#</a>4.5. 元数据区空间不足</h3>
<p>【错误】</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Exception in thread "main" java.lang.OutOfMemoryError: Metaspace<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>【原因】</p>
<p>Java8 以后，JVM 内存空间发生了很大的变化。取消了永久代，转而变为元数据区。</p>
<p><strong>元数据区的内存不足，即方法区和运行时常量池的空间不足</strong>。</p>
<p>方法区用于存放 Class 的相关信息，如类名、访问修饰符、常量池、字段描述、方法描述等。</p>
<p>一个类要被垃圾收集器回收，判定条件是比较苛刻的。在经常动态生成大量 Class 的应用中，需要特别注意类的回收状况。这类常见除了 CGLib 字节码增强和动态语言以外，常见的还有：大量 JSP 或动态产生 JSP 文件的应用（JSP 第一次运行时需要编译为 Java 类）、基于 OSGi 的应用（即使是同一个类文件，被不同的加载器加载也会视为不同的类）等。</p>
<p>【示例】方法区出现  <code>OutOfMemoryError</code></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MethodAreaOutOfMemoryDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Enhancer</span> enhancer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Enhancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            enhancer<span class="token punctuation">.</span><span class="token function">setSuperclass</span><span class="token punctuation">(</span><span class="token class-name">Bean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            enhancer<span class="token punctuation">.</span><span class="token function">setUseCache</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            enhancer<span class="token punctuation">.</span><span class="token function">setCallback</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MethodInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">intercept</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">,</span> <span class="token class-name">MethodProxy</span> proxy<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">return</span> proxy<span class="token punctuation">.</span><span class="token function">invokeSuper</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            enhancer<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Bean</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>【解决】</p>
<p>当由于元空间而面临  <code>OutOfMemoryError</code>  时，第一个解决方案应该是显而易见的。如果应用程序耗尽了内存中的 Metaspace 区域，则应增加 Metaspace 的大小。更改应用程序启动配置并增加以下内容：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">-XX:MaxMetaspaceSize=512m<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>上面的配置示例告诉 JVM，允许 Metaspace 增长到 512 MB。</p>
<p>另一种解决方案甚至更简单。你可以通过删除此参数来完全解除对 Metaspace 大小的限制，JVM 默认对 Metaspace 的大小没有限制。但是请注意以下事实：这样做可能会导致大量交换或达到本机物理内存而分配失败。</p>
<h3 id="-795"><a class="markdownIt-Anchor" href="#-795">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-memory.html#_4-6-%E6%97%A0%E6%B3%95%E6%96%B0%E5%BB%BA%E6%9C%AC%E5%9C%B0%E7%BA%BF%E7%A8%8B">#</a>4.6. 无法新建本地线程</h3>
<p><code>java.lang.OutOfMemoryError: Unable to create new native thread</code>  这个错误意味着：<strong>Java 应用程序已达到其可以启动线程数的限制</strong>。</p>
<p>【原因】</p>
<p>当发起一个线程的创建时，虚拟机会在 JVM 内存创建一个  <code>Thread</code>  对象同时创建一个操作系统线程，而这个系统线程的内存用的不是 JVM 内存，而是系统中剩下的内存。</p>
<p>那么，究竟能创建多少线程呢？这里有一个公式：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">线程数 = (MaxProcessMemory - JVMMemory - ReservedOsMemory) / (ThreadStackSize)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>【参数】</p>
<ul>
<li><code>MaxProcessMemory</code>  - 一个进程的最大内存</li>
<li><code>JVMMemory</code>  - JVM 内存</li>
<li><code>ReservedOsMemory</code>  - 保留的操作系统内存</li>
<li><code>ThreadStackSize</code>  - 线程栈的大小</li>
</ul>
<p><strong>给 JVM 分配的内存越多，那么能用来创建系统线程的内存就会越少，越容易发生  <code>unable to create new native thread</code> </strong>。所以，JVM 内存不是分配的越大越好。</p>
<p>但是，通常导致  <code>java.lang.OutOfMemoryError</code>  的情况：无法创建新的本机线程需要经历以下阶段：</p>
<ol>
<li>JVM 内部运行的应用程序请求新的 Java 线程</li>
<li>JVM 本机代码代理为操作系统创建新本机线程的请求</li>
<li>操作系统尝试创建一个新的本机线程，该线程需要将内存分配给该线程</li>
<li>操作系统将拒绝本机内存分配，原因是 32 位 Java 进程大小已耗尽其内存地址空间（例如，已达到（2-4）GB 进程大小限制）或操作系统的虚拟内存已完全耗尽</li>
<li>引发  <code>java.lang.OutOfMemoryError: Unable to create new native thread</code>  错误。</li>
</ol>
<p>【示例】</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UnableCreateNativeThreadErrorDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                        <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MINUTES<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>【处理】</p>
<p>可以通过增加操作系统级别的限制来绕过无法创建新的本机线程问题。例如，如果限制了 JVM 可在用户空间中产生的进程数，则应检查出并可能增加该限制：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">[</span>root@dev ~<span class="token punctuation">]</span><span class="token comment"># ulimit -a</span>
core <span class="token function">file</span> size          <span class="token punctuation">(</span>blocks, -c<span class="token punctuation">)</span> <span class="token number">0</span>
--- <span class="token function">cut</span> <span class="token keyword">for</span> brevity ---
max user processes              <span class="token punctuation">(</span>-u<span class="token punctuation">)</span> <span class="token number">1800</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>通常， <code>OutOfMemoryError</code>  对新的本机线程的限制表示编程错误。当应用程序产生数千个线程时，很可能出了一些问题 — 很少有应用程序可以从如此大量的线程中受益。</p>
<p>解决问题的一种方法是开始进行线程转储以了解情况。</p>
<h3 id="-796"><a class="markdownIt-Anchor" href="#-796">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-memory.html#_4-7-%E7%9B%B4%E6%8E%A5%E5%86%85%E5%AD%98%E6%BA%A2%E5%87%BA">#</a>4.7. 直接内存溢出</h3>
<p>由直接内存导致的内存溢出，一个明显的特征是在 Head Dump 文件中不会看见明显的异常，如果发现 OOM 之后 Dump 文件很小，而程序中又直接或间接使用了 NIO，就可以考虑检查一下是不是这方面的原因。</p>
<p>【示例】直接内存  <code>OutOfMemoryError</code></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 本机直接内存溢出示例
 * 错误现象：java.lang.OutOfMemoryError
 * VM Args：-Xmx20M -XX:MaxDirectMemorySize=10M
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DirectOutOfMemoryDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> _1MB <span class="token operator">=</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IllegalAccessException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Field</span> unsafeField <span class="token operator">=</span> <span class="token class-name">Unsafe</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getDeclaredFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        unsafeField<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Unsafe</span> unsafe <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Unsafe</span><span class="token punctuation">)</span> unsafeField<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            unsafe<span class="token punctuation">.</span><span class="token function">allocateMemory</span><span class="token punctuation">(</span>_1MB<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="-797"><a class="markdownIt-Anchor" href="#-797">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-memory.html#_5-stackoverflowerror">#</a>5. StackOverflowError</h2>
<p>对于 HotSpot 虚拟机来说，栈容量只由  <code>-Xss</code>  参数来决定如果线程请求的栈深度大于虚拟机所允许的最大深度，将抛出  <code>StackOverflowError</code>  异常。</p>
<p>从实战来说，栈溢出的常见原因：</p>
<ul>
<li><strong>递归函数调用层数太深</strong></li>
<li><strong>大量循环或死循环</strong></li>
</ul>
<p>【示例】递归函数调用层数太深导致  <code>StackOverflowError</code></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StackOverflowDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> stackLength <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">recursion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        stackLength<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token function">recursion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">StackOverflowDemo</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StackOverflowDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            obj<span class="token punctuation">.</span><span class="token function">recursion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"栈深度："</span> <span class="token operator">+</span> obj<span class="token punctuation">.</span>stackLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<h1 id="jvm-垃圾收集"><a class="markdownIt-Anchor" href="#jvm-垃圾收集">#</a> JVM 垃圾收集</h1>
<blockquote>
<p><strong>📦 本文以及示例源码已归档在 <a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/">javacore(opens new window)</a></strong></p>
</blockquote>
<blockquote>
<p>程序计数器、虚拟机栈和本地方法栈这三个区域属于线程私有的，只存在于线程的生命周期内，线程结束之后也会消失，因此不需要对这三个区域进行垃圾回收。<strong>垃圾回收主要是针对 Java 堆和方法区进行</strong>。</p>
</blockquote>
<ul>
<li>\1. 对象活着吗
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#11-%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0%E7%AE%97%E6%B3%95">1.1. 引用计数算法</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#12-%E5%8F%AF%E8%BE%BE%E6%80%A7%E5%88%86%E6%9E%90%E7%AE%97%E6%B3%95">1.2. 可达性分析算法</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#13-%E5%BC%95%E7%94%A8%E7%B1%BB%E5%9E%8B">1.3. 引用类型</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#14-%E6%96%B9%E6%B3%95%E5%8C%BA%E7%9A%84%E5%9B%9E%E6%94%B6">1.4. 方法区的回收</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#15-finalize">1.5. finalize()</a></li>
</ul>
</li>
<li>\2. 垃圾收集算法
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#21-%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E6%80%A7%E8%83%BD">2.1. 垃圾收集性能</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#22-%E6%A0%87%E8%AE%B0---%E6%B8%85%E9%99%A4mark-sweep">2.2. 标记 - 清除（Mark-Sweep）</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#23-%E6%A0%87%E8%AE%B0---%E6%95%B4%E7%90%86mark-compact">2.3. 标记 - 整理（Mark-Compact）</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#24-%E5%A4%8D%E5%88%B6copying">2.4. 复制（Copying）</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#25-%E5%88%86%E4%BB%A3%E6%94%B6%E9%9B%86">2.5. 分代收集</a></li>
</ul>
</li>
<li>\3. 垃圾收集器
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#31-%E4%B8%B2%E8%A1%8C%E6%94%B6%E9%9B%86%E5%99%A8">3.1. 串行收集器</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#32-%E5%B9%B6%E8%A1%8C%E6%94%B6%E9%9B%86%E5%99%A8">3.2. 并行收集器</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#33-%E5%B9%B6%E5%8F%91%E6%A0%87%E8%AE%B0%E6%B8%85%E9%99%A4%E6%94%B6%E9%9B%86%E5%99%A8">3.3. 并发标记清除收集器</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#34-g1-%E6%94%B6%E9%9B%86%E5%99%A8">3.4. G1 收集器</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#35-%E6%80%BB%E7%BB%93">3.5. 总结</a></li>
</ul>
</li>
<li>\4. 内存分配与回收策略
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#41-minor-gc">4.1. Minor GC</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#42-full-gc">4.2. Full GC</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#5-%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">5. 参考资料</a></li>
</ul>
<h2 id="-798"><a class="markdownIt-Anchor" href="#-798">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#_1-%E5%AF%B9%E8%B1%A1%E6%B4%BB%E7%9D%80%E5%90%97">#</a>1. 对象活着吗</h2>
<h3 id="-799"><a class="markdownIt-Anchor" href="#-799">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#_1-1-%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0%E7%AE%97%E6%B3%95">#</a>1.1. 引用计数算法</h3>
<p>给对象添加一个引用计数器，当对象增加一个引用时计数器加 1，引用失效时计数器减 1。引用计数为 0 的对象可被回收。</p>
<p>两个对象出现循环引用的情况下，此时引用计数器永远不为 0，导致无法对它们进行回收。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReferenceCountingGC</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> instance <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ReferenceCountingGC</span> objectA <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReferenceCountingGC</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ReferenceCountingGC</span> objectB <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReferenceCountingGC</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectA<span class="token punctuation">.</span>instance <span class="token operator">=</span> objectB<span class="token punctuation">;</span>
        objectB<span class="token punctuation">.</span>instance <span class="token operator">=</span> objectA<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>因为循环引用的存在，所以 <strong>Java 虚拟机不适用引用计数算法</strong>。</p>
<h3 id="-800"><a class="markdownIt-Anchor" href="#-800">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#_1-2-%E5%8F%AF%E8%BE%BE%E6%80%A7%E5%88%86%E6%9E%90%E7%AE%97%E6%B3%95">#</a>1.2. 可达性分析算法</h3>
<p>通过 <strong>GC Roots</strong> 作为起始点进行搜索，JVM 将能够到达到的对象视为<strong>存活</strong>，不可达的对象视为<strong>死亡</strong>。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/cs/java/javacore/jvm/jvm-gc-root.png" alt="img"></p>
<p>可达性分析算法</p>
<p><strong>可作为 GC Roots 的对象</strong>包括下面几种：</p>
<ul>
<li>虚拟机栈中引用的对象</li>
<li>本地方法栈中引用的对象（Native 方法）</li>
<li>方法区中，类静态属性引用的对象</li>
<li>方法区中，常量引用的对象</li>
</ul>
<h3 id="-801"><a class="markdownIt-Anchor" href="#-801">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#_1-3-%E5%BC%95%E7%94%A8%E7%B1%BB%E5%9E%8B">#</a>1.3. 引用类型</h3>
<p>无论是通过引用计算算法判断对象的引用数量，还是通过可达性分析算法判断对象的引用链是否可达，判定对象是否可被回收都与引用有关。</p>
<p>Java 具有四种强度不同的引用类型。</p>
<h4 id="-802"><a class="markdownIt-Anchor" href="#-802">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#%E5%BC%BA%E5%BC%95%E7%94%A8">#</a>强引用</h4>
<p><strong>被强引用（Strong Reference）关联的对象不会被垃圾收集器回收。</strong></p>
<p>强引用：使用  <code>new</code>  一个新对象的方式来创建强引用。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Object</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="-803"><a class="markdownIt-Anchor" href="#-803">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#%E8%BD%AF%E5%BC%95%E7%94%A8">#</a>软引用</h4>
<p><strong>被软引用（Soft Reference）关联的对象，只有在内存不够的情况下才会被回收。</strong></p>
<p>软引用：使用  <code>SoftReference</code>  类来创建软引用。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Object</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">SoftReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> sf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SoftReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
obj <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 使对象只被软引用关联</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="-804"><a class="markdownIt-Anchor" href="#-804">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#%E5%BC%B1%E5%BC%95%E7%94%A8">#</a>弱引用</h4>
<p><strong>被弱引用（Weak Reference）关联的对象一定会被垃圾收集器回收，也就是说它只能存活到下一次垃圾收集发生之前。</strong></p>
<p>使用  <code>WeakReference</code>  类来实现弱引用。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Object</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">WeakReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> wf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
obj <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><code>WeakHashMap</code>  的  <code>Entry</code>  继承自  <code>WeakReference</code> ，主要用来实现缓存。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">WeakReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> <span class="token keyword">implements</span> <span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Tomcat 中的  <code>ConcurrentCache</code>  就使用了  <code>WeakHashMap</code>  来实现缓存功能。 <code>ConcurrentCache</code>  采取的是分代缓存，经常使用的对象放入 eden 中，而不常用的对象放入 longterm。eden 使用  <code>ConcurrentHashMap</code>  实现，longterm 使用  <code>WeakHashMap</code> ，保证了不常使用的对象容易被回收。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ConcurrentCache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> size<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">></span></span> eden<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">></span></span> longterm<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ConcurrentCache</span><span class="token punctuation">(</span><span class="token keyword">int</span> size<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>size <span class="token operator">=</span> size<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>eden <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>longterm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">V</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">K</span> k<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">V</span> v <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>eden<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>v <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            v <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>longterm<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>v <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>eden<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> v<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">K</span> k<span class="token punctuation">,</span> <span class="token class-name">V</span> v<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>eden<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> size<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>longterm<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>eden<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>eden<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>eden<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-805"><a class="markdownIt-Anchor" href="#-805">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#%E8%99%9A%E5%BC%95%E7%94%A8">#</a>虚引用</h4>
<p>又称为幽灵引用或者幻影引用。一个对象是否有虚引用的存在，完全不会对其生存时间构成影响，也无法通过虚引用取得一个对象实例。</p>
<p><strong>为一个对象设置虚引用关联的唯一目的就是能在这个对象被收集器回收时收到一个系统通知。</strong></p>
<p>使用  <code>PhantomReference</code>  来实现虚引用。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Object</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">PhantomReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> pf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PhantomReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
obj <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="-806"><a class="markdownIt-Anchor" href="#-806">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#_1-4-%E6%96%B9%E6%B3%95%E5%8C%BA%E7%9A%84%E5%9B%9E%E6%94%B6">#</a>1.4. 方法区的回收</h3>
<p>因为方法区主要存放永久代对象，而永久代对象的回收率比年轻代差很多，因此在方法区上进行回收性价比不高。</p>
<p>主要是对常量池的回收和对类的卸载。</p>
<p>类的卸载条件很多，需要满足以下三个条件，并且满足了也不一定会被卸载：</p>
<ul>
<li>该类所有的实例都已经被回收，也就是 Java 堆中不存在该类的任何实例。</li>
<li>加载该类的  <code>ClassLoader</code>  已经被回收。</li>
<li>该类对应的  <code>java.lang.Class</code>  对象没有在任何地方被引用，也就无法在任何地方通过反射访问该类方法。</li>
</ul>
<p>可以通过  <code>-Xnoclassgc</code>  参数来控制是否对类进行卸载。</p>
<p>在大量使用反射、动态代理、CGLib 等字节码框架、动态生成 JSP 以及 OSGi 这类频繁自定义  <code>ClassLoader</code>  的场景都需要虚拟机具备类卸载功能，以保证不会出现内存溢出。</p>
<h3 id="-807"><a class="markdownIt-Anchor" href="#-807">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#_1-5-finalize">#</a>1.5. finalize()</h3>
<p><code>finalize()</code>  类似 C++ 的析构函数，用来做关闭外部资源等工作。但是 try-finally 等方式可以做的更好，并且该方法运行代价高昂，不确定性大，无法保证各个对象的调用顺序，因此<strong>最好不要使用  <code>finalize()</code> </strong>。</p>
<p>当一个对象可被回收时，如果需要执行该对象的  <code>finalize()</code>  方法，那么就有可能通过在该方法中让对象重新被引用，从而实现自救。</p>
<h2 id="-808"><a class="markdownIt-Anchor" href="#-808">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#_2-%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E7%AE%97%E6%B3%95">#</a>2. 垃圾收集算法</h2>
<h3 id="-809"><a class="markdownIt-Anchor" href="#-809">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#_2-1-%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E6%80%A7%E8%83%BD">#</a>2.1. 垃圾收集性能</h3>
<p>垃圾收集器的性能指标主要有两点：</p>
<ul>
<li><strong>停顿时间</strong> - 停顿时间是因为 GC 而导致程序不能工作的时间长度。</li>
<li><strong>吞吐量</strong> - 吞吐量关注在特定的时间周期内一个应用的工作量的最大值。对关注吞吐量的应用来说长暂停时间是可以接受的。由于高吞吐量的应用关注的基准在更长周期时间上，所以快速响应时间不在考虑之内。</li>
</ul>
<h3 id="-810"><a class="markdownIt-Anchor" href="#-810">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#_2-2-%E6%A0%87%E8%AE%B0-%E6%B8%85%E9%99%A4-mark-sweep">#</a>2.2. 标记 - 清除（Mark-Sweep）</h3>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/jvm-gc-mark-sweep.jpg" alt="img"></p>
<p>将需要回收的对象进行标记，然后清理掉被标记的对象。</p>
<p>不足：</p>
<ul>
<li>标记和清除过程效率都不高；</li>
<li>会产生大量不连续的内存碎片，导致无法给大对象分配内存。</li>
</ul>
<h3 id="-811"><a class="markdownIt-Anchor" href="#-811">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#_2-3-%E6%A0%87%E8%AE%B0-%E6%95%B4%E7%90%86-mark-compact">#</a>2.3. 标记 - 整理（Mark-Compact）</h3>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/cs/java/javacore/jvm/jvm-gc-mark-compact.jpg" alt="img"></p>
<p>让所有存活的对象都向一端移动，然后直接清理掉端边界以外的内存。</p>
<p>这种做法能够解决内存碎片化的问题，但代价是压缩算法的性能开销。</p>
<h3 id="-812"><a class="markdownIt-Anchor" href="#-812">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#_2-4-%E5%A4%8D%E5%88%B6-copying">#</a>2.4. 复制（Copying）</h3>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/cs/java/javacore/jvm/jvm-gc-copying.jpg" alt="img"></p>
<p>将内存划分为大小相等的两块，每次只使用其中一块，当这一块内存用完了就将还存活的对象复制到另一块上面，然后再把使用过的内存空间进行一次清理。</p>
<p>主要不足是只使用了内存的一半。</p>
<p>现在的商业虚拟机都<strong>采用这种收集算法来回收年轻代</strong>，但是并不是将内存划分为大小相等的两块，而是分为一块较大的 Eden 空间和两块较小的 Survior 空间，每次使用 Eden 空间和其中一块 Survivor。在回收时，将 Eden 和 Survivor 中还存活着的对象一次性复制到另一块 Survivor 空间上，最后清理 Eden 和使用过的那一块 Survivor。HotSpot 虚拟机的 Eden 和 Survivor 的大小比例默认为 8:1（可以通过参数  <code>-XX:SurvivorRatio</code>  来调整比例），保证了内存的利用率达到 90 %。如果每次回收有多于 10% 的对象存活，那么一块 Survivor 空间就不够用了，此时需要依赖于老年代进行分配担保，也就是借用老年代的空间存储放不下的对象。</p>
<h3 id="-813"><a class="markdownIt-Anchor" href="#-813">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#_2-5-%E5%88%86%E4%BB%A3%E6%94%B6%E9%9B%86">#</a>2.5. 分代收集</h3>
<p>现在的商业虚拟机采用分代收集算法，它根据对象存活周期将内存划分为几块，不同块采用适当的收集算法。</p>
<p>一般将 Java 堆分为年轻代和老年代。</p>
<ul>
<li>年轻代使用：<strong>复制</strong> 算法</li>
<li>老年代使用：<strong>标记 - 清理</strong> 或者 <strong>标记 - 整理</strong> 算法</li>
</ul>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/cs/java/javacore/jvm/jvm-hotspot-heap-structure.png" alt="img"></p>
<h4 id="-814"><a class="markdownIt-Anchor" href="#-814">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#%E6%96%B0%E7%94%9F%E4%BB%A3">#</a>新生代</h4>
<p>新生代是大部分对象创建和销毁的区域，在通常的 Java 应用中，绝大部分对象生命周期都是很短暂的。其内部又分为  <code>Eden</code>  区域，作为对象初始分配的区域；两个  <code>Survivor</code> ，有时候也叫  <code>from</code> 、 <code>to</code>  区域，被用来放置从 Minor GC 中保留下来的对象。</p>
<p>JVM 会随意选取一个  <code>Survivor</code>  区域作为  <code>to</code> ，然后会在 GC 过程中进行区域间拷贝，也就是将 Eden 中存活下来的对象和  <code>from</code>  区域的对象，拷贝到这个 <code>to</code>  区域。这种设计主要是为了防止内存的碎片化，并进一步清理无用对象。</p>
<p>Java 虚拟机会记录  <code>Survivor</code>  区中的对象一共被来回复制了几次。如果一个对象被复制的次数为 15（对应虚拟机参数  <code>-XX:+MaxTenuringThreshold</code> ），那么该对象将被晋升（promote）至老年代。另外，如果单个  <code>Survivor</code>  区已经被占用了 50%（对应虚拟机参数  <code>-XX:TargetSurvivorRatio</code> ），那么较高复制次数的对象也会被晋升至老年代。</p>
<h4 id="-815"><a class="markdownIt-Anchor" href="#-815">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#%E8%80%81%E5%B9%B4%E4%BB%A3">#</a>老年代</h4>
<p>放置长生命周期的对象，通常都是从  <code>Survivor</code>  区域拷贝过来的对象。当然，也有特殊情况，如果对象较大，JVM 会试图直接分配在  <code>Eden</code>  其他位置上；如果对象太大，完全无法在新生代找到足够长的连续空闲空间，JVM 就会直接分配到老年代。</p>
<h4 id="-816"><a class="markdownIt-Anchor" href="#-816">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#%E6%B0%B8%E4%B9%85%E4%BB%A3">#</a>永久代</h4>
<p>这部分就是早期 Hotspot JVM 的方法区实现方式了，储存 Java 类元数据、常量池、Intern 字符串缓存。在 JDK 8 之后就不存在永久代这块儿了。</p>
<h4 id="-817"><a class="markdownIt-Anchor" href="#-817">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#jvm-%E5%8F%82%E6%95%B0">#</a>JVM 参数</h4>
<p>这里顺便提一下，JVM 允许对堆空间大小、各代空间大小进行设置，以调整 JVM GC。</p>
<table>
<thead>
<tr>
<th>配置</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>-Xss</code></td>
<td>虚拟机栈大小。</td>
</tr>
<tr>
<td><code>-Xms</code></td>
<td>堆空间初始值。</td>
</tr>
<tr>
<td><code>-Xmx</code></td>
<td>堆空间最大值。</td>
</tr>
<tr>
<td><code>-Xmn</code></td>
<td>新生代空间大小。</td>
</tr>
<tr>
<td><code>-XX:NewSize</code></td>
<td>新生代空间初始值。</td>
</tr>
<tr>
<td><code>-XX:MaxNewSize</code></td>
<td>新生代空间最大值。</td>
</tr>
<tr>
<td><code>-XX:NewRatio</code></td>
<td>新生代与年老代的比例。默认为 2，意味着老年代是新生代的 2 倍。</td>
</tr>
<tr>
<td><code>-XX:SurvivorRatio</code></td>
<td>新生代中调整 eden 区与 survivor 区的比例，默认为 8。即  <code>eden</code>  区为 80% 的大小，两个  <code>survivor</code>  分别为 10% 的大小。</td>
</tr>
<tr>
<td><code>-XX:PermSize</code></td>
<td>永久代空间的初始值。</td>
</tr>
<tr>
<td><code>-XX:MaxPermSize</code></td>
<td>永久代空间的最大值。</td>
</tr>
</tbody>
</table>
<h2 id="-818"><a class="markdownIt-Anchor" href="#-818">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#_3-%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E5%99%A8">#</a>3. 垃圾收集器</h2>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/jvm-gc-overview.jpg" alt="img"></p>
<p>以上是 HotSpot 虚拟机中的 7 个垃圾收集器，连线表示垃圾收集器可以配合使用。</p>
<p>注：G1 垃圾收集器既可以回收年轻代内存，也可以回收老年代内存。而其他垃圾收集器只能针对特定代的内存进行回收。</p>
<h3 id="-819"><a class="markdownIt-Anchor" href="#-819">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#_3-1-%E4%B8%B2%E8%A1%8C%E6%94%B6%E9%9B%86%E5%99%A8">#</a>3.1. 串行收集器</h3>
<p>串行收集器（Serial）是最基本、发展历史最悠久的收集器。</p>
<p>串行收集器是 <strong> <code>client</code>  模式下的默认收集器配置</strong>。因为在客户端模式下，分配给虚拟机管理的内存一般来说不会很大。Serial 收集器收集几十兆甚至一两百兆的年轻代停顿时间可以控制在一百多毫秒以内，只要不是太频繁，这点停顿是可以接受的。</p>
<p><strong>串行收集器采用单线程 stop-the-world 的方式进行收集</strong>。当内存不足时，串行 GC 设置停顿标识，待所有线程都进入安全点（Safepoint）时，应用线程暂停，串行 GC 开始工作，<strong>采用单线程方式回收空间并整理内存</strong>。</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/jvm-gc-serial.jpg" alt="img"></p>
<p>Serial / Serial Old 收集器运行示意图</p>
<p>单线程意味着复杂度更低、占用内存更少，垃圾回收效率高；但同时也意味着不能有效利用多核优势。事实上，串行收集器特别适合堆内存不高、单核甚至双核 CPU 的场合。</p>
<h4 id="-820"><a class="markdownIt-Anchor" href="#-820">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#serial-%E6%94%B6%E9%9B%86%E5%99%A8">#</a>Serial 收集器</h4>
<blockquote>
<p>开启选项： <code>-XX:+UseSerialGC</code></p>
<p>打开此开关后，使用 <strong>Serial</strong> + <strong>Serial Old</strong> 收集器组合来进行内存回收。</p>
</blockquote>
<h4 id="-821"><a class="markdownIt-Anchor" href="#-821">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#serial-old-%E6%94%B6%E9%9B%86%E5%99%A8">#</a>Serial Old 收集器</h4>
<p>Serial Old 是 Serial 收集器的老年代版本，也是给 Client 模式下的虚拟机使用。如果用在 Server 模式下，它有两大用途：</p>
<ul>
<li>在 JDK 1.5 以及之前版本（Parallel Old 诞生以前）中与 Parallel Scavenge 收集器搭配使用。</li>
<li>作为 CMS 收集器的后备预案，在并发收集发生 Concurrent Mode Failure 时使用。</li>
</ul>
<h3 id="-822"><a class="markdownIt-Anchor" href="#-822">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#_3-2-%E5%B9%B6%E8%A1%8C%E6%94%B6%E9%9B%86%E5%99%A8">#</a>3.2. 并行收集器</h3>
<blockquote>
<p>开启选项： <code>-XX:+UseParallelGC</code></p>
<p>打开此开关后，使用 <strong>Parallel Scavenge</strong> + <strong>Serial Old</strong> 收集器组合来进行内存回收。</p>
<p>开启选项： <code>-XX:+UseParallelOldGC</code></p>
<p>打开此开关后，使用 <strong>Parallel Scavenge</strong> + <strong>Parallel Old</strong> 收集器组合来进行内存回收。</p>
</blockquote>
<p>其他收集器都是以关注停顿时间为目标，而<strong>并行收集器是以关注吞吐量（Throughput）为目标的垃圾收集器</strong>。</p>
<ul>
<li>停顿时间越短就越适合需要与用户交互的程序，良好的响应速度能提升用户体验；</li>
<li>而高吞吐量则可以高效率地利用 CPU 时间，尽快完成程序的运算任务，主要适合在后台运算而不需要太多交互的任务。</li>
</ul>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">吞吐量 = 运行用户代码时间 / (运行用户代码时间 + 垃圾收集时间)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><strong>并行收集器是 server 模式下的默认收集器。</strong></p>
<p>并行收集器与串行收集器工作模式相似，都是 stop-the-world 方式，只是暂停时并行地进行垃圾收集。<strong>并行收集器年轻代采用复制算法，老年代采用标记 - 整理</strong>，在回收的同时还会对内存进行压缩。并行收集器适合对吞吐量要求远远高于延迟要求的场景，并且在满足最差延时的情况下，并行收集器将提供最佳的吞吐量。</p>
<p><strong>在注重吞吐量以及 CPU 资源敏感的场合，都可以优先考虑 Parallel Scavenge 收集器 + Parallel Old 收集器。</strong></p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/cs/java/javacore/jvm/jvm-gc-parallel.jpg" alt="img"></p>
<p>Parallel / Parallel Old 收集器运行示意图</p>
<h4 id="-823"><a class="markdownIt-Anchor" href="#-823">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#parallel-scavenge-%E6%94%B6%E9%9B%86%E5%99%A8">#</a>Parallel Scavenge 收集器</h4>
<p>Parallel Scavenge 收集器提供了两个参数用于精确控制吞吐量，分别是：</p>
<ul>
<li><code>-XX:MaxGCPauseMillis</code>  - 控制最大垃圾收集停顿时间，收集器将尽可能保证内存回收时间不超过设定值。</li>
<li><code>-XX:GCTimeRatio</code>  - 直接设置吞吐量大小的（值为大于 0 且小于 100 的整数）。</li>
</ul>
<p>缩短停顿时间是以牺牲吞吐量和年轻代空间来换取的：年轻代空间变小，垃圾回收变得频繁，导致吞吐量下降。</p>
<p>Parallel Scavenge 收集器还提供了一个参数  <code>-XX:+UseAdaptiveSizePolicy</code> ，这是一个开关参数，打开参数后，就不需要手工指定年轻代的大小（ <code>-Xmn</code> ）、Eden 和 Survivor 区的比例（ <code>-XX:SurvivorRatio</code> ）、晋升老年代对象年龄（ <code>-XX:PretenureSizeThreshold</code> ）等细节参数了，虚拟机会根据当前系统的运行情况收集性能监控信息，动态调整这些参数以提供最合适的停顿时间或者最大的吞吐量，这种方式称为 GC 自适应的调节策略（GC Ergonomics）。</p>
<h4 id="-824"><a class="markdownIt-Anchor" href="#-824">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#parallel-old-%E6%94%B6%E9%9B%86%E5%99%A8">#</a>Parallel Old 收集器</h4>
<p>是 Parallel Scavenge 收集器的老年代版本，使用<strong>多线程和 “标记 - 整理” 算法</strong>。</p>
<h3 id="-825"><a class="markdownIt-Anchor" href="#-825">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#_3-3-%E5%B9%B6%E5%8F%91%E6%A0%87%E8%AE%B0%E6%B8%85%E9%99%A4%E6%94%B6%E9%9B%86%E5%99%A8">#</a>3.3. 并发标记清除收集器</h3>
<blockquote>
<p>开启选项： <code>-XX:+UseConcMarkSweepGC</code></p>
<p>打开此开关后，使用 <strong>CMS</strong> + <strong>ParNew</strong> + <strong>Serial Old</strong> 收集器组合来进行内存回收。</p>
</blockquote>
<p>并发标记清除收集器是以获取最短停顿时间为目标。</p>
<p>开启后，年轻代使用 ParNew 收集器；老年代使用 CMS 收集器，如果 CMS 产生的碎片过多，导致无法存放浮动垃圾，JVM 会出现  <code>Concurrent Mode Failure</code>  ，此时使用 Serial Old 收集器来替代 CMS 收集器清理碎片。</p>
<h4 id="-826"><a class="markdownIt-Anchor" href="#-826">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#cms-%E6%94%B6%E9%9B%86%E5%99%A8">#</a>CMS 收集器</h4>
<p><strong>CMS 收集器是一种以获取最短停顿时间为目标的收集器。</strong></p>
<p>CMS（Concurrent Mark Sweep），Mark Sweep 指的是标记 - 清除算法。</p>
<h5 id="-827"><a class="markdownIt-Anchor" href="#-827">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#cms-%E5%9B%9E%E6%94%B6%E6%9C%BA%E5%88%B6">#</a>CMS 回收机制</h5>
<p>CMS 收集器运行步骤如下：</p>
<ol>
<li><strong>初始标记</strong>：仅仅只是标记一下 GC Roots 能直接关联到的对象，速度很快，需要停顿。</li>
<li><strong>并发标记</strong>：进行 GC Roots Tracing 的过程，它在整个回收过程中耗时最长，不需要停顿。</li>
<li><strong>重新标记</strong>：为了修正并发标记期间因用户程序继续运作而导致标记产生变动的那一部分对象的标记记录，需要停顿。</li>
<li><strong>并发清除</strong>：回收在标记阶段被鉴定为不可达的对象。不需要停顿。</li>
</ol>
<p>在整个过程中耗时最长的并发标记和并发清除过程中，收集器线程都可以与用户线程一起工作，不需要进行停顿。</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/jvm-gc-cms.jpg" alt="img"></p>
<p>CMS 收集器运行示意图</p>
<h5 id="-828"><a class="markdownIt-Anchor" href="#-828">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#cms-%E5%9B%9E%E6%94%B6%E5%B9%B4%E8%BD%BB%E4%BB%A3%E8%AF%A6%E7%BB%86%E6%AD%A5%E9%AA%A4">#</a>CMS 回收年轻代详细步骤</h5>
<p><strong>（1）堆空间被分割为三块空间</strong></p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/slide1.png" alt="img"> 年轻代分割成一个 Eden 区和两个 Survivor 区。年老代一个连续的空间。就地完成对象收集。除非有 FullGC 否则不会压缩。</p>
<p><strong>（2）CMS 年轻代垃圾收集如何工作</strong></p>
<p>年轻代被标为浅绿色，年老代被标记为蓝色。如果你的应用已经运行了一段时间，CMS 的堆看起来应该是这个样子。对象分散在年老代区域里。</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/slide2.png" alt="img"></p>
<p>使用 CMS，年老代对象就地释放。它们不会被来回移动。这个空间不会被压缩除非发生 FullGC。</p>
<p><strong>（3）年轻代收集</strong></p>
<p>从 Eden 和 Survivor 区复制活跃对象到另一个 Survivor 区。所有达到他们的年龄阈值的对象会晋升到年老代。</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/slide3.png" alt="img"> <strong>（4) 年轻代回收之后</strong></p>
<p>一次年轻代垃圾收集之后，Eden 区和其中一个 Survivor 区被清空。</p>
<p><img src="http://www.oracle.com/webfolder/technetwork/tutorials/obe/java/G1GettingStarted/images/slide4.png" alt="img"> 最近晋升的对象以深蓝色显示在上图中，绿色的对象是年轻代幸免的还没有晋升到老年代对象。</p>
<h5 id="-829"><a class="markdownIt-Anchor" href="#-829">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#cms-%E5%9B%9E%E6%94%B6%E5%B9%B4%E8%80%81%E4%BB%A3%E8%AF%A6%E7%BB%86%E6%AD%A5%E9%AA%A4">#</a>CMS 回收年老代详细步骤</h5>
<p><strong>（1）CMS 的年老代收集</strong></p>
<p>发生两次 stop the world 事件：初始标记和重新标记。当年老代达到特定的占用比例时，CMS 开始执行。</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/slide5.png" alt="img"></p>
<ul>
<li>初始标记是一个短暂暂停的、可达对象被标记的阶段。</li>
<li>并发标记寻找活跃对象在应用连续执行时。</li>
<li>最后，在重新标记阶段，寻找在之前并发标记阶段中丢失的对象。</li>
</ul>
<p><strong>（2）年老代收集 - 并发清除</strong></p>
<p>在之前阶段没有被标记的对象会被就地释放。不进行压缩操作。</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/slide6.png" alt="img"> ** 注意：** 未被标记的对象等于死亡对象</p>
<p><strong>（3）年老代收集 - 清除之后</strong></p>
<p>清除阶段之后，你可以看到大量内存被释放。你还可以注意到没有进行压缩操作。</p>
<p><img src="http://www.oracle.com/webfolder/technetwork/tutorials/obe/java/G1GettingStarted/images/slide7.png" alt="img"> 最后，CMS 收集器会再次进入重新设置阶段，等待下一次垃圾收集时机的到来。</p>
<h5 id="-830"><a class="markdownIt-Anchor" href="#-830">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#cms-%E7%89%B9%E7%82%B9">#</a>CMS 特点</h5>
<p>CMS 收集器具有以下缺点：</p>
<ul>
<li>
<p>并发收集 - 并发指的是用户线程和 GC 线程同时运行。</p>
</li>
<li>
<p>吞吐量低 - 低停顿时间是以牺牲吞吐量为代价的，导致 CPU 利用率不够高。</p>
</li>
<li>
<p>无法处理浮动垃圾 - 可能出现</p>
</li>
</ul>
<p>​</p>
<pre><code><pre class="line-numbers language-none"><code class="language-none">Concurrent Mode Failure<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

。浮动垃圾是指并发清除阶段由于用户线程继续运行而产生的垃圾，这部分垃圾只能到下一次 GC 时才能进行回收。由于浮动垃圾的存在，因此需要预留出一部分内存，意味着 CMS 收集不能像其它收集器那样等待老年代快满的时候再回收。

- 可以使用 `-XX:CMSInitiatingOccupancyFraction` 来改变触发 CMS 收集器工作的内存占用百分，如果这个值设置的太大，导致预留的内存不够存放浮动垃圾，就会出现 `Concurrent Mode Failure`，这时虚拟机将临时启用 Serial Old 收集器来替代 CMS 收集器。
</code></pre>
<ul>
<li>
<p>标记 - 清除算法导致的空间碎片，往往出现老年代空间剩余，但无法找到足够大连续空间来分配当前对象，不得不提前触发一次 Full GC。</p>
<ul>
<li>可以使用  <code>-XX:+UseCMSCompactAtFullCollection</code>  ，用于在 CMS 收集器要进行 Full GC 时开启内存碎片的合并整理，内存整理的过程是无法并发的，空间碎片问题没有了，但是停顿时间不得不变长了。</li>
<li>可以使用  <code>-XX:CMSFullGCsBeforeCompaction</code>  ，用于设置执行多少次不压缩的 Full GC 后，来一次带压缩的（默认为 0，表示每次进入 Full GC 时都要进行碎片整理）。</li>
</ul>
</li>
</ul>
<h4 id="-831"><a class="markdownIt-Anchor" href="#-831">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#parnew-%E6%94%B6%E9%9B%86%E5%99%A8">#</a>ParNew 收集器</h4>
<blockquote>
<p>开启选项： <code>-XX:+UseParNewGC</code></p>
</blockquote>
<p>ParNew 收集器其实是 Serial 收集器的多线程版本。</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/jvm-gc-par-new.jpg" alt="img"></p>
<p>ParNew 收集器运行示意图</p>
<p>是 Server 模式下的虚拟机首选年轻代收集器，除了性能原因外，主要是因为除了 Serial 收集器，只有它能与 CMS 收集器配合工作。</p>
<p>ParNew 收集器也是使用  <code>-XX:+UseConcMarkSweepGC</code>  后的默认年轻代收集器。</p>
<p>ParNew 收集器默认开启的线程数量与 CPU 数量相同，可以使用 - <code>XX:ParallelGCThreads</code>  参数来设置线程数。</p>
<h3 id="-832"><a class="markdownIt-Anchor" href="#-832">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#_3-4-g1-%E6%94%B6%E9%9B%86%E5%99%A8">#</a>3.4. G1 收集器</h3>
<blockquote>
<p>开启选项： <code>-XX:+UseG1GC</code></p>
</blockquote>
<p>前面提到的垃圾收集器一般策略是关注吞吐量或停顿时间。而 <strong>G1 是一种兼顾吞吐量和停顿时间的 GC 收集器</strong>。G1 是 Oracle JDK9 以后的默认 GC 收集器。G1 可以直观的设定停顿时间的目标，相比于 CMS GC，G1 未必能做到 CMS 在最好情况下的延时停顿，但是最差情况要好很多。</p>
<p>G1 最大的特点是引入分区的思路，弱化了分代的概念，合理利用垃圾收集各个周期的资源，解决了其他收集器甚至 CMS 的众多缺陷。</p>
<h4 id="-833"><a class="markdownIt-Anchor" href="#-833">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#%E5%88%86%E4%BB%A3%E5%92%8C%E5%88%86%E5%8C%BA">#</a>分代和分区</h4>
<p>旧的垃圾收集器一般采取分代收集，Java 堆被分为年轻代、老年代和永久代。收集的范围都是整个年轻代或者整个老年代。</p>
<p>G1 取消了永久代，并把年轻代和老年代划分成多个大小相等的独立区域（Region），年轻代和老年代不再物理隔离。G1 可以直接对年轻代和老年代一起回收。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/cs/java/javacore/jvm/jvm-gc-g1-heap-allocation.png" alt="img"></p>
<p>通过引入 Region 的概念，从而将原来的一整块内存空间划分成多个的小空间，使得每个小空间可以单独进行垃圾回收。这种划分方法带来了很大的灵活性，使得可预测的停顿时间模型成为可能。通过记录每个 Region 垃圾回收时间以及回收所获得的空间（这两个值是通过过去回收的经验获得），并维护一个优先列表，每次根据允许的收集时间，优先回收价值最大的 Region。</p>
<p>每个 Region 都有一个 Remembered Set，用来记录该 Region 对象的引用对象所在的 Region。通过使用 Remembered Set，在做可达性分析的时候就可以避免全堆扫描。</p>
<h4 id="-834"><a class="markdownIt-Anchor" href="#-834">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#g1-%E5%9B%9E%E6%94%B6%E6%9C%BA%E5%88%B6">#</a>G1 回收机制</h4>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/jvm-gc-g1.jpg" alt="img"></p>
<p>G1 收集器运行示意图</p>
<p>如果不计算维护 Remembered Set 的操作，G1 收集器的运作大致可划分为以下几个步骤：</p>
<ol>
<li><strong>初始标记</strong></li>
<li><strong>并发标记</strong></li>
<li><strong>最终标记</strong> - 为了修正在并发标记期间因用户程序继续运作而导致标记产生变动的那一部分标记记录，虚拟机将这段时间对象变化记录在线程的 Remembered Set Logs 里面，最终标记阶段需要把 Remembered Set Logs 的数据合并到 Remembered Set 中。这阶段需要停顿线程，但是可并行执行。</li>
<li><strong>筛选回收</strong> - 首先对各个 Region 中的回收价值和成本进行排序，根据用户所期望的 GC 停顿是时间来制定回收计划。此阶段其实也可以做到与用户程序一起并发执行，但是因为只回收一部分 Region，时间是用户可控制的，而且停顿用户线程将大幅度提高收集效率。</li>
</ol>
<p>具备如下特点：</p>
<ul>
<li>空间整合：整体来看是基于 “标记 - 整理” 算法实现的收集器，从局部（两个 Region 之间）上来看是基于 “复制” 算法实现的，这意味着运行期间不会产生内存空间碎片。</li>
<li>可预测的停顿：能让使用者明确指定在一个长度为 M 毫秒的时间片段内，消耗在 GC 上的时间不得超过 N 毫秒。</li>
</ul>
<h4 id="-835"><a class="markdownIt-Anchor" href="#-835">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#g1-%E5%9B%9E%E6%94%B6%E5%B9%B4%E8%BD%BB%E4%BB%A3%E8%AF%A6%E7%BB%86%E6%AD%A5%E9%AA%A4">#</a>G1 回收年轻代详细步骤</h4>
<p><strong>（1）G1 初始堆空间</strong></p>
<p>堆空间是一个被分成许多固定大小区域的内存块。</p>
<p><img src="http://www.oracle.com/webfolder/technetwork/tutorials/obe/java/G1GettingStarted/images/slide8.png" alt="img"> Java 虚拟机启动时选定区域大小。Java 虚拟机通常会指定 2000 个左右的大小相等、每个大小范围在 1 到 32M 的区域。</p>
<p><strong>（2）G1 堆空间分配</strong></p>
<p>实际上，这些区域被映射成 Eden、Survivor、年老代空间的逻辑表述形式。</p>
<p><img src="http://www.oracle.com/webfolder/technetwork/tutorials/obe/java/G1GettingStarted/images/slide9.png" alt="img"> 图片中的颜色表明了哪个区域被关联上什么角色。活跃对象从一个区域疏散（复制、移动) 到另一个区域。区域被设计为并行的方式收集，可以暂停或者不暂停所有的其它用户线程。</p>
<p>明显的区域可以被分配成 Eden、Survivor、Old 区域。另外，有第四种类型的区域叫做<em>极大区域 (Humongous regions)</em>。这些区域被设计成保持标准区域大小的 50% 或者更大的对象。它们被保存在一个连续的区域集合里。最后，最后一个类型的区域就是堆空间里没有使用的区域。</p>
<p>** 注意：** 写作此文章时，收集极大对象时还没有被优化。因此，你应该避免创建这个大小的对象。</p>
<p><strong>（3）G1 的年轻代</strong></p>
<p>堆空间被分割成大约 2000 个区域。最小 1M，最大 32M，蓝色区域保持年老代对象，绿色区域保持年轻代对象。</p>
<p><img src="http://www.oracle.com/webfolder/technetwork/tutorials/obe/java/G1GettingStarted/images/slide10.png" alt="img"> ** 注意：** 区域没有必要像旧的收集器一样是保持连续的。</p>
<p><strong>（4）G1 的年轻代收集</strong></p>
<p>活跃对象会被疏散（复制、移动）到一个或多个 survivor 区域。如果达到晋升总阈值，对象会晋升到年老代区域。</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/slide11.png" alt="img"> 这是一个 stop the world 暂停。为下一次年轻代垃圾回收计算 Eden 和 Survivor 的大小。保留审计信息有助于计算大小。类似目标暂停时间的事情会被考虑在内。</p>
<p>这个方法使重调区域大小变得很容易，按需把它们调大或调小。</p>
<p><strong>（5）G1 年轻代回收的尾声</strong></p>
<p>活跃对象被疏散到 Survivor 或者年老代区域。</p>
<p><img src="http://www.oracle.com/webfolder/technetwork/tutorials/obe/java/G1GettingStarted/images/slide12.png" alt="img"> 最近晋升的对象显示为深蓝色。Survivor 区域显示为绿色。</p>
<p>关于 G1 的年轻代回收做以下总结：</p>
<ul>
<li>堆空间是一块单独的内存空间被分割成多个区域。</li>
<li>年轻代内存是由一组非连续的区域组成。这使得需要重调大小变得容易。</li>
<li>年轻代垃圾回收是 stop the world 事件，所有应用线程都会因此操作暂停。</li>
<li>年轻代垃圾收集使用多线程并行回收。</li>
<li>活跃对象被复制到新的 Survivor 区或者年老代区域。</li>
</ul>
<h4 id="-836"><a class="markdownIt-Anchor" href="#-836">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#g1-%E5%9B%9E%E6%94%B6%E5%B9%B4%E8%80%81%E4%BB%A3%E8%AF%A6%E7%BB%86%E6%AD%A5%E9%AA%A4">#</a>G1 回收年老代详细步骤</h4>
<p><strong>（1）初始标记阶段</strong></p>
<p>年轻代垃圾收集肩负着活跃对象初始标记的任务。在日志文件中被标为<em> GC pause (young)(inital-mark)</em></p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/slide13.png" alt="img"> <strong>（2) 并发标记阶段</strong></p>
<p>如果发现空区域 (“X” 标示的)，在重新标记阶段它们会被马上清除掉。当然，决定活性的审计信息也在此时被计算。</p>
<p><img src="http://www.oracle.com/webfolder/technetwork/tutorials/obe/java/G1GettingStarted/images/slide14.png" alt="img"> <strong>（3) 重新标记阶段</strong></p>
<p>空的区域被清除和回收掉。所有区域的活性在此时计算。</p>
<p><img src="http://www.oracle.com/webfolder/technetwork/tutorials/obe/java/G1GettingStarted/images/slide15.png" alt="img"> <strong>（4) 复制 / 清理阶段</strong></p>
<p>G1 选择活性最低的区域，这些区域能够以最快的速度回收。然后这些区域会在年轻代垃圾回收过程中被回收。在日志中被指示为 *[GC pause (mixed)]*。所以年轻代和年老代在同一时间被回收。</p>
<p><img src="http://www.oracle.com/webfolder/technetwork/tutorials/obe/java/G1GettingStarted/images/slide16.png" alt="img"> <strong>（5) 复制 / 清理阶段之后</strong></p>
<p>被选择的区域已经被回收和压缩到图中显示的深蓝色区和深绿色区中。</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/slide17.png" alt="img"></p>
<h3 id="-837"><a class="markdownIt-Anchor" href="#-837">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#_3-5-%E6%80%BB%E7%BB%93">#</a>3.5. 总结</h3>
<table>
<thead>
<tr>
<th style="text-align:center">收集器</th>
<th style="text-align:center">串行 / 并行 / 并发</th>
<th style="text-align:center">年轻代 / 老年代</th>
<th style="text-align:center">收集算法</th>
<th style="text-align:center">目标</th>
<th style="text-align:center">适用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><strong>Serial</strong></td>
<td style="text-align:center">串行</td>
<td style="text-align:center">年轻代</td>
<td style="text-align:center">复制</td>
<td style="text-align:center">响应速度优先</td>
<td style="text-align:center">单 CPU 环境下的 Client 模式</td>
</tr>
<tr>
<td style="text-align:center"><strong>Serial Old</strong></td>
<td style="text-align:center">串行</td>
<td style="text-align:center">老年代</td>
<td style="text-align:center">标记 - 整理</td>
<td style="text-align:center">响应速度优先</td>
<td style="text-align:center">单 CPU 环境下的 Client 模式、CMS 的后备预案</td>
</tr>
<tr>
<td style="text-align:center"><strong>ParNew</strong></td>
<td style="text-align:center">串行 + 并行</td>
<td style="text-align:center">年轻代</td>
<td style="text-align:center">复制算法</td>
<td style="text-align:center">响应速度优先</td>
<td style="text-align:center">多 CPU 环境时在 Server 模式下与 CMS 配合</td>
</tr>
<tr>
<td style="text-align:center"><strong>Parallel Scavenge</strong></td>
<td style="text-align:center">串行 + 并行</td>
<td style="text-align:center">年轻代</td>
<td style="text-align:center">复制算法</td>
<td style="text-align:center">吞吐量优先</td>
<td style="text-align:center">在后台运算而不需要太多交互的任务</td>
</tr>
<tr>
<td style="text-align:center"><strong>Parallel Old</strong></td>
<td style="text-align:center">串行 + 并行</td>
<td style="text-align:center">老年代</td>
<td style="text-align:center">标记 - 整理</td>
<td style="text-align:center">吞吐量优先</td>
<td style="text-align:center">在后台运算而不需要太多交互的任务</td>
</tr>
<tr>
<td style="text-align:center"><strong>CMS</strong></td>
<td style="text-align:center">并行 + 并发</td>
<td style="text-align:center">老年代</td>
<td style="text-align:center">标记 - 清除</td>
<td style="text-align:center">响应速度优先</td>
<td style="text-align:center">集中在互联网站或 B/S 系统服务端上的 Java 应用</td>
</tr>
<tr>
<td style="text-align:center"><strong>G1</strong></td>
<td style="text-align:center">并行 + 并发</td>
<td style="text-align:center">年轻代 + 老年代</td>
<td style="text-align:center">标记 - 整理 + 复制算法</td>
<td style="text-align:center">响应速度优先</td>
<td style="text-align:center">面向服务端应用，将来替换 CMS</td>
</tr>
</tbody>
</table>
<h2 id="-838"><a class="markdownIt-Anchor" href="#-838">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#_4-%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E4%B8%8E%E5%9B%9E%E6%94%B6%E7%AD%96%E7%95%A5">#</a>4. 内存分配与回收策略</h2>
<p>对象的内存分配，也就是在堆上分配。主要分配在年轻代的 Eden 区上，少数情况下也可能直接分配在老年代中。</p>
<h3 id="-839"><a class="markdownIt-Anchor" href="#-839">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#_4-1-minor-gc">#</a>4.1. Minor GC</h3>
<p><strong>当  <code>Eden</code>  区空间不足时，触发 Minor GC</strong>。</p>
<p><strong>Minor GC 发生在年轻代上</strong>，因为年轻代对象存活时间很短，因此 Minor GC 会频繁执行，执行的速度一般也会比较快。</p>
<p>Minor GC 工作流程：</p>
<ol>
<li>Java 应用不断创建对象，通常都是分配在  <code>Eden</code>  区域，当其空间不足时（达到设定的阈值），触发 minor GC。仍然被引用的对象（绿色方块）存活下来，被复制到 JVM 选择的 Survivor 区域，而没有被引用的对象（黄色方块）则被回收。</li>
<li>经过一次 Minor GC，Eden 就会空闲下来，直到再次达到 Minor GC 触发条件。这时候，另外一个 Survivor 区域则会成为  <code>To</code>  区域，Eden 区域的存活对象和  <code>From</code>  区域对象，都会被复制到  <code>To</code>  区域，并且存活的年龄计数会被加 1。</li>
<li>类似第二步的过程会发生很多次，直到有对象年龄计数达到阈值，这时候就会发生所谓的晋升（Promotion）过程，如下图所示，超过阈值的对象会被晋升到老年代。这个阈值是可以通过  <code>-XX:MaxTenuringThreshold</code>  参数指定。</li>
</ol>
<h3 id="-840"><a class="markdownIt-Anchor" href="#-840">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#_4-2-full-gc">#</a>4.2. Full GC</h3>
<p><strong>Full GC 发生在老年代上</strong>，老年代对象和年轻代的相反，其存活时间长，因此 Full GC 很少执行，而且执行速度会比 Minor GC 慢很多。</p>
<h4 id="-841"><a class="markdownIt-Anchor" href="#-841">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E7%AD%96%E7%95%A5">#</a>内存分配策略</h4>
<p><strong>（一）对象优先在 Eden 分配</strong></p>
<p>大多数情况下，对象在年轻代 Eden 区分配，当 Eden 区空间不够时，发起 Minor GC。</p>
<p><strong>（二）大对象直接进入老年代</strong></p>
<p>大对象是指需要连续内存空间的对象，最典型的大对象是那种很长的字符串以及数组。</p>
<p>经常出现大对象会提前触发垃圾收集以获取足够的连续空间分配给大对象。</p>
<p><code>-XX:PretenureSizeThreshold</code> ，大于此值的对象直接在老年代分配，避免在 Eden 区和 Survivor 区之间的大量内存复制。</p>
<p><strong>（三）长期存活的对象进入老年代</strong></p>
<p>为对象定义年龄计数器，对象在 Eden 出生并经过 Minor GC 依然存活，将移动到 Survivor 中，年龄就增加 1 岁，增加到一定年龄则移动到老年代中。</p>
<p><code>-XX:MaxTenuringThreshold</code>  用来定义年龄的阈值。</p>
<p><strong>（四）动态对象年龄判定</strong></p>
<p>虚拟机并不是永远地要求对象的年龄必须达到  <code>MaxTenuringThreshold</code>  才能晋升老年代，如果在 Survivor 区中相同年龄所有对象大小的总和大于 Survivor 空间的一半，则年龄大于或等于该年龄的对象可以直接进入老年代，无需等到  <code>MaxTenuringThreshold</code>  中要求的年龄。</p>
<p><strong>（五）空间分配担保</strong></p>
<p>在发生 Minor GC 之前，虚拟机先检查老年代最大可用的连续空间是否大于年轻代所有对象总空间，如果条件成立的话，那么 Minor GC 可以确认是安全的；如果不成立的话虚拟机会查看  <code>HandlePromotionFailure</code>  设置值是否允许担保失败，如果允许那么就会继续检查老年代最大可用的连续空间是否大于历次晋升到老年代对象的平均大小，如果大于，将尝试着进行一次 Minor GC，尽管这次 Minor GC 是有风险的；如果小于，或者  <code>HandlePromotionFailure</code>  设置不允许冒险，那这时也要改为进行一次 Full GC。</p>
<h4 id="-842"><a class="markdownIt-Anchor" href="#-842">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gc.html#full-gc-%E7%9A%84%E8%A7%A6%E5%8F%91%E6%9D%A1%E4%BB%B6">#</a>Full GC 的触发条件</h4>
<p>对于 Minor GC，其触发条件非常简单，当 Eden 区空间满时，就将触发一次 Minor GC。而 Full GC 则相对复杂，有以下条件：</p>
<p><strong>（1）调用  <code>System.gc()</code> </strong></p>
<p>此方法的调用是建议虚拟机进行 Full GC，虽然只是建议而非一定，但很多情况下它会触发 Full GC，从而增加 Full GC 的频率，也即增加了间歇性停顿的次数。因此强烈建议能不使用此方法就不要使用，让虚拟机自己去管理它的内存。可通过  <code>-XX:DisableExplicitGC</code>  来禁止 RMI 调用  <code>System.gc()</code> 。</p>
<p><strong>（2）老年代空间不足</strong></p>
<p>老年代空间不足的常见场景为前文所讲的大对象直接进入老年代、长期存活的对象进入老年代等，当执行 Full GC 后空间仍然不足，则抛出  <code>java.lang.OutOfMemoryError: Java heap space</code> 。为避免以上原因引起的 Full GC，调优时应尽量做到让对象在 Minor GC 阶段被回收、让对象在年轻代多存活一段时间以及不要创建过大的对象及数组。</p>
<p><strong>（3）方法区空间不足</strong></p>
<p>JVM 规范中运行时数据区域中的<strong>方法区</strong>，在 HotSpot 虚拟机中又被习惯称为<strong>永久代</strong>，永久代中存放的是类的描述信息、常量、静态变量等数据，当系统中要加载的类、反射的类和调用的方法较多时，永久代可能会被占满，在未配置为采用 CMS GC 的情况下也会执行 Full GC。如果经过 Full GC 仍然回收不了，那么 JVM 会抛出  <code>java.lang.OutOfMemoryError: PermGen space</code>  错误。为避免永久代占满造成 Full GC 现象，可采用的方法为增大 Perm Gen 空间或转为使用 CMS GC。</p>
<p><strong>（4）Minor GC 的平均晋升空间大小大于老年代可用空间</strong></p>
<p>如果发现统计数据说之前 Minor GC 的平均晋升大小比目前老年代剩余的空间大，则不会触发 Minor GC 而是转为触发 Full GC。</p>
<p><strong>（5）对象大小大于 To 区和老年代的可用内存</strong></p>
<p>由  <code>Eden</code>  区、 <code>From</code>  区向  <code>To</code>  区复制时，对象大小大于 To 区可用内存，则把该对象转存到老年代，且老年代的可用内存小于该对象大小</p>
<hr>
<h1 id="jvm-字节码"><a class="markdownIt-Anchor" href="#jvm-字节码">#</a> JVM 字节码</h1>
<p>Java 之所以可以 “一次编译，到处运行”，一是因为 JVM 针对各种操作系统、平台都进行了定制，二是因为无论在什么平台，都可以编译生成固定格式的字节码（.class 文件）供 JVM 使用。</p>
<p><strong>.class 文件是一组以 8 位字节为基础单位的二进制流</strong>，各个数据项严格按照顺序紧凑地排列在 .class 文件中，中间没有添加任何分隔符。<strong>整个 .class 文件本质上就是一张表</strong>。</p>
<ul>
<li>\1. 字节码
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-bytecode.html#11-%E4%BB%80%E4%B9%88%E6%98%AF%E5%AD%97%E8%8A%82%E7%A0%81">1.1. 什么是字节码</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-bytecode.html#12-%E5%AD%97%E8%8A%82%E7%A0%81%E7%BB%93%E6%9E%84">1.2. 字节码结构</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-bytecode.html#13-%E5%AD%97%E8%8A%82%E7%A0%81%E6%93%8D%E4%BD%9C%E9%9B%86%E5%90%88">1.3. 字节码操作集合</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-bytecode.html#14-%E6%93%8D%E4%BD%9C%E6%95%B0%E6%A0%88%E5%92%8C%E5%AD%97%E8%8A%82%E7%A0%81">1.4. 操作数栈和字节码</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-bytecode.html#15-%E5%AD%97%E8%8A%82%E7%A0%81%E5%B7%A5%E5%85%B7">1.5. 字节码工具</a></li>
</ul>
</li>
<li>\2. 字节码增强
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-bytecode.html#21-asm">2.1. Asm</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-bytecode.html#22-javassist">2.2. Javassist</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-bytecode.html#3-%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">3. 参考资料</a></li>
</ul>
<h2 id="-843"><a class="markdownIt-Anchor" href="#-843">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-bytecode.html#_1-%E5%AD%97%E8%8A%82%E7%A0%81">#</a>1. 字节码</h2>
<h3 id="-844"><a class="markdownIt-Anchor" href="#-844">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-bytecode.html#_1-1-%E4%BB%80%E4%B9%88%E6%98%AF%E5%AD%97%E8%8A%82%E7%A0%81">#</a>1.1. 什么是字节码</h3>
<p>之所以被称之为字节码，是因为字节码文件由十六进制值组成，而 JVM 以两个十六进制值为一组，即以字节为单位进行读取。在 Java 中一般是用  <code>javac</code>  命令编译源代码为字节码文件，一个.java 文件从编译到运行的示例如下图所示。</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/9/10/16d19bdf4493c822?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="图1 Java运行示意图"></p>
<p>对于开发人员，了解字节码可以更准确、直观地理解 Java 语言中更深层次的东西，比如通过字节码，可以很直观地看到 Volatile 关键字如何在字节码上生效。另外，字节码增强技术在 Spring AOP、各种 ORM 框架、热部署中的应用屡见不鲜，深入理解其原理对于我们来说大有裨益。除此之外，由于 JVM 规范的存在，只要最终可以生成符合规范的字节码就可以在 JVM 上运行，因此这就给了各种运行在 JVM 上的语言（如 Scala、Groovy、Kotlin）一种契机，可以扩展 Java 所没有的特性或者实现各种语法糖。理解字节码后再学习这些语言，可以 “逆流而上”，从字节码视角看它的设计思路，学习起来也 “易如反掌”。</p>
<h3 id="-845"><a class="markdownIt-Anchor" href="#-845">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-bytecode.html#_1-2-%E5%AD%97%E8%8A%82%E7%A0%81%E7%BB%93%E6%9E%84">#</a>1.2. 字节码结构</h3>
<p>.java 文件通过 javac 编译后将得到一个.class 文件，比如编写一个简单的 ByteCodeDemo 类，如下图 2 的左侧部分：</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/9/10/16d19bdf44c9f803?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="图2 示例代码（左侧）及对应的字节码（右侧）"></p>
<p>编译后生成 ByteCodeDemo.class 文件，打开后是一堆十六进制数，按字节为单位进行分割后展示如图 2 右侧部分所示。上文提及过，JVM 对于字节码是有规范要求的，那么看似杂乱的十六进制符合什么结构呢？JVM 规范要求每一个字节码文件都要由十部分按照固定的顺序组成，整体结构如图 3 所示。接下来我们将一一介绍这十部分：</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/9/10/16d19bdf4505c321?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="图3 JVM规定的字节码结构"></p>
<p><strong>（1）魔数（Magic Number）</strong></p>
<p>每个  <code>.class</code>  文件的头 4 个字节称为 <strong> <code>魔数（magic number）</code> </strong>，它的唯一作用是确定这个文件是否为一个能被虚拟机接收的  <code>.class</code>  文件。魔数的固定值为： <code>0xCAFEBABE</code> 。</p>
<blockquote>
<p>有趣的是，魔数的固定值是 Java 之父 James Gosling 制定的，为 CafeBabe（咖啡宝贝），而 Java 的图标为一杯咖啡。</p>
</blockquote>
<p><strong>（2）版本号（Version）</strong></p>
<p>版本号为魔数之后的 4 个字节，<strong>前两个字节表示次版本号（Minor Version），后两个字节表示主版本号（Major Version）</strong>。</p>
<p>举例来说，如果版本号为：“00 00 00 34”。那么，次版本号转化为十进制为 0，主版本号转化为十进制为 52，在 Oracle 官网中查询序号 52 对应的主版本号为 1.8，所以编译该文件的 Java 版本号为 1.8.0。</p>
<p><strong>（3）常量池（Constant Pool）</strong></p>
<p>紧接着主版本号之后的字节为常量池入口。</p>
<p>常量池主要存放两类常量：</p>
<ul>
<li><strong>字面量</strong> - 如文本字符串、声明为  <code>final</code>  的常量值。</li>
<li>符号引用
<ul>
<li>类和接口的全限定名</li>
<li>字段的名称和描述符</li>
<li>方法的名称和描述符</li>
</ul>
</li>
</ul>
<p>常量池整体上分为两部分：常量池计数器以及常量池数据区，如下图 4 所示。</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/9/10/16d19bdf460b4b9d?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="图4 常量池的结构"></p>
<ul>
<li><strong>常量池计数器（constant_pool_count）</strong> - 由于常量的数量不固定，所以需要先放置两个字节来表示常量池容量计数值。图 2 中示例代码的字节码前 10 个字节如下图 5 所示，将十六进制的 24 转化为十进制值为 36，排除掉下标 “0”，也就是说，这个类文件中共有 35 个常量。</li>
</ul>
<p><img src="https://user-gold-cdn.xitu.io/2019/9/10/16d19bdf44f56bb2?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="图5 前十个字节及含义"></p>
<ul>
<li><strong>常量池数据区</strong> - 数据区是由（ <code>constant_pool_count-1</code> ）个 cp_info 结构组成，一个 cp_info 结构对应一个常量。在字节码中共有 14 种类型的 cp_info（如下图 6 所示），每种类型的结构都是固定的。</li>
</ul>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/1986868-831993b2dc19dd90.png" alt="img"></p>
<p>具体以 CONSTANT_utf8_info 为例，它的结构如下图 7 左侧所示。首先一个字节 “tag”，它的值取自上图 6 中对应项的 Tag，由于它的类型是 utf8_info，所以值为 “01”。接下来两个字节标识该字符串的长度 Length，然后 Length 个字节为这个字符串具体的值。从图 2 中的字节码摘取一个 cp_info 结构，如下图 7 右侧所示。将它翻译过来后，其含义为：该常量类型为 utf8 字符串，长度为一字节，数据为 “a”。</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/9/10/16d19bdf731b4fee?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="图7 CONSTANT_utf8_info的结构（左）及示例（右）"></p>
<p>其他类型的 cp_info 结构在本文不再赘述，整体结构大同小异，都是先通过 Tag 来标识类型，然后后续 n 个字节来描述长度和（或）数据。先知其所以然，以后可以通过 javap -verbose ByteCodeDemo 命令，查看 JVM 反编译后的完整常量池，如下图 8 所示。可以看到反编译结果将每一个 cp_info 结构的类型和值都很明确地呈现了出来。</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/9/10/16d19bdf732cbb78?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="图8 常量池反编译结果"></p>
<p><strong>（4）访问标志</strong></p>
<p>紧接着的 2 个字节代表访问标志，这个标志<strong>用于识别一些类或者接口的访问信息</strong>，描述该 Class 是类还是接口，以及是否被  <code>public</code> 、 <code>abstract</code> 、 <code>final</code>  等修饰符修饰。</p>
<p>JVM 规范规定了如下图 9 的访问标志（Access_Flag）。需要注意的是，JVM 并没有穷举所有的访问标志，而是使用按位或操作来进行描述的，比如某个类的修饰符为 Public Final，则对应的访问修饰符的值为 ACC_PUBLIC | ACC_FINAL，即 0x0001 | 0x0010=0x0011。</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/1561473228816.png" alt="img"> <strong>（5) 当前类名</strong></p>
<p>访问标志后的 2 个字节，描述的是当前类的全限定名。这两个字节保存的值为常量池中的索引值，根据索引值就能在常量池中找到这个类的全限定名。</p>
<p><strong>（6）父类名称</strong></p>
<p>当前类名后的 2 个字节，描述父类的全限定名，同上，保存的也是常量池中的索引值。</p>
<p><strong>（7）接口信息</strong></p>
<p>父类名称后为 2 字节的接口计数器，描述了该类或父类实现的接口数量。紧接着的 n 个字节是所有接口名称的字符串常量的索引值。</p>
<p><strong>（8）字段表</strong></p>
<p>字段表用于描述类和接口中声明的变量，包含类级别的变量以及实例变量，但是不包含方法内部声明的局部变量。字段表也分为两部分，第一部分为两个字节，描述字段个数；第二部分是每个字段的详细信息 fields_info。字段表结构如下图所示：</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/9/10/16d19bdf73378788?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="图10 字段表结构"></p>
<p>以图 2 中字节码的字段表为例，如下图 11 所示。其中字段的访问标志查图 9，0002 对应为 Private。通过索引下标在图 8 中常量池分别得到字段名为 “a”，描述符为 “I”（代表 int）。综上，就可以唯一确定出一个类中声明的变量 private int a。</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/9/10/16d19bdf734cb782?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="图11 字段表示例"></p>
<p><strong>（9）方法表</strong></p>
<p>字段表结束后为方法表，方法表也是由两部分组成，第一部分为两个字节描述方法的个数；第二部分为每个方法的详细信息。方法的详细信息较为复杂，包括方法的访问标志、方法名、方法的描述符以及方法的属性，如下图所示：</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/9/10/16d19bdf7333358e?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="图12 方法表结构"></p>
<p>方法的权限修饰符依然可以通过图 9 的值查询得到，方法名和方法的描述符都是常量池中的索引值，可以通过索引值在常量池中找到。而 “方法的属性” 这一部分较为复杂，直接借助 javap -verbose 将其反编译为人可以读懂的信息进行解读，如图 13 所示。可以看到属性中包括以下三个部分：</p>
<ul>
<li>“Code 区”：源代码对应的 JVM 指令操作码，在进行字节码增强时重点操作的就是 “Code 区” 这一部分。</li>
<li>“LineNumberTable”：行号表，将 Code 区的操作码和源代码中的行号对应，Debug 时会起到作用（源代码走一行，需要走多少个 JVM 指令操作码）。</li>
<li>“LocalVariableTable”：本地变量表，包含 This 和局部变量，之所以可以在每一个方法内部都可以调用 This，是因为 JVM 将 This 作为每一个方法的第一个参数隐式进行传入。当然，这是针对非 Static 方法而言。</li>
</ul>
<p><img src="https://user-gold-cdn.xitu.io/2019/9/10/16d19bdf9d3f442f?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="图13 反编译后的方法表"></p>
<p><strong>（10）附加属性表</strong></p>
<p>字节码的最后一部分，该项存放了在该文件中类或接口所定义属性的基本信息。</p>
<h3 id="-846"><a class="markdownIt-Anchor" href="#-846">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-bytecode.html#_1-3-%E5%AD%97%E8%8A%82%E7%A0%81%E6%93%8D%E4%BD%9C%E9%9B%86%E5%90%88">#</a>1.3. 字节码操作集合</h3>
<p>在上图 13 中，Code 区的红色编号 0 ～ 17，就是.java 中的方法源代码编译后让 JVM 真正执行的操作码。为了帮助人们理解，反编译后看到的是十六进制操作码所对应的助记符，十六进制值操作码与助记符的对应关系，以及每一个操作码的用处可以查看 Oracle 官方文档进行了解，在需要用到时进行查阅即可。比如上图中第一个助记符为 iconst_2，对应到图 2 中的字节码为 0x05，用处是将 int 值 2 压入操作数栈中。以此类推，对 0~17 的助记符理解后，就是完整的 add () 方法的实现。</p>
<h3 id="-847"><a class="markdownIt-Anchor" href="#-847">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-bytecode.html#_1-4-%E6%93%8D%E4%BD%9C%E6%95%B0%E6%A0%88%E5%92%8C%E5%AD%97%E8%8A%82%E7%A0%81">#</a>1.4. 操作数栈和字节码</h3>
<p>JVM 的指令集是基于栈而不是寄存器，基于栈可以具备很好的跨平台性（因为寄存器指令集往往和硬件挂钩），但缺点在于，要完成同样的操作，基于栈的实现需要更多指令才能完成（因为栈只是一个 FILO 结构，需要频繁压栈出栈）。另外，由于栈是在内存实现的，而寄存器是在 CPU 的高速缓存区，相较而言，基于栈的速度要慢很多，这也是为了跨平台性而做出的牺牲。</p>
<p>我们在上文所说的操作码或者操作集合，其实控制的就是这个 JVM 的操作数栈。为了更直观地感受操作码是如何控制操作数栈的，以及理解常量池、变量表的作用，将 add () 方法的对操作数栈的操作制作为 GIF，如下图 14 所示，图中仅截取了常量池中被引用的部分，以指令 iconst_2 开始到 ireturn 结束，与图 13 中 Code 区 0~17 的指令一一对应：</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/9/10/16d19bdf9f0ee846?imageslim" alt="图14 控制操作数栈示意图"></p>
<h3 id="-848"><a class="markdownIt-Anchor" href="#-848">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-bytecode.html#_1-5-%E5%AD%97%E8%8A%82%E7%A0%81%E5%B7%A5%E5%85%B7">#</a>1.5. 字节码工具</h3>
<p>如果每次查看反编译后的字节码都使用 javap 命令的话，好非常繁琐。这里推荐一个 Idea 插件：<a target="_blank" rel="noopener" href="https://plugins.jetbrains.com/plugin/9248-jclasslib-bytecode-viewer">jclasslib (opens new window)</a>。使用效果如图 15 所示，代码编译后在菜单栏 &quot;View&quot; 中选择 &quot;Show Bytecode With jclasslib&quot;，可以很直观地看到当前字节码文件的类信息、常量池、方法区等信息。</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/9/10/16d19bdfa08b6904?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="图15 jclasslib查看字节码"></p>
<h2 id="-849"><a class="markdownIt-Anchor" href="#-849">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-bytecode.html#_2-%E5%AD%97%E8%8A%82%E7%A0%81%E5%A2%9E%E5%BC%BA">#</a>2. 字节码增强</h2>
<h3 id="-850"><a class="markdownIt-Anchor" href="#-850">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-bytecode.html#_2-1-asm">#</a>2.1. Asm</h3>
<p>对于需要手动操纵字节码的需求，可以使用 Asm，它可以直接生产  <code>.class</code>  字节码文件，也可以在类被加载入 JVM 之前动态修改类行为（如下图 17 所示）。</p>
<p>Asm 的应用场景有 AOP（Cglib 就是基于 Asm）、热部署、修改其他 jar 包中的类等。当然，涉及到如此底层的步骤，实现起来也比较麻烦。</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/9/10/16d19bdfad737fd7?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="图17 Asm修改字节码"></p>
<p>Asm 有两类 API：核心 API 和树形 API</p>
<h4 id="-851"><a class="markdownIt-Anchor" href="#-851">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-bytecode.html#%E6%A0%B8%E5%BF%83-api">#</a>核心 API</h4>
<p>Asm Core API 可以类比解析 XML 文件中的 SAX 方式，不需要把这个类的整个结构读取进来，就可以用流式的方法来处理字节码文件。好处是非常节约内存，但是编程难度较大。然而出于性能考虑，一般情况下编程都使用 Core API。在 Core API 中有以下几个关键类：</p>
<ul>
<li>ClassReader：用于读取已经编译好的.class 文件。</li>
<li>ClassWriter：用于重新构建编译后的类，如修改类名、属性以及方法，也可以生成新的类的字节码文件。</li>
<li>各种 Visitor 类：如上所述，CoreAPI 根据字节码从上到下依次处理，对于字节码文件中不同的区域有不同的 Visitor，比如用于访问方法的 MethodVisitor、用于访问类变量的 FieldVisitor、用于访问注解的 AnnotationVisitor 等。为了实现 AOP，重点要使用的是 MethodVisitor。</li>
</ul>
<h4 id="-852"><a class="markdownIt-Anchor" href="#-852">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-bytecode.html#%E6%A0%91%E5%BD%A2-api">#</a>树形 API</h4>
<p>Asm Tree API 可以类比解析 XML 文件中的 DOM 方式，把整个类的结构读取到内存中，缺点是消耗内存多，但是编程比较简单。TreeApi 不同于 CoreAPI，TreeAPI 通过各种 Node 类来映射字节码的各个区域，类比 DOM 节点，就可以很好地理解这种编程方式。</p>
<h3 id="-853"><a class="markdownIt-Anchor" href="#-853">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-bytecode.html#_2-2-javassist">#</a>2.2. Javassist</h3>
<p>利用 Javassist 实现字节码增强时，可以无须关注字节码刻板的结构，其优点就在于编程简单。直接使用 java 编码的形式，而不需要了解虚拟机指令，就能动态改变类的结构或者动态生成类。</p>
<p>其中最重要的是 ClassPool、CtClass、CtMethod、CtField 这四个类：</p>
<ul>
<li><code>CtClass（compile-time class）</code>  - 编译时类信息，它是一个 class 文件在代码中的抽象表现形式，可以通过一个类的全限定名来获取一个 CtClass 对象，用来表示这个类文件。</li>
<li><code>ClassPool</code>  - 从开发视角来看，ClassPool 是一张保存 CtClass 信息的 HashTable，key 为类名，value 为类名对应的 CtClass 对象。当我们需要对某个类进行修改时，就是通过 pool.getCtClass (“className”) 方法从 pool 中获取到相应的 CtClass。</li>
<li><code>CtMethod</code> 、 <code>CtField</code>  - 这两个比较好理解，对应的是类中的方法和属性。</li>
</ul>
<hr>
<h1 id="jvm-类加载"><a class="markdownIt-Anchor" href="#jvm-类加载">#</a> JVM 类加载</h1>
<blockquote>
<p><strong>📦 本文以及示例源码已归档在 <a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/">javacore(opens new window)</a></strong></p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/20200617145849.png" alt="img"></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-class-loader.html#1-%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6">1. 类加载机制</a></li>
<li>\2. 类的生命周期
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-class-loader.html#21-%E4%B8%80%E5%8A%A0%E8%BD%BD">2.1. （一）加载</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-class-loader.html#22-%E4%BA%8C%E9%AA%8C%E8%AF%81">2.2. （二）验证</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-class-loader.html#23-%E4%B8%89%E5%87%86%E5%A4%87">2.3. （三）准备</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-class-loader.html#24-%E5%9B%9B%E8%A7%A3%E6%9E%90">2.4. （四）解析</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-class-loader.html#25-%E4%BA%94%E5%88%9D%E5%A7%8B%E5%8C%96">2.5. （五）初始化</a></li>
</ul>
</li>
<li>\3. ClassLoader
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-class-loader.html#31-%E7%B1%BB%E4%B8%8E%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8">3.1. 类与类加载器</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-class-loader.html#32-%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%88%86%E7%B1%BB">3.2. 类加载器分类</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-class-loader.html#33-%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE">3.3. 双亲委派</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-class-loader.html#34-classloader-%E5%8F%82%E6%95%B0">3.4. ClassLoader 参数</a></li>
</ul>
</li>
<li>\4. 类的加载
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-class-loader.html#41-%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%96%B9%E5%BC%8F">4.1. 类加载方式</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-class-loader.html#42-%E5%8A%A0%E8%BD%BD%E7%B1%BB%E9%94%99%E8%AF%AF">4.2. 加载类错误</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-class-loader.html#5-%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">5. 参考资料</a></li>
</ul>
<h2 id="-854"><a class="markdownIt-Anchor" href="#-854">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-class-loader.html#_1-%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6">#</a>1. 类加载机制</h2>
<blockquote>
<p>类是在运行期间动态加载的。</p>
</blockquote>
<p>类的加载指的是将类的  <code>.class</code>  文件中的二进制数据读入到内存中，将其放在运行时数据区的方法区内，然后在堆区创建一个 <code>java.lang.Class</code>  对象，用来封装类在方法区内的数据结构。类的加载的最终产品是位于堆区中的 <code>Class</code>  对象， <code>Class</code>  对象封装了类在方法区内的数据结构，并且向 Java 程序员提供了访问方法区内的数据结构的接口。</p>
<p>类加载器并不需要等到某个类被 “首次主动使用” 时再加载它，JVM 规范允许类加载器在预料某个类将要被使用时就预先加载它，如果在预先加载的过程中遇到了.class 文件缺失或存在错误，类加载器必须在程序首次主动使用该类时才报告错误（LinkageError 错误）如果这个类一直没有被程序主动使用，那么类加载器就不会报告错误</p>
<h2 id="-855"><a class="markdownIt-Anchor" href="#-855">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-class-loader.html#_2-%E7%B1%BB%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F">#</a>2. 类的生命周期</h2>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/20200617115110.png" alt="img"></p>
<p>Java 类的完整生命周期包括以下几个阶段：</p>
<ul>
<li><strong>加载（Loading）</strong></li>
<li>链接（Linking）
<ul>
<li><strong>验证（Verification）</strong></li>
<li><strong>准备（Preparation）</strong></li>
<li><strong>解析（Resolution）</strong></li>
</ul>
</li>
<li><strong>初始化（Initialization）</strong></li>
<li><strong>使用（Using）</strong></li>
<li><strong>卸载（Unloading）</strong></li>
</ul>
<p>加载、验证、准备、初始化和卸载这 5 个阶段的顺序是确定的，类的加载过程必须按照这种顺序按部就班地开始。而<strong>解析过程在某些情况下可以在初始化阶段之后再开始，这是为了支持 Java 的动态绑定</strong>。</p>
<p>类加载过程是指加载、验证、准备、解析和初始化这 5 个阶段。</p>
<h3 id="-856"><a class="markdownIt-Anchor" href="#-856">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-class-loader.html#_2-1-%E4%B8%80-%E5%8A%A0%E8%BD%BD">#</a>2.1. （一）加载</h3>
<p>加载是类加载的一个阶段，注意不要混淆。</p>
<p><strong>加载，是指查找字节流，并且据此创建类的过程</strong>。</p>
<p>加载过程完成以下三件事：</p>
<ul>
<li>通过一个类的全限定名来获取定义此类的二进制字节流。</li>
<li>将这个字节流所代表的静态存储结构转化为方法区的运行时存储结构。</li>
<li>在内存中生成一个代表这个类的  <code>Class</code>  对象，作为方法区这个类的各种数据的访问入口。</li>
</ul>
<p>其中二进制字节流可以从以下方式中获取：</p>
<ul>
<li>从 ZIP 包读取，这很常见，最终成为日后 JAR、EAR、WAR 格式的基础。</li>
<li>从网络中获取，这种场景最典型的应用是 Applet。</li>
<li>运行时计算生成，这种场景使用得最多得就是动态代理技术，在  <code>java.lang.reflect.Proxy</code>  中，就是用了  <code>ProxyGenerator.generateProxyClass</code>  的代理类的二进制字节流。</li>
<li>由其他文件生成，典型场景是 JSP 应用，即由 JSP 文件生成对应的 Class 类。</li>
<li>从数据库读取，这种场景相对少见，例如有些中间件服务器（如 SAP Netweaver）可以选择把程序安装到数据库中来完成程序代码在集群间的分发。 …</li>
</ul>
<blockquote>
<p>更详细内容会在 <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-class-loader.html#3-classloader">3. ClassLoader</a> 介绍。</p>
</blockquote>
<h3 id="-857"><a class="markdownIt-Anchor" href="#-857">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-class-loader.html#_2-2-%E4%BA%8C-%E9%AA%8C%E8%AF%81">#</a>2.2. （二）验证</h3>
<p>验证是链接阶段的第一步。<strong>验证的目标是确保 Class 文件的字节流中包含的信息符合当前虚拟机的要求</strong>，并且不会危害虚拟机自身的安全。</p>
<p>验证阶段大致会完成 4 个阶段的检验动作：</p>
<ul>
<li><strong>文件格式验证</strong> - 验证字节流是否符合 Class 文件格式的规范，并且能被当前版本的虚拟机处理。</li>
<li><strong>元数据验证</strong> - 对字节码描述的信息进行语义分析，以保证其描述的信息符合 Java 语言规范的要求。</li>
<li><strong>字节码验证</strong> - 通过数据流和控制流分析，确保程序语义是合法、符合逻辑的。</li>
<li><strong>符号引用验证</strong> - 发生在虚拟机将符号引用转换为直接引用的时候，对类自身以外（常量池中的各种符号引用）的信息进行匹配性校验。</li>
</ul>
<p>验证阶段是非常重要的，但不是必须的，它对程序运行期没有影响，如果所引用的类经过反复验证，那么可以考虑采用  <code>-Xverifynone</code>  参数来关闭大部分的类验证措施，以缩短虚拟机类加载的时间。</p>
<h3 id="-858"><a class="markdownIt-Anchor" href="#-858">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-class-loader.html#_2-3-%E4%B8%89-%E5%87%86%E5%A4%87">#</a>2.3. （三）准备</h3>
<p><strong>类变量是被 static 修饰的变量，准备阶段为 static 变量在方法区分配内存并初始化为默认值，使用的是方法区的内存。</strong></p>
<p>实例变量不会在这阶段分配内存，它将会在对象实例化时随着对象一起分配在 Java 堆中。（实例化不是类加载的一个过程，类加载发生在所有实例化操作之前，并且类加载只进行一次，实例化可以进行多次）</p>
<p>初始值一般为 0 值，例如下面的类变量 value 被初始化为 0 而不是 123。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> value <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>如果类变量是常量，那么会按照表达式来进行初始化，而不是赋值为 0。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> value <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>准备阶段有以下几点需要注意：</p>
<ul>
<li>这时候进行内存分配的仅包括类变量（static），而不包括实例变量，实例变量会在对象实例化时随着对象一块分配在 Java 堆中。</li>
<li>这里所设置的初始值通常情况下是数据类型默认的零值（如  <code>0</code> 、 <code>0L</code> 、 <code>null</code> 、 <code>false</code>  等），而不是被在 Java 代码中被显式地赋予的值。</li>
</ul>
<p>假设一个类变量的定义为： <code>public static int value = 3</code> ；</p>
<p>那么变量 value 在准备阶段过后的初始值为 0，而不是 3，因为这时候尚未开始执行任何 Java 方法，而把 value 赋值为 3 的 <code>public static</code>  指令是在程序编译后，存放于类构造器 <code>（）</code> 方法之中的，所以把 value 赋值为 3 的动作将在初始化阶段才会执行。</p>
<blockquote>
<p>这里还需要注意如下几点：</p>
<ul>
<li>对基本数据类型来说，对于类变量（static）和全局变量，如果不显式地对其赋值而直接使用，则系统会为其赋予默认的零值，而对于局部变量来说，在使用前必须显式地为其赋值，否则编译时不通过。</li>
<li>对于同时被 static 和 final 修饰的常量，必须在声明的时候就为其显式地赋值，否则编译时不通过；而只被 final 修饰的常量则既可以在声明时显式地为其赋值，也可以在类初始化时显式地为其赋值，总之，在使用前必须为其显式地赋值，系统不会为其赋予默认零值。</li>
<li>对于引用数据类型 reference 来说，如数组引用、对象引用等，如果没有对其进行显式地赋值而直接使用，系统都会为其赋予默认的零值，即 null。</li>
<li>如果在数组初始化时没有对数组中的各元素赋值，那么其中的元素将根据对应的数据类型而被赋予默认的零值。</li>
</ul>
</blockquote>
<ul>
<li>如果类字段的字段属性表中存在 <code>ConstantValue</code>  属性，即同时被 final 和 static 修饰，那么在准备阶段变量 value 就会被初始化为 ConstValue 属性所指定的值。</li>
</ul>
<p>假设上面的类变量 value 被定义为：  <code>public static final int value = 3</code> ；</p>
<p>编译时 Javac 将会为 value 生成 ConstantValue 属性，在准备阶段虚拟机就会根据 <code>ConstantValue</code>  的设置将 value 赋值为 3。我们可以理解为 static final 常量在编译期就将其结果放入了调用它的类的常量池中</p>
<h3 id="-859"><a class="markdownIt-Anchor" href="#-859">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-class-loader.html#_2-4-%E5%9B%9B-%E8%A7%A3%E6%9E%90">#</a>2.4. （四）解析</h3>
<p>在 class 文件被加载至 Java 虚拟机之前，这个类无法知道其他类及其方法、字段所对应的具体地址，甚至不知道自己方法、字段的地址。因此，每当需要引用这些成员时，Java 编译器会生成一个符号引用。在运行阶段，这个符号引用一般都能够无歧义地定位到具体目标上。</p>
<p>举例来说，对于一个方法调用，编译器会生成一个包含目标方法所在类的名字、目标方法的名字、接收参数类型以及返回值类型的符号引用，来指代所要调用的方法。</p>
<p><strong>解析阶段目标是将常量池的符号引用替换为直接引用的过程</strong>。解析动作主要针对类或接口、字段、类方法、接口方法、方法类型、方法句柄和调用点限定符 7 类符号引用进行。</p>
<ul>
<li><strong>符号引用（Symbolic References）</strong> - 符号引用以一组符号来描述所引用的目标，符号可以是任何形式的字面量，只要使用时能无歧义地定位到目标即可。</li>
<li><strong>直接引用（Direct Reference）</strong> - 直接引用可以是直接指向目标的指针、相对偏移量或是一个能间接定位到目标的句柄。</li>
</ul>
<h3 id="-860"><a class="markdownIt-Anchor" href="#-860">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-class-loader.html#_2-5-%E4%BA%94-%E5%88%9D%E5%A7%8B%E5%8C%96">#</a>2.5. （五）初始化</h3>
<p>在 Java 代码中，如果要初始化一个静态字段，可以在声明时直接赋值，也可以在静态代码块中对其赋值。</p>
<p>如果直接赋值的静态字段被  <code>final</code>  所修饰，并且它的类型是基本类型或字符串时，那么该字段便会被 Java 编译器标记成常量值（ConstantValue），其初始化直接由 Java 虚拟机完成。除此之外的直接赋值操作，以及所有静态代码块中的代码，则会被 Java 编译器置于同一方法中，并把它命名为  <code>&lt; clinit &gt;</code> 。</p>
<p>初始化阶段才真正开始执行类中的定义的 Java 程序代码。初始化，<strong>为类的静态变量赋予正确的初始值，JVM 负责对类进行初始化，主要对类变量进行初始化</strong>。</p>
<h4 id="-861"><a class="markdownIt-Anchor" href="#-861">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-class-loader.html#%E7%B1%BB%E5%88%9D%E5%A7%8B%E5%8C%96%E6%96%B9%E5%BC%8F">#</a>类初始化方式</h4>
<ul>
<li>声明类变量时指定初始值</li>
<li>使用静态代码块为类变量指定初始值</li>
</ul>
<blockquote>
<p>在准备阶段，类变量已经赋过一次系统要求的初始值，而在初始化阶段，根据程序员通过程序制定的主观计划去初始化类变量和其它资源。</p>
</blockquote>
<h4 id="-862"><a class="markdownIt-Anchor" href="#-862">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-class-loader.html#%E7%B1%BB%E5%88%9D%E5%A7%8B%E5%8C%96%E6%AD%A5%E9%AA%A4">#</a>类初始化步骤</h4>
<ol>
<li>如果类还没有被加载和链接，开始加载该类。</li>
<li>如果该类的直接父类还没有被初始化，先初始化其父类。</li>
<li>如果该类有初始化语句，则依次执行这些初始化语句。</li>
</ol>
<h4 id="-863"><a class="markdownIt-Anchor" href="#-863">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-class-loader.html#%E7%B1%BB%E5%88%9D%E5%A7%8B%E5%8C%96%E6%97%B6%E6%9C%BA">#</a>类初始化时机</h4>
<p>只有主动引用类的时候才会导致类的初始化。</p>
<p><strong>（1）主动引用</strong></p>
<p>类的主动引用包括以下六种：</p>
<ul>
<li><strong>创建类的实例</strong> - 也就是  <code>new</code>  对象</li>
<li><strong>访问静态变量</strong> - 访问某个类或接口的静态变量，或者对该静态变量赋值</li>
<li><strong>访问静态方法</strong></li>
<li><strong>反射</strong> - 如 <code>Class.forName(“com.shengsiyuan.Test”)</code></li>
<li><strong>初始化子类</strong> - 初始化某个类的子类，则其父类也会被初始化</li>
<li><strong>启动类</strong> - Java 虚拟机启动时被标明为启动类的类（ <code>Java Test</code> ），直接使用 <code>java.exe</code>  命令来运行某个主类</li>
</ul>
<p><strong>（2）被动引用</strong></p>
<p>以上 5 种场景中的行为称为对一个类进行主动引用。除此之外，所有引用类的方式都不会触发初始化，称为被动引用。被动引用的常见例子包括：</p>
<ul>
<li><strong>通过子类引用父类的静态字段，不会导致子类初始化</strong>。</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">SubClass</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// value 字段在 SuperClass 中定义</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li><strong>通过数组定义来引用类，不会触发此类的初始化</strong>。该过程会对数组类进行初始化，数组类是一个由虚拟机自动生成的、直接继承自  <code>Object</code>  的子类，其中包含了数组的属性和方法。</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">SuperClass</span><span class="token punctuation">[</span><span class="token punctuation">]</span> sca <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SuperClass</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>常量在编译阶段会存入调用类的常量池中，本质上并没有直接引用到定义常量的类，因此不会触发<strong>定义常量的类的初始化</strong>。</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">ConstClass</span><span class="token punctuation">.</span>HELLOWORLD<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="-864"><a class="markdownIt-Anchor" href="#-864">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-class-loader.html#%E7%B1%BB%E5%88%9D%E5%A7%8B%E5%8C%96%E7%BB%86%E8%8A%82">#</a>类初始化细节</h4>
<p>类初始化  <code>&lt;clinit&gt;()</code>  方法的细节：</p>
<ul>
<li>是由编译器自动收集类中所有类变量的赋值动作和静态语句块（static {} 块）中的语句合并产生的，编译器收集的顺序由语句在源文件中出现的顺序决定。特别注意的是，静态语句块只能访问到定义在它之前的类变量，定义在它之后的类变量只能赋值，不能访问。例如以下代码：</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">static</span> <span class="token punctuation">&#123;</span>
        i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                <span class="token comment">// 给变量赋值可以正常编译通过</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 这句编译器会提示“非法向前引用”</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">static</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>与类的构造函数（或者说实例构造器  <code>&lt;init&gt;()</code> ）不同，不需要显式的调用父类的构造器。虚拟机会自动保证在子类的  <code>&lt;clinit&gt;()</code>  方法运行之前，父类的  <code>&lt;clinit&gt;()</code>  方法已经执行结束。因此虚拟机中第一个执行  <code>&lt;clinit&gt;()</code>  方法的类肯定为  <code>java.lang.Object</code> 。</li>
<li>由于父类的  <code>&lt;clinit&gt;()</code>  方法先执行，也就意味着父类中定义的静态语句块要优于子类的变量赋值操作。例如以下代码：</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Parent</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token class-name">A</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">A</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Sub</span> <span class="token keyword">extends</span> <span class="token class-name">Parent</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token class-name">B</span> <span class="token operator">=</span> <span class="token class-name">A</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
     <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Sub<span class="token punctuation">.</span>B</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 输出结果是父类中的静态变量 A 的值，也就是 2。</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><code>&lt;clinit&gt;()</code>  方法对于类或接口不是必须的，如果一个类中不包含静态语句块，也没有对类变量的赋值操作，编译器可以不为该类生成  <code>&lt;clinit&gt;()</code>  方法。</li>
<li>接口中不可以使用静态语句块，但仍然有类变量初始化的赋值操作，因此接口与类一样都会生成  <code>&lt;clinit&gt;()</code>  方法。但接口与类不同的是，执行接口的  <code>&lt;clinit&gt;()</code>  方法不需要先执行父接口的  <code>&lt;clinit&gt;()</code>  方法。只有当父接口中定义的变量使用时，父接口才会初始化。另外，接口的实现类在初始化时也一样不会执行接口的  <code>&lt;clinit&gt;()</code>  方法。</li>
<li>虚拟机会保证一个类的  <code>&lt;clinit&gt;()</code>  方法在多线程环境下被正确的加锁和同步，如果多个线程同时初始化一个类，只会有一个线程执行这个类的  <code>&lt;clinit&gt;()</code>  方法，其它线程都会阻塞等待，直到活动线程执行  <code>&lt;clinit&gt;()</code>  方法完毕。如果在一个类的  <code>&lt;clinit&gt;()</code>  方法中有耗时的操作，就可能造成多个线程阻塞，在实际过程中此种阻塞很隐蔽。</li>
</ul>
<h2 id="-865"><a class="markdownIt-Anchor" href="#-865">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-class-loader.html#_3-classloader">#</a>3. ClassLoader</h2>
<p><code>ClassLoader</code>  即类加载器，负责将类加载到 JVM。在 Java 虚拟机外部实现，以便让应用程序自己决定如何去获取所需要的类。</p>
<p>JVM 加载  <code>class</code>  文件到内存有两种方式：</p>
<ul>
<li>隐式加载 - JVM 自动加载需要的类到内存中。</li>
<li>显示加载 - 通过使用  <code>ClassLoader</code>  来加载一个类到内存中。</li>
</ul>
<h3 id="-866"><a class="markdownIt-Anchor" href="#-866">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-class-loader.html#_3-1-%E7%B1%BB%E4%B8%8E%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8">#</a>3.1. 类与类加载器</h3>
<p>如何判断两个类是否相等：类本身相等，并且使用同一个类加载器进行加载。这是因为<strong>每一个  <code>ClassLoader</code>  都拥有一个独立的类名称空间</strong>。</p>
<p>这里的相等，包括类的  <code>Class</code>  对象的  <code>equals()</code>  方法、 <code>isAssignableFrom()</code>  方法、 <code>isInstance()</code>  方法的返回结果为 true，也包括使用  <code>instanceof</code>  关键字做对象所属关系判定结果为 true。</p>
<h3 id="-867"><a class="markdownIt-Anchor" href="#-867">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-class-loader.html#_3-2-%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%88%86%E7%B1%BB">#</a>3.2. 类加载器分类</h3>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200617115936.png" alt="img"></p>
<h4 id="-868"><a class="markdownIt-Anchor" href="#-868">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-class-loader.html#bootstrap-classloader">#</a>Bootstrap ClassLoader</h4>
<p><code>Bootstrap ClassLoader</code>  ，即启动类加载器 ，<strong>负责加载 JVM 自身工作所需要的类</strong>。</p>
<p><strong> <code>Bootstrap ClassLoader</code>  会将存放在  <code>&lt;JAVA_HOME&gt;\lib</code>  目录中的，或者被  <code>-Xbootclasspath</code>  参数所指定的路径中的，并且是虚拟机识别的（仅按照文件名识别，如 rt.jar，名字不符合的类库即使放在 lib 目录中也不会被加载）类库加载到虚拟机内存中</strong>。</p>
<p><code>Bootstrap ClassLoader</code>  是由 C++ 实现的，它完全由 JVM 自己控制的，启动类加载器无法被 Java 程序直接引用，用户在编写自定义类加载器时，如果需要把加载请求委派给启动类加载器，直接使用  <code>null</code>  代替即可。</p>
<h4 id="-869"><a class="markdownIt-Anchor" href="#-869">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-class-loader.html#extclassloader">#</a>ExtClassLoader</h4>
<p><code>ExtClassLoader</code> ，即扩展类加载器，这个类加载器是由  <code>ExtClassLoader(sun.misc.Launcher\$ExtClassLoader)</code>  实现的。</p>
<p><strong> <code>ExtClassLoader</code>  负责将  <code>&lt;JAVA_HOME&gt;\lib\ext</code>  或者被  <code>java.ext.dir</code>  系统变量所指定路径中的所有类库加载到内存中，开发者可以直接使用扩展类加载器</strong>。</p>
<h4 id="-870"><a class="markdownIt-Anchor" href="#-870">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-class-loader.html#appclassloader">#</a>AppClassLoader</h4>
<p><code>AppClassLoader</code> ，即应用程序类加载器，这个类加载器是由  <code>AppClassLoader(sun.misc.Launcher\$AppClassLoader)</code>  实现的。由于这个类加载器是  <code>ClassLoader</code>  中的  <code>getSystemClassLoader()</code>  方法的返回值，因此一般称为系统类加载器。</p>
<p><strong> <code>AppClassLoader</code>  负责加载用户类路径（即  <code>classpath</code> ）上所指定的类库</strong>，开发者可以直接使用这个类加载器，如果应用程序中没有自定义过自己的类加载器，一般情况下这个就是程序中默认的类加载器。</p>
<h4 id="-871"><a class="markdownIt-Anchor" href="#-871">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-class-loader.html#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8">#</a>自定义类加载器</h4>
<p>自定义类加载器可以做到如下几点：</p>
<ul>
<li>在执行非置信代码之前，自动验证数字签名。</li>
<li>动态地创建符合用户特定需要的定制化构建类。</li>
<li>从特定的场所取得 java class，例如数据库中和网络中。</li>
</ul>
<p>假设，我们需要自定义一个名为  <code>FileSystemClassLoader</code>  的类加载器，继承自  <code>java.lang.ClassLoader</code> ，用于加载文件系统上的类。它首先根据类的全名在文件系统上查找类的字节代码文件（ <code>.class</code>  文件），然后读取该文件内容，最后通过  <code>defineClass()</code>  方法来把这些字节代码转换成  <code>java.lang.Class</code>  类的实例。</p>
<p><code>java.lang.ClassLoader</code>  类的方法  <code>loadClass()</code>  实现了双亲委派模型的逻辑，因此自定义类加载器一般不去覆写它，而是通过覆写  <code>findClass()</code>  方法。</p>
<p><code>ClassLoader</code>  常用的场景：</p>
<ul>
<li>容器 - 典型应用：Servlet 容器（如：Tomcat、Jetty）、udf （Mysql、Hive）等。加载解压 jar 包或 war 包后，加载其 Class 到指定的类加载器中运行（通常需要考虑空间隔离）。</li>
<li>热部署、热插拔 - 应用启动后，动态获得某个类信息，然后加载到 JVM 中工作。很多著名的容器软件、框架（如：Spring 等），都使用  <code>ClassLoader</code>  来实现自身的热部署。</li>
</ul>
<p>【示例】自定义一个类加载器</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FileSystemClassLoader</span> <span class="token keyword">extends</span> <span class="token class-name">ClassLoader</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> rootDir<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">FileSystemClassLoader</span><span class="token punctuation">(</span><span class="token class-name">String</span> rootDir<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>rootDir <span class="token operator">=</span> rootDir<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">protected</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> <span class="token function">findClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> classData <span class="token operator">=</span> <span class="token function">getClassData</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>classData <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token function">defineClass</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> classData<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> classData<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getClassData</span><span class="token punctuation">(</span><span class="token class-name">String</span> className<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> path <span class="token operator">=</span> <span class="token function">classNameToPath</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">InputStream</span> ins <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ByteArrayOutputStream</span> baos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> bufferSize <span class="token operator">=</span> <span class="token number">4096</span><span class="token punctuation">;</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span>bufferSize<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> bytesNumRead<span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>bytesNumRead <span class="token operator">=</span> ins<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                baos<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> bytesNumRead<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">return</span> baos<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">classNameToPath</span><span class="token punctuation">(</span><span class="token class-name">String</span> className<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> rootDir <span class="token operator">+</span> <span class="token class-name">File</span><span class="token punctuation">.</span>separatorChar
                <span class="token operator">+</span> className<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">,</span> <span class="token class-name">File</span><span class="token punctuation">.</span>separatorChar<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">".class"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-872"><a class="markdownIt-Anchor" href="#-872">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-class-loader.html#_3-3-%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE">#</a>3.3. 双亲委派</h3>
<p>理解双亲委派之前，先让我们看一个示例。</p>
<p>【示例】寻找类加载示例</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">ClassLoader</span> loader <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContextClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>loader<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>loader<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>loader<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>输出：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">sun.misc.Launcher$AppClassLoader@18b4aac2
sun.misc.Launcher$ExtClassLoader@19e1023e
null<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>从上面的结果可以看出，并没有获取到  <code>ExtClassLoader</code>  的父 Loader，原因是  <code>Bootstrap Loader</code> （引导类加载器）是用 C 语言实现的，找不到一个确定的返回父 Loader 的方式，于是就返回 null。</p>
<p>下图展示的类加载器之间的层次关系，称为类加载器的<strong>双亲委派模型（Parents Delegation Model）</strong>。<strong>该模型要求除了顶层的 Bootstrap ClassLoader 外，其余的类加载器都应有自己的父类加载器</strong>。<strong>这里类加载器之间的父子关系一般通过组合（Composition）关系来实现，而不是通过继承（Inheritance）的关系实现</strong>。</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/jmm-%25E7%25B1%25BB%25E5%258A%25A0%25E8%25BD%25BD-%25E5%258F%258C%25E4%25BA%25B2%25E5%25A7%2594%25E6%25B4%25BE.png" alt="img"></p>
<p><strong>（1）工作过程</strong></p>
<p><strong>一个类加载器首先将类加载请求传送到父类加载器，只有当父类加载器无法完成类加载请求时才尝试加载</strong>。</p>
<p><strong>（2）好处</strong></p>
<p><strong>使得 Java 类随着它的类加载器一起具有一种带有优先级的层次关系</strong>，从而使得基础类得到统一：</p>
<ul>
<li>系统类防止内存中出现多份同样的字节码</li>
<li>保证 Java 程序安全稳定运行</li>
</ul>
<p>例如：  <code>java.lang.Object</code>  存放在 rt.jar 中，如果编写另外一个  <code>java.lang.Object</code>  的类并放到  <code>classpath</code>  中，程序可以编译通过。因为双亲委派模型的存在，所以在 rt.jar 中的  <code>Object</code>  比在  <code>classpath</code>  中的  <code>Object</code>  优先级更高，因为 rt.jar 中的  <code>Object</code>  使用的是启动类加载器，而  <code>classpath</code>  中的  <code>Object</code>  使用的是应用程序类加载器。正因为 rt.jar 中的  <code>Object</code>  优先级更高，因为程序中所有的  <code>Object</code>  都是这个  <code>Object</code> 。</p>
<p><strong>（3）实现</strong></p>
<p>以下是抽象类  <code>java.lang.ClassLoader</code>  的代码片段，其中的  <code>loadClass()</code>  方法运行过程如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ClassLoader</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// The parent class loader for delegation</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ClassLoader</span> parent<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> <span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token function">loadClass</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">protected</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> <span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">boolean</span> resolve<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token function">getClassLoadingLock</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 首先判断该类型是否已经被加载</span>
            <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> c <span class="token operator">=</span> <span class="token function">findLoadedClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// 如果没有被加载，就委托给父类加载或者委派给启动类加载器加载</span>
                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token comment">// 如果存在父类加载器，就委派给父类加载器加载</span>
                        c <span class="token operator">=</span> parent<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                        <span class="token comment">// 如果不存在父类加载器，就检查是否是由启动类加载器加载的类，通过调用本地方法native Class findBootstrapClass(String name)</span>
                        c <span class="token operator">=</span> <span class="token function">findBootstrapClassOrNull</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">// 如果父类加载器加载失败，会抛出 ClassNotFoundException</span>
                <span class="token punctuation">&#125;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">// 如果父类加载器和启动类加载器都不能完成加载任务，才调用自身的加载功能</span>
                    c <span class="token operator">=</span> <span class="token function">findClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token function">resolveClass</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">return</span> c<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">protected</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> <span class="token function">findClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>【说明】</p>
<ul>
<li>先检查类是否已经加载过，如果没有则让父类加载器去加载。</li>
<li>当父类加载器加载失败时抛出  <code>ClassNotFoundException</code> ，此时尝试自己去加载。</li>
</ul>
<h3 id="-873"><a class="markdownIt-Anchor" href="#-873">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-class-loader.html#_3-4-classloader-%E5%8F%82%E6%95%B0">#</a>3.4. ClassLoader 参数</h3>
<p>在生产环境上启动 java 应用时，通常会指定一些  <code>ClassLoader</code>  参数，以加载应用所需要的 lib：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">java -jar xxx.jar -classpath lib/*<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><code>ClassLoader</code>  相关参数选项：</p>
<table>
<thead>
<tr>
<th>参数选项</th>
<th>ClassLoader 类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>-Xbootclasspath</code></td>
<td><code>Bootstrap ClassLoader</code></td>
<td>设置  <code>Bootstrap ClassLoader</code>  搜索路径。【不常用】</td>
</tr>
<tr>
<td><code>-Xbootclasspath/a</code></td>
<td><code>Bootstrap ClassLoader</code></td>
<td>把路径添加到已存在的  <code>Bootstrap ClassLoader</code>  搜索路径后面。【常用】</td>
</tr>
<tr>
<td><code>-Xbootclasspath/p</code></td>
<td><code>Bootstrap ClassLoader</code></td>
<td>把路径添加到已存在的  <code>Bootstrap ClassLoader</code>  搜索路径前面。【不常用】</td>
</tr>
<tr>
<td><code>-Djava.ext.dirs</code></td>
<td><code>ExtClassLoader</code></td>
<td>设置  <code>ExtClassLoader</code>  搜索路径。</td>
</tr>
<tr>
<td><code>-Djava.class.path</code>  或  <code>-cp</code>  或  <code>-classpath</code></td>
<td><code>AppClassLoader</code></td>
<td>设置  <code>AppClassLoader</code>  搜索路径。</td>
</tr>
</tbody>
</table>
<h2 id="-874"><a class="markdownIt-Anchor" href="#-874">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-class-loader.html#_4-%E7%B1%BB%E7%9A%84%E5%8A%A0%E8%BD%BD">#</a>4. 类的加载</h2>
<h3 id="-875"><a class="markdownIt-Anchor" href="#-875">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-class-loader.html#_4-1-%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%96%B9%E5%BC%8F">#</a>4.1. 类加载方式</h3>
<p>类加载有三种方式：</p>
<ul>
<li>命令行启动应用时候由 JVM 初始化加载</li>
<li>通过  <code>Class.forName()</code>  方法动态加载</li>
<li>通过  <code>ClassLoader.loadClass()</code>  方法动态加载</li>
</ul>
<p><strong> <code>Class.forName()</code>  和  <code>ClassLoader.loadClass()</code>  区别</strong></p>
<ul>
<li><code>Class.forName()</code>  将类的  <code>.class</code>  文件加载到 jvm 中之外，还会对类进行解释，执行类中的  <code>static</code>  块；</li>
<li><code>ClassLoader.loadClass()</code>  只干一件事情，就是将  <code>.class</code>  文件加载到 jvm 中，不会执行  <code>static</code>  中的内容，只有在  <code>newInstance</code>  才会去执行  <code>static</code>  块。</li>
<li><code>Class.forName(name, initialize, loader)</code>  带参函数也可控制是否加载  <code>static</code>  块。并且只有调用了  <code>newInstance()</code>  方法采用调用构造函数，创建类的对象 。</li>
</ul>
<h3 id="-876"><a class="markdownIt-Anchor" href="#-876">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-class-loader.html#_4-2-%E5%8A%A0%E8%BD%BD%E7%B1%BB%E9%94%99%E8%AF%AF">#</a>4.2. 加载类错误</h3>
<h4 id="-877"><a class="markdownIt-Anchor" href="#-877">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-class-loader.html#classnotfoundexception">#</a>ClassNotFoundException</h4>
<p><code>ClassNotFoundException</code>  异常出镜率极高。<strong> <code>ClassNotFoundException</code>  表示当前  <code>classpath</code>  下找不到指定类</strong>。</p>
<p>常见问题原因：</p>
<ul>
<li>调用  <code>Class</code>  的  <code>forName()</code>  方法，未找到类。</li>
<li>调用  <code>ClassLoader</code>  中的  <code>loadClass()</code>  方法，未找到类。</li>
<li>调用  <code>ClassLoader</code>  中的  <code>findSystemClass()</code>  方法，未找到类。</li>
</ul>
<p>【示例】执行以下代码，会抛出  <code>ClassNotFoundException</code>  异常：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClassNotFoundExceptionDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"NotFound"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>解决方法：检查  <code>classpath</code>  下有没有相应的 class 文件。</p>
<h4 id="-878"><a class="markdownIt-Anchor" href="#-878">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-class-loader.html#noclassdeffounderror">#</a>NoClassDefFoundError</h4>
<p>常见问题原因：</p>
<ul>
<li>类依赖的 Class 或者 jar 不存在。</li>
<li>类文件存在，但是存在不同的域中。</li>
</ul>
<p>解决方法：现代 Java 项目，一般使用  <code>maven</code> 、 <code>gradle</code>  等构建工具管理项目，仔细检查找不到的类所在的 jar 包是否已添加为依赖。</p>
<h4 id="-879"><a class="markdownIt-Anchor" href="#-879">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-class-loader.html#unsatisfiedlinkerror">#</a>UnsatisfiedLinkError</h4>
<p>这个异常倒不是很常见，但是出错的话，通常是在 JVM 启动的时候如果一不小心将在 JVM 中的某个 lib 删除了，可能就会报这个错误了。</p>
<p>【示例】执行以下代码，会抛出  <code>UnsatisfiedLinkError</code>  错误。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UnsatisfiedLinkErrorDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">nativeMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token string">"NoLib"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">new</span> <span class="token class-name">UnsatisfiedLinkErrorDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nativeMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>【输出】</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>UnsatisfiedLinkError</span><span class="token operator">:</span> no <span class="token class-name">NoLib</span> in java<span class="token punctuation">.</span>library<span class="token punctuation">.</span>path
	at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>ClassLoader</span><span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1867</span><span class="token punctuation">)</span>
	at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Runtime</span><span class="token punctuation">.</span><span class="token function">loadLibrary0</span><span class="token punctuation">(</span><span class="token class-name">Runtime</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">870</span><span class="token punctuation">)</span>
	at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>System</span><span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1122</span><span class="token punctuation">)</span>
	at <span class="token class-name"><span class="token namespace">io<span class="token punctuation">.</span>github<span class="token punctuation">.</span>dunwu<span class="token punctuation">.</span>javacore<span class="token punctuation">.</span>jvm<span class="token punctuation">.</span>classloader<span class="token punctuation">.</span>exception<span class="token punctuation">.</span></span>UnsatisfiedLinkErrorDemo</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span>clinit<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token class-name">UnsatisfiedLinkErrorDemo</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">12</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-880"><a class="markdownIt-Anchor" href="#-880">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-class-loader.html#classcastexception">#</a>ClassCastException</h4>
<p><code>ClassCastException</code>  异常通常是在程序中强制类型转换失败时出现。</p>
<p>【示例】执行以下代码，会抛出  <code>ClassCastException</code>  异常。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClassCastExceptionDemo</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Object</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">EmptyClass</span> newObj <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">EmptyClass</span><span class="token punctuation">)</span> obj<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">EmptyClass</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>【输出】</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Exception</span> in thread <span class="token string">"main"</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>ClassCastException</span><span class="token operator">:</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Object</span> cannot be cast <span class="token keyword">to</span> <span class="token namespace">io<span class="token punctuation">.</span>github<span class="token punctuation">.</span>dunwu<span class="token punctuation">.</span>javacore<span class="token punctuation">.</span>jvm<span class="token punctuation">.</span>classloader<span class="token punctuation">.</span>exception<span class="token punctuation">.</span></span><span class="token class-name">ClassCastExceptionDemo</span>$<span class="token class-name">EmptyClass</span>
	at <span class="token class-name"><span class="token namespace">io<span class="token punctuation">.</span>github<span class="token punctuation">.</span>dunwu<span class="token punctuation">.</span>javacore<span class="token punctuation">.</span>jvm<span class="token punctuation">.</span>classloader<span class="token punctuation">.</span>exception<span class="token punctuation">.</span></span>ClassCastExceptionDemo</span><span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">ClassCastExceptionDemo</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">11</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<hr>
<h1 id="jvm-实战"><a class="markdownIt-Anchor" href="#jvm-实战">#</a> JVM 实战</h1>
<blockquote>
<p><strong>📦 本文以及示例源码已归档在 <a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/">javacore(opens new window)</a></strong></p>
</blockquote>
<ul>
<li>\1. JVM 调优概述
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-action.html#11-gc-%E6%80%A7%E8%83%BD%E6%8C%87%E6%A0%87">1.1. GC 性能指标</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-action.html#12-%E8%B0%83%E4%BC%98%E5%8E%9F%E5%88%99">1.2. 调优原则</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-action.html#13-gc-%E4%BC%98%E5%8C%96%E7%9A%84%E8%BF%87%E7%A8%8B">1.3. GC 优化的过程</a></li>
</ul>
</li>
<li>\2. GC 日志
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-action.html#21-%E8%8E%B7%E5%8F%96-gc-%E6%97%A5%E5%BF%97">2.1. 获取 GC 日志</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-action.html#22-%E5%88%86%E6%9E%90-gc-%E6%97%A5%E5%BF%97">2.2. 分析 GC 日志</a></li>
</ul>
</li>
<li>\3. GC 配置
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-action.html#31-%E5%A0%86%E5%A4%A7%E5%B0%8F%E8%AE%BE%E7%BD%AE">3.1. 堆大小设置</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-action.html#32-jvm-%E5%86%85%E5%AD%98%E9%85%8D%E7%BD%AE">3.2. JVM 内存配置</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-action.html#33-gc-%E7%B1%BB%E5%9E%8B%E9%85%8D%E7%BD%AE">3.3. GC 类型配置</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-action.html#34-%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8%E9%80%9A%E7%94%A8%E5%8F%82%E6%95%B0">3.4. 垃圾回收器通用参数</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-action.html#35-jmx">3.5. JMX</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-action.html#36-%E8%BF%9C%E7%A8%8B-debug">3.6. 远程 DEBUG</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-action.html#37-heapdump">3.7. HeapDump</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-action.html#38-%E8%BE%85%E5%8A%A9%E9%85%8D%E7%BD%AE">3.8. 辅助配置</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-action.html#4-%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">4. 参考资料</a></li>
</ul>
<h2 id="-881"><a class="markdownIt-Anchor" href="#-881">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-action.html#_1-jvm-%E8%B0%83%E4%BC%98%E6%A6%82%E8%BF%B0">#</a>1. JVM 调优概述</h2>
<h3 id="-882"><a class="markdownIt-Anchor" href="#-882">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-action.html#_1-1-gc-%E6%80%A7%E8%83%BD%E6%8C%87%E6%A0%87">#</a>1.1. GC 性能指标</h3>
<p>对于 JVM 调优来说，需要先明确调优的目标。 从性能的角度看，通常关注三个指标：</p>
<ul>
<li><code>吞吐量（throughput）</code>  - 指不考虑 GC 引起的停顿时间或内存消耗，垃圾收集器能支撑应用达到的最高性能指标。</li>
<li><code>停顿时间（latency）</code>  - 其度量标准是缩短由于垃圾啊收集引起的停顿时间或者完全消除因垃圾收集所引起的停顿，避免应用运行时发生抖动。</li>
<li><code>垃圾回收频率</code>  - 久发生一次指垃圾回收呢？通常垃圾回收的频率越低越好，增大堆内存空间可以有效降低垃圾回收发生的频率，但同时也意味着堆积的回收对象越多，最终也会增加回收时的停顿时间。所以我们只要适当地增大堆内存空间，保证正常的垃圾回收频率即可。</li>
</ul>
<p>大多数情况下调优会侧重于其中一个或者两个方面的目标，很少有情况可以兼顾三个不同的角度。</p>
<h3 id="-883"><a class="markdownIt-Anchor" href="#-883">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-action.html#_1-2-%E8%B0%83%E4%BC%98%E5%8E%9F%E5%88%99">#</a>1.2. 调优原则</h3>
<p>GC 优化的两个目标：</p>
<ul>
<li><strong>降低 Full GC 的频率</strong></li>
<li><strong>减少 Full GC 的执行时间</strong></li>
</ul>
<p>GC 优化的基本原则是：将不同的 GC 参数应用到两个及以上的服务器上然后比较它们的性能，然后将那些被证明可以提高性能或减少 GC 执行时间的参数应用于最终的工作服务器上。</p>
<h4 id="-884"><a class="markdownIt-Anchor" href="#-884">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-action.html#%E9%99%8D%E4%BD%8E-minor-gc-%E9%A2%91%E7%8E%87">#</a>降低 Minor GC 频率</h4>
<p>如果新生代空间较小，Eden 区很快被填满，就会导致频繁 Minor GC，因此我们可以通过增大新生代空间来降低 Minor GC 的频率。</p>
<p>可能你会有这样的疑问，扩容 Eden 区虽然可以减少 Minor GC 的次数，但不会增加单次 Minor GC 的时间吗？如果单次 Minor GC 的时间增加，那也很难达到我们期待的优化效果呀。</p>
<p>我们知道，单次 Minor GC 时间是由两部分组成：T1（扫描新生代）和 T2（复制存活对象）。假设一个对象在 Eden 区的存活时间为 500ms，Minor GC 的时间间隔是 300ms，那么正常情况下，Minor GC 的时间为 ：T1+T2。</p>
<p>当我们增大新生代空间，Minor GC 的时间间隔可能会扩大到 600ms，此时一个存活 500ms 的对象就会在 Eden 区中被回收掉，此时就不存在复制存活对象了，所以再发生 Minor GC 的时间为：两次扫描新生代，即 2T1。</p>
<p>可见，扩容后，Minor GC 时增加了 T1，但省去了 T2 的时间。通常在虚拟机中，复制对象的成本要远高于扫描成本。</p>
<p>如果在堆内存中存在较多的长期存活的对象，此时增加年轻代空间，反而会增加 Minor GC 的时间。如果堆中的短期对象很多，那么扩容新生代，单次 Minor GC 时间不会显著增加。因此，单次 Minor GC 时间更多取决于 GC 后存活对象的数量，而非 Eden 区的大小。</p>
<h4 id="-885"><a class="markdownIt-Anchor" href="#-885">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-action.html#%E9%99%8D%E4%BD%8E-full-gc-%E7%9A%84%E9%A2%91%E7%8E%87">#</a>降低 Full GC 的频率</h4>
<p>Full GC 相对来说会比 Minor GC 更耗时。减少进入老年代的对象数量可以显著降低 Full GC 的频率。</p>
<p>** 减少创建大对象：*<em> 如果 *<em> 对象占用内存过大，在 Eden 区被创建后会直接被传入老年代</em></em>。在平常的业务场景中，我们习惯一次性从数据库中查询出一个大对象用于 web 端显示。例如，我之前碰到过一个一次性查询出 60 个字段的业务操作，这种大对象如果超过年轻代最大对象阈值，会被直接创建在老年代；即使被创建在了年轻代，由于年轻代的内存空间有限，通过 Minor GC 之后也会进入到老年代。这种大对象很容易产生较多的 Full GC。</p>
<p>我们可以将这种大对象拆解出来，首次只查询一些比较重要的字段，如果还需要其它字段辅助查看，再通过第二次查询显示剩余的字段。</p>
<p>** 增大堆内存空间：** 在堆内存不足的情况下，增大堆内存空间，且设置初始化堆内存为最大堆内存，也可以降低 Full GC 的频率。</p>
<h4 id="-886"><a class="markdownIt-Anchor" href="#-886">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-action.html#%E9%99%8D%E4%BD%8E-full-gc-%E7%9A%84%E6%97%B6%E9%97%B4">#</a>降低 Full GC 的时间</h4>
<p>Full GC 的执行时间比 Minor GC 要长很多，因此，如果在 Full GC 上花费过多的时间（超过 1s），将可能出现超时错误。</p>
<ul>
<li>如果<strong>通过减小老年代内存来减少 Full GC 时间</strong>，可能会引起  <code>OutOfMemoryError</code>  或者导致 Full GC 的频率升高。</li>
<li>另外，如果<strong>通过增加老年代内存来降低 Full GC 的频率</strong>，Full GC 的时间可能因此增加。</li>
</ul>
<p>因此，你<strong>需要把老年代的大小设置成一个 “合适” 的值</strong>。</p>
<p><strong>GC 优化需要考虑的 JVM 参数</strong></p>
<table>
<thead>
<tr>
<th><strong>类型</strong></th>
<th><strong>参数</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>堆内存大小</td>
<td><code>-Xms</code></td>
<td>启动 JVM 时堆内存的大小</td>
</tr>
<tr>
<td></td>
<td><code>-Xmx</code></td>
<td>堆内存最大限制</td>
</tr>
<tr>
<td>新生代空间大小</td>
<td><code>-XX:NewRatio</code></td>
<td>新生代和老年代的内存比</td>
</tr>
<tr>
<td></td>
<td><code>-XX:NewSize</code></td>
<td>新生代内存大小</td>
</tr>
<tr>
<td></td>
<td><code>-XX:SurvivorRatio</code></td>
<td>Eden 区和 Survivor 区的内存比</td>
</tr>
</tbody>
</table>
<p>GC 优化时最常用的参数是 <code>-Xms</code> , <code>-Xmx</code>  和 <code>-XX:NewRatio</code> 。 <code>-Xms</code>  和 <code>-Xmx</code>  参数通常是必须的，所以 <code>NewRatio</code>  的值将对 GC 性能产生重要的影响。</p>
<p>有些人可能会问<strong>如何设置永久代内存大小</strong>，你可以用 <code>-XX:PermSize</code>  和 <code>-XX:MaxPermSize</code>  参数来进行设置，但是要记住，只有当出现 <code>OutOfMemoryError</code>  错误时你才需要去设置永久代内存。</p>
<h3 id="-887"><a class="markdownIt-Anchor" href="#-887">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-action.html#_1-3-gc-%E4%BC%98%E5%8C%96%E7%9A%84%E8%BF%87%E7%A8%8B">#</a>1.3. GC 优化的过程</h3>
<p>GC 优化的过程大致可分为以下步骤：</p>
<h4 id="-888"><a class="markdownIt-Anchor" href="#-888">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-action.html#_1-%E7%9B%91%E6%8E%A7-gc-%E7%8A%B6%E6%80%81">#</a>（1）监控 GC 状态</h4>
<p>你需要监控 GC 从而检查系统中运行的 GC 的各种状态。</p>
<h4 id="-889"><a class="markdownIt-Anchor" href="#-889">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-action.html#_2-%E5%88%86%E6%9E%90-gc-%E6%97%A5%E5%BF%97">#</a>（2）分析 GC 日志</h4>
<p>在检查 GC 状态后，你需要分析监控结构并决定是否需要进行 GC 优化。如果分析结果显示运行 GC 的时间只有 0.1-0.3 秒，那么就不需要把时间浪费在 GC 优化上，但如果运行 GC 的时间达到 1-3 秒，甚至大于 10 秒，那么 GC 优化将是很有必要的。</p>
<p>但是，如果你已经分配了大约 10GB 内存给 Java，并且这些内存无法省下，那么就无法进行 GC 优化了。在进行 GC 优化之前，你需要考虑为什么你需要分配这么大的内存空间，如果你分配了 1GB 或 2GB 大小的内存并且出现了 <code>OutOfMemoryError</code> ，那你就应该执行 ** 堆快照（heap dump）** 来消除导致异常的原因。</p>
<blockquote>
<p>🔔 注意：</p>
</blockquote>
<blockquote>
<p>** 堆快照（heap dump）** 是一个用来检查 Java 内存中的对象和数据的内存文件。该文件可以通过执行 JDK 中的 <code>jmap</code>  命令来创建。在创建文件的过程中，所有 Java 程序都将暂停，因此，不要在系统执行过程中创建该文件。</p>
</blockquote>
<blockquote>
<p>你可以在互联网上搜索 heap dump 的详细说明。</p>
</blockquote>
<h4 id="-890"><a class="markdownIt-Anchor" href="#-890">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-action.html#_3-%E9%80%89%E6%8B%A9%E5%90%88%E9%80%82-gc-%E5%9B%9E%E6%94%B6%E5%99%A8">#</a>（3）选择合适 GC 回收器</h4>
<p>如果你决定要进行 GC 优化，那么你需要选择一个 GC 回收器，并且为它设置合理 JVM 参数。此时如果你有多个服务器，请如上文提到的那样，在每台机器上设置不同的 GC 参数并分析它们的区别。</p>
<h4 id="-891"><a class="markdownIt-Anchor" href="#-891">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-action.html#_4-%E5%88%86%E6%9E%90%E7%BB%93%E6%9E%9C">#</a>（4）分析结果</h4>
<p>在设置完 GC 参数后就可以开始收集数据，请在收集至少 24 小时后再进行结果分析。如果你足够幸运，你可能会找到系统的最佳 GC 参数。如若不然，你还需要分析输出日志并检查分配的内存，然后需要通过不断调整 GC 类型 / 内存大小来找到系统的最佳参数。</p>
<h4 id="-892"><a class="markdownIt-Anchor" href="#-892">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-action.html#_5-%E5%BA%94%E7%94%A8%E4%BC%98%E5%8C%96%E9%85%8D%E7%BD%AE">#</a>（5）应用优化配置</h4>
<p>如果 GC 优化的结果令人满意，就可以将参数应用到所有服务器上，并停止 GC 优化。</p>
<p>在下面的章节中，你将会看到上述每一步所做的具体工作。</p>
<h2 id="-893"><a class="markdownIt-Anchor" href="#-893">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-action.html#_2-gc-%E6%97%A5%E5%BF%97">#</a>2. GC 日志</h2>
<h3 id="-894"><a class="markdownIt-Anchor" href="#-894">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-action.html#_2-1-%E8%8E%B7%E5%8F%96-gc-%E6%97%A5%E5%BF%97">#</a>2.1. 获取 GC 日志</h3>
<p>获取 GC 日志有两种方式：</p>
<ul>
<li>使用  <code>jstat</code>  命令动态查看</li>
<li>在容器中设置相关参数打印 GC 日志</li>
</ul>
<h4 id="-895"><a class="markdownIt-Anchor" href="#-895">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-action.html#jstat-%E5%91%BD%E4%BB%A4%E6%9F%A5%E7%9C%8B-gc">#</a>jstat 命令查看 GC</h4>
<p><code>jstat -gc</code>  统计垃圾回收堆的行为：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">jstat <span class="token operator">-</span>gc <span class="token number">1262</span>
 S0C    S1C     S0U     S1U   EC       EU        OC         OU        PC       PU         YGC    YGCT    FGC    FGCT     GCT
<span class="token number">26112.0</span> <span class="token number">24064.0</span> <span class="token number">6562.5</span>  <span class="token number">0.0</span>   <span class="token number">564224.0</span> <span class="token number">76274.5</span>   <span class="token number">434176.0</span>   <span class="token number">388518.3</span>  <span class="token number">524288.0</span> <span class="token number">42724.7</span>    <span class="token number">320</span>    <span class="token number">6.417</span>   <span class="token number">1</span>      <span class="token number">0.398</span>    <span class="token number">6.815</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>也可以设置间隔固定时间来打印：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">jstat -gc <span class="token number">1262</span> <span class="token number">2000</span> <span class="token number">20</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这个命令意思就是每隔 2000ms 输出 1262 的 gc 情况，一共输出 20 次</p>
<h4 id="-896"><a class="markdownIt-Anchor" href="#-896">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-action.html#%E6%89%93%E5%8D%B0-gc-%E7%9A%84%E5%8F%82%E6%95%B0">#</a>打印 GC 的参数</h4>
<p>通过 JVM 参数预先设置 GC 日志，通常有以下几种 JVM 参数设置：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">-XX:+PrintGC 输出 GC 日志
-XX:+PrintGCDetails 输出 GC 的详细日志
-XX:+PrintGCTimeStamps 输出 GC 的时间戳（以基准时间的形式）
-XX:+PrintGCDateStamps 输出 GC 的时间戳（以日期的形式，如 2013-05-04T21:53:59.234+0800）
-XX:+PrintHeapAtGC 在进行 GC 的前后打印出堆的信息
-verbose:gc -Xloggc:../logs/gc.log 日志文件的输出路径<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果是长时间的 GC 日志，我们很难通过文本形式去查看整体的 GC 性能。此时，我们可以通过<a target="_blank" rel="noopener" href="https://sourceforge.net/projects/gcviewer/"> GCView (opens new window)</a> 工具打开日志文件，图形化界面查看整体的 GC 性能。</p>
<p>【示例】Tomcat 设置示例</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token assign-left variable">JAVA_OPTS</span><span class="token operator">=</span><span class="token string">"-server -Xms2000m -Xmx2000m -Xmn800m -XX:PermSize=64m -XX:MaxPermSize=256m -XX:SurvivorRatio=4
-verbose:gc -Xloggc:<span class="token variable">$CATALINA_HOME</span>/logs/gc.log
-Djava.awt.headless=true
-XX:+PrintGCTimeStamps -XX:+PrintGCDetails
-Dsun.rmi.dgc.server.gcInterval=600000 -Dsun.rmi.dgc.client.gcInterval=600000
-XX:+UseConcMarkSweepGC -XX:MaxTenuringThreshold=15"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><code>-Xms2000m -Xmx2000m -Xmn800m -XX:PermSize=64m -XX:MaxPermSize=256m</code>  Xms，即为 jvm 启动时得 JVM 初始堆大小，Xmx 为 jvm 的最大堆大小，xmn 为新生代的大小，permsize 为永久代的初始大小，MaxPermSize 为永久代的最大空间。</li>
<li><code>-XX:SurvivorRatio=4</code>  SurvivorRatio 为新生代空间中的 Eden 区和救助空间 Survivor 区的大小比值，默认是 8，则两个 Survivor 区与一个 Eden 区的比值为 2:8, 一个 Survivor 区占整个年轻代的 1/10。调小这个参数将增大 survivor 区，让对象尽量在 survitor 区呆长一点，减少进入年老代的对象。去掉救助空间的想法是让大部分不能马上回收的数据尽快进入年老代，加快年老代的回收频率，减少年老代暴涨的可能性，这个是通过将 - XX:SurvivorRatio 设置成比较大的值（比如 65536) 来做到。</li>
<li><code>-verbose:gc -Xloggc:$CATALINA_HOME/logs/gc.log</code>  将虚拟机每次垃圾回收的信息写到日志文件中，文件名由 file 指定，文件格式是平文件，内容和 - verbose:gc 输出内容相同。</li>
<li><code>-Djava.awt.headless=true</code>  Headless 模式是系统的一种配置模式。在该模式下，系统缺少了显示设备、键盘或鼠标。</li>
<li><code>-XX:+PrintGCTimeStamps -XX:+PrintGCDetails</code>  设置 gc 日志的格式</li>
<li><code>-Dsun.rmi.dgc.server.gcInterval=600000 -Dsun.rmi.dgc.client.gcInterval=600000</code>  指定 rmi 调用时 gc 的时间间隔</li>
<li><code>-XX:+UseConcMarkSweepGC -XX:MaxTenuringThreshold=15</code>  采用并发 gc 方式，经过 15 次 minor gc 后进入年老代</li>
</ul>
<h3 id="-897"><a class="markdownIt-Anchor" href="#-897">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-action.html#_2-2-%E5%88%86%E6%9E%90-gc-%E6%97%A5%E5%BF%97">#</a>2.2. 分析 GC 日志</h3>
<p>Young GC 回收日志:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token number">2016</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">05</span>T10<span class="token operator">:</span><span class="token number">43</span><span class="token operator">:</span><span class="token number">18.093</span><span class="token operator">+</span><span class="token number">0800</span><span class="token operator">:</span> <span class="token number">25.395</span><span class="token operator">:</span> <span class="token punctuation">[</span>GC <span class="token punctuation">[</span><span class="token class-name">PSYoungGen</span><span class="token operator">:</span> <span class="token number">274931</span>K<span class="token operator">-></span><span class="token function">10738K</span><span class="token punctuation">(</span><span class="token number">274944</span>K<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token number">371093</span>K<span class="token operator">-></span><span class="token function">147186K</span><span class="token punctuation">(</span><span class="token number">450048</span>K<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0668480</span> secs<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name">Times</span><span class="token operator">:</span> user<span class="token operator">=</span><span class="token number">0.17</span> sys<span class="token operator">=</span><span class="token number">0.08</span><span class="token punctuation">,</span> real<span class="token operator">=</span><span class="token number">0.07</span> secs<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Full GC 回收日志:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token number">2016</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">05</span>T10<span class="token operator">:</span><span class="token number">43</span><span class="token operator">:</span><span class="token number">18.160</span><span class="token operator">+</span><span class="token number">0800</span><span class="token operator">:</span> <span class="token number">25.462</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token class-name">Full</span> GC <span class="token punctuation">[</span><span class="token class-name">PSYoungGen</span><span class="token operator">:</span> <span class="token number">10738</span>K<span class="token operator">-></span><span class="token function">0K</span><span class="token punctuation">(</span><span class="token number">274944</span>K<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name">ParOldGen</span><span class="token operator">:</span> <span class="token number">136447</span>K<span class="token operator">-></span><span class="token function">140379K</span><span class="token punctuation">(</span><span class="token number">302592</span>K<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token number">147186</span>K<span class="token operator">-></span><span class="token function">140379K</span><span class="token punctuation">(</span><span class="token number">577536</span>K<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token class-name">PSPermGen</span><span class="token operator">:</span> <span class="token number">85411</span>K<span class="token operator">-></span><span class="token function">85376K</span><span class="token punctuation">(</span><span class="token number">171008</span>K<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0.6763541</span> secs<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name">Times</span><span class="token operator">:</span> user<span class="token operator">=</span><span class="token number">1.75</span> sys<span class="token operator">=</span><span class="token number">0.02</span><span class="token punctuation">,</span> real<span class="token operator">=</span><span class="token number">0.68</span> secs<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>通过上面日志分析得出，PSYoungGen、ParOldGen、PSPermGen 属于 Parallel 收集器。其中 PSYoungGen 表示 gc 回收前后年轻代的内存变化；ParOldGen 表示 gc 回收前后老年代的内存变化；PSPermGen 表示 gc 回收前后永久区的内存变化。young gc 主要是针对年轻代进行内存回收比较频繁，耗时短；full gc 会对整个堆内存进行回城，耗时长，因此一般尽量减少 full gc 的次数</p>
<p>通过两张图非常明显看出 gc 日志构成：</p>
<p>YOUNG GC</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20220107093538.jfif" alt="img"></p>
<p>FULL GC</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20220107093543.jfif" alt="img"></p>
<h4 id="-898"><a class="markdownIt-Anchor" href="#-898">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-action.html#cpu-%E8%BF%87%E9%AB%98">#</a>CPU 过高</h4>
<p>定位步骤：</p>
<p>（1）执行 top -c 命令，找到 cpu 最高的进程的 id</p>
<p>（2）jstack PID 导出 Java 应用程序的线程堆栈信息。</p>
<p>示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">jstack <span class="token number">6795</span>

<span class="token string">"Low Memory Detector"</span> daemon prio<span class="token operator">=</span><span class="token number">10</span> tid<span class="token operator">=</span><span class="token number">0x081465f8</span> nid<span class="token operator">=</span><span class="token number">0x7</span> runnable <span class="token punctuation">[</span><span class="token number">0x00000000</span><span class="token punctuation">.</span><span class="token number">.0</span>x00000000<span class="token punctuation">]</span>
        <span class="token string">"CompilerThread0"</span> daemon prio<span class="token operator">=</span><span class="token number">10</span> tid<span class="token operator">=</span><span class="token number">0x08143c58</span> nid<span class="token operator">=</span><span class="token number">0x6</span> waiting on condition <span class="token punctuation">[</span><span class="token number">0x00000000</span><span class="token punctuation">.</span><span class="token number">.0</span>xfb5fd798<span class="token punctuation">]</span>
        <span class="token string">"Signal Dispatcher"</span> daemon prio<span class="token operator">=</span><span class="token number">10</span> tid<span class="token operator">=</span><span class="token number">0x08142f08</span> nid<span class="token operator">=</span><span class="token number">0x5</span> waiting on condition <span class="token punctuation">[</span><span class="token number">0x00000000</span><span class="token punctuation">.</span><span class="token number">.0</span>x00000000<span class="token punctuation">]</span>
        <span class="token string">"Finalizer"</span> daemon prio<span class="token operator">=</span><span class="token number">10</span> tid<span class="token operator">=</span><span class="token number">0x08137ca0</span> nid<span class="token operator">=</span><span class="token number">0x4</span> in <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token number">0xfbeed000</span><span class="token punctuation">.</span><span class="token number">.0</span>xfbeeddb8<span class="token punctuation">]</span>

        at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Object</span><span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token class-name">Native</span> <span class="token class-name">Method</span><span class="token punctuation">)</span>

        <span class="token operator">-</span> waiting on <span class="token generics"><span class="token punctuation">&lt;</span>0xef600848<span class="token punctuation">></span></span> <span class="token punctuation">(</span>a <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>ref<span class="token punctuation">.</span></span>ReferenceQueue</span>$<span class="token class-name">Lock</span><span class="token punctuation">)</span>

        at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>ref<span class="token punctuation">.</span></span>ReferenceQueue</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token class-name">ReferenceQueue</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">116</span><span class="token punctuation">)</span>

        <span class="token operator">-</span> locked <span class="token generics"><span class="token punctuation">&lt;</span>0xef600848<span class="token punctuation">></span></span> <span class="token punctuation">(</span>a <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>ref<span class="token punctuation">.</span></span>ReferenceQueue</span>$<span class="token class-name">Lock</span><span class="token punctuation">)</span>

        at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>ref<span class="token punctuation">.</span></span>ReferenceQueue</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token class-name">ReferenceQueue</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">132</span><span class="token punctuation">)</span>

        at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>ref<span class="token punctuation">.</span></span>Finalizer</span>$<span class="token class-name">FinalizerThread</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Finalizer</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">159</span><span class="token punctuation">)</span>

        <span class="token string">"Reference Handler"</span> daemon prio<span class="token operator">=</span><span class="token number">10</span> tid<span class="token operator">=</span><span class="token number">0x081370f0</span> nid<span class="token operator">=</span><span class="token number">0x3</span> in <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token number">0xfbf4a000</span><span class="token punctuation">.</span><span class="token number">.0</span>xfbf4aa38<span class="token punctuation">]</span>

        at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Object</span><span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token class-name">Native</span> <span class="token class-name">Method</span><span class="token punctuation">)</span>

        <span class="token operator">-</span> waiting on <span class="token generics"><span class="token punctuation">&lt;</span>0xef600758<span class="token punctuation">></span></span> <span class="token punctuation">(</span>a <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>ref<span class="token punctuation">.</span></span>Reference</span>$<span class="token class-name">Lock</span><span class="token punctuation">)</span>

        at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Object</span><span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">474</span><span class="token punctuation">)</span>

        at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>ref<span class="token punctuation">.</span></span>Reference</span>$<span class="token class-name">ReferenceHandler</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Reference</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">116</span><span class="token punctuation">)</span>

        <span class="token operator">-</span> locked <span class="token generics"><span class="token punctuation">&lt;</span>0xef600758<span class="token punctuation">></span></span> <span class="token punctuation">(</span>a <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>ref<span class="token punctuation">.</span></span>Reference</span>$<span class="token class-name">Lock</span><span class="token punctuation">)</span>

        <span class="token string">"VM Thread"</span> prio<span class="token operator">=</span><span class="token number">10</span> tid<span class="token operator">=</span><span class="token number">0x08134878</span> nid<span class="token operator">=</span><span class="token number">0x2</span> runnable

        <span class="token string">"VM Periodic Task Thread"</span> prio<span class="token operator">=</span><span class="token number">10</span> tid<span class="token operator">=</span><span class="token number">0x08147768</span> nid<span class="token operator">=</span><span class="token number">0x8</span> waiting on condition<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在打印的堆栈日志文件中，tid 和 nid 的含义：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">nid : 对应的 Linux 操作系统下的 tid 线程号，也就是前面转化的 16 进制数字
tid: 这个应该是 jvm 的 jmm 内存规范中的唯一地址定位<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>在 CPU 过高的情况下，查找响应的线程，一般定位都是用 nid 来定位的。而如果发生死锁之类的问题，一般用 tid 来定位。</p>
<p>（3）定位 CPU 高的线程打印其 nid</p>
<p>查看线程下具体进程信息的命令如下：</p>
<p>top -H -p 6735</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">top <span class="token operator">-</span> <span class="token number">14</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">09</span> up <span class="token number">611</span> days<span class="token punctuation">,</span>  <span class="token number">2</span><span class="token operator">:</span><span class="token number">56</span><span class="token punctuation">,</span>  <span class="token number">1</span> user<span class="token punctuation">,</span>  load average<span class="token operator">:</span> <span class="token number">13.19</span><span class="token punctuation">,</span> <span class="token number">7.76</span><span class="token punctuation">,</span> <span class="token number">7.82</span>
<span class="token class-name">Threads</span><span class="token operator">:</span> <span class="token number">6991</span> total<span class="token punctuation">,</span>  <span class="token number">17</span> running<span class="token punctuation">,</span> <span class="token number">6974</span> sleeping<span class="token punctuation">,</span>   <span class="token number">0</span> stopped<span class="token punctuation">,</span>   <span class="token number">0</span> zombie
<span class="token operator">%</span><span class="token class-name">Cpu</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token number">90.4</span> us<span class="token punctuation">,</span>  <span class="token number">2.1</span> sy<span class="token punctuation">,</span>  <span class="token number">0.0</span> ni<span class="token punctuation">,</span>  <span class="token number">7.0</span> id<span class="token punctuation">,</span>  <span class="token number">0.0</span> wa<span class="token punctuation">,</span>  <span class="token number">0.0</span> hi<span class="token punctuation">,</span>  <span class="token number">0.4</span> si<span class="token punctuation">,</span>  <span class="token number">0.0</span> st
<span class="token class-name">KiB</span> <span class="token class-name">Mem</span><span class="token operator">:</span>  <span class="token number">32783044</span> total<span class="token punctuation">,</span> <span class="token number">32505008</span> used<span class="token punctuation">,</span>   <span class="token number">278036</span> free<span class="token punctuation">,</span>   <span class="token number">120304</span> buffers
<span class="token class-name">KiB</span> <span class="token class-name">Swap</span><span class="token operator">:</span>        <span class="token number">0</span> total<span class="token punctuation">,</span>        <span class="token number">0</span> used<span class="token punctuation">,</span>        <span class="token number">0</span> free<span class="token punctuation">.</span> <span class="token number">4497428</span> cached <span class="token class-name">Mem</span>

  PID USER      PR  NI    VIRT    RES    SHR <span class="token class-name">S</span> <span class="token operator">%</span>CPU <span class="token operator">%</span>MEM     TIME<span class="token operator">+</span> COMMAND
 <span class="token number">6800</span> root      <span class="token number">20</span>   <span class="token number">0</span> <span class="token number">27.299</span>g <span class="token number">0.021</span>t   <span class="token number">7172</span> <span class="token class-name">S</span> <span class="token number">54.7</span> <span class="token number">70.1</span> <span class="token number">187</span><span class="token operator">:</span><span class="token number">55.61</span> java
 <span class="token number">6803</span> root      <span class="token number">20</span>   <span class="token number">0</span> <span class="token number">27.299</span>g <span class="token number">0.021</span>t   <span class="token number">7172</span> <span class="token class-name">S</span> <span class="token number">54.4</span> <span class="token number">70.1</span> <span class="token number">187</span><span class="token operator">:</span><span class="token number">52.59</span> java
 <span class="token number">6798</span> root      <span class="token number">20</span>   <span class="token number">0</span> <span class="token number">27.299</span>g <span class="token number">0.021</span>t   <span class="token number">7172</span> <span class="token class-name">S</span> <span class="token number">53.7</span> <span class="token number">70.1</span> <span class="token number">187</span><span class="token operator">:</span><span class="token number">55.08</span> java
 <span class="token number">6801</span> root      <span class="token number">20</span>   <span class="token number">0</span> <span class="token number">27.299</span>g <span class="token number">0.021</span>t   <span class="token number">7172</span> <span class="token class-name">S</span> <span class="token number">53.7</span> <span class="token number">70.1</span> <span class="token number">187</span><span class="token operator">:</span><span class="token number">55.25</span> java
 <span class="token number">6797</span> root      <span class="token number">20</span>   <span class="token number">0</span> <span class="token number">27.299</span>g <span class="token number">0.021</span>t   <span class="token number">7172</span> <span class="token class-name">S</span> <span class="token number">53.1</span> <span class="token number">70.1</span> <span class="token number">187</span><span class="token operator">:</span><span class="token number">52.78</span> java
 <span class="token number">6804</span> root      <span class="token number">20</span>   <span class="token number">0</span> <span class="token number">27.299</span>g <span class="token number">0.021</span>t   <span class="token number">7172</span> <span class="token class-name">S</span> <span class="token number">53.1</span> <span class="token number">70.1</span> <span class="token number">187</span><span class="token operator">:</span><span class="token number">55.76</span> java
 <span class="token number">6802</span> root      <span class="token number">20</span>   <span class="token number">0</span> <span class="token number">27.299</span>g <span class="token number">0.021</span>t   <span class="token number">7172</span> <span class="token class-name">S</span> <span class="token number">52.1</span> <span class="token number">70.1</span> <span class="token number">187</span><span class="token operator">:</span><span class="token number">54.79</span> java
 <span class="token number">6799</span> root      <span class="token number">20</span>   <span class="token number">0</span> <span class="token number">27.299</span>g <span class="token number">0.021</span>t   <span class="token number">7172</span> <span class="token class-name">S</span> <span class="token number">51.8</span> <span class="token number">70.1</span> <span class="token number">187</span><span class="token operator">:</span><span class="token number">53.36</span> java
 <span class="token number">6807</span> root      <span class="token number">20</span>   <span class="token number">0</span> <span class="token number">27.299</span>g <span class="token number">0.021</span>t   <span class="token number">7172</span> <span class="token class-name">S</span> <span class="token number">13.6</span> <span class="token number">70.1</span>  <span class="token number">48</span><span class="token operator">:</span><span class="token number">58.60</span> java
<span class="token number">11014</span> root      <span class="token number">20</span>   <span class="token number">0</span> <span class="token number">27.299</span>g <span class="token number">0.021</span>t   <span class="token number">7172</span> <span class="token class-name">R</span>  <span class="token number">8.4</span> <span class="token number">70.1</span>   <span class="token number">8</span><span class="token operator">:</span><span class="token number">00.32</span> java
<span class="token number">10642</span> root      <span class="token number">20</span>   <span class="token number">0</span> <span class="token number">27.299</span>g <span class="token number">0.021</span>t   <span class="token number">7172</span> <span class="token class-name">R</span>  <span class="token number">6.5</span> <span class="token number">70.1</span>   <span class="token number">6</span><span class="token operator">:</span><span class="token number">32.06</span> java
 <span class="token number">6808</span> root      <span class="token number">20</span>   <span class="token number">0</span> <span class="token number">27.299</span>g <span class="token number">0.021</span>t   <span class="token number">7172</span> <span class="token class-name">S</span>  <span class="token number">6.1</span> <span class="token number">70.1</span> <span class="token number">159</span><span class="token operator">:</span><span class="token number">08.40</span> java
<span class="token number">11315</span> root      <span class="token number">20</span>   <span class="token number">0</span> <span class="token number">27.299</span>g <span class="token number">0.021</span>t   <span class="token number">7172</span> <span class="token class-name">S</span>  <span class="token number">3.9</span> <span class="token number">70.1</span>   <span class="token number">5</span><span class="token operator">:</span><span class="token number">54.10</span> java
<span class="token number">12545</span> root      <span class="token number">20</span>   <span class="token number">0</span> <span class="token number">27.299</span>g <span class="token number">0.021</span>t   <span class="token number">7172</span> <span class="token class-name">S</span>  <span class="token number">3.9</span> <span class="token number">70.1</span>   <span class="token number">6</span><span class="token operator">:</span><span class="token number">55.48</span> java
<span class="token number">23353</span> root      <span class="token number">20</span>   <span class="token number">0</span> <span class="token number">27.299</span>g <span class="token number">0.021</span>t   <span class="token number">7172</span> <span class="token class-name">S</span>  <span class="token number">3.9</span> <span class="token number">70.1</span>   <span class="token number">2</span><span class="token operator">:</span><span class="token number">20.55</span> java
<span class="token number">24868</span> root      <span class="token number">20</span>   <span class="token number">0</span> <span class="token number">27.299</span>g <span class="token number">0.021</span>t   <span class="token number">7172</span> <span class="token class-name">S</span>  <span class="token number">3.9</span> <span class="token number">70.1</span>   <span class="token number">2</span><span class="token operator">:</span><span class="token number">12.46</span> java
 <span class="token number">9146</span> root      <span class="token number">20</span>   <span class="token number">0</span> <span class="token number">27.299</span>g <span class="token number">0.021</span>t   <span class="token number">7172</span> <span class="token class-name">S</span>  <span class="token number">3.6</span> <span class="token number">70.1</span>   <span class="token number">7</span><span class="token operator">:</span><span class="token number">42.72</span> java<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>由此可以看出占用 CPU 较高的线程，但是这些还不高，无法直接定位到具体的类。nid 是 16 进制的，所以我们要获取线程的 16 进制 ID：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">printf "%x\n" 6800
输出结果:45cd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>然后根据输出结果到 jstack 打印的堆栈日志中查定位：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token string">"catalina-exec-5692"</span> daemon prio<span class="token operator">=</span><span class="token number">10</span> tid<span class="token operator">=</span><span class="token number">0x00007f3b05013800</span> nid<span class="token operator">=</span><span class="token number">0x45cd</span> waiting on condition <span class="token punctuation">[</span><span class="token number">0x00007f3ae08e3000</span><span class="token punctuation">]</span>
   <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Thread<span class="token punctuation">.</span>State</span><span class="token operator">:</span> TIMED_WAITING <span class="token punctuation">(</span>parking<span class="token punctuation">)</span>
        at <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span></span>Unsafe</span><span class="token punctuation">.</span><span class="token function">park</span><span class="token punctuation">(</span><span class="token class-name">Native</span> <span class="token class-name">Method</span><span class="token punctuation">)</span>
        <span class="token operator">-</span> parking <span class="token keyword">to</span> <span class="token namespace">wait</span> <span class="token keyword">for</span>  <span class="token generics"><span class="token punctuation">&lt;</span>0x00000006a7800598<span class="token punctuation">></span></span> <span class="token punctuation">(</span>a <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span>AbstractQueuedSynchronizer</span>$<span class="token class-name">ConditionObject</span><span class="token punctuation">)</span>
        at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span>LockSupport</span><span class="token punctuation">.</span><span class="token function">parkNanos</span><span class="token punctuation">(</span><span class="token class-name">LockSupport</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">226</span><span class="token punctuation">)</span>
        at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span>AbstractQueuedSynchronizer</span>$<span class="token class-name">ConditionObject</span><span class="token punctuation">.</span><span class="token function">awaitNanos</span><span class="token punctuation">(</span><span class="token class-name">AbstractQueuedSynchronizer</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">2082</span><span class="token punctuation">)</span>
        at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span>LinkedBlockingQueue</span><span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token class-name">LinkedBlockingQueue</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">467</span><span class="token punctuation">)</span>
        at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>tomcat<span class="token punctuation">.</span>util<span class="token punctuation">.</span>threads<span class="token punctuation">.</span></span>TaskQueue</span><span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token class-name">TaskQueue</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">86</span><span class="token punctuation">)</span>
        at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>tomcat<span class="token punctuation">.</span>util<span class="token punctuation">.</span>threads<span class="token punctuation">.</span></span>TaskQueue</span><span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token class-name">TaskQueue</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">32</span><span class="token punctuation">)</span>
        at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span>ThreadPoolExecutor</span><span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1068</span><span class="token punctuation">)</span>
        at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span>ThreadPoolExecutor</span><span class="token punctuation">.</span><span class="token function">runWorker</span><span class="token punctuation">(</span><span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1130</span><span class="token punctuation">)</span>
        at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span>ThreadPoolExecutor</span>$<span class="token class-name">Worker</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">615</span><span class="token punctuation">)</span>
        at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>tomcat<span class="token punctuation">.</span>util<span class="token punctuation">.</span>threads<span class="token punctuation">.</span></span>TaskThread</span>$<span class="token class-name">WrappingRunnable</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">TaskThread</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">61</span><span class="token punctuation">)</span>
        at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Thread</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">745</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="-899"><a class="markdownIt-Anchor" href="#-899">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-action.html#_3-gc-%E9%85%8D%E7%BD%AE">#</a>3. GC 配置</h2>
<blockquote>
<p>详细参数说明请参考官方文档：<a target="_blank" rel="noopener" href="http://www.oracle.com/technetwork/java/javase/tech/vmoptions-jsp-140102.html">JavaHotSpot VM Options (opens new window)</a>，这里仅列举常用参数。</p>
</blockquote>
<h3 id="-900"><a class="markdownIt-Anchor" href="#-900">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-action.html#_3-1-%E5%A0%86%E5%A4%A7%E5%B0%8F%E8%AE%BE%E7%BD%AE">#</a>3.1. 堆大小设置</h3>
<p><strong>年轻代的设置很关键。</strong></p>
<p>JVM 中最大堆大小有三方面限制：</p>
<ol>
<li>相关操作系统的数据模型（32-bt 还是 64-bit）限制；</li>
<li>系统的可用虚拟内存限制；</li>
<li>系统的可用物理内存限制。</li>
</ol>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">整个堆大小 = 年轻代大小 + 年老代大小 + 持久代大小<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>持久代一般固定大小为  <code>64m</code> 。使用  <code>-XX:PermSize</code>  设置。</li>
<li>官方推荐年轻代占整个堆的 3/8。使用  <code>-Xmn</code>  设置。</li>
</ul>
<h3 id="-901"><a class="markdownIt-Anchor" href="#-901">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-action.html#_3-2-jvm-%E5%86%85%E5%AD%98%E9%85%8D%E7%BD%AE">#</a>3.2. JVM 内存配置</h3>
<table>
<thead>
<tr>
<th>配置</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>-Xss</code></td>
<td>虚拟机栈大小。</td>
</tr>
<tr>
<td><code>-Xms</code></td>
<td>堆空间初始值。</td>
</tr>
<tr>
<td><code>-Xmx</code></td>
<td>堆空间最大值。</td>
</tr>
<tr>
<td><code>-Xmn</code></td>
<td>新生代空间大小。</td>
</tr>
<tr>
<td><code>-XX:NewSize</code></td>
<td>新生代空间初始值。</td>
</tr>
<tr>
<td><code>-XX:MaxNewSize</code></td>
<td>新生代空间最大值。</td>
</tr>
<tr>
<td><code>-XX:NewRatio</code></td>
<td>新生代与年老代的比例。默认为 2，意味着老年代是新生代的 2 倍。</td>
</tr>
<tr>
<td><code>-XX:SurvivorRatio</code></td>
<td>新生代中调整 eden 区与 survivor 区的比例，默认为 8。即  <code>eden</code>  区为 80% 的大小，两个  <code>survivor</code>  分别为 10% 的大小。</td>
</tr>
<tr>
<td><code>-XX:PermSize</code></td>
<td>永久代空间的初始值。</td>
</tr>
<tr>
<td><code>-XX:MaxPermSize</code></td>
<td>永久代空间的最大值。</td>
</tr>
</tbody>
</table>
<h3 id="-902"><a class="markdownIt-Anchor" href="#-902">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-action.html#_3-3-gc-%E7%B1%BB%E5%9E%8B%E9%85%8D%E7%BD%AE">#</a>3.3. GC 类型配置</h3>
<table>
<thead>
<tr>
<th>配置</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>-XX:+UseSerialGC</code></td>
<td>使用 Serial + Serial Old 垃圾回收器组合</td>
</tr>
<tr>
<td><code>-XX:+UseParallelGC</code></td>
<td>使用 Parallel Scavenge + Parallel Old 垃圾回收器组合</td>
</tr>
<tr>
<td><code>-XX:+UseParallelOldGC</code></td>
<td>使用 Parallel Old 垃圾回收器（JDK5 后已无用）</td>
</tr>
<tr>
<td><code>-XX:+UseParNewGC</code></td>
<td>使用 ParNew + Serial Old 垃圾回收器</td>
</tr>
<tr>
<td><code>-XX:+UseConcMarkSweepGC</code></td>
<td>使用 CMS + ParNew + Serial Old 垃圾回收器组合</td>
</tr>
<tr>
<td><code>-XX:+UseG1GC</code></td>
<td>使用 G1 垃圾回收器</td>
</tr>
<tr>
<td><code>-XX:ParallelCMSThreads</code></td>
<td>并发标记扫描垃圾回收器 = 为使用的线程数量</td>
</tr>
</tbody>
</table>
<h3 id="-903"><a class="markdownIt-Anchor" href="#-903">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-action.html#_3-4-%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8%E9%80%9A%E7%94%A8%E5%8F%82%E6%95%B0">#</a>3.4. 垃圾回收器通用参数</h3>
<table>
<thead>
<tr>
<th>配置</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>PretenureSizeThreshold</code></td>
<td>晋升年老代的对象大小。默认为 0。比如设为 10M，则超过 10M 的对象将不在 eden 区分配，而直接进入年老代。</td>
</tr>
<tr>
<td><code>MaxTenuringThreshold</code></td>
<td>晋升老年代的最大年龄。默认为 15。比如设为 10，则对象在 10 次普通 GC 后将会被放入年老代。</td>
</tr>
<tr>
<td><code>DisableExplicitGC</code></td>
<td>禁用  <code>System.gc()</code></td>
</tr>
</tbody>
</table>
<h3 id="-904"><a class="markdownIt-Anchor" href="#-904">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-action.html#_3-5-jmx">#</a>3.5. JMX</h3>
<p>开启 JMX 后，可以使用  <code>jconsole</code>  或  <code>jvisualvm</code>  进行监控 Java 程序的基本信息和运行情况。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">-</span><span class="token class-name">Dcom</span><span class="token punctuation">.</span>sun<span class="token punctuation">.</span>management<span class="token punctuation">.</span>jmxremote<span class="token operator">=</span><span class="token boolean">true</span>
<span class="token operator">-</span><span class="token class-name">Dcom</span><span class="token punctuation">.</span>sun<span class="token punctuation">.</span>management<span class="token punctuation">.</span>jmxremote<span class="token punctuation">.</span>ssl<span class="token operator">=</span><span class="token boolean">false</span>
<span class="token operator">-</span><span class="token class-name">Dcom</span><span class="token punctuation">.</span>sun<span class="token punctuation">.</span>management<span class="token punctuation">.</span>jmxremote<span class="token punctuation">.</span>authenticate<span class="token operator">=</span><span class="token boolean">false</span>
<span class="token operator">-</span><span class="token class-name">Djava</span><span class="token punctuation">.</span>rmi<span class="token punctuation">.</span>server<span class="token punctuation">.</span>hostname<span class="token operator">=</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span>
<span class="token operator">-</span><span class="token class-name">Dcom</span><span class="token punctuation">.</span>sun<span class="token punctuation">.</span>management<span class="token punctuation">.</span>jmxremote<span class="token punctuation">.</span>port<span class="token operator">=</span><span class="token number">18888</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>-Djava.rmi.server.hostname</code>  指定 Java 程序运行的服务器， <code>-Dcom.sun.management.jmxremote.port</code>  指定服务监听端口。</p>
<h3 id="-905"><a class="markdownIt-Anchor" href="#-905">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-action.html#_3-6-%E8%BF%9C%E7%A8%8B-debug">#</a>3.6. 远程 DEBUG</h3>
<p>如果开启 Java 应用的远程 Debug 功能，需要指定如下参数：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">-</span><span class="token class-name">Xdebug</span>
<span class="token operator">-</span><span class="token class-name">Xnoagent</span>
<span class="token operator">-</span><span class="token class-name">Djava</span><span class="token punctuation">.</span>compiler<span class="token operator">=</span>NONE
<span class="token operator">-</span><span class="token class-name">Xrunjdwp</span><span class="token operator">:</span>transport<span class="token operator">=</span>dt_socket<span class="token punctuation">,</span>address<span class="token operator">=</span><span class="token number">28888</span><span class="token punctuation">,</span>server<span class="token operator">=</span>y<span class="token punctuation">,</span>suspend<span class="token operator">=</span>n<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>address 即为远程 debug 的监听端口。</p>
<h3 id="-906"><a class="markdownIt-Anchor" href="#-906">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-action.html#_3-7-heapdump">#</a>3.7. HeapDump</h3>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">-</span>XX<span class="token operator">:</span><span class="token operator">-</span><span class="token class-name">OmitStackTraceInFastThrow</span> <span class="token operator">-</span>XX<span class="token operator">:</span><span class="token operator">+</span><span class="token class-name">HeapDumpOnOutOfMemoryError</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="-907"><a class="markdownIt-Anchor" href="#-907">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-action.html#_3-8-%E8%BE%85%E5%8A%A9%E9%85%8D%E7%BD%AE">#</a>3.8. 辅助配置</h3>
<table>
<thead>
<tr>
<th>配置</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>-XX:+PrintGCDetails</code></td>
<td>打印 GC 日志</td>
</tr>
<tr>
<td><code>-Xloggc:&lt;filename&gt;</code></td>
<td>指定 GC 日志文件名</td>
</tr>
<tr>
<td><code>-XX:+HeapDumpOnOutOfMemoryError</code></td>
<td>内存溢出时输出堆快照文件</td>
</tr>
</tbody>
</table>
<hr>
<h1 id="jvm-命令行工具"><a class="markdownIt-Anchor" href="#jvm-命令行工具">#</a> JVM 命令行工具</h1>
<blockquote>
<p>Java 程序员免不了故障排查工作，所以经常需要使用一些 JVM 工具。</p>
<p>JDK 自带了一些实用的命令行工具来监控、分析 JVM 信息，掌握它们，非常有助于 TroubleShooting。</p>
</blockquote>
<p>以下是较常用的 JDK 命令行工具：</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>jps</code></td>
<td>JVM 进程状态工具。显示系统内的所有 JVM 进程。</td>
</tr>
<tr>
<td><code>jstat</code></td>
<td>JVM 统计监控工具。监控虚拟机运行时状态信息，它可以显示出 JVM 进程中的类装载、内存、GC、JIT 编译等运行数据。</td>
</tr>
<tr>
<td><code>jmap</code></td>
<td>JVM 堆内存分析工具。用于打印 JVM 进程对象直方图、类加载统计。并且可以生成堆转储快照（一般称为 heapdump 或 dump 文件）。</td>
</tr>
<tr>
<td><code>jstack</code></td>
<td>JVM 栈查看工具。用于打印 JVM 进程的线程和锁的情况。并且可以生成线程快照（一般称为 threaddump 或 javacore 文件）。</td>
</tr>
<tr>
<td><code>jhat</code></td>
<td>用来分析 jmap 生成的 dump 文件。</td>
</tr>
<tr>
<td><code>jinfo</code></td>
<td>JVM 信息查看工具。用于实时查看和调整 JVM 进程参数。</td>
</tr>
<tr>
<td><code>jcmd</code></td>
<td>JVM 命令行调试 工具。用于向 JVM 进程发送调试命令。</td>
</tr>
</tbody>
</table>
<ul>
<li>\1. jps
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-cli-tools.html#11-jps-%E5%91%BD%E4%BB%A4%E7%94%A8%E6%B3%95">1.1. jps 命令用法</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-cli-tools.html#12-jps-%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B">1.2. jps 使用示例</a></li>
</ul>
</li>
<li>\2. jstat
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-cli-tools.html#21-jstat-%E5%91%BD%E4%BB%A4%E7%94%A8%E6%B3%95">2.1. jstat 命令用法</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-cli-tools.html#22-jstat-%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B">2.2. jstat 使用示例</a></li>
</ul>
</li>
<li>\3. jmap
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-cli-tools.html#31-jmap-%E5%91%BD%E4%BB%A4%E7%94%A8%E6%B3%95">3.1. jmap 命令用法</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-cli-tools.html#32-jstat-%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B">3.2. jstat 使用示例</a></li>
</ul>
</li>
<li>\4. jstack
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-cli-tools.html#41-jstack-%E5%91%BD%E4%BB%A4%E7%94%A8%E6%B3%95">4.1. jstack 命令用法</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-cli-tools.html#42-thread-dump-%E6%96%87%E4%BB%B6">4.2. thread dump 文件</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-cli-tools.html#43-%E7%B3%BB%E7%BB%9F%E7%BA%BF%E7%A8%8B%E7%8A%B6%E6%80%81">4.3. 系统线程状态</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-cli-tools.html#44-jstack-%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B">4.4. jstack 使用示例</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-cli-tools.html#5-jinfo">5. jinfo</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-cli-tools.html#6-jhat">6. jhat</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-cli-tools.html#7-%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">7. 参考资料</a></li>
</ul>
<h2 id="-908"><a class="markdownIt-Anchor" href="#-908">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-cli-tools.html#_1-jps">#</a>1. jps</h2>
<blockquote>
<p><strong><a target="_blank" rel="noopener" href="https://docs.oracle.com/en/java/javase/11/tools/jps.html#GUID-6EB65B96-F9DD-4356-B825-6146E9EEC81E">jps(JVM Process Status Tool) (opens new window)</a> 是虚拟机进程状态工具</strong>。它可以显示指定系统内所有的 HotSpot 虚拟机进程状态信息。jps 通过 RMI 协议查询开启了 RMI 服务的远程虚拟机进程状态。</p>
</blockquote>
<h3 id="-909"><a class="markdownIt-Anchor" href="#-909">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-cli-tools.html#_1-1-jps-%E5%91%BD%E4%BB%A4%E7%94%A8%E6%B3%95">#</a>1.1. jps 命令用法</h3>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">jps <span class="token punctuation">[</span>option<span class="token punctuation">]</span> <span class="token punctuation">[</span>hostid<span class="token punctuation">]</span>
jps <span class="token punctuation">[</span>-help<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>如果不指定 hostid 就默认为当前主机或服务器。</p>
<p>常用参数：</p>
<ul>
<li>
<pre><code>
  option
  <pre class="line-numbers language-none"><code class="language-none">

​	 

	\- 选项参数
	
	- &#96;-m&#96; - 输出 JVM 启动时传递给 main() 的参数。
	- &#96;-l&#96; - 输出主类的全名，如果进程执行的是 jar 包，输出 jar 路径。
	- &#96;-v&#96; - 显示传递给 JVM 的参数。
	- &#96;-q&#96; - 仅输出本地 JVM 进程 ID。
	- &#96;-V&#96; - 仅输出本地 JVM 标识符。

- &#96;hostid&#96; - RMI 注册表中注册的主机名。如果不指定 hostid 就默认为当前主机或服务器。

其中 &#96;option&#96;、&#96;hostid&#96; 参数也可以不写。

### [#](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;jvm&#x2F;jvm-cli-tools.html#_1-2-jps-使用示例)1.2. jps 使用示例

【示例】列出本地 Java 进程

&#96;&#96;&#96;shell
$ jps
18027 Java2Demo.JAR
18032 jps
18005 jstat<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

</code></pre>
</li>
</ul>
<p>【示例】列出本地 Java 进程 ID</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ jps -q
<span class="token number">8841</span>
<span class="token number">1292</span>
<span class="token number">5398</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>【示例】列出本地 Java 进程 ID，并输出主类的全名，如果进程执行的是 jar 包，输出 jar 路径</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ jps -l remote.domain
<span class="token number">3002</span> /opt/jdk1.7.0/demo/jfc/Java2D/Java2Demo.JAR
<span class="token number">2857</span> sun.tools.jstatd.jstatd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h2 id="-910"><a class="markdownIt-Anchor" href="#-910">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-cli-tools.html#_2-jstat">#</a>2. jstat</h2>
<blockquote>
<p><strong><a target="_blank" rel="noopener" href="https://docs.oracle.com/en/java/javase/11/tools/jstat.html">jstat(JVM statistics Monitoring) (opens new window)</a>，是虚拟机统计信息监视工具</strong>。jstat 用于监视虚拟机运行时状态信息，它可以显示出虚拟机进程中的类装载、内存、垃圾收集、JIT 编译等运行数据。</p>
</blockquote>
<h3 id="-911"><a class="markdownIt-Anchor" href="#-911">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-cli-tools.html#_2-1-jstat-%E5%91%BD%E4%BB%A4%E7%94%A8%E6%B3%95">#</a>2.1. jstat 命令用法</h3>
<p>命令格式：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">jstat <span class="token punctuation">[</span>option<span class="token punctuation">]</span> VMID <span class="token punctuation">[</span>interval<span class="token punctuation">]</span> <span class="token punctuation">[</span>count<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>常用参数：</p>
<ul>
<li>
<pre><code>
  option
  <pre class="line-numbers language-none"><code class="language-none">

​	 

	\- 选项参数，用于指定用户需要查询的虚拟机信息
	
	- &#96;-class&#96; - 监视类装载、卸载数量、总空间以及类装载所耗费的时间
	- &#96;-compiler&#96;：显示 JIT 编译的相关信息；
	- &#96;-gc&#96;：监视 Java 堆状况，包括 Eden 区、两个 survivor 区、老年代、永久代等区的容量、已用空间、GC 时间合计等信息。
	- &#96;-gccapacity&#96;：显示各个代的容量以及使用情况；
	- &#96;-gcmetacapacity&#96;：显示 Metaspace 的大小；
	- &#96;-gcnew&#96;：显示新生代信息；
	- &#96;-gcnewcapacity&#96;：显示新生代大小和使用情况；
	- &#96;-gcold&#96;：显示老年代和永久代的信息；
	- &#96;-gcoldcapacity&#96;：显示老年代的大小；
	- &#96;-gcutil&#96;：显示垃圾回收统计信息；
	- &#96;-gccause&#96;：显示垃圾回收的相关信息（通 -gcutil），同时显示最后一次或当前正在发生的垃圾回收的诱因；
	- &#96;-printcompilation&#96;：输出 JIT 编译的方法信息。

- &#96;VMID&#96; - 如果是本地虚拟机进程，则 VMID 与 LVMID 是一致的；如果是远程虚拟机进程，那 VMID 的格式应当是：&#96;[protocol:][&#x2F;&#x2F;]lvmid[@hostname[:port]&#x2F;servername]&#96;

- &#96;interval&#96; - 查询间隔

- &#96;count&#96; - 查询次数

&gt; 【参考】更详细说明可以参考：[jstat 命令查看 jvm 的 GC 情况(opens new window)](https:&#x2F;&#x2F;www.cnblogs.com&#x2F;yjd_hycf_space&#x2F;p&#x2F;7755633.html)

### [#](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;jvm&#x2F;jvm-cli-tools.html#_2-2-jstat-使用示例)2.2. jstat 使用示例

#### [#](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;jvm&#x2F;jvm-cli-tools.html#类加载统计)类加载统计

使用 &#96;jstat -class pid&#96; 命令可以查看编译统计信息。

【参数】

- Loaded - 加载 class 的数量
- Bytes - 所占用空间大小
- Unloaded - 未加载数量
- Bytes - 未加载占用空间
- Time - 时间

【示例】查看类加载信息

&#96;&#96;&#96;shell
$ jstat -class 7129
Loaded  Bytes  Unloaded  Bytes     Time
 26749 50405.3      873  1216.8      19.75<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

</code></pre>
</li>
</ul>
<h4 id="-912"><a class="markdownIt-Anchor" href="#-912">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-cli-tools.html#%E7%BC%96%E8%AF%91%E7%BB%9F%E8%AE%A1">#</a>编译统计</h4>
<p>使用  <code>jstat -compiler pid</code>  命令可以查看编译统计信息。</p>
<p>【示例】</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ jstat -compiler <span class="token number">7129</span>
Compiled Failed Invalid   Time   FailedType FailedMethod
   <span class="token number">42030</span>      <span class="token number">2</span>       <span class="token number">0</span>   <span class="token number">302.53</span>          <span class="token number">1</span> org/apache/felix/framework/BundleWiringImpl<span class="token variable">$BundleClassLoader</span> findClass<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>【参数】</p>
<ul>
<li>Compiled - 编译数量</li>
<li>Failed - 失败数量</li>
<li>Invalid - 不可用数量</li>
<li>Time - 时间</li>
<li>FailedType - 失败类型</li>
<li>FailedMethod - 失败的方法</li>
</ul>
<h4 id="-913"><a class="markdownIt-Anchor" href="#-913">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-cli-tools.html#gc-%E7%BB%9F%E8%AE%A1">#</a>GC 统计</h4>
<p>使用  <code>jstat -gc pid time</code>  命令可以查看 GC 统计信息。</p>
<p>【示例】以 250 毫秒的间隔进行 7 个采样，并显示 - gcutil 选项指定的输出。</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ jstat -gcutil <span class="token number">21891</span> <span class="token number">250</span> <span class="token number">7</span>
  S0     S1     E      O      M     CCS    YGC     YGCT    FGC    FGCT     GCT
  <span class="token number">0.00</span>  <span class="token number">97.02</span>  <span class="token number">70.31</span>  <span class="token number">66.80</span>  <span class="token number">95.52</span>  <span class="token number">89.14</span>      <span class="token number">7</span>    <span class="token number">0.300</span>     <span class="token number">0</span>    <span class="token number">0.000</span>    <span class="token number">0.300</span>
  <span class="token number">0.00</span>  <span class="token number">97.02</span>  <span class="token number">86.23</span>  <span class="token number">66.80</span>  <span class="token number">95.52</span>  <span class="token number">89.14</span>      <span class="token number">7</span>    <span class="token number">0.300</span>     <span class="token number">0</span>    <span class="token number">0.000</span>    <span class="token number">0.300</span>
  <span class="token number">0.00</span>  <span class="token number">97.02</span>  <span class="token number">96.53</span>  <span class="token number">66.80</span>  <span class="token number">95.52</span>  <span class="token number">89.14</span>      <span class="token number">7</span>    <span class="token number">0.300</span>     <span class="token number">0</span>    <span class="token number">0.000</span>    <span class="token number">0.300</span>
 <span class="token number">91.03</span>   <span class="token number">0.00</span>   <span class="token number">1.98</span>  <span class="token number">68.19</span>  <span class="token number">95.89</span>  <span class="token number">91.24</span>      <span class="token number">8</span>    <span class="token number">0.378</span>     <span class="token number">0</span>    <span class="token number">0.000</span>    <span class="token number">0.378</span>
 <span class="token number">91.03</span>   <span class="token number">0.00</span>  <span class="token number">15.82</span>  <span class="token number">68.19</span>  <span class="token number">95.89</span>  <span class="token number">91.24</span>      <span class="token number">8</span>    <span class="token number">0.378</span>     <span class="token number">0</span>    <span class="token number">0.000</span>    <span class="token number">0.378</span>
 <span class="token number">91.03</span>   <span class="token number">0.00</span>  <span class="token number">17.80</span>  <span class="token number">68.19</span>  <span class="token number">95.89</span>  <span class="token number">91.24</span>      <span class="token number">8</span>    <span class="token number">0.378</span>     <span class="token number">0</span>    <span class="token number">0.000</span>    <span class="token number">0.378</span>
 <span class="token number">91.03</span>   <span class="token number">0.00</span>  <span class="token number">17.80</span>  <span class="token number">68.19</span>  <span class="token number">95.89</span>  <span class="token number">91.24</span>      <span class="token number">8</span>    <span class="token number">0.378</span>     <span class="token number">0</span>    <span class="token number">0.000</span>    <span class="token number">0.378</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>【示例】以 1 秒的间隔进行 4 个采样，并显示 - gc 选项指定的输出。</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ jstat -gc <span class="token number">25196</span> 1s <span class="token number">4</span>
 S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT     GCT
<span class="token number">20928.0</span> <span class="token number">20928.0</span>  <span class="token number">0.0</span>    <span class="token number">0.0</span>   <span class="token number">167936.0</span>  <span class="token number">8880.5</span>   <span class="token number">838912.0</span>   <span class="token number">80291.2</span>   <span class="token number">106668.0</span> <span class="token number">100032.1</span> <span class="token number">12772.0</span> <span class="token number">11602.2</span>    <span class="token number">760</span>   <span class="token number">14.332</span>  <span class="token number">580</span>   <span class="token number">656.218</span>  <span class="token number">670.550</span>
<span class="token number">20928.0</span> <span class="token number">20928.0</span>  <span class="token number">0.0</span>    <span class="token number">0.0</span>   <span class="token number">167936.0</span>  <span class="token number">8880.5</span>   <span class="token number">838912.0</span>   <span class="token number">80291.2</span>   <span class="token number">106668.0</span> <span class="token number">100032.1</span> <span class="token number">12772.0</span> <span class="token number">11602.2</span>    <span class="token number">760</span>   <span class="token number">14.332</span>  <span class="token number">580</span>   <span class="token number">656.218</span>  <span class="token number">670.550</span>
<span class="token number">20928.0</span> <span class="token number">20928.0</span>  <span class="token number">0.0</span>    <span class="token number">0.0</span>   <span class="token number">167936.0</span>  <span class="token number">8880.5</span>   <span class="token number">838912.0</span>   <span class="token number">80291.2</span>   <span class="token number">106668.0</span> <span class="token number">100032.1</span> <span class="token number">12772.0</span> <span class="token number">11602.2</span>    <span class="token number">760</span>   <span class="token number">14.332</span>  <span class="token number">580</span>   <span class="token number">656.218</span>  <span class="token number">670.550</span>
<span class="token number">20928.0</span> <span class="token number">20928.0</span>  <span class="token number">0.0</span>    <span class="token number">0.0</span>   <span class="token number">167936.0</span>  <span class="token number">8880.5</span>   <span class="token number">838912.0</span>   <span class="token number">80291.2</span>   <span class="token number">106668.0</span> <span class="token number">100032.1</span> <span class="token number">12772.0</span> <span class="token number">11602.2</span>    <span class="token number">760</span>   <span class="token number">14.332</span>  <span class="token number">580</span>   <span class="token number">656.218</span>  <span class="token number">670.550</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>参数说明：</p>
<ul>
<li><code>S0C</code> ：年轻代中 To Survivor 的容量（单位 KB）；</li>
<li><code>S1C</code> ：年轻代中 From Survivor 的容量（单位 KB）；</li>
<li><code>S0U</code> ：年轻代中 To Survivor 目前已使用空间（单位 KB）；</li>
<li><code>S1U</code> ：年轻代中 From Survivor 目前已使用空间（单位 KB）；</li>
<li><code>EC</code> ：年轻代中 Eden 的容量（单位 KB）；</li>
<li><code>EU</code> ：年轻代中 Eden 目前已使用空间（单位 KB）；</li>
<li><code>OC</code> ：Old 代的容量（单位 KB）；</li>
<li><code>OU</code> ：Old 代目前已使用空间（单位 KB）；</li>
<li><code>MC</code> ：Metaspace 的容量（单位 KB）；</li>
<li><code>MU</code> ：Metaspace 目前已使用空间（单位 KB）；</li>
<li><code>YGC</code> ：从应用程序启动到采样时年轻代中 gc 次数；</li>
<li><code>YGCT</code> ：从应用程序启动到采样时年轻代中 gc 所用时间 (s)；</li>
<li><code>FGC</code> ：从应用程序启动到采样时 old 代（全 gc）gc 次数；</li>
<li><code>FGCT</code> ：从应用程序启动到采样时 old 代（全 gc）gc 所用时间 (s)；</li>
<li><code>GCT</code> ：从应用程序启动到采样时 gc 用的总时间 (s)。</li>
</ul>
<blockquote>
<p>注：更详细的参数含义可以参考官方文档：<a target="_blank" rel="noopener" href="http://docs.oracle.com/javase/8/docs/technotes/tools/unix/jstat.html">http://docs.oracle.com/javase/8/docs/technotes/tools/unix/jstat.html</a></p>
</blockquote>
<h2 id="-914"><a class="markdownIt-Anchor" href="#-914">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-cli-tools.html#_3-jmap">#</a>3. jmap</h2>
<blockquote>
<p><strong><a target="_blank" rel="noopener" href="https://docs.oracle.com/en/java/javase/11/tools/jmap.html">jmap(JVM Memory Map) (opens new window)</a> 是 Java 内存映像工具</strong>。jmap 用于生成堆转储快照（一般称为 heapdump 或 dump 文件）。jmap 不仅能生成 dump 文件，还可以查询  <code>finalize</code>  执行队列、Java 堆和永久代的详细信息，如当前使用率、当前使用的是哪种收集器等。</p>
<p>如果不使用这个命令，还可以使用  <code>-XX:+HeapDumpOnOutOfMemoryError</code>  参数来让虚拟机出现 OOM 的时候，自动生成 dump 文件。</p>
</blockquote>
<h3 id="-915"><a class="markdownIt-Anchor" href="#-915">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-cli-tools.html#_3-1-jmap-%E5%91%BD%E4%BB%A4%E7%94%A8%E6%B3%95">#</a>3.1. jmap 命令用法</h3>
<p>命令格式：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">jmap [option] pid<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><code>option</code>  选项参数：</p>
<ul>
<li><code>-dump</code>  - 生成堆转储快照。 <code>-dump:live</code>  只保存堆中的存活对象。</li>
<li><code>-finalizerinfo</code>  - 显示在 F-Queue 队列等待执行  <code>finalizer</code>  方法的对象</li>
<li><code>-heap</code>  - 显示 Java 堆详细信息。</li>
<li><code>-histo</code>  - 显示堆中对象的统计信息，包括类、实例数量、合计容量。 <code>-histo:live</code>  只统计堆中的存活对象。</li>
<li><code>-permstat</code>  - to print permanent generation statistics</li>
<li><code>-F</code>  - 当 - dump 没有响应时，强制生成 dump 快照</li>
</ul>
<h3 id="-916"><a class="markdownIt-Anchor" href="#-916">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-cli-tools.html#_3-2-jstat-%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B">#</a>3.2. jstat 使用示例</h3>
<h4 id="-917"><a class="markdownIt-Anchor" href="#-917">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-cli-tools.html#%E7%94%9F%E6%88%90-heapdump-%E5%BF%AB%E7%85%A7">#</a>生成 heapdump 快照</h4>
<p>dump 堆到文件，format 指定输出格式，live 指明是活着的对象，file 指定文件名</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ jmap -dump:live,format<span class="token operator">=</span>b,file<span class="token operator">=</span>dump.hprof <span class="token number">28920</span>
Dumping heap to /home/xxx/dump.hprof <span class="token punctuation">..</span>.
Heap dump <span class="token function">file</span> created<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>dump.hprof 这个后缀是为了后续可以直接用 MAT (Memory Anlysis Tool) 等工具打开。</p>
<h4 id="-918"><a class="markdownIt-Anchor" href="#-918">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-cli-tools.html#%E6%9F%A5%E7%9C%8B%E5%AE%9E%E4%BE%8B%E6%95%B0%E6%9C%80%E5%A4%9A%E7%9A%84%E7%B1%BB">#</a>查看实例数最多的类</h4>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ jmap -histo <span class="token number">29527</span> <span class="token operator">|</span> <span class="token function">head</span> -n <span class="token number">6</span>

 num     <span class="token comment">#instances         #bytes  class name</span>
----------------------------------------------
   <span class="token number">1</span>:      <span class="token number">13673280</span>     <span class="token number">1438961864</span>  <span class="token punctuation">[</span>C
   <span class="token number">2</span>:       <span class="token number">1207166</span>      <span class="token number">411277184</span>  <span class="token punctuation">[</span>I
   <span class="token number">3</span>:       <span class="token number">7382322</span>      <span class="token number">347307096</span>  <span class="token punctuation">[</span>Ljava.lang.Object<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-919"><a class="markdownIt-Anchor" href="#-919">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-cli-tools.html#%E6%9F%A5%E7%9C%8B%E6%8C%87%E5%AE%9A%E8%BF%9B%E7%A8%8B%E7%9A%84%E5%A0%86%E4%BF%A1%E6%81%AF">#</a>查看指定进程的堆信息</h4>
<p>注意：使用 CMS GC 情况下， <code>jmap -heap PID</code>  的执行有可能会导致 java 进程挂起。</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ jmap -heap <span class="token number">12379</span>
Attaching to process ID <span class="token number">12379</span>, please wait<span class="token punctuation">..</span>.
Debugger attached successfully.
Server compiler detected.
JVM version is <span class="token number">17.0</span>-b16

using thread-local object allocation.
Parallel GC with <span class="token number">6</span> thread<span class="token punctuation">(</span>s<span class="token punctuation">)</span>

Heap Configuration:
   MinHeapFreeRatio <span class="token operator">=</span> <span class="token number">40</span>
   MaxHeapFreeRatio <span class="token operator">=</span> <span class="token number">70</span>
   MaxHeapSize      <span class="token operator">=</span> <span class="token number">83886080</span> <span class="token punctuation">(</span><span class="token number">80</span>.0MB<span class="token punctuation">)</span>
   NewSize          <span class="token operator">=</span> <span class="token number">1310720</span> <span class="token punctuation">(</span><span class="token number">1</span>.25MB<span class="token punctuation">)</span>
   MaxNewSize       <span class="token operator">=</span> <span class="token number">17592186044415</span> MB
   OldSize          <span class="token operator">=</span> <span class="token number">5439488</span> <span class="token punctuation">(</span><span class="token number">5</span>.1875MB<span class="token punctuation">)</span>
   NewRatio         <span class="token operator">=</span> <span class="token number">2</span>
   SurvivorRatio    <span class="token operator">=</span> <span class="token number">8</span>
   PermSize         <span class="token operator">=</span> <span class="token number">20971520</span> <span class="token punctuation">(</span><span class="token number">20</span>.0MB<span class="token punctuation">)</span>
   MaxPermSize      <span class="token operator">=</span> <span class="token number">88080384</span> <span class="token punctuation">(</span><span class="token number">84</span>.0MB<span class="token punctuation">)</span>

Heap Usage:
PS Young Generation
Eden Space:
   capacity <span class="token operator">=</span> <span class="token number">9306112</span> <span class="token punctuation">(</span><span class="token number">8</span>.875MB<span class="token punctuation">)</span>
   used     <span class="token operator">=</span> <span class="token number">5375360</span> <span class="token punctuation">(</span><span class="token number">5</span>.1263427734375MB<span class="token punctuation">)</span>
   <span class="token function">free</span>     <span class="token operator">=</span> <span class="token number">3930752</span> <span class="token punctuation">(</span><span class="token number">3</span>.7486572265625MB<span class="token punctuation">)</span>
   <span class="token number">57.761608714788736</span>% used
From Space:
   capacity <span class="token operator">=</span> <span class="token number">9306112</span> <span class="token punctuation">(</span><span class="token number">8</span>.875MB<span class="token punctuation">)</span>
   used     <span class="token operator">=</span> <span class="token number">3425240</span> <span class="token punctuation">(</span><span class="token number">3</span>.2665634155273438MB<span class="token punctuation">)</span>
   <span class="token function">free</span>     <span class="token operator">=</span> <span class="token number">5880872</span> <span class="token punctuation">(</span><span class="token number">5</span>.608436584472656MB<span class="token punctuation">)</span>
   <span class="token number">36.80634834397007</span>% used
To Space:
   capacity <span class="token operator">=</span> <span class="token number">9306112</span> <span class="token punctuation">(</span><span class="token number">8</span>.875MB<span class="token punctuation">)</span>
   used     <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">(</span><span class="token number">0</span>.0MB<span class="token punctuation">)</span>
   <span class="token function">free</span>     <span class="token operator">=</span> <span class="token number">9306112</span> <span class="token punctuation">(</span><span class="token number">8</span>.875MB<span class="token punctuation">)</span>
   <span class="token number">0.0</span>% used
PS Old Generation
   capacity <span class="token operator">=</span> <span class="token number">55967744</span> <span class="token punctuation">(</span><span class="token number">53</span>.375MB<span class="token punctuation">)</span>
   used     <span class="token operator">=</span> <span class="token number">48354640</span> <span class="token punctuation">(</span><span class="token number">46</span>.11457824707031MB<span class="token punctuation">)</span>
   <span class="token function">free</span>     <span class="token operator">=</span> <span class="token number">7613104</span> <span class="token punctuation">(</span><span class="token number">7</span>.2604217529296875MB<span class="token punctuation">)</span>
   <span class="token number">86.39733629427693</span>% used
PS Perm Generation
   capacity <span class="token operator">=</span> <span class="token number">62062592</span> <span class="token punctuation">(</span><span class="token number">59</span>.1875MB<span class="token punctuation">)</span>
   used     <span class="token operator">=</span> <span class="token number">60243112</span> <span class="token punctuation">(</span><span class="token number">57</span>.452308654785156MB<span class="token punctuation">)</span>
   <span class="token function">free</span>     <span class="token operator">=</span> <span class="token number">1819480</span> <span class="token punctuation">(</span><span class="token number">1</span>.7351913452148438MB<span class="token punctuation">)</span>
   <span class="token number">97.06831451706046</span>% used<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="-920"><a class="markdownIt-Anchor" href="#-920">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-cli-tools.html#_4-jstack">#</a>4. jstack</h2>
<blockquote>
<p><strong><a target="_blank" rel="noopener" href="https://docs.oracle.com/en/java/javase/11/tools/jstack.html">jstack(Stack Trace for java) (opens new window)</a> 是 Java 堆栈跟踪工具</strong>。jstack 用来打印目标 Java 进程中各个线程的栈轨迹，以及这些线程所持有的锁，并可以生成 java 虚拟机当前时刻的线程快照（一般称为 threaddump 或 javacore 文件）。</p>
<p><strong>线程快照是当前虚拟机内每一条线程正在执行的方法堆栈的集合，生成线程快照的主要目的是定位线程出现长时间停顿的原因，如线程间死锁、死循环、请求外部资源导致的长时间等待等</strong>。</p>
</blockquote>
<p><code>jstack</code>  通常会结合  <code>top -Hp pid</code>  或  <code>pidstat -p pid -t</code>  一起查看具体线程的状态，也经常用来排查一些死锁的异常。</p>
<p>线程出现停顿的时候通过 jstack 来查看各个线程的调用堆栈，就可以知道没有响应的线程到底在后台做什么事情，或者等待什么资源。 如果 java 程序崩溃生成 core 文件，jstack 工具可以用来获得 core 文件的 java stack 和 native stack 的信息，从而可以轻松地知道 java 程序是如何崩溃和在程序何处发生问题。另外，jstack 工具还可以附属到正在运行的 java 程序中，看到当时运行的 java 程序的 java stack 和 native stack 的信息，如果现在运行的 java 程序呈现 hung 的状态，jstack 是非常有用的。</p>
<h3 id="-921"><a class="markdownIt-Anchor" href="#-921">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-cli-tools.html#_4-1-jstack-%E5%91%BD%E4%BB%A4%E7%94%A8%E6%B3%95">#</a>4.1. jstack 命令用法</h3>
<p>命令格式：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">jstack <span class="token punctuation">[</span>option<span class="token punctuation">]</span> pid<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><code>option</code>  选项参数</p>
<ul>
<li><code>-F</code>  - 当正常输出请求不被响应时，强制输出线程堆栈</li>
<li><code>-l</code>  - 除堆栈外，显示关于锁的附加信息</li>
<li><code>-m</code>  - 打印 java 和 jni 框架的所有栈信息</li>
</ul>
<h3 id="-922"><a class="markdownIt-Anchor" href="#-922">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-cli-tools.html#_4-2-thread-dump-%E6%96%87%E4%BB%B6">#</a>4.2. thread dump 文件</h3>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/20200730112431.png" alt="img"></p>
<p>一个 Thread Dump 文件大致可以分为五个部分。</p>
<h4 id="-923"><a class="markdownIt-Anchor" href="#-923">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-cli-tools.html#%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86-full-thread-dump-identifier">#</a>第一部分：Full thread dump identifier</h4>
<p>这一部分是内容最开始的部分，展示了快照文件的生成时间和 JVM 的版本信息。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">2017-10-19 10:46:44
Full thread dump Java HotSpot(TM) 64-Bit Server VM (24.79-b02 mixed mode):<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h4 id="-924"><a class="markdownIt-Anchor" href="#-924">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-cli-tools.html#%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86-java-ee-middleware-third-party-custom-application-threads">#</a>第二部分：Java EE middleware, third party &amp; custom application Threads</h4>
<p>这是整个文件的核心部分，里面展示了 JavaEE 容器（如 tomcat、resin 等）、自己的程序中所使用的线程信息。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">"resin-22129" daemon prio=10 tid=0x00007fbe5c34e000 nid=0x4cb1 waiting on condition [0x00007fbe4ff7c000]
   java.lang.Thread.State: WAITING (parking)
    at sun.misc.Unsafe.park(Native Method)
    at java.util.concurrent.locks.LockSupport.park(LockSupport.java:315)
    at com.caucho.env.thread2.ResinThread2.park(ResinThread2.java:196)
    at com.caucho.env.thread2.ResinThread2.runTasks(ResinThread2.java:147)
    at com.caucho.env.thread2.ResinThread2.run(ResinThread2.java:118)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>参数说明：</p>
<ul>
<li><code>&quot;resin-22129&quot;</code>  ** 线程名称：** 如果使用 java.lang.Thread 类生成一个线程的时候，线程名称为 Thread-(数字) 的形式，这里是 resin 生成的线程；</li>
<li><code>daemon</code>  ** 线程类型：** 线程分为守护线程 (daemon) 和非守护线程 (non-daemon) 两种，通常都是守护线程；</li>
<li><code>prio=10</code>  ** 线程优先级：** 默认为 5，数字越大优先级越高；</li>
<li><code>tid=0x00007fbe5c34e000</code>  **JVM 线程的 id：**JVM 内部线程的唯一标识，通过 java.lang.Thread.getId () 获取，通常用自增的方式实现；</li>
<li><code>nid=0x4cb1</code>  ** 系统线程 id：** 对应的系统线程 id（Native Thread ID)，可以通过 top 命令进行查看，现场 id 是十六进制的形式；</li>
<li><code>waiting on condition</code>  ** 系统线程状态：** 这里是系统的线程状态；</li>
<li><code>[0x00007fbe4ff7c000]</code>  ** 起始栈地址：** 线程堆栈调用的其实内存地址；</li>
<li><code>java.lang.Thread.State: WAITING (parking)</code>  **JVM 线程状态：** 这里标明了线程在代码级别的状态。</li>
<li>** 线程调用栈信息：** 下面就是当前线程调用的详细栈信息，用于代码的分析。堆栈信息应该从下向上解读，因为程序调用的顺序是从下向上的。</li>
</ul>
<h4 id="-925"><a class="markdownIt-Anchor" href="#-925">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-cli-tools.html#%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86-hotspot-vm-thread">#</a>第三部分：HotSpot VM Thread</h4>
<p>这一部分展示了 JVM 内部线程的信息，用于执行内部的原生操作。下面常见的集中内置线程：</p>
<h5 id="-926"><a class="markdownIt-Anchor" href="#-926">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-cli-tools.html#attach-listener">#</a>“Attach Listener”</h5>
<p>该线程负责接收外部命令，执行该命令并把结果返回给调用者，此种类型的线程通常在桌面程序中出现。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">"Attach Listener" daemon prio=5 tid=0x00007fc6b6800800 nid=0x3b07 waiting on condition [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h5 id="-927"><a class="markdownIt-Anchor" href="#-927">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-cli-tools.html#destroyjavavm">#</a>“DestroyJavaVM”</h5>
<p>执行  <code>main()</code>  的线程在执行完之后调用 JNI 中的  <code>jni_DestroyJavaVM()</code>  方法会唤起  <code>DestroyJavaVM</code>  线程，处于等待状态，等待其它线程（java 线程和 native 线程）退出时通知它卸载 JVM。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">"DestroyJavaVM" prio=5 tid=0x00007fc6b3001000 nid=0x1903 waiting on condition [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h5 id="-928"><a class="markdownIt-Anchor" href="#-928">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-cli-tools.html#service-thread">#</a>“Service Thread”</h5>
<p>用于启动服务的线程</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">"Service Thread" daemon prio=10 tid=0x00007fbea81b3000 nid=0x5f2 runnable [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h5 id="-929"><a class="markdownIt-Anchor" href="#-929">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-cli-tools.html#compilerthread">#</a>“CompilerThread”</h5>
<p>用来调用 JITing，实时编译装卸类。通常 JVM 会启动多个线程来处理这部分工作，线程名称后面的数字也会累加，比如 CompilerThread1。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">"C2 CompilerThread1" daemon prio=10 tid=0x00007fbea814b000 nid=0x5f1 waiting on condition [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

"C2 CompilerThread0" daemon prio=10 tid=0x00007fbea8142000 nid=0x5f0 waiting on condition [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="-930"><a class="markdownIt-Anchor" href="#-930">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-cli-tools.html#signal-dispatcher">#</a>“Signal Dispatcher”</h5>
<p>Attach Listener 线程的职责是接收外部 jvm 命令，当命令接收成功后，会交给 signal dispather 线程去进行分发到各个不同的模块处理命令，并且返回处理结果。 signal dispather 线程也是在第一次接收外部 jvm 命令时，进行初始化工作。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">"Signal Dispatcher" daemon prio=10 tid=0x00007fbea81bf800 nid=0x5ef runnable [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h5 id="-931"><a class="markdownIt-Anchor" href="#-931">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-cli-tools.html#finalizer">#</a>“Finalizer”</h5>
<p>这个线程也是在 main 线程之后创建的，其优先级为 10，主要用于在垃圾收集前，调用对象的  <code>finalize()</code>  方法；关于 Finalizer 线程的几点：</p>
<ul>
<li>只有当开始一轮垃圾收集时，才会开始调用 finalize () 方法；因此并不是所有对象的 finalize () 方法都会被执行；</li>
<li>该线程也是 daemon 线程，因此如果虚拟机中没有其他非 daemon 线程，不管该线程有没有执行完 finalize () 方法，JVM 也会退出；</li>
<li>JVM 在垃圾收集时会将失去引用的对象包装成 Finalizer 对象（Reference 的实现），并放入 ReferenceQueue，由 Finalizer 线程来处理；最后将该 Finalizer 对象的引用置为 null，由垃圾收集器来回收；</li>
</ul>
<p>JVM 为什么要单独用一个线程来执行  <code>finalize()</code>  方法呢？</p>
<p>如果 JVM 的垃圾收集线程自己来做，很有可能由于在 finalize () 方法中误操作导致 GC 线程停止或不可控，这对 GC 线程来说是一种灾难。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">"Finalizer" daemon prio=10 tid=0x00007fbea80da000 nid=0x5eb in Object.wait() [0x00007fbeac044000]
   java.lang.Thread.State: WAITING (on object monitor)
    at java.lang.Object.wait(Native Method)
    at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:135)
    - locked &lt;0x00000006d173c1a8> (a java.lang.ref.ReferenceQueue$Lock)
    at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:151)
    at java.lang.ref.Finalizer$FinalizerThread.run(Finalizer.java:209)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="-932"><a class="markdownIt-Anchor" href="#-932">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-cli-tools.html#reference-handler">#</a>“Reference Handler”</h5>
<p>JVM 在创建 main 线程后就创建 Reference Handler 线程，其优先级最高，为 10，它主要用于处理引用对象本身（软引用、弱引用、虚引用）的垃圾回收问题 。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">"Reference Handler" daemon prio=10 tid=0x00007fbea80d8000 nid=0x5ea in Object.wait() [0x00007fbeac085000]
   java.lang.Thread.State: WAITING (on object monitor)
    at java.lang.Object.wait(Native Method)
    at java.lang.Object.wait(Object.java:503)
    at java.lang.ref.Reference$ReferenceHandler.run(Reference.java:133)
    - locked &lt;0x00000006d173c1f0> (a java.lang.ref.Reference$Lock)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="-933"><a class="markdownIt-Anchor" href="#-933">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-cli-tools.html#vm-thread">#</a>“VM Thread”</h5>
<p>JVM 中线程的母体，根据 HotSpot 源码中关于 vmThread.hpp 里面的注释，它是一个单例的对象（最原始的线程）会产生或触发所有其他的线程，这个单例的 VM 线程是会被其他线程所使用来做一些 VM 操作（如清扫垃圾等）。 在 VM Thread 的结构体里有一个 VMOperationQueue 列队，所有的 VM 线程操作 (vm_operation) 都会被保存到这个列队当中，VMThread 本身就是一个线程，它的线程负责执行一个自轮询的 loop 函数 (具体可以参考：VMThread.cpp 里面的 void VMThread::loop ()) ，该 loop 函数从 VMOperationQueue 列队中按照优先级取出当前需要执行的操作对象 (VM_Operation)，并且调用 VM_Operation-&gt;evaluate 函数去执行该操作类型本身的业务逻辑。 VM 操作类型被定义在 vm_operations.hpp 文件内，列举几个：ThreadStop、ThreadDump、PrintThreads、GenCollectFull、GenCollectFullConcurrent、CMS_Initial_Mark、CMS_Final_Remark…… 有兴趣的同学，可以自己去查看源文件。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">"VM Thread" prio=10 tid=0x00007fbea80d3800 nid=0x5e9 runnable<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="-934"><a class="markdownIt-Anchor" href="#-934">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-cli-tools.html#%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86-hotspot-gc-thread">#</a>第四部分：HotSpot GC Thread</h4>
<p>JVM 中用于进行资源回收的线程，包括以下几种类型的线程：</p>
<h5 id="-935"><a class="markdownIt-Anchor" href="#-935">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-cli-tools.html#vm-periodic-task-thread">#</a>“VM Periodic Task Thread”</h5>
<p>该线程是 JVM 周期性任务调度的线程，它由 WatcherThread 创建，是一个单例对象。该线程在 JVM 内使用得比较频繁，比如：定期的内存监控、JVM 运行状况监控。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">"VM Periodic Task Thread" prio=10 tid=0x00007fbea82ae800 nid=0x5fa waiting on condition<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>可以使用 jstat 命令查看 GC 的情况，比如查看某个进程没有存活必要的引用可以使用命令  <code>jstat -gcutil 250 7</code>  参数中 pid 是进程 id，后面的 250 和 7 表示每 250 毫秒打印一次，总共打印 7 次。 这对于防止因为应用代码中直接使用 native 库或者第三方的一些监控工具的内存泄漏有非常大的帮助。</p>
<h5 id="-936"><a class="markdownIt-Anchor" href="#-936">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-cli-tools.html#gc-task-thread-0-parallelgc">#</a>“GC task thread#0 (ParallelGC)”</h5>
<p>垃圾回收线程，该线程会负责进行垃圾回收。通常 JVM 会启动多个线程来处理这个工作，线程名称中 #后面的数字也会累加。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">"GC task thread#0 (ParallelGC)" prio=5 tid=0x00007fc6b480d000 nid=0x2503 runnable

"GC task thread#1 (ParallelGC)" prio=5 tid=0x00007fc6b2812000 nid=0x2703 runnable

"GC task thread#2 (ParallelGC)" prio=5 tid=0x00007fc6b2812800 nid=0x2903 runnable

"GC task thread#3 (ParallelGC)" prio=5 tid=0x00007fc6b2813000 nid=0x2b03 runnable<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果在 JVM 中增加了  <code>-XX:+UseConcMarkSweepGC</code>  参数将会启用 CMS （Concurrent Mark-Sweep）GC Thread 方式，以下是该模式下的线程类型：</p>
<h5 id="-937"><a class="markdownIt-Anchor" href="#-937">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-cli-tools.html#gang-worker-0-parallel-gc-threads">#</a>“Gang worker#0 (Parallel GC Threads)”</h5>
<p>原来垃圾回收线程 GC task thread#0 (ParallelGC) 被替换为 Gang worker#0 (Parallel GC Threads)。Gang worker 是 JVM 用于年轻代垃圾回收 (minor gc) 的线程。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">"Gang worker#0 (Parallel GC Threads)" prio=10 tid=0x00007fbea801b800 nid=0x5e4 runnable

"Gang worker#1 (Parallel GC Threads)" prio=10 tid=0x00007fbea801d800 nid=0x5e7 runnable<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h5 id="-938"><a class="markdownIt-Anchor" href="#-938">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-cli-tools.html#concurrent-mark-sweep-gc-thread">#</a>“Concurrent Mark-Sweep GC Thread”</h5>
<p>并发标记清除垃圾回收器（就是通常所说的 CMS GC）线程， 该线程主要针对于年老代垃圾回收。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">"Concurrent Mark-Sweep GC Thread" prio=10 tid=0x00007fbea8073800 nid=0x5e8 runnable<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h5 id="-939"><a class="markdownIt-Anchor" href="#-939">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-cli-tools.html#surrogate-locker-thread-concurrent-gc">#</a>“Surrogate Locker Thread (Concurrent GC)”</h5>
<p>此线程主要配合 CMS 垃圾回收器来使用，是一个守护线程，主要负责处理 GC 过程中 Java 层的 Reference（指软引用、弱引用等等）与 jvm 内部层面的对象状态同步。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">"Surrogate Locker Thread (Concurrent GC)" daemon prio=10 tid=0x00007fbea8158800 nid=0x5ee waiting on condition [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>这里以 WeakHashMap 为例进行说明，首先是一个关键点：</p>
<ul>
<li>WeakHashMap 和 HashMap 一样，内部有一个 Entry [] 数组；</li>
<li>WeakHashMap 的 Entry 比较特殊，它的继承体系结构为 Entry-&gt;WeakReference-&gt;Reference;</li>
<li>Reference 里面有一个全局锁对象：Lock，它也被称为 pending_lock，注意：它是静态对象；</li>
<li>Reference 里面有一个静态变量：pending；</li>
<li>Reference 里面有一个静态内部类：ReferenceHandler 的线程，它在 static 块里面被初始化并且启动，启动完成后处于 wait 状态，它在一个 Lock 同步锁模块中等待；</li>
<li>WeakHashMap 里面还实例化了一个 ReferenceQueue 列队</li>
</ul>
<p>假设，WeakHashMap 对象里面已经保存了很多对象的引用，JVM 在进行 CMS GC 的时候会创建一个 ConcurrentMarkSweepThread（简称 CMST）线程去进行 GC。ConcurrentMarkSweepThread 线程被创建的同时会创建一个 SurrogateLockerThread（简称 SLT）线程并且启动它，SLT 启动之后，处于等待阶段。 CMST 开始 GC 时，会发一个消息给 SLT 让它去获取 Java 层 Reference 对象的全局锁：Lock。直到 CMS GC 完毕之后，JVM 会将 WeakHashMap 中所有被回收的对象所属的 WeakReference 容器对象放入到 Reference 的 pending 属性当中（每次 GC 完毕之后，pending 属性基本上都不会为 null 了），然后通知 SLT 释放并且 notify 全局锁：Lock。此时激活了 ReferenceHandler 线程的 run 方法，使其脱离 wait 状态，开始工作了。 ReferenceHandler 这个线程会将 pending 中的所有 WeakReference 对象都移动到它们各自的列队当中，比如当前这个 WeakReference 属于某个 WeakHashMap 对象，那么它就会被放入相应的 ReferenceQueue 列队里面（该列队是链表结构）。 当我们下次从 WeakHashMap 对象里面 get、put 数据或者调用 size 方法的时候，WeakHashMap 就会将 ReferenceQueue 列队中的 WeakReference 依依 poll 出来去和 Entry [] 数据做比较，如果发现相同的，则说明这个 Entry 所保存的对象已经被 GC 掉了，那么将 Entry [] 内的 Entry 对象剔除掉。</p>
<h4 id="-940"><a class="markdownIt-Anchor" href="#-940">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-cli-tools.html#%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86-jni-global-references-count">#</a>第五部分：JNI global references count</h4>
<p>这一部分主要回收那些在 native 代码上被引用，但在 java 代码中却没有存活必要的引用，对于防止因为应用代码中直接使用 native 库或第三方的一些监控工具的内存泄漏有非常大的帮助。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">JNI global references: 830<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>下一篇文章将要讲述一个直接找出 CPU 100% 线程的例子。</p>
<h3 id="-941"><a class="markdownIt-Anchor" href="#-941">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-cli-tools.html#_4-3-%E7%B3%BB%E7%BB%9F%E7%BA%BF%E7%A8%8B%E7%8A%B6%E6%80%81">#</a>4.3. 系统线程状态</h3>
<p>系统线程有如下状态：</p>
<h4 id="-942"><a class="markdownIt-Anchor" href="#-942">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-cli-tools.html#deadlock">#</a>deadlock</h4>
<p>死锁线程，一般指多个线程调用期间进入了相互资源占用，导致一直等待无法释放的情况。</p>
<p>【示例】deadlock 示例</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">"DEADLOCK_TEST-1" daemon prio=6 tid=0x000000000690f800 nid=0x1820 waiting for monitor entry [0x000000000805f000]
   java.lang.Thread.State: BLOCKED (on object monitor)
                at com.nbp.theplatform.threaddump.ThreadDeadLockState$DeadlockThread.goMonitorDeadlock(ThreadDeadLockState.java:197)
                - waiting to lock &lt;0x00000007d58f5e60> (a com.nbp.theplatform.threaddump.ThreadDeadLockState$Monitor)
                at com.nbp.theplatform.threaddump.ThreadDeadLockState$DeadlockThread.monitorOurLock(ThreadDeadLockState.java:182)
                - locked &lt;0x00000007d58f5e48> (a com.nbp.theplatform.threaddump.ThreadDeadLockState$Monitor)
                at com.nbp.theplatform.threaddump.ThreadDeadLockState$DeadlockThread.run(ThreadDeadLockState.java:135)

   Locked ownable synchronizers:
                - None

"DEADLOCK_TEST-2" daemon prio=6 tid=0x0000000006858800 nid=0x17b8 waiting for monitor entry [0x000000000815f000]
   java.lang.Thread.State: BLOCKED (on object monitor)
                at com.nbp.theplatform.threaddump.ThreadDeadLockState$DeadlockThread.goMonitorDeadlock(ThreadDeadLockState.java:197)
                - waiting to lock &lt;0x00000007d58f5e78> (a com.nbp.theplatform.threaddump.ThreadDeadLockState$Monitor)
                at com.nbp.theplatform.threaddump.ThreadDeadLockState$DeadlockThread.monitorOurLock(ThreadDeadLockState.java:182)
                - locked &lt;0x00000007d58f5e60> (a com.nbp.theplatform.threaddump.ThreadDeadLockState$Monitor)
                at com.nbp.theplatform.threaddump.ThreadDeadLockState$DeadlockThread.run(ThreadDeadLockState.java:135)

   Locked ownable synchronizers:
                - None

"DEADLOCK_TEST-3" daemon prio=6 tid=0x0000000006859000 nid=0x25dc waiting for monitor entry [0x000000000825f000]
   java.lang.Thread.State: BLOCKED (on object monitor)
                at com.nbp.theplatform.threaddump.ThreadDeadLockState$DeadlockThread.goMonitorDeadlock(ThreadDeadLockState.java:197)
                - waiting to lock &lt;0x00000007d58f5e48> (a com.nbp.theplatform.threaddump.ThreadDeadLockState$Monitor)
                at com.nbp.theplatform.threaddump.ThreadDeadLockState$DeadlockThread.monitorOurLock(ThreadDeadLockState.java:182)
                - locked &lt;0x00000007d58f5e78> (a com.nbp.theplatform.threaddump.ThreadDeadLockState$Monitor)
                at com.nbp.theplatform.threaddump.ThreadDeadLockState$DeadlockThread.run(ThreadDeadLockState.java:135)

   Locked ownable synchronizers:
                - None<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-943"><a class="markdownIt-Anchor" href="#-943">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-cli-tools.html#runnable">#</a>runnable</h4>
<p>一般指该线程正在执行状态中，该线程占用了资源，正在处理某个操作，如通过 SQL 语句查询数据库、对某个文件进行写入等。</p>
<h4 id="-944"><a class="markdownIt-Anchor" href="#-944">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-cli-tools.html#blocked">#</a>blocked</h4>
<p>线程正处于阻塞状态，指当前线程执行过程中，所需要的资源长时间等待却一直未能获取到，被容器的线程管理器标识为阻塞状态，可以理解为等待资源超时的线程。</p>
<p>【示例】blocked 示例</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">"BLOCKED_TEST pool-1-thread-2" prio=6 tid=0x0000000007673800 nid=0x260c waiting for monitor entry [0x0000000008abf000]
   java.lang.Thread.State: BLOCKED (on object monitor)
                at com.nbp.theplatform.threaddump.ThreadBlockedState.monitorLock(ThreadBlockedState.java:43)
                - waiting to lock &lt;0x0000000780a000b0> (a com.nbp.theplatform.threaddump.ThreadBlockedState)
                at com.nbp.theplatform.threaddump.ThreadBlockedState$2.run(ThreadBlockedState.java:26)
                at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)
                at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)
                at java.lang.Thread.run(Thread.java:662)
   Locked ownable synchronizers:
                - &lt;0x0000000780b0c6a0> (a java.util.concurrent.locks.ReentrantLock$NonfairSync)
"BLOCKED_TEST pool-1-thread-3" prio=6 tid=0x00000000074f5800 nid=0x1994 waiting for monitor entry [0x0000000008bbf000]
   java.lang.Thread.State: BLOCKED (on object monitor)
                at com.nbp.theplatform.threaddump.ThreadBlockedState.monitorLock(ThreadBlockedState.java:42)
                - waiting to lock &lt;0x0000000780a000b0> (a com.nbp.theplatform.threaddump.ThreadBlockedState)
                at com.nbp.theplatform.threaddump.ThreadBlockedState$3.run(ThreadBlockedState.java:34)
                at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886
                at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)
                at java.lang.Thread.run(Thread.java:662)
   Locked ownable synchronizers:
                - &lt;0x0000000780b0e1b8> (a java.util.concurrent.locks.ReentrantLock$NonfairSync)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-945"><a class="markdownIt-Anchor" href="#-945">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-cli-tools.html#waiting-on-condition">#</a>waiting on condition</h4>
<p>线程正处于等待资源或等待某个条件的发生，具体的原因需要结合下面堆栈信息进行分析。</p>
<p>（1）如果堆栈信息明确是应用代码，则证明该线程正在等待资源，一般是大量读取某种资源且该资源采用了资源锁的情况下，线程进入等待状态，等待资源的读取，或者正在等待其他线程的执行等。</p>
<p>（2）如果发现有大量的线程都正处于这种状态，并且堆栈信息中得知正等待网络读写，这是因为网络阻塞导致线程无法执行，很有可能是一个网络瓶颈的征兆：</p>
<ul>
<li>网络非常繁忙，几乎消耗了所有的带宽，仍然有大量数据等待网络读写；</li>
<li>网络可能是空闲的，但由于路由或防火墙等原因，导致包无法正常到达；</li>
</ul>
<p>所以一定要结合系统的一些性能观察工具进行综合分析，比如 netstat 统计单位时间的发送包的数量，看是否很明显超过了所在网络带宽的限制；观察 CPU 的利用率，看系统态的 CPU 时间是否明显大于用户态的 CPU 时间。这些都指向由于网络带宽所限导致的网络瓶颈。</p>
<p>（3）还有一种常见的情况是该线程在 sleep，等待 sleep 的时间到了，将被唤醒。</p>
<p>【示例】等待状态样例</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">"IoWaitThread" prio=6 tid=0x0000000007334800 nid=0x2b3c waiting on condition [0x000000000893f000]
  java.lang.Thread.State: WAITING (parking)
               at sun.misc.Unsafe.park(Native Method)
               - parking to wait for  &lt;0x00000007d5c45850> (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)
               at java.util.concurrent.locks.LockSupport.park(LockSupport.java:156)
               at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:1987)
               at java.util.concurrent.LinkedBlockingDeque.takeFirst(LinkedBlockingDeque.java:440)
               at java.util.concurrent.LinkedBlockingDeque.take(LinkedBlockingDeque.java:629)
               at com.nbp.theplatform.threaddump.ThreadIoWaitState$IoWaitHandler2.run(ThreadIoWaitState.java:89)
               at java.lang.Thread.run(Thread.java:662)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-946"><a class="markdownIt-Anchor" href="#-946">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-cli-tools.html#waiting-for-monitor-entry-%E6%88%96-in-object-wait">#</a>waiting for monitor entry 或 in Object.wait ()</h4>
<p>Moniter 是 Java 中用以实现线程之间的互斥与协作的主要手段，它可以看成是对象或者 class 的锁，每个对象都有，也仅有一个 Monitor。</p>
<p><img src="https://www.javatang.com/wp-content/uploads/2017/10/java-monitor.png" alt="img"></p>
<p>从上图可以看出，每个 Monitor 在某个时刻只能被一个线程拥有，该线程就是 “Active Thread”，而其他线程都是 “Waiting Thread”，分别在两个队列 &quot;Entry Set&quot; 和 &quot;Waint Set&quot; 里面等待。其中在 “Entry Set” 中等待的线程状态是  <code>waiting for monitor entry</code> ，在 “Wait Set” 中等待的线程状态是  <code>in Object.wait()</code> 。</p>
<p>（1）&quot;Entry Set&quot; 里面的线程。</p>
<p>我们称被  <code>synchronized</code>  保护起来的代码段为临界区，对应的代码如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">synchronized</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>当一个线程申请进入临界区时，它就进入了 “Entry Set” 队列中，这时候有两种可能性：</p>
<ul>
<li>该 Monitor 不被其他线程拥有，&quot;Entry Set&quot; 里面也没有其他等待的线程。本线程即成为相应类或者对象的 Monitor 的 Owner，执行临界区里面的代码；此时在 Thread Dump 中显示线程处于 “Runnable” 状态。</li>
<li>该 Monitor 被其他线程拥有，本线程在 “Entry Set” 队列中等待。此时在 Thread Dump 中显示线程处于 “waiting for monity entry” 状态。</li>
</ul>
<p>临界区的设置是为了保证其内部的代码执行的原子性和完整性，但因为临界区在任何时间只允许线程串行通过，这和我们使用多线程的初衷是相反的。如果在多线程程序中大量使用 synchronized，或者不适当的使用它，会造成大量线程在临界区的入口等待，造成系统的性能大幅下降。如果在 Thread Dump 中发现这个情况，应该审视源码并对其进行改进。</p>
<p>（2）&quot;Wait Set&quot; 里面的线程</p>
<p>当线程获得了 Monitor，进入了临界区之后，如果发现线程继续运行的条件没有满足，它则调用对象（通常是被 synchronized 的对象）的 wait () 方法，放弃 Monitor，进入 &quot;Wait Set&quot; 队列。只有当别的线程在该对象上调用了 notify () 或者 notifyAll () 方法，&quot;Wait Set&quot; 队列中的线程才得到机会去竞争，但是只有一个线程获得对象的 Monitor，恢复到运行态。&quot;Wait Set&quot; 中的线程在 Thread Dump 中显示的状态为 in Object.wait ()。通常来说，当 CPU 很忙的时候关注 Runnable 状态的线程，反之则关注 waiting for monitor entry 状态的线程。</p>
<h3 id="-947"><a class="markdownIt-Anchor" href="#-947">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-cli-tools.html#_4-4-jstack-%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B">#</a>4.4. jstack 使用示例</h3>
<h4 id="-948"><a class="markdownIt-Anchor" href="#-948">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-cli-tools.html#%E6%89%BE%E5%87%BA%E6%9F%90-java-%E8%BF%9B%E7%A8%8B%E4%B8%AD%E6%9C%80%E8%80%97%E8%B4%B9-cpu-%E7%9A%84-java-%E7%BA%BF%E7%A8%8B">#</a>找出某 Java 进程中最耗费 CPU 的 Java 线程</h4>
<p>（1）找出 Java 进程</p>
<p>假设应用名称为 myapp：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ jps <span class="token operator">|</span> <span class="token function">grep</span> myapp
<span class="token number">29527</span> myapp.jar<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>得到进程 ID 为 21711</p>
<p>（2）找出该进程内最耗费 CPU 的线程，可以使用  <code>ps -Lfp pid</code>  或者  <code>ps -mp pid -o THREAD, tid, time</code>  或者  <code>top -Hp pid</code></p>
<p><img src="http://static.oschina.net/uploads/space/2014/0128/170402_A57i_111708.png" alt="img"> TIME 列就是各个 Java 线程耗费的 CPU 时间，CPU 时间最长的是线程 ID 为 21742 的线程，用</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token builtin class-name">printf</span> <span class="token string">"%x<span class="token entity" title="\n">\n</span>"</span> <span class="token number">21742</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>得到 21742 的十六进制值为 54ee，下面会用到。</p>
<p>（3）使用 jstack 打印线程堆栈信息</p>
<p>下一步终于轮到 jstack 上场了，它用来输出进程 21711 的堆栈信息，然后根据线程 ID 的十六进制值 grep，如下：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ jstack <span class="token number">21711</span> <span class="token operator">|</span> <span class="token function">grep</span> 54ee
<span class="token string">"PollIntervalRetrySchedulerThread"</span> <span class="token assign-left variable">prio</span><span class="token operator">=</span><span class="token number">10</span> <span class="token assign-left variable">tid</span><span class="token operator">=</span>0x00007f950043e000 <span class="token assign-left variable">nid</span><span class="token operator">=</span>0x54ee <span class="token keyword">in</span> Object.wait<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>0x00007f94c6eda000<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>可以看到 CPU 消耗在  <code>PollIntervalRetrySchedulerThread</code>  这个类的  <code>Object.wait()</code> 。</p>
<blockquote>
<p>注：上面的例子中，默认只显示了一行信息，但很多时候我们希望查看更详细的调用栈。可以通过指定  <code>-A &lt;num&gt;</code>  的方式来显示行数。例如： <code>jstack -l &lt;pid&gt; | grep &lt;thread-hex-id&gt; -A 10</code></p>
</blockquote>
<p>（4）分析代码</p>
<p>我找了下我的代码，定位到下面的代码：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// Idle wait</span>
<span class="token function">getLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Thread ["</span> <span class="token operator">+</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"] is idle waiting..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
schedulerThreadState <span class="token operator">=</span> <span class="token class-name">PollTaskSchedulerThreadState<span class="token punctuation">.</span>IdleWaiting</span><span class="token punctuation">;</span>
<span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">long</span> waitTime <span class="token operator">=</span> now <span class="token operator">+</span> <span class="token function">getIdleWaitTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">long</span> timeUntilContinue <span class="token operator">=</span> waitTime <span class="token operator">-</span> now<span class="token punctuation">;</span>
<span class="token keyword">synchronized</span><span class="token punctuation">(</span>sigLock<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>halted<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    		sigLock<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>timeUntilContinue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
	<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ignore<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>它是轮询任务的空闲等待代码，上面的  <code>sigLock.wait(timeUntilContinue)</code>  就对应了前面的  <code>Object.wait()</code> 。</p>
<h4 id="-949"><a class="markdownIt-Anchor" href="#-949">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-cli-tools.html#%E7%94%9F%E6%88%90-threaddump-%E6%96%87%E4%BB%B6">#</a>生成 threaddump 文件</h4>
<p>可以使用  <code>jstack -l &lt;pid&gt; &gt; &lt;file-path&gt;</code>  命令生成 threaddump 文件</p>
<p>【示例】生成进程 ID 为 8841 的 Java 进程的 threaddump 文件。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">jstack -l 8841 > /home/threaddump.txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="-950"><a class="markdownIt-Anchor" href="#-950">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-cli-tools.html#_5-jinfo">#</a>5. jinfo</h2>
<blockquote>
<p><strong><a target="_blank" rel="noopener" href="https://docs.oracle.com/en/java/javase/11/tools/jinfo.html">jinfo(JVM Configuration info) (opens new window)</a>，是 Java 配置信息工具</strong>。jinfo 用于实时查看和调整虚拟机运行参数。如传递给 Java 虚拟机的 <code>-X</code> （即输出中的 jvm_args）、 <code>-XX</code>  参数（即输出中的 VM Flags），以及可在 Java 层面通过 <code>System.getProperty</code>  获取的 <code>-D</code>  参数（即输出中的 System Properties）。</p>
</blockquote>
<p>之前的  <code>jps -v</code>  口令只能查看到显示指定的参数，如果想要查看未被显示指定的参数的值就要使用 jinfo 口令。</p>
<p>jinfo 命令格式：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">jinfo <span class="token punctuation">[</span>option<span class="token punctuation">]</span> pid<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><code>option</code>  选项参数：</p>
<ul>
<li><code>-flag</code>  - 输出指定 args 参数的值</li>
<li><code>-sysprops</code>  - 输出系统属性，等同于  <code>System.getProperties()</code></li>
</ul>
<p>【示例】jinfo 使用示例</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ jinfo -sysprops <span class="token number">29527</span>
Attaching to process ID <span class="token number">29527</span>, please wait<span class="token punctuation">..</span>.
Debugger attached successfully.
Server compiler detected.
JVM version is <span class="token number">25.222</span>-b10
<span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="-951"><a class="markdownIt-Anchor" href="#-951">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-cli-tools.html#_6-jhat">#</a>6. jhat</h2>
<blockquote>
<p><strong>jhat (JVM Heap Analysis Tool)，是虚拟机堆转储快照分析工具</strong>。jhat 与 jmap 搭配使用，用来分析 jmap 生成的 dump 文件。jhat 内置了一个微型的 HTTP/HTML 服务器，生成 dump 的分析结果后，可以在浏览器中查看。</p>
<p>注意：一般不会直接在服务器上进行分析，因为 jhat 是一个耗时并且耗费硬件资源的过程，一般把服务器生成的 dump 文件，用 jvisualvm 、Eclipse Memory Analyzer、IBM HeapAnalyzer 等工具来分析。</p>
</blockquote>
<p>命令格式：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">jhat <span class="token punctuation">[</span>dumpfile<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<hr>
<h1 id="jvm-gui-工具"><a class="markdownIt-Anchor" href="#jvm-gui-工具">#</a> JVM GUI 工具</h1>
<blockquote>
<p>Java 程序员免不了故障排查工作，所以经常需要使用一些 JVM 工具。</p>
<p>本文系统性的介绍一下常用的 JVM GUI 工具。</p>
</blockquote>
<ul>
<li>\1. jconsole
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gui-tools.html#11-%E5%BC%80%E5%90%AF-jmx">1.1. 开启 JMX</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gui-tools.html#12-%E8%BF%9E%E6%8E%A5-jconsole">1.2. 连接 jconsole</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gui-tools.html#13-jconsole-%E7%95%8C%E9%9D%A2">1.3. jconsole 界面</a></li>
</ul>
</li>
<li>\2. jvisualvm
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gui-tools.html#21-jvisualvm-%E6%A6%82%E8%BF%B0%E9%A1%B5%E9%9D%A2">2.1. jvisualvm 概述页面</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gui-tools.html#22-jvisualvm-%E7%9B%91%E6%8E%A7%E9%A1%B5%E9%9D%A2">2.2. jvisualvm 监控页面</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gui-tools.html#23-jvisualvm-%E7%BA%BF%E7%A8%8B%E9%A1%B5%E9%9D%A2">2.3. jvisualvm 线程页面</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gui-tools.html#24-jvisualvm-%E6%8A%BD%E6%A0%B7%E5%99%A8%E9%A1%B5%E9%9D%A2">2.4. jvisualvm 抽样器页面</a></li>
</ul>
</li>
<li>\3. MAT
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gui-tools.html#31-mat-%E9%85%8D%E7%BD%AE">3.1. MAT 配置</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gui-tools.html#32-mat-%E5%88%86%E6%9E%90">3.2. MAT 分析</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gui-tools.html#4-jprofile">4. JProfile</a></li>
<li>\5. Arthas
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gui-tools.html#51-arthas-%E5%9F%BA%E7%A1%80%E5%91%BD%E4%BB%A4">5.1. Arthas 基础命令</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gui-tools.html#52-arthas-jvm-%E7%9B%B8%E5%85%B3%E5%91%BD%E4%BB%A4">5.2. Arthas jvm 相关命令</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gui-tools.html#53-arthas-classclassloader-%E7%9B%B8%E5%85%B3%E5%91%BD%E4%BB%A4">5.3. Arthas class/classloader 相关命令</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gui-tools.html#54-arthas-monitorwatchtrace-%E7%9B%B8%E5%85%B3%E5%91%BD%E4%BB%A4">5.4. Arthas monitor/watch/trace 相关命令</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gui-tools.html#6-%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">6. 参考资料</a></li>
</ul>
<h2 id="-952"><a class="markdownIt-Anchor" href="#-952">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gui-tools.html#_1-jconsole">#</a>1. jconsole</h2>
<blockquote>
<p>jconsole 是 JDK 自带的 GUI 工具。<strong>jconsole (Java Monitoring and Management Console) 是一种基于 JMX 的可视化监视与管理工具</strong>。</p>
<p>jconsole 的管理功能是针对 JMX MBean 进行管理，由于 MBean 可以使用代码、中间件服务器的管理控制台或所有符合 JMX 规范的软件进行访问。</p>
</blockquote>
<p>注意：使用 jconsole 的前提是 Java 应用开启 JMX。</p>
<h3 id="-953"><a class="markdownIt-Anchor" href="#-953">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gui-tools.html#_1-1-%E5%BC%80%E5%90%AF-jmx">#</a>1.1. 开启 JMX</h3>
<p>Java 应用开启 JMX 后，可以使用  <code>jconsole</code>  或  <code>jvisualvm</code>  进行监控 Java 程序的基本信息和运行情况。</p>
<p>开启方法是，在 java 指令后，添加以下参数：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">-</span><span class="token class-name">Dcom</span><span class="token punctuation">.</span>sun<span class="token punctuation">.</span>management<span class="token punctuation">.</span>jmxremote<span class="token operator">=</span><span class="token boolean">true</span>
<span class="token operator">-</span><span class="token class-name">Dcom</span><span class="token punctuation">.</span>sun<span class="token punctuation">.</span>management<span class="token punctuation">.</span>jmxremote<span class="token punctuation">.</span>ssl<span class="token operator">=</span><span class="token boolean">false</span>
<span class="token operator">-</span><span class="token class-name">Dcom</span><span class="token punctuation">.</span>sun<span class="token punctuation">.</span>management<span class="token punctuation">.</span>jmxremote<span class="token punctuation">.</span>authenticate<span class="token operator">=</span><span class="token boolean">false</span>
<span class="token operator">-</span><span class="token class-name">Djava</span><span class="token punctuation">.</span>rmi<span class="token punctuation">.</span>server<span class="token punctuation">.</span>hostname<span class="token operator">=</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span>
<span class="token operator">-</span><span class="token class-name">Dcom</span><span class="token punctuation">.</span>sun<span class="token punctuation">.</span>management<span class="token punctuation">.</span>jmxremote<span class="token punctuation">.</span>port<span class="token operator">=</span><span class="token number">18888</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><code>-Djava.rmi.server.hostname</code>  - 指定 Java 程序运行的服务器</li>
<li><code>-Dcom.sun.management.jmxremote.port</code>  - 指定 JMX 服务监听端口</li>
</ul>
<h3 id="-954"><a class="markdownIt-Anchor" href="#-954">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gui-tools.html#_1-2-%E8%BF%9E%E6%8E%A5-jconsole">#</a>1.2. 连接 jconsole</h3>
<p>如果是本地 Java 进程，jconsole 可以直接绑定连接。</p>
<p>如果是远程 Java 进程，需要连接 Java 进程的 JMX 端口。</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/connectadv.gif" alt="Connecting to a JMX Agent Using the JMX Service URL"></p>
<h3 id="-955"><a class="markdownIt-Anchor" href="#-955">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gui-tools.html#_1-3-jconsole-%E7%95%8C%E9%9D%A2">#</a>1.3. jconsole 界面</h3>
<p>进入 jconsole 应用后，可以看到以下 tab 页面。</p>
<ul>
<li><code>概述</code>  - 显示有关 Java VM 和监视值的概述信息。</li>
<li><code>内存</code>  - 显示有关内存使用的信息。内存页相当于可视化的  <code>jstat</code>  命令。</li>
<li><code>线程</code>  - 显示有关线程使用的信息。</li>
<li><code>类</code>  - 显示有关类加载的信息。</li>
<li><code>VM 摘要</code>  - 显示有关 Java VM 的信息。</li>
<li><code>MBean</code>  - 显示有关 MBean 的信息。</li>
</ul>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/20200730151422.png" alt="img"></p>
<h2 id="-956"><a class="markdownIt-Anchor" href="#-956">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gui-tools.html#_2-jvisualvm">#</a>2. jvisualvm</h2>
<blockquote>
<p>jvisualvm 是 JDK 自带的 GUI 工具。<strong>jvisualvm (All-In-One Java Troubleshooting Tool) 是多合一故障处理工具</strong>。它支持运行监视、故障处理、性能分析等功能。</p>
</blockquote>
<p>个人觉得 jvisualvm 比 jconsole 好用。</p>
<h3 id="-957"><a class="markdownIt-Anchor" href="#-957">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gui-tools.html#_2-1-jvisualvm-%E6%A6%82%E8%BF%B0%E9%A1%B5%E9%9D%A2">#</a>2.1. jvisualvm 概述页面</h3>
<p>jvisualvm 概述页面可以查看当前 Java 进程的基本信息，如：JDK 版本、Java 进程、JVM 参数等。</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/20200730150147.png" alt="img"></p>
<h3 id="-958"><a class="markdownIt-Anchor" href="#-958">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gui-tools.html#_2-2-jvisualvm-%E7%9B%91%E6%8E%A7%E9%A1%B5%E9%9D%A2">#</a>2.2. jvisualvm 监控页面</h3>
<p>在 jvisualvm 监控页面，可以看到 Java 进程的 CPU、内存、类加载、线程的实时变化。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200730150254.png" alt="img"></p>
<h3 id="-959"><a class="markdownIt-Anchor" href="#-959">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gui-tools.html#_2-3-jvisualvm-%E7%BA%BF%E7%A8%8B%E9%A1%B5%E9%9D%A2">#</a>2.3. jvisualvm 线程页面</h3>
<p>jvisualvm 线程页面展示了当前的线程状态。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200730150416.png" alt="img"></p>
<p>jvisualvm 还可以生成线程 Dump 文件，帮助进一步分析线程栈信息。</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/20200730150830.png" alt="img"></p>
<h3 id="-960"><a class="markdownIt-Anchor" href="#-960">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gui-tools.html#_2-4-jvisualvm-%E6%8A%BD%E6%A0%B7%E5%99%A8%E9%A1%B5%E9%9D%A2">#</a>2.4. jvisualvm 抽样器页面</h3>
<p>jvisualvm 可以对 CPU、内存进行抽样，帮助我们进行性能分析。</p>
<p><img src="C:/%5CUsers%5Czp%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200730150648010.png" alt="image-20200730150648010"></p>
<h2 id="-961"><a class="markdownIt-Anchor" href="#-961">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gui-tools.html#_3-mat">#</a>3. MAT</h2>
<p><a target="_blank" rel="noopener" href="https://www.eclipse.org/mat/">MAT (opens new window)</a> 即 Eclipse Memory Analyzer Tool 的缩写。</p>
<p>MAT 本身也能够获取堆的二进制快照。该功能将借助  <code>jps</code>  列出当前正在运行的 Java 进程，以供选择并获取快照。由于  <code>jps</code>  会将自己列入其中，因此你会在列表中发现一个已经结束运行的  <code>jps</code>  进程。</p>
<p>MAT 可以独立安装（<a target="_blank" rel="noopener" href="http://www.eclipse.org/mat/downloads.php">官方下载地址 (opens new window)</a>），也可以作为 Eclipse IDE 的插件安装。</p>
<h3 id="-962"><a class="markdownIt-Anchor" href="#-962">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gui-tools.html#_3-1-mat-%E9%85%8D%E7%BD%AE">#</a>3.1. MAT 配置</h3>
<p>MAT 解压后，安装目录下有个  <code>MemoryAnalyzer.ini</code>  文件。</p>
<pre class="line-numbers language-none"><code class="language-none">MemoryAnalyzer.ini&#96; 中有个重要的参数 &#96;Xmx&#96; 表示最大内存，默认为：&#96;-vmargs -Xmx1024m<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>如果试图用 MAT 导入的 dump 文件超过 1024 M，会报错：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">An internal error occurred during: <span class="token string">"Parsing heap dump from XXX"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>此时，可以适当调整  <code>Xmx</code>  大小。如果设置的  <code>Xmx</code>  数值过大，本机内存不足以支撑，启动 MAT 会报错：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Failed to create the Java Virtual Machine<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="-963"><a class="markdownIt-Anchor" href="#-963">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gui-tools.html#_3-2-mat-%E5%88%86%E6%9E%90">#</a>3.2. MAT 分析</h3>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/20200308092746.png" alt="img"></p>
<p>点击 Leak Suspects 可以进入内存泄漏页面。</p>
<p>（1）首先，可以查看饼图了解内存的整体消耗情况</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200308150556.png" alt="img"></p>
<p>（2）缩小范围，寻找问题疑似点</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/20160223202154818" alt="img"></p>
<p>可以点击进入详情页面，在详情页面 Shortest Paths To the Accumulation Point 表示 GC root 到内存消耗聚集点的最短路径，如果某个内存消耗聚集点有路径到达 GC root，则该内存消耗聚集点不会被当做垃圾被回收。</p>
<p>为了找到内存泄露，我获取了两个堆转储文件，两个文件获取时间间隔是一天（因为内存只是小幅度增长，短时间很难发现问题）。对比两个文件的对象，通过对比后的结果可以很方便定位内存泄露。</p>
<p>MAT 同时打开两个堆转储文件，分别打开 Histogram，如下图。在下图中方框 1 按钮用于对比两个 Histogram，对比后在方框 2 处选择 Group By package，然后对比各对象的变化。不难发现 heap3.hprof 比 heap6.hprof 少了 64 个 eventInfo 对象，如果对代码比较熟悉的话想必这样一个结果是能够给程序员一定的启示的。而我也是根据这个启示差找到了最终内存泄露的位置。 <img src="https://img-blog.csdn.net/20160223203226362" alt="img"></p>
<h2 id="-964"><a class="markdownIt-Anchor" href="#-964">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gui-tools.html#_4-jprofile">#</a>4. JProfile</h2>
<p><a target="_blank" rel="noopener" href="https://www.ej-technologies.com/products/jprofiler/overview.html">JProfiler (opens new window)</a> 是一款性能分析工具。</p>
<p>由于它是收费的，所以我本人使用较少。但是，它确实功能强大，且方便使用，还可以和 Intellij Idea 集成。</p>
<p><img src="C:/%5CUsers%5Czp%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200730152158398.png" alt="image-20200730152158398"></p>
<h2 id="-965"><a class="markdownIt-Anchor" href="#-965">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gui-tools.html#_5-arthas">#</a>5. Arthas</h2>
<p><a target="_blank" rel="noopener" href="https://github.com/alibaba/arthas">Arthas (opens new window)</a> 是 Alibaba 开源的 Java 诊断工具，深受开发者喜爱。在线排查问题，无需重启；动态跟踪 Java 代码；实时监控 JVM 状态。</p>
<p>Arthas 支持 JDK 6+，支持 Linux/Mac/Windows，采用命令行交互模式，同时提供丰富的  <code>Tab</code>  自动补全功能，进一步方便进行问题的定位和诊断。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200730145030.png" alt="img"></p>
<h3 id="-966"><a class="markdownIt-Anchor" href="#-966">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gui-tools.html#_5-1-arthas-%E5%9F%BA%E7%A1%80%E5%91%BD%E4%BB%A4">#</a>5.1. Arthas 基础命令</h3>
<ul>
<li>help—— 查看命令帮助信息</li>
<li><a target="_blank" rel="noopener" href="https://alibaba.github.io/arthas/cat.html">cat (opens new window)</a>—— 打印文件内容，和 linux 里的 cat 命令类似</li>
<li><a target="_blank" rel="noopener" href="https://alibaba.github.io/arthas/echo.html">echo (opens new window)</a>–打印参数，和 linux 里的 echo 命令类似</li>
<li><a target="_blank" rel="noopener" href="https://alibaba.github.io/arthas/grep.html">grep (opens new window)</a>—— 匹配查找，和 linux 里的 grep 命令类似</li>
<li><a target="_blank" rel="noopener" href="https://alibaba.github.io/arthas/tee.html">tee (opens new window)</a>—— 复制标准输入到标准输出和指定的文件，和 linux 里的 tee 命令类似</li>
<li><a target="_blank" rel="noopener" href="https://alibaba.github.io/arthas/pwd.html">pwd (opens new window)</a>—— 返回当前的工作目录，和 linux 命令类似</li>
<li>cls—— 清空当前屏幕区域</li>
<li>session—— 查看当前会话的信息</li>
<li><a target="_blank" rel="noopener" href="https://alibaba.github.io/arthas/reset.html">reset (opens new window)</a>—— 重置增强类，将被 Arthas 增强过的类全部还原，Arthas 服务端关闭时会重置所有增强过的类</li>
<li>version—— 输出当前目标 Java 进程所加载的 Arthas 版本号</li>
<li>history—— 打印命令历史</li>
<li>quit—— 退出当前 Arthas 客户端，其他 Arthas 客户端不受影响</li>
<li>stop—— 关闭 Arthas 服务端，所有 Arthas 客户端全部退出</li>
<li><a target="_blank" rel="noopener" href="https://alibaba.github.io/arthas/keymap.html">keymap (opens new window)</a>——Arthas 快捷键列表及自定义快捷键</li>
</ul>
<h3 id="-967"><a class="markdownIt-Anchor" href="#-967">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gui-tools.html#_5-2-arthas-jvm-%E7%9B%B8%E5%85%B3%E5%91%BD%E4%BB%A4">#</a>5.2. Arthas jvm 相关命令</h3>
<ul>
<li><a target="_blank" rel="noopener" href="https://alibaba.github.io/arthas/dashboard.html">dashboard (opens new window)</a>—— 当前系统的实时数据面板</li>
<li><a target="_blank" rel="noopener" href="https://alibaba.github.io/arthas/thread.html">thread (opens new window)</a>—— 查看当前 JVM 的线程堆栈信息</li>
<li><a target="_blank" rel="noopener" href="https://alibaba.github.io/arthas/jvm.html">jvm (opens new window)</a>—— 查看当前 JVM 的信息</li>
<li><a target="_blank" rel="noopener" href="https://alibaba.github.io/arthas/sysprop.html">sysprop (opens new window)</a>—— 查看和修改 JVM 的系统属性</li>
<li><a target="_blank" rel="noopener" href="https://alibaba.github.io/arthas/sysenv.html">sysenv (opens new window)</a>—— 查看 JVM 的环境变量</li>
<li><a target="_blank" rel="noopener" href="https://alibaba.github.io/arthas/vmoption.html">vmoption (opens new window)</a>—— 查看和修改 JVM 里诊断相关的 option</li>
<li><a target="_blank" rel="noopener" href="https://alibaba.github.io/arthas/perfcounter.html">perfcounter (opens new window)</a>—— 查看当前 JVM 的 Perf Counter 信息</li>
<li><a target="_blank" rel="noopener" href="https://alibaba.github.io/arthas/logger.html">logger (opens new window)</a>—— 查看和修改 logger</li>
<li><a target="_blank" rel="noopener" href="https://alibaba.github.io/arthas/getstatic.html">getstatic (opens new window)</a>—— 查看类的静态属性</li>
<li><a target="_blank" rel="noopener" href="https://alibaba.github.io/arthas/ognl.html">ognl (opens new window)</a>—— 执行 ognl 表达式</li>
<li><a target="_blank" rel="noopener" href="https://alibaba.github.io/arthas/mbean.html">mbean (opens new window)</a>—— 查看 Mbean 的信息</li>
<li><a target="_blank" rel="noopener" href="https://alibaba.github.io/arthas/heapdump.html">heapdump (opens new window)</a>——dump java heap, 类似 jmap 命令的 heap dump 功能</li>
</ul>
<h3 id="-968"><a class="markdownIt-Anchor" href="#-968">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gui-tools.html#_5-3-arthas-class-classloader-%E7%9B%B8%E5%85%B3%E5%91%BD%E4%BB%A4">#</a>5.3. Arthas class/classloader 相关命令</h3>
<ul>
<li><a target="_blank" rel="noopener" href="https://alibaba.github.io/arthas/sc.html">sc (opens new window)</a>—— 查看 JVM 已加载的类信息</li>
<li><a target="_blank" rel="noopener" href="https://alibaba.github.io/arthas/sm.html">sm (opens new window)</a>—— 查看已加载类的方法信息</li>
<li><a target="_blank" rel="noopener" href="https://alibaba.github.io/arthas/jad.html">jad (opens new window)</a>—— 反编译指定已加载类的源码</li>
<li><a target="_blank" rel="noopener" href="https://alibaba.github.io/arthas/mc.html">mc (opens new window)</a>—— 内存编译器，内存编译 <code>.java</code>  文件为 <code>.class</code>  文件</li>
<li><a target="_blank" rel="noopener" href="https://alibaba.github.io/arthas/redefine.html">redefine (opens new window)</a>—— 加载外部的 <code>.class</code>  文件，redefine 到 JVM 里</li>
<li><a target="_blank" rel="noopener" href="https://alibaba.github.io/arthas/dump.html">dump (opens new window)</a>——dump 已加载类的 byte code 到特定目录</li>
<li><a target="_blank" rel="noopener" href="https://alibaba.github.io/arthas/classloader.html">classloader (opens new window)</a>—— 查看 classloader 的继承树，urls，类加载信息，使用 classloader 去 getResource</li>
</ul>
<h3 id="-969"><a class="markdownIt-Anchor" href="#-969">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-gui-tools.html#_5-4-arthas-monitor-watch-trace-%E7%9B%B8%E5%85%B3%E5%91%BD%E4%BB%A4">#</a>5.4. Arthas monitor/watch/trace 相关命令</h3>
<blockquote>
<p>请注意，这些命令，都通过字节码增强技术来实现的，会在指定类的方法中插入一些切面来实现数据统计和观测，因此在线上、预发使用时，请尽量明确需要观测的类、方法以及条件，诊断结束要执行  <code>stop</code>  或将增强过的类执行  <code>reset</code>  命令。</p>
</blockquote>
<ul>
<li><a target="_blank" rel="noopener" href="https://alibaba.github.io/arthas/monitor.html">monitor (opens new window)</a>—— 方法执行监控</li>
<li><a target="_blank" rel="noopener" href="https://alibaba.github.io/arthas/watch.html">watch (opens new window)</a>—— 方法执行数据观测</li>
<li><a target="_blank" rel="noopener" href="https://alibaba.github.io/arthas/trace.html">trace (opens new window)</a>—— 方法内部调用路径，并输出方法路径上的每个节点上耗时</li>
<li><a target="_blank" rel="noopener" href="https://alibaba.github.io/arthas/stack.html">stack (opens new window)</a>—— 输出当前方法被调用的调用路径</li>
<li><a target="_blank" rel="noopener" href="https://alibaba.github.io/arthas/tt.html">tt (opens new window)</a>—— 方法执行数据的时空隧道，记录下指定方法每次调用的入参和返回信息，并能对这些不同的时间下调用进行观测</li>
</ul>
<hr>
<h1 id="java-应用故障诊断"><a class="markdownIt-Anchor" href="#java-应用故障诊断">#</a> Java 应用故障诊断</h1>
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/trouble-shooting.html#%E4%B8%80%E6%95%85%E9%9A%9C%E5%AE%9A%E4%BD%8D%E6%80%9D%E8%B7%AF">一、故障定位思路</a></li>
<li>二、CPU 问题
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/trouble-shooting.html#%E6%9F%A5%E6%89%BE-cpu-%E5%8D%A0%E7%94%A8%E7%8E%87%E8%BE%83%E9%AB%98%E7%9A%84%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B">查找 CPU 占用率较高的进程、线程</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/trouble-shooting.html#%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8%E9%A2%91%E7%B9%81-gc">是否存在频繁 GC</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/trouble-shooting.html#%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8%E9%A2%91%E7%B9%81%E4%B8%8A%E4%B8%8B%E6%96%87%E5%88%87%E6%8D%A2">是否存在频繁上下文切换</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/trouble-shooting.html#%E4%B8%89%E5%86%85%E5%AD%98%E9%97%AE%E9%A2%98">三、内存问题</a></li>
<li>四、磁盘问题
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/trouble-shooting.html#%E6%9F%A5%E7%9C%8B%E7%A3%81%E7%9B%98%E7%A9%BA%E9%97%B4%E4%BD%BF%E7%94%A8%E7%8E%87">查看磁盘空间使用率</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/trouble-shooting.html#%E6%9F%A5%E7%9C%8B%E7%A3%81%E7%9B%98%E8%AF%BB%E5%86%99%E6%80%A7%E8%83%BD">查看磁盘读写性能</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/trouble-shooting.html#%E6%9F%A5%E7%9C%8B%E5%85%B7%E4%BD%93%E7%9A%84%E6%96%87%E4%BB%B6%E8%AF%BB%E5%86%99%E6%83%85%E5%86%B5">查看具体的文件读写情况</a></li>
</ul>
</li>
<li>五、网络问题
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/trouble-shooting.html#%E6%97%A0%E6%B3%95%E8%BF%9E%E6%8E%A5">无法连接</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/trouble-shooting.html#%E7%BD%91%E7%BB%9C%E8%B6%85%E6%97%B6">网络超时</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/trouble-shooting.html#tcp-%E9%98%9F%E5%88%97%E6%BA%A2%E5%87%BA">TCP 队列溢出</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/trouble-shooting.html#rst-%E5%BC%82%E5%B8%B8">RST 异常</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/trouble-shooting.html#time_wait-%E5%92%8C-close_wait">TIME_WAIT 和 CLOSE_WAIT</a></li>
</ul>
</li>
<li>六、GC 问题
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/trouble-shooting.html#oom">OOM</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/trouble-shooting.html#minor-gc">Minor GC</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/trouble-shooting.html#full-gc-%E8%BF%87%E9%A2%91">Full GC 过频</a></li>
</ul>
</li>
<li>七、常用 Linux 命令
<ul>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/trouble-shooting.html#top">top</a></li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/trouble-shooting.html#vmstat">vmstat</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/trouble-shooting.html#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">参考资料</a></li>
</ul>
<h2 id="-970"><a class="markdownIt-Anchor" href="#-970">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/trouble-shooting.html#%E4%B8%80%E3%80%81%E6%95%85%E9%9A%9C%E5%AE%9A%E4%BD%8D%E6%80%9D%E8%B7%AF">#</a>一、故障定位思路</h2>
<p>Java 应用出现线上故障，如何进行诊断？</p>
<p>我们在定位线上问题时要有一个整体的思路，顺藤摸瓜，才能较快的找到问题原因。</p>
<p>一般来说，服务器故障诊断的整体思路如下：</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/20200309181645.png" alt="img"></p>
<p>应用故障诊断思路：</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/20200309181831.png" alt="img"></p>
<h2 id="-971"><a class="markdownIt-Anchor" href="#-971">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/trouble-shooting.html#%E4%BA%8C%E3%80%81cpu-%E9%97%AE%E9%A2%98">#</a>二、CPU 问题</h2>
<p>一、<strong>CPU 使用率过高</strong>：往往是由于程序逻辑问题导致的。常见导致 CPU 飙升的问题场景如：死循环，无限递归、频繁 GC、线程上下文切换过多。</p>
<p>二、<strong>CPU 始终升不上去</strong>：往往是由于程序中存在大量 IO 操作并且时间很长（数据库读写、日志等）。</p>
<h3 id="-972"><a class="markdownIt-Anchor" href="#-972">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/trouble-shooting.html#%E6%9F%A5%E6%89%BE-cpu-%E5%8D%A0%E7%94%A8%E7%8E%87%E8%BE%83%E9%AB%98%E7%9A%84%E8%BF%9B%E7%A8%8B%E3%80%81%E7%BA%BF%E7%A8%8B">#</a>查找 CPU 占用率较高的进程、线程</h3>
<p>线上环境的 Java 应用可能有多个进程、线程，所以，要先找到 CPU 占用率较高的进程、线程。</p>
<p>（1）使用  <code>ps</code>  命令查看 xxx 应用的进程 ID（PID）</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">ps</span> -ef <span class="token operator">|</span> <span class="token function">grep</span> xxx<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>也可以使用  <code>jps</code>  命令来查看。</p>
<p>（2）如果应用有多个进程，可以用  <code>top</code>  命令查看哪个占用 CPU 较高。</p>
<p>（3）用  <code>top -Hp pid</code>  来找到 CPU 使用率比较高的一些线程。</p>
<p>（4）将占用 CPU 最高的 PID 转换为 16 进制，使用  <code>printf '%x\n' pid</code>  得到  <code>nid</code></p>
<p>（5）使用  <code>jstack pic | grep 'nid' -C5</code>  命令，查看堆栈信息：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ jstack <span class="token number">7129</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">'0x1c23'</span> -C5
        at java.lang.Object.wait<span class="token punctuation">(</span>Object.java:502<span class="token punctuation">)</span>
        at java.lang.ref.Reference.tryHandlePending<span class="token punctuation">(</span>Reference.java:191<span class="token punctuation">)</span>
        - locked <span class="token operator">&lt;</span>0x00000000b5383ff<span class="token operator"><span class="token file-descriptor important">0</span>></span> <span class="token punctuation">(</span>a java.lang.ref.Reference<span class="token variable">$Lock</span><span class="token punctuation">)</span>
        at java.lang.ref.Reference<span class="token variable">$ReferenceHandler</span>.run<span class="token punctuation">(</span>Reference.java:153<span class="token punctuation">)</span>

<span class="token string">"main"</span> <span class="token comment">#1 prio=5 os_prio=0 tid=0x00007f4df400a800 nid=0x1c23 in Object.wait() [0x00007f4dfdec8000]</span>
   java.lang.Thread.State: WAITING <span class="token punctuation">(</span>on object monitor<span class="token punctuation">)</span>
        at java.lang.Object.wait<span class="token punctuation">(</span>Native Method<span class="token punctuation">)</span>
        - waiting on <span class="token operator">&lt;</span>0x00000000b538401<span class="token operator"><span class="token file-descriptor important">8</span>></span> <span class="token punctuation">(</span>a org.apache.felix.framework.util.ThreadGate<span class="token punctuation">)</span>
        at org.apache.felix.framework.util.ThreadGate.await<span class="token punctuation">(</span>ThreadGate.java:79<span class="token punctuation">)</span>
        - locked <span class="token operator">&lt;</span>0x00000000b538401<span class="token operator"><span class="token file-descriptor important">8</span>></span> <span class="token punctuation">(</span>a org.apache.felix.framework.util.ThreadGate<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>（6）更常见的操作是用  <code>jstack</code>  生成堆栈快照，然后基于快照文件进行分析。生成快照命令：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">jstack -F -l pid <span class="token operator">>></span> threaddump.log<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>（7）分析堆栈信息</p>
<p>一般来说，状态为  <code>WAITING</code> 、 <code>TIMED_WAITING</code>  、 <code>BLOCKED</code>  的线程更可能出现问题。可以执行以下命令查看线程状态统计：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">cat threaddump.log | grep "java.lang.Thread.State" | sort -nr | uniq -c<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>如果存在大量  <code>WAITING</code> 、 <code>TIMED_WAITING</code>  、 <code>BLOCKED</code>  ，那么多半是有问题啦。</p>
<h3 id="-973"><a class="markdownIt-Anchor" href="#-973">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/trouble-shooting.html#%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8%E9%A2%91%E7%B9%81-gc">#</a>是否存在频繁 GC</h3>
<p>如果应用频繁 GC，也可能导致 CPU 飙升。为何频繁 GC 可以使用  <code>jstack</code>  来分析问题（分析和解决频繁 GC 问题，在后续讲解）。</p>
<p>那么，如何判断 Java 进程 GC 是否频繁？</p>
<p>可以使用  <code>jstat -gc pid 1000</code>  命令来观察 GC 状态。</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ jstat -gc <span class="token number">29527</span> <span class="token number">200</span> <span class="token number">5</span>
 S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT     GCT
<span class="token number">22528.0</span> <span class="token number">22016.0</span>  <span class="token number">0.0</span>   <span class="token number">21388.2</span> <span class="token number">4106752.0</span> <span class="token number">921244.7</span> <span class="token number">5592576.0</span>  <span class="token number">2086826.5</span>  <span class="token number">110716.0</span> <span class="token number">103441.1</span> <span class="token number">12416.0</span> <span class="token number">11167.7</span>   <span class="token number">3189</span>   <span class="token number">90.057</span>  <span class="token number">10</span>      <span class="token number">2.140</span>   <span class="token number">92.197</span>
<span class="token number">22528.0</span> <span class="token number">22016.0</span>  <span class="token number">0.0</span>   <span class="token number">21388.2</span> <span class="token number">4106752.0</span> <span class="token number">921244.7</span> <span class="token number">5592576.0</span>  <span class="token number">2086826.5</span>  <span class="token number">110716.0</span> <span class="token number">103441.1</span> <span class="token number">12416.0</span> <span class="token number">11167.7</span>   <span class="token number">3189</span>   <span class="token number">90.057</span>  <span class="token number">10</span>      <span class="token number">2.140</span>   <span class="token number">92.197</span>
<span class="token number">22528.0</span> <span class="token number">22016.0</span>  <span class="token number">0.0</span>   <span class="token number">21388.2</span> <span class="token number">4106752.0</span> <span class="token number">921244.7</span> <span class="token number">5592576.0</span>  <span class="token number">2086826.5</span>  <span class="token number">110716.0</span> <span class="token number">103441.1</span> <span class="token number">12416.0</span> <span class="token number">11167.7</span>   <span class="token number">3189</span>   <span class="token number">90.057</span>  <span class="token number">10</span>      <span class="token number">2.140</span>   <span class="token number">92.197</span>
<span class="token number">22528.0</span> <span class="token number">22016.0</span>  <span class="token number">0.0</span>   <span class="token number">21388.2</span> <span class="token number">4106752.0</span> <span class="token number">921244.7</span> <span class="token number">5592576.0</span>  <span class="token number">2086826.5</span>  <span class="token number">110716.0</span> <span class="token number">103441.1</span> <span class="token number">12416.0</span> <span class="token number">11167.7</span>   <span class="token number">3189</span>   <span class="token number">90.057</span>  <span class="token number">10</span>      <span class="token number">2.140</span>   <span class="token number">92.197</span>
<span class="token number">22528.0</span> <span class="token number">22016.0</span>  <span class="token number">0.0</span>   <span class="token number">21388.2</span> <span class="token number">4106752.0</span> <span class="token number">921244.7</span> <span class="token number">5592576.0</span>  <span class="token number">2086826.5</span>  <span class="token number">110716.0</span> <span class="token number">103441.1</span> <span class="token number">12416.0</span> <span class="token number">11167.7</span>   <span class="token number">3189</span>   <span class="token number">90.057</span>  <span class="token number">10</span>      <span class="token number">2.140</span>   <span class="token number">92.197</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-974"><a class="markdownIt-Anchor" href="#-974">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/trouble-shooting.html#%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8%E9%A2%91%E7%B9%81%E4%B8%8A%E4%B8%8B%E6%96%87%E5%88%87%E6%8D%A2">#</a>是否存在频繁上下文切换</h3>
<p>针对频繁上下文切换问题，可以使用  <code>vmstat pid</code>  命令来进行查看。</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ <span class="token function">vmstat</span> <span class="token number">7129</span>
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   <span class="token function">free</span>   buff  cache   si   so    bi    bo   <span class="token keyword">in</span>   cs us sy <span class="token function">id</span> wa st
 <span class="token number">1</span>  <span class="token number">0</span>   <span class="token number">6836</span> <span class="token number">737532</span>   <span class="token number">1588</span> <span class="token number">3504956</span>    <span class="token number">0</span>    <span class="token number">0</span>     <span class="token number">1</span>     <span class="token number">4</span>    <span class="token number">5</span>    <span class="token number">3</span>  <span class="token number">0</span>  <span class="token number">0</span> <span class="token number">100</span>  <span class="token number">0</span>  <span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中， <code>cs</code>  一列代表了上下文切换的次数。</p>
<p>【解决方法】</p>
<p>如果，线程上下文切换很频繁，可以考虑在应用中针对线程进行优化，方法有：</p>
<ul>
<li><strong>无锁并发</strong>：多线程竞争时，会引起上下文切换，所以多线程处理数据时，可以用一些办法来避免使用锁，如将数据的 ID 按照 Hash 取模分段，不同的线程处理不同段的数据；</li>
<li><strong>CAS 算法</strong>：Java 的 Atomic 包使用 CAS 算法来更新数据，而不需要加锁；</li>
<li><strong>最少线程</strong>：避免创建不需要的线程，比如任务很少，但是创建了很多线程来处理，这样会造成大量线程都处于等待状态；</li>
<li><strong>使用协程</strong>：在单线程里实现多任务的调度，并在单线程里维持多个任务间的切换；</li>
</ul>
<h2 id="-975"><a class="markdownIt-Anchor" href="#-975">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/trouble-shooting.html#%E4%B8%89%E3%80%81%E5%86%85%E5%AD%98%E9%97%AE%E9%A2%98">#</a>三、内存问题</h2>
<p>内存问题诊断起来相对比 CPU 麻烦一些，场景也比较多。主要包括 OOM、GC 问题和堆外内存。一般来讲，我们会先用  <code>free</code>  命令先来检查一发内存的各种情况。</p>
<p>诊断内存问题，一般首先会用  <code>free</code>  命令查看一下机器的物理内存使用情况。</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ <span class="token function">free</span>
              total        used        <span class="token function">free</span>      shared  buff/cache   available
Mem:        <span class="token number">8011164</span>     <span class="token number">3767900</span>      <span class="token number">735364</span>        <span class="token number">8804</span>     <span class="token number">3507900</span>     <span class="token number">3898568</span>
Swap:       <span class="token number">5242876</span>        <span class="token number">6836</span>     <span class="token number">5236040</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="-976"><a class="markdownIt-Anchor" href="#-976">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/trouble-shooting.html#%E5%9B%9B%E3%80%81%E7%A3%81%E7%9B%98%E9%97%AE%E9%A2%98">#</a>四、磁盘问题</h2>
<h3 id="-977"><a class="markdownIt-Anchor" href="#-977">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/trouble-shooting.html#%E6%9F%A5%E7%9C%8B%E7%A3%81%E7%9B%98%E7%A9%BA%E9%97%B4%E4%BD%BF%E7%94%A8%E7%8E%87">#</a>查看磁盘空间使用率</h3>
<p>可以使用  <code>df -hl</code>  命令查看磁盘空间使用率。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">$ df -hl
Filesystem      Size  Used Avail Use% Mounted on
devtmpfs        494M     0  494M   0% /dev
tmpfs           504M     0  504M   0% /dev/shm
tmpfs           504M   58M  447M  12% /run
tmpfs           504M     0  504M   0% /sys/fs/cgroup
/dev/sda2        20G  5.7G   13G  31% /
/dev/sda1       380M  142M  218M  40% /boot
tmpfs           101M     0  101M   0% /run/user/0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-978"><a class="markdownIt-Anchor" href="#-978">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/trouble-shooting.html#%E6%9F%A5%E7%9C%8B%E7%A3%81%E7%9B%98%E8%AF%BB%E5%86%99%E6%80%A7%E8%83%BD">#</a>查看磁盘读写性能</h3>
<p>可以使用  <code>iostat</code>  命令查看磁盘读写性能。</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">iostat -d -k -x
Linux 3.10.0-327.el7.x86_64 (elk-server)        03/07/2020      _x86_64_        (4 CPU)

Device:         rrqm/s   wrqm/s     r/s     w/s    rkB/s    wkB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util
sda               0.00     0.14    0.01    1.63     0.42   157.56   193.02     0.00    2.52   11.43    2.48   0.60   0.10
scd0              0.00     0.00    0.00    0.00     0.00     0.00     8.00     0.00    0.27    0.27    0.00   0.27   0.00
dm-0              0.00     0.00    0.01    1.78     0.41   157.56   177.19     0.00    2.46   12.09    2.42   0.59   0.10
dm-1              0.00     0.00    0.00    0.00     0.00     0.00    16.95     0.00    1.04    1.04    0.00   1.02   0.00<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-979"><a class="markdownIt-Anchor" href="#-979">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/trouble-shooting.html#%E6%9F%A5%E7%9C%8B%E5%85%B7%E4%BD%93%E7%9A%84%E6%96%87%E4%BB%B6%E8%AF%BB%E5%86%99%E6%83%85%E5%86%B5">#</a>查看具体的文件读写情况</h3>
<p>可以使用  <code>lsof -p pid</code>  命令</p>
<h2 id="-980"><a class="markdownIt-Anchor" href="#-980">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/trouble-shooting.html#%E4%BA%94%E3%80%81%E7%BD%91%E7%BB%9C%E9%97%AE%E9%A2%98">#</a>五、网络问题</h2>
<h3 id="-981"><a class="markdownIt-Anchor" href="#-981">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/trouble-shooting.html#%E6%97%A0%E6%B3%95%E8%BF%9E%E6%8E%A5">#</a>无法连接</h3>
<p>可以通过  <code>ping</code>  命令，查看是否能连通。</p>
<p>通过  <code>netstat -nlp | grep &lt;port&gt;</code>  命令，查看服务端口是否在工作。</p>
<h3 id="-982"><a class="markdownIt-Anchor" href="#-982">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/trouble-shooting.html#%E7%BD%91%E7%BB%9C%E8%B6%85%E6%97%B6">#</a>网络超时</h3>
<p>网络超时问题大部分出在应用层面。超时大体可以分为连接超时和读写超时，某些使用连接池的客户端框架还会存在获取连接超时和空闲连接清理超时。</p>
<ul>
<li>读写超时。readTimeout/writeTimeout，有些框架叫做 so_timeout 或者 socketTimeout，均指的是数据读写超时。注意这边的超时大部分是指逻辑上的超时。soa 的超时指的也是读超时。读写超时一般都只针对客户端设置。</li>
<li>连接超时。connectionTimeout，客户端通常指与服务端建立连接的最大时间。服务端这边 connectionTimeout 就有些五花八门了，jetty 中表示空闲连接清理时间，tomcat 则表示连接维持的最大时间。</li>
<li>其他。包括连接获取超时 connectionAcquireTimeout 和空闲连接清理超时 idleConnectionTimeout。多用于使用连接池或队列的客户端或服务端框架。</li>
</ul>
<p>我们在设置各种超时时间中，需要确认的是尽量保持客户端的超时小于服务端的超时，以保证连接正常结束。</p>
<p>在实际开发中，我们关心最多的应该是接口的读写超时了。</p>
<p>如何设置合理的接口超时是一个问题。如果接口超时设置的过长，那么有可能会过多地占用服务端的 tcp 连接。而如果接口设置的过短，那么接口超时就会非常频繁。</p>
<p>服务端接口明明 rt 降低，但客户端仍然一直超时又是另一个问题。这个问题其实很简单，客户端到服务端的链路包括网络传输、排队以及服务处理等，每一个环节都可能是耗时的原因。</p>
<h3 id="-983"><a class="markdownIt-Anchor" href="#-983">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/trouble-shooting.html#tcp-%E9%98%9F%E5%88%97%E6%BA%A2%E5%87%BA">#</a>TCP 队列溢出</h3>
<p>tcp 队列溢出是个相对底层的错误，它可能会造成超时、rst 等更表层的错误。因此错误也更隐蔽，所以我们单独说一说。 <img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/2019-11-04-083827.jpg" alt="img"></p>
<p>如上图所示，这里有两个队列：syns queue (半连接队列）、accept queue（全连接队列）。三次握手，在 server 收到 client 的 syn 后，把消息放到 syns queue，回复 syn+ack 给 client，server 收到 client 的 ack，如果这时 accept queue 没满，那就从 syns queue 拿出暂存的信息放入 accept queue 中，否则按 tcp_abort_on_overflow 指示的执行。</p>
<p>tcp_abort_on_overflow 0 表示如果三次握手第三步的时候 accept queue 满了那么 server 扔掉 client 发过来的 ack。tcp_abort_on_overflow 1 则表示第三步的时候如果全连接队列满了，server 发送一个 rst 包给 client，表示废掉这个握手过程和这个连接，意味着日志里可能会有很多 <code>connection reset / connection reset by peer</code> 。</p>
<p>那么在实际开发中，我们怎么能快速定位到 tcp 队列溢出呢？</p>
<p><strong>netstat 命令，执行 netstat -s | egrep “listen|LISTEN”</strong> <img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/2019-11-04-83828.jpg" alt="img"> 如上图所示，overflowed 表示全连接队列溢出的次数，sockets dropped 表示半连接队列溢出的次数。</p>
<p><strong>ss 命令，执行 ss -lnt</strong> <img src="https://fredal-blog.oss-cn-hangzhou.aliyuncs.com/2019-11-04-083828.jpg" alt="img"> 上面看到 Send-Q 表示第三列的 listen 端口上的全连接队列最大为 5，第一列 Recv-Q 为全连接队列当前使用了多少。</p>
<p>接着我们看看怎么设置全连接、半连接队列大小吧：</p>
<p>全连接队列的大小取决于 min (backlog, somaxconn)。backlog 是在 socket 创建的时候传入的，somaxconn 是一个 os 级别的系统参数。而半连接队列的大小取决于 max (64, /proc/sys/net/ipv4/tcp_max_syn_backlog)。</p>
<p>在日常开发中，我们往往使用 servlet 容器作为服务端，所以我们有时候也需要关注容器的连接队列大小。在 tomcat 中 backlog 叫做 <code>acceptCount</code> ，在 jetty 里面则是 <code>acceptQueueSize</code> 。</p>
<h3 id="-984"><a class="markdownIt-Anchor" href="#-984">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/trouble-shooting.html#rst-%E5%BC%82%E5%B8%B8">#</a>RST 异常</h3>
<p>RST 包表示连接重置，用于关闭一些无用的连接，通常表示异常关闭，区别于四次挥手。</p>
<p>在实际开发中，我们往往会看到 <code>connection reset / connection reset by peer</code>  错误，这种情况就是 RST 包导致的。</p>
<p><strong>端口不存在</strong></p>
<p>如果像不存在的端口发出建立连接 SYN 请求，那么服务端发现自己并没有这个端口则会直接返回一个 RST 报文，用于中断连接。</p>
<p><strong>主动代替 FIN 终止连接</strong></p>
<p>一般来说，正常的连接关闭都是需要通过 FIN 报文实现，然而我们也可以用 RST 报文来代替 FIN，表示直接终止连接。实际开发中，可设置 SO_LINGER 数值来控制，这种往往是故意的，来跳过 TIMED_WAIT，提供交互效率，不闲就慎用。</p>
<p><strong>客户端或服务端有一边发生了异常，该方向对端发送 RST 以告知关闭连接</strong></p>
<p>我们上面讲的 tcp 队列溢出发送 RST 包其实也是属于这一种。这种往往是由于某些原因，一方无法再能正常处理请求连接了 (比如程序崩了，队列满了)，从而告知另一方关闭连接。</p>
<p><strong>接收到的 TCP 报文不在已知的 TCP 连接内</strong></p>
<p>比如，一方机器由于网络实在太差 TCP 报文失踪了，另一方关闭了该连接，然后过了许久收到了之前失踪的 TCP 报文，但由于对应的 TCP 连接已不存在，那么会直接发一个 RST 包以便开启新的连接。</p>
<p><strong>一方长期未收到另一方的确认报文，在一定时间或重传次数后发出 RST 报文</strong></p>
<p>这种大多也和网络环境相关了，网络环境差可能会导致更多的 RST 报文。</p>
<p>之前说过 RST 报文多会导致程序报错，在一个已关闭的连接上读操作会报 <code>connection reset</code> ，而在一个已关闭的连接上写操作则会报 <code>connection reset by peer</code> 。通常我们可能还会看到 <code>broken pipe</code>  错误，这是管道层面的错误，表示对已关闭的管道进行读写，往往是在收到 RST，报出 <code>connection reset</code>  错后继续读写数据报的错，这个在 glibc 源码注释中也有介绍。</p>
<p>我们在诊断故障时候怎么确定有 RST 包的存在呢？当然是使用 tcpdump 命令进行抓包，并使用 wireshark 进行简单分析了。 <code>tcpdump -i en0 tcp -w xxx.cap</code> ，en0 表示监听的网卡。 <img src="https://fredal-blog.oss-cn-hangzhou.aliyuncs.com/2019-11-04-083829.jpg" alt="img"></p>
<p>接下来我们通过 wireshark 打开抓到的包，可能就能看到如下图所示，红色的就表示 RST 包了。 <img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/2019-11-04-083830.jpg" alt="img"></p>
<h3 id="-985"><a class="markdownIt-Anchor" href="#-985">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/trouble-shooting.html#time-wait-%E5%92%8C-close-wait">#</a>TIME_WAIT 和 CLOSE_WAIT</h3>
<p>TIME_WAIT 和 CLOSE_WAIT 是啥意思相信大家都知道。 在线上时，我们可以直接用命令 <code>netstat -n | awk '/^tcp/ &#123;++S[$NF]&#125; END &#123;for(a in S) print a, S[a]&#125;'</code>  来查看 time-wait 和 close_wait 的数量</p>
<p>用 ss 命令会更快 <code>ss -ant | awk '&#123;++S[$1]&#125; END &#123;for(a in S) print a, S[a]&#125;'</code></p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/2019-11-04-083830.png" alt="img"></p>
<h4 id="-986"><a class="markdownIt-Anchor" href="#-986">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/trouble-shooting.html#time-wait">#</a>TIME_WAIT</h4>
<p>time_wait 的存在一是为了丢失的数据包被后面连接复用，二是为了在 2MSL 的时间范围内正常关闭连接。它的存在其实会大大减少 RST 包的出现。</p>
<p>过多的 time_wait 在短连接频繁的场景比较容易出现。这种情况可以在服务端做一些内核参数调优:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">#表示开启重用。允许将TIME<span class="token operator">-</span>WAIT sockets重新用于新的TCP连接，默认为<span class="token number">0</span>，表示关闭
net<span class="token punctuation">.</span>ipv4<span class="token punctuation">.</span>tcp_tw_reuse <span class="token operator">=</span> <span class="token number">1</span>
#表示开启TCP连接中TIME<span class="token operator">-</span>WAIT sockets的快速回收，默认为<span class="token number">0</span>，表示关闭
net<span class="token punctuation">.</span>ipv4<span class="token punctuation">.</span>tcp_tw_recycle <span class="token operator">=</span> <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>当然我们不要忘记在 NAT 环境下因为时间戳错乱导致数据包被拒绝的坑了，另外的办法就是改小 <code>tcp_max_tw_buckets</code> ，超过这个数的 time_wait 都会被干掉，不过这也会导致报 <code>time wait bucket table overflow</code>  的错。</p>
<h4 id="-987"><a class="markdownIt-Anchor" href="#-987">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/trouble-shooting.html#close-wait">#</a>CLOSE_WAIT</h4>
<p>close_wait 往往都是因为应用程序写的有问题，没有在 ACK 后再次发起 FIN 报文。close_wait 出现的概率甚至比 time_wait 要更高，后果也更严重。往往是由于某个地方阻塞住了，没有正常关闭连接，从而渐渐地消耗完所有的线程。</p>
<p>想要定位这类问题，最好是通过 jstack 来分析线程堆栈来诊断问题，具体可参考上述章节。这里仅举一个例子。</p>
<p>开发同学说应用上线后 CLOSE_WAIT 就一直增多，直到挂掉为止，jstack 后找到比较可疑的堆栈是大部分线程都卡在了 <code>countdownlatch.await</code>  方法，找开发同学了解后得知使用了多线程但是确没有 catch 异常，修改后发现异常仅仅是最简单的升级 sdk 后常出现的 <code>class not found</code> 。</p>
<h2 id="-988"><a class="markdownIt-Anchor" href="#-988">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/trouble-shooting.html#%E5%85%AD%E3%80%81gc-%E9%97%AE%E9%A2%98">#</a>六、GC 问题</h2>
<p>GC 问题除了影响 CPU 也会影响内存，诊断思路也是一致的。</p>
<p>（1）通常，先使用  <code>jstat</code>  来查看分代变化情况，比如 <strong>minor gc</strong> 或 <strong>full gc</strong> 次数是不是太频繁、耗时太久。</p>
<p>线程量太大，且不被及时 GC 也会引发 OOM，大部分就是之前说的  <code>unable to create new native thread</code> 。除了 jstack 细细分析 dump 文件外，我们一般先会看下总体线程。</p>
<p>可以执行以下命令中任意一个，没来查看当前进程创建的总线程数。</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">pstreee -p pid <span class="token operator">|</span> <span class="token function">wc</span> -l
<span class="token function">ls</span> -l /proc/pid/task <span class="token operator">|</span> <span class="token function">wc</span> -l<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>堆内内存泄漏总是和 GC 异常相伴。不过 GC 问题不只是和内存问题相关，还有可能引起 CPU 负载、网络问题等系列并发症，只是相对来说和内存联系紧密些，所以我们在此单独总结一下 GC 相关问题。</p>
<p>我们在 cpu 章介绍了使用 jstat 来获取当前 GC 分代变化信息。而更多时候，我们是通过 GC 日志来诊断问题的，在启动参数中加上 <code>-verbose:gc -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+PrintGCTimeStamps</code>  来开启 GC 日志。 常见的 Minor GC、Full GC 日志含义在此就不做赘述了。</p>
<p>针对 gc 日志，我们就能大致推断出 Minor GC 与 fullGC 是否过于频繁或者耗时过长，从而对症下药。我们下面将对 G1 垃圾收集器来做分析，这边也建议大家使用 G1 <code>-XX:+UseG1GC</code> 。</p>
<h3 id="-989"><a class="markdownIt-Anchor" href="#-989">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/trouble-shooting.html#oom">#</a>OOM</h3>
<p>查看 GC 日志，如果有明显提示 OOM 问题，那就可以根据提示信息，较为快速的定位问题。</p>
<blockquote>
<p>OOM 定位可以参考：<a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/jvm-memory.html#%E4%B8%89OutOfMemoryError">JVM 内存管理 之 OutOfMemoryError</a></p>
</blockquote>
<h3 id="-990"><a class="markdownIt-Anchor" href="#-990">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/trouble-shooting.html#minor-gc">#</a>Minor GC</h3>
<h4 id="-991"><a class="markdownIt-Anchor" href="#-991">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/trouble-shooting.html#minor-gc-%E8%BF%87%E9%A2%91">#</a>Minor GC 过频</h4>
<p><strong>Minor GC 频繁一般是短周期的 Java 小对象较多</strong>。</p>
<p>（1）先考虑是不是 Eden 区 / 新生代设置的太小了，看能否通过调整  <code>-Xmn、-XX:SurvivorRatio</code>  等参数设置来解决问题。</p>
<p>（2）如果参数正常，但是 Minor GC 频率还是太高，就需要使用  <code>jmap</code>  和  <code>MAT</code>  对 dump 文件进行进一步诊断了。</p>
<h4 id="-992"><a class="markdownIt-Anchor" href="#-992">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/trouble-shooting.html#minor-gc-%E8%80%97%E6%97%B6%E8%BF%87%E9%95%BF">#</a>Minor GC 耗时过长</h4>
<p>Minor GC 耗时过长问题就要看 GC 日志里耗时耗在哪一块了。</p>
<p>以 G1 GC 日志为例，可以关注 Root Scanning、Object Copy、Ref Proc 等阶段。Ref Proc 耗时长，就要注意引用相关的对象。Root Scanning 耗时长，就要注意线程数、跨代引用。Object Copy 则需要关注对象生存周期。而且耗时分析它需要横向比较，就是和其他项目或者正常时间段的耗时比较。</p>
<h3 id="-993"><a class="markdownIt-Anchor" href="#-993">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/trouble-shooting.html#full-gc-%E8%BF%87%E9%A2%91">#</a>Full GC 过频</h3>
<p>G1 中更多的还是 mixedGC，但 mixedGC 可以和 Minor GC 思路一样去诊断。触发 fullGC 了一般都会有问题，G1 会退化使用 Serial 收集器来完成垃圾的清理工作，暂停时长达到秒级别，可以说是半跪了。</p>
<p>fullGC 的原因可能包括以下这些，以及参数调整方面的一些思路：</p>
<ul>
<li>并发阶段失败：在并发标记阶段，MixGC 之前老年代就被填满了，那么这时候 G1 就会放弃标记周期。这种情况，可能就需要增加堆大小，或者调整并发标记线程数 <code>-XX:ConcGCThreads</code> 。</li>
<li>晋升失败：在 GC 的时候没有足够的内存供存活 / 晋升对象使用，所以触发了 Full GC。这时候可以通过 <code>-XX:G1ReservePercent</code>  来增加预留内存百分比，减少 <code>-XX:InitiatingHeapOccupancyPercent</code>  来提前启动标记， <code>-XX:ConcGCThreads</code>  来增加标记线程数也是可以的。</li>
<li>大对象分配失败：大对象找不到合适的 region 空间进行分配，就会进行 fullGC，这种情况下可以增大内存或者增大 <code>-XX:G1HeapRegionSize</code> 。</li>
<li>程序主动执行 System.gc ()：不要随便写就对了。</li>
</ul>
<p>另外，我们可以在启动参数中配置 <code>-XX:HeapDumpPath=/xxx/dump.hprof</code>  来 dump fullGC 相关的文件，并通过 jinfo 来进行 gc 前后的 dump</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">jinfo <span class="token operator">-</span>flag <span class="token operator">+</span><span class="token class-name">HeapDumpBeforeFullGC</span> pid
jinfo <span class="token operator">-</span>flag <span class="token operator">+</span><span class="token class-name">HeapDumpAfterFullGC</span> pid<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>这样得到 2 份 dump 文件，对比后主要关注被 gc 掉的问题对象来定位问题。</p>
<h2 id="-994"><a class="markdownIt-Anchor" href="#-994">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/trouble-shooting.html#%E4%B8%83%E3%80%81%E5%B8%B8%E7%94%A8-linux-%E5%91%BD%E4%BB%A4">#</a>七、常用 Linux 命令</h2>
<p>在故障排查时，有一些 Linux 命令十分有用，建议掌握。</p>
<h3 id="-995"><a class="markdownIt-Anchor" href="#-995">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/trouble-shooting.html#top">#</a>top</h3>
<p>top 命令可以实时动态地查看系统的整体运行情况，是一个综合了多方信息监测系统性能和运行信息的实用工具。</p>
<p>通常，会使用  <code>top -Hp pid</code>  查看具体线程使用系统资源情况。</p>
<blockquote>
<p>命令详情参考：<a target="_blank" rel="noopener" href="http://man.linuxde.net/top">http://man.linuxde.net/top</a></p>
</blockquote>
<h3 id="-996"><a class="markdownIt-Anchor" href="#-996">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/jvm/trouble-shooting.html#vmstat">#</a>vmstat</h3>
<p>vmstat 是一款指定采样周期和次数的功能性监测工具，我们可以看到，它不仅可以统计内存的使用情况，还可以观测到 CPU 的使用率、swap 的使用情况。但 vmstat 一般很少用来查看内存的使用情况，而是经常被用来观察进程的上下文切换。</p>
<ul>
<li>r：等待运行的进程数；</li>
<li>b：处于非中断睡眠状态的进程数；</li>
<li>swpd：虚拟内存使用情况；</li>
<li>free：空闲的内存；</li>
<li>buff：用来作为缓冲的内存数；</li>
<li>si：从磁盘交换到内存的交换页数量；</li>
<li>so：从内存交换到磁盘的交换页数量；</li>
<li>bi：发送到块设备的块数；</li>
<li>bo：从块设备接收到的块数；</li>
<li>in：每秒中断数；</li>
<li>cs：每秒上下文切换次数；</li>
<li>us：用户 CPU 使用时间；</li>
<li>sy：内核 CPU 系统使用时间；</li>
<li>id：空闲时间；</li>
<li>wa：等待 I/O 时间；</li>
<li>st：运行虚拟机窃取的时间。</li>
</ul>
<hr>
<h1 id="面试题"><a class="markdownIt-Anchor" href="#面试题">#</a> 面试题</h1>
<h2 id="基础"><a class="markdownIt-Anchor" href="#基础">#</a> 基础</h2>
<h3 id="-997"><a class="markdownIt-Anchor" href="#-997">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#%E5%B7%A5%E5%85%B7%E7%B1%BB">#</a>工具类</h3>
<h4 id="-998"><a class="markdownIt-Anchor" href="#-998">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#string">#</a>String</h4>
<blockquote>
<p>String 类能被继承吗？</p>
<p>String，StringBuffer，StringBuilder 的区别。</p>
</blockquote>
<p>String 类不能被继承。因为其被 final 修饰，所以无法被继承。</p>
<p>StringBuffer，StringBuilder 拼接字符串，使用 append 比 String 效率高。因为 String 会隐式 new String 对象。</p>
<p>StringBuffer 主要方法都用 synchronized 修饰，是线程安全的；而 StringBuilder 不是。</p>
<h3 id="-999"><a class="markdownIt-Anchor" href="#-999">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1">#</a>面向对象</h3>
<blockquote>
<p>抽象类和接口的区别？</p>
<p>类可以继承多个类么？接口可以继承多个接口么？类可以实现多个接口么？</p>
</blockquote>
<p>类只能继承一个类，但是可以实现多个接口。接口可以继承多个接口。</p>
<blockquote>
<p>继承和聚合的区别在哪？</p>
</blockquote>
<p>一般，能用聚合就别用继承。</p>
<h3 id="-1000"><a class="markdownIt-Anchor" href="#-1000">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#%E5%8F%8D%E5%B0%84">#</a>反射</h3>
<h4 id="-1001"><a class="markdownIt-Anchor" href="#-1001">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#%E2%AD%90-%E5%88%9B%E5%BB%BA%E5%AE%9E%E4%BE%8B">#</a>⭐ 创建实例</h4>
<blockquote>
<p>反射创建实例有几种方式？</p>
</blockquote>
<p>通过反射来创建实例对象主要有两种方式：</p>
<ul>
<li>用  <code>Class</code>  对象的  <code>newInstance</code>  方法。</li>
<li>用  <code>Constructor</code>  对象的  <code>newInstance</code>  方法。</li>
</ul>
<h4 id="-1002"><a class="markdownIt-Anchor" href="#-1002">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#%E2%AD%90-%E5%8A%A0%E8%BD%BD%E5%AE%9E%E4%BE%8B">#</a>⭐ 加载实例</h4>
<blockquote>
<p>加载实例有几种方式？</p>
<p>Class.forName (“className”) 和 ClassLoader.laodClass (“className”) 有什么区别？</p>
</blockquote>
<ul>
<li><code>Class.forName(&quot;className&quot;)</code>  加载的是已经初始化到 JVM 中的类。</li>
<li><code>ClassLoader.laodClass(&quot;className&quot;)</code>  装载的是还没有初始化到 JVM 中的类。</li>
</ul>
<h4 id="-1003"><a class="markdownIt-Anchor" href="#-1003">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#%E2%AD%90%E2%AD%90-%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86">#</a>⭐⭐ 动态代理</h4>
<blockquote>
<p>动态代理有几种实现方式？有什么特点？</p>
<p>JDK 动态代理和 CGLIB 动态代理有什么区别？</p>
</blockquote>
<p>（1）JDK 方式</p>
<p>代理类与委托类实现同一接口，主要是通过代理类实现  <code>InvocationHandler</code>  并重写  <code>invoke</code>  方法来进行动态代理的，在  <code>invoke</code>  方法中将对方法进行处理。</p>
<p>JDK 动态代理特点：</p>
<ul>
<li>优点：相对于静态代理模式，不需要硬编码接口，代码复用率高。</li>
<li>缺点：强制要求代理类实现  <code>InvocationHandler</code>  接口。</li>
</ul>
<p>（2）CGLIB</p>
<p>CGLIB 底层，其实是借助了 ASM 这个强大的 Java 字节码框架去进行字节码增强操作。</p>
<p>CGLIB 动态代理特点：</p>
<p>优点：使用字节码增强，比 JDK 动态代理方式性能高。可以在运行时对类或者是接口进行增强操作，且委托类无需实现接口。</p>
<p>缺点：不能对  <code>final</code>  类以及  <code>final</code>  方法进行代理。</p>
<h3 id="-1004"><a class="markdownIt-Anchor" href="#-1004">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#jdk8">#</a>JDK8</h3>
<h3 id="-1005"><a class="markdownIt-Anchor" href="#-1005">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#%E5%85%B6%E4%BB%96">#</a>其他</h3>
<h4 id="-1006"><a class="markdownIt-Anchor" href="#-1006">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#%E2%AD%90-hashcode">#</a>⭐ hashcode</h4>
<blockquote>
<p>有 <code>==</code>  运算符了，为什么还需要 equals 啊？</p>
<p>说一说你对 java.lang.Object 对象中 hashCode 和 equals 方法的理解。在什么场景下需 要重新实现这两个方法。</p>
<p>有没有可能 2 个不相等的对象有相同的 hashcode</p>
</blockquote>
<p>（1）有 <code>==</code>  运算符了，为什么还需要 equals 啊？</p>
<p>equals 等价于 <code>==</code> , 而 <code>==</code>  运算符是判断两个对象是不是同一个对象，即他们的<strong>地址是否相等</strong>。而覆写 equals 更多的是追求两个对象在<strong>逻辑上的相等</strong>，你可以说是<strong>值相等</strong>，也可说是<strong>内容相等</strong>。</p>
<p>（2）说一说你对 java.lang.Object 对象中 hashCode 和 equals 方法的理解。在什么场景下需 要重新实现这两个方法。</p>
<p>在集合查找时，hashcode 能大大降低对象比较次数，提高查找效率！</p>
<p>（3）有没有可能 2 个不相等的对象有相同的 hashcode</p>
<p>有可能。</p>
<ul>
<li>如果两个对象 equals，Java 运行时环境会认为他们的 hashcode 一定相等。</li>
<li>如果两个对象不 equals，他们的 hashcode 有可能相等。</li>
<li>如果两个对象 hashcode 相等，他们不一定 equals。</li>
<li>如果两个对象 hashcode 不相等，他们一定不 equals。</li>
</ul>
<h2 id="-1007"><a class="markdownIt-Anchor" href="#-1007">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#io">#</a>IO</h2>
<h3 id="-1008"><a class="markdownIt-Anchor" href="#-1008">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#nio">#</a>NIO</h3>
<blockquote>
<p>什么是 NIO？</p>
<p>NIO 和 BIO、AIO 有何差别？</p>
</blockquote>
<h3 id="-1009"><a class="markdownIt-Anchor" href="#-1009">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#%E5%BA%8F%E5%88%97%E5%8C%96">#</a>序列化</h3>
<h4 id="-1010"><a class="markdownIt-Anchor" href="#-1010">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#%E2%AD%90-%E5%BA%8F%E5%88%97%E5%8C%96%E9%97%AE%E9%A2%98">#</a>⭐ 序列化问题</h4>
<blockquote>
<p>序列化、反序列化有哪些问题？如何解决？</p>
</blockquote>
<p>Java 的序列化能保证对象状态的持久保存，但是遇到一些对象结构复杂的情况还是难以处理，这里归纳一下：</p>
<ul>
<li>当父类继承  <code>Serializable</code>  接口时，所有子类都可以被序列化。</li>
<li>子类实现了  <code>Serializable</code>  接口，父类没有，则父类的属性不会被序列化（不报错，数据丢失），子类的属性仍可以正确序列化。</li>
<li>如果序列化的属性是对象，则这个对象也必须实现  <code>Serializable</code>  接口，否则会报错。</li>
<li>在反序列化时，如果对象的属性有修改或删减，则修改的部分属性会丢失，但不会报错。</li>
<li>在反序列化时，如果  <code>serialVersionUID</code>  被修改，则反序列化时会失败。</li>
</ul>
<h2 id="-1011"><a class="markdownIt-Anchor" href="#-1011">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#%E5%AE%B9%E5%99%A8">#</a>容器</h2>
<h3 id="-1012"><a class="markdownIt-Anchor" href="#-1012">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#list">#</a>List</h3>
<h4 id="-1013"><a class="markdownIt-Anchor" href="#-1013">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#arraylist-%E5%92%8C-linkedlist-%E6%9C%89%E4%BB%80%E4%B9%88%E5%8C%BA%E5%88%AB">#</a>ArrayList 和 LinkedList 有什么区别？</h4>
<p>ArrayList 是数组链表，访问效率更高。</p>
<p>LinkedList 是双链表，数据有序存储。</p>
<h3 id="-1014"><a class="markdownIt-Anchor" href="#-1014">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#map">#</a>Map</h3>
<p>请描述 HashMap 的实现原理？</p>
<h2 id="-1015"><a class="markdownIt-Anchor" href="#-1015">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#%E5%B9%B6%E5%8F%91">#</a>并发</h2>
<h3 id="-1016"><a class="markdownIt-Anchor" href="#-1016">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B">#</a>并发简介</h3>
<h4 id="-1017"><a class="markdownIt-Anchor" href="#-1017">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#%E4%BB%80%E4%B9%88%E6%98%AF%E8%BF%9B%E7%A8%8B-%E4%BB%80%E4%B9%88%E6%98%AF%E7%BA%BF%E7%A8%8B-%E8%BF%9B%E7%A8%8B%E5%92%8C%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%8C%BA%E5%88%AB">#</a>什么是进程？什么是线程？进程和线程的区别？</h4>
<ul>
<li>什么是进程？
<ul>
<li>简言之，进程可视为一个正在运行的程序。</li>
<li>进程是具有一定独立功能的程序关于某个数据集合上的一次运行活动。进程是操作系统进行资源分配的基本单位。</li>
</ul>
</li>
<li>什么是线程？
<ul>
<li>线程是操作系统进行调度的基本单位。</li>
</ul>
</li>
<li>进程 vs. 线程
<ul>
<li>一个程序至少有一个进程，一个进程至少有一个线程。</li>
<li>线程比进程划分更细，所以执行开销更小，并发性更高。</li>
<li>进程是一个实体，拥有独立的资源；而同一个进程中的多个线程共享进程的资源。</li>
</ul>
</li>
</ul>
<h4 id="-1018"><a class="markdownIt-Anchor" href="#-1018">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#%E5%B9%B6%E5%8F%91-%E5%A4%9A%E7%BA%BF%E7%A8%8B-%E7%BC%96%E7%A8%8B%E7%9A%84%E5%A5%BD%E5%A4%84%E6%98%AF%E4%BB%80%E4%B9%88">#</a>并发（多线程）编程的好处是什么？</h4>
<ul>
<li>更有效率的利用多处理器核心</li>
<li>更快的响应时间</li>
<li>更好的编程模型</li>
</ul>
<h4 id="-1019"><a class="markdownIt-Anchor" href="#-1019">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#%E5%B9%B6%E5%8F%91%E4%B8%80%E5%AE%9A%E6%AF%94%E4%B8%B2%E8%A1%8C%E6%9B%B4%E5%BF%AB%E5%90%97">#</a>并发一定比串行更快吗？</h4>
<p>答：否。</p>
<p>要点：<strong>创建线程和线程上下文切换有一定开销</strong>。</p>
<p>说明：即使是单核处理器也支持多线程。CPU 通过给每个线程分配时间切片的算法来循环执行任务，当前任务执行一个时间片后会切换到下一个任务。但是，在切换前会保持上一个任务的状态，以便下次切换回这个任务时，可以再加载这个任务的状态。所以<strong>任务从保存到再加载的过程就是一次上下文切换</strong>。</p>
<p>引申</p>
<ul>
<li>如何减少上下文切换？
<ul>
<li>尽量少用锁</li>
<li>CAS 算法</li>
<li>线程数要合理</li>
<li>协程：在单线程中实现多任务调度，并在单线程中维持多个任务的切换</li>
</ul>
</li>
</ul>
<h4 id="-1020"><a class="markdownIt-Anchor" href="#-1020">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#%E5%A6%82%E4%BD%95%E8%AE%A9%E6%AD%A3%E5%9C%A8%E8%BF%90%E8%A1%8C%E7%9A%84%E7%BA%BF%E7%A8%8B%E6%9A%82%E5%81%9C%E4%B8%80%E6%AE%B5%E6%97%B6%E9%97%B4">#</a>如何让正在运行的线程暂停一段时间？</h4>
<p>我们可以使用  <code>Thread</code>  类的 Sleep () 方法让线程暂停一段时间。</p>
<p>需要注意的是，这并不会让线程终止，一旦从休眠中唤醒线程，线程的状态将会被改变为 Runnable，并且根据线程调度，它将得到执行。</p>
<h4 id="-1021"><a class="markdownIt-Anchor" href="#-1021">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#%E4%BB%80%E4%B9%88%E6%98%AF%E7%BA%BF%E7%A8%8B%E8%B0%83%E5%BA%A6%E5%99%A8-thread-scheduler-%E5%92%8C%E6%97%B6%E9%97%B4%E5%88%86%E7%89%87-time-slicing">#</a>什么是线程调度器 (Thread Scheduler) 和时间分片 (Time Slicing)？</h4>
<p>线程调度器是一个操作系统服务，它负责为  <code>Runnable</code>  状态的线程分配 CPU 时间。一旦我们创建一个线程并启动它，它的执行便依赖于线程调度器的实现。</p>
<p>时间分片是指将可用的 CPU 时间分配给可用的  <code>Runnable</code>  线程的过程。</p>
<p>分配 CPU 时间可以基于线程优先级或者线程等待的时间。线程调度并不受到 Java 虚拟机控制，所以由应用程序来控制它是更好的选择（也就是说不要让你的程序依赖于线程的优先级）。</p>
<h4 id="-1022"><a class="markdownIt-Anchor" href="#-1022">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#%E5%9C%A8%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%AD-%E4%BB%80%E4%B9%88%E6%98%AF%E4%B8%8A%E4%B8%8B%E6%96%87%E5%88%87%E6%8D%A2-context-switching">#</a>在多线程中，什么是上下文切换 (context-switching)？</h4>
<p>上下文切换是存储和恢复 CPU 状态的过程，它使得线程执行能够从中断点恢复执行。上下文切换是多任务操作系统和多线程环境的基本特征。</p>
<h4 id="-1023"><a class="markdownIt-Anchor" href="#-1023">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#%E5%A6%82%E4%BD%95%E7%A1%AE%E4%BF%9D%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8">#</a>如何确保线程安全？</h4>
<ul>
<li>原子类 (atomic concurrent classes)</li>
<li>锁</li>
<li><code>volatile</code>  关键字</li>
<li>不变类和线程安全类</li>
</ul>
<h4 id="-1024"><a class="markdownIt-Anchor" href="#-1024">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#%E4%BB%80%E4%B9%88%E6%98%AF%E6%AD%BB%E9%94%81-deadlock-%E5%A6%82%E4%BD%95%E5%88%86%E6%9E%90%E5%92%8C%E9%81%BF%E5%85%8D%E6%AD%BB%E9%94%81">#</a>什么是死锁 (Deadlock)？如何分析和避免死锁？</h4>
<p>死锁是指两个以上的线程永远相互阻塞的情况，这种情况产生至少需要两个以上的线程和两个以上的资源。</p>
<p>分析死锁，我们需要查看 Java 应用程序的线程转储。我们需要找出那些状态为 BLOCKED 的线程和他们等待的资源。每个资源都有一个唯一的 id，用这个 id 我们可以找出哪些线程已经拥有了它的对象锁。</p>
<p>避免嵌套锁，只在需要的地方使用锁和避免无限期等待是避免死锁的通常办法。</p>
<h3 id="-1025"><a class="markdownIt-Anchor" href="#-1025">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80">#</a>线程基础</h3>
<h4 id="-1026"><a class="markdownIt-Anchor" href="#-1026">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#java-%E7%BA%BF%E7%A8%8B%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E4%B8%AD%E6%9C%89%E5%93%AA%E4%BA%9B%E7%8A%B6%E6%80%81-%E5%90%84%E7%8A%B6%E6%80%81%E4%B9%8B%E9%97%B4%E5%A6%82%E4%BD%95%E5%88%87%E6%8D%A2">#</a>Java 线程生命周期中有哪些状态？各状态之间如何切换？</h4>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/cs/java/javacore/concurrent/java-thread_1.png" alt="img"></p>
<p><code>java.lang.Thread.State</code>  中定义了 <strong>6</strong> 种不同的线程状态，在给定的一个时刻，线程只能处于其中的一个状态。</p>
<p>以下是各状态的说明，以及状态间的联系：</p>
<ul>
<li>
<p><strong>开始（New）</strong> - 还没有调用  <code>start()</code>  方法的线程处于此状态。</p>
</li>
<li>
<p><strong>可运行（Runnable）</strong> - 已经调用了  <code>start()</code>  方法的线程状态。此状态意味着，线程已经准备好了，一旦被线程调度器分配了 CPU 时间片，就可以运行线程。</p>
</li>
<li>
<p><strong>阻塞（Blocked）</strong> - 阻塞状态。线程阻塞的线程状态等待监视器锁定。处于阻塞状态的线程正在等待监视器锁定，以便在调用  <code>Object.wait()</code>  之后输入同步块 / 方法或重新输入同步块 / 方法。</p>
</li>
<li>
<p>等待（Waiting）</p>
</li>
</ul>
<p>​</p>
<pre><code>\- 等待状态。一个线程处于等待状态，是由于执行了 3 个方法中的任意方法：

- `Object.wait()`
- `Thread.join()`
- `LockSupport.park()`
</code></pre>
<ul>
<li>定时等待（Timed waiting）</li>
</ul>
<p>​</p>
<pre><code>\- 等待指定时间的状态。一个线程处于定时等待状态，是由于执行了以下方法中的任意方法：

- `Thread.sleep(sleeptime)`
- `Object.wait(timeout)`
- `Thread.join(timeout)`
- `LockSupport.parkNanos(timeout)`
- `LockSupport.parkUntil(timeout)`
</code></pre>
<ul>
<li><strong>终止 (Terminated)</strong> - 线程  <code>run()</code>  方法执行结束，或者因异常退出了  <code>run()</code>  方法，则该线程结束生命周期。死亡的线程不可再次复生。</li>
</ul>
<blockquote>
<p>👉 参考阅读：<a target="_blank" rel="noopener" href="https://www.w3resource.com/java-tutorial/java-threadclass-methods-and-threadstates.php">Java <code>Thread</code>  Methods and  <code>Thread</code>  States (opens new window)</a>👉 参考阅读：<a target="_blank" rel="noopener" href="https://blog.csdn.net/pange1991/article/details/53860651">Java 线程的 5 种状态及切换 (透彻讲解)(opens new window)</a></p>
</blockquote>
<h4 id="-1027"><a class="markdownIt-Anchor" href="#-1027">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#%E5%88%9B%E5%BB%BA%E7%BA%BF%E7%A8%8B%E6%9C%89%E5%93%AA%E4%BA%9B%E6%96%B9%E5%BC%8F-%E8%BF%99%E4%BA%9B%E6%96%B9%E6%B3%95%E5%90%84%E8%87%AA%E5%88%A9%E5%BC%8A%E6%98%AF%E4%BB%80%E4%B9%88">#</a>创建线程有哪些方式？这些方法各自利弊是什么？</h4>
<p>创建线程主要有三种方式：</p>
<p><strong>1. 继承  <code>Thread</code>  类</strong></p>
<ul>
<li>定义  <code>Thread</code>  类的子类，并重写该类的  <code>run()</code>  方法，该  <code>run()</code>  方法的方法体就代表了线程要完成的任务。因此把  <code>run()</code>  方法称为执行体。</li>
<li>创建  <code>Thread</code>  子类的实例，即创建了线程对象。</li>
<li>调用线程对象的  <code>start()</code>  方法来启动该线程。</li>
</ul>
<p><strong>2. 实现  <code>Runnable</code>  接口</strong></p>
<ul>
<li>定义  <code>Runnable</code>  接口的实现类，并重写该接口的  <code>run()</code>  方法，该  <code>run()</code>  方法的方法体同样是该线程的线程执行体。</li>
<li>创建  <code>Runnable</code>  实现类的实例，并以此实例作为  <code>Thread</code>  对象，该  <code>Thread</code>  对象才是真正的线程对象。</li>
<li>调用线程对象的 start () 方法来启动该线程。</li>
</ul>
<p><strong>3. 通过  <code>Callable</code>  接口和  <code>Future</code>  接口</strong></p>
<ul>
<li>创建  <code>Callable</code>  接口的实现类，并实现  <code>call()</code>  方法，该  <code>call()</code>  方法将作为线程执行体，并且有返回值。</li>
<li>创建  <code>Callable</code>  实现类的实例，使用  <code>FutureTask</code>  类来包装  <code>Callable</code>  对象，该  <code>FutureTask</code>  对象封装了该  <code>Callable</code>  对象的  <code>call()</code>  方法的返回值。</li>
<li>使用  <code>FutureTask</code>  对象作为  <code>Thread</code>  对象的 target 创建并启动新线程。</li>
<li>调用  <code>FutureTask</code>  对象的  <code>get()</code>  方法来获得子线程执行结束后的返回值</li>
</ul>
<p>三种创建线程方式对比</p>
<ul>
<li>实现  <code>Runnable</code>  接口优于继承  <code>Thread</code>  类，因为根据开放封闭原则 —— 实现接口更便于扩展；</li>
<li>实现  <code>Runnable</code>  接口的线程没有返回值；而使用  <code>Callable</code>  /  <code>Future</code>  方式可以让线程有返回值。</li>
</ul>
<blockquote>
<p>👉 参考阅读：<a target="_blank" rel="noopener" href="https://blog.csdn.net/longshengguoji/article/details/41126119">Java 创建线程的三种方式及其对比 (opens new window)</a></p>
</blockquote>
<h4 id="-1028"><a class="markdownIt-Anchor" href="#-1028">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#%E4%BB%80%E4%B9%88%E6%98%AF-callable-%E5%92%8C-future-%E4%BB%80%E4%B9%88%E6%98%AF-futuretask">#</a>什么是  <code>Callable</code>  和  <code>Future</code> ？什么是  <code>FutureTask</code> ？</h4>
<p><strong>什么是  <code>Callable</code>  和  <code>Future</code> ？</strong></p>
<p>Java 5 在 concurrency 包中引入了  <code>Callable</code>  接口，它和  <code>Runnable</code>  接口很相似，但它可以返回一个对象或者抛出一个异常。</p>
<p><code>Callable</code>  接口使用泛型去定义它的返回类型。 <code>Executors</code>  类提供了一些有用的方法去在线程池中执行  <code>Callable</code>  内的任务。由于  <code>Callable</code>  任务是并行的，我们必须等待它返回的结果。 <code>Future</code>  对象为我们解决了这个问题。在线程池提交  <code>Callable</code>  任务后返回了一个  <code>Future</code>  对象，使用它我们可以知道  <code>Callable</code>  任务的状态和得到  <code>Callable</code>  返回的执行结果。 <code>Future</code>  提供了  <code>get()</code>  方法让我们可以等待  <code>Callable</code>  结束并获取它的执行结果。</p>
<p><strong>什么是  <code>FutureTask</code> ？</strong></p>
<p><code>FutureTask</code>  是  <code>Future</code>  的一个基础实现，我们可以将它同  <code>Executors</code>  使用处理异步任务。通常我们不需要使用  <code>FutureTask</code>  类，单当我们打算重写  <code>Future</code>  接口的一些方法并保持原来基础的实现是，它就变得非常有用。我们可以仅仅继承于它并重写我们需要的方法。阅读 Java  <code>FutureTask</code>  例子，学习如何使用它。</p>
<blockquote>
<p>👉 参考阅读：<a target="_blank" rel="noopener" href="http://www.cnblogs.com/dolphin0520/p/3949310.html">Java 并发编程：Callable、Future 和 FutureTask (opens new window)</a></p>
</blockquote>
<h4 id="-1029"><a class="markdownIt-Anchor" href="#-1029">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#start-%E5%92%8C-run-%E6%9C%89%E4%BB%80%E4%B9%88%E5%8C%BA%E5%88%AB-%E5%8F%AF%E4%BB%A5%E7%9B%B4%E6%8E%A5%E8%B0%83%E7%94%A8-thread-%E7%B1%BB%E7%9A%84-run-%E6%96%B9%E6%B3%95%E4%B9%88">#</a> <code>start()</code>  和  <code>run()</code>  有什么区别？可以直接调用  <code>Thread</code>  类的  <code>run()</code>  方法么？</h4>
<ul>
<li><code>run()</code>  方法是线程的执行体。</li>
<li><code>start()</code>  方法负责启动线程，然后 JVM 会让这个线程去执行  <code>run()</code>  方法。</li>
</ul>
<p>可以直接调用  <code>Thread</code>  类的  <code>run()</code>  方法么？</p>
<ul>
<li>可以。但是如果直接调用  <code>Thread</code>  的  <code>run()</code>  方法，它的行为就会和普通的方法一样。</li>
<li>为了在新的线程中执行我们的代码，必须使用  <code>start()</code>  方法。</li>
</ul>
<h4 id="-1030"><a class="markdownIt-Anchor" href="#-1030">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#sleep-%E3%80%81yield-%E3%80%81join-%E6%96%B9%E6%B3%95%E6%9C%89%E4%BB%80%E4%B9%88%E5%8C%BA%E5%88%AB-%E4%B8%BA%E4%BB%80%E4%B9%88-sleep-%E5%92%8C-yield-%E6%96%B9%E6%B3%95%E6%98%AF%E9%9D%99%E6%80%81-static-%E7%9A%84">#</a> <code>sleep()</code> 、 <code>yield()</code> 、 <code>join()</code>  方法有什么区别？为什么  <code>sleep()</code>  和  <code>yield()</code>  方法是静态（static）的？</h4>
<p><strong> <code>yield()</code> </strong></p>
<ul>
<li><code>yield()</code>  方法可以让当前正在执行的线程暂停，但它不会阻塞该线程，它只是将该线程从 <strong>Running</strong> 状态转入  <code>Runnable</code>  状态。</li>
<li>当某个线程调用了  <code>yield()</code>  方法暂停之后，只有优先级与当前线程相同，或者优先级比当前线程更高的处于就绪状态的线程才会获得执行的机会。</li>
</ul>
<p><strong> <code>sleep()</code> </strong></p>
<ul>
<li><code>sleep()</code>  方法需要指定等待的时间，它可以让当前正在执行的线程在指定的时间内暂停执行，进入 <strong>Blocked</strong> 状态。</li>
<li>该方法既可以让其他同优先级或者高优先级的线程得到执行的机会，也可以让低优先级的线程得到执行机会。</li>
<li>但是， <code>sleep()</code>  方法不会释放 “锁标志”，也就是说如果有  <code>synchronized</code>  同步块，其他线程仍然不能访问共享数据。</li>
</ul>
<p><strong> <code>join()</code> </strong></p>
<ul>
<li><code>join()</code>  方法会使当前线程转入 <strong>Blocked</strong> 状态，等待调用  <code>join()</code>  方法的线程结束后才能继续执行。</li>
</ul>
<p><strong>为什么  <code>sleep()</code>  和  <code>yield()</code>  方法是静态（static）的？</strong></p>
<ul>
<li><code>Thread</code>  类的  <code>sleep()</code>  和  <code>yield()</code>  方法将处理 <strong>Running</strong> 状态的线程。所以在其他处于非 <strong>Running</strong> 状态的线程上执行这两个方法是没有意义的。这就是为什么这些方法是静态的。它们可以在当前正在执行的线程中工作，并避免程序员错误的认为可以在其他非运行线程调用这些方法。</li>
</ul>
<blockquote>
<p>👉 参考阅读：<a target="_blank" rel="noopener" href="http://www.importnew.com/14958.html">Java 线程中 yield 与 join 方法的区别 (opens new window)</a>👉 参考阅读：<a target="_blank" rel="noopener" href="https://blog.csdn.net/xiangwanpeng/article/details/54972952">sleep ()，wait ()，yield () 和 join () 方法的区别 (opens new window)</a></p>
</blockquote>
<h4 id="-1031"><a class="markdownIt-Anchor" href="#-1031">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#java-%E7%9A%84%E7%BA%BF%E7%A8%8B%E4%BC%98%E5%85%88%E7%BA%A7%E5%A6%82%E4%BD%95%E6%8E%A7%E5%88%B6-%E9%AB%98%E4%BC%98%E5%85%88%E7%BA%A7%E7%9A%84-java-%E7%BA%BF%E7%A8%8B%E4%B8%80%E5%AE%9A%E5%85%88%E6%89%A7%E8%A1%8C%E5%90%97">#</a>Java 的线程优先级如何控制？高优先级的 Java 线程一定先执行吗？</h4>
<p><strong>Java 中的线程优先级如何控制</strong></p>
<ul>
<li>Java 中的线程优先级的范围是  <code>[1,10]</code> ，一般来说，高优先级的线程在运行时会具有优先权。可以通过  <code>thread.setPriority(Thread.MAX_PRIORITY)</code>  的方式设置，默认优先级为  <code>5</code> 。</li>
</ul>
<p><strong>高优先级的 Java 线程一定先执行吗</strong></p>
<ul>
<li>即使设置了线程的优先级，也<strong>无法保证高优先级的线程一定先执行</strong>。</li>
<li>原因：这是因为 <strong>Java 线程优先级依赖于操作系统的支持</strong>，然而，不同的操作系统支持的线程优先级并不相同，不能很好的和 Java 中线程优先级一一对应。</li>
<li>结论：Java 线程优先级控制并不可靠。</li>
</ul>
<h4 id="-1032"><a class="markdownIt-Anchor" href="#-1032">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#%E4%BB%80%E4%B9%88%E6%98%AF%E5%AE%88%E6%8A%A4%E7%BA%BF%E7%A8%8B-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E7%94%A8%E5%AE%88%E6%8A%A4%E7%BA%BF%E7%A8%8B-%E5%A6%82%E4%BD%95%E5%88%9B%E5%BB%BA%E5%AE%88%E6%8A%A4%E7%BA%BF%E7%A8%8B">#</a>什么是守护线程？为什么要用守护线程？如何创建守护线程？</h4>
<p><strong>什么是守护线程</strong></p>
<ul>
<li>守护线程（Daemon Thread）是在后台执行并且不会阻止 JVM 终止的线程。</li>
<li>与守护线程（Daemon Thread）相反的，叫用户线程（User Thread），也就是非守护线程。</li>
</ul>
<p><strong>为什么要用守护线程</strong></p>
<ul>
<li>守护线程的优先级比较低，用于为系统中的其它对象和线程提供服务。典型的应用就是垃圾回收器。</li>
</ul>
<p><strong>如何创建守护线程</strong></p>
<ul>
<li>使用  <code>thread.setDaemon(true)</code>  可以设置 thread 线程为守护线程。</li>
<li>注意点：
<ul>
<li>正在运行的用户线程无法设置为守护线程，所以  <code>thread.setDaemon(true)</code>  必须在  <code>thread.start()</code>  之前设置，否则会抛出  <code>llegalThreadStateException</code>  异常；</li>
<li>一个守护线程创建的子线程依然是守护线程。</li>
<li>不要认为所有的应用都可以分配给守护线程来进行服务，比如读写操作或者计算逻辑。</li>
</ul>
</li>
</ul>
<blockquote>
<p>👉 参考阅读：<a target="_blank" rel="noopener" href="https://blog.csdn.net/shimiso/article/details/8964414">Java 中守护线程的总结 (opens new window)</a></p>
</blockquote>
<h4 id="-1033"><a class="markdownIt-Anchor" href="#-1033">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#%E7%BA%BF%E7%A8%8B%E9%97%B4%E6%98%AF%E5%A6%82%E4%BD%95%E9%80%9A%E4%BF%A1%E7%9A%84">#</a>线程间是如何通信的？</h4>
<p>当线程间是可以共享资源时，线程间通信是协调它们的重要的手段。 <code>Object</code>  类中  <code>wait()</code> ,  <code>notify()</code>  和  <code>notifyAll()</code>  方法可以用于线程间通信关于资源的锁的状态。</p>
<blockquote>
<p>👉 参考阅读：<a target="_blank" rel="noopener" href="http://www.cnblogs.com/dolphin0520/p/3920385.html">Java 并发编程：线程间协作的两种方式：wait、notify、notifyAll 和 Condition (opens new window)</a></p>
</blockquote>
<h4 id="-1034"><a class="markdownIt-Anchor" href="#-1034">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#%E4%B8%BA%E4%BB%80%E4%B9%88%E7%BA%BF%E7%A8%8B%E9%80%9A%E4%BF%A1%E7%9A%84%E6%96%B9%E6%B3%95-wait-notify-%E5%92%8C-notifyall-%E8%A2%AB%E5%AE%9A%E4%B9%89%E5%9C%A8-object-%E7%B1%BB%E9%87%8C">#</a>为什么线程通信的方法  <code>wait()</code> ,  <code>notify()</code>  和  <code>notifyAll()</code>  被定义在 Object 类里？</h4>
<p>Java 的每个对象中都有一个锁 (monitor，也可以成为监视器) 并且  <code>wait()</code> 、 <code>notify()</code>  等方法用于等待对象的锁或者通知其他线程对象的监视器可用。在 Java 的线程中并没有可供任何对象使用的锁和同步器。这就是为什么这些方法是 Object 类的一部分，这样 Java 的每一个类都有用于线程间通信的基本方法</p>
<h4 id="-1035"><a class="markdownIt-Anchor" href="#-1035">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#%E4%B8%BA%E4%BB%80%E4%B9%88-wait-notify-%E5%92%8C-notifyall-%E5%BF%85%E9%A1%BB%E5%9C%A8%E5%90%8C%E6%AD%A5%E6%96%B9%E6%B3%95%E6%88%96%E8%80%85%E5%90%8C%E6%AD%A5%E5%9D%97%E4%B8%AD%E8%A2%AB%E8%B0%83%E7%94%A8">#</a>为什么  <code>wait()</code> ,  <code>notify()</code>  和  <code>notifyAll()</code>  必须在同步方法或者同步块中被调用？</h4>
<p>当一个线程需要调用对象的  <code>wait()</code>  方法的时候，这个线程必须拥有该对象的锁，接着它就会释放这个对象锁并进入等待状态直到其他线程调用这个对象上的  <code>notify()</code>  方法。同样的，当一个线程需要调用对象的  <code>notify()</code>  方法时，它会释放这个对象的锁，以便其他在等待的线程就可以得到这个对象锁。</p>
<p>由于所有的这些方法都需要线程持有对象的锁，这样就只能通过同步来实现，所以他们只能在同步方法或者同步块中被调用。</p>
<h3 id="-1036"><a class="markdownIt-Anchor" href="#-1036">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#%E5%B9%B6%E5%8F%91%E6%9C%BA%E5%88%B6%E7%9A%84%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0">#</a>并发机制的底层实现</h3>
<blockquote>
<p>👉 参考阅读：<a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/blob/master/docs/concurrent/Java%E5%B9%B6%E5%8F%91%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6.md">Java 并发核心机制 (opens new window)</a></p>
</blockquote>
<h4 id="-1037"><a class="markdownIt-Anchor" href="#-1037">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#%E2%AD%90%E2%AD%90%E2%AD%90-synchronized">#</a>⭐⭐⭐  <code>synchronized</code></h4>
<blockquote>
<p><code>synchronized</code>  有什么作用？</p>
<p><code>synchronized</code>  的原理是什么？</p>
<p>同步方法和同步块，哪个更好？</p>
<p>JDK1.6 对 <code>synchronized</code>  做了哪些优化？</p>
<p>使用  <code>synchronized</code>  修饰静态方法和非静态方法有什么区别？</p>
</blockquote>
<p><strong>作用</strong></p>
<p><strong> <code>synchronized</code>  可以保证在同一个时刻，只有一个线程可以执行某个方法或者某个代码块</strong>。</p>
<p><code>synchronized</code>  有 3 种应用方式：</p>
<ul>
<li><strong>同步实例方法</strong> - 对于普通同步方法，锁是当前实例对象</li>
<li><strong>同步静态方法</strong> - 对于静态同步方法，锁是当前类的  <code>Class</code>  对象</li>
<li><strong>同步代码块</strong> - 对于同步方法块，锁是  <code>synchonized</code>  括号里配置的对象</li>
</ul>
<p><strong>原理</strong></p>
<p><code>synchronized</code>  经过编译后，会在同步块的前后分别形成  <code>monitorenter</code>  和  <code>monitorexit</code>  这两个字节码指令，这两个字节码指令都需要一个引用类型的参数来指明要锁定和解锁的对象。如果  <code>synchronized</code>  明确制定了对象参数，那就是这个对象的引用；如果没有明确指定，那就根据  <code>synchronized</code>  修饰的是实例方法还是静态方法，去对对应的对象实例或  <code>Class</code>  对象来作为锁对象。</p>
<p><code>synchronized</code>  同步块对同一线程来说是可重入的，不会出现锁死问题。</p>
<p><code>synchronized</code>  同步块是互斥的，即已进入的线程执行完成前，会阻塞其他试图进入的线程。</p>
<p><strong>优化</strong></p>
<p>Java 1.6 以后， <code>synchronized</code>  做了大量的优化，其性能已经与  <code>Lock</code>  、 <code>ReadWriteLock</code>  基本上持平。</p>
<p><code>synchronized</code>  的优化是将锁粒度分为不同级别， <code>synchronized</code>  会根据运行状态动态的由低到高调整锁级别（<strong>偏向锁</strong> -&gt; <strong>轻量级锁</strong> -&gt; <strong>重量级锁</strong>），以减少阻塞。</p>
<p><strong>同步方法 or 同步块？</strong></p>
<ul>
<li>同步块是更好的选择。</li>
<li>因为它不会锁住整个对象（当然你也可以让它锁住整个对象）。同步方法会锁住整个对象，哪怕这个类中有多个不相关联的同步块，这通常会导致他们停止执行并需要等待获得这个对象上的锁。</li>
</ul>
<h4 id="-1038"><a class="markdownIt-Anchor" href="#-1038">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#%E2%AD%90-volatile">#</a>⭐  <code>volatile</code></h4>
<blockquote>
<p><code>volatile</code>  有什么作用？</p>
<p><code>volatile</code>  的原理是什么？</p>
<p><code>volatile</code>  能代替锁吗？</p>
<p><code>volatile</code>  和  <code>synchronized</code>  的区别？</p>
</blockquote>
<p><strong> <code>volatile</code>  无法替代  <code>synchronized</code>  ，因为  <code>volatile</code>  无法保证操作的原子性</strong>。</p>
<p><strong>作用</strong></p>
<p>被  <code>volatile</code>  关键字修饰的变量有两层含义：</p>
<ul>
<li><strong>保证了不同线程对这个变量进行操作时的可见性</strong>，即一个线程修改了某个变量的值，这新值对其他线程来说是立即可见的。</li>
<li><strong>禁止指令重排序</strong>。</li>
</ul>
<p><strong>原理</strong></p>
<p>观察加入 volatile 关键字和没有加入 volatile 关键字时所生成的汇编代码发现，<strong>加入  <code>volatile</code>  关键字时，会多出一个  <code>lock</code>  前缀指令</strong>。</p>
<p><strong> <code>lock</code>  前缀指令实际上相当于一个内存屏障</strong>（也成内存栅栏），内存屏障会提供 3 个功能：</p>
<ul>
<li>它确保指令重排序时不会把其后面的指令排到内存屏障之前的位置，也不会把前面的指令排到内存屏障的后面；即在执行到内存屏障这句指令时，在它前面的操作已经全部完成；</li>
<li>它会强制将对缓存的修改操作立即写入主存；</li>
<li>如果是写操作，它会导致其他 CPU 中对应的缓存行无效。</li>
</ul>
<p><strong> <code>volatile</code>  和  <code>synchronized</code>  的区别？</strong></p>
<ul>
<li><code>volatile</code>  本质是在告诉 jvm 当前变量在寄存器（工作内存）中的值是不确定的，需要从主存中读取；  <code>synchronized</code>  则是锁定当前变量，只有当前线程可以访问该变量，其他线程被阻塞住。</li>
<li><code>volatile</code>  仅能使用在变量级别；synchronized 则可以使用在变量、方法、和类级别的。</li>
<li><code>volatile</code>  仅能实现变量的修改可见性，不能保证原子性；而  <code>synchronized</code>  则可以保证变量的修改可见性和原子性</li>
<li><code>volatile</code>  不会造成线程的阻塞；synchronized 可能会造成线程的阻塞。</li>
<li><code>volatile</code>  标记的变量不会被编译器优化；synchronized 标记的变量可以被编译器优化。</li>
</ul>
<h4 id="-1039"><a class="markdownIt-Anchor" href="#-1039">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#%E2%AD%90%E2%AD%90-cas">#</a>⭐⭐ CAS</h4>
<blockquote>
<p>什么是 CAS？</p>
<p>CAS 有什么作用？</p>
<p>CAS 的原理是什么？</p>
<p>CAS 的三大问题？</p>
</blockquote>
<p><strong>作用</strong></p>
<p><strong>CAS（Compare and Swap）</strong>，字面意思为<strong>比较并交换</strong>。CAS 有 3 个操作数，分别是：内存值 V，旧的预期值 A，要修改的新值 B。当且仅当预期值 A 和内存值 V 相同时，将内存值 V 修改为 B，否则什么都不做。</p>
<p><strong>原理</strong></p>
<p>Java 主要利用  <code>Unsafe</code>  这个类提供的 CAS 操作。 <code>Unsafe</code>  的 CAS 依赖的是 JV M 针对不同的操作系统实现的  <code>Atomic::cmpxchg</code>  指令。</p>
<p><strong>三大问题</strong></p>
<ol>
<li><strong>ABA 问题</strong>：因为 CAS 需要在操作值的时候检查下值有没有发生变化，如果没有发生变化则更新，但是如果一个值原来是 A，变成了 B，又变成了 A，那么使用 CAS 进行检查时会发现它的值没有发生变化，但是实际上却变化了。ABA 问题的解决思路就是使用版本号。在变量前面追加上版本号，每次变量更新的时候把版本号加一，那么 A－B－A 就会变成 1A-2B－3A。</li>
<li><strong>循环时间长开销大</strong>。自旋 CAS 如果长时间不成功，会给 CPU 带来非常大的执行开销。如果 JVM 能支持处理器提供的 pause 指令那么效率会有一定的提升，pause 指令有两个作用，第一它可以延迟流水线执行指令（de-pipeline）, 使 CPU 不会消耗过多的执行资源，延迟的时间取决于具体实现的版本，在一些处理器上延迟时间是零。第二它可以避免在退出循环的时候因内存顺序冲突（memory order violation）而引起 CPU 流水线被清空（CPU pipeline flush），从而提高 CPU 的执行效率。</li>
<li><strong>只能保证一个共享变量的原子操作</strong>。当对一个共享变量执行操作时，我们可以使用循环 CAS 的方式来保证原子操作，但是对多个共享变量操作时，循环 CAS 就无法保证操作的原子性，这个时候就可以用锁，或者有一个取巧的办法，就是把多个共享变量合并成一个共享变量来操作。比如有两个共享变量 i ＝ 2,j=a，合并一下 ij=2a，然后用 CAS 来操作 ij。从 Java1.5 开始 JDK 提供了 AtomicReference 类来保证引用对象之间的原子性，你可以把多个变量放在一个对象里来进行 CAS 操作。</li>
</ol>
<h4 id="-1040"><a class="markdownIt-Anchor" href="#-1040">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#%E2%AD%90-threadlocal">#</a>⭐  <code>ThreadLocal</code></h4>
<blockquote>
<p><code>ThreadLocal</code>  有什么作用？</p>
<p><code>ThreadLocal</code>  的原理是什么？</p>
<p>如何解决  <code>ThreadLocal</code>  内存泄漏问题？</p>
</blockquote>
<p><strong>作用</strong></p>
<p><strong> <code>ThreadLocal</code>  是一个存储线程本地副本的工具类</strong>。</p>
<p><strong>原理</strong></p>
<p><code>Thread</code>  类中维护着一个  <code>ThreadLocal.ThreadLocalMap</code>  类型的成员  <code>threadLocals</code> 。这个成员就是用来存储当前线程独占的变量副本。</p>
<p><code>ThreadLocalMap</code>  是  <code>ThreadLocal</code>  的内部类，它维护着一个  <code>Entry</code>  数组，  <code>Entry</code>  用于保存键值对，其 key 是  <code>ThreadLocal</code>  对象，value 是传递进来的对象（变量副本）。  <code>Entry</code>  继承了  <code>WeakReference</code>  ，所以是弱引用。</p>
<p><strong>内存泄漏问题</strong></p>
<p>ThreadLocalMap 的  <code>Entry</code>  继承了  <code>WeakReference</code> ，所以它的 key （ <code>ThreadLocal</code>  对象）是弱引用，而 value （变量副本）是强引用。</p>
<ul>
<li>如果  <code>ThreadLocal</code>  对象没有外部强引用来引用它，那么  <code>ThreadLocal</code>  对象会在下次 GC 时被回收。</li>
<li>此时， <code>Entry</code>  中的 key 已经被回收，但是 value 由于是强引用不会被垃圾收集器回收。如果创建  <code>ThreadLocal</code>  的线程一直持续运行，那么 value 就会一直得不到回收，产生内存泄露。</li>
</ul>
<p>那么如何避免内存泄漏呢？方法就是：<strong>使用  <code>ThreadLocal</code>  的  <code>set</code>  方法后，显示的调用  <code>remove</code>  方法</strong> 。</p>
<h3 id="-1041"><a class="markdownIt-Anchor" href="#-1041">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B">#</a>内存模型</h3>
<h4 id="-1042"><a class="markdownIt-Anchor" href="#-1042">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#%E4%BB%80%E4%B9%88%E6%98%AF-java-%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B">#</a>什么是 Java 内存模型</h4>
<ul>
<li>Java 内存模型即 Java Memory Model，简称 JMM。JMM 定义了 JVM 在计算机内存 (RAM) 中的工作方式。JMM 是隶属于 JVM 的。</li>
<li>并发编程领域两个关键问题：线程间通信和线程间同步</li>
<li>线程间通信机制
<ul>
<li>共享内存 - 线程间通过写 - 读内存中的公共状态来隐式进行通信。</li>
<li>消息传递 - java 中典型的消息传递方式就是 wait () 和 notify ()。</li>
</ul>
</li>
<li>线程间同步机制
<ul>
<li>在共享内存模型中，必须显示指定某个方法或某段代码在线程间互斥地执行。</li>
<li>在消息传递模型中，由于发送消息必须在接收消息之前，因此同步是隐式进行的。</li>
</ul>
</li>
<li>Java 的并发采用的是共享内存模型</li>
<li>JMM 决定一个线程对共享变量的写入何时对另一个线程可见。</li>
<li>线程之间的共享变量存储在主内存（main memory）中，每个线程都有一个私有的本地内存（local memory），本地内存中存储了该线程以读 / 写共享变量的副本。</li>
<li>JMM 把内存分成了两部分：线程栈区和堆区
<ul>
<li>线程栈
<ul>
<li>JVM 中运行的每个线程都拥有自己的线程栈，线程栈包含了当前线程执行的方法调用相关信息，我们也把它称作调用栈。随着代码的不断执行，调用栈会不断变化。</li>
<li>线程栈还包含了当前方法的所有本地变量信息。线程中的本地变量对其它线程是不可见的。</li>
</ul>
</li>
<li>堆区
<ul>
<li>堆区包含了 Java 应用创建的所有对象信息，不管对象是哪个线程创建的，其中的对象包括原始类型的封装类（如 Byte、Integer、Long 等等）。不管对象是属于一个成员变量还是方法中的本地变量，它都会被存储在堆区。</li>
</ul>
</li>
<li>一个本地变量如果是原始类型，那么它会被完全存储到栈区。</li>
<li>一个本地变量也有可能是一个对象的引用，这种情况下，这个本地引用会被存储到栈中，但是对象本身仍然存储在堆区。</li>
<li>对于一个对象的成员方法，这些方法中包含本地变量，仍需要存储在栈区，即使它们所属的对象在堆区。</li>
<li>对于一个对象的成员变量，不管它是原始类型还是包装类型，都会被存储到堆区。</li>
</ul>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/cs/java/javacore/concurrent/java-memory-model_3.png" alt="img"></p>
<blockquote>
<p>👉 参考阅读：<a target="_blank" rel="noopener" href="https://blog.csdn.net/suifeng3051/article/details/52611310">全面理解 Java 内存模型 (opens new window)</a></p>
</blockquote>
<h3 id="-1043"><a class="markdownIt-Anchor" href="#-1043">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#%E5%90%8C%E6%AD%A5%E5%AE%B9%E5%99%A8%E5%92%8C%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8">#</a>同步容器和并发容器</h3>
<blockquote>
<p>👉 参考阅读：<a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/blob/master/docs/concurrent/Java%E5%B9%B6%E5%8F%91%E5%92%8C%E5%AE%B9%E5%99%A8.md">Java 并发容器 (opens new window)</a></p>
</blockquote>
<h4 id="-1044"><a class="markdownIt-Anchor" href="#-1044">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#%E2%AD%90-%E5%90%8C%E6%AD%A5%E5%AE%B9%E5%99%A8">#</a>⭐ 同步容器</h4>
<blockquote>
<p>什么是同步容器？</p>
<p>有哪些常见同步容器？</p>
<p>它们是如何实现线程安全的？</p>
<p>同步容器真的线程安全吗？</p>
</blockquote>
<p><strong>类型</strong></p>
<pre class="line-numbers language-none"><code class="language-none">Vector&#96;、&#96;Stack&#96;、&#96;Hashtable<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><strong>作用 / 原理</strong></p>
<p>同步容器的同步原理就是在方法上用  <code>synchronized</code>  修饰。 <strong> <code>synchronized</code>  可以保证在同一个时刻，只有一个线程可以执行某个方法或者某个代码块</strong>。</p>
<p><code>synchronized</code>  的互斥同步会产生阻塞和唤醒线程的开销。显然，这种方式比没有使用  <code>synchronized</code>  的容器性能要差。</p>
<p><strong>线程安全</strong></p>
<p>同步容器真的绝对安全吗？</p>
<p>其实也未必。在做复合操作（非原子操作）时，仍然需要加锁来保护。常见复合操作如下：</p>
<ul>
<li><strong>迭代</strong>：反复访问元素，直到遍历完全部元素；</li>
<li><strong>跳转</strong>：根据指定顺序寻找当前元素的下一个（下 n 个）元素；</li>
<li><strong>条件运算</strong>：例如若没有则添加等；</li>
</ul>
<h4 id="-1045"><a class="markdownIt-Anchor" href="#-1045">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#%E2%AD%90%E2%AD%90%E2%AD%90-concurrenthashmap">#</a>⭐⭐⭐ ConcurrentHashMap</h4>
<blockquote>
<p>请描述 ConcurrentHashMap 的实现原理？</p>
<p>ConcurrentHashMap 为什么放弃了分段锁？</p>
</blockquote>
<p>基础数据结构原理和  <code>HashMap</code>  一样，JDK 1.7 采用 数组＋单链表；JDK 1.8 采用数组＋单链表＋红黑树。</p>
<p>并发安全特性的实现：</p>
<p>JDK 1.7：</p>
<ul>
<li>使用分段锁，设计思路是缩小锁粒度，提高并发吞吐。</li>
<li>写数据时，会使用可重入锁去锁住分段（segment）。</li>
</ul>
<p>JDK 1.8：</p>
<ul>
<li>
<p>取消分段锁，直接采用  <code>transient volatile HashEntry&lt;K,V&gt;[] table</code>  保存数据，采用 table 数组元素作为锁，从而实现了对每一行数据进行加锁，进一步减少并发冲突的概率。</p>
</li>
<li>
<p>写数据时，使用是 CAS +</p>
</li>
</ul>
<p>​</p>
<pre><code><pre class="line-numbers language-none"><code class="language-none">synchronized<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

。

- 根据 key 计算出 hashcode 。
- 判断是否需要进行初始化。
- `f` 即为当前 key 定位出的 Node，如果为空表示当前位置可以写入数据，利用 CAS 尝试写入，失败则自旋保证成功。
- 如果当前位置的 `hashcode == MOVED == -1`,则需要进行扩容。
- 如果都不满足，则利用 synchronized 锁写入数据。
- 如果数量大于 `TREEIFY_THRESHOLD` 则要转换为红黑树。
</code></pre>
<h4 id="-1046"><a class="markdownIt-Anchor" href="#-1046">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#%E2%AD%90%E2%AD%90-copyonwritearraylist">#</a>⭐⭐ CopyOnWriteArrayList</h4>
<blockquote>
<p>CopyOnWriteArrayList 的作用？</p>
<p>CopyOnWriteArrayList 的原理？</p>
</blockquote>
<p><strong>作用</strong></p>
<p>CopyOnWrite 字面意思为写入时复制。CopyOnWriteArrayList 是线程安全的 ArrayList。</p>
<p><strong>原理</strong></p>
<ul>
<li>在  <code>CopyOnWriteAarrayList</code>  中，读操作不同步，因为它们在内部数组的快照上工作，所以多个迭代器可以同时遍历而不会相互阻塞（1,2,4）。</li>
<li>所有的写操作都是同步的。他们在备份数组（3）的副本上工作。写操作完成后，后备阵列将被替换为复制的阵列，并释放锁定。支持数组变得易变，所以替换数组的调用是原子（5）。</li>
<li>写操作后创建的迭代器将能够看到修改的结构（6,7）。</li>
<li>写时复制集合返回的迭代器不会抛出 ConcurrentModificationException，因为它们在数组的快照上工作，并且无论后续的修改（2,4）如何，都会像迭代器创建时那样完全返回元素。</li>
</ul>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/cs/java/javacore/container/CopyOnWriteArrayList.png" alt="img"></p>
<h3 id="-1047"><a class="markdownIt-Anchor" href="#-1047">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#%E5%B9%B6%E5%8F%91%E9%94%81">#</a>并发锁</h3>
<blockquote>
<p>👉 参考阅读：<a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/blob/master/docs/concurrent/Java%E9%94%81.md">Java 并发锁 (opens new window)</a></p>
</blockquote>
<h4 id="-1048"><a class="markdownIt-Anchor" href="#-1048">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#%E2%AD%90%E2%AD%90-%E9%94%81%E7%B1%BB%E5%9E%8B">#</a>⭐⭐ 锁类型</h4>
<blockquote>
<p>Java 中有哪些锁？</p>
<p>这些锁有什么特性？</p>
</blockquote>
<p><strong>可重入锁</strong></p>
<ul>
<li><strong> <code>ReentrantLock</code>  、 <code>ReentrantReadWriteLock</code>  是可重入锁</strong>。这点，从其命名也不难看出。</li>
<li><strong> <code>synchronized</code>  也是一个可重入锁</strong>。</li>
</ul>
<p><strong>公平锁与非公平锁</strong></p>
<ul>
<li><strong> <code>synchronized</code>  只支持非公平锁</strong>。</li>
<li><strong> <code>ReentrantLock</code>  、 <code>ReentrantReadWriteLock</code> ，默认是非公平锁，但支持公平锁</strong>。</li>
</ul>
<p><strong>独享锁与共享锁</strong></p>
<ul>
<li><strong> <code>synchronized</code>  、 <code>ReentrantLock</code>  只支持独享锁</strong>。</li>
<li><strong> <code>ReentrantReadWriteLock</code>  其写锁是独享锁，其读锁是共享锁</strong>。读锁是共享锁使得并发读是非常高效的，读写，写读 ，写写的过程是互斥的。</li>
</ul>
<p><strong>悲观锁与乐观锁</strong></p>
<ul>
<li>悲观锁在 Java 中的应用就是通过使用  <code>synchronized</code>  和  <code>Lock</code>  显示加锁来进行互斥同步，这是一种阻塞同步。</li>
<li>乐观锁在 Java 中的应用就是采用 CAS 机制（CAS 操作通过  <code>Unsafe</code>  类提供，但这个类不直接暴露为 API，所以都是间接使用，如各种原子类）。</li>
</ul>
<p><strong>偏向锁、轻量级锁、重量级锁</strong></p>
<p>Java 1.6 以前，重量级锁一般指的是  <code>synchronized</code>  ，而轻量级锁指的是  <code>volatile</code> 。</p>
<p>Java 1.6 以后，针对  <code>synchronized</code>  做了大量优化，引入 4 种锁状态： 无锁状态、偏向锁、轻量级锁和重量级锁。锁可以单向的从偏向锁升级到轻量级锁，再从轻量级锁升级到重量级锁 。</p>
<p><strong>分段锁</strong></p>
<p>分段锁其实是一种锁的设计，并不是具体的一种锁。典型：JDK1.7 之前的  <code>ConcurrentHashMap</code></p>
<p><strong>显示锁和内置锁</strong></p>
<ul>
<li>内置锁： <code>synchronized</code></li>
<li>显示锁： <code>ReentrantLock</code> 、 <code>ReentrantReadWriteLock</code>  等。</li>
</ul>
<h4 id="-1049"><a class="markdownIt-Anchor" href="#-1049">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#%E2%AD%90%E2%AD%90-aqs">#</a>⭐⭐ AQS</h4>
<blockquote>
<p>什么是 AQS？</p>
<p>AQS 的作用是什么？</p>
<p>AQS 的原理？</p>
</blockquote>
<p><strong>作用</strong></p>
<p><code>AbstractQueuedSynchronizer</code> （简称 <strong>AQS</strong>）是<strong>队列同步器</strong>，顾名思义，其主要作用是处理同步。它是并发锁和很多同步工具类的实现基石（如  <code>ReentrantLock</code> 、 <code>ReentrantReadWriteLock</code> 、 <code>Semaphore</code>  等）。</p>
<p><strong>AQS 提供了对独享锁与共享锁的支持</strong>。</p>
<p><strong>原理</strong></p>
<p>（1）数据结构</p>
<ul>
<li>
<pre><code>
  state
  <pre class="line-numbers language-none"><code class="language-none">

​	 

	\- AQS 使用一个整型的


​	 
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
  volatile
  <pre class="line-numbers language-none"><code class="language-none">

​	 

	变量来


​	 

	维护同步状态
	
	。
	
	- 这个整数状态的意义由子类来赋予，如&#96;ReentrantLock&#96; 中该状态值表示所有者线程已经重复获取该锁的次数，&#96;Semaphore&#96; 中该状态值表示剩余的许可数量。

- &#96;head&#96; 和 &#96;tail&#96; - AQS **维护了一个 &#96;Node&#96; 类型（AQS 的内部类）的双链表来完成同步状态的管理**。这个双链表是一个双向的 FIFO 队列，通过 &#96;head&#96; 和 &#96;tail&#96; 指针进行访问。当 **有线程获取锁失败后，就被添加到队列末尾**。

（2）获取独占锁

AQS 中使用 &#96;acquire(int arg)&#96; 方法获取独占锁，其大致流程如下：

1. 先尝试获取同步状态，如果获取同步状态成功，则结束方法，直接返回。
2. 如果获取同步状态不成功，AQS 会不断尝试利用 CAS 操作将当前线程插入等待同步队列的队尾，直到成功为止。
3. 接着，不断尝试为等待队列中的线程节点获取独占锁。

（3）释放独占锁

AQS 中使用 &#96;release(int arg)&#96; 方法释放独占锁，其大致流程如下：

1. 先尝试获取解锁线程的同步状态，如果获取同步状态不成功，则结束方法，直接返回。
2. 如果获取同步状态成功，AQS 会尝试唤醒当前线程节点的后继节点。

（4）获取共享锁

AQS 中使用 &#96;acquireShared(int arg)&#96; 方法获取共享锁。

&#96;acquireShared&#96; 方法和 &#96;acquire&#96; 方法的逻辑很相似，区别仅在于自旋的条件以及节点出队的操作有所不同。

成功获得共享锁的条件如下：

- &#96;tryAcquireShared(arg)&#96; 返回值大于等于 0 （这意味着共享锁的 permit 还没有用完）。
- 当前节点的前驱节点是头结点。

（5）释放共享锁

AQS 中使用 &#96;releaseShared(int arg)&#96; 方法释放共享锁。

&#96;releaseShared&#96; 首先会尝试释放同步状态，如果成功，则解锁一个或多个后继线程节点。释放共享锁和释放独享锁流程大体相似，区别在于：

对于独享模式，如果需要 SIGNAL，释放仅相当于调用头节点的 &#96;unparkSuccessor&#96;。

#### [#](https:&#x2F;&#x2F;dunwu.github.io&#x2F;javacore&#x2F;java-interview.html#⭐⭐-reentrantlock)⭐⭐ ReentrantLock

&gt; 什么是 ReentrantLock？
&gt;
&gt; 什么是可重入锁？
&gt;
&gt; ReentrantLock 有什么用？
&gt;
&gt; ReentrantLock 原理？

**作用**

**&#96;ReentrantLock&#96; 提供了一组无条件的、可轮询的、定时的以及可中断的锁操作**

&#96;ReentrantLock&#96; 的特性如下：

- **&#96;ReentrantLock&#96; 提供了与 &#96;synchronized&#96; 相同的互斥性、内存可见性和可重入性**。

- &#96;ReentrantLock&#96; 支持公平锁和非公平锁（默认）两种模式。

- &#96;&#96;&#96;

	ReentrantLock<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


</code></pre>
</li>
</ul>
<p>​</p>
<pre><code>实现了
</code></pre>
<p>​</p>
<pre><code><pre class="line-numbers language-none"><code class="language-none">Lock<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</code></pre>
<p>​</p>
<pre><code>接口，支持了
</code></pre>
<p>​</p>
<pre><code><pre class="line-numbers language-none"><code class="language-none">synchronized<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</code></pre>
<p>​</p>
<pre><code>所不具备的

灵活性

。

- `synchronized` 无法中断一个正在等待获取锁的线程
- `synchronized` 无法在请求获取一个锁时无休止地等待
</code></pre>
<p><strong>原理</strong></p>
<p><code>ReentrantLock</code>  基于其内部类  <code>ReentrantLock.Sync</code>  实现， <code>Sync</code>  继承自 AQS。它有两个子类：</p>
<ul>
<li><code>ReentrantLock.FairSync</code>  - 公平锁。</li>
<li><code>ReentrantLock.NonfairSync</code>  - 非公平锁。</li>
</ul>
<p>本质上，就是基于 AQS 实现。</p>
<h4 id="-1050"><a class="markdownIt-Anchor" href="#-1050">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#%E2%AD%90-reentrantreadwritelock">#</a>⭐ ReentrantReadWriteLock</h4>
<blockquote>
<p>ReentrantReadWriteLock 是什么？</p>
<p>ReentrantReadWriteLock 的作用？</p>
<p>ReentrantReadWriteLock 的原理？</p>
</blockquote>
<p><strong>作用</strong></p>
<p><code>ReentrantReadWriteLock</code>  是一个<strong>可重入的读写锁</strong>。<strong> <code>ReentrantReadWriteLock</code>  维护了一对读写锁，将读写锁分开，有利于提高并发效率</strong>。</p>
<p><strong>原理</strong></p>
<p><code>ReentrantReadWriteLock</code>  本质上也是基于 AQS 实现。有三个核心字段：</p>
<ul>
<li><code>sync</code>  - 内部类  <code>ReentrantReadWriteLock.Sync</code>  对象。与  <code>ReentrantLock</code>  类似，它有两个子类： <code>ReentrantReadWriteLock.FairSync</code>  和  <code>ReentrantReadWriteLock.NonfairSync</code>  ，分别表示公平锁和非公平锁的实现。</li>
<li><code>readerLock</code>  - 内部类  <code>ReentrantReadWriteLock.ReadLock</code>  对象，这是一把读锁。</li>
<li><code>writerLock</code>  - 内部类  <code>ReentrantReadWriteLock.WriteLock</code>  对象，这是一把写锁。</li>
</ul>
<h4 id="-1051"><a class="markdownIt-Anchor" href="#-1051">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#%E2%AD%90-condition">#</a>⭐ Condition</h4>
<blockquote>
<p>Condition 有什么用？</p>
<p>使用 Lock 的线程，彼此如何通信？</p>
</blockquote>
<p><strong>作用</strong></p>
<p>可以理解为，什么样的锁配什么样的钥匙。</p>
<p><strong>内置锁（ <code>synchronized</code> ）配合内置条件队列（ <code>wait</code> 、 <code>notify</code> 、 <code>notifyAll</code>  ），显式锁（ <code>Lock</code> ）配合显式条件队列（ <code>Condition</code>  ）</strong>。</p>
<h4 id="-1052"><a class="markdownIt-Anchor" href="#-1052">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#%E2%AD%90%E2%AD%90-%E6%AD%BB%E9%94%81">#</a>⭐⭐ 死锁</h4>
<blockquote>
<p>如何避免死锁？</p>
</blockquote>
<ul>
<li>避免一个线程同时获取多个锁</li>
<li>避免一个线程在锁内同时占用多个资源，尽量保证每个锁只占用一个资源</li>
<li>尝试使用定时锁 lock.tryLock (timeout)，避免锁一直不能释放</li>
<li>对于数据库锁，加锁和解锁必须在一个数据库连接中里，否则会出现解锁失败的情况。</li>
</ul>
<h3 id="-1053"><a class="markdownIt-Anchor" href="#-1053">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#%E5%8E%9F%E5%AD%90%E5%8F%98%E9%87%8F%E7%B1%BB">#</a>原子变量类</h3>
<blockquote>
<p>👉 参考阅读：<a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/blob/master/docs/concurrent/Java%E5%8E%9F%E5%AD%90%E7%B1%BB.md">Java 原子类 (opens new window)</a></p>
</blockquote>
<h4 id="-1054"><a class="markdownIt-Anchor" href="#-1054">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#%E2%AD%90-%E5%8E%9F%E5%AD%90%E7%B1%BB%E7%AE%80%E4%BB%8B">#</a>⭐ 原子类简介</h4>
<blockquote>
<p>为什么要用原子类？</p>
<p>用过哪些原子类？</p>
</blockquote>
<p><strong>作用</strong></p>
<p>常规的锁（ <code>Lock</code> 、 <code>sychronized</code> ）由于是阻塞式的，势必影响并发吞吐量。</p>
<p><code>volatile</code>  号称轻量级的锁，但不能保证原子性。</p>
<p>为了兼顾原子性和锁的性能问题，所以引入了原子类。</p>
<p><strong>类型</strong></p>
<p>原子变量类可以分为 4 组：</p>
<ul>
<li>基本类型
<ul>
<li><code>AtomicBoolean</code>  - 布尔类型原子类</li>
<li><code>AtomicInteger</code>  - 整型原子类</li>
<li><code>AtomicLong</code>  - 长整型原子类</li>
</ul>
</li>
<li>引用类型
<ul>
<li><code>AtomicReference</code>  - 引用类型原子类</li>
<li><code>AtomicMarkableReference</code>  - 带有标记位的引用类型原子类</li>
<li><code>AtomicStampedReference</code>  - 带有版本号的引用类型原子类</li>
</ul>
</li>
<li>数组类型
<ul>
<li><code>AtomicIntegerArray</code>  - 整形数组原子类</li>
<li><code>AtomicLongArray</code>  - 长整型数组原子类</li>
<li><code>AtomicReferenceArray</code>  - 引用类型数组原子类</li>
</ul>
</li>
<li>属性更新器类型
<ul>
<li><code>AtomicIntegerFieldUpdater</code>  - 整型字段的原子更新器。</li>
<li><code>AtomicLongFieldUpdater</code>  - 长整型字段的原子更新器。</li>
<li><code>AtomicReferenceFieldUpdater</code>  - 原子更新引用类型里的字段。</li>
</ul>
</li>
</ul>
<h4 id="-1055"><a class="markdownIt-Anchor" href="#-1055">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#%E2%AD%90-%E5%8E%9F%E5%AD%90%E7%B1%BB%E7%9A%84%E5%8E%9F%E7%90%86">#</a>⭐ 原子类的原理</h4>
<ol>
<li>处理器实现原子操作：使用总线锁保证原子性，使用缓存锁保证原子性（修改内存地址，缓存一致性机制：阻止同时修改由 2 个以上的处理器缓存的内存区域数据）</li>
<li>JAVA 实现原子操作：循环使用 CAS （自旋 CAS）实现原子操作</li>
</ol>
<h3 id="-1056"><a class="markdownIt-Anchor" href="#-1056">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#%E5%B9%B6%E5%8F%91%E5%B7%A5%E5%85%B7%E7%B1%BB">#</a>并发工具类</h3>
<blockquote>
<p>👉 参考阅读：<a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/blob/master/docs/concurrent/Java%E5%B9%B6%E5%8F%91%E5%B7%A5%E5%85%B7%E7%B1%BB.md">Java 并发工具类 (opens new window)</a></p>
</blockquote>
<h4 id="-1057"><a class="markdownIt-Anchor" href="#-1057">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#%E2%AD%90-countdownlatch">#</a>⭐ CountDownLatch</h4>
<blockquote>
<p>CountDownLatch 作用？</p>
<p>CountDownLatch 原理？</p>
</blockquote>
<p><strong>作用</strong></p>
<p>字面意思为 <strong>递减计数锁</strong>。用于控制一个或者多个线程等待多个线程。</p>
<p><code>CountDownLatch</code>  维护一个计数器 count，表示需要等待的事件数量。 <code>countDown</code>  方法递减计数器，表示有一个事件已经发生。调用  <code>await</code>  方法的线程会一直阻塞直到计数器为零，或者等待中的线程中断，或者等待超时。</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/CountDownLatch.png" alt="img"></p>
<p><strong>原理</strong></p>
<p><code>CountDownLatch</code>  是基于 AQS ( <code>AbstractQueuedSynchronizer</code> ) 实现的。</p>
<h4 id="-1058"><a class="markdownIt-Anchor" href="#-1058">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#%E2%AD%90-cyclicbarrier">#</a>⭐ CyclicBarrier</h4>
<blockquote>
<p>CyclicBarrier 有什么用？</p>
<p>CyclicBarrier 的原理是什么？</p>
<p>CyclicBarrier 和 CountDownLatch 有什么区别？</p>
</blockquote>
<p><strong>作用</strong></p>
<p>字面意思是 <strong>循环栅栏</strong>。<strong> <code>CyclicBarrier</code>  可以让一组线程等待至某个状态（遵循字面意思，不妨称这个状态为栅栏）之后再全部同时执行</strong>。之所以叫循环栅栏是因为：当所有等待线程都被释放以后， <code>CyclicBarrier</code>  可以被重用。</p>
<p><code>CyclicBarrier</code>  维护一个计数器 count。每次执行  <code>await</code>  方法之后，count 加 1，直到计数器的值和设置的值相等，等待的所有线程才会继续执行。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/cs/java/javacore/concurrent/CyclicBarrier.png" alt="img"></p>
<p><strong>原理</strong></p>
<p><code>CyclicBarrier</code>  是基于  <code>ReentrantLock</code>  和  <code>Condition</code>  实现的。</p>
<p><strong>区别</strong></p>
<p><code>CyclicBarrier</code>  和  <code>CountDownLatch</code>  都可以用来让一组线程等待其它线程。与  <code>CyclicBarrier</code>  不同的是， <code>CountdownLatch</code>  不能重用。</p>
<h4 id="-1059"><a class="markdownIt-Anchor" href="#-1059">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#%E2%AD%90-semaphore">#</a>⭐ Semaphore</h4>
<blockquote>
<p>Semaphore 作用？</p>
</blockquote>
<p><strong>作用</strong></p>
<p>字面意思为 <strong>信号量</strong>。 <code>Semaphore</code>  用来控制同时访问某个特定资源的操作数量，或者同时执行某个指定操作的数量。</p>
<p><code>Semaphore</code>  管理着一组虚拟的许可（permit），permit 的初始数量可通过构造方法来指定。每次执行  <code>acquire</code>  方法可以获取一个 permit，如果没有就等待；而  <code>release</code>  方法可以释放一个 permit。</p>
<ul>
<li><code>Semaphore</code>  可以用于实现资源池，如数据库连接池。</li>
<li><code>Semaphore</code>  可以用于将任何一种容器变成有界阻塞容器。</li>
</ul>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/cs/java/javacore/concurrent/Semaphore.png" alt="img"></p>
<h3 id="-1060"><a class="markdownIt-Anchor" href="#-1060">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#%E7%BA%BF%E7%A8%8B%E6%B1%A0">#</a>线程池</h3>
<blockquote>
<p>👉 参考阅读：<a target="_blank" rel="noopener" href="https://github.com/dunwu/javacore/blob/master/docs/concurrent/Java%E7%BA%BF%E7%A8%8B%E6%B1%A0.md">Java 线程池 (opens new window)</a></p>
</blockquote>
<h4 id="-1061"><a class="markdownIt-Anchor" href="#-1061">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#%E2%AD%90%E2%AD%90-threadpoolexecutor">#</a>⭐⭐ ThreadPoolExecutor</h4>
<blockquote>
<p><code>ThreadPoolExecutor</code>  有哪些参数，各自有什么用？</p>
<p><code>ThreadPoolExecutor</code>  工作原理？</p>
</blockquote>
<p><strong>原理</strong></p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/cs/java/javacore/concurrent/java-thread-pool_1.png" alt="img"></p>
<p><strong>参数</strong></p>
<p><code>java.uitl.concurrent.ThreadPoolExecutor</code>  类是  <code>Executor</code>  框架中最核心的一个类。</p>
<p>ThreadPoolExecutor 有四个构造方法，前三个都是基于第四个实现。第四个构造方法定义如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token keyword">int</span> corePoolSize<span class="token punctuation">,</span>
                          <span class="token keyword">int</span> maximumPoolSize<span class="token punctuation">,</span>
                          <span class="token keyword">long</span> keepAliveTime<span class="token punctuation">,</span>
                          <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">,</span>
                          <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">></span></span> workQueue<span class="token punctuation">,</span>
                          <span class="token class-name">ThreadFactory</span> threadFactory<span class="token punctuation">,</span>
                          <span class="token class-name">RejectedExecutionHandler</span> handler<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>参数说明：</p>
<ul>
<li>
<pre><code>
  corePoolSize
  <pre class="line-numbers language-none"><code class="language-none">

​	 

	\-


​	 

	核心线程数量
	
	。当有新任务通过


​	 
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
  execute
  <pre class="line-numbers language-none"><code class="language-none">

​	 

	方法提交时 ，线程池会执行以下判断：
	
	- 如果运行的线程数少于 &#96;corePoolSize&#96;，则创建新线程来处理任务，即使线程池中的其他线程是空闲的。
	- 如果线程池中的线程数量大于等于 &#96;corePoolSize&#96; 且小于 &#96;maximumPoolSize&#96;，则只有当 &#96;workQueue&#96; 满时才创建新的线程去处理任务；
	- 如果设置的 &#96;corePoolSize&#96; 和 &#96;maximumPoolSize&#96; 相同，则创建的线程池的大小是固定的。这时如果有新任务提交，若 &#96;workQueue&#96; 未满，则将请求放入 &#96;workQueue&#96; 中，等待有空闲的线程去从 &#96;workQueue&#96; 中取任务并处理；
	- 如果运行的线程数量大于等于 &#96;maximumPoolSize&#96;，这时如果 &#96;workQueue&#96; 已经满了，则使用 &#96;handler&#96; 所指定的策略来处理任务；
	- 所以，任务提交时，判断的顺序为 &#96;corePoolSize&#96; &#x3D;&gt; &#96;workQueue&#96; &#x3D;&gt; &#96;maximumPoolSize&#96;。

- &#96;&#96;&#96;

	maximumPoolSize<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


</code></pre>
</li>
</ul>
<p>​</p>
<pre><code>\-
</code></pre>
<p>​</p>
<pre><code>最大线程数量

。

- 如果队列满了，并且已创建的线程数小于最大线程数，则线程池会再创建新的线程执行任务。
- 值得注意的是：如果使用了无界的任务队列这个参数就没什么效果。
</code></pre>
<ul>
<li>
<pre><code>
  keepAliveTime
  <pre class="line-numbers language-none"><code class="language-none">	
	：
	
	线程保持活动的时间
	
	。
	
	- 当线程池中的线程数量大于 &#96;corePoolSize&#96; 的时候，如果这时没有新的任务提交，核心线程外的线程不会立即销毁，而是会等待，直到等待的时间超过了 &#96;keepAliveTime&#96;。
	- 所以，如果任务很多，并且每个任务执行的时间比较短，可以调大这个时间，提高线程的利用率。

- &#96;unit&#96; - **&#96;keepAliveTime&#96; 的时间单位**。有 7 种取值。可选的单位有天（DAYS），小时（HOURS），分钟（MINUTES），毫秒(MILLISECONDS)，微秒(MICROSECONDS, 千分之一毫秒)和毫微秒(NANOSECONDS, 千分之一微秒)。

- &#96;&#96;&#96;

	workQueue<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


</code></pre>
</li>
</ul>
<p>​</p>
<pre><code>\-
</code></pre>
<p>​</p>
<pre><code>等待执行的任务队列

。用于保存等待执行的任务的阻塞队列。 可以选择以下几个阻塞队列。

- ```
	ArrayBlockingQueue
	<pre class="line-numbers language-none"><code class="language-none">

​		 

		\-


​		 

		有界阻塞队列
	
		。
	
		- 此队列是**基于数组的先进先出队列（FIFO）**。
		- 此队列创建时必须指定大小。
	
	- &#96;&#96;&#96;
		LinkedBlockingQueue<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</code></pre>
<p>​</p>
<pre><code>	\-
</code></pre>
<p>​</p>
<pre><code>	无界阻塞队列

	。

	- 此队列是**基于链表的先进先出队列（FIFO）**。
	- 如果创建时没有指定此队列大小，则默认为 `Integer.MAX_VALUE`。
	- 吞吐量通常要高于 `ArrayBlockingQueue`。
	- 使用 `LinkedBlockingQueue` 意味着： `maximumPoolSize` 将不起作用，线程池能创建的最大线程数为 `corePoolSize`，因为任务等待队列是无界队列。
	- `Executors.newFixedThreadPool` 使用了这个队列。

- ```
	SynchronousQueue
	```
</code></pre>
<p>​</p>
<pre><code>	\-
</code></pre>
<p>​</p>
<pre><code>	不会保存提交的任务，而是将直接新建一个线程来执行新来的任务

	。

	- 每个插入操作必须等到另一个线程调用移除操作，否则插入操作一直处于阻塞状态。
	- 吞吐量通常要高于 `LinkedBlockingQueue`。
	- `Executors.newCachedThreadPool` 使用了这个队列。

- `PriorityBlockingQueue` - **具有优先级的无界阻塞队列**。
</code></pre>
<ul>
<li>
<p><code>threadFactory</code>  - <strong>线程工厂</strong>。可以通过线程工厂给每个创建出来的线程设置更有意义的名字。</p>
</li>
<li>
<p><code>handler</code>  - 饱和策略。它是 RejectedExecutionHandler 类型的变量。当队列和线程池都满了，说明线程池处于饱和状态，那么必须采取一种策略处理提交的新任务。线程池支持以下策略：</p>
<ul>
<li><code>AbortPolicy</code>  - 丢弃任务并抛出异常。这也是默认策略。</li>
<li><code>DiscardPolicy</code>  - 丢弃任务，但不抛出异常。</li>
<li><code>DiscardOldestPolicy</code>  - 丢弃队列最前面的任务，然后重新尝试执行任务（重复此过程）。</li>
<li><code>CallerRunsPolicy</code>  - 只用调用者所在的线程来运行任务。</li>
<li>如果以上策略都不能满足需要，也可以通过实现  <code>RejectedExecutionHandler</code>  接口来定制处理策略。如记录日志或持久化不能处理的任务。</li>
</ul>
</li>
</ul>
<h4 id="-1062"><a class="markdownIt-Anchor" href="#-1062">#</a> <a target="_blank" rel="noopener" href="https://dunwu.github.io/javacore/java-interview.html#%E2%AD%90-executors">#</a>⭐ Executors</h4>
<blockquote>
<p>Executors 提供了哪些内置的线程池？</p>
<p>这些线程池各自有什么特性？适合用于什么场景？</p>
</blockquote>
<p>Executors 为 Executor，ExecutorService，ScheduledExecutorService，ThreadFactory 和  <code>Callable</code>  类提供了一些工具方法。</p>
<p>（1）newSingleThreadExecutor</p>
<p><strong>创建一个单线程的线程池</strong>。</p>
<p>只会创建唯一的工作线程来执行任务，保证所有任务按照指定顺序 (FIFO, LIFO, 优先级) 执行。 <strong>如果这个唯一的线程因为异常结束，那么会有一个新的线程来替代它</strong> 。</p>
<p>单工作线程最大的特点是：<strong>可保证顺序地执行各个任务</strong>。</p>
<p>（2）newFixedThreadPool</p>
<p><strong>创建一个固定大小的线程池</strong>。</p>
<p><strong>每次提交一个任务就会新创建一个工作线程，如果工作线程数量达到线程池最大线程数，则将提交的任务存入到阻塞队列中</strong>。</p>
<p><code>FixedThreadPool</code>  是一个典型且优秀的线程池，它具有线程池提高程序效率和节省创建线程时所耗的开销的优点。但是，在线程池空闲时，即线程池中没有可运行任务时，它不会释放工作线程，还会占用一定的系统资源。</p>
<p>（3）newCachedThreadPool</p>
<p><strong>创建一个可缓存的线程池</strong>。</p>
<ul>
<li>如果线程池大小超过处理任务所需要的线程数，就会回收部分空闲的线程；</li>
<li>如果长时间没有往线程池中提交任务，即如果工作线程空闲了指定的时间（默认为 1 分钟），则该工作线程将自动终止。终止后，如果你又提交了新的任务，则线程池重新创建一个工作线程。</li>
<li>此线程池不会对线程池大小做限制，线程池大小完全依赖于操作系统（或者说 JVM）能够创建的最大线程大小。 因此，使用  <code>CachedThreadPool</code>  时，一定要注意控制任务的数量，否则，由于大量线程同时运行，很有会造成系统瘫痪。</li>
</ul>
<p>（4）newScheduleThreadPool</p>
<p>创建一个大小无限的线程池。此线程池支持定时以及周期性执行任务的需求。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Harry Qu</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://harryqu1229.github.io/2022/04/30/java%E5%A4%A7%E6%80%BB%E7%BB%93/">https://harryqu1229.github.io/2022/04/30/java%E5%A4%A7%E6%80%BB%E7%BB%93/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/javase/">javase</a><a class="post-meta__tags" href="/tags/fundamental/">fundamental</a><a class="post-meta__tags" href="/tags/summary/">summary</a></div><div class="post_share"><div class="addthis_inline_share_toolbox"></div><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-621848f44e1c3724" async="async"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/04/29/Java%20IO/"><img class="prev-cover" src="/img/default-covers/car.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Java I/O</div></div></a></div><div class="next-post pull-right"><a href="/2022/04/30/java%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98/"><img class="next-cover" src="/img/default-covers/town.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">Java Interview Questions</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2022/02/23/%E7%AE%97%E6%B3%95%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/" title="Algorithm and Data Structure notes summary"><img class="cover" src="/img/default-covers/car.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-23</div><div class="title">Algorithm and Data Structure notes summary</div></div></a></div><div><a href="/2022/06/12/%E7%AE%97%E6%B3%95%E7%BB%88%E6%9E%81%E6%8C%87%E5%8D%97/" title="My ultimate data structure and algorithm guide"><img class="cover" src="/img/default-covers/car.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-06-12</div><div class="title">My ultimate data structure and algorithm guide</div></div></a></div><div><a href="/2022/04/29/Java%20IO/" title="Java I/O"><img class="cover" src="/img/default-covers/car.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-04-29</div><div class="title">Java I/O</div></div></a></div><div><a href="/2022/04/29/Java%20%E5%9F%BA%E7%A1%80/" title="Java Basics(javase)"><img class="cover" src="/img/default-covers/statue.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-04-29</div><div class="title">Java Basics(javase)</div></div></a></div><div><a href="/2022/04/29/Java%20%E5%AE%B9%E5%99%A8/" title="Java Container(JUC)"><img class="cover" src="/img/default-covers/sky.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-04-29</div><div class="title">Java Container(JUC)</div></div></a></div><div><a href="/2022/04/30/java%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98/" title="Java Interview Questions"><img class="cover" src="/img/default-covers/town.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-04-30</div><div class="title">Java Interview Questions</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comment</span></div><div id="comment-switch"><span class="first-comment">Disqus</span><span class="switch-btn"></span><span class="second-comment">Gitalk</span></div></div><div class="comment-wrap"><div><div id="disqus_thread"></div></div><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.jpeg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Harry Qu</div><div class="author-info__description">Software Engineering Student</div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">158</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">84</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">57</div></a></div></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/HarryQu1229"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://www.linkedin.com/in/harry-qu-a0a38220a" target="_blank" title="LinkedIn"><i class="fab fa-linkedin"></i></a><a class="social-icon" href="https://github.com/HarryQu1229" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:Harryqu666@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="weixin://dl/chat?harry666ya" target="_blank" title="Wechat"><i class="fab fa-weixin"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">be healthy, stay safe</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#java-%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95%E7%89%B9%E6%80%A7"><span class="toc-number">1.</span> <span class="toc-text"> Java 基础语法特性</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%B3%A8%E9%87%8A"><span class="toc-number">1.1.</span> <span class="toc-text"> 1. 注释</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.2.</span> <span class="toc-text"> 2. 基本数据类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E5%8F%98%E9%87%8F"><span class="toc-number">1.3.</span> <span class="toc-text"> 3. 变量</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E6%95%B0%E7%BB%84"><span class="toc-number">1.4.</span> <span class="toc-text"> 4. 数组</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E6%9E%9A%E4%B8%BE"><span class="toc-number">1.5.</span> <span class="toc-text"> 5. 枚举</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E6%93%8D%E4%BD%9C%E7%AC%A6"><span class="toc-number">1.6.</span> <span class="toc-text"> 6. 操作符</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E6%96%B9%E6%B3%95"><span class="toc-number">1.7.</span> <span class="toc-text"> 7. 方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-%E6%8E%A7%E5%88%B6%E8%AF%AD%E5%8F%A5"><span class="toc-number">1.8.</span> <span class="toc-text"> 8. 控制语句</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-%E5%BC%82%E5%B8%B8"><span class="toc-number">1.9.</span> <span class="toc-text"> 9. 异常</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-%E6%B3%9B%E5%9E%8B"><span class="toc-number">1.10.</span> <span class="toc-text"> 10. 泛型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-%E5%8F%8D%E5%B0%84"><span class="toc-number">1.11.</span> <span class="toc-text"> 11. 反射</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-%E6%B3%A8%E8%A7%A3"><span class="toc-number">1.12.</span> <span class="toc-text"> 12. 注解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13-%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.13.</span> <span class="toc-text"> 13. 序列化</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-java-%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">2.</span> <span class="toc-text"> 深入理解 Java 基本数据类型</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">2.1.</span> <span class="toc-text"> 1. 数据类型分类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-2"><span class="toc-number">2.1.1.</span> <span class="toc-text"> 1.1. 值类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-3"><span class="toc-number">2.1.2.</span> <span class="toc-text"> 1.2. 值类型和引用类型的区别</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-4"><span class="toc-number">2.2.</span> <span class="toc-text"> 2. 数据转换</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-5"><span class="toc-number">2.2.1.</span> <span class="toc-text"> 2.1. 自动转换</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-6"><span class="toc-number">2.2.2.</span> <span class="toc-text"> 2.2. 强制转换</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-7"><span class="toc-number">2.3.</span> <span class="toc-text"> 3. 装箱和拆箱</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-8"><span class="toc-number">2.3.1.</span> <span class="toc-text"> 3.1. 包装类、装箱、拆箱</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-9"><span class="toc-number">2.3.2.</span> <span class="toc-text"> 3.2. 自动装箱、自动拆箱</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-10"><span class="toc-number">2.3.3.</span> <span class="toc-text"> 3.3. 装箱、拆箱的应用和注意点</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-11"><span class="toc-number">2.3.3.1.</span> <span class="toc-text"> 装箱、拆箱应用场景</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-12"><span class="toc-number">2.3.3.2.</span> <span class="toc-text"> 装箱、拆箱应用注意点</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-13"><span class="toc-number">2.4.</span> <span class="toc-text"> 4. 判等问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-14"><span class="toc-number">2.4.1.</span> <span class="toc-text"> 4.1. 包装类的判等</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-15"><span class="toc-number">2.4.2.</span> <span class="toc-text"> 4.2. String 的判等</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-16"><span class="toc-number">2.4.3.</span> <span class="toc-text"> 4.3. 实现 equals</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-17"><span class="toc-number">2.4.4.</span> <span class="toc-text"> 4.4. hashCode 和 equals 要配对实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-18"><span class="toc-number">2.4.5.</span> <span class="toc-text"> 4.5. compareTo 和 equals 的逻辑一致性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-19"><span class="toc-number">2.4.6.</span> <span class="toc-text"> 4.6. 小心 Lombok 生成代码的 “坑”</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-20"><span class="toc-number">2.5.</span> <span class="toc-text"> 5. 数值计算</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-21"><span class="toc-number">2.5.1.</span> <span class="toc-text"> 5.1. 浮点数计算问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-22"><span class="toc-number">2.5.2.</span> <span class="toc-text"> 5.2. 浮点数精度和格式化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-23"><span class="toc-number">2.5.3.</span> <span class="toc-text"> 5.3. BigDecimal 判等问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-24"><span class="toc-number">2.5.4.</span> <span class="toc-text"> 5.4. 数值溢出</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-java-string-%E7%B1%BB%E5%9E%8B"><span class="toc-number">3.</span> <span class="toc-text"> 深入理解 Java String 类型</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-25"><span class="toc-number">3.1.</span> <span class="toc-text"> 1. String 的不可变性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-26"><span class="toc-number">3.2.</span> <span class="toc-text"> 2. String 的性能考量</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-27"><span class="toc-number">3.2.1.</span> <span class="toc-text"> 2.1. 字符串拼接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-28"><span class="toc-number">3.2.2.</span> <span class="toc-text"> 2.2. 字符串分割</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-29"><span class="toc-number">3.2.3.</span> <span class="toc-text"> 2.3. String.intern</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-30"><span class="toc-number">3.3.</span> <span class="toc-text"> 3. String、StringBuffer、StringBuilder 有什么区别</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#java-%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1"><span class="toc-number">4.</span> <span class="toc-text"> Java 面向对象</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-31"><span class="toc-number">4.1.</span> <span class="toc-text"> 1. 面向对象</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-32"><span class="toc-number">4.1.1.</span> <span class="toc-text"> 1.1. 封装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-33"><span class="toc-number">4.1.2.</span> <span class="toc-text"> 1.2. 继承</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-34"><span class="toc-number">4.1.2.1.</span> <span class="toc-text"> 继承类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-35"><span class="toc-number">4.1.2.2.</span> <span class="toc-text"> 继承的特性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-36"><span class="toc-number">4.1.2.3.</span> <span class="toc-text"> 继承关键字</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-37"><span class="toc-number">4.1.3.</span> <span class="toc-text"> 1.3. 多态</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-38"><span class="toc-number">4.2.</span> <span class="toc-text"> 2. 类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-39"><span class="toc-number">4.3.</span> <span class="toc-text"> 3. 方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-40"><span class="toc-number">4.3.1.</span> <span class="toc-text"> 3.1. 方法定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-41"><span class="toc-number">4.3.2.</span> <span class="toc-text"> 3.2. 方法调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-42"><span class="toc-number">4.3.3.</span> <span class="toc-text"> 3.3. 构造方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-43"><span class="toc-number">4.4.</span> <span class="toc-text"> 4. 变量</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-44"><span class="toc-number">4.4.1.</span> <span class="toc-text"> 4.1. 变量修饰符</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-45"><span class="toc-number">4.4.2.</span> <span class="toc-text"> 4.2. 创建对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-46"><span class="toc-number">4.4.3.</span> <span class="toc-text"> 4.3. 访问实例变量和方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-47"><span class="toc-number">4.5.</span> <span class="toc-text"> 5. 访问权限控制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-48"><span class="toc-number">4.5.1.</span> <span class="toc-text"> 5.1. 代码组织</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-49"><span class="toc-number">4.5.1.1.</span> <span class="toc-text"> package</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-50"><span class="toc-number">4.5.1.2.</span> <span class="toc-text"> import</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-51"><span class="toc-number">4.5.2.</span> <span class="toc-text"> 5.2. 访问权限修饰关键字</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-52"><span class="toc-number">4.6.</span> <span class="toc-text"> 6. 接口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-53"><span class="toc-number">4.7.</span> <span class="toc-text"> 7. 抽象类</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-java-%E6%96%B9%E6%B3%95"><span class="toc-number">5.</span> <span class="toc-text"> 深入理解 Java 方法</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-54"><span class="toc-number">5.1.</span> <span class="toc-text"> 1. 方法的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-55"><span class="toc-number">5.1.1.</span> <span class="toc-text"> 1.1. 方法定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-56"><span class="toc-number">5.1.2.</span> <span class="toc-text"> 1.2. 方法的调用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-57"><span class="toc-number">5.1.2.1.</span> <span class="toc-text"> 递归调用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-58"><span class="toc-number">5.2.</span> <span class="toc-text"> 2. 方法参数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-59"><span class="toc-number">5.3.</span> <span class="toc-text"> 3. 方法修饰符</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-60"><span class="toc-number">5.3.1.</span> <span class="toc-text"> 3.1. 访问控制修饰符</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-61"><span class="toc-number">5.3.2.</span> <span class="toc-text"> 3.2. static</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-62"><span class="toc-number">5.3.3.</span> <span class="toc-text"> 3.3. final</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-63"><span class="toc-number">5.3.4.</span> <span class="toc-text"> 3.4. default</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-64"><span class="toc-number">5.3.5.</span> <span class="toc-text"> 3.5. abstract</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-65"><span class="toc-number">5.3.6.</span> <span class="toc-text"> 3.6. synchronized</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-66"><span class="toc-number">5.4.</span> <span class="toc-text"> 4. 特殊方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-67"><span class="toc-number">5.4.1.</span> <span class="toc-text"> 4.1. main 方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-68"><span class="toc-number">5.4.2.</span> <span class="toc-text"> 4.2. 构造方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-69"><span class="toc-number">5.4.3.</span> <span class="toc-text"> 4.3. 变参方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-70"><span class="toc-number">5.4.4.</span> <span class="toc-text"> 4.4. finalize () 方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-71"><span class="toc-number">5.5.</span> <span class="toc-text"> 5. 覆写和重载</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-72"><span class="toc-number">5.6.</span> <span class="toc-text"> 6. 小结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-java-%E6%95%B0%E7%BB%84"><span class="toc-number">6.</span> <span class="toc-text"> 深入理解 Java 数组</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-73"><span class="toc-number">6.1.</span> <span class="toc-text"> 1. 简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-74"><span class="toc-number">6.1.1.</span> <span class="toc-text"> 1.1. 数组的特性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-75"><span class="toc-number">6.1.2.</span> <span class="toc-text"> 1.2. 数组和容器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-76"><span class="toc-number">6.1.3.</span> <span class="toc-text"> 1.3. Java 数组的本质是对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-77"><span class="toc-number">6.1.4.</span> <span class="toc-text"> 1.4. Java 数组和内存</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-78"><span class="toc-number">6.2.</span> <span class="toc-text"> 2. 声明数组</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-79"><span class="toc-number">6.3.</span> <span class="toc-text"> 3. 创建数组</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-80"><span class="toc-number">6.3.1.</span> <span class="toc-text"> 3.1. 数组维度的形式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-81"><span class="toc-number">6.3.2.</span> <span class="toc-text"> 3.2. 数组维度的大小</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-82"><span class="toc-number">6.4.</span> <span class="toc-text"> 4. 访问数组</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-83"><span class="toc-number">6.5.</span> <span class="toc-text"> 5. 数组的引用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-84"><span class="toc-number">6.6.</span> <span class="toc-text"> 6. 泛型和数组</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-85"><span class="toc-number">6.7.</span> <span class="toc-text"> 7. 多维数组</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-86"><span class="toc-number">6.8.</span> <span class="toc-text"> 8. Arrays 类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-87"><span class="toc-number">6.9.</span> <span class="toc-text"> 9. 小结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-java-%E6%9E%9A%E4%B8%BE"><span class="toc-number">7.</span> <span class="toc-text"> 深入理解 Java 枚举</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-88"><span class="toc-number">7.1.</span> <span class="toc-text"> 1. 简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-89"><span class="toc-number">7.2.</span> <span class="toc-text"> 2. 枚举的本质</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-90"><span class="toc-number">7.3.</span> <span class="toc-text"> 3. 枚举的方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-91"><span class="toc-number">7.4.</span> <span class="toc-text"> 4. 枚举的特性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-92"><span class="toc-number">7.4.1.</span> <span class="toc-text"> 4.1. 基本特性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-93"><span class="toc-number">7.4.2.</span> <span class="toc-text"> 4.2. 枚举可以添加方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-94"><span class="toc-number">7.4.3.</span> <span class="toc-text"> 4.3. 枚举可以实现接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-95"><span class="toc-number">7.4.4.</span> <span class="toc-text"> 4.4. 枚举不可以继承</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-96"><span class="toc-number">7.5.</span> <span class="toc-text"> 5. 枚举的应用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-97"><span class="toc-number">7.5.1.</span> <span class="toc-text"> 5.1. 组织常量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-98"><span class="toc-number">7.5.2.</span> <span class="toc-text"> 5.2. switch 状态机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-99"><span class="toc-number">7.5.3.</span> <span class="toc-text"> 5.3. 错误码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-100"><span class="toc-number">7.5.4.</span> <span class="toc-text"> 5.4. 组织枚举</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-101"><span class="toc-number">7.5.5.</span> <span class="toc-text"> 5.5. 策略枚举</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-102"><span class="toc-number">7.5.6.</span> <span class="toc-text"> 5.6. 枚举实现单例模式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-103"><span class="toc-number">7.6.</span> <span class="toc-text"> 6. 枚举工具类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-104"><span class="toc-number">7.6.1.</span> <span class="toc-text"> 6.1. EnumSet</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-105"><span class="toc-number">7.6.2.</span> <span class="toc-text"> 6.2. EnumMap</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-106"><span class="toc-number">7.7.</span> <span class="toc-text"> 7. 小结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#java-%E6%8E%A7%E5%88%B6%E8%AF%AD%E5%8F%A5"><span class="toc-number">8.</span> <span class="toc-text"> Java 控制语句</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-107"><span class="toc-number">8.1.</span> <span class="toc-text"> 1. 选择语句</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-108"><span class="toc-number">8.1.1.</span> <span class="toc-text"> 1.1. if 语句</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-109"><span class="toc-number">8.1.2.</span> <span class="toc-text"> 1.2. if…else 语句</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-110"><span class="toc-number">8.1.3.</span> <span class="toc-text"> 1.3. if…else if…else 语句</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-111"><span class="toc-number">8.1.4.</span> <span class="toc-text"> 1.4. 嵌套的 if…else 语句</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-112"><span class="toc-number">8.1.5.</span> <span class="toc-text"> 1.5. switch 语句</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-113"><span class="toc-number">8.2.</span> <span class="toc-text"> 2. 循环语句</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-114"><span class="toc-number">8.2.1.</span> <span class="toc-text"> 2.1. while 循环</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-115"><span class="toc-number">8.2.2.</span> <span class="toc-text"> 2.2. do while 循环</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-116"><span class="toc-number">8.2.3.</span> <span class="toc-text"> 2.3. for 循环</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-117"><span class="toc-number">8.2.4.</span> <span class="toc-text"> 2.4. foreach 循环</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-118"><span class="toc-number">8.3.</span> <span class="toc-text"> 3. 中断语句</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-119"><span class="toc-number">8.3.1.</span> <span class="toc-text"> 3.1. break 关键字</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-120"><span class="toc-number">8.3.2.</span> <span class="toc-text"> 3.2. continue 关键字</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-121"><span class="toc-number">8.3.3.</span> <span class="toc-text"> 3.3. return 关键字</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-122"><span class="toc-number">8.4.</span> <span class="toc-text"> 4. 最佳实践</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-java-%E5%BC%82%E5%B8%B8"><span class="toc-number">9.</span> <span class="toc-text"> 深入理解 Java 异常</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-123"><span class="toc-number">9.1.</span> <span class="toc-text"> 1. 异常框架</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-124"><span class="toc-number">9.1.1.</span> <span class="toc-text"> 1.1. Throwable</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-125"><span class="toc-number">9.1.2.</span> <span class="toc-text"> 1.2. Error</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-126"><span class="toc-number">9.1.3.</span> <span class="toc-text"> 1.3. Exception</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-127"><span class="toc-number">9.1.4.</span> <span class="toc-text"> 1.4. RuntimeException</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-128"><span class="toc-number">9.2.</span> <span class="toc-text"> 2. 自定义异常</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-129"><span class="toc-number">9.3.</span> <span class="toc-text"> 3. 抛出异常</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-130"><span class="toc-number">9.4.</span> <span class="toc-text"> 4. 捕获异常</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-131"><span class="toc-number">9.5.</span> <span class="toc-text"> 5. 异常链</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-132"><span class="toc-number">9.6.</span> <span class="toc-text"> 6. 异常注意事项</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-133"><span class="toc-number">9.6.1.</span> <span class="toc-text"> 6.1. finally 覆盖异常</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-134"><span class="toc-number">9.6.2.</span> <span class="toc-text"> 6.2. 覆盖抛出异常的方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-135"><span class="toc-number">9.6.3.</span> <span class="toc-text"> 6.3. 异常和线程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-136"><span class="toc-number">9.7.</span> <span class="toc-text"> 7. 最佳实践</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-java-%E6%B3%9B%E5%9E%8B"><span class="toc-number">10.</span> <span class="toc-text"> 深入理解 Java 泛型</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-137"><span class="toc-number">10.1.</span> <span class="toc-text"> 1. 为什么需要泛型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-138"><span class="toc-number">10.2.</span> <span class="toc-text"> 2. 泛型类型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-139"><span class="toc-number">10.2.1.</span> <span class="toc-text"> 2.1. 泛型类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-140"><span class="toc-number">10.2.2.</span> <span class="toc-text"> 2.2. 泛型接口</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-141"><span class="toc-number">10.3.</span> <span class="toc-text"> 3. 泛型方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-142"><span class="toc-number">10.4.</span> <span class="toc-text"> 4. 类型擦除</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-143"><span class="toc-number">10.5.</span> <span class="toc-text"> 5. 泛型和继承</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-144"><span class="toc-number">10.6.</span> <span class="toc-text"> 6. 类型边界</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-145"><span class="toc-number">10.7.</span> <span class="toc-text"> 7. 类型通配符</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-146"><span class="toc-number">10.7.1.</span> <span class="toc-text"> 7.1. 上界通配符</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-147"><span class="toc-number">10.7.2.</span> <span class="toc-text"> 7.2. 下界通配符</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-148"><span class="toc-number">10.7.3.</span> <span class="toc-text"> 7.3. 无界通配符</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-149"><span class="toc-number">10.7.4.</span> <span class="toc-text"> 7.4. 通配符和向上转型</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-150"><span class="toc-number">10.8.</span> <span class="toc-text"> 8. 泛型的约束</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-151"><span class="toc-number">10.9.</span> <span class="toc-text"> 9. 泛型最佳实践</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-152"><span class="toc-number">10.9.1.</span> <span class="toc-text"> 9.1. 泛型命名</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-153"><span class="toc-number">10.9.2.</span> <span class="toc-text"> 9.2. 使用泛型的建议</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-154"><span class="toc-number">10.10.</span> <span class="toc-text"> 10. 小结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-java-%E5%8F%8D%E5%B0%84%E5%92%8C%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86"><span class="toc-number">11.</span> <span class="toc-text"> 深入理解 Java 反射和动态代理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-155"><span class="toc-number">11.1.</span> <span class="toc-text"> 1. 反射简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-156"><span class="toc-number">11.1.1.</span> <span class="toc-text"> 1.1. 什么是反射</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-157"><span class="toc-number">11.1.2.</span> <span class="toc-text"> 1.2. 反射的应用场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-158"><span class="toc-number">11.1.3.</span> <span class="toc-text"> 1.3. 反射的缺点</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-159"><span class="toc-number">11.2.</span> <span class="toc-text"> 2. 反射机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-160"><span class="toc-number">11.2.1.</span> <span class="toc-text"> 2.1. 类加载过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-161"><span class="toc-number">11.2.2.</span> <span class="toc-text"> 2.2. Class 对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-162"><span class="toc-number">11.2.3.</span> <span class="toc-text"> 2.3. 方法的反射调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-163"><span class="toc-number">11.2.4.</span> <span class="toc-text"> 2.4. 反射调用的开销</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-164"><span class="toc-number">11.3.</span> <span class="toc-text"> 3. 使用反射</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-165"><span class="toc-number">11.3.1.</span> <span class="toc-text"> 3.1. java.lang.reflect 包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-166"><span class="toc-number">11.3.2.</span> <span class="toc-text"> 3.2. 获取 Class 对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-167"><span class="toc-number">11.3.3.</span> <span class="toc-text"> 3.3. 判断是否为某个类的实例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-168"><span class="toc-number">11.3.4.</span> <span class="toc-text"> 3.4. 创建实例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-169"><span class="toc-number">11.3.5.</span> <span class="toc-text"> 3.5. 创建数组实例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-170"><span class="toc-number">11.3.6.</span> <span class="toc-text"> 3.6. Field</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-171"><span class="toc-number">11.3.7.</span> <span class="toc-text"> 3.7. Method</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-172"><span class="toc-number">11.3.8.</span> <span class="toc-text"> 3.8. Constructor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-173"><span class="toc-number">11.3.9.</span> <span class="toc-text"> 3.9. 绕开访问限制</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-174"><span class="toc-number">11.4.</span> <span class="toc-text"> 4. 动态代理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-175"><span class="toc-number">11.4.1.</span> <span class="toc-text"> 4.1. 静态代理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-176"><span class="toc-number">11.4.2.</span> <span class="toc-text"> 4.2. JDK 动态代理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-177"><span class="toc-number">11.4.2.1.</span> <span class="toc-text"> InvocationHandler 接口</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-178"><span class="toc-number">11.4.2.2.</span> <span class="toc-text"> Proxy 类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-179"><span class="toc-number">11.4.2.3.</span> <span class="toc-text"> JDK 动态代理实例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-180"><span class="toc-number">11.4.2.4.</span> <span class="toc-text"> JDK 动态代理小结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-181"><span class="toc-number">11.4.3.</span> <span class="toc-text"> 4.3. CGLIB 动态代理</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-java-%E6%B3%A8%E8%A7%A3"><span class="toc-number">12.</span> <span class="toc-text"> 深入理解 Java 注解</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-182"><span class="toc-number">12.1.</span> <span class="toc-text"> 1. 简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-183"><span class="toc-number">12.1.1.</span> <span class="toc-text"> 1.1. 注解的形式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-184"><span class="toc-number">12.1.2.</span> <span class="toc-text"> 1.2. 什么是注解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-185"><span class="toc-number">12.1.3.</span> <span class="toc-text"> 1.3. 注解的作用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-186"><span class="toc-number">12.1.4.</span> <span class="toc-text"> 1.4. 注解的代价</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-187"><span class="toc-number">12.1.5.</span> <span class="toc-text"> 1.5. 注解的应用范围</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-188"><span class="toc-number">12.2.</span> <span class="toc-text"> 2. 内置注解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-189"><span class="toc-number">12.2.1.</span> <span class="toc-text"> 2.1. @Override</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-190"><span class="toc-number">12.2.2.</span> <span class="toc-text"> 2.2. @Deprecated</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-191"><span class="toc-number">12.2.3.</span> <span class="toc-text"> 2.3. @SuppressWarnnings</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-192"><span class="toc-number">12.2.4.</span> <span class="toc-text"> 2.4. @SafeVarargs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-193"><span class="toc-number">12.2.5.</span> <span class="toc-text"> 2.5. @FunctionalInterface</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-194"><span class="toc-number">12.3.</span> <span class="toc-text"> 3. 元注解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-195"><span class="toc-number">12.3.1.</span> <span class="toc-text"> 3.1. @Retention</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-196"><span class="toc-number">12.3.2.</span> <span class="toc-text"> 3.2. @Documented</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-197"><span class="toc-number">12.3.3.</span> <span class="toc-text"> 3.3. @Target</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-198"><span class="toc-number">12.3.4.</span> <span class="toc-text"> 3.4. @Inherited</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-199"><span class="toc-number">12.3.5.</span> <span class="toc-text"> 3.5. @Repeatable</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-200"><span class="toc-number">12.4.</span> <span class="toc-text"> 4. 自定义注解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-201"><span class="toc-number">12.4.1.</span> <span class="toc-text"> 4.1. 注解的定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-202"><span class="toc-number">12.4.2.</span> <span class="toc-text"> 4.2. 注解属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-203"><span class="toc-number">12.4.3.</span> <span class="toc-text"> 4.3. 注解处理器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-204"><span class="toc-number">12.4.4.</span> <span class="toc-text"> 4.4. 使用注解</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-205"><span class="toc-number">12.5.</span> <span class="toc-text"> 5. 小结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#java-%E6%AD%A3%E5%88%99%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%B2%BE%E9%80%9A"><span class="toc-number">13.</span> <span class="toc-text"> Java 正则从入门到精通</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-206"><span class="toc-number">13.1.</span> <span class="toc-text"> 1. 正则简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-207"><span class="toc-number">13.1.1.</span> <span class="toc-text"> 1.1. 正则表达式是什么</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-208"><span class="toc-number">13.1.2.</span> <span class="toc-text"> 1.2. 如何学习正则</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-209"><span class="toc-number">13.2.</span> <span class="toc-text"> 2. 正则工具类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-210"><span class="toc-number">13.2.1.</span> <span class="toc-text"> 2.1. Pattern 类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-211"><span class="toc-number">13.2.2.</span> <span class="toc-text"> 2.2. Matcher 类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-212"><span class="toc-number">13.2.2.1.</span> <span class="toc-text"> 校验</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-213"><span class="toc-number">13.2.2.2.</span> <span class="toc-text"> 查找</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-214"><span class="toc-number">13.2.2.3.</span> <span class="toc-text"> 替换</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-215"><span class="toc-number">13.3.</span> <span class="toc-text"> 3. 元字符</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-216"><span class="toc-number">13.3.1.</span> <span class="toc-text"> 3.1. 基本元字符</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-217"><span class="toc-number">13.3.1.1.</span> <span class="toc-text"> 多选（ | ）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-218"><span class="toc-number">13.3.1.2.</span> <span class="toc-text"> 分组（ () ）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-219"><span class="toc-number">13.3.1.3.</span> <span class="toc-text"> 指定单字符有效范围（ [] ）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-220"><span class="toc-number">13.3.1.4.</span> <span class="toc-text"> 指定单字符无效范围（  [^] ）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-221"><span class="toc-number">13.3.1.5.</span> <span class="toc-text"> 限制字符数量（ {} ）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-222"><span class="toc-number">13.3.1.6.</span> <span class="toc-text"> 转义字符（ &#x2F; ）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-223"><span class="toc-number">13.3.1.7.</span> <span class="toc-text"> 指定表达式字符串的开始（ ^ ）和结尾（ $ ）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-224"><span class="toc-number">13.3.2.</span> <span class="toc-text"> 3.2. 等价字符</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-225"><span class="toc-number">13.3.2.1.</span> <span class="toc-text"> 表示某一类型字符的等价字符</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-226"><span class="toc-number">13.3.2.2.</span> <span class="toc-text"> 限制字符数量的等价字符</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-227"><span class="toc-number">13.3.2.3.</span> <span class="toc-text"> 元字符优先级顺序</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-228"><span class="toc-number">13.4.</span> <span class="toc-text"> 4. 分组构造</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-229"><span class="toc-number">13.4.1.</span> <span class="toc-text"> 4.1. 捕获与非捕获</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-230"><span class="toc-number">13.4.2.</span> <span class="toc-text"> 4.2. 反向引用</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#-231"><span class="toc-number">13.4.2.0.1.</span> <span class="toc-text"> 带编号的反向引用</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-232"><span class="toc-number">13.4.2.1.</span> <span class="toc-text"> 命名的反向引用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-233"><span class="toc-number">13.4.3.</span> <span class="toc-text"> 4.3. 非捕获组</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-234"><span class="toc-number">13.4.4.</span> <span class="toc-text"> 4.4. 零宽断言</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-235"><span class="toc-number">13.4.4.1.</span> <span class="toc-text"> 匹配 exp 前面的位置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-236"><span class="toc-number">13.4.4.2.</span> <span class="toc-text"> 匹配 exp 后面的位置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-237"><span class="toc-number">13.4.4.3.</span> <span class="toc-text"> 匹配后面跟的不是 exp 的位置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-238"><span class="toc-number">13.4.4.4.</span> <span class="toc-text"> 匹配前面不是 exp 的位置</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-239"><span class="toc-number">13.5.</span> <span class="toc-text"> 5. 贪婪与懒惰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-240"><span class="toc-number">13.6.</span> <span class="toc-text"> 6. 正则附录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-241"><span class="toc-number">13.6.1.</span> <span class="toc-text"> 6.1. 匹配正则字符串的方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-242"><span class="toc-number">13.6.2.</span> <span class="toc-text"> 6.2. 速查元字符字典</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-243"><span class="toc-number">13.6.2.1.</span> <span class="toc-text"> 限定符</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-244"><span class="toc-number">13.6.2.2.</span> <span class="toc-text"> 定位符</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-245"><span class="toc-number">13.6.2.3.</span> <span class="toc-text"> 非打印字符</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-246"><span class="toc-number">13.6.2.4.</span> <span class="toc-text"> 分组</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-247"><span class="toc-number">13.6.2.5.</span> <span class="toc-text"> 特殊符号</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-248"><span class="toc-number">13.7.</span> <span class="toc-text"> 7. 正则实战</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-249"><span class="toc-number">13.7.1.</span> <span class="toc-text"> 7.1. 最实用的正则</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-250"><span class="toc-number">13.7.1.1.</span> <span class="toc-text"> 校验中文</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-251"><span class="toc-number">13.7.1.2.</span> <span class="toc-text"> 校验身份证号码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-252"><span class="toc-number">13.7.1.3.</span> <span class="toc-text"> 校验有效用户名、密码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-253"><span class="toc-number">13.7.1.4.</span> <span class="toc-text"> 校验邮箱</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-254"><span class="toc-number">13.7.1.5.</span> <span class="toc-text"> 校验 URL</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-255"><span class="toc-number">13.7.1.6.</span> <span class="toc-text"> 校验时间</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-256"><span class="toc-number">13.7.1.7.</span> <span class="toc-text"> 校验日期</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-257"><span class="toc-number">13.7.1.8.</span> <span class="toc-text"> 校验中国手机号码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-258"><span class="toc-number">13.7.1.9.</span> <span class="toc-text"> 校验中国固话号码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-259"><span class="toc-number">13.7.1.10.</span> <span class="toc-text"> 校验 IPv4 地址</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-260"><span class="toc-number">13.7.1.11.</span> <span class="toc-text"> 校验 IPv6 地址</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-261"><span class="toc-number">13.7.2.</span> <span class="toc-text"> 7.2. 特定字符</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-262"><span class="toc-number">13.7.3.</span> <span class="toc-text"> 7.3. 特定数字</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-263"><span class="toc-number">13.8.</span> <span class="toc-text"> 8. 正则表达式的性能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-264"><span class="toc-number">13.8.1.</span> <span class="toc-text"> 8.1. NFA 自动机的回溯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-265"><span class="toc-number">13.8.2.</span> <span class="toc-text"> 8.2. 如何避免回溯</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-266"><span class="toc-number">13.8.2.1.</span> <span class="toc-text"> 贪婪模式（Greedy）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-267"><span class="toc-number">13.8.2.2.</span> <span class="toc-text"> 懒惰模式（Reluctant）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-268"><span class="toc-number">13.8.2.3.</span> <span class="toc-text"> 独占模式（Possessive）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-269"><span class="toc-number">13.8.3.</span> <span class="toc-text"> 8.3. 正则表达式的优化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-270"><span class="toc-number">13.8.3.1.</span> <span class="toc-text"> 少用贪婪模式，多用独占模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-271"><span class="toc-number">13.8.3.2.</span> <span class="toc-text"> 减少分支选择</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-272"><span class="toc-number">13.8.3.3.</span> <span class="toc-text"> 减少捕获嵌套</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#java-%E7%BC%96%E7%A0%81%E5%92%8C%E5%8A%A0%E5%AF%86"><span class="toc-number">14.</span> <span class="toc-text"> Java 编码和加密</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-273"><span class="toc-number">14.1.</span> <span class="toc-text"> 一、Base64 编码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-274"><span class="toc-number">14.1.1.</span> <span class="toc-text"> Base64 原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-275"><span class="toc-number">14.1.2.</span> <span class="toc-text"> Base64 应用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-276"><span class="toc-number">14.2.</span> <span class="toc-text"> 二、消息摘要</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-277"><span class="toc-number">14.2.1.</span> <span class="toc-text"> 消息摘要概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-278"><span class="toc-number">14.2.2.</span> <span class="toc-text"> 消息摘要特点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-279"><span class="toc-number">14.2.3.</span> <span class="toc-text"> 消息摘要常用算法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-280"><span class="toc-number">14.2.4.</span> <span class="toc-text"> 消息摘要应用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-281"><span class="toc-number">14.2.4.1.</span> <span class="toc-text"> MD5、SHA 的范例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-282"><span class="toc-number">14.2.4.2.</span> <span class="toc-text"> HMAC 的范例</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-283"><span class="toc-number">14.3.</span> <span class="toc-text"> 三、数字签名</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-284"><span class="toc-number">14.3.1.</span> <span class="toc-text"> 数字签名概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-285"><span class="toc-number">14.3.2.</span> <span class="toc-text"> 数字签名算法应用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-286"><span class="toc-number">14.3.2.1.</span> <span class="toc-text"> DSA 的范例</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-287"><span class="toc-number">14.4.</span> <span class="toc-text"> 四、对称加密</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-288"><span class="toc-number">14.4.1.</span> <span class="toc-text"> 对称加密概述</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-289"><span class="toc-number">14.4.1.1.</span> <span class="toc-text"> 对称加密原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-290"><span class="toc-number">14.4.1.2.</span> <span class="toc-text"> 对称加密工作模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-291"><span class="toc-number">14.4.1.3.</span> <span class="toc-text"> 对称加密填充方法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-292"><span class="toc-number">14.4.2.</span> <span class="toc-text"> 对称加密应用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-293"><span class="toc-number">14.4.2.1.</span> <span class="toc-text"> 基于密钥加密的流程（DES、DESede、AES 和 IDEA）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-294"><span class="toc-number">14.4.2.2.</span> <span class="toc-text"> 基于口令加密的流程（PBE）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-295"><span class="toc-number">14.5.</span> <span class="toc-text"> 五、非对称加密</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-296"><span class="toc-number">14.5.1.</span> <span class="toc-text"> 非对称加密概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-297"><span class="toc-number">14.5.2.</span> <span class="toc-text"> 非对称加密算法应用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-298"><span class="toc-number">14.6.</span> <span class="toc-text"> 六、术语</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#java-%E6%9C%AC%E5%9C%B0%E5%8C%96"><span class="toc-number">15.</span> <span class="toc-text"> Java 本地化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-299"><span class="toc-number">15.1.</span> <span class="toc-text"> 背景知识</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-300"><span class="toc-number">15.1.1.</span> <span class="toc-text"> 语言编码、国家 &#x2F; 地区编码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-301"><span class="toc-number">15.1.2.</span> <span class="toc-text"> 字符编码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-302"><span class="toc-number">15.2.</span> <span class="toc-text"> Java 中实现本地化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-303"><span class="toc-number">15.2.1.</span> <span class="toc-text"> 定义不同语种的模板</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-304"><span class="toc-number">15.2.1.1.</span> <span class="toc-text"> 定义 properties 文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-305"><span class="toc-number">15.2.1.2.</span> <span class="toc-text"> Unicode 转换工具</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-306"><span class="toc-number">15.2.2.</span> <span class="toc-text"> 选择语种</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-307"><span class="toc-number">15.2.2.1.</span> <span class="toc-text"> Locale</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-308"><span class="toc-number">15.2.3.</span> <span class="toc-text"> 加载指定语种的模板</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-309"><span class="toc-number">15.2.3.1.</span> <span class="toc-text"> ResourceBoundle</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-310"><span class="toc-number">15.3.</span> <span class="toc-text"> 支持本地化的工具类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-311"><span class="toc-number">15.3.1.</span> <span class="toc-text"> NumberFormat</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-312"><span class="toc-number">15.3.2.</span> <span class="toc-text"> DateFormat</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-313"><span class="toc-number">15.3.3.</span> <span class="toc-text"> MessageFormat</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#jdk8-%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97"><span class="toc-number">16.</span> <span class="toc-text"> JDK8 入门指南</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-314"><span class="toc-number">16.1.</span> <span class="toc-text"> Default Methods for Interfaces (接口的默认方法)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-315"><span class="toc-number">16.2.</span> <span class="toc-text"> Lambda expressions (Lambda 表达式)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-316"><span class="toc-number">16.3.</span> <span class="toc-text"> Functional Interfaces (函数接口)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-317"><span class="toc-number">16.4.</span> <span class="toc-text"> Method and Constructor References (方法和构造器引用)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-318"><span class="toc-number">16.5.</span> <span class="toc-text"> Lambda Scopes (Lambda 作用域)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-319"><span class="toc-number">16.5.1.</span> <span class="toc-text"> Accessing local variables (访问本地变量)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-320"><span class="toc-number">16.5.2.</span> <span class="toc-text"> Accessing fields and static variables (访问成员变量和静态变量)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-321"><span class="toc-number">16.5.3.</span> <span class="toc-text"> Accessing Default Interface Methods（访问默认的接口方法）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-322"><span class="toc-number">16.6.</span> <span class="toc-text"> Built-in Functional Interfaces (内置函数接口)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-323"><span class="toc-number">16.6.1.</span> <span class="toc-text"> Predicates</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-324"><span class="toc-number">16.6.2.</span> <span class="toc-text"> Functions</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-325"><span class="toc-number">16.6.3.</span> <span class="toc-text"> Suppliers</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-326"><span class="toc-number">16.6.4.</span> <span class="toc-text"> Consumers</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-327"><span class="toc-number">16.6.5.</span> <span class="toc-text"> Comparators</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-328"><span class="toc-number">16.7.</span> <span class="toc-text"> Optionals</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-329"><span class="toc-number">16.8.</span> <span class="toc-text"> Streams</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-330"><span class="toc-number">16.8.1.</span> <span class="toc-text"> Filter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-331"><span class="toc-number">16.8.2.</span> <span class="toc-text"> Sorted</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-332"><span class="toc-number">16.8.3.</span> <span class="toc-text"> Map</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-333"><span class="toc-number">16.8.4.</span> <span class="toc-text"> Match</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-334"><span class="toc-number">16.8.4.1.</span> <span class="toc-text"> Count</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-335"><span class="toc-number">16.8.5.</span> <span class="toc-text"> Reduce</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-336"><span class="toc-number">16.9.</span> <span class="toc-text"> Parallel Streams</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-337"><span class="toc-number">16.9.1.</span> <span class="toc-text"> Sequential Sort</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-338"><span class="toc-number">16.9.2.</span> <span class="toc-text"> Parallel Sort</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-339"><span class="toc-number">16.10.</span> <span class="toc-text"> Maps</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-340"><span class="toc-number">16.11.</span> <span class="toc-text"> Date API</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-341"><span class="toc-number">16.11.1.</span> <span class="toc-text"> Clock</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-342"><span class="toc-number">16.11.2.</span> <span class="toc-text"> Timezones</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-343"><span class="toc-number">16.11.3.</span> <span class="toc-text"> LocalTime</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-344"><span class="toc-number">16.11.4.</span> <span class="toc-text"> LocalDate</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-345"><span class="toc-number">16.11.5.</span> <span class="toc-text"> LocalDateTime</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-346"><span class="toc-number">16.12.</span> <span class="toc-text"> Annotations</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-347"><span class="toc-number">16.12.1.</span> <span class="toc-text"> Variant 1: 使用容器注解 (老套路)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-348"><span class="toc-number">16.12.2.</span> <span class="toc-text"> Variant 2: 使用 repeatable 注解 (新套路)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-349"><span class="toc-number">16.13.</span> <span class="toc-text"> JDK8 升级常见问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-350"><span class="toc-number">16.13.1.</span> <span class="toc-text"> Intellij 中的 JDK 环境设置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-351"><span class="toc-number">16.13.1.1.</span> <span class="toc-text"> Settings</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-352"><span class="toc-number">16.13.1.2.</span> <span class="toc-text"> Projcet Settings</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-353"><span class="toc-number">16.13.1.3.</span> <span class="toc-text"> Application</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-354"><span class="toc-number">16.13.2.</span> <span class="toc-text"> Linux 环境修改</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-355"><span class="toc-number">16.13.2.1.</span> <span class="toc-text"> 修改环境变量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-356"><span class="toc-number">16.13.2.2.</span> <span class="toc-text"> 修改 maven</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-357"><span class="toc-number">16.13.2.3.</span> <span class="toc-text"> 修改 server</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-358"><span class="toc-number">16.13.3.</span> <span class="toc-text"> sun.* 包缺失问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-359"><span class="toc-number">16.13.4.</span> <span class="toc-text"> 默认安全策略修改</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-360"><span class="toc-number">16.13.5.</span> <span class="toc-text"> JVM 参数调整</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-361"><span class="toc-number">16.13.6.</span> <span class="toc-text"> 字节码问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-362"><span class="toc-number">16.13.7.</span> <span class="toc-text"> Java 连接 redis 启动报错 Error redis clients jedis HostAndPort cant resolve localhost address</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-363"><span class="toc-number">16.13.8.</span> <span class="toc-text"> Resin 容器指定 JDK 1.8</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#java-%E5%AE%B9%E5%99%A8%E7%AE%80%E4%BB%8B"><span class="toc-number">17.</span> <span class="toc-text"> Java 容器简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-364"><span class="toc-number">17.1.</span> <span class="toc-text"> 1. 容器简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-365"><span class="toc-number">17.1.1.</span> <span class="toc-text"> 1.1. 数组与容器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-366"><span class="toc-number">17.1.2.</span> <span class="toc-text"> 1.2. 容器框架</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-367"><span class="toc-number">17.1.3.</span> <span class="toc-text"> 2.2. Iterable 和 Iterator</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-368"><span class="toc-number">17.1.4.</span> <span class="toc-text"> 2.3. Comparable 和 Comparator</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-369"><span class="toc-number">17.1.5.</span> <span class="toc-text"> 2.4. Cloneable</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-370"><span class="toc-number">17.1.6.</span> <span class="toc-text"> 2.5. fail-fast</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-371"><span class="toc-number">17.1.6.1.</span> <span class="toc-text"> fail-fast 的要点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-372"><span class="toc-number">17.1.6.2.</span> <span class="toc-text"> 解决 fail-fast</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-373"><span class="toc-number">17.2.</span> <span class="toc-text"> 3. 容器和线程安全</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#java-%E5%AE%B9%E5%99%A8%E4%B9%8B-list"><span class="toc-number">18.</span> <span class="toc-text"> Java 容器之 List</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-374"><span class="toc-number">18.1.</span> <span class="toc-text"> 1. List 简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-375"><span class="toc-number">18.1.1.</span> <span class="toc-text"> 1.1. ArrayList 和 LinkedList</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-376"><span class="toc-number">18.1.2.</span> <span class="toc-text"> 1.2. Vector 和 Stack</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-377"><span class="toc-number">18.2.</span> <span class="toc-text"> 2. ArrayList</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-378"><span class="toc-number">18.2.1.</span> <span class="toc-text"> 2.1. ArrayList 要点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-379"><span class="toc-number">18.2.2.</span> <span class="toc-text"> 2.2. ArrayList 原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-380"><span class="toc-number">18.2.2.1.</span> <span class="toc-text"> ArrayList 的数据结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-381"><span class="toc-number">18.2.2.2.</span> <span class="toc-text"> ArrayList 的序列化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-382"><span class="toc-number">18.2.2.3.</span> <span class="toc-text"> ArrayList 构造方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-383"><span class="toc-number">18.2.2.4.</span> <span class="toc-text"> ArrayList 访问元素</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-384"><span class="toc-number">18.2.2.5.</span> <span class="toc-text"> ArrayList 添加元素</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-385"><span class="toc-number">18.2.2.6.</span> <span class="toc-text"> ArrayList 删除元素</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-386"><span class="toc-number">18.2.2.7.</span> <span class="toc-text"> ArrayList 的 Fail-Fast</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-387"><span class="toc-number">18.3.</span> <span class="toc-text"> 3. LinkedList</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-388"><span class="toc-number">18.3.1.</span> <span class="toc-text"> 3.1. LinkedList 要点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-389"><span class="toc-number">18.3.2.</span> <span class="toc-text"> 3.2. LinkedList 原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-390"><span class="toc-number">18.3.2.1.</span> <span class="toc-text"> LinkedList 的数据结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-391"><span class="toc-number">18.3.2.2.</span> <span class="toc-text"> LinkedList 的序列化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-392"><span class="toc-number">18.3.2.3.</span> <span class="toc-text"> LinkedList 访问元素</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-393"><span class="toc-number">18.3.2.4.</span> <span class="toc-text"> LinkedList 添加元素</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-394"><span class="toc-number">18.3.2.5.</span> <span class="toc-text"> LinkedList 删除元素</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-395"><span class="toc-number">18.3.3.</span> <span class="toc-text"> 4.2. List.subList 问题点</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#java-%E5%AE%B9%E5%99%A8%E4%B9%8B-map"><span class="toc-number">19.</span> <span class="toc-text"> Java 容器之 Map</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-396"><span class="toc-number">19.1.</span> <span class="toc-text"> 1. Map 简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-397"><span class="toc-number">19.1.1.</span> <span class="toc-text"> 1.1. Map 架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-398"><span class="toc-number">19.1.2.</span> <span class="toc-text"> 1.2. Map 接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-399"><span class="toc-number">19.1.3.</span> <span class="toc-text"> 1.3. Map.Entry 接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-400"><span class="toc-number">19.1.4.</span> <span class="toc-text"> 1.4. AbstractMap 抽象类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-401"><span class="toc-number">19.1.5.</span> <span class="toc-text"> 1.5. SortedMap 接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-402"><span class="toc-number">19.1.6.</span> <span class="toc-text"> 1.6. NavigableMap 接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-403"><span class="toc-number">19.1.7.</span> <span class="toc-text"> 1.7. Dictionary 抽象类</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-404"><span class="toc-number">19.2.</span> <span class="toc-text"> 2. HashMap 类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-405"><span class="toc-number">19.2.1.</span> <span class="toc-text"> 2.1. HashMap 要点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-406"><span class="toc-number">19.2.2.</span> <span class="toc-text"> 2.2. HashMap 原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-407"><span class="toc-number">19.2.2.1.</span> <span class="toc-text"> HashMap 数据结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-408"><span class="toc-number">19.2.2.2.</span> <span class="toc-text"> HashMap 构造方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-409"><span class="toc-number">19.2.2.3.</span> <span class="toc-text"> put 方法的实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-410"><span class="toc-number">19.2.2.4.</span> <span class="toc-text"> get 方法的实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-411"><span class="toc-number">19.2.2.5.</span> <span class="toc-text"> hash 方法的实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-412"><span class="toc-number">19.2.2.6.</span> <span class="toc-text"> resize 的实现</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-413"><span class="toc-number">19.3.</span> <span class="toc-text"> 3. LinkedHashMap 类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-414"><span class="toc-number">19.3.1.</span> <span class="toc-text"> 3.1. LinkedHashMap 要点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-415"><span class="toc-number">19.3.2.</span> <span class="toc-text"> 3.2. LinkedHashMap 要点</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-416"><span class="toc-number">19.3.2.1.</span> <span class="toc-text"> LinkedHashMap 数据结构</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-417"><span class="toc-number">19.4.</span> <span class="toc-text"> 4. TreeMap 类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-418"><span class="toc-number">19.4.1.</span> <span class="toc-text"> 4.1. TreeMap 要点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-419"><span class="toc-number">19.4.2.</span> <span class="toc-text"> 4.2. TreeMap 原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-420"><span class="toc-number">19.4.2.1.</span> <span class="toc-text"> put 方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-421"><span class="toc-number">19.4.2.2.</span> <span class="toc-text"> get 方法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-422"><span class="toc-number">19.4.3.</span> <span class="toc-text"> 4.3. remove 方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-423"><span class="toc-number">19.4.4.</span> <span class="toc-text"> 4.4. TreeMap 示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-424"><span class="toc-number">19.5.</span> <span class="toc-text"> 5. WeakHashMap</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#java-%E5%AE%B9%E5%99%A8%E4%B9%8B-set"><span class="toc-number">20.</span> <span class="toc-text"> Java 容器之 Set</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-425"><span class="toc-number">20.1.</span> <span class="toc-text"> 1. Set 简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-426"><span class="toc-number">20.1.1.</span> <span class="toc-text"> 1.1. Set 接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-427"><span class="toc-number">20.1.2.</span> <span class="toc-text"> 1.2. SortedSet 接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-428"><span class="toc-number">20.1.3.</span> <span class="toc-text"> 1.3. NavigableSet 接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-429"><span class="toc-number">20.1.4.</span> <span class="toc-text"> 1.4. AbstractSet 抽象类</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-430"><span class="toc-number">20.2.</span> <span class="toc-text"> 2. HashSet 类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-431"><span class="toc-number">20.2.1.</span> <span class="toc-text"> 2.1. HashSet 要点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-432"><span class="toc-number">20.2.2.</span> <span class="toc-text"> 2.2. HashSet 原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-433"><span class="toc-number">20.2.3.</span> <span class="toc-text"> 3.1. TreeSet 要点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-434"><span class="toc-number">20.2.4.</span> <span class="toc-text"> 3.2. TreeSet 源码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-435"><span class="toc-number">20.3.</span> <span class="toc-text"> 4. LinkedHashSet 类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-436"><span class="toc-number">20.3.1.</span> <span class="toc-text"> 4.1. LinkedHashSet 要点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-437"><span class="toc-number">20.3.2.</span> <span class="toc-text"> 4.2. LinkedHashSet 原理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-438"><span class="toc-number">20.4.</span> <span class="toc-text"> 5. EnumSet 类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-439"><span class="toc-number">20.4.1.</span> <span class="toc-text"> 5.1. EnumSet 要点</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-440"><span class="toc-number">20.5.</span> <span class="toc-text"> 6. 要点总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#java-%E5%AE%B9%E5%99%A8%E4%B9%8B-queue"><span class="toc-number">21.</span> <span class="toc-text"> Java 容器之 Queue</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-441"><span class="toc-number">21.1.</span> <span class="toc-text"> 1. Queue 简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-442"><span class="toc-number">21.1.1.</span> <span class="toc-text"> 1.1. Queue 接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-443"><span class="toc-number">21.1.2.</span> <span class="toc-text"> 1.2. AbstractQueue 抽象类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-444"><span class="toc-number">21.1.3.</span> <span class="toc-text"> 1.3. Deque 接口</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-445"><span class="toc-number">21.2.</span> <span class="toc-text"> 2. ArrayDeque</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-446"><span class="toc-number">21.3.</span> <span class="toc-text"> 3. LinkedList</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-447"><span class="toc-number">21.4.</span> <span class="toc-text"> 4. PriorityQueue</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#java-io-%E6%A8%A1%E5%9E%8B"><span class="toc-number">22.</span> <span class="toc-text"> Java IO 模型</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-448"><span class="toc-number">22.1.</span> <span class="toc-text"> UNIX I&#x2F;O 模型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-449"><span class="toc-number">22.1.1.</span> <span class="toc-text"> 同步阻塞 I&#x2F;O</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-450"><span class="toc-number">22.1.2.</span> <span class="toc-text"> 同步非阻塞 I&#x2F;O</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-451"><span class="toc-number">22.1.3.</span> <span class="toc-text"> I&#x2F;O 多路复用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-452"><span class="toc-number">22.1.4.</span> <span class="toc-text"> 信号驱动 I&#x2F;O</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-453"><span class="toc-number">22.1.5.</span> <span class="toc-text"> 异步 I&#x2F;O</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-454"><span class="toc-number">22.2.</span> <span class="toc-text"> Java I&#x2F;O 模型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-455"><span class="toc-number">22.2.1.</span> <span class="toc-text"> BIO</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-456"><span class="toc-number">22.2.1.1.</span> <span class="toc-text"> BIO 简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-457"><span class="toc-number">22.2.1.2.</span> <span class="toc-text"> BIO 的性能缺陷</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-458"><span class="toc-number">22.2.2.</span> <span class="toc-text"> NIO</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-459"><span class="toc-number">22.2.2.1.</span> <span class="toc-text"> 使用缓冲区优化读写流</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-460"><span class="toc-number">22.2.2.2.</span> <span class="toc-text"> 使用 DirectBuffer 减少内存复制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-461"><span class="toc-number">22.2.2.3.</span> <span class="toc-text"> 优化 I&#x2F;O，避免阻塞</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-462"><span class="toc-number">22.2.3.</span> <span class="toc-text"> AIO</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-463"><span class="toc-number">22.3.</span> <span class="toc-text"> 传统 IO 流</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-464"><span class="toc-number">22.3.1.</span> <span class="toc-text"> 字节流</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-465"><span class="toc-number">22.3.1.1.</span> <span class="toc-text"> 文件字节流</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-466"><span class="toc-number">22.3.1.2.</span> <span class="toc-text"> 内存字节流</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-467"><span class="toc-number">22.3.1.3.</span> <span class="toc-text"> 管道流</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-468"><span class="toc-number">22.3.1.4.</span> <span class="toc-text"> 对象字节流</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-469"><span class="toc-number">22.3.1.5.</span> <span class="toc-text"> 数据操作流</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-470"><span class="toc-number">22.3.1.6.</span> <span class="toc-text"> 合并流</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-471"><span class="toc-number">22.3.2.</span> <span class="toc-text"> 字符流</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-472"><span class="toc-number">22.3.2.1.</span> <span class="toc-text"> 文件字符流</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-473"><span class="toc-number">22.3.2.2.</span> <span class="toc-text"> 字节流转换字符流</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-474"><span class="toc-number">22.3.3.</span> <span class="toc-text"> 字节流 vs. 字符流</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#java-nio"><span class="toc-number">23.</span> <span class="toc-text"> Java NIO</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-475"><span class="toc-number">23.1.</span> <span class="toc-text"> 一、NIO 简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-476"><span class="toc-number">23.1.1.</span> <span class="toc-text"> NIO 和 BIO 的区别</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-477"><span class="toc-number">23.1.1.1.</span> <span class="toc-text"> Non-blocking IO (非阻塞)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-478"><span class="toc-number">23.1.1.2.</span> <span class="toc-text"> Buffer (缓冲区)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-479"><span class="toc-number">23.1.1.3.</span> <span class="toc-text"> Channel (通道)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-480"><span class="toc-number">23.1.1.4.</span> <span class="toc-text"> Selector (选择器)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-481"><span class="toc-number">23.1.2.</span> <span class="toc-text"> NIO 的基本流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-482"><span class="toc-number">23.1.3.</span> <span class="toc-text"> NIO 核心组件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-483"><span class="toc-number">23.2.</span> <span class="toc-text"> 二、Channel (通道)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-484"><span class="toc-number">23.3.</span> <span class="toc-text"> 三、Buffer (缓冲区)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-485"><span class="toc-number">23.3.1.</span> <span class="toc-text"> 缓冲区状态变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-486"><span class="toc-number">23.3.2.</span> <span class="toc-text"> 文件 NIO 示例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-487"><span class="toc-number">23.3.3.</span> <span class="toc-text"> DirectBuffer</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-488"><span class="toc-number">23.4.</span> <span class="toc-text"> 四、Selector (选择器)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-489"><span class="toc-number">23.4.1.</span> <span class="toc-text"> 创建选择器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-490"><span class="toc-number">23.4.2.</span> <span class="toc-text"> 将通道注册到选择器上</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-491"><span class="toc-number">23.4.3.</span> <span class="toc-text"> 监听事件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-492"><span class="toc-number">23.4.4.</span> <span class="toc-text"> 获取到达的事件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-493"><span class="toc-number">23.4.5.</span> <span class="toc-text"> 事件循环</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-494"><span class="toc-number">23.4.6.</span> <span class="toc-text"> 套接字 NIO 示例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-495"><span class="toc-number">23.4.7.</span> <span class="toc-text"> 内存映射文件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-496"><span class="toc-number">23.5.</span> <span class="toc-text"> 五、NIO vs. BIO</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-java-%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">24.</span> <span class="toc-text"> 深入理解 Java 序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-497"><span class="toc-number">24.1.</span> <span class="toc-text"> 1. Java 序列化简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-498"><span class="toc-number">24.2.</span> <span class="toc-text"> 2. Java 序列化和反序列化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-499"><span class="toc-number">24.3.</span> <span class="toc-text"> 3. Serializable 接口</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-500"><span class="toc-number">24.3.1.</span> <span class="toc-text"> 3.1. serialVersionUID</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-501"><span class="toc-number">24.3.2.</span> <span class="toc-text"> 3.2. 默认序列化机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-502"><span class="toc-number">24.3.3.</span> <span class="toc-text"> 3.3. transient</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-503"><span class="toc-number">24.4.</span> <span class="toc-text"> 4. Externalizable 接口</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-504"><span class="toc-number">24.4.1.</span> <span class="toc-text"> 4.1. Externalizable 接口的替代方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-505"><span class="toc-number">24.4.2.</span> <span class="toc-text"> 4.2. readResolve () 方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-506"><span class="toc-number">24.5.</span> <span class="toc-text"> 5. Java 序列化问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-507"><span class="toc-number">24.6.</span> <span class="toc-text"> 6. Java 序列化的缺陷</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-508"><span class="toc-number">24.7.</span> <span class="toc-text"> 7. 序列化技术选型</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#java-%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B"><span class="toc-number">25.</span> <span class="toc-text"> Java 网络编程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-509"><span class="toc-number">25.1.</span> <span class="toc-text"> 一、Socket 和 ServerSocket</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-510"><span class="toc-number">25.1.1.</span> <span class="toc-text"> ServerSocket</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-511"><span class="toc-number">25.1.1.1.</span> <span class="toc-text"> ServerSocket 构造方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-512"><span class="toc-number">25.1.1.2.</span> <span class="toc-text"> ServerSocket 常用方法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-513"><span class="toc-number">25.1.2.</span> <span class="toc-text"> Socket</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-514"><span class="toc-number">25.1.2.1.</span> <span class="toc-text"> Socket 构造方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-515"><span class="toc-number">25.1.2.2.</span> <span class="toc-text"> Socket 常用方法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-516"><span class="toc-number">25.1.3.</span> <span class="toc-text"> Socket 通信示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-517"><span class="toc-number">25.2.</span> <span class="toc-text"> 二、DatagramSocket 和 DatagramPacket</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-518"><span class="toc-number">25.3.</span> <span class="toc-text"> 三、InetAddress</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-519"><span class="toc-number">25.4.</span> <span class="toc-text"> 四、URL</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#java-io-%E5%B7%A5%E5%85%B7%E7%B1%BB"><span class="toc-number">26.</span> <span class="toc-text"> Java IO 工具类</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-520"><span class="toc-number">26.1.</span> <span class="toc-text"> 一、File</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-521"><span class="toc-number">26.1.1.</span> <span class="toc-text"> createNewFille</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-522"><span class="toc-number">26.1.2.</span> <span class="toc-text"> mkdir</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-523"><span class="toc-number">26.1.3.</span> <span class="toc-text"> delete</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-524"><span class="toc-number">26.1.4.</span> <span class="toc-text"> list 和 listFiles</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-525"><span class="toc-number">26.2.</span> <span class="toc-text"> 二、RandomAccessFile</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-526"><span class="toc-number">26.2.1.</span> <span class="toc-text"> RandomAccessFile 写操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-527"><span class="toc-number">26.2.2.</span> <span class="toc-text"> RandomAccessFile 读操作</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-528"><span class="toc-number">26.3.</span> <span class="toc-text"> 三、System</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-529"><span class="toc-number">26.4.</span> <span class="toc-text"> 四、Scanner</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#java-%E5%B9%B6%E5%8F%91%E7%AE%80%E4%BB%8B"><span class="toc-number">27.</span> <span class="toc-text"> Java 并发简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-530"><span class="toc-number">27.1.</span> <span class="toc-text"> 1. 并发概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-531"><span class="toc-number">27.1.1.</span> <span class="toc-text"> 1.1. 并发和并行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-532"><span class="toc-number">27.1.2.</span> <span class="toc-text"> 1.2. 同步和异步</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-533"><span class="toc-number">27.1.3.</span> <span class="toc-text"> 1.3. 阻塞和非阻塞</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-534"><span class="toc-number">27.1.4.</span> <span class="toc-text"> 1.4. 进程和线程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-535"><span class="toc-number">27.1.5.</span> <span class="toc-text"> 1.5. 竞态条件和临界区</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-536"><span class="toc-number">27.1.6.</span> <span class="toc-text"> 1.6. 管程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-537"><span class="toc-number">27.2.</span> <span class="toc-text"> 2. 并发的特点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-538"><span class="toc-number">27.2.1.</span> <span class="toc-text"> 2.1. 提升资源利用率</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-539"><span class="toc-number">27.2.2.</span> <span class="toc-text"> 2.2. 程序响应更快</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-540"><span class="toc-number">27.2.3.</span> <span class="toc-text"> 2.3. 并发的问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-541"><span class="toc-number">27.3.</span> <span class="toc-text"> 3. 安全性问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-542"><span class="toc-number">27.3.1.</span> <span class="toc-text"> 3.1. 缓存导致的可见性问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-543"><span class="toc-number">27.3.2.</span> <span class="toc-text"> 3.2. 线程切换带来的原子性问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-544"><span class="toc-number">27.3.3.</span> <span class="toc-text"> 3.3. 编译优化带来的有序性问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-545"><span class="toc-number">27.3.4.</span> <span class="toc-text"> 3.4. 保证并发安全的思路</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-546"><span class="toc-number">27.3.4.1.</span> <span class="toc-text"> 互斥同步（阻塞同步）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-547"><span class="toc-number">27.3.4.2.</span> <span class="toc-text"> 非阻塞同步</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-548"><span class="toc-number">27.3.4.3.</span> <span class="toc-text"> 无同步</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-549"><span class="toc-number">27.4.</span> <span class="toc-text"> 4. 活跃性问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-550"><span class="toc-number">27.4.1.</span> <span class="toc-text"> 4.1. 死锁（Deadlock）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-551"><span class="toc-number">27.4.1.1.</span> <span class="toc-text"> 什么是死锁</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-552"><span class="toc-number">27.4.1.2.</span> <span class="toc-text"> 避免死锁</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-553"><span class="toc-number">27.4.2.</span> <span class="toc-text"> 4.2. 活锁（Livelock）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-554"><span class="toc-number">27.4.2.1.</span> <span class="toc-text"> 什么是活锁</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-555"><span class="toc-number">27.4.2.2.</span> <span class="toc-text"> 避免活锁</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-556"><span class="toc-number">27.4.3.</span> <span class="toc-text"> 4.3. 饥饿（Starvation）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-557"><span class="toc-number">27.4.3.1.</span> <span class="toc-text"> 什么是饥饿</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-558"><span class="toc-number">27.4.3.2.</span> <span class="toc-text"> 解决饥饿</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-559"><span class="toc-number">27.5.</span> <span class="toc-text"> 5. 性能问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-560"><span class="toc-number">27.5.1.</span> <span class="toc-text"> 5.1. 上下文切换</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-561"><span class="toc-number">27.5.1.1.</span> <span class="toc-text"> 什么是上下文切换？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-562"><span class="toc-number">27.5.1.2.</span> <span class="toc-text"> 减少上下文切换的方法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-563"><span class="toc-number">27.5.2.</span> <span class="toc-text"> 5.2. 资源限制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-564"><span class="toc-number">27.5.2.1.</span> <span class="toc-text"> 什么是资源限制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-565"><span class="toc-number">27.5.2.2.</span> <span class="toc-text"> 资源限制引发的问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-566"><span class="toc-number">27.5.2.3.</span> <span class="toc-text"> 如何解决资源限制的问题</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-567"><span class="toc-number">27.6.</span> <span class="toc-text"> 6. 小结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#java-%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80"><span class="toc-number">28.</span> <span class="toc-text"> Java 线程基础</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-568"><span class="toc-number">28.1.</span> <span class="toc-text"> 1. 线程简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-569"><span class="toc-number">28.1.1.</span> <span class="toc-text"> 1.1. 什么是进程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-570"><span class="toc-number">28.1.2.</span> <span class="toc-text"> 1.2. 什么是线程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-571"><span class="toc-number">28.1.3.</span> <span class="toc-text"> 1.3. 进程和线程的区别</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-572"><span class="toc-number">28.2.</span> <span class="toc-text"> 2. 创建线程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-573"><span class="toc-number">28.2.1.</span> <span class="toc-text"> 2.1. Thread</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-574"><span class="toc-number">28.2.2.</span> <span class="toc-text"> 2.2. Runnable</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-575"><span class="toc-number">28.2.3.</span> <span class="toc-text"> 2.3. Callable、Future、FutureTask</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-576"><span class="toc-number">28.2.3.1.</span> <span class="toc-text"> Callable</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-577"><span class="toc-number">28.2.3.2.</span> <span class="toc-text"> Future</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-578"><span class="toc-number">28.2.3.3.</span> <span class="toc-text"> FutureTask</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-579"><span class="toc-number">28.2.3.4.</span> <span class="toc-text"> Callable + Future + FutureTask 示例</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-580"><span class="toc-number">28.3.</span> <span class="toc-text"> 3. 线程基本用法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-581"><span class="toc-number">28.3.1.</span> <span class="toc-text"> 3.1. 线程休眠</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-582"><span class="toc-number">28.3.2.</span> <span class="toc-text"> 3.2. 线程礼让</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-583"><span class="toc-number">28.3.3.</span> <span class="toc-text"> 3.3. 终止线程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-584"><span class="toc-number">28.3.4.</span> <span class="toc-text"> 3.4. 守护线程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-585"><span class="toc-number">28.4.</span> <span class="toc-text"> 4. 线程通信</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-586"><span class="toc-number">28.4.1.</span> <span class="toc-text"> 4.1. wait&#x2F;notify&#x2F;notifyAll</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-587"><span class="toc-number">28.4.2.</span> <span class="toc-text"> 4.2. join</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-588"><span class="toc-number">28.4.3.</span> <span class="toc-text"> 4.3. 管道</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-589"><span class="toc-number">28.5.</span> <span class="toc-text"> 5. 线程生命周期</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-590"><span class="toc-number">28.6.</span> <span class="toc-text"> 6. 线程常见问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-591"><span class="toc-number">28.6.1.</span> <span class="toc-text"> 6.1. sleep、yield、join 方法有什么区别</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-592"><span class="toc-number">28.6.1.1.</span> <span class="toc-text"> 同步静态方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-593"><span class="toc-number">28.6.1.2.</span> <span class="toc-text"> 同步代码块</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-594"><span class="toc-number">28.6.2.</span> <span class="toc-text"> 2.2. synchronized 的原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-595"><span class="toc-number">28.6.2.1.</span> <span class="toc-text"> 同步代码块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-596"><span class="toc-number">28.6.2.2.</span> <span class="toc-text"> 同步方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-597"><span class="toc-number">28.6.2.3.</span> <span class="toc-text"> Monitor</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-598"><span class="toc-number">28.6.3.</span> <span class="toc-text"> 2.3. synchronized 的优化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-599"><span class="toc-number">28.6.3.1.</span> <span class="toc-text"> Java 对象头</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-600"><span class="toc-number">28.6.3.2.</span> <span class="toc-text"> 偏向锁</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-601"><span class="toc-number">28.6.3.3.</span> <span class="toc-text"> 轻量级锁</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-602"><span class="toc-number">28.6.3.4.</span> <span class="toc-text"> 锁消除 &#x2F; 锁粗化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-603"><span class="toc-number">28.6.3.5.</span> <span class="toc-text"> 自旋锁</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-604"><span class="toc-number">28.6.4.</span> <span class="toc-text"> 2.4. synchronized 的误区</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-605"><span class="toc-number">28.6.4.1.</span> <span class="toc-text"> synchronized 使用范围不当导致的错误</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-606"><span class="toc-number">28.6.4.2.</span> <span class="toc-text"> synchronized 保护对象不对导致的错误</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-607"><span class="toc-number">28.6.4.3.</span> <span class="toc-text"> 锁粒度导致的问题</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-608"><span class="toc-number">28.7.</span> <span class="toc-text"> 3. volatile</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-609"><span class="toc-number">28.7.1.</span> <span class="toc-text"> 3.1. volatile 的要点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-610"><span class="toc-number">28.7.2.</span> <span class="toc-text"> 3.2. volatile 的应用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-611"><span class="toc-number">28.7.3.</span> <span class="toc-text"> 3.3. volatile 的原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-612"><span class="toc-number">28.7.4.</span> <span class="toc-text"> 3.4. volatile 的问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-613"><span class="toc-number">28.8.</span> <span class="toc-text"> 4. CAS</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-614"><span class="toc-number">28.8.1.</span> <span class="toc-text"> 4.1. CAS 的要点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-615"><span class="toc-number">28.8.2.</span> <span class="toc-text"> 4.2. CAS 的应用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-616"><span class="toc-number">28.8.2.1.</span> <span class="toc-text"> 原子类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-617"><span class="toc-number">28.8.2.2.</span> <span class="toc-text"> 自旋锁</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-618"><span class="toc-number">28.8.3.</span> <span class="toc-text"> 4.3. CAS 的原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-619"><span class="toc-number">28.8.4.</span> <span class="toc-text"> 4.4. CAS 的问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-620"><span class="toc-number">28.8.4.1.</span> <span class="toc-text"> ABA 问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-621"><span class="toc-number">28.8.4.2.</span> <span class="toc-text"> 循环时间长开销大</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-622"><span class="toc-number">28.8.4.3.</span> <span class="toc-text"> 只能保证一个共享变量的原子性</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-623"><span class="toc-number">28.9.</span> <span class="toc-text"> 5. ThreadLocal</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-624"><span class="toc-number">28.9.1.</span> <span class="toc-text"> 5.1. ThreadLocal 的应用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-625"><span class="toc-number">28.9.2.</span> <span class="toc-text"> 5.2. ThreadLocal 的原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-626"><span class="toc-number">28.9.2.1.</span> <span class="toc-text"> 存储结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-627"><span class="toc-number">28.9.2.2.</span> <span class="toc-text"> 如何解决 Hash 冲突</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-628"><span class="toc-number">28.9.2.3.</span> <span class="toc-text"> 内存泄漏问题</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-629"><span class="toc-number">28.9.3.</span> <span class="toc-text"> 5.3. ThreadLocal 的误区</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-630"><span class="toc-number">28.9.3.1.</span> <span class="toc-text"> ThreadLocal 错误案例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-631"><span class="toc-number">28.9.3.2.</span> <span class="toc-text"> ThreadLocal 错误案例修正</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-632"><span class="toc-number">28.9.4.</span> <span class="toc-text"> 5.4. InheritableThreadLocal</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-java-%E5%B9%B6%E5%8F%91%E9%94%81"><span class="toc-number">29.</span> <span class="toc-text"> 深入理解 Java 并发锁</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-633"><span class="toc-number">29.1.</span> <span class="toc-text"> 1. 并发锁简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-634"><span class="toc-number">29.1.1.</span> <span class="toc-text"> 1.1. 可重入锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-635"><span class="toc-number">29.1.2.</span> <span class="toc-text"> 1.2. 公平锁与非公平锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-636"><span class="toc-number">29.1.3.</span> <span class="toc-text"> 1.3. 独享锁与共享锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-637"><span class="toc-number">29.1.4.</span> <span class="toc-text"> 1.4. 悲观锁与乐观锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-638"><span class="toc-number">29.1.5.</span> <span class="toc-text"> 1.5. 偏向锁、轻量级锁、重量级锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-639"><span class="toc-number">29.1.6.</span> <span class="toc-text"> 1.6. 分段锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-640"><span class="toc-number">29.1.7.</span> <span class="toc-text"> 1.7. 显示锁和内置锁</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-641"><span class="toc-number">29.2.</span> <span class="toc-text"> 2. Lock 和 Condition</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-642"><span class="toc-number">29.2.1.</span> <span class="toc-text"> 2.1. 为何引入 Lock 和 Condition</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-643"><span class="toc-number">29.2.2.</span> <span class="toc-text"> 2.2. Lock 接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-644"><span class="toc-number">29.2.3.</span> <span class="toc-text"> 2.3. Condition</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-645"><span class="toc-number">29.2.3.1.</span> <span class="toc-text"> Condition 的特性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-646"><span class="toc-number">29.2.3.2.</span> <span class="toc-text"> Condition 的用法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-647"><span class="toc-number">29.3.</span> <span class="toc-text"> 3. ReentrantLock</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-648"><span class="toc-number">29.3.1.</span> <span class="toc-text"> 3.1. ReentrantLock 的特性</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-649"><span class="toc-number">29.3.1.1.</span> <span class="toc-text"> lock 和 unlock 方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-650"><span class="toc-number">29.3.1.2.</span> <span class="toc-text"> tryLock 方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-651"><span class="toc-number">29.3.1.3.</span> <span class="toc-text"> lockInterruptibly 方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-652"><span class="toc-number">29.3.1.4.</span> <span class="toc-text"> newCondition 方法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-653"><span class="toc-number">29.3.2.</span> <span class="toc-text"> 3.3. ReentrantLock 的原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-654"><span class="toc-number">29.3.2.1.</span> <span class="toc-text"> ReentrantLock 的可见性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-655"><span class="toc-number">29.3.2.2.</span> <span class="toc-text"> ReentrantLock 的数据结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-656"><span class="toc-number">29.3.2.3.</span> <span class="toc-text"> ReentrantLock 的获取锁和释放锁</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-657"><span class="toc-number">29.3.2.4.</span> <span class="toc-text"> 公平锁和非公平锁</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-658"><span class="toc-number">29.4.</span> <span class="toc-text"> 4. ReentrantReadWriteLock</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-659"><span class="toc-number">29.4.1.</span> <span class="toc-text"> 4.1. ReentrantReadWriteLock 的特性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-660"><span class="toc-number">29.4.2.</span> <span class="toc-text"> 4.2. ReentrantReadWriteLock 的用法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-661"><span class="toc-number">29.4.2.1.</span> <span class="toc-text"> ReentrantReadWriteLock 的构造方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-662"><span class="toc-number">29.4.2.2.</span> <span class="toc-text"> ReentrantReadWriteLock 的使用实例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-663"><span class="toc-number">29.4.3.</span> <span class="toc-text"> 4.3. ReentrantReadWriteLock 的原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-664"><span class="toc-number">29.4.3.1.</span> <span class="toc-text"> ReentrantReadWriteLock 的数据结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-665"><span class="toc-number">29.4.3.2.</span> <span class="toc-text"> ReentrantReadWriteLock 的获取锁和释放锁</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-666"><span class="toc-number">29.5.</span> <span class="toc-text"> 5. StampedLock</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-667"><span class="toc-number">29.6.</span> <span class="toc-text"> 6. AQS</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-668"><span class="toc-number">29.6.1.</span> <span class="toc-text"> 6.1. AQS 的要点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-669"><span class="toc-number">29.6.2.</span> <span class="toc-text"> 6.2. AQS 的应用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-670"><span class="toc-number">29.6.2.1.</span> <span class="toc-text"> 独享锁 API</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-671"><span class="toc-number">29.6.3.</span> <span class="toc-text"> 6.3. AQS 的原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-672"><span class="toc-number">29.6.3.1.</span> <span class="toc-text"> AQS 的数据结构</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-673"><span class="toc-number">29.6.4.</span> <span class="toc-text"> 2.2.  AtomicInteger  实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-674"><span class="toc-number">29.7.</span> <span class="toc-text"> 3. 引用类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-675"><span class="toc-number">29.8.</span> <span class="toc-text"> 4. 数组类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-676"><span class="toc-number">29.9.</span> <span class="toc-text"> 5. 属性更新器类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-677"><span class="toc-number">29.10.</span> <span class="toc-text"> 6. 原子化的累加器</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#java-%E5%B9%B6%E5%8F%91%E5%92%8C%E5%AE%B9%E5%99%A8"><span class="toc-number">30.</span> <span class="toc-text"> Java 并发和容器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-678"><span class="toc-number">30.1.</span> <span class="toc-text"> 1. 同步容器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-679"><span class="toc-number">30.1.1.</span> <span class="toc-text"> 1.1. 同步容器简介</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-680"><span class="toc-number">30.2.</span> <span class="toc-text"> 2. 并发容器简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-681"><span class="toc-number">30.2.1.</span> <span class="toc-text"> 2.1. 并发场景下的 Map</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-682"><span class="toc-number">30.2.2.</span> <span class="toc-text"> 2.2. 并发场景下的 List</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-683"><span class="toc-number">30.3.</span> <span class="toc-text"> 3. Map</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-684"><span class="toc-number">30.3.1.</span> <span class="toc-text"> 3.1. ConcurrentHashMap</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-685"><span class="toc-number">30.3.1.1.</span> <span class="toc-text">  ConcurrentHashMap  的特性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-686"><span class="toc-number">30.3.1.2.</span> <span class="toc-text"> ConcurrentHashMap 的用法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-687"><span class="toc-number">30.3.1.3.</span> <span class="toc-text"> ConcurrentHashMap 的原理</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#-688"><span class="toc-number">30.3.1.3.1.</span> <span class="toc-text"> Java 1.7 的实现</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-689"><span class="toc-number">30.3.1.3.2.</span> <span class="toc-text"> Java 1.8 的实现</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-690"><span class="toc-number">30.3.1.4.</span> <span class="toc-text"> ConcurrentHashMap 的实战</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#-691"><span class="toc-number">30.3.1.4.1.</span> <span class="toc-text"> ConcurrentHashMap 错误示例</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-692"><span class="toc-number">30.3.1.4.2.</span> <span class="toc-text"> ConcurrentHashMap 错误示例修正 1.0 版</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-693"><span class="toc-number">30.3.1.4.3.</span> <span class="toc-text"> ConcurrentHashMap 错误示例修正 2.0 版</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-694"><span class="toc-number">30.4.</span> <span class="toc-text"> 4. List</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-695"><span class="toc-number">30.4.1.</span> <span class="toc-text"> 4.1. CopyOnWriteArrayList</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-696"><span class="toc-number">30.4.1.1.</span> <span class="toc-text"> CopyOnWriteArrayList 原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-697"><span class="toc-number">30.4.1.2.</span> <span class="toc-text"> CopyOnWriteArrayList 示例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-698"><span class="toc-number">30.4.1.3.</span> <span class="toc-text"> CopyOnWriteArrayList 实战</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-699"><span class="toc-number">30.5.</span> <span class="toc-text"> 5. Set</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-700"><span class="toc-number">30.6.</span> <span class="toc-text"> 6. Queue</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-701"><span class="toc-number">30.6.1.</span> <span class="toc-text"> 6.1. BlockingQueue</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-702"><span class="toc-number">30.6.2.</span> <span class="toc-text"> 6.2. PriorityBlockingQueue 类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-703"><span class="toc-number">30.6.2.1.</span> <span class="toc-text"> PriorityBlockingQueue 要点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-704"><span class="toc-number">30.6.2.2.</span> <span class="toc-text"> PriorityBlockingQueue 原理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-705"><span class="toc-number">30.6.3.</span> <span class="toc-text"> 6.3. ArrayBlockingQueue 类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-706"><span class="toc-number">30.6.3.1.</span> <span class="toc-text"> ArrayBlockingQueue 要点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-707"><span class="toc-number">30.6.3.2.</span> <span class="toc-text"> ArrayBlockingQueue 原理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-708"><span class="toc-number">30.6.4.</span> <span class="toc-text"> 6.4. LinkedBlockingQueue 类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-709"><span class="toc-number">30.6.4.1.</span> <span class="toc-text"> LinkedBlockingQueue 要点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-710"><span class="toc-number">30.6.4.2.</span> <span class="toc-text"> LinkedBlockingQueue 原理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-711"><span class="toc-number">30.6.5.</span> <span class="toc-text"> 6.5. SynchronousQueue 类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-712"><span class="toc-number">30.6.6.</span> <span class="toc-text"> 6.6. ConcurrentLinkedDeque 类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-713"><span class="toc-number">30.6.7.</span> <span class="toc-text"> 6.7. Queue 的并发应用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#java-%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="toc-number">31.</span> <span class="toc-text"> Java 线程池</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-714"><span class="toc-number">31.1.</span> <span class="toc-text"> 1. 简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-715"><span class="toc-number">31.1.1.</span> <span class="toc-text"> 1.1. 什么是线程池</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-716"><span class="toc-number">31.1.2.</span> <span class="toc-text"> 1.2. 为什么要用线程池</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-717"><span class="toc-number">31.2.</span> <span class="toc-text"> 2. Executor 框架</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-718"><span class="toc-number">31.2.1.</span> <span class="toc-text"> 2.1. 核心 API 概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-719"><span class="toc-number">31.2.2.</span> <span class="toc-text"> 2.3. ExecutorService</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-720"><span class="toc-number">31.2.3.</span> <span class="toc-text"> 2.4. ScheduledExecutorService</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-721"><span class="toc-number">31.3.</span> <span class="toc-text"> 3. ThreadPoolExecutor</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-722"><span class="toc-number">31.3.1.</span> <span class="toc-text"> 3.1. 重要字段</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-723"><span class="toc-number">31.3.2.</span> <span class="toc-text"> 3.3. execute 方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-724"><span class="toc-number">31.3.3.</span> <span class="toc-text"> 3.4. 其他重要方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-725"><span class="toc-number">31.3.4.</span> <span class="toc-text"> 3.5. 使用示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-726"><span class="toc-number">31.4.</span> <span class="toc-text"> 4. Executors</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-727"><span class="toc-number">31.4.1.</span> <span class="toc-text"> 4.1. newSingleThreadExecutor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-728"><span class="toc-number">31.4.2.</span> <span class="toc-text"> 4.2. newFixedThreadPool</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-729"><span class="toc-number">31.4.3.</span> <span class="toc-text"> 4.3. newCachedThreadPool</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-730"><span class="toc-number">31.4.4.</span> <span class="toc-text"> 4.4. newScheduleThreadPool</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-731"><span class="toc-number">31.4.5.</span> <span class="toc-text"> 4.5. newWorkStealingPool</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-732"><span class="toc-number">31.5.</span> <span class="toc-text"> 5. 线程池最佳实践</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-733"><span class="toc-number">31.5.1.</span> <span class="toc-text"> 5.1. 计算线程数量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-734"><span class="toc-number">31.5.2.</span> <span class="toc-text"> 5.2. 建议使用有界阻塞队列</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-735"><span class="toc-number">31.5.3.</span> <span class="toc-text"> 5.3. 重要任务应该自定义拒绝策略</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#java-%E5%B9%B6%E5%8F%91%E5%B7%A5%E5%85%B7%E7%B1%BB"><span class="toc-number">32.</span> <span class="toc-text"> Java 并发工具类</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-736"><span class="toc-number">32.1.</span> <span class="toc-text"> 1. CountDownLatch</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-737"><span class="toc-number">32.2.</span> <span class="toc-text"> 2. CyclicBarrier</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-738"><span class="toc-number">32.3.</span> <span class="toc-text"> 3. Semaphore</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-739"><span class="toc-number">32.4.</span> <span class="toc-text"> 4. 总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#java-%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B"><span class="toc-number">33.</span> <span class="toc-text"> Java 内存模型</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-740"><span class="toc-number">33.1.</span> <span class="toc-text"> 1. 物理内存模型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-741"><span class="toc-number">33.1.1.</span> <span class="toc-text"> 1.1. 硬件处理效率</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-742"><span class="toc-number">33.1.2.</span> <span class="toc-text"> 1.2. 缓存一致性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-743"><span class="toc-number">33.1.3.</span> <span class="toc-text"> 1.3. 代码乱序执行优化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-744"><span class="toc-number">33.2.</span> <span class="toc-text"> 2. Java 内存模型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-745"><span class="toc-number">33.2.1.</span> <span class="toc-text"> 2.1. 主内存和工作内存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-746"><span class="toc-number">33.2.2.</span> <span class="toc-text"> 2.2. JMM 内存操作的问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-747"><span class="toc-number">33.2.3.</span> <span class="toc-text"> 2.3. 内存间交互操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-748"><span class="toc-number">33.2.4.</span> <span class="toc-text"> 2.4. 并发安全特性</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-749"><span class="toc-number">33.2.4.1.</span> <span class="toc-text"> 原子性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-750"><span class="toc-number">33.2.4.2.</span> <span class="toc-text"> 可见性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-751"><span class="toc-number">33.2.4.3.</span> <span class="toc-text"> 有序性</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-752"><span class="toc-number">33.3.</span> <span class="toc-text"> 3. Happens-Before</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-753"><span class="toc-number">33.4.</span> <span class="toc-text"> 4. 内存屏障</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-754"><span class="toc-number">33.5.</span> <span class="toc-text"> 5. volatile</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-755"><span class="toc-number">33.5.0.1.</span> <span class="toc-text"> volatile 变量的特性</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#-756"><span class="toc-number">33.5.0.1.1.</span> <span class="toc-text"> 保证变量对所有线程的可见性</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-757"><span class="toc-number">33.5.0.1.2.</span> <span class="toc-text"> 语义 2 禁止进行指令重排序</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-758"><span class="toc-number">33.5.0.2.</span> <span class="toc-text"> volatile 的原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-759"><span class="toc-number">33.5.0.3.</span> <span class="toc-text"> volatile 的使用场景</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-760"><span class="toc-number">33.6.</span> <span class="toc-text"> 6. synchronized</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-761"><span class="toc-number">33.6.1.</span> <span class="toc-text"> 6.1. long 和 double 变量的特殊规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-762"><span class="toc-number">33.6.2.</span> <span class="toc-text"> 6.2. final 型量的特殊规则</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#vm-%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84"><span class="toc-number">34.</span> <span class="toc-text"> VM 体系结构</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-763"><span class="toc-number">34.1.</span> <span class="toc-text"> 1. JVM 简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-764"><span class="toc-number">34.1.1.</span> <span class="toc-text"> 1.1. 计算机体系结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-765"><span class="toc-number">34.1.2.</span> <span class="toc-text"> 1.2. JVM 体系结构简介</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-766"><span class="toc-number">34.2.</span> <span class="toc-text"> 2. Hotspot 架构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-767"><span class="toc-number">34.2.1.</span> <span class="toc-text"> 2.1. Hotspot 关键组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-768"><span class="toc-number">34.2.2.</span> <span class="toc-text"> 2.2. 性能指标</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#java-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86"><span class="toc-number">35.</span> <span class="toc-text"> Java 内存管理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-769"><span class="toc-number">35.1.</span> <span class="toc-text"> 1. 内存简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-770"><span class="toc-number">35.1.1.</span> <span class="toc-text"> 1.1. 物理内存和虚拟内存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-771"><span class="toc-number">35.1.2.</span> <span class="toc-text"> 1.2. 内核空间和用户空间</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-772"><span class="toc-number">35.1.3.</span> <span class="toc-text"> 1.3. 使用内存的 Java 组件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-773"><span class="toc-number">35.2.</span> <span class="toc-text"> 2. 运行时数据区域</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-774"><span class="toc-number">35.2.1.</span> <span class="toc-text"> 2.1. 程序计数器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-775"><span class="toc-number">35.2.2.</span> <span class="toc-text"> 2.2. Java 虚拟机栈</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-776"><span class="toc-number">35.2.3.</span> <span class="toc-text"> 2.3. 本地方法栈</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-777"><span class="toc-number">35.2.4.</span> <span class="toc-text"> 2.4. Java 堆</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-778"><span class="toc-number">35.2.5.</span> <span class="toc-text"> 2.5. 方法区</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-779"><span class="toc-number">35.2.6.</span> <span class="toc-text"> 2.6. 运行时常量池</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-780"><span class="toc-number">35.2.7.</span> <span class="toc-text"> 2.7. 直接内存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-781"><span class="toc-number">35.2.8.</span> <span class="toc-text"> 2.8. Java 内存区域对比</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-782"><span class="toc-number">35.3.</span> <span class="toc-text"> 3. JVM 运行原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-783"><span class="toc-number">35.4.</span> <span class="toc-text"> 4. OutOfMemoryError</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-784"><span class="toc-number">35.4.1.</span> <span class="toc-text"> 4.1. 什么是 OutOfMemoryError</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-785"><span class="toc-number">35.4.2.</span> <span class="toc-text"> 4.2. 堆空间溢出</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-786"><span class="toc-number">35.4.2.1.</span> <span class="toc-text"> Java heap space 分析步骤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-787"><span class="toc-number">35.4.2.2.</span> <span class="toc-text"> 内存泄漏</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-788"><span class="toc-number">35.4.2.3.</span> <span class="toc-text"> 内存溢出</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-789"><span class="toc-number">35.4.3.</span> <span class="toc-text"> 4.3. GC 开销超过限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-790"><span class="toc-number">35.4.4.</span> <span class="toc-text"> 4.4. 永久代空间不足</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-791"><span class="toc-number">35.4.4.1.</span> <span class="toc-text"> 初始化时永久代空间不足</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-792"><span class="toc-number">35.4.4.2.</span> <span class="toc-text"> 重部署时永久代空间不足</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-793"><span class="toc-number">35.4.4.3.</span> <span class="toc-text"> PermGen space 解决方案</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-794"><span class="toc-number">35.4.5.</span> <span class="toc-text"> 4.5. 元数据区空间不足</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-795"><span class="toc-number">35.4.6.</span> <span class="toc-text"> 4.6. 无法新建本地线程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-796"><span class="toc-number">35.4.7.</span> <span class="toc-text"> 4.7. 直接内存溢出</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-797"><span class="toc-number">35.5.</span> <span class="toc-text"> 5. StackOverflowError</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#jvm-%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86"><span class="toc-number">36.</span> <span class="toc-text"> JVM 垃圾收集</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-798"><span class="toc-number">36.1.</span> <span class="toc-text"> 1. 对象活着吗</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-799"><span class="toc-number">36.1.1.</span> <span class="toc-text"> 1.1. 引用计数算法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-800"><span class="toc-number">36.1.2.</span> <span class="toc-text"> 1.2. 可达性分析算法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-801"><span class="toc-number">36.1.3.</span> <span class="toc-text"> 1.3. 引用类型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-802"><span class="toc-number">36.1.3.1.</span> <span class="toc-text"> 强引用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-803"><span class="toc-number">36.1.3.2.</span> <span class="toc-text"> 软引用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-804"><span class="toc-number">36.1.3.3.</span> <span class="toc-text"> 弱引用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-805"><span class="toc-number">36.1.3.4.</span> <span class="toc-text"> 虚引用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-806"><span class="toc-number">36.1.4.</span> <span class="toc-text"> 1.4. 方法区的回收</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-807"><span class="toc-number">36.1.5.</span> <span class="toc-text"> 1.5. finalize()</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-808"><span class="toc-number">36.2.</span> <span class="toc-text"> 2. 垃圾收集算法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-809"><span class="toc-number">36.2.1.</span> <span class="toc-text"> 2.1. 垃圾收集性能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-810"><span class="toc-number">36.2.2.</span> <span class="toc-text"> 2.2. 标记 - 清除（Mark-Sweep）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-811"><span class="toc-number">36.2.3.</span> <span class="toc-text"> 2.3. 标记 - 整理（Mark-Compact）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-812"><span class="toc-number">36.2.4.</span> <span class="toc-text"> 2.4. 复制（Copying）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-813"><span class="toc-number">36.2.5.</span> <span class="toc-text"> 2.5. 分代收集</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-814"><span class="toc-number">36.2.5.1.</span> <span class="toc-text"> 新生代</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-815"><span class="toc-number">36.2.5.2.</span> <span class="toc-text"> 老年代</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-816"><span class="toc-number">36.2.5.3.</span> <span class="toc-text"> 永久代</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-817"><span class="toc-number">36.2.5.4.</span> <span class="toc-text"> JVM 参数</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-818"><span class="toc-number">36.3.</span> <span class="toc-text"> 3. 垃圾收集器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-819"><span class="toc-number">36.3.1.</span> <span class="toc-text"> 3.1. 串行收集器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-820"><span class="toc-number">36.3.1.1.</span> <span class="toc-text"> Serial 收集器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-821"><span class="toc-number">36.3.1.2.</span> <span class="toc-text"> Serial Old 收集器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-822"><span class="toc-number">36.3.2.</span> <span class="toc-text"> 3.2. 并行收集器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-823"><span class="toc-number">36.3.2.1.</span> <span class="toc-text"> Parallel Scavenge 收集器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-824"><span class="toc-number">36.3.2.2.</span> <span class="toc-text"> Parallel Old 收集器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-825"><span class="toc-number">36.3.3.</span> <span class="toc-text"> 3.3. 并发标记清除收集器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-826"><span class="toc-number">36.3.3.1.</span> <span class="toc-text"> CMS 收集器</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#-827"><span class="toc-number">36.3.3.1.1.</span> <span class="toc-text"> CMS 回收机制</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-828"><span class="toc-number">36.3.3.1.2.</span> <span class="toc-text"> CMS 回收年轻代详细步骤</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-829"><span class="toc-number">36.3.3.1.3.</span> <span class="toc-text"> CMS 回收年老代详细步骤</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-830"><span class="toc-number">36.3.3.1.4.</span> <span class="toc-text"> CMS 特点</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-831"><span class="toc-number">36.3.3.2.</span> <span class="toc-text"> ParNew 收集器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-832"><span class="toc-number">36.3.4.</span> <span class="toc-text"> 3.4. G1 收集器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-833"><span class="toc-number">36.3.4.1.</span> <span class="toc-text"> 分代和分区</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-834"><span class="toc-number">36.3.4.2.</span> <span class="toc-text"> G1 回收机制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-835"><span class="toc-number">36.3.4.3.</span> <span class="toc-text"> G1 回收年轻代详细步骤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-836"><span class="toc-number">36.3.4.4.</span> <span class="toc-text"> G1 回收年老代详细步骤</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-837"><span class="toc-number">36.3.5.</span> <span class="toc-text"> 3.5. 总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-838"><span class="toc-number">36.4.</span> <span class="toc-text"> 4. 内存分配与回收策略</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-839"><span class="toc-number">36.4.1.</span> <span class="toc-text"> 4.1. Minor GC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-840"><span class="toc-number">36.4.2.</span> <span class="toc-text"> 4.2. Full GC</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-841"><span class="toc-number">36.4.2.1.</span> <span class="toc-text"> 内存分配策略</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-842"><span class="toc-number">36.4.2.2.</span> <span class="toc-text"> Full GC 的触发条件</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#jvm-%E5%AD%97%E8%8A%82%E7%A0%81"><span class="toc-number">37.</span> <span class="toc-text"> JVM 字节码</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-843"><span class="toc-number">37.1.</span> <span class="toc-text"> 1. 字节码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-844"><span class="toc-number">37.1.1.</span> <span class="toc-text"> 1.1. 什么是字节码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-845"><span class="toc-number">37.1.2.</span> <span class="toc-text"> 1.2. 字节码结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-846"><span class="toc-number">37.1.3.</span> <span class="toc-text"> 1.3. 字节码操作集合</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-847"><span class="toc-number">37.1.4.</span> <span class="toc-text"> 1.4. 操作数栈和字节码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-848"><span class="toc-number">37.1.5.</span> <span class="toc-text"> 1.5. 字节码工具</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-849"><span class="toc-number">37.2.</span> <span class="toc-text"> 2. 字节码增强</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-850"><span class="toc-number">37.2.1.</span> <span class="toc-text"> 2.1. Asm</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-851"><span class="toc-number">37.2.1.1.</span> <span class="toc-text"> 核心 API</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-852"><span class="toc-number">37.2.1.2.</span> <span class="toc-text"> 树形 API</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-853"><span class="toc-number">37.2.2.</span> <span class="toc-text"> 2.2. Javassist</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#jvm-%E7%B1%BB%E5%8A%A0%E8%BD%BD"><span class="toc-number">38.</span> <span class="toc-text"> JVM 类加载</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-854"><span class="toc-number">38.1.</span> <span class="toc-text"> 1. 类加载机制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-855"><span class="toc-number">38.2.</span> <span class="toc-text"> 2. 类的生命周期</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-856"><span class="toc-number">38.2.1.</span> <span class="toc-text"> 2.1. （一）加载</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-857"><span class="toc-number">38.2.2.</span> <span class="toc-text"> 2.2. （二）验证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-858"><span class="toc-number">38.2.3.</span> <span class="toc-text"> 2.3. （三）准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-859"><span class="toc-number">38.2.4.</span> <span class="toc-text"> 2.4. （四）解析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-860"><span class="toc-number">38.2.5.</span> <span class="toc-text"> 2.5. （五）初始化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-861"><span class="toc-number">38.2.5.1.</span> <span class="toc-text"> 类初始化方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-862"><span class="toc-number">38.2.5.2.</span> <span class="toc-text"> 类初始化步骤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-863"><span class="toc-number">38.2.5.3.</span> <span class="toc-text"> 类初始化时机</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-864"><span class="toc-number">38.2.5.4.</span> <span class="toc-text"> 类初始化细节</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-865"><span class="toc-number">38.3.</span> <span class="toc-text"> 3. ClassLoader</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-866"><span class="toc-number">38.3.1.</span> <span class="toc-text"> 3.1. 类与类加载器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-867"><span class="toc-number">38.3.2.</span> <span class="toc-text"> 3.2. 类加载器分类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-868"><span class="toc-number">38.3.2.1.</span> <span class="toc-text"> Bootstrap ClassLoader</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-869"><span class="toc-number">38.3.2.2.</span> <span class="toc-text"> ExtClassLoader</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-870"><span class="toc-number">38.3.2.3.</span> <span class="toc-text"> AppClassLoader</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-871"><span class="toc-number">38.3.2.4.</span> <span class="toc-text"> 自定义类加载器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-872"><span class="toc-number">38.3.3.</span> <span class="toc-text"> 3.3. 双亲委派</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-873"><span class="toc-number">38.3.4.</span> <span class="toc-text"> 3.4. ClassLoader 参数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-874"><span class="toc-number">38.4.</span> <span class="toc-text"> 4. 类的加载</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-875"><span class="toc-number">38.4.1.</span> <span class="toc-text"> 4.1. 类加载方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-876"><span class="toc-number">38.4.2.</span> <span class="toc-text"> 4.2. 加载类错误</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-877"><span class="toc-number">38.4.2.1.</span> <span class="toc-text"> ClassNotFoundException</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-878"><span class="toc-number">38.4.2.2.</span> <span class="toc-text"> NoClassDefFoundError</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-879"><span class="toc-number">38.4.2.3.</span> <span class="toc-text"> UnsatisfiedLinkError</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-880"><span class="toc-number">38.4.2.4.</span> <span class="toc-text"> ClassCastException</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#jvm-%E5%AE%9E%E6%88%98"><span class="toc-number">39.</span> <span class="toc-text"> JVM 实战</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-881"><span class="toc-number">39.1.</span> <span class="toc-text"> 1. JVM 调优概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-882"><span class="toc-number">39.1.1.</span> <span class="toc-text"> 1.1. GC 性能指标</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-883"><span class="toc-number">39.1.2.</span> <span class="toc-text"> 1.2. 调优原则</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-884"><span class="toc-number">39.1.2.1.</span> <span class="toc-text"> 降低 Minor GC 频率</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-885"><span class="toc-number">39.1.2.2.</span> <span class="toc-text"> 降低 Full GC 的频率</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-886"><span class="toc-number">39.1.2.3.</span> <span class="toc-text"> 降低 Full GC 的时间</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-887"><span class="toc-number">39.1.3.</span> <span class="toc-text"> 1.3. GC 优化的过程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-888"><span class="toc-number">39.1.3.1.</span> <span class="toc-text"> （1）监控 GC 状态</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-889"><span class="toc-number">39.1.3.2.</span> <span class="toc-text"> （2）分析 GC 日志</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-890"><span class="toc-number">39.1.3.3.</span> <span class="toc-text"> （3）选择合适 GC 回收器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-891"><span class="toc-number">39.1.3.4.</span> <span class="toc-text"> （4）分析结果</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-892"><span class="toc-number">39.1.3.5.</span> <span class="toc-text"> （5）应用优化配置</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-893"><span class="toc-number">39.2.</span> <span class="toc-text"> 2. GC 日志</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-894"><span class="toc-number">39.2.1.</span> <span class="toc-text"> 2.1. 获取 GC 日志</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-895"><span class="toc-number">39.2.1.1.</span> <span class="toc-text"> jstat 命令查看 GC</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-896"><span class="toc-number">39.2.1.2.</span> <span class="toc-text"> 打印 GC 的参数</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-897"><span class="toc-number">39.2.2.</span> <span class="toc-text"> 2.2. 分析 GC 日志</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-898"><span class="toc-number">39.2.2.1.</span> <span class="toc-text"> CPU 过高</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-899"><span class="toc-number">39.3.</span> <span class="toc-text"> 3. GC 配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-900"><span class="toc-number">39.3.1.</span> <span class="toc-text"> 3.1. 堆大小设置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-901"><span class="toc-number">39.3.2.</span> <span class="toc-text"> 3.2. JVM 内存配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-902"><span class="toc-number">39.3.3.</span> <span class="toc-text"> 3.3. GC 类型配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-903"><span class="toc-number">39.3.4.</span> <span class="toc-text"> 3.4. 垃圾回收器通用参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-904"><span class="toc-number">39.3.5.</span> <span class="toc-text"> 3.5. JMX</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-905"><span class="toc-number">39.3.6.</span> <span class="toc-text"> 3.6. 远程 DEBUG</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-906"><span class="toc-number">39.3.7.</span> <span class="toc-text"> 3.7. HeapDump</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-907"><span class="toc-number">39.3.8.</span> <span class="toc-text"> 3.8. 辅助配置</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#jvm-%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B7%A5%E5%85%B7"><span class="toc-number">40.</span> <span class="toc-text"> JVM 命令行工具</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-908"><span class="toc-number">40.1.</span> <span class="toc-text"> 1. jps</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-909"><span class="toc-number">40.1.1.</span> <span class="toc-text"> 1.1. jps 命令用法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-910"><span class="toc-number">40.2.</span> <span class="toc-text"> 2. jstat</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-911"><span class="toc-number">40.2.1.</span> <span class="toc-text"> 2.1. jstat 命令用法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-912"><span class="toc-number">40.2.1.1.</span> <span class="toc-text"> 编译统计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-913"><span class="toc-number">40.2.1.2.</span> <span class="toc-text"> GC 统计</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-914"><span class="toc-number">40.3.</span> <span class="toc-text"> 3. jmap</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-915"><span class="toc-number">40.3.1.</span> <span class="toc-text"> 3.1. jmap 命令用法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-916"><span class="toc-number">40.3.2.</span> <span class="toc-text"> 3.2. jstat 使用示例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-917"><span class="toc-number">40.3.2.1.</span> <span class="toc-text"> 生成 heapdump 快照</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-918"><span class="toc-number">40.3.2.2.</span> <span class="toc-text"> 查看实例数最多的类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-919"><span class="toc-number">40.3.2.3.</span> <span class="toc-text"> 查看指定进程的堆信息</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-920"><span class="toc-number">40.4.</span> <span class="toc-text"> 4. jstack</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-921"><span class="toc-number">40.4.1.</span> <span class="toc-text"> 4.1. jstack 命令用法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-922"><span class="toc-number">40.4.2.</span> <span class="toc-text"> 4.2. thread dump 文件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-923"><span class="toc-number">40.4.2.1.</span> <span class="toc-text"> 第一部分：Full thread dump identifier</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-924"><span class="toc-number">40.4.2.2.</span> <span class="toc-text"> 第二部分：Java EE middleware, third party &amp; custom application Threads</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-925"><span class="toc-number">40.4.2.3.</span> <span class="toc-text"> 第三部分：HotSpot VM Thread</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#-926"><span class="toc-number">40.4.2.3.1.</span> <span class="toc-text"> “Attach Listener”</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-927"><span class="toc-number">40.4.2.3.2.</span> <span class="toc-text"> “DestroyJavaVM”</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-928"><span class="toc-number">40.4.2.3.3.</span> <span class="toc-text"> “Service Thread”</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-929"><span class="toc-number">40.4.2.3.4.</span> <span class="toc-text"> “CompilerThread”</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-930"><span class="toc-number">40.4.2.3.5.</span> <span class="toc-text"> “Signal Dispatcher”</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-931"><span class="toc-number">40.4.2.3.6.</span> <span class="toc-text"> “Finalizer”</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-932"><span class="toc-number">40.4.2.3.7.</span> <span class="toc-text"> “Reference Handler”</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-933"><span class="toc-number">40.4.2.3.8.</span> <span class="toc-text"> “VM Thread”</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-934"><span class="toc-number">40.4.2.4.</span> <span class="toc-text"> 第四部分：HotSpot GC Thread</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#-935"><span class="toc-number">40.4.2.4.1.</span> <span class="toc-text"> “VM Periodic Task Thread”</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-936"><span class="toc-number">40.4.2.4.2.</span> <span class="toc-text"> “GC task thread#0 (ParallelGC)”</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-937"><span class="toc-number">40.4.2.4.3.</span> <span class="toc-text"> “Gang worker#0 (Parallel GC Threads)”</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-938"><span class="toc-number">40.4.2.4.4.</span> <span class="toc-text"> “Concurrent Mark-Sweep GC Thread”</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#-939"><span class="toc-number">40.4.2.4.5.</span> <span class="toc-text"> “Surrogate Locker Thread (Concurrent GC)”</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-940"><span class="toc-number">40.4.2.5.</span> <span class="toc-text"> 第五部分：JNI global references count</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-941"><span class="toc-number">40.4.3.</span> <span class="toc-text"> 4.3. 系统线程状态</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-942"><span class="toc-number">40.4.3.1.</span> <span class="toc-text"> deadlock</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-943"><span class="toc-number">40.4.3.2.</span> <span class="toc-text"> runnable</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-944"><span class="toc-number">40.4.3.3.</span> <span class="toc-text"> blocked</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-945"><span class="toc-number">40.4.3.4.</span> <span class="toc-text"> waiting on condition</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-946"><span class="toc-number">40.4.3.5.</span> <span class="toc-text"> waiting for monitor entry 或 in Object.wait ()</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-947"><span class="toc-number">40.4.4.</span> <span class="toc-text"> 4.4. jstack 使用示例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-948"><span class="toc-number">40.4.4.1.</span> <span class="toc-text"> 找出某 Java 进程中最耗费 CPU 的 Java 线程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-949"><span class="toc-number">40.4.4.2.</span> <span class="toc-text"> 生成 threaddump 文件</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-950"><span class="toc-number">40.5.</span> <span class="toc-text"> 5. jinfo</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-951"><span class="toc-number">40.6.</span> <span class="toc-text"> 6. jhat</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#jvm-gui-%E5%B7%A5%E5%85%B7"><span class="toc-number">41.</span> <span class="toc-text"> JVM GUI 工具</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-952"><span class="toc-number">41.1.</span> <span class="toc-text"> 1. jconsole</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-953"><span class="toc-number">41.1.1.</span> <span class="toc-text"> 1.1. 开启 JMX</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-954"><span class="toc-number">41.1.2.</span> <span class="toc-text"> 1.2. 连接 jconsole</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-955"><span class="toc-number">41.1.3.</span> <span class="toc-text"> 1.3. jconsole 界面</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-956"><span class="toc-number">41.2.</span> <span class="toc-text"> 2. jvisualvm</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-957"><span class="toc-number">41.2.1.</span> <span class="toc-text"> 2.1. jvisualvm 概述页面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-958"><span class="toc-number">41.2.2.</span> <span class="toc-text"> 2.2. jvisualvm 监控页面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-959"><span class="toc-number">41.2.3.</span> <span class="toc-text"> 2.3. jvisualvm 线程页面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-960"><span class="toc-number">41.2.4.</span> <span class="toc-text"> 2.4. jvisualvm 抽样器页面</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-961"><span class="toc-number">41.3.</span> <span class="toc-text"> 3. MAT</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-962"><span class="toc-number">41.3.1.</span> <span class="toc-text"> 3.1. MAT 配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-963"><span class="toc-number">41.3.2.</span> <span class="toc-text"> 3.2. MAT 分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-964"><span class="toc-number">41.4.</span> <span class="toc-text"> 4. JProfile</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-965"><span class="toc-number">41.5.</span> <span class="toc-text"> 5. Arthas</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-966"><span class="toc-number">41.5.1.</span> <span class="toc-text"> 5.1. Arthas 基础命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-967"><span class="toc-number">41.5.2.</span> <span class="toc-text"> 5.2. Arthas jvm 相关命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-968"><span class="toc-number">41.5.3.</span> <span class="toc-text"> 5.3. Arthas class&#x2F;classloader 相关命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-969"><span class="toc-number">41.5.4.</span> <span class="toc-text"> 5.4. Arthas monitor&#x2F;watch&#x2F;trace 相关命令</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#java-%E5%BA%94%E7%94%A8%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD"><span class="toc-number">42.</span> <span class="toc-text"> Java 应用故障诊断</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-970"><span class="toc-number">42.1.</span> <span class="toc-text"> 一、故障定位思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-971"><span class="toc-number">42.2.</span> <span class="toc-text"> 二、CPU 问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-972"><span class="toc-number">42.2.1.</span> <span class="toc-text"> 查找 CPU 占用率较高的进程、线程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-973"><span class="toc-number">42.2.2.</span> <span class="toc-text"> 是否存在频繁 GC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-974"><span class="toc-number">42.2.3.</span> <span class="toc-text"> 是否存在频繁上下文切换</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-975"><span class="toc-number">42.3.</span> <span class="toc-text"> 三、内存问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-976"><span class="toc-number">42.4.</span> <span class="toc-text"> 四、磁盘问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-977"><span class="toc-number">42.4.1.</span> <span class="toc-text"> 查看磁盘空间使用率</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-978"><span class="toc-number">42.4.2.</span> <span class="toc-text"> 查看磁盘读写性能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-979"><span class="toc-number">42.4.3.</span> <span class="toc-text"> 查看具体的文件读写情况</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-980"><span class="toc-number">42.5.</span> <span class="toc-text"> 五、网络问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-981"><span class="toc-number">42.5.1.</span> <span class="toc-text"> 无法连接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-982"><span class="toc-number">42.5.2.</span> <span class="toc-text"> 网络超时</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-983"><span class="toc-number">42.5.3.</span> <span class="toc-text"> TCP 队列溢出</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-984"><span class="toc-number">42.5.4.</span> <span class="toc-text"> RST 异常</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-985"><span class="toc-number">42.5.5.</span> <span class="toc-text"> TIME_WAIT 和 CLOSE_WAIT</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-986"><span class="toc-number">42.5.5.1.</span> <span class="toc-text"> TIME_WAIT</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-987"><span class="toc-number">42.5.5.2.</span> <span class="toc-text"> CLOSE_WAIT</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-988"><span class="toc-number">42.6.</span> <span class="toc-text"> 六、GC 问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-989"><span class="toc-number">42.6.1.</span> <span class="toc-text"> OOM</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-990"><span class="toc-number">42.6.2.</span> <span class="toc-text"> Minor GC</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-991"><span class="toc-number">42.6.2.1.</span> <span class="toc-text"> Minor GC 过频</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-992"><span class="toc-number">42.6.2.2.</span> <span class="toc-text"> Minor GC 耗时过长</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-993"><span class="toc-number">42.6.3.</span> <span class="toc-text"> Full GC 过频</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-994"><span class="toc-number">42.7.</span> <span class="toc-text"> 七、常用 Linux 命令</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-995"><span class="toc-number">42.7.1.</span> <span class="toc-text"> top</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-996"><span class="toc-number">42.7.2.</span> <span class="toc-text"> vmstat</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%9D%A2%E8%AF%95%E9%A2%98"><span class="toc-number">43.</span> <span class="toc-text"> 面试题</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80"><span class="toc-number">43.1.</span> <span class="toc-text"> 基础</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-997"><span class="toc-number">43.1.1.</span> <span class="toc-text"> 工具类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-998"><span class="toc-number">43.1.1.1.</span> <span class="toc-text"> String</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-999"><span class="toc-number">43.1.2.</span> <span class="toc-text"> 面向对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-1000"><span class="toc-number">43.1.3.</span> <span class="toc-text"> 反射</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-1001"><span class="toc-number">43.1.3.1.</span> <span class="toc-text"> ⭐ 创建实例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-1002"><span class="toc-number">43.1.3.2.</span> <span class="toc-text"> ⭐ 加载实例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-1003"><span class="toc-number">43.1.3.3.</span> <span class="toc-text"> ⭐⭐ 动态代理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-1004"><span class="toc-number">43.1.4.</span> <span class="toc-text"> JDK8</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-1005"><span class="toc-number">43.1.5.</span> <span class="toc-text"> 其他</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-1006"><span class="toc-number">43.1.5.1.</span> <span class="toc-text"> ⭐ hashcode</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-1007"><span class="toc-number">43.2.</span> <span class="toc-text"> IO</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-1008"><span class="toc-number">43.2.1.</span> <span class="toc-text"> NIO</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-1009"><span class="toc-number">43.2.2.</span> <span class="toc-text"> 序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-1010"><span class="toc-number">43.2.2.1.</span> <span class="toc-text"> ⭐ 序列化问题</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-1011"><span class="toc-number">43.3.</span> <span class="toc-text"> 容器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-1012"><span class="toc-number">43.3.1.</span> <span class="toc-text"> List</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-1013"><span class="toc-number">43.3.1.1.</span> <span class="toc-text"> ArrayList 和 LinkedList 有什么区别？</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-1014"><span class="toc-number">43.3.2.</span> <span class="toc-text"> Map</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-1015"><span class="toc-number">43.4.</span> <span class="toc-text"> 并发</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-1016"><span class="toc-number">43.4.1.</span> <span class="toc-text"> 并发简介</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-1017"><span class="toc-number">43.4.1.1.</span> <span class="toc-text"> 什么是进程？什么是线程？进程和线程的区别？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-1018"><span class="toc-number">43.4.1.2.</span> <span class="toc-text"> 并发（多线程）编程的好处是什么？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-1019"><span class="toc-number">43.4.1.3.</span> <span class="toc-text"> 并发一定比串行更快吗？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-1020"><span class="toc-number">43.4.1.4.</span> <span class="toc-text"> 如何让正在运行的线程暂停一段时间？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-1021"><span class="toc-number">43.4.1.5.</span> <span class="toc-text"> 什么是线程调度器 (Thread Scheduler) 和时间分片 (Time Slicing)？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-1022"><span class="toc-number">43.4.1.6.</span> <span class="toc-text"> 在多线程中，什么是上下文切换 (context-switching)？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-1023"><span class="toc-number">43.4.1.7.</span> <span class="toc-text"> 如何确保线程安全？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-1024"><span class="toc-number">43.4.1.8.</span> <span class="toc-text"> 什么是死锁 (Deadlock)？如何分析和避免死锁？</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-1025"><span class="toc-number">43.4.2.</span> <span class="toc-text"> 线程基础</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-1026"><span class="toc-number">43.4.2.1.</span> <span class="toc-text"> Java 线程生命周期中有哪些状态？各状态之间如何切换？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-1027"><span class="toc-number">43.4.2.2.</span> <span class="toc-text"> 创建线程有哪些方式？这些方法各自利弊是什么？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-1028"><span class="toc-number">43.4.2.3.</span> <span class="toc-text"> 什么是  Callable  和  Future ？什么是  FutureTask ？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-1029"><span class="toc-number">43.4.2.4.</span> <span class="toc-text">  start()  和  run()  有什么区别？可以直接调用  Thread  类的  run()  方法么？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-1030"><span class="toc-number">43.4.2.5.</span> <span class="toc-text">  sleep() 、 yield() 、 join()  方法有什么区别？为什么  sleep()  和  yield()  方法是静态（static）的？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-1031"><span class="toc-number">43.4.2.6.</span> <span class="toc-text"> Java 的线程优先级如何控制？高优先级的 Java 线程一定先执行吗？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-1032"><span class="toc-number">43.4.2.7.</span> <span class="toc-text"> 什么是守护线程？为什么要用守护线程？如何创建守护线程？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-1033"><span class="toc-number">43.4.2.8.</span> <span class="toc-text"> 线程间是如何通信的？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-1034"><span class="toc-number">43.4.2.9.</span> <span class="toc-text"> 为什么线程通信的方法  wait() ,  notify()  和  notifyAll()  被定义在 Object 类里？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-1035"><span class="toc-number">43.4.2.10.</span> <span class="toc-text"> 为什么  wait() ,  notify()  和  notifyAll()  必须在同步方法或者同步块中被调用？</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-1036"><span class="toc-number">43.4.3.</span> <span class="toc-text"> 并发机制的底层实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-1037"><span class="toc-number">43.4.3.1.</span> <span class="toc-text"> ⭐⭐⭐  synchronized</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-1038"><span class="toc-number">43.4.3.2.</span> <span class="toc-text"> ⭐  volatile</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-1039"><span class="toc-number">43.4.3.3.</span> <span class="toc-text"> ⭐⭐ CAS</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-1040"><span class="toc-number">43.4.3.4.</span> <span class="toc-text"> ⭐  ThreadLocal</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-1041"><span class="toc-number">43.4.4.</span> <span class="toc-text"> 内存模型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-1042"><span class="toc-number">43.4.4.1.</span> <span class="toc-text"> 什么是 Java 内存模型</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-1043"><span class="toc-number">43.4.5.</span> <span class="toc-text"> 同步容器和并发容器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-1044"><span class="toc-number">43.4.5.1.</span> <span class="toc-text"> ⭐ 同步容器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-1045"><span class="toc-number">43.4.5.2.</span> <span class="toc-text"> ⭐⭐⭐ ConcurrentHashMap</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-1046"><span class="toc-number">43.4.5.3.</span> <span class="toc-text"> ⭐⭐ CopyOnWriteArrayList</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-1047"><span class="toc-number">43.4.6.</span> <span class="toc-text"> 并发锁</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-1048"><span class="toc-number">43.4.6.1.</span> <span class="toc-text"> ⭐⭐ 锁类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-1049"><span class="toc-number">43.4.6.2.</span> <span class="toc-text"> ⭐⭐ AQS</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-1050"><span class="toc-number">43.4.6.3.</span> <span class="toc-text"> ⭐ ReentrantReadWriteLock</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-1051"><span class="toc-number">43.4.6.4.</span> <span class="toc-text"> ⭐ Condition</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-1052"><span class="toc-number">43.4.6.5.</span> <span class="toc-text"> ⭐⭐ 死锁</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-1053"><span class="toc-number">43.4.7.</span> <span class="toc-text"> 原子变量类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-1054"><span class="toc-number">43.4.7.1.</span> <span class="toc-text"> ⭐ 原子类简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-1055"><span class="toc-number">43.4.7.2.</span> <span class="toc-text"> ⭐ 原子类的原理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-1056"><span class="toc-number">43.4.8.</span> <span class="toc-text"> 并发工具类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-1057"><span class="toc-number">43.4.8.1.</span> <span class="toc-text"> ⭐ CountDownLatch</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-1058"><span class="toc-number">43.4.8.2.</span> <span class="toc-text"> ⭐ CyclicBarrier</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-1059"><span class="toc-number">43.4.8.3.</span> <span class="toc-text"> ⭐ Semaphore</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-1060"><span class="toc-number">43.4.9.</span> <span class="toc-text"> 线程池</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-1061"><span class="toc-number">43.4.9.1.</span> <span class="toc-text"> ⭐⭐ ThreadPoolExecutor</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-1062"><span class="toc-number">43.4.9.2.</span> <span class="toc-text"> ⭐ Executors</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-map"><div class="card-content"><div class="item-headline"><i class="fa fa-globe-asia" aria-hidden="true"></i><span>Visitor Map</span></div><script id="clstr_globe" type="text/javascript" defer="defer" src="//clustrmaps.com/globe.js?d=4LA950xi3DtQgUHPlkO0mo-n_QgrcOu-1BIiVpExg7k"></script></div></div><div class="card-widget card-pixiv"><div class="card-content"><div class="item-headline"><i class="fa fa-image" aria-hidden="true"></i><span>Pixiv Top50</span><iframe src="https://cloud.mokeyjay.com/pixiv" frameborder="0" style="width:99%;height:380px;margin:0;"></iframe></div></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/06/12/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" title="Design Patterns"><img src="/img/default-covers/town-lake.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Design Patterns"/></a><div class="content"><a class="title" href="/2022/06/12/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" title="Design Patterns">Design Patterns</a><time datetime="2022-06-11T12:00:00.000Z" title="Created 2022-06-12 00:00:00">2022-06-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/06/12/%E7%AE%97%E6%B3%95%E7%BB%88%E6%9E%81%E6%8C%87%E5%8D%97/" title="My ultimate data structure and algorithm guide"><img src="/img/default-covers/car.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="My ultimate data structure and algorithm guide"/></a><div class="content"><a class="title" href="/2022/06/12/%E7%AE%97%E6%B3%95%E7%BB%88%E6%9E%81%E6%8C%87%E5%8D%97/" title="My ultimate data structure and algorithm guide">My ultimate data structure and algorithm guide</a><time datetime="2022-06-11T12:00:00.000Z" title="Created 2022-06-12 00:00:00">2022-06-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/06/11/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%20-%20%E5%91%BD%E4%BB%A4/" title="Design Patterns - Command"><img src="/img/default-covers/cat.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Design Patterns - Command"/></a><div class="content"><a class="title" href="/2022/06/11/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%20-%20%E5%91%BD%E4%BB%A4/" title="Design Patterns - Command">Design Patterns - Command</a><time datetime="2022-06-10T12:00:00.000Z" title="Created 2022-06-11 00:00:00">2022-06-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/06/11/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%20-%20%E5%A4%87%E5%BF%98%E5%BD%95/" title="Design Patterns - Momento"><img src="/img/default-covers/sun.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Design Patterns - Momento"/></a><div class="content"><a class="title" href="/2022/06/11/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%20-%20%E5%A4%87%E5%BF%98%E5%BD%95/" title="Design Patterns - Momento">Design Patterns - Momento</a><time datetime="2022-06-10T12:00:00.000Z" title="Created 2022-06-11 00:00:00">2022-06-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/06/11/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%20-%20%E5%B7%A5%E5%8E%82%E6%96%B9%E6%B3%95/" title="Design Patterns - Factory Method"><img src="/img/default-covers/cat.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Design Patterns - Factory Method"/></a><div class="content"><a class="title" href="/2022/06/11/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%20-%20%E5%B7%A5%E5%8E%82%E6%96%B9%E6%B3%95/" title="Design Patterns - Factory Method">Design Patterns - Factory Method</a><time datetime="2022-06-10T12:00:00.000Z" title="Created 2022-06-11 00:00:00">2022-06-11</time></div></div></div></div></div></div></main><footer id="footer" style="background: transparent"><div id="footer-wrap"><div class="copyright">&copy;2021 - 2022 By Harry Qu</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="Chat"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="Scroll To Comments"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Local search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>function loadDisqus () {
  var disqus_config = function () {
    this.page.url = 'https://harryqu1229.github.io/2022/04/30/java%E5%A4%A7%E6%80%BB%E7%BB%93/'
    this.page.identifier = '2022/04/30/java大总结/'
    this.page.title = 'Java big Summary'
  };

  window.disqusReset = () => {
    DISQUS.reset({
      reload: true,
      config: disqus_config
    })
  }

  if (window.DISQUS) disqusReset()
  else {
    (function() { 
      var d = document, s = d.createElement('script');
      s.src = 'https://harry-study-blog.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  }
}

if ('Disqus' === 'Disqus' || !true) {
  if (true) btf.loadComment(document.getElementById('disqus_thread'), loadDisqus)
  else loadDisqus()
} else {
  function loadOtherComment () {
    loadDisqus()
  }
}
</script><script>function addGitalkSource () {
  const ele = document.createElement('link')
  ele.rel = 'stylesheet'
  ele.href= 'https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css'
  document.getElementsByTagName('head')[0].appendChild(ele)
}

function loadGitalk () {
  function initGitalk () {
    var gitalk = new Gitalk(Object.assign({
      clientID: '5df1e915e0fa867b50de',
      clientSecret: 'ce1cb793fe49078ee9d0102d3326d0d50ff6937b',
      repo: 'blog-comments-storage',
      owner: 'HarryQu1229',
      admin: ['HarryQu1229'],
      id: 'ffd6a04d8e7991cddef8f7fb896d95c5',
      updateCountCallback: commentCount
    },null))

    gitalk.render('gitalk-container')
  }

  if (typeof Gitalk === 'function') initGitalk()
  else {
    addGitalkSource()
    getScript('https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js').then(initGitalk)
  }
}

function commentCount(n){
  let isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
  if (isCommentCount) {
    isCommentCount.innerHTML= n
  }
}

if ('Disqus' === 'Gitalk' || !true) {
  if (true) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
  else loadGitalk()
} else {
  function loadOtherComment () {
    loadGitalk()
  }
}</script></div><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[image]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[link]') // replace url
    content = content.replace(/<code>.*?<\/code>/gi, '[code]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getComment = () => {
    fetch('https://disqus.com/api/3.0/forums/listPosts.json?forum=harry-study-blog&related=thread&limit=6&api_key=B5XFmdGuVaYDW7OIBakffpXoKorvphwRiwONIol4puEtr8YiwYAMAk2K7QcExNLY')
      .then(response => response.json())
      .then(data => {
        const disqusArray = data.response.map(item => {
          return {
            'avatar': item.author.avatar.cache,
            'content': changeContent(item.message),
            'nick': item.author.name,
            'url': item.url,
            'date': item.createdAt
          }
        })

        saveToLocal.set('disqus-newest-comments', JSON.stringify(disqusArray), 10/(60*24))
        generateHtml(disqusArray)
      }).catch(e => {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.innerHTML= "Unable to get the data, please make sure the settings are correct."
      })
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }
        
        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick}</span><time> / ${btf.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += 'No Comment'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom.innerHTML= result
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('disqus-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><div class="aplayer no-destroy" data-id="2809513713" data-server="netease" data-type="playlist" data-autoplay="false" data-fixed="true" data-order="random" data-theme="#e9ccd3"> </div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/fireworks.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script>((window.gitter = {}).chat = {}).options = {
  disableDefaultChat: true,
};
document.addEventListener('gitter-sidecar-ready', (e) => {
  const GitterChat = e.detail.Chat
  let chat

  function initGitter () {
    chat = new GitterChat({
      room: 'HarryStudyBlog/community',
      activationElement: '#chat_btn'
    });
  }

  initGitter()

  if (true) {
    document.addEventListener('pjax:complete', () => {
      chat.destroy()
      initGitter()
    })
  }

})</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async="async" defer="defer"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/gh/metowolf/MetingJS@1.2/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --><script data-pjax>
  function butterfly_footer_beautify_injector_config(){
    var parent_div_git = document.getElementById('footer-wrap');
    var item_html = '<div id="workboard"></div><div id="ghbdages" style="overflow:hidden;max-height:90px;height:auto;text-align:center;margin-top:10px"><div class="swiper-wrapper"><div class="swiper-slide"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" title="博客框架为Hexo_v5.4.0"><img src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&amp;logo=hexo" alt=""/></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px" title="主题版本Butterfly_v3.8.2"><img src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&amp;logo=bitdefender" alt=""/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" title="本站项目由Github托管"><img src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&amp;logo=GitHub" alt=""/></a></div><div class="swiper-slide"><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" style="margin-inline:5px" title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"><img src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&amp;logo=Claris" alt=""/></a></div></div></div><style>a.github-badge:hover:before {display:none}</style>';
    console.log('已挂载butterfly_footer_beautify')
    parent_div_git.insertAdjacentHTML("beforeend",item_html)
    }
  var elist = 'undefined'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_footer_beautify_injector_config();
  }
  else if (epage === cpage){
    butterfly_footer_beautify_injector_config();
  }
  </script><script async src="/js/footer-beautify-runtime.js"></script><script defer src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.js"></script><script defer data-pjax src="https://npm.elemecdn.com/hexo-butterfly-footer-beautify/lib/swiperbdage_init.min.js"></script><script data-pjax src="https://npm.elemecdn.com/hexo-filter-gitcalendar/lib/gitcalendar.js"></script><script data-pjax>
  function gitcalendar_injector_config(){
      var parent_div_git = document.getElementById('recent-posts');
      var item_html = '<div class="recent-post-item" style="width:100%;height:auto;padding:10px;"><style>#git_container{min-height: 280px}@media screen and (max-width:650px) {#git_container{min-height: 0px}}</style><div id="git_loading" style="width:10%;height:100%;margin:0 auto;display: block;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 50 50" style="enable-background:new 0 0 50 50" xml:space="preserve"><path fill="#d0d0d0" d="M25.251,6.461c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615V6.461z" transform="rotate(275.098 25 25)"><animatetransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"></animatetransform></path></svg><style>#git_container{display: none;}</style></div><div id="git_container"></div></div>';
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
      console.log('已挂载gitcalendar')
      }

    if( document.getElementById('recent-posts') && (location.pathname ==='/'|| '/' ==='all')){
        gitcalendar_injector_config()
        GitCalendarInit("https://gitcalendar.akilar.top/api?HarryQu1229",['#ebedf0', '#fdcdec', '#fc9bd9', '#fa6ac5', '#f838b2', '#f5089f', '#c4067e', '#92055e', '#540336', '#48022f', '#30021f'],'HarryQu1229')
    }
  </script><!-- hexo injector body_end end --><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"position":"right","width":300,"height":450},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html>