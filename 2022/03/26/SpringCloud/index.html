<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>My SpringCloud notes | Harry Blog</title><meta name="keywords" content="backend,springcloud,java"><meta name="author" content="Harry Qu"><meta name="copyright" content="Harry Qu"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="# 认识微服务 # 单体架构 单体架构：将业务的所有功能集中在一个项目中开发，打成一个包部署。  优点： 架构简单，部署成本低 缺点： 耦合度高（维护困难、升级困难） # 分布式架构 分布式架构：根据业务功能对系统做拆分，每个业务功能模块作为独立项目开发，称为一个服务。  优点： 降低服务耦合，有利于服务升级和拓展 缺点： 服务调用关系错综复杂 分布式架构虽然降低了服务耦合，但是服务拆分时也有很多">
<meta property="og:type" content="article">
<meta property="og:title" content="My SpringCloud notes">
<meta property="og:url" content="https://harryqu1229.github.io/2022/03/26/SpringCloud/index.html">
<meta property="og:site_name" content="Harry Blog">
<meta property="og:description" content="# 认识微服务 # 单体架构 单体架构：将业务的所有功能集中在一个项目中开发，打成一个包部署。  优点： 架构简单，部署成本低 缺点： 耦合度高（维护困难、升级困难） # 分布式架构 分布式架构：根据业务功能对系统做拆分，每个业务功能模块作为独立项目开发，称为一个服务。  优点： 降低服务耦合，有利于服务升级和拓展 缺点： 服务调用关系错综复杂 分布式架构虽然降低了服务耦合，但是服务拆分时也有很多">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://harryqu1229.github.io/img/default-covers/mountain.jpg">
<meta property="article:published_time" content="2022-03-25T11:00:00.000Z">
<meta property="article:modified_time" content="2022-06-12T01:14:17.538Z">
<meta property="article:author" content="Harry Qu">
<meta property="article:tag" content="java">
<meta property="article:tag" content="backend">
<meta property="article:tag" content="springcloud">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://harryqu1229.github.io/img/default-covers/mountain.jpg"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://harryqu1229.github.io/2022/03/26/SpringCloud/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: undefined,
  noticeOutdate: {"limitDay":100,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"prismjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"Traditional Chinese Activated Manually","cht_to_chs":"Simplified Chinese Activated Manually","day_to_night":"Dark Mode Activated Manually","night_to_day":"Light Mode Activated Manually","bgLight":"#C78550","bgDark":"#c08eaf","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'My SpringCloud notes',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-06-12 13:14:17'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><style type="text/css">.aplayer.aplayer-fixed.aplayer-narrow .aplayer-body{left:-66px!important}.aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover{left:0!important}</style><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-footer-beautify@1.0.0/lib/runtime.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.css" media="print" onload="this.media='all'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">Loading...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/avatar.jpeg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">158</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">84</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">57</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-graduation-cap"></i><span> Journey</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> Hobbies</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/Music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/Photos/"><i class="fa-fw fas fa-images"></i><span> Photos</span></a></li><li><a class="site-page child" href="/Movies/"><i class="fa-fw fas fa-video"></i><span> Movies</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Links</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://images.g2crowd.com/uploads/product/image/social_landscape/social_landscape_fce7761796f53e5289b0c856a8986146/spring-cloud.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Harry Blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-graduation-cap"></i><span> Journey</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> Hobbies</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/Music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/Photos/"><i class="fa-fw fas fa-images"></i><span> Photos</span></a></li><li><a class="site-page child" href="/Movies/"><i class="fa-fw fas fa-video"></i><span> Movies</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Links</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">My SpringCloud notes</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2022-03-25T11:00:00.000Z" title="Created 2022-03-26 00:00:00">2022-03-26</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2022-06-12T01:14:17.538Z" title="Updated 2022-06-12 13:14:17">2022-06-12</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Backend/">Backend</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Backend/java/">java</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word count:</span><span class="word-count">36k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading time:</span><span>130min</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="My SpringCloud notes"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="认识微服务"><a class="markdownIt-Anchor" href="#认识微服务">#</a> 认识微服务</h1>
<h2 id="单体架构"><a class="markdownIt-Anchor" href="#单体架构">#</a> 单体架构</h2>
<p><strong>单体架构</strong>：将业务的所有功能集中在一个项目中开发，打成一个包部署。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901083809.png" alt=""></p>
<p><strong>优点：</strong> 架构简单，部署成本低</p>
<p><strong>缺点：</strong> 耦合度高（维护困难、升级困难）</p>
<h2 id="分布式架构"><a class="markdownIt-Anchor" href="#分布式架构">#</a> 分布式架构</h2>
<p><strong>分布式架构</strong>：根据业务功能对系统做拆分，每个业务功能模块作为独立项目开发，称为一个服务。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901092921.png" alt=""></p>
<p><strong>优点：</strong> 降低服务耦合，有利于服务升级和拓展</p>
<p><strong>缺点：</strong> 服务调用关系错综复杂</p>
<p>分布式架构虽然降低了服务耦合，但是服务拆分时也有<strong>很多问题需要思考</strong>：</p>
<ul>
<li>服务拆分的粒度如何界定？</li>
<li>服务之间如何调用？</li>
<li>服务的调用关系如何管理？</li>
</ul>
<p><strong>人们需要制定一套行之有效的标准来约束分布式架构。</strong></p>
<h2 id="微服务"><a class="markdownIt-Anchor" href="#微服务">#</a> 微服务</h2>
<p>微服务的架构特征：</p>
<ul>
<li>单一职责：微服务拆分粒度更小，每一个服务都对应唯一的业务能力，做到单一职责</li>
<li>自治：团队独立、技术独立、数据独立，独立部署和交付</li>
<li>面向服务：服务提供统一标准的接口，与语言和技术无关</li>
<li>隔离性强：服务调用做好隔离、容错、降级，避免出现级联问题</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/blog/img20210901083658.png" alt=""></p>
<p>微服务的上述特性<strong>其实是在给分布式架构制定一个标准</strong>，进一步降低服务之间的耦合度，提供服务的独立性和灵活性。做到高内聚，低耦合。</p>
<p><strong>因此，可以认为微服务是一种经过良好架构设计的分布式架构方案 。</strong></p>
<p>其中在 Java 领域最引人注目的就是 SpringCloud 提供的方案了。</p>
<h2 id="springcloud"><a class="markdownIt-Anchor" href="#springcloud">#</a> SpringCloud</h2>
<p>SpringCloud 是目前国内使用最广泛的微服务框架。官网地址：<a target="_blank" rel="noopener" href="https://spring.io/projects/spring-cloud">https://spring.io/projects/spring-cloud</a>。</p>
<p>SpringCloud 集成了各种微服务功能组件，并基于 SpringBoot 实现了这些组件的自动装配，从而提供了良好的开箱即用体验。</p>
<p>其中常见的组件包括：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901083717.png" alt=""></p>
<p>另外，SpringCloud 底层是依赖于 SpringBoot 的，并且有版本的兼容关系，如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901084050.png" alt=""></p>
<h2 id="内容知识"><a class="markdownIt-Anchor" href="#内容知识">#</a> 内容知识</h2>
<p>需要学习的微服务知识内容</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901092925.png" alt=""></p>
<p>技术栈</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901084131.png" alt=""></p>
<p>自动化部署</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901090737.png" alt=""></p>
<h2 id="技术栈对比"><a class="markdownIt-Anchor" href="#技术栈对比">#</a> 技术栈对比</h2>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901090726.png" alt=""></p>
<hr>
<h1 id="服务拆分"><a class="markdownIt-Anchor" href="#服务拆分">#</a> 服务拆分</h1>
<blockquote>
<p>案例源码：<a target="_blank" rel="noopener" href="https://gitee.com/xn2001/cloudcode/tree/master/01-cloud-demo">https://gitee.com/xn2001/cloudcode/tree/master/01-cloud-demo</a></p>
</blockquote>
<p><strong>服务拆分注意事项</strong></p>
<p>单一职责：不同微服务，不要重复开发相同业务</p>
<p>数据独立：不要访问其它微服务的数据库</p>
<p>面向服务：将自己的业务暴露为接口，供其它微服务调用，其他微服务就只需要发送请求到其他的微服务来调用那个微服务等等功能</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901090745.png" alt=""></p>
<p>cloud-demo：父工程，管理依赖</p>
<ul>
<li>order-service：订单微服务，负责订单相关业务</li>
<li>user-service：用户微服务，负责用户相关业务</li>
</ul>
<p>要求：</p>
<ul>
<li>订单微服务和用户微服务都必须有<strong>各自的数据库</strong>，相互独立</li>
<li>订单服务和用户服务<strong>都对外暴露 Restful 的接口</strong></li>
<li>订单服务如果需要查询用户信息，<strong>只能调用用户服务的 Restful 接口</strong>，不能查询用户数据库</li>
</ul>
<p>微服务项目下，打开 idea 中的 Service，可以很方便的启动。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901090750.png" alt=""></p>
<p>启动完成后，访问 <a target="_blank" rel="noopener" href="http://localhost:8080/order/101">http://localhost:8080/order/101</a></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901090757.png" alt=""></p>
<hr>
<h1 id="远程调用"><a class="markdownIt-Anchor" href="#远程调用">#</a> 远程调用</h1>
<blockquote>
<p>案例源码：<a target="_blank" rel="noopener" href="https://gitee.com/xn2001/cloudcode/tree/master/02-cloud-restTemplate">https://gitee.com/xn2001/cloudcode/tree/master/02-cloud-restTemplate</a></p>
</blockquote>
<p>正如上面的服务拆分要求中所提到，</p>
<blockquote>
<p>订单服务如果需要查询用户信息，<strong>只能调用用户服务的 Restful 接口</strong>，不能查询用户数据库</p>
</blockquote>
<p><mark>因此我们需要知道 Java 如何去发送 http 请求，Spring 提供了一个 RestTemplate 工具，只需要把它创建出来即可。</mark>（即注入 Bean）</p>
<blockquote>
<p>需要在 order 微服务 (module) 的 springboot 启动类里面写上以下这个代码，把 RestTemplate 类的对象注册到 IOC 容器中，然后我们就可以在 order 微服务里面发送 http 请求到别的微服务去</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901090814.png" alt=""></p>
<blockquote>
<p>然后再我们 order 微服务里面 controller 层调用了 service 层，service 层则有着 dao/mapper 层查询 order 微服务专属的数据库的信息 (里面除了 order 的信息外还包含了每个 order 对应的 userId, 但是没有那个 User 的信息)</p>
<p>我们需要在这个 service 层写以下的代码:</p>
</blockquote>
<p>发送请求，自动序列化为 Java 对象。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901090846.png" alt=""></p>
<blockquote>
<ul>
<li>
<p>首先因为我们把 RestTemplate 类的对象注册到 IOC 容器中了，我们可以直接用里面的方法</p>
</li>
<li>
<p>我们在 service 层用着调用 dao 层查询出来的结果中的 userId 信息来 (调用 RestTemplate 类里面的方法) 发送请求</p>
</li>
<li>
<p>然后这个 <code>getForObject</code>  方法作用就是发送请求然后把相应的结果返回给我们为一个对象，(要是我们没写那个 User.class 就传的就是个 json 对象)</p>
</li>
<li>
<p>然后我们就可以把这个请求到的 User 信息封装给我们的 order 类的实例化对象里面，然后再把这个 order 类的实例化对象返回出去给 controller,controller 再相应任何对应的请求</p>
</li>
</ul>
</blockquote>
<blockquote>
<p>这样我们就在 order 微服务远程调用了 user 微服务中的 controller 层获取到了想要的信息 (注意这个 user 微服务中的 controller 层那个 RequestMapping 注解啥的要配置好才行–&gt; 复合我们上面写的那个 http 请求)</p>
</blockquote>
<p>启动完成后，访问：<a target="_blank" rel="noopener" href="http://localhost">http://localhost</a>:8080/order/101</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901090909.png" alt=""></p>
<blockquote>
<p>在上面 order 是消费者，user 是提供者，因为 user 提供接口而 order 则调用了接口</p>
<p>一个微服务可以是消费者也可以是提供者，比如说 A 调用了 B,B 调用了 C, 那么 B 就是又是消费者又是提供者</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220217201322680.png" alt="image-20220217201322680"></p>
<hr>
<p>在上面代码的 url 中，我们可以发现调用服务的地址采用硬编码，这在后续的开发中肯定是不理想的，这就需要<strong>服务注册中心</strong>（Eureka）来帮我们解决这个事情。</p>
<p>比如说我们的 user 微服务做了集群，有好几个 user 微服务，要是我们上面这么做只能会是给一个服务器的 user 微服务发请求，集群没意义了.</p>
<h1 id="eureka注册中心"><a class="markdownIt-Anchor" href="#eureka注册中心">#</a> Eureka 注册中心</h1>
<blockquote>
<p>案例源码：<a target="_blank" rel="noopener" href="https://gitee.com/xn2001/cloudcode/tree/master/03-cloud-eureka">https://gitee.com/xn2001/cloudcode/tree/master/03-cloud-eureka</a></p>
</blockquote>
<p>最广为人知的注册中心就是 Eureka，其结构如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901090919.png" alt=""></p>
<p>不管是服务消费者还是服务提供者都是 eureka 的 client</p>
<blockquote>
<p><strong>order-service 如何得知 user-service 实例地址？</strong></p>
</blockquote>
<ul>
<li><strong>每一个</strong> user-service 服务实例启动后，将自己的信息注册到 eureka-server (Eureka 服务端)，叫做<strong>服务注册</strong></li>
<li>eureka-server 保存服务名称到服务实例地址列表的映射关系</li>
<li><strong>每一个</strong> order-service 根据服务名称，拉取实例地址列表，这个叫<strong>服务发现</strong>或服务拉取</li>
</ul>
<blockquote>
<p><strong>order-service 如何从多个 user-service 实例中选择具体的实例？</strong></p>
</blockquote>
<p>eureka-server 发给 order-service 所有注册了的 user-service 实例，然后 order-service 从实例列表中利用<strong>负载均衡算法</strong>选中一个实例地址，向该实例地址发起远程调用 (发请求)</p>
<blockquote>
<p><strong>order-service 如何得知某个 user-service 实例是否依然健康，是不是已经宕机？</strong></p>
</blockquote>
<ul>
<li><strong>每一个</strong> user-service 会<strong>每隔一段时间 (默认 30 秒) 向 eureka-server 发起请求</strong>，报告自己状态，称为<strong>心跳</strong></li>
<li>当超过一定时间没有发送心跳时，eureka-server 会认为微服务实例故障，<mark>将该实例从服务列表中剔除</mark></li>
<li>order-service 拉取服务时，就能将故障实例排除了</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220217223244970.png" alt="image-20220217223244970"></p>
<p>接下来我们动手实践的步骤包括：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901090932.png" alt=""></p>
<h2 id="搭建注册中心"><a class="markdownIt-Anchor" href="#搭建注册中心">#</a> 搭建注册中心</h2>
<p><strong>搭建 eureka-server</strong></p>
<p>引入 SpringCloud 为 eureka 提供的 starter 依赖，注意这里是用 <strong>server</strong></p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-netflix-eureka-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>编写启动类</strong></p>
<p>注意要添加一个  <code>@EnableEurekaServer</code>  <strong>注解</strong>，开启 eureka 的<strong>注册中心</strong>功能</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xn2001<span class="token punctuation">.</span>eureka</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span></span><span class="token class-name">SpringApplication</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span></span><span class="token class-name">SpringBootApplication</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>netflix<span class="token punctuation">.</span>eureka<span class="token punctuation">.</span>server<span class="token punctuation">.</span></span><span class="token class-name">EnableEurekaServer</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableEurekaServer</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EurekaApplication</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">EurekaApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>编写配置文件</strong></p>
<p>编写一个 application.yml 文件，内容如下：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10086</span>  <span class="token comment">#服务端口</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> eureka<span class="token punctuation">-</span>server <span class="token comment">#eureka的服务名称</span>
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>  <span class="token comment">#eureka地址信息->127.0.0.1可以换成localhost或者其他IP地址等</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>10086/eureka<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中  <code>default-zone</code>  是因为前面配置类开启了注册中心所需要配置的 eureka 的<strong>地址信息</strong>，因为 eureka 本身也是一个微服务，这里也要将自己注册到 eureka 上 (自己注册自己)，当后面 eureka <strong>集群</strong>时，这里就可以填写多个，使用 “,” 隔开。</p>
<p>启动完成后，访问 <a target="_blank" rel="noopener" href="http://localhost">http://localhost</a>:10086/</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901090945.png" alt=""></p>
<h2 id="服务注册"><a class="markdownIt-Anchor" href="#服务注册">#</a> 服务注册</h2>
<blockquote>
<p>将 user-service、order-service 都注册到 eureka</p>
</blockquote>
<p>引入 SpringCloud 为 eureka 提供的 starter 依赖，注意这里是用 <strong>client</strong></p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-netflix-eureka-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>在启动类上添加注解： <code>@EnableEurekaClient</code></p>
<p>在 application.yml 文件，添加下面的配置：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
      <span class="token comment">#name：orderservice</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> userservice <span class="token comment">#注册到eureka的当前服务名称</span>
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span> <span class="token comment">#eureka服务的地址</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>127.0.0.1<span class="token punctuation">:</span>10086/eureka<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>注意这里是 eureka 的客户端 (client, 之前我们那是服务端)</p>
<p>注意上面的 xml 文件的依赖配置和 yaml 的服务注册到 eureka 都是在那个被注册的服务的本身的 pom.xml 和 resources 下的 application.yml 文件里面</p>
<p>因为提供者服务和消费者服务都需要注册到 eureka 所以我们在挨个服务都要配置上面的</p>
</blockquote>
<blockquote>
<p>注意～！！！</p>
<p>我们为了模仿分布式把每个微服务的端口改了</p>
<p>所以 user 微服务和 order 微服务的端口号不一样的</p>
</blockquote>
<p>3 个项目启动后，访问 <a target="_blank" rel="noopener" href="http://localhost">http://localhost</a>:10086/</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901090958.png" alt=""></p>
<p>这里另外再补充个小技巧，我们可以通过 idea 的多实例启动，来查看 Eureka 的集群效果。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901091005.png" alt=""></p>
<p>4 个项目启动后，访问 <a target="_blank" rel="noopener" href="http://localhost">http://localhost</a>:10086/</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901091015.png" alt=""></p>
<p>两个 user 微服务的实例都注册到了 eureka 服务端</p>
<h2 id="服务拉取"><a class="markdownIt-Anchor" href="#服务拉取">#</a> 服务拉取</h2>
<blockquote>
<p>在 order-service 中完成服务拉取，然后通过负载均衡挑选一个服务，实现远程调用</p>
</blockquote>
<p>下面我们让 order-service 向 eureka-server 拉取 user-service 的信息，实现服务发现。</p>
<p>所以在 order-service 这个微服务里面:</p>
<p>首先给  <code>RestTemplate</code>  这个 Bean 添加一个  <code>@LoadBalanced</code>  <strong>注解</strong>，用于开启<strong>负载均衡</strong>。（后面会讲）</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Bean</span>
<span class="token annotation punctuation">@LoadBalanced</span>
<span class="token keyword">public</span> <span class="token class-name">RestTemplate</span> <span class="token function">restTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>修改 OrderService 访问的 url 路径，用<strong>服务名</strong> (就是当初我们注册那个服务给的名) 代替 ip、端口：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901091216.png" alt=""></p>
<p>spring 会自动帮助我们从 eureka-server 中，根据 userservice 这个服务名称，获取实例列表后去完成负载均衡。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220217230956923.png" alt="image-20220217230956923"></p>
<hr>
<h1 id="ribbon负载均衡"><a class="markdownIt-Anchor" href="#ribbon负载均衡">#</a> Ribbon 负载均衡</h1>
<blockquote>
<p>案例源码：<a target="_blank" rel="noopener" href="https://gitee.com/xn2001/cloudcode/tree/master/04-cloud-ribbon">https://gitee.com/xn2001/cloudcode/tree/master/04-cloud-ribbon</a></p>
</blockquote>
<p>我们添加了  <code>@LoadBalanced</code>  注解，即可实现负载均衡功能，这是什么原理呢？</p>
<p><strong>SpringCloud 底层提供了一个名为 Ribbon 的组件，来实现负载均衡功能。</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901091242.png" alt=""></p>
<blockquote>
<p>只要给那个注册 RestTemplate 类的对象到 IOC 容器的那个方法上面加上个 <code>@LoadBalanced</code>  注解，就证明之后用这个 RestTemplate 的方法发送请求，那个请求就会被 ribbon 拦截，然后 ribbon 就会询问 eureka 服务端得到那个传来的请求里面的那个服务名对应的所有服务实例，然后做 load balancing 选一个服务实例把请求里面的服务名换成选到的服务实例的 IP 地址和端口号，所以 order-service 可以访问到一个 user-service 服务实例</p>
</blockquote>
<h2 id="源码跟踪"><a class="markdownIt-Anchor" href="#源码跟踪">#</a> 源码跟踪</h2>
<p>为什么我们只输入了 service 名称就可以访问了呢？为什么不需要获取 ip 和端口，这显然有人帮我们根据 service 名称，获取到了服务实例的 ip 和端口。它就是 <code>LoadBalancerInterceptor</code> ，这个类会在对 RestTemplate 的请求进行拦截，然后从 Eureka 根据服务 id 获取服务列表，随后利用负载均衡算法得到真实的服务地址信息，替换服务 id。</p>
<p>我们进行源码跟踪：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901091323.png" alt=""></p>
<p>这里的  <code>intercept()</code>  方法，拦截了用户的 HttpRequest 请求，然后做了几件事：</p>
<ul>
<li><code>request.getURI()</code> ：获取请求 uri，即 <a target="_blank" rel="noopener" href="http://user-service/user/8">http://user-service/user/8</a></li>
<li><code>originalUri.getHost()</code> ：获取 uri 路径的主机名，其实就是服务 id  <code>user-service</code></li>
<li><code>this.loadBalancer.execute()</code> ：处理服务 id，和用户请求</li>
</ul>
<p>这里的  <code>this.loadBalancer</code>  是  <code>LoadBalancerClient</code>  类型</p>
<p>继续跟入  <code>execute()</code>  方法：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901091330.png" alt=""></p>
<ul>
<li><code>getLoadBalancer(serviceId)</code> ：根据服务 id 获取  <code>ILoadBalancer</code> ，而  <code>ILoadBalancer</code>  会拿着服务 id 去 eureka 中获取服务列表。</li>
<li><code>getServer(loadBalancer)</code> ：利用内置的负载均衡算法，从服务列表中选择一个。在图中<strong>可以看到获取了 8082 端口的服务</strong></li>
</ul>
<p>可以看到获取服务时，通过一个  <code>getServer()</code>  方法来做负载均衡:</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901091345.png" alt=""></p>
<p>我们继续跟入：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901091355.png" alt=""></p>
<p>继续跟踪源码  <code>chooseServer()</code>  方法，发现这么一段代码：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901091414.png" alt=""></p>
<p>我们看看这个  <code>rule</code>  是谁：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901091432.png" alt=""></p>
<p>这里的 rule 默认值是一个  <code>RoundRobinRule</code>  ，看类的介绍：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901091442.png" alt=""></p>
<p>负载均衡默认使用了轮询算法，当然我们也可以自定义。</p>
<h2 id="流程总结"><a class="markdownIt-Anchor" href="#流程总结">#</a> 流程总结</h2>
<p>SpringCloud Ribbon 底层采用了一个拦截器，拦截了 RestTemplate 发出的请求，对地址做了修改。</p>
<p>基本流程如下：</p>
<ul>
<li>拦截我们的  <code>RestTemplate</code>  请求 <a target="_blank" rel="noopener" href="http://userservice/user/1">http://userservice/user/1</a></li>
<li><code>RibbonLoadBalancerClient</code>  会从请求 url 中获取服务名称，也就是 user-service</li>
<li><code>DynamicServerListLoadBalancer</code>  根据 user-service 到 eureka 拉取服务列表</li>
<li>eureka 返回列表，localhost:8081、localhost:8082</li>
<li><code>IRule</code>  (IRule 有接口，他有很多实现类，对应着不同的 load balancing 的选择方式，上面的是轮询算法挑选的) 利用内置负载均衡规则，从列表中选择一个，例如 localhost:8081</li>
<li><code>RibbonLoadBalancerClient</code>  修改请求地址，用 localhost:8081 替代 userservice，得到 <a target="_blank" rel="noopener" href="http://localhost">http://localhost</a>:8081/user/1，发起真实请求</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901091755.png" alt=""></p>
<h2 id="负载均衡策略"><a class="markdownIt-Anchor" href="#负载均衡策略">#</a> 负载均衡策略</h2>
<p>负载均衡的规则都定义在 IRule 接口中，而 IRule 有很多不同的实现类：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901091811.png" alt=""></p>
<p>不同规则的含义如下：</p>
<table>
<thead>
<tr>
<th><strong>内置负载均衡规则类</strong></th>
<th><strong>规则描述</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>RoundRobinRule</td>
<td>简单轮询服务列表来选择服务器。它是 Ribbon 默认的负载均衡规则。</td>
</tr>
<tr>
<td>AvailabilityFilteringRule</td>
<td>对以下两种服务器进行忽略：（1）在默认情况下，这台服务器如果 3 次连接失败，这台服务器就会被设置为 “短路” 状态。短路状态将持续 30 秒，如果再次连接失败，短路的持续时间就会几何级地增加。 （2）并发数过高的服务器。如果一个服务器的并发连接数过高，配置了 AvailabilityFilteringRule 规则的客户端也会将其忽略。并发连接数的上限，可以由客户端设置。</td>
</tr>
<tr>
<td>WeightedResponseTimeRule</td>
<td>为每一个服务器赋予一个权重值。服务器响应时间越长，这个服务器的权重就越小。这个规则会随机选择服务器，这个权重值会影响服务器的选择。</td>
</tr>
<tr>
<td><strong>ZoneAvoidanceRule (默认)</strong></td>
<td>以区域可用的服务器为基础进行服务器的选择。使用 Zone 对服务器进行分类，这个 Zone 可以理解为一个机房、一个机架等。而后再对 Zone 内的多个服务做轮询。</td>
</tr>
<tr>
<td>BestAvailableRule</td>
<td>忽略那些短路的服务器，并选择并发数较低的服务器。</td>
</tr>
<tr>
<td>RandomRule</td>
<td>随机选择一个可用的服务器。</td>
</tr>
<tr>
<td>RetryRule</td>
<td>重试机制的选择逻辑</td>
</tr>
</tbody>
</table>
<p>默认的实现就是  <code>ZoneAvoidanceRule</code> ，<strong>是一种轮询方案</strong>。</p>
<h2 id="自定义策略"><a class="markdownIt-Anchor" href="#自定义策略">#</a> 自定义策略</h2>
<p>通过定义 IRule 实现可以修改负载均衡规则，有两种方式：</p>
<ol>
<li>代码方式在 order-service 中的 OrderApplication 类中，定义一个新的 IRule：</li>
</ol>
<blockquote>
<p>这种方式是给所有可能会请求的提供服务来配置的负载均衡规则，而不是特定哪个微服务</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901091832.png" alt=""></p>
<ol start="2">
<li>配置文件方式：在 order-service 的 application.yml 文件中，添加新的配置也可以修改规则：</li>
</ol>
<blockquote>
<p>这种方式是给某个指定的微服务来配置负载均衡规则</p>
</blockquote>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">userservice</span><span class="token punctuation">:</span> <span class="token comment"># 给需要调用的微服务配置负载均衡规则，orderservice服务去调用userservice服务</span>
  <span class="token key atrule">ribbon</span><span class="token punctuation">:</span>
    <span class="token key atrule">NFLoadBalancerRuleClassName</span><span class="token punctuation">:</span> com.netflix.loadbalancer.RandomRule <span class="token comment"># 负载均衡规则` </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><strong>注意</strong>：一般用默认的负载均衡规则，不做修改。</p>
<blockquote>
<p>上面的就是改为 RandomRule 这个 IRule 接口的实现类，然后按照 RandomRule 里面定义的规则去做 load balancing 选择服务的规则</p>
</blockquote>
<blockquote>
<p>注意上方的不管是什么方式，都是在 order-service 微服务 (消费者) 里面配置的</p>
</blockquote>
<h2 id="饥饿加载"><a class="markdownIt-Anchor" href="#饥饿加载">#</a> 饥饿加载</h2>
<p>当我们启动 orderservice，第一次访问 (别的微服务) 时，时间消耗会大很多，这是因为 Ribbon 懒加载的机制。<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901091850.png" alt=""></p>
<p>Ribbon 默认是采用__懒加载__，即第一次访问时才会去创建 LoadBalanceClient，拉取集群地址，所以请求时间会很长。</p>
<p>不过之后的加载都不会那么长，因为已经被缓存到内存当中了，以后想用直接用就行.</p>
<p><mark>而饥饿加载则会在项目启动时创建 LoadBalanceClient，降低第一次访问的耗时，通过下面配置开启饥饿加载：</mark></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">ribbon</span><span class="token punctuation">:</span>
  <span class="token key atrule">eager-load</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">clients</span><span class="token punctuation">:</span> userservice <span class="token comment"># 项目启动时直接去拉取userservice的集群，多个用","隔开,或者是yaml的数组的写法</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<h1 id="nacos注册中心"><a class="markdownIt-Anchor" href="#nacos注册中心">#</a> Nacos 注册中心</h1>
<blockquote>
<p>源码案例：<a target="_blank" rel="noopener" href="https://gitee.com/xn2001/cloudcode/tree/master/05-cloud-nacos">https://gitee.com/xn2001/cloudcode/tree/master/05-cloud-nacos</a></p>
</blockquote>
<p>SpringCloudAlibaba 推出了一个名为 Nacos 的注册中心，在国外也有大量的使用。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901091857.png" alt=""></p>
<p>解压启动 Nacos，详细请看 <a target="_blank" rel="noopener" href="https://www.xn2001.com/archives/661.html">Nacos 安装指南</a></p>
<pre class="line-numbers language-cmd" data-language="cmd"><code class="language-cmd">startup.cmd -m standalone<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>访问：<a target="_blank" rel="noopener" href="http://localhost">http://localhost</a>:8848/nacos/</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901091904.png" alt=""></p>
<h2 id="服务注册-2"><a class="markdownIt-Anchor" href="#服务注册-2">#</a> 服务注册</h2>
<p>这里上来就直接服务注册，很多东西可能有疑惑，<strong>其实 Nacos 本身就是一个 SprintBoot 项目</strong>，这点你从启动的控制台打印就可以看出来，<mark>所以就不再需要去额外搭建一个像 Eureka 的注册中心 (不用自己写一个 eureka 服务端了，直接注册我们那些微服务就行)。</mark></p>
<p><strong>引入依赖</strong></p>
<p>在 cloud-demo 父工程中引入 SpringCloudAlibaba 的依赖：</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-alibaba-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.2.6.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">></span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后在 user-service 和 order-service 中的 pom 文件中引入 nacos-discovery 依赖：</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>配置 nacos 地址</strong></p>
<p>在 user-service 和 order-service 的 application.yml 中添加 nacos 地址：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>其他我们之前 ribbon 和 eureka 那些不用动 (除了注释掉了那些依赖啥的), 都一样的，会生效</p>
</blockquote>
<p>项目重新启动后，可以看到三个服务都被注册进了 Nacos</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901091918.png" alt=""></p>
<p>浏览器访问：<a target="_blank" rel="noopener" href="http://localhost">http://localhost</a>:8080/order/101，正常访问，同时负载均衡也正常。</p>
<h2 id="分级存储模型"><a class="markdownIt-Anchor" href="#分级存储模型">#</a> 分级存储模型</h2>
<p>一个<strong>服务</strong>可以有多个<strong>实例</strong>，例如我们的 user-service，可以有:</p>
<ul>
<li>127.0.0.1:8081</li>
<li>127.0.0.1:8082</li>
<li>127.0.0.1:8083</li>
</ul>
<p>假如这些实例分布于全国各地的不同机房，例如：</p>
<ul>
<li>127.0.0.1:8081，在上海机房</li>
<li>127.0.0.1:8082，在上海机房</li>
<li>127.0.0.1:8083，在杭州机房</li>
</ul>
<p>Nacos 就将同一机房内的实例，划分为一个<strong>集群</strong>。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901091928.png" alt=""></p>
<p>微服务互相访问时，<mark>应该尽可能访问同集群实例</mark>，因为本地访问速度更快。<strong>当本集群内不可用时，才访问其它集群。</strong> 例如：杭州机房内的 order-service 应该优先访问同机房的 user-service。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901091937.png" alt=""></p>
<h2 id="配置集群"><a class="markdownIt-Anchor" href="#配置集群">#</a> 配置集群</h2>
<p>接下来我们给 user-service <strong>配置集群</strong></p>
<p>修改 user-service 的 application.yml 文件，添加集群配置：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8848</span>     
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">cluster-name</span><span class="token punctuation">:</span> HZ <span class="token comment"># 集群名称 HZ杭州</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>重启两个 user-service 实例后，我们再去启动一个上海集群的实例。</p>
<pre class="line-numbers language-cmd" data-language="cmd"><code class="language-cmd">-Dserver.port&#x3D;8083 -Dspring.cloud.nacos.discovery.cluster-name&#x3D;SH<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901091947.png" alt=""></p>
<p>查看 nacos 控制台：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901091957.png" alt=""></p>
<h2 id="nacosrule"><a class="markdownIt-Anchor" href="#nacosrule">#</a> NacosRule</h2>
<p>Ribbon 的默认实现  <code>ZoneAvoidanceRule</code>  并不能实现根据同集群优先来实现负载均衡，我们把规则改成 <strong>NacosRule</strong> 即可。我们是用 orderservice 调用 userservice，所以在 orderservice 配置规则。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">IRule</span> <span class="token function">iRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token comment">//默认为轮询规则，这里自定义为随机规则</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">NacosRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>__另外，你同样可以__使用配置的形式来完成，具体参考上面的 Ribbon 栏目。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">userservice</span><span class="token punctuation">:</span>
  <span class="token key atrule">ribbon</span><span class="token punctuation">:</span>
    <span class="token key atrule">NFLoadBalancerRuleClassName</span><span class="token punctuation">:</span> com.alibaba.cloud.nacos.ribbon.NacosRule <span class="token comment">#负载均衡规则` </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>然后，再对 orderservice 配置集群。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8848</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">cluster-name</span><span class="token punctuation">:</span> HZ <span class="token comment"># 集群名称</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>现在我启动了四个服务，分别是：</p>
<ul>
<li>orderservice - HZ</li>
<li>userservice - HZ</li>
<li>userservice1 - HZ</li>
<li>userservice2 - SH</li>
</ul>
<p>访问地址：<a target="_blank" rel="noopener" href="http://localhost">http://localhost</a>:8080/order/101</p>
<p>在访问中我们发现，只有同在一个 HZ 集群下的 userservice、userservice1 会被调用，<strong>并且是随机的</strong>。</p>
<p>我们试着把 userservice、userservice2 停掉。依旧可以访问。</p>
<blockquote>
<p>在 orderservice 控制台可以看到发出了一串的警告，因为 orderservice 本身是在 HZ 集群的，这波 HZ 集群没有了 userservice，就会去别的集群找。</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901092012.png" alt=""></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220218002035575.png" alt="image-20220218002035575"></p>
<h2 id="权重配置"><a class="markdownIt-Anchor" href="#权重配置">#</a> 权重配置</h2>
<p>实际部署中会出现这样的场景：</p>
<p>服务器设备性能有差异，部分实例所在机器性能较好，另一些较差，我们希望性能好的机器承担更多的用户请求。但默认情况下 NacosRule 是同集群内随机挑选，不会考虑机器的性能问题。</p>
<p>因此，Nacos 提供了<strong>权重配置来控制访问频率</strong>，0~1 之间，权重越大则访问频率越高，权重修改为 0，则该实例永远不会被访问。</p>
<p>在 Nacos 控制台，找到 user-service 的实例列表，点击编辑，即可修改权重。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901092020.png" alt=""></p>
<p>在弹出的编辑窗口，修改权重</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901092026.png" alt=""></p>
<blockquote>
<p>另外，在服务升级的时候，有一种较好的方案：我们也可以通过调整权重来进行平滑升级，例如：先把 userservice 权重调节为 0，让用户先流向 userservice2、userservice3，升级 userservice 后，再把权重从 0 调到 0.1，让一部分用户先体验，用户体验稳定后就可以往上调权重啦。</p>
</blockquote>
<h2 id="环境隔离"><a class="markdownIt-Anchor" href="#环境隔离">#</a> 环境隔离</h2>
<p>Nacos 提供了 namespace 来实现环境隔离功能。</p>
<ul>
<li>Nacos 中可以有多个 namespace</li>
<li>namespace 下可以有 group、service 等</li>
<li>不同 namespace 之间<strong>相互隔离</strong>，例如不同 namespace 的服务互相不可见</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901092032.png" alt=""></p>
<h3 id="创建namespace"><a class="markdownIt-Anchor" href="#创建namespace">#</a> 创建 namespace</h3>
<p>默认情况下，所有 service、data、group 都在同一个 namespace，名为 public (保留空间)：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901092038.png" alt=""></p>
<p>我们可以点击页面新增按钮，添加一个 namespace：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901092050.png" alt=""></p>
<p>然后，填写表单：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901092059.png" alt=""></p>
<p>就能在页面看到一个新的 namespace：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901092114.png" alt=""></p>
<h3 id="配置namespace"><a class="markdownIt-Anchor" href="#配置namespace">#</a> 配置 namespace</h3>
<p>给微服务配置 namespace 只能通过修改配置来实现。</p>
<p>例如，修改 order-service 的 application.yml 文件：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8848</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">cluster-name</span><span class="token punctuation">:</span> HZ
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> 492a7d5d<span class="token punctuation">-</span>237b<span class="token punctuation">-</span>46a1<span class="token punctuation">-</span>a99a<span class="token punctuation">-</span>fa8e98e4b0f9 <span class="token comment"># 命名空间ID</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>重启 order-service 后，访问控制台。</p>
<p><strong>public</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901092143.png" alt=""></p>
<p><strong>dev</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901092130.png" alt=""></p>
<p><strong><mark>此时访问 order-service，因为 namespace 不同，会导致找不到 userservice，控制台会报错：</mark></strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901092138.png" alt=""></p>
<h2 id="临时实例"><a class="markdownIt-Anchor" href="#临时实例">#</a> 临时实例</h2>
<p>Nacos 的服务实例分为两种类型：</p>
<ul>
<li><strong>临时实例</strong>：如果实例宕机超过一定时间，会从服务列表剔除，<strong>默认的类型</strong>。</li>
<li>非临时实例：如果实例宕机，不会从服务列表剔除，也可以叫永久实例。</li>
</ul>
<p>配置一个服务实例为永久实例：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">ephemeral</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># 设置为非临时实例</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>另外，Nacos 集群<strong>默认采用 AP 方式 (可用性)</strong>，当集群中存在非临时实例时，<strong>采用 CP 模式 (一致性)</strong>；而 Eureka 采用 AP 方式，不可切换。（这里说的是 CAP 原理，后面会写到）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220218003024265.png" alt="image-20220218003024265"></p>
<h2 id="nacos和eureka区别"><a class="markdownIt-Anchor" href="#nacos和eureka区别">#</a> Nacos 和 Eureka 区别</h2>
<ul>
<li>首先先说下消费者会从注册中心 (nacos or eureka) 拉取他请求的服务的服务集群列表，这个是会存到缓存中，这样就不会每次调用都会重新从注册中心 (nacos or eureka) 拉取然后各种 load balancing 等等等，而是用内存中的然后各种 load balancing 等等等</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220218003614493.png" alt="image-20220218003614493"></p>
<p>任何注册的服务是临时实例 (默认你注册的都是临时实例) 的话，那么就跟 eureka 一样会是过多久多久的心跳检测，<strong> 如果临时实例服务挂了，那么 nacos 注册中心直接会把这个服务剔除</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220218004029000.png" alt="image-20220218004029000"></p>
<p>而非临时实例则不会发心跳检测让 nacos 注册中心知道自己还活着，而是 nacos 注册中心自己发请求到那个非临时实例问他还活着，<strong> 如果非临时实例服务挂了，那么 nacos 注册中心不会把这个服务剔除，而是把它标为不健康</strong></p>
<p>设置非临时实例:</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220218004328217.png" alt="image-20220218004328217"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220218004101730.png" alt="image-20220218004101730"></p>
<p>要是一个提供者挂了，那么 eureka 的注册中心不会主动推送变更消息让消费者知道他请求的提供者挂了，可能会出问题</p>
<p>而 nacos 的注册中心发现那个提供者服务挂了，则会立即主动推送变更消息让消费者知道他请求的提供者挂了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220218004617853.png" alt="image-20220218004617853"></p>
<hr>
<h1 id="nacos配置中心"><a class="markdownIt-Anchor" href="#nacos配置中心">#</a> Nacos 配置中心</h1>
<blockquote>
<p>案例地址：<a target="_blank" rel="noopener" href="https://gitee.com/xn2001/cloudcode/tree/master/05-cloud-nacos">https://gitee.com/xn2001/cloudcode/tree/master/05-cloud-nacos</a></p>
</blockquote>
<p>Nacos 除了可以做注册中心，同样可以做配置管理来使用。</p>
<p>当微服务部署的实例越来越多，达到数十、数百时，逐个修改微服务配置就会让人抓狂，而且很容易出错。<strong>我们需要一种统一配置管理方案，可以集中管理所有实例的配置。</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901092150.png" alt=""></p>
<p>Nacos 一方面可以将配置集中管理，另一方可以在配置变更时，及时通知微服务，<strong>实现配置的热更新。</strong></p>
<h2 id="创建配置"><a class="markdownIt-Anchor" href="#创建配置">#</a> 创建配置</h2>
<p>在 Nacos 控制面板中添加配置文件</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901092159.png" alt=""></p>
<p>然后在弹出的表单中，填写配置信息：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901092206.png" alt=""></p>
<blockquote>
<p><strong>注意：</strong> 项目的核心配置，需要热更新的配置才有放到 nacos 管理的必要。基本不会变更的一些配置 (例如数据库连接) 还是保存在微服务本地比较好。</p>
</blockquote>
<h2 id="拉取配置"><a class="markdownIt-Anchor" href="#拉取配置">#</a> 拉取配置</h2>
<p>首先我们需要了解 Nacos 读取配置文件的环节是在哪一步，在没加入 Nacos 配置之前，获取配置是这样：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901092215.png" alt=""></p>
<p>加入 Nacos 配置，它的读取是在 application.yml 之前的：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901092223.png" alt=""></p>
<p>这时候如果把 nacos 地址放在 application.yml 中，显然是不合适的，<strong>Nacos 就无法根据地址去获取配置了。</strong></p>
<p><strong><mark>因此，nacos 地址必须放在优先级最高的 bootstrap.yml 文件。</mark></strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901092228.png" alt=""></p>
<p><strong>引入 nacos-config 依赖</strong></p>
<p>首先，在 user-service 服务中，引入 nacos-config 的客户端依赖：</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token comment">&lt;!--nacos配置管理依赖--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-alibaba-nacos-config<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>添加 bootstrap.yml</strong></p>
<p>然后，在 user-service 中添加一个 bootstrap.yml 文件，内容如下：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> userservice <span class="token comment"># 服务名称</span>
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span>
    <span class="token key atrule">active</span><span class="token punctuation">:</span> dev <span class="token comment">#开发环境，这里是dev </span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment"># Nacos地址</span>
      <span class="token key atrule">config</span><span class="token punctuation">:</span>
        <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yaml <span class="token comment"># 文件后缀名</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>根据 spring.cloud.nacos.server-addr 获取 nacos 地址，再根据 <code>$&#123;spring.application.name&#125;-$&#123;spring.profiles.active&#125;.$&#123;spring.cloud.nacos.config.file-extension&#125;</code>  作为文件 id (就是我们 nacos 里面弄的那个配置文件的 data id)，来读取配置。</p>
<p>在这个例子例中，就是去读取  <code>userservice-dev.yaml</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901092237.png" alt=""></p>
<p>使用代码来验证是否拉取成功</p>
<p>在 user-service 中的 UserController 中添加业务逻辑，读取 pattern.dateformat 配置并使用：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;pattern.dateformat&#125;"</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> dateformat<span class="token punctuation">;</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"now"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token comment">//格式化时间</span>
    <span class="token keyword">return</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span>dateformat<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901092243.png" alt=""></p>
<p>启动服务后，访问：<a target="_blank" rel="noopener" href="http://localhost">http://localhost</a>:8081/user/now</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901092251.png" alt=""></p>
<blockquote>
<p>因为我们是给 userservice 微服务里面设置的 bootstrp.yaml 去找那个 nacos 里的配置，所以在访问 (任何方式) userservice 微服务时就会获取到那些配置</p>
</blockquote>
<h2 id="配置热更新"><a class="markdownIt-Anchor" href="#配置热更新">#</a> 配置热更新</h2>
<p>我们最终的目的，是修改 nacos 中的配置后，微服务中无需重启即可让配置生效，也就是<strong>配置热更新</strong>。</p>
<p>有两种方式：1. 用  <code>@value</code>  读取配置时，搭配  <code>@RefreshScope</code> ；2. 直接用  <code>@ConfigurationProperties</code>  读取配置</p>
<h3 id="refreshscope"><a class="markdownIt-Anchor" href="#refreshscope">#</a> @RefreshScope</h3>
<p>方式一：在  <code>@Value</code>  注入的变量所在类上添加注解  <code>@RefreshScope</code></p>
<blockquote>
<p>这里我们用了那个 nacos 里的配置文件，得要加上 <code>@RefreshScope</code>  才会启动热更新</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901092258.png" alt=""></p>
<h3 id="configurationproperties"><a class="markdownIt-Anchor" href="#configurationproperties">#</a> @ConfigurationProperties</h3>
<p>方式二：使用  <code>@ConfigurationProperties</code>  注解读取配置文件 (才发现竟然除了.properties 文件读取，还可以.yaml 文件读取)，<strong>就不需要加  <code>@RefreshScope</code>  注解。</strong></p>
<p>在 user-service 服务中，添加一个 PatternProperties 类，读取  <code>patterrn.dateformat</code>  属性</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">"pattern"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PatternProperties</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> dateformat<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">PatternProperties</span> patternProperties<span class="token punctuation">;</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"now2"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">now2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token comment">//格式化时间</span>
    <span class="token keyword">return</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span>patternProperties<span class="token punctuation">.</span>dateformat<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>这样热更新就能起效果了</p>
<p>只要我们 nacos 里的那个配置文件内容发生改变，不需要我们重新重启项目啊什么的，我们 nacos 会通知我们的微服务然后让他们读取这个更改后的配置文件内容，然后就生效了，不需要重新项目</p>
</blockquote>
<h2 id="配置共享"><a class="markdownIt-Anchor" href="#配置共享">#</a> 配置共享</h2>
<p>其实在服务启动时，nacos 会读取多个配置文件，例如：</p>
<ul>
<li><code>[spring.application.name]-[spring.profiles.active].yaml</code> ，例如：userservice-dev.yaml</li>
<li><code>[spring.application.name].yaml</code> ，例如：userservice.yaml</li>
</ul>
<p>这里的  <code>[spring.application.name].yaml</code>  不包含环境，<strong>因此可以被多个环境 (dev,test,…) 共享</strong>。</p>
<p><strong>添加一个环境共享配置</strong></p>
<p>我们在 nacos 中添加一个 userservice.yaml 文件：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901092323.png" alt=""></p>
<p><strong>在 user-service 中读取共享配置</strong></p>
<p>在 user-service 服务中，修改 PatternProperties 类，读取新添加的属性：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901092314.png" alt=""></p>
<p>在 user-service 服务中，修改 UserController，添加一个方法：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901092331.png" alt=""></p>
<p><strong>运行两个 UserApplication，使用不同的 profile</strong></p>
<p>修改 UserApplication2 这个启动项，改变其 profile 值：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901092345.png" alt=""></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901092338.png" alt=""></p>
<p>这样，UserApplication (8081) 使用的 profile 是 dev，UserApplication2 (8082) 使用的 profile 是 test</p>
<p>启动 UserApplication 和 UserApplication2</p>
<p>访问地址：<a target="_blank" rel="noopener" href="http://localhost">http://localhost</a>:8081/user/prop，结果：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901092400.png" alt=""></p>
<p>访问地址：<a target="_blank" rel="noopener" href="http://localhost">http://localhost</a>:8082/user/prop，结果：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901092419.png" alt=""></p>
<p>可以看出来，不管是 dev，还是 test 环境，都读取到了 envSharedValue 这个属性的值。</p>
<p>上面的都是同一个微服务下，<strong>那么不同微服务之间可以环境共享吗？</strong></p>
<p>通过下面的两种方式来指定：</p>
<ul>
<li>extension-configs</li>
<li>shared-configs</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span> 
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">config</span><span class="token punctuation">:</span>
        <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yaml <span class="token comment"># 文件后缀名</span>
        <span class="token key atrule">extends-configs</span><span class="token punctuation">:</span> <span class="token comment"># 多微服务间共享的配置列表</span>
          <span class="token punctuation">-</span> <span class="token key atrule">dataId</span><span class="token punctuation">:</span> common.yaml <span class="token comment"># 要共享的配置文件id</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span> 
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">config</span><span class="token punctuation">:</span>
        <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yaml <span class="token comment"># 文件后缀名</span>
        <span class="token key atrule">shared-configs</span><span class="token punctuation">:</span> <span class="token comment"># 多微服务间共享的配置列表</span>
          <span class="token punctuation">-</span> <span class="token key atrule">dataId</span><span class="token punctuation">:</span> common.yaml <span class="token comment"># 要共享的配置文件id</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="配置优先级"><a class="markdownIt-Anchor" href="#配置优先级">#</a> 配置优先级</h2>
<p>当 nacos、服务本地同时<strong>出现相同属性时</strong>，优先级有高低之分。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901092501.png" alt=""></p>
<p>更细致的配置</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901092520.png" alt=""></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220218012924754.png" alt="image-20220218012924754"></p>
<h2 id="nacos集群"><a class="markdownIt-Anchor" href="#nacos集群">#</a> Nacos 集群</h2>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220218013938908.png" alt="image-20220218013938908"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220218014201197.png" alt="image-20220218014201197"></p>
<p>所以我们先__模拟 (只是模拟，real life 可能不一样)__三个 nacos 节点:</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220218014241200.png" alt="image-20220218014241200"></p>
<p><strong>注意点：修改两个配置文件：</strong></p>
<ul>
<li>修改 cluster.conf<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/3216cabcbd0e4331951b0539c31398ea.png" alt=""></li>
</ul>
<blockquote>
<p>上面那些就是集群中每一个 nacos 节点的信息</p>
</blockquote>
<ul>
<li>修改 Nacos 的 application.properties（不是你的 application.properties）</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/7ed93f53205e4c219fa102ee94f26c75.png" alt=""><br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/b55826b031c6459b9bbeb324e3f4ed62.png" alt=""></p>
<p>修改完成后保存即可。</p>
<ul>
<li><strong>使用 Nginx 对 Nacos 做反向代理</strong><br>
这里需要 Nginx 前置知识，可以看我以下这一篇文章：<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44757863/article/details/120117645?spm=1001.2014.3001.5501">Nginx 入门：通俗理解反向代理和负载均衡，简单配置 Nginx</a></li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220218014826273.png" alt="image-20220218014826273"></p>
<blockquote>
<p>然后在我们微服务的配置文件中</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220218015109186.png" alt="image-20220218015109186"></p>
</blockquote>
<p><strong>如果你的 Nacos 配置集群死活报下图的错误：</strong><br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/ea27fbe5628245fe942f600536830f5e.png" alt=""></p>
<p>请检查你的 MySQL 版本，需要在 5.7 及以上，而且在 8.0 以下（比较苛刻）</p>
<blockquote>
<p>这样我们在 nacos 服务端的页面里面写配置文件，这些都是会存 (持久化) 到我们连接的 mysql (集群) 里的</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220218015532407.png" alt="image-20220218015532407"></p>
<hr>
<h1 id="feign远程调用"><a class="markdownIt-Anchor" href="#feign远程调用">#</a> Feign 远程调用</h1>
<blockquote>
<p>案例地址：<a target="_blank" rel="noopener" href="https://gitee.com/xn2001/cloudcode/tree/master/06-cloud-feign">https://gitee.com/xn2001/cloudcode/tree/master/06-cloud-feign</a></p>
</blockquote>
<p>我们以前利用 RestTemplate 发起远程调用的代码：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901092616.png" alt=""></p>
<ul>
<li>代码可读性差，编程体验不统一</li>
<li>参数复杂 URL 难以维护</li>
</ul>
<p>Feign 是一个声明式的 http 客户端，官方地址：<a target="_blank" rel="noopener" href="https://github.com/OpenFeign/feign">https://github.com/OpenFeign/feign</a></p>
<p>其作用就是帮助我们<strong>优雅的实现 http 请求的发送</strong>，解决上面提到的问题。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901092639.png" alt=""></p>
<h2 id="feign使用"><a class="markdownIt-Anchor" href="#feign使用">#</a> Feign 使用</h2>
<p><strong>引入依赖</strong></p>
<p>我们在 order-service 引入 feign 依赖：</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>添加注解</strong></p>
<p>在 order-service 启动类添加注解开启 Feign</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901092704.png" alt=""></p>
<p><strong>请求接口</strong></p>
<p>在 order-service 中新建一个接口，内容如下</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>order<span class="token punctuation">.</span>client</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>order<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">User</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>openfeign<span class="token punctuation">.</span></span><span class="token class-name">FeignClient</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PathVariable</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span><span class="token string">"userservice"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserClient</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/user/&#123;id&#125;"</span><span class="token punctuation">)</span>
    <span class="token class-name">User</span> <span class="token function">findById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>@FeignClient(&quot;userservice&quot;)</code> ：其中参数填写的是 (提供者) 微服务名</p>
<p><code>@GetMapping(&quot;/user/&#123;id&#125;&quot;)</code> ：其中参数填写的是请求路径</p>
<p>这个客户端主要是基于 SpringMVC 的注解  <code>@GetMapping</code>  来声明远程调用的信息</p>
<p>Feign 可以帮助我们发送 http 请求，无需自己使用 RestTemplate 来发送了。</p>
<blockquote>
<p>就这么在消费者微服务里面写个这么一个接口就行了</p>
<p>之后在我们的 orderservice 微服务里面要是用的话就直接拿这个接口 UserClient 调这个方法 findById 就行了</p>
</blockquote>
<p><strong>测试</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">UserClient</span> userClient<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token class-name">Order</span> <span class="token function">queryOrderAndUserById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> orderId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 1.查询订单</span>
    <span class="token class-name">Order</span> order <span class="token operator">=</span> orderMapper<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// TODO: 2021/8/20 使用feign远程调用</span>
    <span class="token class-name">User</span> user <span class="token operator">=</span> userClient<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3. 将用户信息封装进订单</span>
    order<span class="token punctuation">.</span><span class="token function">setUser</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4.返回</span>
    <span class="token keyword">return</span> order<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>我们要是要用只要声明那个接口类的属性然后自动注入 (IOC 容器会找到 openfeign 实现这个接口的实现类的对象注册到 IOC 容器然后自动注入到我们这里的这个属性)</p>
<p>然后我们只管调用方法就行，把那个 id 值传进去，然后 feign 帮我们按照我们写的那个接口里面那个方法的设置的请求方式，地址，参数，返回值等发送请求并把结果作为给我们的调用那个方法的结果，我们接着可以用各种操作</p>
</blockquote>
<blockquote>
<p>feign 底层已经集合了 ribbon, 可以做到 load balancing</p>
</blockquote>
<h2 id="自定义配置"><a class="markdownIt-Anchor" href="#自定义配置">#</a> 自定义配置</h2>
<p>Feign 可以支持很多的自定义配置，如下表所示：</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>作用</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>feign.Logger.Level</strong></td>
<td>修改日志级别</td>
<td>包含四种不同的级别：NONE、BASIC、HEADERS、FULL</td>
</tr>
<tr>
<td>feign.codec.Decoder</td>
<td>响应结果的解析器</td>
<td>http 远程调用的结果做解析，例如解析 json 字符串为 java 对象</td>
</tr>
<tr>
<td>feign.codec.Encoder</td>
<td>请求参数编码</td>
<td>将请求参数编码，便于通过 http 请求发送</td>
</tr>
<tr>
<td>feign.Contract</td>
<td>支持的注解格式</td>
<td>默认是 SpringMVC 的注解</td>
</tr>
<tr>
<td>feign.Retryer</td>
<td>失败重试机制</td>
<td>请求失败的重试机制，默认是没有，不过会使用 Ribbon 的重试</td>
</tr>
</tbody>
</table>
<p>一般情况下，默认值就能满足我们使用，如果要自定义时，只需要创建自定义的 @Bean 覆盖默认 Bean 即可。下面以日志为例来演示如何自定义配置。</p>
<p>基于配置文件修改 feign 的日志级别可以针对单个服务：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">feign</span><span class="token punctuation">:</span>  
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span> 
      <span class="token key atrule">userservice</span><span class="token punctuation">:</span> <span class="token comment"># 针对某个微服务的配置,这里是对userservice微服务发送的请求</span>
        <span class="token key atrule">loggerLevel</span><span class="token punctuation">:</span> FULL <span class="token comment">#  日志级别` </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>也可以针对所有服务：</strong></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">feign</span><span class="token punctuation">:</span>  
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span> 
      <span class="token key atrule">default</span><span class="token punctuation">:</span> <span class="token comment"># 这里用default就是全局配置，如果是写服务名称，则是针对某个微服务的配置</span>
        <span class="token key atrule">loggerLevel</span><span class="token punctuation">:</span> FULL <span class="token comment">#  日志级别` </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>而日志的级别分为四种：</p>
<ul>
<li>NONE：不记录任何日志信息，这是默认值。</li>
<li>BASIC：仅记录请求的方法，URL 以及响应状态码和执行时间</li>
<li>HEADERS：在 BASIC 的基础上，额外记录了请求和响应的头信息</li>
<li>FULL：记录所有请求和响应的明细，包括头信息、请求体、元数据</li>
</ul>
<p>也可以基于 <strong>Java 代码</strong>来修改日志级别，先声明一个类，然后声明一个 Logger.Level 的对象</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultFeignConfiguration</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Logger<span class="token punctuation">.</span>Level</span> <span class="token function">feignLogLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token class-name">Logger<span class="token punctuation">.</span>Level</span><span class="token punctuation">.</span>BASIC<span class="token punctuation">;</span> <span class="token comment">// 日志级别为BASIC</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果要<strong>全局生效</strong>，将其放到启动类的  <code>@EnableFeignClients</code>  这个注解中：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@EnableFeignClients</span><span class="token punctuation">(</span>defaultConfiguration <span class="token operator">=</span> <span class="token class-name">DefaultFeignConfiguration</span> <span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>如果是<strong>局部生效</strong>，则把它放到对应的  <code>@FeignClient</code>  这个注解中：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"userservice"</span><span class="token punctuation">,</span> configuration <span class="token operator">=</span> <span class="token class-name">DefaultFeignConfiguration</span> <span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220218130328185.png" alt="image-20220218130328185"></p>
<h2 id="性能优化"><a class="markdownIt-Anchor" href="#性能优化">#</a> 性能优化</h2>
<p>Feign 底层发起 http 请求，依赖于其它的框架。其底层客户端实现有：</p>
<ul>
<li><strong>URLConnection</strong>：默认实现，不支持连接池</li>
<li><strong>Apache HttpClient</strong> ：支持连接池</li>
<li><strong>OKHttp</strong>：支持连接池</li>
</ul>
<p>因此提高 Feign 性能的主要手段就是使用<strong>连接池</strong>代替默认的 URLConnection</p>
<p>另外，日志级别应该尽量用 basic/none，可以有效提高性能。</p>
<p><strong>这里我们用 Apache 的 HttpClient 来演示连接池。</strong></p>
<p>在 order-service 的 pom 文件中引入 HttpClient 依赖</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token comment">&lt;!--httpClient的依赖 --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>io.github.openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>feign-httpclient<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>配置连接池</strong></p>
<p>在 order-service 的 application.yml 中添加配置</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">feign</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
      <span class="token key atrule">default</span><span class="token punctuation">:</span> <span class="token comment"># default全局的配置</span>
        <span class="token key atrule">loggerLevel</span><span class="token punctuation">:</span> BASIC <span class="token comment"># 日志级别，BASIC就是基本的请求和响应信息</span>
  <span class="token key atrule">httpclient</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 开启feign对HttpClient的支持</span>
    <span class="token key atrule">max-connections</span><span class="token punctuation">:</span> <span class="token number">200</span> <span class="token comment"># 最大的连接数</span>
    <span class="token key atrule">max-connections-per-route</span><span class="token punctuation">:</span> <span class="token number">50</span> <span class="token comment"># 每个路径的最大连接数</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在 FeignClientFactoryBean 中的 loadBalance 方法中打断点</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901092729.png" alt=""></p>
<p>Debug 方式启动 order-service 服务，可以看到这里的 client，底层就是 HttpClient</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901092737.png" alt=""></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220218130753949.png" alt="image-20220218130753949"></p>
<blockquote>
<p>日志级别一般是 none 或者 basic, 太高有损性能</p>
</blockquote>
<h2 id="最佳实践"><a class="markdownIt-Anchor" href="#最佳实践">#</a> 最佳实践</h2>
<h3 id="继承方式"><a class="markdownIt-Anchor" href="#继承方式">#</a> 继承方式</h3>
<blockquote>
<p>我们之前那种方式可以看到那个 orderservice 里面写的那个 userCilent 接口里面那个方法以及注解跟我们 userservice 里面的 controller 层的 userController 对应的方法很像 (Request 地址，方式，参数，返回值等等等)</p>
<p>所以我们干脆做个接口让他们都继承 / 实现</p>
<ul>
<li>我们 orderservice 里面写的那个 userCilent 接口继承这个新写的接口</li>
<li>我们 userservice 里面的 controller 层的 userController 实现这个新写的接口</li>
</ul>
<p>更省事了 (-&gt; 有个接口定义了规范)</p>
<p>但是也有问题这种方式</p>
</blockquote>
<p>一样的代码可以通过继承来共享：</p>
<p>1）定义一个 API 接口，利用定义方法，并基于 SpringMVC 注解做声明</p>
<p>2）Feign 客户端、Controller 都集成该接口</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901092803.png" alt=""></p>
<p>优点</p>
<ul>
<li>简单</li>
<li>实现了代码共享</li>
</ul>
<p>缺点</p>
<ul>
<li>服务提供方、服务消费方紧耦合</li>
<li>参数列表中的注解 (SpringMVC 的) 映射并不会继承，因此 Controller 中必须再次声明方法、参数列表、注解</li>
</ul>
<h3 id="抽取方式"><a class="markdownIt-Anchor" href="#抽取方式">#</a> 抽取方式</h3>
<p>将 FeignClient 抽取为独立模块，并且把接口有关的 POJO (就是你消费者发送请求返回的信息存到这个 pojo (任意你写的) 对象里面), 所以干脆把 pojo 也写在 feign-api 模块、默认的 Feign 配置都放到这个模块中，提供给所有消费者使用。</p>
<p>例如：将 UserClient、User、Feign 的默认配置都抽取到一个 feign-api 包中，所有微服务引用该依赖包，即可直接使用。</p>
<blockquote>
<p>这样就不用在每一个需要调用 userservice 服务的消费者微服务写 userClient 接口，以及 pojo 比如说 User 对象装着请求 userservice 返回的信息和 feign 的一些配置 (性能优化啥的等等), 等等等其他的，只需要在 feign-api 模块写一次就足够</p>
</blockquote>
<blockquote>
<p>但这种方式也有坏处，比如说我们 orderservice 服务只需要用一个 userClient 的方法但是我们还是需要把它全部引入进来</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901092811.png" alt=""></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220218132216059.png" alt="image-20220218132216059"></p>
<p>接下来我们就用该方法在代码中实现上面说的第二种方式 (feign-api 独立模块)</p>
<p><strong>首先创建一个 module，命名为 feign-api</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901092835.png" alt=""></p>
<p>在 feign-api 中然后引入依赖</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>order-service 中的 UserClient、User 都复制到 feign-api 项目中</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901092848.png" alt=""></p>
<p><strong>在 order-service 中使用 feign-api</strong></p>
<p>首先，删除 order-service 中的 UserClient、User</p>
<p>在 order-service 中引入 feign-api</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.xn2001.feign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>feign-api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>修改注解</strong></p>
<p>当定义的 FeignClient 不在 SpringBootApplication 的扫描包范围下时，这些 FeignClient 就不能使用。</p>
<p>修改 order-service 启动类上的 @EnableFeignClients 注解</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@EnableFeignClients</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token string">"com.xn2001.feign.clients"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220218133114731.png" alt="image-20220218133114731"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220218133032990.png" alt="image-20220218133032990"></p>
<hr>
<h1 id="gateway网关"><a class="markdownIt-Anchor" href="#gateway网关">#</a> Gateway 网关</h1>
<blockquote>
<p>案例地址：<a target="_blank" rel="noopener" href="https://gitee.com/xn2001/cloudcode/tree/master/07-cloud-gateway">https://gitee.com/xn2001/cloudcode/tree/master/07-cloud-gateway</a></p>
</blockquote>
<p>Spring Cloud Gateway 是 Spring Cloud 的一个全新项目，该项目是基于 Spring 5.0，Spring Boot 2.0 和 Project Reactor 等响应式编程和事件流技术开发的网关，它旨在为微服务架构提供一种简单有效的统一的 API 路由管理方式。</p>
<p>Gateway 网关是我们服务的守门神，<strong>所有微服务的统一入口。</strong></p>
<blockquote>
<p>网关可以看作是一个特殊微服务，需要注册到 nacos，仅此而已。其余的就是跟微服务群打交道了，没 nacos 什么事了，微服务群自己又会跟 nacos 打交道，服务注册服务拉取什么的。</p>
</blockquote>
<p>网关的<strong>核心功能特性</strong>：</p>
<ul>
<li>请求路由</li>
<li>权限控制</li>
<li>限流</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210901092857.png" alt=""></p>
<p><strong>权限控制</strong>：网关作为微服务入口，需要校验用户是是否有请求资格，如果没有则进行拦截。</p>
<p><strong>路由和负载均衡</strong>：一切请求都必须先经过 gateway，但网关不处理业务，而是根据某种规则，把请求转发到某个微服务，这个过程叫做路由。当然路由的目标服务有多个时，还需要做负载均衡 (这跟 ribbon 不一样，ribbon 是微服务之间的调用)。</p>
<blockquote>
<p>nginx,ribbon,gateway 这三个负载均衡的对象都是不同的，比如网关的负载均衡是面向用户访问微服务，Ribbon 是面向微服务之间，Nginx 是面向 Nacos (nacos 的客户端 -&gt; 微服务注册 (或者请求服务获取对应的服务列表等等等) 到某一个 nacos 节点) 的</p>
</blockquote>
<p><strong>限流</strong>：当请求流量过高时，在网关中按照下流的微服务能够接受的速度来放行请求，避免服务压力过大。</p>
<p>在 SpringCloud 中网关的实现包括两种：</p>
<ul>
<li>gateway</li>
<li>zuul</li>
</ul>
<p>Zuul 是基于 Servlet 实现，属于阻塞式编程。而 Spring Cloud Gateway 则是基于 Spring5 中提供的 WebFlux，属于响应式编程的实现，具备更好的性能。</p>
<h2 id="入门使用"><a class="markdownIt-Anchor" href="#入门使用">#</a> 入门使用</h2>
<ol>
<li>创建 SpringBoot 工程 gateway，引入网关依赖</li>
<li>编写启动类</li>
<li>编写基础配置和路由规则</li>
<li>启动网关服务进行测试</li>
</ol>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token comment">&lt;!--网关--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-gateway<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span> #自动装配网关的各种功能
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token comment">&lt;!--nacos服务发现依赖--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>网关服务本身也是个微服务，也需要把自己注册到 nacos (或者其他的) 注册中心，他自己也需要注册或者拉去他需要调用的服务，所以也需要引入 nacos 发现服务依赖</p>
</blockquote>
<p>在网关微服务 (module) 里面创建 application.yml 文件，内容如下：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10010</span> <span class="token comment"># 网关端口</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> gateway <span class="token comment"># 服务名称</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment"># nacos地址 ,上面到这的配置是让网关注册到nacos以及可以联系上nacos实现服务发现 </span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span> <span class="token comment"># 网关路由配置</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> user<span class="token punctuation">-</span>service <span class="token comment"># 路由id，自定义，只要唯一即可</span>
          <span class="token comment"># uri: http://127.0.0.1:8081 # 路由的目标地址 http就是固定地址,这种方式也行但是写死了</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//userservice <span class="token comment"># 路由的目标地址 lb就是负载均衡，后面跟服务名称,其实就是按照这个服务名去nacos找这个服务的所有实例的列表,然后负载均衡选一个</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span> <span class="token comment"># 路由断言，也就是判断请求是否符合路由规则的条件</span>
            <span class="token punctuation">-</span> Path=/user/<span class="token important">**</span> <span class="token comment"># 这个是按照路径匹配，只要以/user/开头就符合要求</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>当然我们还需要一个开启类开启当前网关服务，就是普通的那种 main 函数有个 SpringBootApplication 注解的那个，这里没写</p>
</blockquote>
<p>我们将符合 <code>Path</code>  规则的一切请求，都代理到  <code>uri</code>  参数指定的地址。</p>
<p>上面的例子中，我们将  <code>/user/**</code>  开头的请求，代理到  <code>lb://userservice</code> ，其中 lb 是负载均衡 (LoadBalance)，根据服务名拉取服务列表，实现负载均衡。</p>
<p>重启网关，访问 <a target="_blank" rel="noopener" href="http://localhost:10010/user/1">http://localhost:10010 (这个是网关的端口)/user/1</a> 时，符合  <code>/user/**</code>  规则，请求__<mark>转发</mark>__到我们设置的 uri：<a target="_blank" rel="noopener" href="http://userservice/user/1">http://userservice/user/1</a></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/202108220125749.png" alt=""></p>
<p><strong>多个 predicates 的话，要同时满足规则，下文有例子。</strong></p>
<h2 id="流程图"><a class="markdownIt-Anchor" href="#流程图">#</a> 流程图</h2>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220218135351422.png" alt="image-20220218135351422"></p>
<p>路由配置包括：</p>
<ol>
<li>路由 id：路由的唯一标示</li>
<li>路由目标（uri）：路由的目标地址，http 代表固定地址，lb 代表根据服务名负载均衡</li>
<li>路由断言（predicates）：判断路由的规则</li>
<li>路由过滤器（filters）：对请求或响应做处理</li>
</ol>
<h2 id="断言工厂"><a class="markdownIt-Anchor" href="#断言工厂">#</a> 断言工厂</h2>
<p>我们在配置文件中写的断言规则只是字符串，这些字符串会被 Predicate Factory (断言工厂) 读取并处理，转变为路由判断的条件。</p>
<p>例如  <code>Path=/user/**</code>  是按照路径匹配，这个规则是由</p>
<p><code>org.springframework.cloud.gateway.handler.predicate.PathRoutePredicateFactory</code>  类来读取和处理的，像这样的断言工厂在 Spring Cloud Gateway 还有十几个，每一个都有自己的判断规则和条件</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody>
<tr>
<td>After</td>
<td>是某个时间点后的请求</td>
<td>- After=2037-01-20T17:42:47.789-07:00[America/Denver]</td>
</tr>
<tr>
<td>Before</td>
<td>是某个时间点之前的请求</td>
<td>- Before=2031-04-13T15:14:47.433+08:00[Asia/Shanghai]</td>
</tr>
<tr>
<td>Between</td>
<td>是某两个时间点之前的请求</td>
<td>- Between=2037-01-20T17:42:47.789-07:00[America/Denver], 2037-01-21T17:42:47.789-07:00[America/Denver]</td>
</tr>
<tr>
<td>Cookie</td>
<td>请求必须包含某些 cookie</td>
<td>- Cookie=chocolate, ch.p</td>
</tr>
<tr>
<td>Header</td>
<td>请求必须包含某些 header</td>
<td>- Header=X-Request-Id, d+</td>
</tr>
<tr>
<td>Host</td>
<td>请求必须是访问某个 host（域名）</td>
<td>- Host= <code>**.somehost.org</code> ,  <code>**.anotherhost.org</code></td>
</tr>
<tr>
<td>Method</td>
<td>请求方式必须是指定方式</td>
<td>- Method=GET,POST</td>
</tr>
<tr>
<td>Path</td>
<td>请求路径必须符合指定规则</td>
<td>- Path=/red/{segment},/blue/**</td>
</tr>
<tr>
<td>Query</td>
<td>请求参数必须包含指定参数</td>
<td>- Query=name, Jack 或者 - Query=name</td>
</tr>
<tr>
<td>RemoteAddr</td>
<td>请求者的 ip 必须是指定范围</td>
<td>- RemoteAddr=192.168.1.1/24</td>
</tr>
<tr>
<td>Weight</td>
<td>权重处理</td>
<td></td>
</tr>
</tbody>
</table>
<blockquote>
<p>官方文档：<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#gateway-request-predicates-factories">https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#gateway-request-predicates-factories</a></p>
</blockquote>
<p>一般的，我们只需要掌握 Path，加上官方文档的例子，就可以应对各种工作场景了。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">predicates</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> Path=/order/<span class="token important">**</span>
  <span class="token punctuation">-</span> After=2031<span class="token punctuation">-</span>04<span class="token punctuation">-</span>13T15<span class="token punctuation">:</span>14<span class="token punctuation">:</span>47.433+08<span class="token punctuation">:</span>00<span class="token punctuation">[</span>Asia/Shanghai<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>像这样的规则，现在是 2021 年 8 月 22 日 01:32:42，很明显 After 条件不满足，可以不会转发，路由不起作用，<strong>找不到对应的路由就会报错</strong>。</p>
<h2 id="过滤器工厂"><a class="markdownIt-Anchor" href="#过滤器工厂">#</a> 过滤器工厂</h2>
<p>GatewayFilter 是网关中提供的一种过滤器，可以对进入网关的请求和微服务返回的响应做处理。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/202108220133487.png" alt=""></p>
<p>Spring 提供了 31 种不同的路由过滤器工厂。</p>
<blockquote>
<p>官方文档：<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#gatewayfilter-factories">https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#gatewayfilter-factories</a></p>
</blockquote>
<table>
<thead>
<tr>
<th><strong>名称</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>AddRequestHeader</td>
<td>给当前请求添加一个请求头</td>
</tr>
<tr>
<td>RemoveRequestHeader</td>
<td>移除请求中的一个请求头</td>
</tr>
<tr>
<td>AddResponseHeader</td>
<td>给响应结果中添加一个响应头</td>
</tr>
<tr>
<td>RemoveResponseHeader</td>
<td>从响应结果中移除有一个响应头</td>
</tr>
<tr>
<td>RequestRateLimiter</td>
<td>限制请求的流量</td>
</tr>
</tbody>
</table>
<p>下面我们以 AddRequestHeader 为例：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/202108220139913.png" alt=""></p>
<p><strong>需求</strong>：给所有进入 userservice 的请求添加一个请求头： <code>sign=xn2001.com is eternal</code>  (sign 是 key,<a target="_blank" rel="noopener" href="http://xn2001.com">xn2001.com</a> is eternal 是 value)</p>
<p>只需要修改 gateway 服务的 application.yml 文件，添加路由过滤即可。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span> <span class="token comment"># 网关路由配置</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> user<span class="token punctuation">-</span>service <span class="token comment"># 路由id，自定义，只要唯一即可</span>
          <span class="token comment"># uri: http://127.0.0.1:8081 # 路由的目标地址 http就是固定地址</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//userservice <span class="token comment"># 路由的目标地址 lb就是负载均衡，后面跟服务名称</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span> <span class="token comment"># 路由断言，也就是判断请求是否符合路由规则的条件</span>
            <span class="token punctuation">-</span> Path=/user/<span class="token important">**</span> <span class="token comment"># 这个是按照路径匹配，只要以/user/开头就符合要求</span>
          <span class="token key atrule">filters</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> AddRequestHeader=sign<span class="token punctuation">,</span> xn2001.com is eternal <span class="token comment"># 添加请求头</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如何验证，我们修改 userservice 中的一个接口</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/&#123;id&#125;"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">User</span> <span class="token function">queryById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestHeader</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"sign"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> sign<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>sign<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> userService<span class="token punctuation">.</span><span class="token function">queryById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>重启两个服务，访问：<a target="_blank" rel="noopener" href="http://localhost:10010/user/1">http://localhost:10010/user/1</a></p>
<p>可以看到控制台打印出了这个请求头</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/202108220145565.png" alt=""></p>
<p>当然，Gateway 也是有<strong>全局过滤器</strong>的，如果要<strong>对所有的路由都生效</strong>，则可以将过滤器工厂写到 default-filters 下：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">default-filters</span><span class="token punctuation">:</span> <span class="token comment"># 对所有请求的微服务都会生效,都会带上这里(过滤器配置的)添加的请求头</span>
        <span class="token punctuation">-</span> AddRequestHeader=sign<span class="token punctuation">,</span> xn2001.com is eternal <span class="token comment"># 添加请求头</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220218140949350.png" alt="image-20220218140949350"></p>
<h2 id="全局过滤器"><a class="markdownIt-Anchor" href="#全局过滤器">#</a> 全局过滤器</h2>
<p>上面介绍的过滤器工厂，网关提供了 31 种，但每一种过滤器的作用都是固定的。<strong>如果我们希望拦截请求，做自己的业务逻辑则没办法实现</strong>。</p>
<p>全局过滤器的作用也是处理一切进入网关的请求和微服务响应，<strong>与 GatewayFilter 的作用一样</strong>。区别在于 GlobalFilter 的逻辑可以<strong>写代码来自定义规则</strong>；而 GatewayFilter 通过配置定义，处理逻辑是固定的。</p>
<p><strong>需求：</strong> 定义全局过滤器，拦截请求，判断请求的参数是否满足下面条件</p>
<ul>
<li>参数中是否有 authorization</li>
<li>authorization 参数值是否为 admin</li>
</ul>
<p>如果同时满足则放行，否则拦截。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthorizeFilter</span> <span class="token keyword">implements</span> <span class="token class-name">GlobalFilter</span><span class="token punctuation">,</span> <span class="token class-name">Ordered</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">// 测试：http://localhost:10010/order/101?authorization=admin</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 获取第一个 authorization 参数</span>
        <span class="token class-name">String</span> authorization <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQueryParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFirst</span><span class="token punctuation">(</span><span class="token string">"authorization"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>authorization<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token comment">// 放行</span>
            <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// 设置拦截状态码信息</span>
        exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setStatusCode</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span>UNAUTHORIZED<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置拦截</span>
        <span class="token keyword">return</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 设置过滤器优先级，值越低优先级越高</span>
    <span class="token comment">// 也可以在这个类上面使用 @Order 注解然后给个值</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>这里的 order 就像是 spring 的 AOP-&gt;aspectJ 的那些学过的东西</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220218142045870.png" alt="image-20220218142045870"></p>
<h2 id="过滤器顺序"><a class="markdownIt-Anchor" href="#过滤器顺序">#</a> 过滤器顺序</h2>
<p>请求进入网关会碰到三类过滤器：DefaultFilter、当前路由的过滤器、GlobalFilter；</p>
<p><strong>请求路由后</strong>，会将三者合并到一个过滤器链（集合）中，排序后依次执行每个过滤器.</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/202108230002747.png" alt=""></p>
<p>排序的规则是什么呢？</p>
<ul>
<li>
<p>每一个过滤器都必须指定一个 int 类型的 order 值，<strong>order 值越小，优先级越高，执行顺序越靠前</strong>。</p>
</li>
<li>
<p>GlobalFilter 通过实现 Ordered 接口然后实现那个接口的方法，或者使用 @Order 注解来指定 order 值，由我们自己指定。</p>
</li>
<li>
<p>路由过滤器和 defaultFilter 的 order <strong>由 Spring 指定</strong>，默认是按照声明顺序从 1 递增</p>
<ul>
<li>比如说你一个微服务有两个路由过滤器，第一个写的就是 1, 第二个写的就是 2。</li>
<li>再比如说如果你写的 defaultFilter (全局，不分哪个微服务), 第一个写的就是 1, 第二个写的就是 2 (上面写的具体的微服务的路由器不影响这里的这个)</li>
</ul>
</li>
<li>
<p>当过滤器的 order 值一样时，<strong>会按照 defaultFilter &gt; 路由过滤器 &gt; GlobalFilter 的顺序执行。</strong></p>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220218142738537.png" alt="image-20220218142738537"></p>
<h2 id="跨域问题"><a class="markdownIt-Anchor" href="#跨域问题">#</a> 跨域问题</h2>
<blockquote>
<p>所有对我们的微服务的访问都要通过我们的网关，所以直接给网关设置跨域问题的解决等就行了</p>
</blockquote>
<p>不了解跨域问题的同学可以百度了解一下；在 Gateway 网关中解决跨域问题还是比较方便的。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220218142940020.png" alt="image-20220218142940020"></p>
<blockquote>
<p>不过不确定到底是不是请求被拦截了还是发出去但是服务器不允许的，这个不清楚</p>
</blockquote>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">globalcors</span><span class="token punctuation">:</span> <span class="token comment"># 全局的跨域处理</span>
        <span class="token key atrule">add-to-simple-url-handler-mapping</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 解决options请求被拦截问题(就是允许浏览器发请求问我们服务器允不允许跨域,而不是原来会跨域的ajax请求)</span>
        <span class="token key atrule">corsConfigurations</span><span class="token punctuation">:</span>
          <span class="token key atrule">'[/**]'</span><span class="token punctuation">:</span> <span class="token comment">#这里/**就是拦截所有的请求,一切进入网关的请求都做跨域处理(解决或者.)</span>
            <span class="token key atrule">allowedOrigins</span><span class="token punctuation">:</span> <span class="token comment"># 允许哪些网站的跨域请求 allowedOrigins: “*” 允许所有网站</span>
              <span class="token punctuation">-</span> <span class="token string">"http://localhost:8090"</span>
            <span class="token key atrule">allowedMethods</span><span class="token punctuation">:</span> <span class="token comment"># 允许的跨域ajax的请求方式</span>
              <span class="token punctuation">-</span> <span class="token string">"GET"</span>
              <span class="token punctuation">-</span> <span class="token string">"POST"</span>
              <span class="token punctuation">-</span> <span class="token string">"DELETE"</span>
              <span class="token punctuation">-</span> <span class="token string">"PUT"</span>
              <span class="token punctuation">-</span> <span class="token string">"OPTIONS"</span>
            <span class="token key atrule">allowedHeaders</span><span class="token punctuation">:</span> <span class="token string">"*"</span> <span class="token comment"># 允许在请求中携带的头信息</span>
            <span class="token key atrule">allowCredentials</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 是否允许携带cookie</span>
            <span class="token key atrule">maxAge</span><span class="token punctuation">:</span> <span class="token number">360000</span> <span class="token comment"># 这次跨域检测的有效期(就是浏览器在第一询问请求结束后然后我们说可以跨域,之后要是还有ajax请求,只要在我们这里设置的有效期内,浏览器就不用再发那个询问请求了)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<h1 id="rabbitmq"><a class="markdownIt-Anchor" href="#rabbitmq">#</a> RabbitMQ</h1>
<blockquote>
<p>案例地址：<a target="_blank" rel="noopener" href="https://gitee.com/xn2001/cloudcode/tree/master/08-rabbitmq-demo">https://gitee.com/xn2001/cloudcode/tree/master/08-rabbitmq-demo</a></p>
</blockquote>
<h2 id="同步异步通讯"><a class="markdownIt-Anchor" href="#同步异步通讯">#</a> 同步异步通讯</h2>
<p><strong>微服务间通讯有同步和异步两种方式</strong></p>
<p>同步通讯：就像打电话，需要实时响应。</p>
<p>异步通讯：就像发邮件，不需要马上回复。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210904133345.png" alt=""></p>
<p>两种方式各有优劣，打电话可以立即得到响应，但是你却不能跟多个人同时通话。发送邮件可以同时与多个人收发邮件，但是往往响应会有延迟。</p>
<p>我们之前学习的 <strong>Feign 调用</strong>就属于<strong>同步方式</strong>，虽然调用可以实时得到结果，但存在下面的问题：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210904133517.png" alt=""></p>
<p><strong>同步调用的优点：</strong></p>
<ul>
<li>时效性较强，可以立即得到结果</li>
</ul>
<p><strong>同步调用的缺点：</strong></p>
<ul>
<li>耦合度高</li>
<li>性能和吞吐能力下降</li>
<li>有额外的资源消耗</li>
<li>有级联失败问题</li>
</ul>
<p>异步调用则可以避免上述问题，我们以购买商品为例，用户支付后需要调用订单服务完成订单状态修改，调用物流服务，从仓库分配响应的库存并准备发货。在事件模式中，支付服务是事件发布者（publisher），在支付完成后只需要发布一个支付成功的事件（event），事件中带上订单 id。订单服务和物流服务是事件订阅者（Consumer），订阅支付成功的事件，监听到事件后完成自己业务即可。</p>
<blockquote>
<p>所以跟我们之前学到的微服务之间的调用不太一样</p>
<p>我们这里更像是有一个生产者 (微服务) 被用户通过网关然后访问到了，然后这个微服务里面的操作需要影响到别的微服务，这个时候就可以把自己的一些信息然后各种细节等等交给 broker, 由 broker 把这个消息按照我们生产者里面设置的交换机和队列等等把它交给对应的队列，然后队列会把信息交给对应的微服务，那个微服务接收到那个消息就可以操作了</p>
<p>这都是异步的</p>
</blockquote>
<blockquote>
<p>这个生产者有点像我们之前的提供者 (提供接口给其他微服务使用), 然后消费者有点像我们的之前的消费者 (也是消费者) 但好像并不是！！！</p>
<p>这里消息队列的概念好像就是因为某种原因，微服务会把一些关于他自己的 (或者其他…) 消息交给 broker, 然后其他微服务就可以用到这个消息</p>
</blockquote>
<p>为了解除事件发布者与订阅者之间的耦合，两者并不是直接通信，而是有一个中间人（Broker）。发布者发布事件到 Broker，不关心谁来订阅事件。订阅者从 Broker 订阅事件，不关心谁发来的消息。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210904144714.png" alt=""></p>
<p>Broker 是一个像数据总线一样的东西，所有的服务要接收数据和发送数据都发到这个总线上，这个总线就像协议一样，让服务间的通讯变得标准和可控。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210904145001.png" alt=""></p>
<blockquote>
<ul>
<li>这里的支付服务是指支付成功后的后续操作（支付成功后才会产生订单以及一系列的操作）</li>
<li>也就是说只有支付成功后请求才会被发送到这个服务，如果支付失败，在第一步调用接口时就会返回失败</li>
<li>这里要表示的就是，用户只关心支付成功没有，也就是说只关心第一步成功没有</li>
<li>至于后面的订单或者是短信通知相对来说不重要了，因为用户知道钱已经给了，如果有问题就再说</li>
<li>最简单的例子就是淘宝买东西，你一般都是付款之后就不会再看了，因为你知道支付成功了</li>
</ul>
</blockquote>
<p><strong>异步调用好处：</strong></p>
<ul>
<li>吞吐量提升：无需等待订阅者处理完成，响应更快速</li>
<li>故障隔离：服务没有直接调用，不存在级联失败问题</li>
<li>调用间没有阻塞，不会造成无效的资源占用</li>
<li>耦合度极低，每个服务都可以灵活插拔，可替换</li>
<li>流量削峰：不管发布事件的流量波动多大，都由 Broker 接收，订阅者可以按照自己的速度去处理事件</li>
</ul>
<p><strong>异步调用缺点：</strong></p>
<ul>
<li>架构复杂了，业务没有明显的流程线，不好管理</li>
<li>需要依赖于 Broker 的可靠、安全、性能</li>
</ul>
<h2 id="mq消息队列"><a class="markdownIt-Anchor" href="#mq消息队列">#</a> MQ 消息队列</h2>
<p>MQ，中文是消息队列（MessageQueue），字面来看就是存放消息的队列，也就是事件驱动架构中的 Broker</p>
<p>比较常见的 MQ 实现：</p>
<ul>
<li>ActiveMQ</li>
<li>RabbitMQ</li>
<li>RocketMQ</li>
<li>Kafka</li>
</ul>
<p>几种常见 MQ 的对比：</p>
<table>
<thead>
<tr>
<th></th>
<th><strong>RabbitMQ</strong></th>
<th><strong>ActiveMQ</strong></th>
<th><strong>RocketMQ</strong></th>
<th><strong>Kafka</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>公司 / 社区</td>
<td>Rabbit</td>
<td>Apache</td>
<td>阿里</td>
<td>Apache</td>
</tr>
<tr>
<td>开发语言</td>
<td>Erlang</td>
<td>Java</td>
<td>Java</td>
<td>Scala&amp;Java</td>
</tr>
<tr>
<td>协议支持</td>
<td>AMQP、XMPP、SMTP、STOMP</td>
<td>OpenWire、STOMP、REST、XMPP、AMQP</td>
<td>自定义协议</td>
<td>自定义协议</td>
</tr>
<tr>
<td>可用性</td>
<td>高</td>
<td>一般</td>
<td>高</td>
<td>高</td>
</tr>
<tr>
<td>单机吞吐量</td>
<td>一般</td>
<td>差</td>
<td>高</td>
<td>非常高</td>
</tr>
<tr>
<td>消息延迟</td>
<td>微秒级</td>
<td>毫秒级</td>
<td>毫秒级</td>
<td>毫秒以内</td>
</tr>
<tr>
<td>消息可靠性</td>
<td>高</td>
<td>一般</td>
<td>高</td>
<td>一般</td>
</tr>
</tbody>
</table>
<p>以 RabbitMQ 为例，我们在 Centos7 虚拟机中使用 Docker 来安装</p>
<p>在线拉取镜像</p>
<pre class="line-numbers language-none"><code class="language-none">docker pull rabbitmq:3-management<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>执行下面的命令来运行 MQ 容器</p>
<pre class="line-numbers language-dockerfile" data-language="dockerfile"><code class="language-dockerfile">docker run \
 -e RABBITMQ_DEFAULT_USER&#x3D;admin \
 -e RABBITMQ_DEFAULT_PASS&#x3D;123456 \
 --name mq \
 --hostname mq1 \
 -p 15672:15672 \
 -p 5672:5672 \
 -d \
 rabbitmq:3-management<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>启动成功后访问地址：<a target="_blank" rel="noopener" href="http://192.168.211.128">http://192.168.211.128</a>:15672</p>
<p><strong>RabbitMQ 中的一些角色</strong></p>
<ul>
<li>publisher：生产者</li>
<li>consumer：消费者</li>
<li>exchange：交换机，负责消息路由</li>
<li>queue：队列，存储消息</li>
<li>virtualHost：虚拟主机，<strong>隔离不同租户</strong>的 exchange、queue、消息的隔离</li>
</ul>
<p><strong>MQ 的基本结构</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210904172912.png" alt=""></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220219162446161.png" alt="image-20220219162446161"></p>
<h2 id="入门案例"><a class="markdownIt-Anchor" href="#入门案例">#</a> 入门案例</h2>
<p>RabbitMQ 官方提供了 5 个不同的 Demo 示例，对应了不同的消息模型。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210904173739.png" alt=""></p>
<p>Hello World 模型</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210904200637.png" alt=""></p>
<p>官方的 HelloWorld 是基于最基础的消息队列模型来实现的，只包括三个角色：</p>
<ul>
<li>publisher：消息发布者，将消息发送到队列 queue</li>
<li>queue：消息队列，负责接受并缓存消息</li>
<li>consumer：订阅队列，处理队列中的消息</li>
</ul>
<h3 id="publisher实现"><a class="markdownIt-Anchor" href="#publisher实现">#</a> publisher 实现</h3>
<ul>
<li>建立连接</li>
<li>创建 channel</li>
<li>声明队列</li>
<li>发送消息</li>
<li>关闭连接和 channel</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PublisherTest</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testSendMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">TimeoutException</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 1.建立连接</span>
        <span class="token class-name">ConnectionFactory</span> factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConnectionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 1.1.设置连接参数，分别是：主机名、端口号、vhost、用户名、密码</span>
        factory<span class="token punctuation">.</span><span class="token function">setHost</span><span class="token punctuation">(</span><span class="token string">"192.168.211.128"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span><span class="token number">5672</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setVirtualHost</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 1.2.建立连接</span>
        <span class="token class-name">Connection</span> connection <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">newConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.创建通道Channel</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3.创建队列</span>
        <span class="token class-name">String</span> queueName <span class="token operator">=</span> <span class="token string">"simple.queue"</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>queueName<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.发送消息</span>
        <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token string">"Hello RabbitMQ！"</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> queueName<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"发送消息成功：["</span> <span class="token operator">+</span> message <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 5.关闭通道和连接</span>
        channel<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connection<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="consumer实现"><a class="markdownIt-Anchor" href="#consumer实现">#</a> consumer 实现</h3>
<ul>
<li>建立连接</li>
<li>创建 channel</li>
<li>声明队列</li>
<li>订阅消息</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConsumerTest</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">TimeoutException</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 1.建立连接</span>
        <span class="token class-name">ConnectionFactory</span> factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConnectionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 1.1.设置连接参数，分别是：主机名、端口号、vhost、用户名、密码</span>
        factory<span class="token punctuation">.</span><span class="token function">setHost</span><span class="token punctuation">(</span><span class="token string">"192.168.211.128"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span><span class="token number">5672</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setVirtualHost</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 1.2.建立连接</span>
        <span class="token class-name">Connection</span> connection <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">newConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.创建通道Channel</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3.创建队列</span>
        <span class="token class-name">String</span> queueName <span class="token operator">=</span> <span class="token string">"simple.queue"</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>queueName<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.订阅消息</span>
        channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span>queueName<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DefaultConsumer</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleDelivery</span><span class="token punctuation">(</span><span class="token class-name">String</span> consumerTag<span class="token punctuation">,</span> <span class="token class-name">Envelope</span> envelope<span class="token punctuation">,</span>
                                       <span class="token class-name">AMQP<span class="token punctuation">.</span>BasicProperties</span> properties<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// 5.处理消息</span>
                <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"接收到消息：["</span> <span class="token operator">+</span> message <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"等待接收消息中"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>注意上面 &quot;等待接收消息中&quot; 会被先打印，然后才是 &quot;接收到消息：[Hello RabbitMQ!]&quot;</p>
<p>这是因为我们那个正常的 sout 是同步的，basicConsume 那个 (函数) 参数是__回调__, 异步的！！！</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220219163524716.png" alt="image-20220219163524716"></p>
<h2 id="springamqp"><a class="markdownIt-Anchor" href="#springamqp">#</a> SpringAMQP</h2>
<p>SpringAMQP 是基于 RabbitMQ 封装的一套模板，并且还利用 SpringBoot 对其实现了自动装配，使用起来非常方便。</p>
<p>SpringAMQP 的官方地址：<a target="_blank" rel="noopener" href="https://spring.io/projects/spring-amqp">https://spring.io/projects/spring-amqp</a></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210904202046.png" alt=""></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210904202056.png" alt=""></p>
<p>SpringAMQP 提供了三个功能：</p>
<ul>
<li>自动声明队列、交换机及其绑定关系</li>
<li>基于注解的监听器模式，异步接收消息</li>
<li>封装了 RabbitTemplate 工具，用于发送消息</li>
</ul>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token comment">&lt;!--AMQP依赖，包含RabbitMQ--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="basicqueue"><a class="markdownIt-Anchor" href="#basicqueue">#</a> BasicQueue</h3>
<p>首先配置 MQ 地址，在 publisher、consumer 服务中的 application.yml 中添加配置</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> 192.168.150.101 <span class="token comment"># 主机名</span>
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5672</span> <span class="token comment"># 端口</span>
    <span class="token key atrule">virtual-host</span><span class="token punctuation">:</span> / <span class="token comment"># 虚拟主机</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> admin <span class="token comment"># 用户名</span>
    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">123456</span> <span class="token comment"># 密码</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在 consumer 服务中添加监听队列</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RabbitMQListener</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token string">"simple.queue"</span><span class="token punctuation">)</span> <span class="token comment">// 消费者这个注解代表在你指定的队列监听消息</span>
    <span class="token comment">// 然后下面这个方法参数可以获得队列里面的消息,等等等->发送的是什么类型的对象接收到的就是什么类型的对象</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenSimpleQueueMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"消费者接收到消息：【"</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">"】"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在 publisher 服务中添加发送消息的测试类</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpringAmqpTest</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Autowired</span> <span class="token comment">//直接自动注入然后用里面的方法指定交换机队列等等等发消息就可以</span>
    <span class="token keyword">private</span> <span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testSimpleQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 队列名称</span>
        <span class="token class-name">String</span> queueName <span class="token operator">=</span> <span class="token string">"simple.queue"</span><span class="token punctuation">;</span>
        <span class="token comment">// 消息</span>
        <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token string">"你好啊，乐心湖！"</span><span class="token punctuation">;</span>
        <span class="token comment">// 发送消息</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span>queueName<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220219164703971.png" alt="image-20220219164703971"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220219165230285.png" alt="image-20220219165230285"></p>
<h3 id="workqueue"><a class="markdownIt-Anchor" href="#workqueue">#</a> WorkQueue</h3>
<p>Work queues，也被称为（Task queues），任务模型。简单来说就是<strong>让多个消费者绑定到一个队列，共同消费队列中的消息</strong>。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210904211238.png" alt=""></p>
<p>当消息处理比较耗时的时候，可能生产消息的速度会远远大于消息的消费速度。长此以往，消息就会堆积越来越多，无法及时处理。</p>
<p>此时就可以使用 work 模型，多个消费者共同处理消息处理，速度就能大大提高了。</p>
<p>我们循环发送，模拟大量消息堆积现象，在 publisher 服务中的 SpringAmqpTest 类中添加一个测试方法：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * workQueue
 * 向队列中不停发送消息，模拟消息堆积。
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testWorkQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 队列名称</span>
    <span class="token class-name">String</span> queueName <span class="token operator">=</span> <span class="token string">"simple.queue"</span><span class="token punctuation">;</span>
    <span class="token comment">// 消息</span>
    <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token string">"hello, message_"</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">50</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 发送消息</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span>queueName<span class="token punctuation">,</span> message <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>消息接收</strong></p>
<p>要模拟多个消费者绑定同一个队列，我们在 consumer 服务的 RabbitMQListener 中添加 2 个新的方法：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token string">"simple.queue"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenWorkQueue1</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"消费者1接收到消息：【"</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">"】"</span> <span class="token operator">+</span> <span class="token class-name">LocalTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token string">"simple.queue"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenWorkQueue2</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"消费者2........接收到消息：【"</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">"】"</span> <span class="token operator">+</span> <span class="token class-name">LocalTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>启动 ConsumerApplication 后，在执行 publisher 服务中刚刚编写的发送测试方法 testWorkQueue</p>
<p>可以看到消费者 1 很快完成了自己的 25 条消息。消费者 2 却在缓慢的处理自己的 25 条消息。</p>
<p>也就是说消息是<strong>平均分配给每个消费者</strong>，并没有考虑到消费者的处理能力。这是因为 RabbitMQ 默认有一个消息预取机制，显然这不是我们想要的结果，<strong>我们需要的是能者多劳嘛，所以去限制每次只能取一条消息，可以解决这个问题 (默认的是轮询)</strong>。</p>
<p>在 spring 中有一个简单的配置，设置 prefetch 属性，我们修改 consumer 服务的 application.yml 文件，添加配置</p>
<blockquote>
<p>默认的预取就是轮询队列中的消息给每个 (对应的) 消费者发一个 (注意这个还是只能给一个消费者发送，而不是给多个，多个的话需要发布订阅 (这个也不是发布确认！！！<span class="spoiler" title="..."><span class="spoiler" title="..."><span class="spoiler" title="..."><span class="spoiler" title="..."> 不同东西，看 rabbitmq 笔记</span></span></span></span>！)), 也可以认为就是每个消费者都会挨个一个一个预取，直到队列中的消息没了，就算当前消费者自己当前消息还没处理完毕也会是预取，所以因为默认轮询最后都一样的数量</p>
<p>我们需要能者多劳，可以 prefetch 设置为 1, 也就是这个消费者说只能预取 1 个，只能当前消费者处理完成才能获取下一个消息，达成不公平的效果 (看 rabbitmq 专门的笔记)</p>
</blockquote>
<p>在消费者里面的配置文件中:</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
    <span class="token key atrule">listener</span><span class="token punctuation">:</span>
      <span class="token key atrule">simple</span><span class="token punctuation">:</span>
        <span class="token key atrule">prefetch</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token comment"># 每次只能获取一条消息，处理完成才能获取下一个消息</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Work 模型的使用：</p>
<ul>
<li>多个消费者绑定到一个队列，同一条消息只会被一个消费者处理</li>
<li>通过设置 prefetch 来控制消费者预取的消息数量</li>
</ul>
<h3 id="发布订阅"><a class="markdownIt-Anchor" href="#发布订阅">#</a> 发布 / 订阅</h3>
<blockquote>
<p>这个不是发布确认</p>
<p>发布订阅就是主要是关于交换机的，交换机可以给匹配 RoutingKey 的队列发送消息，达成如果我们发布了一个消息，我们可以让想要的某一个或者多个消费者订阅 (获取到) 到那个消息，(有点像 vue2 里面的那个 pubsub 的意思)</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210904213455.png" alt=""></p>
<p>图中可以看到，在订阅模型中，多了一个 exchange 角色，而且过程略有变化</p>
<ul>
<li>
<p>Publisher：生产者，也就是要发送消息的程序，但是不再发送到队列中，<strong>而是发给 exchange（交换机）</strong></p>
</li>
<li>
<p>Consumer：消费者，与以前一样，订阅队列，没有变化</p>
</li>
<li>
<p>Queue：消息队列也与以前一样，接收消息、缓存消息</p>
</li>
<li>
<p>Exchange：交换机，一方面，接收生产者发送的消息；另一方面，知道如何处理消息，例如递交给某个特别队列、递交给所有队列、或是将消息丢弃。到底如何操作，取决于 Exchange 的类型。Exchange 有以下 3 种类型：</p>
<ul>
<li>Fanout：广播，将消息交给所有绑定到交换机的队列</li>
<li>Direct：定向，把消息交给符合指定 routing key 的队列</li>
<li>Topic：通配符，把消息交给符合 routing pattern（路由模式） 的队列</li>
</ul>
</li>
</ul>
<p><strong>Exchange（交换机）只负责转发消息，不具备存储消息的能力</strong>，因此如果没有任何队列与 Exchange 绑定，或者没有符合路由规则的队列，那么消息会丢失！</p>
<blockquote>
<p>我们可能会使用备份交换机</p>
<p>或者发布确认来达到交换机没找到符合路由规则的队列消息可能会丢失的问题！</p>
</blockquote>
<h3 id="fanout"><a class="markdownIt-Anchor" href="#fanout">#</a> Fanout</h3>
<p>Fanout，英文翻译是扇出，在 MQ 中我们也可以称为广播。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210912160350.png" alt=""></p>
<p>在广播模式下，消息发送流程是这样的：</p>
<ul>
<li>可以有多个队列</li>
<li>每个队列都要绑定到 Exchange（交换机）</li>
<li>生产者发送的消息，只能发送到交换机，交换机来决定要发给哪个队列，生产者无法决定</li>
<li>交换机把消息发送给绑定过的所有队列</li>
<li>订阅队列的消费者都能拿到消息</li>
</ul>
<p>接下里我们用 SpringAMQP 来简单实现 FanoutExchange</p>
<ol>
<li>在 consumer 服务中，利用代码声明队列、交换机，并将两者绑定</li>
<li>在 consumer 服务中，编写两个消费者方法，分别监听 fanout.queue1 和 fanout.queue2</li>
<li>在 publisher 中编写测试方法，向 fanout 发送消息</li>
</ol>
<p><strong>声明队列和交换机</strong></p>
<p>Spring 提供了一个接口 Exchange，来表示所有不同类型的交换机。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210904213809.png" alt=""></p>
<p>在 consumer 中创建一个类，声明队列、交换机、<strong>绑定对象 Binding</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FanoutConfig</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">/**
     * 声明交换机
     * @return Fanout类型交换机
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">FanoutExchange</span> <span class="token function">fanoutExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FanoutExchange</span><span class="token punctuation">(</span><span class="token string">"xn2001.fanout"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * 声明队列
     * @return Queue
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">fanoutQueue1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token string">"fanout.queue1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">fanoutQueue2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token string">"fanout.queue2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * 绑定队列和交换机
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">bindingQueue1</span><span class="token punctuation">(</span><span class="token class-name">FanoutExchange</span> fanoutExchange<span class="token punctuation">,</span><span class="token class-name">Queue</span> fanoutQueue1<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>fanoutQueue1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>fanoutExchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">bindingQueue2</span><span class="token punctuation">(</span><span class="token class-name">FanoutExchange</span> fanoutExchange<span class="token punctuation">,</span><span class="token class-name">Queue</span> fanoutQueue2<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>fanoutQueue2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>fanoutExchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210912181932.png" alt=""></p>
<p>通过这样  <code>@Bean</code>  的方式来申明确实比较麻烦，其实我们也是可以直接通过  <code>@RabbitListener</code>  注解来完成的，代码如下：</p>
<p>在 consumer 服务的 SpringRabbitListener 中添加三个方法，作为消费者</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token string">"fanout.queue1"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenFanoutQueue1</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"接收到fanout.queue1的消息：【"</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">"】"</span> <span class="token operator">+</span> <span class="token class-name">LocalTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token string">"fanout.queue2"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenFanoutQueue2</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"接收到fanout.queue2的消息：【"</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">"】"</span> <span class="token operator">+</span> <span class="token class-name">LocalTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>bindings <span class="token operator">=</span> <span class="token annotation punctuation">@QueueBinding</span><span class="token punctuation">(</span>
    value <span class="token operator">=</span> <span class="token annotation punctuation">@Queue</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"fanout.queue3"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    exchange <span class="token operator">=</span> <span class="token annotation punctuation">@Exchange</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"xn2001.fanout"</span><span class="token punctuation">,</span>type <span class="token operator">=</span> <span class="token string">"fanout"</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenFanoutQueue3</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"接收到fanout.queue3的消息：【"</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">"】"</span> <span class="token operator">+</span> <span class="token class-name">LocalTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在 publisher 服务的 SpringAmqpTest 类中添加测试方法</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * fanout
 * 向交换机发送消息
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testFanoutExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 交换机名称</span>
    <span class="token class-name">String</span> exchangeName <span class="token operator">=</span> <span class="token string">"xn2001.fanout"</span><span class="token punctuation">;</span>
    <span class="token comment">// 消息</span>
    <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token string">"hello, everybody!"</span><span class="token punctuation">;</span>
    rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span>exchangeName<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>运行该方法，可以发现 fanout.queue1、fanout.queue2 都收到了交换机的消息。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210912182458.png" alt=""></p>
<p>总结一下：</p>
<p>交换机的作用是什么？</p>
<ul>
<li>接收 publisher 发送的消息</li>
<li>将消息按照规则路由到与之绑定的队列</li>
<li>不能缓存消息，路由失败，消息丢失</li>
<li>FanoutExchange 会将所有消息路由到每个绑定的队列</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220219181446412.png" alt="image-20220219181446412"></p>
<h3 id="direct"><a class="markdownIt-Anchor" href="#direct">#</a> Direct</h3>
<p>在 Fanout 模式中，一条消息，会被所有订阅的队列都消费。但是，在某些场景下，我们希望不同的消息被不同的队列消费。这时就要用到 DirectExchange</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210912182822.png" alt=""></p>
<p>在 Direct 模型下：</p>
<ul>
<li>队列与交换机的绑定，不能是任意绑定了，而是要指定一个 <code>RoutingKey</code> （路由 key）</li>
<li>消息的发送方向 Exchange 发送消息时，也必须指定消息的  <code>RoutingKey</code> 。</li>
<li>Exchange 不再把消息交给每一个绑定的队列，而是根据消息的 <code>Routing Key</code>  进行判断，只有队列的 <code>Routingkey</code>  与消息的  <code>Routing key</code>  完全一致，才会接收到消息</li>
</ul>
<p>在 consumer 的 SpringRabbitListener 中添加两个消费者，同时基于注解来声明队列和交换机</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>bindings <span class="token operator">=</span> <span class="token annotation punctuation">@QueueBinding</span><span class="token punctuation">(</span>
    value <span class="token operator">=</span> <span class="token annotation punctuation">@Queue</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"direct.queue1"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    exchange <span class="token operator">=</span> <span class="token annotation punctuation">@Exchange</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"xn2001.direct"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    key <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"a"</span><span class="token punctuation">,</span><span class="token string">"b"</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenDirectQueue1</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"接收到direct.queue1的消息：【"</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">"】"</span> <span class="token operator">+</span> <span class="token class-name">LocalTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>bindings <span class="token operator">=</span> <span class="token annotation punctuation">@QueueBinding</span><span class="token punctuation">(</span>
    value <span class="token operator">=</span> <span class="token annotation punctuation">@Queue</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"direct.queue2"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    exchange <span class="token operator">=</span> <span class="token annotation punctuation">@Exchange</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"xn2001.direct"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    key <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"a"</span><span class="token punctuation">,</span><span class="token string">"c"</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenDirectQueue2</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"接收到direct.queue2的消息：【"</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">"】"</span> <span class="token operator">+</span> <span class="token class-name">LocalTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在 publisher 服务的 SpringAmqpTest 类中添加测试方法</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * direct
 * 向交换机发送消息
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testDirectExchangeToA</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 交换机名称</span>
    <span class="token class-name">String</span> exchangeName <span class="token operator">=</span> <span class="token string">"xn2001.direct"</span><span class="token punctuation">;</span>
    <span class="token comment">// 消息</span>
    <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token string">"hello, i am direct to a!"</span><span class="token punctuation">;</span>
    rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span>exchangeName<span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/**
 * direct
 * 向交换机发送消息
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testDirectExchangeToB</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 交换机名称</span>
    <span class="token class-name">String</span> exchangeName <span class="token operator">=</span> <span class="token string">"xn2001.direct"</span><span class="token punctuation">;</span>
    <span class="token comment">// 消息</span>
    <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token string">"hello, i am direct to b!"</span><span class="token punctuation">;</span>
    rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span>exchangeName<span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="topic"><a class="markdownIt-Anchor" href="#topic">#</a> Topic</h3>
<p><code>Topic</code>  与  <code>Direct</code>  相比，都是可以根据 <code>RoutingKey</code>  把消息路由到不同的队列。只不过 <code>Topic</code>  类型可以让队列在绑定 <code>Routing key</code>  的时候使用通配符！</p>
<p>通配符规则：</p>
<p><code>#</code> ：匹配一个或多个词</p>
<p><code>*</code> ：只能匹配一个词</p>
<p>例如：</p>
<p><code>item.#</code> ：能够匹配 <code>item.spu.insert</code>  或者  <code>item.spu</code></p>
<p><code>item.*</code> ：只能匹配 <code>item.spu</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210912194016.png" alt=""></p>
<ul>
<li>Queue1：绑定的是  <code>china.#</code>  ，因此凡是以  <code>china.</code>  开头的  <code>routing key</code>  都会被匹配到。包括 china.news 和 china.weather</li>
<li>Queue2：绑定的是  <code>#.news</code>  ，因此凡是以  <code>.news</code>  结尾的  <code>routing key</code>  都会被匹配。包括 china.news 和 japan.news</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>bindings <span class="token operator">=</span> <span class="token annotation punctuation">@QueueBinding</span><span class="token punctuation">(</span>
    value <span class="token operator">=</span> <span class="token annotation punctuation">@Queue</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"topic.queue1"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    exchange <span class="token operator">=</span> <span class="token annotation punctuation">@Exchange</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"xn2001.topic"</span><span class="token punctuation">,</span>type <span class="token operator">=</span> <span class="token class-name">ExchangeTypes</span><span class="token punctuation">.</span>TOPIC<span class="token punctuation">)</span><span class="token punctuation">,</span>
    key <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"china.#"</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenTopicQueue1</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"接收到topic.queue1的消息：【"</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">"】"</span> <span class="token operator">+</span> <span class="token class-name">LocalTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>bindings <span class="token operator">=</span> <span class="token annotation punctuation">@QueueBinding</span><span class="token punctuation">(</span>
    value <span class="token operator">=</span> <span class="token annotation punctuation">@Queue</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"topic.queue2"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    exchange <span class="token operator">=</span> <span class="token annotation punctuation">@Exchange</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"xn2001.topic"</span><span class="token punctuation">,</span>type <span class="token operator">=</span> <span class="token class-name">ExchangeTypes</span><span class="token punctuation">.</span>TOPIC<span class="token punctuation">)</span><span class="token punctuation">,</span>
    key <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"china.*"</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenTopicQueue2</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"接收到topic.queue2的消息：【"</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">"】"</span> <span class="token operator">+</span> <span class="token class-name">LocalTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * topic
 * 向交换机发送消息
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testTopicExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 交换机名称</span>
    <span class="token class-name">String</span> exchangeName <span class="token operator">=</span> <span class="token string">"xn2001.topic"</span><span class="token punctuation">;</span>
    <span class="token comment">// 消息</span>
    <span class="token class-name">String</span> message1 <span class="token operator">=</span> <span class="token string">"hello, i am topic form china.news"</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> message2 <span class="token operator">=</span> <span class="token string">"hello, i am topic form china.news.2"</span><span class="token punctuation">;</span>
    rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span>exchangeName<span class="token punctuation">,</span> <span class="token string">"china.news"</span><span class="token punctuation">,</span> message1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span>exchangeName<span class="token punctuation">,</span> <span class="token string">"china.news.2"</span><span class="token punctuation">,</span> message2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210912200012.png" alt=""></p>
<h3 id="消息转换器"><a class="markdownIt-Anchor" href="#消息转换器">#</a> 消息转换器</h3>
<blockquote>
<p>Spring 会把你发送的消息序列化为字节发送给 MQ (所以队列存的是 java 对象序列化 (所以可以发任何对象而不只是 String which stored as bytes (字节), 对象也可以传只不过被序列化了))，接收消息的时候，还会把字节反序列化为 Java 对象。</p>
</blockquote>
<p><strong>默认情况下 Spring 采用的序列化方式是 JDK 序列化。</strong></p>
<p>我们可以去试一下效果</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queuesToDeclare <span class="token operator">=</span> <span class="token annotation punctuation">@Queue</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"object.queue"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenObjectQueue</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"object接收到消息：【"</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">"】"</span> <span class="token operator">+</span> <span class="token class-name">LocalTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testSendMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 准备消息</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    msg<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"Jack"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    msg<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 发送消息</span>
    rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">"object.queue"</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210912204117.png" alt=""></p>
<p>众所周知，JDK 序列化存在下列问题：</p>
<ul>
<li>数据体积过大</li>
<li>有安全漏洞</li>
<li>可读性差</li>
</ul>
<p>我们推荐可以使用 JSON 来序列化</p>
<p>在 publisher 和 consumer 两个服务中都引入依赖</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.fasterxml.jackson.dataformat<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>jackson-dataformat-xml<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.9.10<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>配置消息转换器。</p>
<p>在各自的启动类中添加一个 Bean 即可</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">MessageConverter</span> <span class="token function">jsonMessageConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Jackson2JsonMessageConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210912204512.png" alt=""></p>
<p>当然，接收 json 也需要配置:</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220219182840899.png" alt="image-20220219182840899"></p>
<h3 id="总结一下子"><a class="markdownIt-Anchor" href="#总结一下子">#</a> 总结一下子:</h3>
<blockquote>
<ul>
<li>
<p>消息中间件就是为了一个微服务想要把某一个消息 (可以是任何内容不过一般是关于自己的一部分内容的消息) 发送到别的微服务</p>
</li>
<li>
<p>rabbitmq 这个消息中间件可以为我们干这个 -&gt; 解耦啊，解峰啊，某个微服务崩了不会导致整个系统崩啊等等等</p>
</li>
<li>
<p>正常来说就是一个微服务发送消息给 rabbitmq 消息队列，这个队列可能就一个消费者连着，可能多个连着这一个 (也就是轮询，或者按照能力来预取消息，或者某种自己定的预取值), 这样反正一个队列里面的信息只会被着多个消费者中的一个来消费</p>
</li>
<li>
<p>这个消费者消费消息的方式就是写个回调函数，只有我们消费者自己的同步任务完成了然后接收到来自队列的消息才会执行这个回调函数，当然这个回调函数也会有那个传来的消息等等等</p>
</li>
<li>
<p>为了确保我们 rabbitmq 消息队列发送消息给消费者确实是被消费者消费掉了 (各种处理完成之后), 而不是只是单纯的接收到了消息，我们需要手动确认 (而不是默认的那种一接收到就会跟我们的 rabbitmq 确认收到了), 这是因为 rabbitmq 一看到来自消费者的确认就会把消息从队列中删除，要是我们只是接收到了就发确认那么可能还没处理完消费者崩了，rabbitmq 以为我们已经 ok 了就把那个删了 (不过我不确定 springboot 整合的 rabbitmq 是不是已经帮我们做了手动确认什么的), 不过要是我们改为了手动确认且只有在我们这个消费者各种处理完消息才确认那么如果消费者在消费消息的时候因为某种原因崩了，rabbitmq 就知道消息没有真正被消费，就会把这个消息发给别的当前监听当前这个队列的消费者来处理</p>
</li>
<li>
<p>不过万一我们 rabbitmq 本身崩了怎么办？</p>
<ul>
<li>首先可以把队列和消息设置为持久化到硬盘，那么如果消息没有收到来自消费者的确认就代表这个消息没有被消费就会持久化到部署 rabbitmq 的服务器的硬盘上</li>
<li>同样我们的队列也需要持久化 (一般默认的好像都是临时队列，就是我们一重启当前的 rabbitmq 节点之前弄的临时队列就没了), 也就是 durable 为 true, 这样就算 rabbitmq 本身崩了，设置为 durable 为 true 的队列因为持久化到了硬盘上再重启的时候还在
<ul>
<li>rabbitmq 笔记里有关于 rabbitmq 节点然后把一个队列镜像到其他 rabbitmq 节点等等等</li>
</ul>
</li>
</ul>
<p>不过注意持久化到硬盘也会需要时间要是这期间崩了好像也不行…(不太确定)</p>
</li>
<li>
<p>接着我们可能想要对多个消费者发同一个消息，那么就需要交换机，交换机有 fanout,direct, 和 topic (还有 header 不过不怎么用了)</p>
<ul>
<li>fanout 就是广播，给所有当前交换机绑定的队列都发消息，这样这些队列都有这些消息，对应的消费者都能获得到那个消息 (除了一个队列对应多个消费者理所当然就只能一个消费者才能消费那个消息)</li>
<li>direct 就是正常按照 RoutingKey 方式找当前交换机绑定的队列发，一个队列绑定一个交换机可以有多个 RoutingKey, 两个队列绑定同一个交换机这两个队列绑定的 RoutingKey 可以是同一个 (应该可以)</li>
<li>topic 就是按照 pattern 找当前交换机绑定的有着对应的 RoutingKey 的队列发消息</li>
</ul>
</li>
<li>
<p>其实我们生产者 (发消息的) 给 rabbitmq (交换机…so on…), 我们交换机也需要给我们生产者发送一个发布确认的消息，这样就避免我们 rabbitmq 本身崩了，我们生产者还不知道。发布确认有三只用 (单个和批量属于同步，然后异步的方式，主要用的都是异步的)</p>
<ul>
<li>
<p>首先需要开启发布确认 -&gt;channel 设置 confirm 模式 (不确定 springboot 中怎么操作的)</p>
</li>
<li>
<p>然后如果是为异步的发布确认，那么我们就可以在生产者那边定义回调函数，比如说如果 rabbitmq 给我们返回了发布确认的消息，这个发布确认就会被调用那个消息的发布确认的回调函数 (当然我们有那个消息本身和序号等等等进行我们想要的操作)</p>
<p>最主要的是如果 rabbitmq 因为某种原因发布失败也会调用我们设置的对应的回调函数 (当然我们有那个消息本身和序号等等等进行我们想要的操作)</p>
</li>
</ul>
<p>所以生产者这边也有异步操作，不过这个主要是针对安全性 (个人认为)</p>
</li>
<li>
<p>还有就是死信队列，比如说我们一个消息的队列因为那三种原因某一种就可以把消息 pass on to another exchanger which we call as dead letter exchanger, this is just a normal exchanger which will then pass on to a dead letter queue with matching roughtingKey we have given then to any 监听这个死信队列的消费者这个主要是为了如果监听那个一开始队列的消费者处理不了那个消息 (其实就是那三种原因某一种), 那么就会按照我们给的死信交换机等等设置给到另外一个消费者看看能不能处理</p>
</li>
<li>
<p>然后延迟队列就是死信队列一种，主要是消息 TTL 时间过期，发布那个消息时给一个 TTL 时间，然后给一个延迟队列，这个队列没有消费者消费那个消息所以就会一直带着一直到 TTL 时间，一到 TTL 时间就会交给我们设置的死信交换机 -&gt; 死信队列–&gt; 监听这个死信队列的消费者来进行各种判断啊消费这个消息，一般用于我们想要做个定时任务</p>
</li>
<li>
<p>接着就是我们消息发给交换机，交换机可能找不到我们给的 Routingkey 对应的路由 (队列), 一般我们什么都不做的话那个消息会直接被丢掉，我们可以设置 <code>mandatory</code>  参数然后在生产者这边定义回调函数，这个回调函数 (异步) 会在交换机找不到我们给的 Routingkey 对应的队列时调用，当然可以接收到那个消息等等等，这个跟我们说的发布确认不一样，这个只是针对于交换机找不到对应路由 (的队列), 而发布确认更像是交换机本身没有接收 (发布) 那个消息，可能是因为 rabbitmq 崩了等等等</p>
</li>
<li>
<p>我们还有可以给那个交换机设置一个备份交换机，如果那个交换机找不到我们给的 Routingkey 对应的队列，就会把消息 pass on to 我们给他设置的备份交换机，这个备份交换机可以拿消息用来给各种队列发…(比如说给两个队列，一个队列把消息发给用来本分消息的消费者，一个队列把消息发给做警告的消费者)</p>
</li>
<li>
<p>我们还可以给一个消息设置优先级，这样这个更高优先级的消息进入一个队列中，会先从队列中被监听的消费者取出消费</p>
</li>
<li>
<p>还有什么惰性队列就是把消息放到硬盘中，减轻内存什么的，只有消费者要消费对应的消息时才会被加载到内存中 (好像是，这个了解的不清楚)</p>
</li>
<li>
<p>幂等性 -&gt; 可能某种原因消息被消费者多次消费，我们可以唯一 ID + 指纹码机制然后判断到底有没有已经消费过和这个消息啊方式解决，或者是 Redis 原子性方式解决</p>
</li>
<li>
<p>接着就是多个 rabbitmq 节点 -&gt; 集群啊啥的</p>
</li>
</ul>
</blockquote>
<hr>
<h1 id="elasticsearch"><a class="markdownIt-Anchor" href="#elasticsearch">#</a> ELasticsearch</h1>
<blockquote>
<p>案例地址：<a target="_blank" rel="noopener" href="https://gitee.com/xn2001/cloudcode/tree/master/09-elasticsearch-hotel-demo">https://gitee.com/xn2001/cloudcode/tree/master/09-elasticsearch-hotel-demo</a></p>
</blockquote>
<p>elasticsearch 是一款非常强大的开源搜索引擎，具备非常多强大功能，可以帮助我们从海量数据中快速找到需要的内容，可以用来实现搜索、日志统计、分析、系统监控等功能。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210918202359.png" alt=""></p>
<h2 id="倒排索引"><a class="markdownIt-Anchor" href="#倒排索引">#</a> 倒排索引</h2>
<p><strong>首先，倒排索引的概念是基于 MySQL 这样的正向索引而言的。</strong></p>
<p>那么我们先讲何为正向索引。例如给下表（tb_goods）中的 id 创建索引</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210918202527.png" alt=""></p>
<p>如果是根据 id 查询，那么直接走索引，查询速度非常快。</p>
<p>但如果是基于 title 做模糊查询，只能是逐行扫描数据，流程如下：</p>
<ol>
<li>用户搜索数据，条件是 title 符合  <code>&quot;%手机%&quot;</code></li>
<li>逐行获取数据，比如 id 为 1 的数据</li>
<li>判断数据中的 title 是否符合用户搜索条件</li>
<li>如果符合则放入结果集，不符合则丢弃。然后回到步骤 1</li>
</ol>
<p>逐行扫描，也就是全表扫描，随着数据量增加，其查询效率也会越来越低。当数据量达到数百万时，就是。。。</p>
<p>而倒排索引中有两个非常重要的概念：</p>
<ul>
<li>文档（ <code>Document</code> ）：用来搜索的数据，其中的每一条数据就是一个文档。例如一个网页、一个商品信息</li>
<li>词条（ <code>Term</code> ）：对文档数据或用户搜索数据，利用某种算法分词，得到的具备含义的词语就是词条。例如：我是中国人，就可以分为：我、是、中国人、中国、国人这样的几个词条</li>
</ul>
<p><strong>创建倒排索引</strong>是对正向索引的一种特殊处理，流程如下：</p>
<ul>
<li>将每一个文档的数据利用算法分词，得到一个个词条</li>
<li>创建表，每行数据包括词条、词条所在文档 id、位置等信息</li>
<li>因为词条唯一性，可以给词条创建索引，例如 hash 表结构索引</li>
</ul>
<p>如图：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210918203514.png" alt=""></p>
<p><strong>倒排索引的搜索流程</strong>如下（以搜索 &quot;华为手机&quot; 为例）</p>
<ol>
<li>用户输入条件 <code>&quot;华为手机&quot;</code>  进行搜索</li>
<li>对用户输入内容<strong>分词</strong>，得到词条： <code>华为</code> 、 <code>手机</code></li>
<li>拿着词条在倒排索引中查找，可以得到包含词条的文档 id 有 1、2、3</li>
<li>拿着文档 id 到正向索引中查找具体文档</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210918203815.png" alt=""></p>
<p><strong>虽然要先查询倒排索引，再查询正向索引，但是词条和文档 id 都建立了索引，查询速度非常快！无需全表扫描。</strong></p>
<p>为什么一个叫做正向索引，一个叫做倒排索引呢？</p>
<p><strong>正向索引</strong>是最传统的，根据 id 索引的方式。但根据词条查询时，必须先逐条获取每个文档，然后判断文档中是否包含所需要的词条，是<strong>根据文档找词条的过程</strong></p>
<p><strong>倒排索引</strong>则相反，是先找到用户要搜索的词条，根据得到的文档 id 获取该文档。是<strong>根据词条找文档的过程</strong></p>
<h2 id="文档和字段"><a class="markdownIt-Anchor" href="#文档和字段">#</a> 文档和字段</h2>
<p>elasticsearch 是面向 ** 文档（Document）** 存储的，可以是数据库中的一条商品数据，一个订单信息。文档数据会被序列化为 json 格式后存储在 elasticsearch</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210918212707.png" alt=""></p>
<p>而 JSON 文档中往往包含很多的<strong>字段（Field）</strong>，类似于数据库中的列。</p>
<h2 id="索引和映射"><a class="markdownIt-Anchor" href="#索引和映射">#</a> 索引和映射</h2>
<p><strong>索引（Index）</strong>，就是相同类型的文档的集合。</p>
<p>例如：</p>
<ul>
<li>所有用户文档，就可以组织在一起，称为用户的索引；</li>
<li>所有商品的文档，可以组织在一起，称为商品的索引；</li>
<li>所有订单的文档，可以组织在一起，称为订单的索引；</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210918213357.png" alt=""></p>
<p>因此，我们可以把索引当做是数据库中的表。</p>
<p>数据库的表会有约束信息，用来定义表的结构、字段的名称、类型等信息。因此，索引库中就有<strong>映射（mapping）</strong>，是索引中文档的字段约束信息，类似表的结构约束。</p>
<p><strong>mysql 与 elasticsearch</strong></p>
<table>
<thead>
<tr>
<th><strong>MySQL</strong></th>
<th><strong>Elasticsearch</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>Table</td>
<td>Index</td>
<td>索引 (index)，就是文档的集合，类似数据库的表 (table)</td>
</tr>
<tr>
<td>Row</td>
<td>Document</td>
<td>文档（Document），就是一条条的数据，类似数据库中的行（Row），文档都是 JSON 格式</td>
</tr>
<tr>
<td>Column</td>
<td>Field</td>
<td>字段（Field），就是 JSON 文档中的字段，类似数据库中的列（Column）</td>
</tr>
<tr>
<td>Schema</td>
<td>Mapping</td>
<td>Mapping（映射）是索引中文档的约束，例如字段类型约束。类似数据库的表结构（Schema）</td>
</tr>
<tr>
<td>SQL</td>
<td>DSL</td>
<td>DSL 是 elasticsearch 提供的 JSON 风格的请求语句，用来操作 elasticsearch，实现 CRUD</td>
</tr>
</tbody>
</table>
<ul>
<li>Mysql：擅长事务类型操作，可以确保数据的安全和一致性</li>
<li>Elasticsearch：擅长海量数据的搜索、分析、计算</li>
</ul>
<p>因此在企业中，往往是两者结合使用：</p>
<ul>
<li>对安全性要求较高的写操作，使用 MySQL 实现</li>
<li>对查询性能要求较高的搜索需求，使用 ELasticsearch 实现</li>
<li>两者再基于某种方式，实现数据的同步，保证一致性</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210918213631.png" alt=""></p>
<h2 id="安装elasticsearch"><a class="markdownIt-Anchor" href="#安装elasticsearch">#</a> 安装 Elasticsearch</h2>
<p>因为我们还需要部署 kibana 容器，需要让 es 和 kibana 容器互联。这里先创建一个网络：</p>
<pre class="line-numbers language-none"><code class="language-none">docker network create es-net<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>安装</p>
<pre class="line-numbers language-none"><code class="language-none">docker run -d \
--name es \
-e &quot;ES_JAVA_OPTS&#x3D;-Xms512m -Xmx512m&quot; \
-e &quot;discovery.type&#x3D;single-node&quot; \
-v es-data:&#x2F;usr&#x2F;share&#x2F;elasticsearch&#x2F;data \
-v es-plugins:&#x2F;usr&#x2F;share&#x2F;elasticsearch&#x2F;plugins \
--privileged \
--network es-net \
-p 9200:9200 \
-p 9300:9300 \
elasticsearch:7.12.1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>命令解释：</p>
<ul>
<li><code>-e &quot;cluster.name=es-docker-cluster&quot;</code> ：设置集群名称</li>
<li><code>-e &quot;http.host=0.0.0.0&quot;</code> ：监听的地址，可以外网访问</li>
<li><code>-e &quot;ES_JAVA_OPTS=-Xms512m -Xmx512m&quot;</code> ：内存大小</li>
<li><code>-e &quot;discovery.type=single-node&quot;</code> ：非集群模式</li>
<li><code>-v es-data:/usr/share/elasticsearch/data</code> ：挂载逻辑卷，绑定 es 的数据目录</li>
<li><code>-v es-logs:/usr/share/elasticsearch/logs</code> ：挂载逻辑卷，绑定 es 的日志目录</li>
<li><code>-v es-plugins:/usr/share/elasticsearch/plugins</code> ：挂载逻辑卷，绑定 es 的插件目录</li>
<li><code>--privileged</code> ：授予逻辑卷访问权</li>
<li><code>--network es-net</code>  ：加入一个名为 es-net 的网络中</li>
<li><code>-p 9200:9200</code> ：端口映射配置</li>
</ul>
<p>访问地址：<a target="_blank" rel="noopener" href="http://192.168.211.128">http://192.168.211.128</a>:9200 即可看到 elasticsearch 的响应结果</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210918214620.png" alt=""></p>
<h2 id="安装kibana"><a class="markdownIt-Anchor" href="#安装kibana">#</a> 安装 kibana</h2>
<p>kibana 可以给我们提供一个 elasticsearch 的可视化界面，便于我们学习命令。</p>
<pre class="line-numbers language-none"><code class="language-none">docker run -d \
--name kibana \
-e ELASTICSEARCH_HOSTS&#x3D;http:&#x2F;&#x2F;es:9200 \
--network&#x3D;es-net \
-p 5601:5601  \
kibana:7.12.1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><code>--network es-net</code>  ：加入一个名为 es-net 的网络中，与 elasticsearch 在同一个网络中</li>
<li><code>-e ELASTICSEARCH_HOSTS=http://es:9200&quot;</code> ：设置 elasticsearch 的地址，因为 kibana 已经与 elasticsearch 在一个网络，因此可以用容器名直接访问 elasticsearch</li>
<li><code>-p 5601:5601</code> ：端口映射配置</li>
</ul>
<p>访问地址：<a target="_blank" rel="noopener" href="http://192.168.211.128">http://192.168.211.128</a>:5601，即可看到结果</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210918214722.png" alt=""></p>
<p>控制面板：<a target="_blank" rel="noopener" href="http://192.168.211.128">http://192.168.211.128</a>:5601/app/dev_tools#/console</p>
<h2 id="安装ik分词器"><a class="markdownIt-Anchor" href="#安装ik分词器">#</a> 安装 IK 分词器</h2>
<p>由于国内访问 GitHub 较慢，我们选择离线模式安装。</p>
<p>安装插件需要知道 elasticsearch 的 plugins 目录位置，而我们用了数据卷挂载，因此需要查看 elasticsearch 的数据卷目录，通过下面命令查看</p>
<pre class="line-numbers language-dockerfile" data-language="dockerfile"><code class="language-dockerfile">docker volume inspect es-plugins<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>显示结果：</p>
<pre class="line-numbers language-none"><code class="language-none">[
    &#123;
        &quot;CreatedAt&quot;: &quot;2022-05-06T10:06:34+08:00&quot;,
        &quot;Driver&quot;: &quot;local&quot;,
        &quot;Labels&quot;: null,
        &quot;Mountpoint&quot;: &quot;&#x2F;var&#x2F;lib&#x2F;docker&#x2F;volumes&#x2F;es-plugins&#x2F;_data&quot;,
        &quot;Name&quot;: &quot;es-plugins&quot;,
        &quot;Options&quot;: null,
        &quot;Scope&quot;: &quot;local&quot;
    &#125;
]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>说明 plugins 目录被挂载到了  <code>/var/lib/docker/volumes/es-plugins/_data</code>  这个目录中</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210918215615.png" alt=""></p>
<p>重启容器</p>
<pre class="line-numbers language-none"><code class="language-none"># 4、重启容器
docker restart es
 # 查看es日志
docker logs -f es<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>IK 分词器包含两种模式：</p>
<ul>
<li><code>ik_smart</code> ：智能切分，粗粒度</li>
<li><code>ik_max_word</code> ：最细切分，细粒度</li>
</ul>
<p>我们在上面的 Kibana 控制台测试</p>
<pre class="line-numbers language-none"><code class="language-none">GET &#x2F;_analyze
&#123;
  &quot;analyzer&quot;: &quot;ik_max_word&quot;,
  &quot;text&quot;: &quot;钟老师你好菜啊&quot;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="扩展词词典"><a class="markdownIt-Anchor" href="#扩展词词典">#</a> 扩展词词典</h2>
<p>在上面的 IK 分词器我们可以随着热点词来扩展，可以自己添加，比如 ” 钟老师应该是一个热点词 “，另外你也可以配置一些停用掉的敏感词，让其不进行分词。</p>
<p>打开 IK 分词器 config 目录是  <code>IKAnalyzer.cfg.xml</code> ，添加一个文件名，我们以  <code>ext.dic</code>  文件名为例。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210918221159.png" alt=""></p>
<p>我们去创建  <code>ext.dic</code>  ，在其中添加热点词就好了，一个词一行。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210918220910.png" alt=""></p>
<p>重启 elasticsearch</p>
<pre class="line-numbers language-none"><code class="language-none">docker restart es<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>重新测试</p>
<pre class="line-numbers language-none"><code class="language-none">GET &#x2F;_analyze
&#123;
  &quot;analyzer&quot;: &quot;ik_max_word&quot;,
  &quot;text&quot;: &quot;钟老师你好菜啊&quot;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210918221424.png" alt=""></p>
<h2 id="索引库操作"><a class="markdownIt-Anchor" href="#索引库操作">#</a> 索引库操作</h2>
<h3 id="mapping属性映射"><a class="markdownIt-Anchor" href="#mapping属性映射">#</a> Mapping 属性映射</h3>
<p>索引库就类似数据库表，<strong>mapping 映射就类似表的结构</strong></p>
<p>我们要向 es 中存储数据，必须先创建 “库” 和 “表”</p>
<p>mapping 是对索引库中文档的约束，常见的 mapping 属性包括：</p>
<ul>
<li>
<p>type：字段数据类型，常见的简单类型有：</p>
<ul>
<li>字符串：text（可分词的文本）、keyword（精确值，例如：品牌、国家、ip 地址）</li>
<li>数值：long、integer、short、byte、double、float、</li>
<li>布尔：boolean</li>
<li>日期：date</li>
<li>对象：object</li>
</ul>
</li>
<li>
<p><strong>index：是否创建索引，默认为 true</strong></p>
</li>
<li>
<p>analyzer：使用哪种分词器</p>
</li>
<li>
<p>properties：该字段的子字段</p>
</li>
</ul>
<p>我们以需要存储下面的 JSON 为例来讲解</p>
<pre class="line-numbers language-none"><code class="language-none">&#123;
    &quot;age&quot;: 21,
    &quot;weight&quot;: 52.1,
    &quot;isMarried&quot;: false,
    &quot;info&quot;: &quot;钟老师真菜&quot;,
    &quot;email&quot;: &quot;jialna@qq.com&quot;,
    &quot;score&quot;: [99.1, 99.5, 98.9],
    &quot;name&quot;: &#123;
        &quot;firstName&quot;: &quot;湖&quot;,
        &quot;lastName&quot;: &quot;心&quot;
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先对应的每个字段映射（mapping）情况如下：</p>
<ul>
<li>
<p>age：类型为 integer；参与搜索，index 为 true；无需分词器</p>
</li>
<li>
<p>weight：类型为 float；参与搜索，index 为 true；无需分词器</p>
</li>
<li>
<p>isMarried：类型为 boolean；参与搜索，index 为 true；无需分词器</p>
</li>
<li>
<p>info：类型为字符串，需要分词，因此是 text；参与搜索，index 为 true；分词器可以用 ik_smart</p>
</li>
<li>
<p>email：类型为字符串，但是不需要分词，因此是 keyword；不参与搜索，index 为 false；无需分词器</p>
</li>
<li>
<p>score：虽然是数组，<strong>但是我们只看元素的类型</strong>，类型为 float；参与搜索，index 为 true；无需分词器</p>
</li>
<li>
<p>name：类型为 object，需要定义多个子属性</p>
<ul>
<li>name.firstName：类型为字符串，不需要分词，keyword；参与搜索，index 为 true；无需分词器</li>
<li>name.lastName：类型为字符串，不需要分词，keyword；参与搜索，index 为 true；无需分词器</li>
</ul>
</li>
</ul>
<h3 id="创建索引库和映射"><a class="markdownIt-Anchor" href="#创建索引库和映射">#</a> 创建索引库和映射</h3>
<p>上面我们了解了 Mapping 属性映射，接下来我们就去看看如何创建索引库及映射。</p>
<pre class="line-numbers language-none"><code class="language-none">PUT &#x2F;索引库名称
&#123;
  &quot;mappings&quot;: &#123;
    &quot;properties&quot;: &#123;
      &quot;字段名&quot;:&#123;
        &quot;type&quot;: &quot;text&quot;,
        &quot;analyzer&quot;: &quot;ik_smart&quot;
      &#125;,
      &quot;字段名2&quot;:&#123;
        &quot;type&quot;: &quot;keyword&quot;,
        &quot;index&quot;: &quot;false&quot;
      &#125;,
      &quot;字段名3&quot;:&#123;
        &quot;properties&quot;: &#123;
          &quot;子字段&quot;: &#123;
            &quot;type&quot;: &quot;keyword&quot;
          &#125;
        &#125;
      &#125;
      &#x2F;&#x2F; ...略
    &#125;
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-none"><code class="language-none">PUT &#x2F;xn2001
&#123;
  &quot;mappings&quot;: &#123;
    &quot;properties&quot;: &#123;
      &quot;info&quot;:&#123;
        &quot;type&quot;: &quot;text&quot;,
        &quot;analyzer&quot;: &quot;ik_smart&quot;
      &#125;,
      &quot;email&quot;:&#123;
        &quot;type&quot;: &quot;keyword&quot;,
        &quot;index&quot;: &quot;false&quot;
      &#125;,
      &quot;name&quot;:&#123;
        &quot;properties&quot;: &#123;
          &quot;firstName&quot;: &#123;
            &quot;type&quot;: &quot;keyword&quot;
          &#125;,
          &quot;lastName&quot;: &#123;
            &quot;type&quot;: &quot;keyword&quot;
          &#125;
        &#125;
      &#125;
    &#125;
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210918224647.png" alt=""></p>
<p>我们用真实的数据库表来创建一个索引库</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210919164626.png" alt=""></p>
<ul>
<li>字段名、字段数据类型，可以参考数据表结构的名称和类型</li>
<li>是否参与搜索要分析业务来判断，例如图片地址，就无需参与搜索</li>
<li>是否分词呢要看内容，内容如果是一个整体就无需分词</li>
<li>分词器，我们可以统一使用  <code>ik_max_word</code></li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">PUT &#x2F;hotel
&#123;
  &quot;mappings&quot;: &#123;
    &quot;properties&quot;: &#123;
      &quot;id&quot;: &#123;
        &quot;type&quot;: &quot;keyword&quot;
      &#125;,
      &quot;name&quot;:&#123;
        &quot;type&quot;: &quot;text&quot;,
        &quot;analyzer&quot;: &quot;ik_max_word&quot;,
        &quot;copy_to&quot;: &quot;all&quot;
      &#125;,
      &quot;address&quot;:&#123;
        &quot;type&quot;: &quot;keyword&quot;,
        &quot;index&quot;: false
      &#125;,
      &quot;price&quot;:&#123;
        &quot;type&quot;: &quot;integer&quot;
      &#125;,
      &quot;score&quot;:&#123;
        &quot;type&quot;: &quot;integer&quot;
      &#125;,
      &quot;brand&quot;:&#123;
        &quot;type&quot;: &quot;keyword&quot;,
        &quot;copy_to&quot;: &quot;all&quot;
      &#125;,
      &quot;city&quot;:&#123;
        &quot;type&quot;: &quot;keyword&quot;,
        &quot;copy_to&quot;: &quot;all&quot;
      &#125;,
      &quot;starName&quot;:&#123;
        &quot;type&quot;: &quot;keyword&quot;
      &#125;,
      &quot;business&quot;:&#123;
        &quot;type&quot;: &quot;keyword&quot;
      &#125;,
      &quot;location&quot;:&#123;
        &quot;type&quot;: &quot;geo_point&quot;
      &#125;,
      &quot;pic&quot;:&#123;
        &quot;type&quot;: &quot;keyword&quot;,
        &quot;index&quot;: false
      &#125;,
      &quot;all&quot;:&#123;
        &quot;type&quot;: &quot;text&quot;,
        &quot;analyzer&quot;: &quot;ik_max_word&quot;
      &#125;
    &#125;
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>特殊字段说明：</p>
<ul>
<li>location：地理坐标，里面包含精度、纬度</li>
<li>all：一个组合字段，其目的是将多字段的值利用  <code>copy_to</code>  合并，提供给用户搜索，这样一来就只需要搜索一个字段就可以得到结果，性能更好。</li>
</ul>
<blockquote>
<p>ES 中支持两种地理坐标数据类型：</p>
<ul>
<li>geo_point：由纬度（latitude）和经度（longitude）确定的一个点。例如：“32.8752345, 120.2981576”</li>
<li>geo_shape：有多个 geo_point 组成的复杂几何图形。例如一条直线，“LINESTRING (-77.03653 38.897676, -77.009051 38.889939)”</li>
</ul>
</blockquote>
<h3 id="修改索引库"><a class="markdownIt-Anchor" href="#修改索引库">#</a> 修改索引库</h3>
<p>倒排索引结构虽然不复杂，但是一旦数据结构改变（比如改变了分词器），就需要重新创建倒排索引，这简直是灾难。因此索引库<strong>一旦创建，无法修改 mapping</strong></p>
<p>虽然无法修改 mapping 中已有的字段，但是却允许添加新的字段到 mapping 中，不会对倒排索引产生影响。</p>
<pre class="line-numbers language-none"><code class="language-none">PUT &#x2F;索引库名&#x2F;_mapping
&#123;
  &quot;properties&quot;: &#123;
    &quot;新字段名&quot;:&#123;
      &quot;type&quot;: &quot;integer&quot;
    &#125;
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="删除索引库"><a class="markdownIt-Anchor" href="#删除索引库">#</a> 删除索引库</h3>
<pre class="line-numbers language-none"><code class="language-none">DELETE &#x2F;索引库名<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="查询索引库"><a class="markdownIt-Anchor" href="#查询索引库">#</a> 查询索引库</h3>
<pre class="line-numbers language-none"><code class="language-none">GET &#x2F;数据库名<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="dsl文档操作"><a class="markdownIt-Anchor" href="#dsl文档操作">#</a> DSL 文档操作</h2>
<h3 id="新增文档"><a class="markdownIt-Anchor" href="#新增文档">#</a> 新增文档</h3>
<pre class="line-numbers language-none"><code class="language-none">POST &#x2F;索引库名&#x2F;_doc&#x2F;文档id
&#123;
    &quot;字段1&quot;: &quot;值1&quot;,
    &quot;字段2&quot;: &quot;值2&quot;,
    &quot;字段3&quot;: &#123;
        &quot;子属性1&quot;: &quot;值3&quot;,
        &quot;子属性2&quot;: &quot;值4&quot;
    &#125;
    &#x2F;&#x2F; ...
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-none"><code class="language-none">POST &#x2F;xn2001&#x2F;_doc&#x2F;1
&#123;
    &quot;info&quot;: &quot;我不会Java&quot;,
    &quot;email&quot;: &quot;jialna@qq.com&quot;,
    &quot;name&quot;: &#123;
        &quot;firstName&quot;: &quot;钟&quot;,
        &quot;lastName&quot;: &quot;弟弟&quot;
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="修改文档"><a class="markdownIt-Anchor" href="#修改文档">#</a> 修改文档</h3>
<p>修改文档有两种方式：</p>
<ul>
<li>全量修改：直接覆盖原来的文档</li>
<li>增量修改：修改文档中的部分字段</li>
</ul>
<p><strong>全量修改</strong>是覆盖原来的文档，其本质是：</p>
<ul>
<li>根据指定的 id 删除文档</li>
<li>新增一个相同 id 的文档</li>
</ul>
<p><strong>注意</strong>：如果根据 id 删除时，id 不存在，第二步的新增也会执行，也就是变成了新增操作</p>
<pre class="line-numbers language-none"><code class="language-none">PUT &#x2F;&#123;索引库名&#125;&#x2F;_doc&#x2F;id
&#123;
    &quot;字段1&quot;: &quot;值1&quot;,
    &quot;字段2&quot;: &quot;值2&quot;,
    &#x2F;&#x2F; ... 略
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-none"><code class="language-none">PUT &#x2F;xn2001&#x2F;_doc&#x2F;1
&#123;
    &quot;info&quot;: &quot;我也不会敲代码&quot;,
    &quot;email&quot;: &quot;3300123589@qq.com&quot;,
    &quot;name&quot;: &#123;
        &quot;firstName&quot;: &quot;弟弟&quot;,
        &quot;lastName&quot;: &quot;钟&quot;
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>增量修改</strong>是只修改指定 id 匹配的文档中的部分字段</p>
<pre class="line-numbers language-none"><code class="language-none">POST &#x2F;&#123;索引库名&#125;&#x2F;_update&#x2F;文档id
&#123;
    &quot;doc&quot;: &#123;
         &quot;字段名&quot;: &quot;新的值&quot;,
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-none"><code class="language-none">POST &#x2F;heima&#x2F;_update&#x2F;1
&#123;
  &quot;doc&quot;: &#123;
    &quot;email&quot;: &quot;update@qq.com&quot;
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="查询文档"><a class="markdownIt-Anchor" href="#查询文档">#</a> 查询文档</h3>
<pre class="line-numbers language-none"><code class="language-none">GET &#x2F;&#123;索引库名称&#125;&#x2F;_doc&#x2F;&#123;id&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="删除文档"><a class="markdownIt-Anchor" href="#删除文档">#</a> 删除文档</h3>
<pre class="line-numbers language-none"><code class="language-none">DELETE &#x2F;&#123;索引库名&#125;&#x2F;_doc&#x2F;&#123;id&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="restclient文档操作"><a class="markdownIt-Anchor" href="#restclient文档操作">#</a> RestClient 文档操作</h2>
<p>ES 官方提供了各种不同语言的客户端，用来操作 ES。这些客户端的本质就是组装 DSL 语句，通过 http 请求发送给 ES。官方文档地址：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/client/index.html">https://www.elastic.co/guide/en/elasticsearch/client/index.html</a></p>
<p>其中的 Java Rest Client 又包括两种：</p>
<ul>
<li>Java Low Level Rest Client</li>
<li>Java High Level Rest Client</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210919234405.png" alt=""></p>
<p>我们下面学习的是 <strong>Java HighLevel Rest Client 客户端 API</strong></p>
<h3 id="初始化restclient"><a class="markdownIt-Anchor" href="#初始化restclient">#</a> 初始化 RestClient</h3>
<p>在 elasticsearch 提供的 API 中，elasticsearch 一切交互都封装在一个名为 RestHighLevelClient 的类中，必须先完成这个对象的初始化，建立与 elasticsearch 的连接。</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.elasticsearch.client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>elasticsearch-rest-high-level-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>SpringBoot 默认的 ES 版本是 7.6.2，我们需要覆盖默认的 ES 版本</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.version</span><span class="token punctuation">></span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>java.version</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>elasticsearch.version</span><span class="token punctuation">></span></span>7.12.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>elasticsearch.version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>初始化 RestHighLevelClient，初始化的代码如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">RestHighLevelClient</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RestHighLevelClient</span><span class="token punctuation">(</span><span class="token class-name">RestClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>
        <span class="token class-name">HttpHost</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"http://192.168.211.128:9200"</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>我们创建一个测试类 HotelIndexTest，然后将初始化的代码编写在  <code>@BeforeEach</code>  方法</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * @author 乐心湖
 * @version 1.0
 * @date 2021/9/19 17:18
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HotelIndexTest</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token class-name">RestHighLevelClient</span> restHighLevelClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">testInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>restHighLevelClient<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@BeforeEach</span>
    <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>restHighLevelClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RestHighLevelClient</span><span class="token punctuation">(</span><span class="token class-name">RestClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>
                <span class="token class-name">HttpHost</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"http://192.168.211.128:9200"</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@AfterEach</span>
    <span class="token keyword">void</span> <span class="token function">down</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>restHighLevelClient<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="创建索引库"><a class="markdownIt-Anchor" href="#创建索引库">#</a> 创建索引库</h3>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">createHotelIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//指定索引库名</span>
    <span class="token class-name">CreateIndexRequest</span> hotel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CreateIndexRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//写入JSON数据，这里是Mapping映射</span>
    hotel<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token class-name">HotelConstants</span><span class="token punctuation">.</span>MAPPING_TEMPLATE<span class="token punctuation">,</span> <span class="token class-name">XContentType</span><span class="token punctuation">.</span>JSON<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//创建索引库</span>
    restHighLevelClient<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>hotel<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HotelConstants</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> MAPPING_TEMPLATE <span class="token operator">=</span> <span class="token string">"&#123;\n"</span> <span class="token operator">+</span>
            <span class="token string">"  \"mappings\": &#123;\n"</span> <span class="token operator">+</span>
            <span class="token string">"    \"properties\": &#123;\n"</span> <span class="token operator">+</span>
            <span class="token string">"      \"id\": &#123;\n"</span> <span class="token operator">+</span>
            <span class="token string">"        \"type\": \"keyword\"\n"</span> <span class="token operator">+</span>
            <span class="token string">"      &#125;,\n"</span> <span class="token operator">+</span>
            <span class="token string">"      \"name\":&#123;\n"</span> <span class="token operator">+</span>
            <span class="token string">"        \"type\": \"text\",\n"</span> <span class="token operator">+</span>
            <span class="token string">"        \"analyzer\": \"ik_max_word\",\n"</span> <span class="token operator">+</span>
            <span class="token string">"        \"copy_to\": \"all\"\n"</span> <span class="token operator">+</span>
            <span class="token string">"      &#125;,\n"</span> <span class="token operator">+</span>
            <span class="token string">"      \"address\":&#123;\n"</span> <span class="token operator">+</span>
            <span class="token string">"        \"type\": \"keyword\",\n"</span> <span class="token operator">+</span>
            <span class="token string">"        \"index\": false\n"</span> <span class="token operator">+</span>
            <span class="token string">"      &#125;,\n"</span> <span class="token operator">+</span>
            <span class="token string">"      \"price\":&#123;\n"</span> <span class="token operator">+</span>
            <span class="token string">"        \"type\": \"integer\"\n"</span> <span class="token operator">+</span>
            <span class="token string">"      &#125;,\n"</span> <span class="token operator">+</span>
            <span class="token string">"      \"score\":&#123;\n"</span> <span class="token operator">+</span>
            <span class="token string">"        \"type\": \"integer\"\n"</span> <span class="token operator">+</span>
            <span class="token string">"      &#125;,\n"</span> <span class="token operator">+</span>
            <span class="token string">"      \"brand\":&#123;\n"</span> <span class="token operator">+</span>
            <span class="token string">"        \"type\": \"keyword\",\n"</span> <span class="token operator">+</span>
            <span class="token string">"        \"copy_to\": \"all\"\n"</span> <span class="token operator">+</span>
            <span class="token string">"      &#125;,\n"</span> <span class="token operator">+</span>
            <span class="token string">"      \"city\":&#123;\n"</span> <span class="token operator">+</span>
            <span class="token string">"        \"type\": \"keyword\",\n"</span> <span class="token operator">+</span>
            <span class="token string">"        \"copy_to\": \"all\"\n"</span> <span class="token operator">+</span>
            <span class="token string">"      &#125;,\n"</span> <span class="token operator">+</span>
            <span class="token string">"      \"starName\":&#123;\n"</span> <span class="token operator">+</span>
            <span class="token string">"        \"type\": \"keyword\"\n"</span> <span class="token operator">+</span>
            <span class="token string">"      &#125;,\n"</span> <span class="token operator">+</span>
            <span class="token string">"      \"business\":&#123;\n"</span> <span class="token operator">+</span>
            <span class="token string">"        \"type\": \"keyword\"\n"</span> <span class="token operator">+</span>
            <span class="token string">"      &#125;,\n"</span> <span class="token operator">+</span>
            <span class="token string">"      \"location\":&#123;\n"</span> <span class="token operator">+</span>
            <span class="token string">"        \"type\": \"geo_point\"\n"</span> <span class="token operator">+</span>
            <span class="token string">"      &#125;,\n"</span> <span class="token operator">+</span>
            <span class="token string">"      \"pic\":&#123;\n"</span> <span class="token operator">+</span>
            <span class="token string">"        \"type\": \"keyword\",\n"</span> <span class="token operator">+</span>
            <span class="token string">"        \"index\": false\n"</span> <span class="token operator">+</span>
            <span class="token string">"      &#125;,\n"</span> <span class="token operator">+</span>
            <span class="token string">"      \"all\":&#123;\n"</span> <span class="token operator">+</span>
            <span class="token string">"        \"type\": \"text\",\n"</span> <span class="token operator">+</span>
            <span class="token string">"        \"analyzer\": \"ik_max_word\"\n"</span> <span class="token operator">+</span>
            <span class="token string">"      &#125;\n"</span> <span class="token operator">+</span>
            <span class="token string">"    &#125;\n"</span> <span class="token operator">+</span>
            <span class="token string">"  &#125;\n"</span> <span class="token operator">+</span>
            <span class="token string">"&#125;"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="删除索引库-2"><a class="markdownIt-Anchor" href="#删除索引库-2">#</a> 删除索引库</h3>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">deleteHotelIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">DeleteIndexRequest</span> hotel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DeleteIndexRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    restHighLevelClient<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>hotel<span class="token punctuation">,</span><span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="判断索引库"><a class="markdownIt-Anchor" href="#判断索引库">#</a> 判断索引库</h3>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">existHotelIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">GetIndexRequest</span> hotel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetIndexRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> exists <span class="token operator">=</span> restHighLevelClient<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>hotel<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>exists<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="新增文档-2"><a class="markdownIt-Anchor" href="#新增文档-2">#</a> 新增文档</h3>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * @author 乐心湖
 * @version 1.0
 * @date 2021/9/19 17:18
 */</span>
<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HotelDocumentTest</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token class-name">RestHighLevelClient</span> restHighLevelClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">IHotelService</span> hotelService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">testInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>restHighLevelClient<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">createHotelIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Hotel</span> hotel <span class="token operator">=</span> hotelService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span><span class="token number">61083L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HotelDoc</span> hotelDoc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">(</span>hotel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 1.准备Request对象</span>
        <span class="token class-name">IndexRequest</span> hotelIndex <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>hotelDoc<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.准备Json文档</span>
        hotelIndex<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>hotelDoc<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">XContentType</span><span class="token punctuation">.</span>JSON<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3.发送请求</span>
        restHighLevelClient<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>hotelIndex<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@BeforeEach</span>
    <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>restHighLevelClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RestHighLevelClient</span><span class="token punctuation">(</span><span class="token class-name">RestClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>
                <span class="token class-name">HttpHost</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"http://192.168.211.128:9200"</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@AfterEach</span>
    <span class="token keyword">void</span> <span class="token function">down</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>restHighLevelClient<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="查询文档-2"><a class="markdownIt-Anchor" href="#查询文档-2">#</a> 查询文档</h3>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testGetDocumentById</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 1.准备Request</span>
    <span class="token class-name">GetRequest</span> hotel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">,</span> <span class="token string">"61083"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.发送请求，得到响应</span>
    <span class="token class-name">GetResponse</span> hotelResponse <span class="token operator">=</span> restHighLevelClient<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>hotel<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3.解析响应结果</span>
    <span class="token class-name">String</span> hotelDocSourceAsString <span class="token operator">=</span> hotelResponse<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4.json转实体类</span>
    <span class="token class-name">HotelDoc</span> hotelDoc <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>hotelDocSourceAsString<span class="token punctuation">,</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hotelDoc<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="删除文档-2"><a class="markdownIt-Anchor" href="#删除文档-2">#</a> 删除文档</h3>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testDeleteDocumentById</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">DeleteRequest</span> hotel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DeleteRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">,</span> <span class="token string">"61083"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    restHighLevelClient<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>hotel<span class="token punctuation">,</span><span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="修改文档-2"><a class="markdownIt-Anchor" href="#修改文档-2">#</a> 修改文档</h3>
<p>前面我们说过，修改文档有两种方式：</p>
<ul>
<li>全量修改：直接覆盖原来的文档</li>
<li>增量修改：修改文档中的部分字段</li>
</ul>
<p>在 RestClient 的 API 中，全量修改与新增的 API 完全一致，判断依据是 ID</p>
<ul>
<li>如果新增时，ID 已经存在，则修改</li>
<li>如果新增时，ID 不存在，则新增</li>
</ul>
<p>所以全量修改写法与新增文档一样，下面我们主要是介绍增量修改。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testUpdateDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 1.准备Request</span>
    <span class="token class-name">UpdateRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UpdateRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">,</span> <span class="token string">"61083"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.准备请求参数</span>
    request<span class="token punctuation">.</span><span class="token function">doc</span><span class="token punctuation">(</span>
        <span class="token string">"price"</span><span class="token punctuation">,</span> <span class="token string">"952"</span><span class="token punctuation">,</span>
        <span class="token string">"starName"</span><span class="token punctuation">,</span> <span class="token string">"四钻"</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3.发送请求</span>
    restHighLevelClient<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="批量导入文档"><a class="markdownIt-Anchor" href="#批量导入文档">#</a> 批量导入文档</h3>
<p>案例需求：利用  <code>BulkRequest</code>  批量将数据库数据导入到索引库中。</p>
<ul>
<li>利用 mybatis-plus 查询酒店数据</li>
<li>将查询到的酒店数据（Hotel）转换为文档类型数据（HotelDoc）</li>
<li>利用 JavaRestClient 中的 BulkRequest 批处理，实现批量新增文档</li>
</ul>
<p>批量处理 BulkRequest，其本质就是将多个普通的 CRUD 请求组合在一起发送。</p>
<p>因此 Bulk 中添加了多个 IndexRequest，就是批量新增功能了。示例：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210919234350.png" alt=""></p>
<p>利用这一点，我们可以写出自己需要的代码，如下</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testBulk</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">BulkRequest</span> bulkRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BulkRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Hotel</span><span class="token punctuation">></span></span> hotelList <span class="token operator">=</span> hotelService<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    hotelList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>item <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">HotelDoc</span> hotelDoc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
        bulkRequest<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IndexRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>hotelDoc<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>hotelDoc<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">XContentType</span><span class="token punctuation">.</span>JSON<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    restHighLevelClient<span class="token punctuation">.</span><span class="token function">bulk</span><span class="token punctuation">(</span>bulkRequest<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<p>总之，在 Java 代码中，client 针对操作索引库还是文档，基本都是一样的代码</p>
<p>restHighLevelClient.indices ().xxx，代表操作索引库</p>
<p><a target="_blank" rel="noopener" href="http://restHighLevelClient.xxx">restHighLevelClient.xxx</a>，代表操作文档</p>
<p>而其中所需要的参数，我们直接通过 <strong>ctrl+p</strong> 这样的快捷键去查看就可以，不需要单独记住。</p>
<h2 id="dsl文档查询"><a class="markdownIt-Anchor" href="#dsl文档查询">#</a> DSL 文档查询</h2>
<p>Elasticsearch 提供了基于 JSON 的 DSL (<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl.html">Domain Specific Language</a>) 来定义查询。常见的查询类型包括：</p>
<p><strong>查询所有</strong>：查询出所有数据，一般测试用。例如：match_all</p>
<p><strong>全文检索（full text）查询</strong>：利用分词器对用户输入内容分词，然后去倒排索引库中匹配。例如：</p>
<ul>
<li>match_query</li>
<li>multi_match_query</li>
</ul>
<p><strong>精确查询</strong>：根据精确词条值查找数据，一般是查找 keyword、数值、日期、boolean 等类型字段。例如：</p>
<ul>
<li>ids</li>
<li>range</li>
<li>term</li>
</ul>
<p><strong>地理（geo）查询</strong>：根据经纬度查询。例如：</p>
<ul>
<li>geo_distance</li>
<li>geo_bounding_box</li>
</ul>
<p><strong>复合（compound）查询</strong>：复合查询可以将上述各种查询条件组合起来，合并查询条件。例如：</p>
<ul>
<li>bool</li>
<li>function_score</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">&#x2F;&#x2F; 查询所有
GET &#x2F;indexName&#x2F;_search
&#123;
  &quot;query&quot;: &#123;
    &quot;match_all&quot;: &#123;
    &#125;
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="全文检索"><a class="markdownIt-Anchor" href="#全文检索">#</a> 全文检索</h3>
<p>使用场景：全文检索查询的基本流程如下：</p>
<ul>
<li>对用户搜索的内容做分词，得到词条</li>
<li>根据词条去倒排索引库中匹配，得到文档 id</li>
<li>根据文档 id 找到文档，返回给用户</li>
</ul>
<p>比较常用的场景包括：</p>
<ul>
<li>商城的输入框搜索</li>
<li>百度输入框搜索</li>
</ul>
<p>例如京东：</p>
<p>因为是拿着词条去匹配，因此参与搜索的字段也必须是可分词的 text 类型的字段。</p>
<p>常见的全文检索查询包括：</p>
<ul>
<li>match 查询：单字段查询</li>
<li>multi_match 查询：多字段查询，任意一个字段符合条件就算符合查询条件</li>
</ul>
<p>match 查询语法如下：</p>
<pre class="line-numbers language-none"><code class="language-none">GET &#x2F;indexName&#x2F;_search
&#123;
  &quot;query&quot;: &#123;
    &quot;match&quot;: &#123;
      &quot;FIELD&quot;: &quot;TEXT&quot;
    &#125;
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>mulit_match 查询语法如下：</p>
<pre class="line-numbers language-none"><code class="language-none">GET &#x2F;indexName&#x2F;_search
&#123;
  &quot;query&quot;: &#123;
    &quot;multi_match&quot;: &#123;
      &quot;query&quot;: &quot;TEXT&quot;,
      &quot;fields&quot;: [&quot;FIELD1&quot;, &quot; FIELD12&quot;]
    &#125;
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>因为我们将 brand、name、business 值都利用 <strong>copy_to</strong> 复制到了 <strong>all</strong> 字段中，你根据三个字段搜索，和根据 all 字段搜索效果是一样的。</p>
<pre class="line-numbers language-none"><code class="language-none">GET &#x2F;hotel&#x2F;_search
&#123;
  &quot;query&quot;: &#123;
    &quot;match&quot;: &#123;
      &quot;all&quot;: &quot;7天酒店&quot;
    &#125;
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-none"><code class="language-none">GET &#x2F;hotel&#x2F;_search
&#123;
  &quot;query&quot;: &#123;
    &quot;multi_match&quot;: &#123;
      &quot;query&quot;: &quot;7天酒店&quot;,
      &quot;fields&quot;: [&quot;brand&quot;,&quot;name&quot;]
    &#125;
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>搜索字段越多，对查询性能影响越大，因此建议采用 copy_to 将多个字段合并为一个，然后使用单字段查询的方式。</strong></p>
<h3 id="精准查询"><a class="markdownIt-Anchor" href="#精准查询">#</a> 精准查询</h3>
<p>精确查询一般是查找 keyword、数值、日期、boolean 等类型字段。所以<strong>不会</strong>对搜索条件分词。</p>
<ul>
<li>term：根据词条精确值查询</li>
<li>range：根据值的范围查询</li>
</ul>
<h4 id="term查询"><a class="markdownIt-Anchor" href="#term查询">#</a> term 查询</h4>
<p>因为精确查询的字段搜是不分词的字段，因此查询的条件也必须是<strong>不分词</strong>的词条。查询时，用户输入的内容跟自动值完全匹配时才认为符合条件。如果用户输入的内容过多，反而搜索不到数据。</p>
<p>语法说明：</p>
<pre class="line-numbers language-none"><code class="language-none">&#x2F;&#x2F; term查询
GET &#x2F;indexName&#x2F;_search
&#123;
  &quot;query&quot;: &#123;
    &quot;term&quot;: &#123;
      &quot;FIELD&quot;: &#123;
        &quot;value&quot;: &quot;VALUE&quot;
      &#125;
    &#125;
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>示例：</p>
<pre class="line-numbers language-none"><code class="language-none">GET &#x2F;hotel&#x2F;_search
&#123;
  &quot;query&quot;: &#123;
    &quot;term&quot;: &#123;
      &quot;brand&quot;: &#123;
        &quot;value&quot;: &quot;7天酒店&quot;
      &#125;
    &#125;
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="range查询"><a class="markdownIt-Anchor" href="#range查询">#</a> range 查询</h4>
<p>范围查询，一般应用在对数值类型做范围过滤的时候。比如做价格范围过滤。</p>
<p>基本语法：</p>
<pre class="line-numbers language-none"><code class="language-none">&#x2F;&#x2F; range查询
GET &#x2F;indexName&#x2F;_search
&#123;
  &quot;query&quot;: &#123;
    &quot;range&quot;: &#123;
      &quot;FIELD&quot;: &#123;
        &quot;gte&quot;: 10, &#x2F;&#x2F; 这里的gte代表大于等于，gt则代表大于
        &quot;lte&quot;: 20 &#x2F;&#x2F; lte代表小于等于，lt则代表小于
      &#125;
    &#125;
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>示例：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210921182858.png" alt=""></p>
<p>精确查询常见的有哪些？</p>
<ul>
<li>term 查询：根据词条精确匹配，一般搜索 keyword 类型、数值类型、布尔类型、日期类型字段</li>
<li>range 查询：根据数值范围查询，可以是数值、日期的范围</li>
</ul>
<h3 id="地理坐标查询"><a class="markdownIt-Anchor" href="#地理坐标查询">#</a> 地理坐标查询</h3>
<p>地理坐标查询，其实就是根据经纬度查询，官方文档：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/geo-queries.html">https://www.elastic.co/guide/en/elasticsearch/reference/current/geo-queries.html</a></p>
<p>常见的使用场景包括：</p>
<ul>
<li>携程：搜索我附近的酒店</li>
<li>滴滴：搜索我附近的出租车</li>
<li>微信：搜索我附近的人</li>
</ul>
<p>附近的酒店：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210921183030.png" alt=""></p>
<p>附近的车：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210921183033.png" alt=""></p>
<blockquote>
<p>矩形范围查询</p>
</blockquote>
<p>矩形范围查询，也就是  <code>geo_bounding_box</code>  查询，查询坐标落在某个矩形范围的所有文档</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210921183124.gif" alt=""></p>
<p>查询时，需要指定矩形的<strong>左上</strong>、<strong>右下</strong>两个点的坐标，然后画出一个矩形，落在该矩形内的都是符合条件的点。</p>
<pre class="line-numbers language-none"><code class="language-none">&#x2F;&#x2F; geo_bounding_box查询
GET &#x2F;indexName&#x2F;_search
&#123;
  &quot;query&quot;: &#123;
    &quot;geo_bounding_box&quot;: &#123;
      &quot;FIELD&quot;: &#123;
        &quot;top_left&quot;: &#123; &#x2F;&#x2F; 左上点
          &quot;lat&quot;: 31.1,
          &quot;lon&quot;: 121.5
        &#125;,
        &quot;bottom_right&quot;: &#123; &#x2F;&#x2F; 右下点
          &quot;lat&quot;: 30.9,
          &quot;lon&quot;: 121.7
        &#125;
      &#125;
    &#125;
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>附近查询</p>
</blockquote>
<p>附近查询，也叫做距离查询（geo_distance）：查询到指定中心点小于某个距离值的所有文档</p>
<p>在地图上找一个点作为圆心，以指定距离为半径，画一个圆，落在圆内的坐标都算符合条件：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210921183215.gif" alt=""></p>
<pre class="line-numbers language-none"><code class="language-none">&#x2F;&#x2F; geo_distance 查询
GET &#x2F;indexName&#x2F;_search
&#123;
  &quot;query&quot;: &#123;
    &quot;geo_distance&quot;: &#123;
      &quot;distance&quot;: &quot;15km&quot;, &#x2F;&#x2F; 半径
      &quot;FIELD&quot;: &quot;31.21,121.5&quot; &#x2F;&#x2F; 圆心
    &#125;
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们先搜索陆家嘴附近 15km 的酒店</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210921183228.png" alt=""></p>
<p>发现共有 47 家酒店，然后把半径缩短到 3 公里</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210921183240.png" alt=""></p>
<p>可以发现，搜索到的酒店数量减少到了 5 家。</p>
<pre class="line-numbers language-none"><code class="language-none">GET &#x2F;hotel&#x2F;_search
&#123;
  &quot;query&quot;: &#123;
    &quot;match_all&quot;: &#123;&#125;
  &#125;,
  &quot;sort&quot;: [
    &#123;
      &quot;_geo_distance&quot; : &#123;
          &quot;location&quot;: &quot;31.034661,121.612282&quot;, &#x2F;&#x2F;圆心
          &quot;order&quot; : &quot;asc&quot;, &#x2F;&#x2F;排序
          &quot;unit&quot; : &quot;km&quot; &#x2F;&#x2F;单位
      &#125;
    &#125;
  ]
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>结果为：</p>
<pre class="line-numbers language-none"><code class="language-none">&quot;hits&quot; : [
    &#123;
        &quot;_index&quot; : &quot;hotel&quot;,
        &quot;_type&quot; : &quot;_doc&quot;,
        &quot;_id&quot; : &quot;2056298828&quot;,
        &quot;_score&quot; : null,
        &quot;_source&quot; : &#123;
            ...
        &#125;,
        &quot;sort&quot; : [
            4.8541199685347785 &#x2F;&#x2F;这里的结果为离圆心的距离
        ]
    &#125;,<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意：输出结果中的 <strong>sort</strong> 为距离，比较常用。</p>
<p>排序完成后，页面还要获取我附近每个酒店的具体<strong>距离</strong>值，这个值在响应结果中是独立的：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20211019011334.png" alt=""></p>
<h3 id="复合查询"><a class="markdownIt-Anchor" href="#复合查询">#</a> 复合查询</h3>
<p>复合（compound）查询：复合查询可以将其它简单查询组合起来，实现更复杂的搜索逻辑。</p>
<ul>
<li>fuction score：算分函数查询，可以控制文档相关性算分，控制文档排名</li>
<li>bool query：布尔查询，利用逻辑关系组合多个其它的查询，实现复杂搜索</li>
</ul>
<h3 id="相关性算分"><a class="markdownIt-Anchor" href="#相关性算分">#</a> 相关性算分</h3>
<blockquote>
<p>这部分内容作为了解即可。</p>
</blockquote>
<p>当我们利用 match 查询时，文档结果会根据与搜索词条的关联度打分（_score），返回结果时按照分值降序排列。例如，我们搜索 “虹桥如家”，结果如下：</p>
<pre class="line-numbers language-none"><code class="language-none">[
  &#123;
    &quot;_score&quot; : 17.850193,
    &quot;_source&quot; : &#123;
      &quot;name&quot; : &quot;虹桥如家酒店真不错&quot;,
    &#125;
  &#125;,
  &#123;
    &quot;_score&quot; : 12.259849,
    &quot;_source&quot; : &#123;
      &quot;name&quot; : &quot;外滩如家酒店真不错&quot;,
    &#125;
  &#125;,
  &#123;
    &quot;_score&quot; : 11.91091,
    &quot;_source&quot; : &#123;
      &quot;name&quot; : &quot;迪士尼如家酒店真不错&quot;,
    &#125;
  &#125;
]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>elasticsearch 早期使用的打分算法是 <strong>TF-IDF 算法</strong>，公式如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210921205752.png" alt=""></p>
<p>在后来的 5.1 版本升级中，elasticsearch 将算法改进为 <strong>BM25 算法</strong>，公式如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210921205757.png" alt=""></p>
<p>TF-IDF 算法有一各缺陷，就是词条频率越高，文档得分也会越高，单个词条对文档影响较大。而 BM25 则会让单个词条的算分有一个上限，曲线更加平滑：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210921205831.png" alt=""></p>
<h3 id="算分函数查询"><a class="markdownIt-Anchor" href="#算分函数查询">#</a> 算分函数查询</h3>
<p>根据相关度打分是比较合理的需求，但有时候也不能够满足我们的需求。</p>
<p>以百度为例，你搜索的结果中，并不是相关度越高排名越靠前，而是谁给的钱多排名就越靠前。</p>
<p><strong>要想认为控制相关性算分，就需要利用 elasticsearch 中的 function score 查询了。</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210921210256.png" alt=""></p>
<p>function score 查询中包含四部分内容：</p>
<ul>
<li>
<p><strong>原始查询</strong>条件：query 部分，基于这个条件搜索文档，并且基于 BM25 算法给文档打分，<strong>原始算分</strong>（query score)</p>
</li>
<li>
<p><strong>过滤条件</strong>：filter 部分，符合该条件的文档才会<strong>重新算分</strong></p>
</li>
<li>
<p><strong>算分函数</strong>：符合 filter 条件的文档要根据这个函数做运算，得到的<strong>函数算分</strong>（function score），有四种函数</p>
<ul>
<li>weight：函数结果是常量</li>
<li>field_value_factor：以文档中的某个字段值作为函数结果</li>
<li>random_score：以随机数作为函数结果</li>
<li>script_score：自定义算分函数算法</li>
</ul>
</li>
<li>
<p><strong>运算模式</strong>：算分函数的结果、原始查询的相关性算分，两者之间的运算方式，包括：</p>
<ul>
<li>multiply：相乘</li>
<li>replace：用 function score 替换 query score</li>
<li>sum、avg、max、min</li>
</ul>
</li>
</ul>
<p>function score 的运行流程如下：</p>
<ol>
<li>根据<strong>原始条件</strong>查询搜索文档，并且计算相关性算分，称为<strong>原始算分</strong>（query score）</li>
<li>根据<strong>过滤条件</strong>，过滤文档</li>
<li>符合<strong>过滤条件</strong>的文档，基于<strong>算分函数</strong>运算，得到<strong>函数算分</strong>（function score）</li>
<li>将<strong>原始算分</strong>（query score）和<strong>函数算分</strong>（function score）基于<strong>运算模式</strong>做运算，得到最终结果，作为相关性算分。</li>
</ol>
<p>因此，其中的关键点是</p>
<ul>
<li>过滤条件：决定哪些文档的算分被修改</li>
<li>算分函数：决定函数算分的算法</li>
<li>运算模式：决定最终算分结果</li>
</ul>
<p>例如：我们给 “如家” 这个品牌的酒店排名靠前一些</p>
<pre class="line-numbers language-none"><code class="language-none">GET &#x2F;hotel&#x2F;_search
&#123;
  &quot;query&quot;: &#123;
    &quot;function_score&quot;: &#123;
      &quot;query&quot;: &#123;  .... &#125;, &#x2F;&#x2F; 原始查询，可以是任意条件
      &quot;functions&quot;: [ &#x2F;&#x2F; 算分函数
        &#123;
          &quot;filter&quot;: &#123; &#x2F;&#x2F; 满足的条件，品牌必须是如家
            &quot;term&quot;: &#123;
              &quot;brand&quot;: &quot;如家&quot;
            &#125;
          &#125;,
          &quot;weight&quot;: 10 &#x2F;&#x2F; 算分权重为10
        &#125;
      ],
      &quot;boost_mode&quot;: &quot;sum&quot; &#x2F;&#x2F; 加权模式，求和
    &#125;
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>测试，在未添加算分函数时，如家得分如下</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210921231508.png" alt=""></p>
<p>添加了算分函数后，如家得分就提升了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210921231513.png" alt=""></p>
<p>布尔查询是一个或多个查询子句的组合，每一个子句就是一个<strong>子查询</strong>。子查询的组合方式有</p>
<ul>
<li>must：必须匹配每个子查询，类似 “与”</li>
<li>should：选择性匹配子查询，类似 “或”</li>
<li>must_not：必须不匹配，<strong>不参与算分</strong>，类似 “非”</li>
<li>filter：必须匹配，<strong>不参与算分</strong></li>
</ul>
<p>比如在搜索酒店时，除了关键字搜索外，我们还可能根据品牌、价格、城市等字段做过滤</p>
<p><strong>每一个不同的字段，其查询的条件、方式都不一样，必须是多个不同的查询，而要组合这些查询，就必须用 bool 查询了。</strong></p>
<p>需要注意的是，搜索时，参与<strong>打分的字段越多，查询的性能也越差</strong>。因此这种多条件查询时，建议这样做：</p>
<ul>
<li>搜索框的关键字搜索，是全文检索查询，使用 must 查询，参与算分</li>
<li>其它过滤条件，采用 filter 查询，不参与算分</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">GET &#x2F;hotel&#x2F;_search
&#123;
  &quot;query&quot;: &#123;
    &quot;bool&quot;: &#123;
      &quot;must&quot;: [
        &#123;&quot;term&quot;: &#123;&quot;city&quot;: &quot;上海&quot; &#125;&#125;
      ],
      &quot;should&quot;: [
        &#123;&quot;term&quot;: &#123;&quot;brand&quot;: &quot;皇冠假日&quot; &#125;&#125;,
        &#123;&quot;term&quot;: &#123;&quot;brand&quot;: &quot;华美达&quot; &#125;&#125;
      ],
      &quot;must_not&quot;: [
        &#123; &quot;range&quot;: &#123; &quot;price&quot;: &#123; &quot;lte&quot;: 500 &#125; &#125;&#125;
      ],
      &quot;filter&quot;: [
        &#123; &quot;range&quot;: &#123;&quot;score&quot;: &#123; &quot;gte&quot;: 45 &#125; &#125;&#125;
      ]
    &#125;
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>需求：搜索名字包含 “如家”，价格不高于 400，在坐标 31.21,121.5 周围 10km 范围内的酒店。</p>
<ul>
<li>名称搜索，属于全文检索查询，应该参与算分，放到 must 中</li>
<li>价格不高于 400，用 range 查询，属于过滤条件，不参与算分，放到 must_not 中</li>
<li>周围 10km 范围内，用 geo_distance 查询，属于过滤条件，不参与算分，放到 filter 中</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210921233252.png" alt=""></p>
<p>bool 查询的几种逻辑关系</p>
<ul>
<li>must：必须匹配的条件，可以理解为 “与”</li>
<li>should：选择性匹配的条件，可以理解为 “或”</li>
<li>must_not：必须不匹配的条件，不参与打分</li>
<li>filter：必须匹配的条件，不参与打分</li>
</ul>
<h2 id="搜索结果处理"><a class="markdownIt-Anchor" href="#搜索结果处理">#</a> 搜索结果处理</h2>
<h3 id="排序"><a class="markdownIt-Anchor" href="#排序">#</a> 排序</h3>
<p>elasticsearch 默认是根据相关度算分（_score）来排序，但是也支持自定义方式对搜索<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/sort-search-results.html">结果排序</a>。可以排序字段类型有：keyword 类型、数值类型、地理坐标类型、日期类型等</p>
<p>keyword、数值、日期类型排序的语法基本一致。</p>
<pre class="line-numbers language-none"><code class="language-none">GET &#x2F;indexName&#x2F;_search
&#123;
  &quot;query&quot;: &#123;
    &quot;match_all&quot;: &#123;&#125;
  &#125;,
  &quot;sort&quot;: [
    &#123;
      &quot;FIELD&quot;: &quot;desc&quot;  &#x2F;&#x2F; 排序字段、排序方式ASC、DESC
    &#125;
  ]
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>排序条件是一个数组，也就是可以写多个排序条件。按照声明的顺序，当第一个条件相等时，再按照第二个条件排序。</p>
<p>需求描述：酒店数据按照用户评价（score) 降序排序，评价相同的按照价格 (price) 升序排序</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210921233829.png" alt=""></p>
<p>地理坐标排序略有不同</p>
<pre class="line-numbers language-none"><code class="language-none">GET &#x2F;indexName&#x2F;_search
&#123;
  &quot;query&quot;: &#123;
    &quot;match_all&quot;: &#123;&#125;
  &#125;,
  &quot;sort&quot;: [
    &#123;
      &quot;_geo_distance&quot; : &#123;
          &quot;FIELD&quot; : &quot;纬度，经度&quot;, &#x2F;&#x2F; 文档中geo_point类型的字段名、目标坐标点
          &quot;order&quot; : &quot;asc&quot;, &#x2F;&#x2F; 排序方式
          &quot;unit&quot; : &quot;km&quot; &#x2F;&#x2F; 排序的距离单位
      &#125;
    &#125;
  ]
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-none"><code class="language-none">GET &#x2F;hotel&#x2F;_search
&#123;
  &quot;query&quot;: &#123;
    &quot;match_all&quot;: &#123;&#125;
  &#125;,
  &quot;sort&quot;: [
    &#123;
      &quot;_geo_distance&quot; : &#123;
          &quot;location&quot;: &quot;31.034661,121.612282&quot;, 
          &quot;order&quot; : &quot;asc&quot;, 
          &quot;unit&quot; : &quot;km&quot; 
      &#125;
    &#125;
  ]
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>获取你的位置的经纬度的方式：<a target="_blank" rel="noopener" href="https://lbs.amap.com/demo/jsapi-v2/example/map/click-to-get-lnglat">https://lbs.amap.com/demo/jsapi-v2/example/map/click-to-get-lnglat</a></p>
</blockquote>
<p>假设我的位置是：31.034661，121.612282，寻找我周围距离最近的酒店。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210921233931.png" alt=""></p>
<h3 id="分页"><a class="markdownIt-Anchor" href="#分页">#</a> 分页</h3>
<p>elasticsearch 默认情况下只返回 top10 的数据。而如果要查询更多数据就需要修改分页参数了。</p>
<p>elasticsearch 通过修改 from、size 参数来控制要返回的分页结果：</p>
<ul>
<li>from：从第几个文档开始</li>
<li>size：总共查询几个文档</li>
</ul>
<p>类似于 mysql 中的 <code>limit ?, ?</code></p>
<pre class="line-numbers language-none"><code class="language-none">GET &#x2F;hotel&#x2F;_search
&#123;
  &quot;query&quot;: &#123;
    &quot;match_all&quot;: &#123;&#125;
  &#125;,
  &quot;from&quot;: 0, &#x2F;&#x2F; 分页开始的位置，默认为0
  &quot;size&quot;: 10, &#x2F;&#x2F; 期望获取的文档总数
  &quot;sort&quot;: [
    &#123;&quot;price&quot;: &quot;asc&quot;&#125;
  ]
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>深度分页问题</p>
</blockquote>
<p>现在，我要查询 990~1000 的数据，查询逻辑要这么写</p>
<pre class="line-numbers language-none"><code class="language-none">GET &#x2F;hotel&#x2F;_search
&#123;
  &quot;query&quot;: &#123;
    &quot;match_all&quot;: &#123;&#125;
  &#125;,
  &quot;from&quot;: 990, &#x2F;&#x2F; 分页开始的位置，默认为0
  &quot;size&quot;: 10, &#x2F;&#x2F; 期望获取的文档总数
  &quot;sort&quot;: [
    &#123;&quot;price&quot;: &quot;asc&quot;&#125;
  ]
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里是查询 990 开始的数据，也就是 第 990~ 第 1000 条 数据。</p>
<p>注意：elasticsearch 内部分页时，必须先查询 0~1000 条，然后截取其中的 990 ~ 1000 的这 10 条</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210921234503.png" alt=""></p>
<p>查询 TOP1000，如果 es 是单点模式，这并无太大影响。</p>
<p>但是 elasticsearch 将来一定是集群，例如我集群有 5 个节点，我要查询 TOP1000 的数据，并不是每个节点查询 200 条就可以了。节点 A 的 TOP200，在另一个节点可能排到 10000 名以外了。</p>
<p><strong>因此要想获取整个集群的 TOP1000，必须先查询出每个节点的 TOP1000，汇总结果后，重新排名，重新截取 TOP1000。</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210921234555.png" alt=""></p>
<p><strong>当查询分页深度较大时，汇总数据过多，对内存和 CPU 会产生非常大的压力，因此 elasticsearch 会禁止 from+ size 超过 10000 的请求。</strong></p>
<p>针对深度分页，ES 提供了两种解决方案，<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/paginate-search-results.html">官方文档</a>：</p>
<ul>
<li>search after：分页时需要排序，原理是从上一次的排序值开始，查询下一页数据。官方推荐使用的方式。</li>
<li>scroll：原理将排序后的文档 id 形成快照，保存在内存。官方已经不推荐使用。</li>
</ul>
<p>分页查询的常见实现方案以及优缺点</p>
<ul>
<li>
<p><code>from + size</code></p>
<ul>
<li>优点：支持随机翻页</li>
<li>缺点：深度分页问题，默认查询上限（from + size）是 10000</li>
<li>场景：百度、京东、谷歌、淘宝这样的随机翻页搜索</li>
</ul>
</li>
<li>
<p><code>after search</code></p>
<ul>
<li>优点：没有查询上限（单次查询的 size 不超过 10000）</li>
<li>缺点：只能向后逐页查询，不支持随机翻页</li>
<li>场景：没有随机翻页需求的搜索，例如手机向下滚动翻页</li>
</ul>
</li>
<li>
<p><code>scroll</code></p>
<ul>
<li>优点：没有查询上限（单次查询的 size 不超过 10000）</li>
<li>缺点：会有额外内存消耗，并且搜索结果是非实时的</li>
<li>场景：海量数据的获取和迁移。从 ES7.1 开始不推荐，建议用 after search 方案。</li>
</ul>
</li>
</ul>
<h3 id="高亮"><a class="markdownIt-Anchor" href="#高亮">#</a> 高亮</h3>
<p>我们在百度，京东搜索时，关键字会变成红色，比较醒目，这叫高亮显示：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210921234711.png" alt=""></p>
<p>高亮显示的实现分为两步：</p>
<ul>
<li>1）给文档中的所有关键字都添加一个标签，例如 <code>&lt;em&gt;</code>  标签</li>
<li>2）页面给 <code>&lt;em&gt;</code>  标签编写 CSS 样式</li>
</ul>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">GET /hotel/_search
<span class="token punctuation">&#123;</span>
  <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"match"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"FIELD"</span><span class="token operator">:</span> <span class="token string">"TEXT"</span> <span class="token comment">// 查询条件，高亮一定要使用全文检索查询</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token property">"highlight"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"fields"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 指定要高亮的字段</span>
      <span class="token property">"FIELD"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"pre_tags"</span><span class="token operator">:</span> <span class="token string">"&lt;em>"</span><span class="token punctuation">,</span>  <span class="token comment">// 用来标记高亮字段的前置标签</span>
        <span class="token property">"post_tags"</span><span class="token operator">:</span> <span class="token string">"&lt;/em>"</span> <span class="token comment">// 用来标记高亮字段的后置标签</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>注意：</strong></p>
<ul>
<li>高亮是对关键字高亮，因此<strong>搜索条件必须带有关键字</strong>，而不能是范围这样的查询。</li>
<li>默认情况下，<strong>高亮的字段，必须与搜索指定的字段一致</strong>，否则无法高亮</li>
<li>如果要对非搜索字段高亮，则需要添加一个属性： <code>required_field_match=false</code></li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210921234739.png" alt=""></p>
<blockquote>
<p>DSL 总体结构如下：</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20210921235330.png" alt=""></p>
<h2 id="restclient文档查询"><a class="markdownIt-Anchor" href="#restclient文档查询">#</a> RestClient 文档查询</h2>
<h3 id="发起查询请求"><a class="markdownIt-Anchor" href="#发起查询请求">#</a> 发起查询请求</h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20211016170057.png" alt=""></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * @author 乐心湖
 * @version 1.0
 * @date 2021/10/16 17:05
 */</span>
<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HotelSearchTest</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token class-name">RestHighLevelClient</span> restHighLevelClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">IHotelService</span> hotelService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">match_All</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchAllQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SearchResponse</span> response <span class="token operator">=</span> restHighLevelClient<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@BeforeEach</span>
    <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>restHighLevelClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RestHighLevelClient</span><span class="token punctuation">(</span><span class="token class-name">RestClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>
                <span class="token class-name">HttpHost</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"http://192.168.211.128:9200"</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@AfterEach</span>
    <span class="token keyword">void</span> <span class="token function">down</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>restHighLevelClient<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>
<p>第一步，创建 <code>SearchRequest</code>  对象，指定索引库名</p>
</li>
<li>
<p>第二步，利用 <code>request.source()</code>  构建 DSL，DSL 中可以包含查询、分页、排序、高亮等</p>
<ul>
<li><code>query()</code> ：代表查询条件，利用  <code>QueryBuilders.matchAllQuery()</code>  构建一个 match_all 查询的 DSL</li>
</ul>
</li>
<li>
<p>第三步，利用  <code>client.search()</code>  发送请求，得到响应</p>
</li>
</ul>
<p>关键的 API 有两个，一个是  <code>request.source()</code> ，其中包含了查询、排序、分页、高亮等所有功能</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20211016170203.png" alt=""></p>
<p>另一个是  <code>QueryBuilders</code> ，其中包含 match、term、function_score、bool 等各种查询</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20211016170234.png" alt=""></p>
<h3 id="解析查询响应"><a class="markdownIt-Anchor" href="#解析查询响应">#</a> 解析查询响应</h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20211016174631.png" alt=""></p>
<p>Elasticsearch 返回的结果是一个 JSON 字符串，结构包含</p>
<ul>
<li>
<p><code>hits</code> ：命中的结果</p>
<ul>
<li>
<p><code>total</code> ：总条数，其中的 value 是具体的总条数值</p>
</li>
<li>
<p><code>max_score</code> ：所有结果中得分最高的文档的相关性算分</p>
</li>
<li>
<p><code>hits</code> ：搜索结果的文档数组，其中的每个文档都是一个 json 对象</p>
<ul>
<li><code>_source</code> ：文档中的原始数据，也是 json 对象</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>因此，我们解析响应结果，就是逐层解析 JSON 字符串，流程如下</p>
<ul>
<li>
<p><code>SearchHits</code> ：通过  <code>response.getHits()</code>  获取，就是 json 中的最外层的 hits，代表命中的结果</p>
<ul>
<li>
<p><code>SearchHits.getTotalHits().value</code> ：获取总条数信息</p>
</li>
<li>
<p><code>SearchHits.getHits()</code> ：获取 SearchHit 数组，也就是文档数组</p>
<ul>
<li><code>SearchHit.getSourceAsString()</code> ：获取文档结果中的  <code>_source</code> ，也就是原始的 json 文档数据</li>
</ul>
</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * @author 乐心湖
 * @version 1.0
 * @date 2021/10/16 17:05
 */</span>
<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HotelSearchTest</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token class-name">RestHighLevelClient</span> restHighLevelClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">IHotelService</span> hotelService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">match_All</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchAllQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SearchResponse</span> response <span class="token operator">=</span> restHighLevelClient<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SearchHits</span> searchHits <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"hits.getTotalHits().条数 = "</span> <span class="token operator">+</span> searchHits<span class="token punctuation">.</span><span class="token function">getTotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SearchHit</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hits <span class="token operator">=</span> searchHits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> hits<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">String</span> sourceAsString <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">HotelDoc</span> hotelDoc <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>sourceAsString<span class="token punctuation">,</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hotelDoc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@BeforeEach</span>
    <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>restHighLevelClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RestHighLevelClient</span><span class="token punctuation">(</span><span class="token class-name">RestClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>
                <span class="token class-name">HttpHost</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"http://192.168.211.128:9200"</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@AfterEach</span>
    <span class="token keyword">void</span> <span class="token function">down</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>restHighLevelClient<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="match查询"><a class="markdownIt-Anchor" href="#match查询">#</a> match 查询</h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20211016182859.png" alt=""></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">matchQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchQuery</span><span class="token punctuation">(</span><span class="token string">"all"</span><span class="token punctuation">,</span><span class="token string">"如家"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SearchResponse</span> response <span class="token operator">=</span> restHighLevelClient<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SearchHits</span> searchHits <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"hits.getTotalHits().条数 = "</span> <span class="token operator">+</span> searchHits<span class="token punctuation">.</span><span class="token function">getTotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SearchHit</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hits <span class="token operator">=</span> searchHits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> hits<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> sourceAsString <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HotelDoc</span> hotelDoc <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>sourceAsString<span class="token punctuation">,</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hotelDoc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">multiMatchQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">multiMatchQuery</span><span class="token punctuation">(</span><span class="token string">"如家"</span><span class="token punctuation">,</span><span class="token string">"name"</span><span class="token punctuation">,</span><span class="token string">"brand"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SearchResponse</span> response <span class="token operator">=</span> restHighLevelClient<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SearchHits</span> searchHits <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"hits.getTotalHits().条数 = "</span> <span class="token operator">+</span> searchHits<span class="token punctuation">.</span><span class="token function">getTotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SearchHit</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hits <span class="token operator">=</span> searchHits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> hits<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> sourceAsString <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HotelDoc</span> hotelDoc <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>sourceAsString<span class="token punctuation">,</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hotelDoc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="精确查询"><a class="markdownIt-Anchor" href="#精确查询">#</a> 精确查询</h3>
<p>精确查询主要是两者</p>
<ul>
<li>term：词条精确匹配</li>
<li>range：范围查询</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20211016192658.png" alt=""></p>
<h3 id="布尔查询"><a class="markdownIt-Anchor" href="#布尔查询">#</a> 布尔查询</h3>
<p>布尔查询是用 must、must_not、filter 等方式组合其它查询，代码示例如下</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20211016192745.png" alt=""></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testBool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 1.准备Request</span>
    <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.准备DSL</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>
                    <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">boolQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">"city"</span><span class="token punctuation">,</span> <span class="token string">"上海"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">rangeQuery</span><span class="token punctuation">(</span><span class="token string">"price"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lte</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3.发送请求</span>
    <span class="token class-name">SearchResponse</span> response <span class="token operator">=</span> restHighLevelClient<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4.解析响应</span>
    <span class="token class-name">SearchHits</span> searchHits <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"hits.getTotalHits().条数 = "</span> <span class="token operator">+</span> searchHits<span class="token punctuation">.</span><span class="token function">getTotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SearchHit</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hits <span class="token operator">=</span> searchHits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> hits<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> sourceAsString <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HotelDoc</span> hotelDoc <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>sourceAsString<span class="token punctuation">,</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hotelDoc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="排序-分页"><a class="markdownIt-Anchor" href="#排序-分页">#</a> 排序、分页</h3>
<p>搜索结果的排序和分页是与 query 同级的参数，因此同样是使用  <code>request.source()</code>  来设置。</p>
<p>对应的 API 如下</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20211016202447.png" alt=""></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testPageAndSort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 页码，每页大小</span>
    <span class="token keyword">int</span> page <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> size <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>

    <span class="token comment">// 1.准备Request</span>
    <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.准备DSL</span>
    <span class="token comment">// 2.1.query</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchAllQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.2.排序 sort</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token string">"price"</span><span class="token punctuation">,</span> <span class="token class-name">SortOrder</span><span class="token punctuation">.</span>ASC<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.3.分页 from、size</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token punctuation">(</span>page <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> size<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3.发送请求</span>
    <span class="token class-name">SearchResponse</span> response <span class="token operator">=</span> restHighLevelClient<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4.解析响应</span>
    <span class="token class-name">SearchHits</span> searchHits <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"hits.getTotalHits().条数 = "</span> <span class="token operator">+</span> searchHits<span class="token punctuation">.</span><span class="token function">getTotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SearchHit</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hits <span class="token operator">=</span> searchHits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> hits<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> sourceAsString <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HotelDoc</span> hotelDoc <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>sourceAsString<span class="token punctuation">,</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hotelDoc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="高亮-2"><a class="markdownIt-Anchor" href="#高亮-2">#</a> 高亮</h3>
<ul>
<li>查询的 DSL：其中除了查询条件，还需要添加高亮条件，同样是与 query 同级。</li>
<li>结果解析：结果除了要解析  <code>_source</code>  文档数据，还要解析高亮结果</li>
</ul>
<p><strong>高亮请求的构建 API</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20211016202707.png" alt=""></p>
<p>上述代码省略了查询条件部分，但是高亮查询必须使用全文检索查询，并且要有搜索关键字，将来才可以对关键字高亮.</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testHighlight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 1.准备Request</span>
    <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.准备DSL</span>
    <span class="token comment">// 2.1.query</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchQuery</span><span class="token punctuation">(</span><span class="token string">"all"</span><span class="token punctuation">,</span> <span class="token string">"如家"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.2.高亮</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">highlighter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HighlightBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">requireFieldMatch</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3.发送请求</span>
    <span class="token class-name">SearchResponse</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4.解析响应</span>
    <span class="token function">handleResponse</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//代码在下文</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>高亮结果解析</strong></p>
<p>高亮的结果与查询的文档结果默认是分离的，并不在一起。</p>
<p>因此解析高亮的代码需要额外处理：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20211016202853.png" alt=""></p>
<ul>
<li>第一步：从结果中获取 source。 <code>hit.getSourceAsString()</code> ，这部分是非高亮结果，json 字符串，需要反序列为 HotelDoc 对象</li>
<li>第二步：获取高亮结果。 <code>hit.getHighlightFields()</code> ，返回值是一个 Map，key 是高亮字段名称，值是 HighlightField 对象，代表高亮值</li>
<li>第三步：从 map 中根据高亮字段名称，获取高亮字段值对象 HighlightField</li>
<li>第四步：从 HighlightField 中获取 Fragments，并且转为字符串。<strong>这部分是真正的高亮字符串</strong></li>
<li>第五步：用高亮的结果替换 HotelDoc 中的非高亮结果</li>
</ul>
<p>完整代码如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleResponse</span><span class="token punctuation">(</span><span class="token class-name">SearchResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 4.解析响应</span>
    <span class="token class-name">SearchHits</span> searchHits <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4.1.获取总条数</span>
    <span class="token keyword">long</span> total <span class="token operator">=</span> searchHits<span class="token punctuation">.</span><span class="token function">getTotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"共搜索到"</span> <span class="token operator">+</span> total <span class="token operator">+</span> <span class="token string">"条数据"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4.2.文档数组</span>
    <span class="token class-name">SearchHit</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hits <span class="token operator">=</span> searchHits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4.3.遍历</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> hits<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 获取文档source</span>
        <span class="token class-name">String</span> json <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 反序列化</span>
        <span class="token class-name">HotelDoc</span> hotelDoc <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取高亮结果</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">HighlightField</span><span class="token punctuation">></span></span> highlightFields <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getHighlightFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>highlightFields<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 根据字段名获取高亮结果</span>
            <span class="token class-name">HighlightField</span> highlightField <span class="token operator">=</span> highlightFields<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>highlightField <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// 获取高亮值</span>
                <span class="token class-name">String</span> name <span class="token operator">=</span> highlightField<span class="token punctuation">.</span><span class="token function">getFragments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 覆盖非高亮结果</span>
                hotelDoc<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"hotelDoc = "</span> <span class="token operator">+</span> hotelDoc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="地理坐标查询-2"><a class="markdownIt-Anchor" href="#地理坐标查询-2">#</a> 地理坐标查询</h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20211019000540.png" alt=""></p>
<h3 id="相关性得分"><a class="markdownIt-Anchor" href="#相关性得分">#</a> 相关性得分</h3>
<p>function_score 查询结构如下</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20211019011433.png" alt=""></p>
<p>对应的 JavaAPI 如下</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20211019011439.png" alt=""></p>
<h2 id="dsl数据聚合"><a class="markdownIt-Anchor" href="#dsl数据聚合">#</a> DSL 数据聚合</h2>
<p>**<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html"> 聚合（</a><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html">aggregations</a><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html">）</a>** 可以让我们极其方便的实现对数据的统计、分析、运算。</p>
<ul>
<li>什么品牌的手机最受欢迎？</li>
<li>这些手机的平均价格、最高价格、最低价格？</li>
<li>这些手机每月的销售情况如何？</li>
</ul>
<p>在 Elasticsearch 实现这些统计功能比数据库的 sql 要方便的多，而且查询速度非常快，可以实现近实时搜索效果。</p>
<p>聚合常见的有三类</p>
<ul>
<li>
<p>** 桶（Bucket）** 聚合：用来对文档做分组</p>
<ul>
<li>TermAggregation：按照文档字段值分组，例如按照品牌值分组、按照国家分组</li>
<li>Date Histogram：按照日期阶梯分组，例如一周为一组，或者一月为一组</li>
</ul>
</li>
<li>
<p>** 度量（Metric）** 聚合：用以计算一些值，比如：最大值、最小值、平均值等</p>
<ul>
<li>Avg：求平均值</li>
<li>Max：求最大值</li>
<li>Min：求最小值</li>
<li>Stats：同时求 max、min、avg、sum 等</li>
</ul>
</li>
<li>
<p>** 管道（pipeline）** 聚合：其它聚合的结果为基础做聚合</p>
</li>
</ul>
<blockquote>
<p><strong>注意：</strong> 参加聚合的字段必须是 keyword、日期、数值、布尔类型</p>
</blockquote>
<h3 id="bucket聚合语法"><a class="markdownIt-Anchor" href="#bucket聚合语法">#</a> Bucket 聚合语法</h3>
<p>例如：我们要统计所有数据中的酒店品牌有几种，其实就是按照品牌对数据分组。此时可以根据酒店品牌的名称做聚合，也就是 Bucket 聚合。</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">GET /hotel/_search
<span class="token punctuation">&#123;</span>
  <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token comment">// 设置size为0，结果中不包含文档，只包含聚合结果</span>
  <span class="token property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 定义聚合</span>
    <span class="token property">"brandAgg"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token comment">//给聚合起个名字</span>
      <span class="token property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 聚合的类型，按照品牌值聚合，所以选择term</span>
        <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"brand"</span><span class="token punctuation">,</span> <span class="token comment">// 参与聚合的字段</span>
        <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">20</span> <span class="token comment">// 希望获取的聚合结果数量</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20211022184007.png" alt=""></p>
<p>默认情况下，Bucket 聚合会统计 Bucket 内的文档数量，记为  <code>_count</code> ，并且按照  <code>_count</code>  降序排序。</p>
<p>我们可以指定 order 属性，自定义聚合的排序方式</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">GET /hotel/_search
<span class="token punctuation">&#123;</span>
  <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> 
  <span class="token property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"brandAgg"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"brand"</span><span class="token punctuation">,</span>
        <span class="token property">"order"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          <span class="token property">"_count"</span><span class="token operator">:</span> <span class="token string">"asc"</span> <span class="token comment">// 按照_count升序排列</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">20</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>默认情况下，Bucket 聚合是对索引库的所有文档做聚合，但真实场景下，用户会输入搜索条件，因此聚合必须是对搜索结果聚合。那么聚合必须添加限定条件。</p>
<p>我们可以限定要聚合的文档范围，只要添加 query 条件即可；</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">GET /hotel/_search
<span class="token punctuation">&#123;</span>
  <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"range"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"price"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"lte"</span><span class="token operator">:</span> <span class="token number">200</span> <span class="token comment">// 只对200元以下的文档聚合</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> 
  <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> 
  <span class="token property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"brandAgg"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"brand"</span><span class="token punctuation">,</span>
        <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">20</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这次，聚合得到的品牌明显变少了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20211022184549.png" alt=""></p>
<h3 id="metric聚合语法"><a class="markdownIt-Anchor" href="#metric聚合语法">#</a> Metric 聚合语法</h3>
<p>上面，我们对酒店按照品牌分组，形成了一个个桶。现在我们需要对桶内的酒店做运算，获取每个品牌的用户评分的 min、max、avg 等值。</p>
<p>这就要用到 Metric 聚合了，例如 stats 聚合：就可以获取 min、max、avg 等结果</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">GET /hotel/_search
<span class="token punctuation">&#123;</span>
  <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> 
  <span class="token property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"brandAgg"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> 
      <span class="token property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> 
        <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"brand"</span><span class="token punctuation">,</span> 
        <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">20</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 是brands聚合的子聚合，也就是分组后对每组分别计算</span>
        <span class="token property">"score_stats"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 聚合名称</span>
          <span class="token property">"stats"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 聚合类型，这里stats可以计算min、max、avg等</span>
            <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"score"</span> <span class="token comment">// 聚合字段，这里是score</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这次的 score_stats 聚合是在 brandAgg 的聚合内部嵌套的子聚合。因为我们需要在每个桶分别计算。</p>
<p>另外，我们还可以给聚合结果做个排序，例如按照每个桶的酒店平均分做排序</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20211022184847.png" alt=""></p>
<h2 id="restapi数据聚合"><a class="markdownIt-Anchor" href="#restapi数据聚合">#</a> RestAPI 数据聚合</h2>
<p>聚合条件与 query 条件同级别，因此需要使用  <code>request.source()</code>  来指定聚合条件</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20211022190429.png" alt=""></p>
<p>聚合的结果也与查询结果不同，API 也比较特殊。不过同样是 JSON 逐层解析</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20211022190457.png" alt=""></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testAggregation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">aggregation</span><span class="token punctuation">(</span><span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">"brandAgg"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"brand"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SearchResponse</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Terms</span> brandAgg <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"brandAgg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Terms<span class="token punctuation">.</span>Bucket</span><span class="token punctuation">></span></span> buckets <span class="token operator">=</span> brandAgg<span class="token punctuation">.</span><span class="token function">getBuckets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Terms<span class="token punctuation">.</span>Bucket</span> bucket <span class="token operator">:</span> buckets<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">getKeyAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"key = "</span> <span class="token operator">+</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="自动补全"><a class="markdownIt-Anchor" href="#自动补全">#</a> 自动补全</h2>
<p>当用户在搜索框输入字符时，我们应该提示出与该字符有关的搜索项，提示完整词条的功能，就是自动补全了。</p>
<h3 id="拼音分词器"><a class="markdownIt-Anchor" href="#拼音分词器">#</a> 拼音分词器</h3>
<p>如果我们需要根据拼音字母来推断，因此要用到拼音分词功能。</p>
<p>要实现根据字母做补全，就必须对文档按照拼音分词。插件地址：<a target="_blank" rel="noopener" href="https://github.com/medcl/elasticsearch-analysis-pinyin">https://github.com/medcl/elasticsearch-analysis-pinyin</a></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20211023015636.png" alt=""></p>
<p>使用  <code>docker volume inspect es-plugins</code>  查看插件目录，将下载的文件解压上传，重启 Elasticsearch</p>
<p>测试用法如下：</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">POST /_analyze
<span class="token punctuation">&#123;</span>
  <span class="token property">"text"</span><span class="token operator">:</span> <span class="token string">"如家酒店还不错"</span><span class="token punctuation">,</span>
  <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"pinyin"</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>结果：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20211023021713.png" alt=""></p>
<h3 id="自定义分词器"><a class="markdownIt-Anchor" href="#自定义分词器">#</a> 自定义分词器</h3>
<p>默认的拼音分词器会将每个汉字单独分为拼音，而我们希望的是每个词条形成一组拼音，需要对拼音分词器做个性化定制，形成自定义分词器。</p>
<p>elasticsearch 中分词器（analyzer）的组成包含三部分：</p>
<ul>
<li>character filters：在 tokenizer 之前对文本进行处理。例如删除字符、替换字符</li>
<li>tokenizer：将文本按照一定的规则切割成词条（term）。例如 keyword，就是不分词；还有 ik_smart</li>
<li>tokenizer filter：将 tokenizer 输出的词条做进一步处理。例如大小写转换、同义词处理、拼音处理等</li>
</ul>
<p>文档分词时会依次由这三部分来处理文档：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20211023021451.png" alt=""></p>
<p>声明自定义分词器的语法如下：</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">PUT /test
<span class="token punctuation">&#123;</span>
  <span class="token property">"settings"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"analysis"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 自定义分词器</span>
        <span class="token property">"my_analyzer"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// 分词器名称</span>
          <span class="token property">"tokenizer"</span><span class="token operator">:</span> <span class="token string">"ik_max_word"</span><span class="token punctuation">,</span>
          <span class="token property">"filter"</span><span class="token operator">:</span> <span class="token string">"py"</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"filter"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 自定义tokenizer filter</span>
        <span class="token property">"py"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 过滤器名称</span>
          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"pinyin"</span><span class="token punctuation">,</span> <span class="token comment">// 过滤器类型，这里是pinyin</span>
          <span class="token property">"keep_full_pinyin"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          <span class="token property">"keep_joined_full_pinyin"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          <span class="token property">"keep_original"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          <span class="token property">"limit_first_letter_length"</span><span class="token operator">:</span> <span class="token number">16</span><span class="token punctuation">,</span>
          <span class="token property">"remove_duplicated_term"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          <span class="token property">"none_chinese_pinyin_tokenize"</span><span class="token operator">:</span> <span class="token boolean">false</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>
        <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"my_analyzer"</span><span class="token punctuation">,</span>
        <span class="token property">"search_analyzer"</span><span class="token operator">:</span> <span class="token string">"ik_smart"</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>测试</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20211023021532.png" alt=""></p>
<p>注意：<strong>为了避免搜索到同音字，搜索时不要使用拼音分词器</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20211023022355.png" alt=""></p>
<h3 id="自动补全查询"><a class="markdownIt-Anchor" href="#自动补全查询">#</a> 自动补全查询</h3>
<p>elasticsearch 提供了 <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.6/search-suggesters.html">Completion Suggester</a> 查询来实现自动补全功能。这个查询会匹配以用户输入内容开头的词条并返回；为了提高补全查询的效率，对于文档中字段的类型有一些约束</p>
<ul>
<li>参与补全查询的字段必须是 completion 类型。</li>
<li>字段的内容一般是用来补全的多个词条形成的数组。</li>
</ul>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token comment">// 创建索引库</span>
PUT test
<span class="token punctuation">&#123;</span>
  <span class="token property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"title"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"completion"</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后插入下面的数据</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token comment">// 示例数据</span>
POST test/_doc
<span class="token punctuation">&#123;</span>
  <span class="token property">"title"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"Sony"</span><span class="token punctuation">,</span> <span class="token string">"WH-1000XM3"</span><span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span>
POST test/_doc
<span class="token punctuation">&#123;</span>
  <span class="token property">"title"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"SK-II"</span><span class="token punctuation">,</span> <span class="token string">"PITERA"</span><span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span>
POST test/_doc
<span class="token punctuation">&#123;</span>
  <span class="token property">"title"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"Nintendo"</span><span class="token punctuation">,</span> <span class="token string">"switch"</span><span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>查询的 DSL 语句如下</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token comment">// 自动补全查询</span>
GET /test/_search
<span class="token punctuation">&#123;</span>
  <span class="token property">"suggest"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"title_suggest"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"text"</span><span class="token operator">:</span> <span class="token string">"s"</span><span class="token punctuation">,</span> <span class="token comment">// 关键字</span>
      <span class="token property">"completion"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"title"</span><span class="token punctuation">,</span> <span class="token comment">// 补全查询的字段</span>
        <span class="token property">"skip_duplicates"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 跳过重复的</span>
        <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">10</span> <span class="token comment">// 获取前10条结果</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>例如一个酒店的索引库完整案例</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token comment">// 酒店数据索引库</span>
PUT /hotel
<span class="token punctuation">&#123;</span>
  <span class="token property">"settings"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"analysis"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"text_anlyzer"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          <span class="token property">"tokenizer"</span><span class="token operator">:</span> <span class="token string">"ik_max_word"</span><span class="token punctuation">,</span>
          <span class="token property">"filter"</span><span class="token operator">:</span> <span class="token string">"py"</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token property">"completion_analyzer"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          <span class="token property">"tokenizer"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span>
          <span class="token property">"filter"</span><span class="token operator">:</span> <span class="token string">"py"</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"filter"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"py"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"pinyin"</span><span class="token punctuation">,</span>
          <span class="token property">"keep_full_pinyin"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          <span class="token property">"keep_joined_full_pinyin"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          <span class="token property">"keep_original"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          <span class="token property">"limit_first_letter_length"</span><span class="token operator">:</span> <span class="token number">16</span><span class="token punctuation">,</span>
          <span class="token property">"remove_duplicated_term"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          <span class="token property">"none_chinese_pinyin_tokenize"</span><span class="token operator">:</span> <span class="token boolean">false</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"id"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"name"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>
        <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"text_anlyzer"</span><span class="token punctuation">,</span>
        <span class="token property">"search_analyzer"</span><span class="token operator">:</span> <span class="token string">"ik_smart"</span><span class="token punctuation">,</span>
        <span class="token property">"copy_to"</span><span class="token operator">:</span> <span class="token string">"all"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"address"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span>
        <span class="token property">"index"</span><span class="token operator">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"price"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"integer"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"score"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"integer"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"brand"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span>
        <span class="token property">"copy_to"</span><span class="token operator">:</span> <span class="token string">"all"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"city"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"starName"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"business"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span>
        <span class="token property">"copy_to"</span><span class="token operator">:</span> <span class="token string">"all"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"location"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"geo_point"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"pic"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span>
        <span class="token property">"index"</span><span class="token operator">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"all"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>
        <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"text_anlyzer"</span><span class="token punctuation">,</span>
        <span class="token property">"search_analyzer"</span><span class="token operator">:</span> <span class="token string">"ik_smart"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"suggestion"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>
          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"completion"</span><span class="token punctuation">,</span>
          <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"completion_analyzer"</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="javaapi"><a class="markdownIt-Anchor" href="#javaapi">#</a> JavaAPI</h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20211025113007.png" alt=""></p>
<p>解析响应的代码如下</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20211025113011.png" alt=""></p>
<h2 id="数据同步"><a class="markdownIt-Anchor" href="#数据同步">#</a> 数据同步</h2>
<p>elasticsearch 中的数据来自于 mysq l 数据库，因此 mysql 数据发生改变时，elasticsearch 也必须跟着改变，这个就是 elasticsearch 与 mysql 之间的<strong>数据同步</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20211025163219.png" alt=""></p>
<p>常见的数据同步方案有三种</p>
<ul>
<li>同步调用</li>
<li>异步通知</li>
<li>监听 binlog</li>
</ul>
<h3 id="同步调用"><a class="markdownIt-Anchor" href="#同步调用">#</a> 同步调用</h3>
<p>方案一：同步调用</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20211025163313.png" alt=""></p>
<ul>
<li>hotel-demo 对外提供接口，用来修改 elasticsearch 中的数据</li>
<li>酒店管理服务在完成数据库操作后，直接调用 hotel-demo 提供的接口</li>
</ul>
<h3 id="异步通知"><a class="markdownIt-Anchor" href="#异步通知">#</a> 异步通知</h3>
<p>方案二：异步通知</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20211025163346.png" alt=""></p>
<ul>
<li>hotel-admin 对 mysql 数据库数据完成增、删、改后，发送 MQ 消息</li>
<li>hotel-demo 监听 MQ，接收到消息后完成 elasticsearch 数据修改</li>
</ul>
<h3 id="监听binlog"><a class="markdownIt-Anchor" href="#监听binlog">#</a> 监听 binlog</h3>
<p>方案三：监听 binlog</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20211025163428.png" alt=""></p>
<ul>
<li>mysql 开启 binlog 功能</li>
<li>mysql 完成增、删、改操作都会记录在 binlog 中</li>
<li>hotel-demo 基于 canal 监听 binlog 变化，实时更新 elasticsearch 中的内容</li>
</ul>
<h3 id="优缺点"><a class="markdownIt-Anchor" href="#优缺点">#</a> 优缺点</h3>
<p>方式一：同步调用</p>
<ul>
<li>优点：实现简单，粗暴</li>
<li>缺点：业务耦合度高</li>
</ul>
<p>方式二：异步通知</p>
<ul>
<li>优点：低耦合，实现难度一般</li>
<li>缺点：依赖 mq 的可靠性</li>
</ul>
<p>方式三：监听 binlog</p>
<ul>
<li>优点：完全解除服务间耦合</li>
<li>缺点：开启 binlog 增加数据库负担、实现复杂度高</li>
</ul>
<h3 id="实现方式"><a class="markdownIt-Anchor" href="#实现方式">#</a> 实现方式</h3>
<p>我们以<strong>异步通知</strong>为例，使用 MQ 消息中间件</p>
<p>MQ 结构如图：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.xn2001.com/img/2021/20211025163734.png" alt=""></p>
<p><strong>引入依赖</strong>，在 hotel-admin、hotel-demo 中引入 rabbitmq 的依赖：</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token comment">&lt;!--amqp--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>声明队列交换机</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MQConstants</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">/**
     * 交换机
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> HOTEL_EXCHANGE <span class="token operator">=</span> <span class="token string">"hotel.topic"</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 监听新增和修改的队列
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> HOTEL_INSERT_QUEUE <span class="token operator">=</span> <span class="token string">"hotel.insert.queue"</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 监听删除的队列
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> HOTEL_DELETE_QUEUE <span class="token operator">=</span> <span class="token string">"hotel.delete.queue"</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 新增或修改的RoutingKey
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> HOTEL_INSERT_KEY <span class="token operator">=</span> <span class="token string">"hotel.insert"</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 删除的RoutingKey
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> HOTEL_DELETE_KEY <span class="token operator">=</span> <span class="token string">"hotel.delete"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>消息接收方</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MqConfig</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">TopicExchange</span> <span class="token function">topicExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">TopicExchange</span><span class="token punctuation">(</span><span class="token class-name">MqConstants</span><span class="token punctuation">.</span>HOTEL_EXCHANGE<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">insertQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token class-name">MqConstants</span><span class="token punctuation">.</span>HOTEL_INSERT_QUEUE<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">deleteQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token class-name">MqConstants</span><span class="token punctuation">.</span>HOTEL_DELETE_QUEUE<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">insertQueueBinding</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token function">insertQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token function">topicExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token class-name">MqConstants</span><span class="token punctuation">.</span>HOTEL_INSERT_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">deleteQueueBinding</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token function">deleteQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token function">topicExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token class-name">MqConstants</span><span class="token punctuation">.</span>HOTEL_DELETE_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>消息发送方</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token class-name">MQConstants</span><span class="token punctuation">.</span>HOTEL_EXCHANGE<span class="token punctuation">,</span> <span class="token class-name">MQConstants</span><span class="token punctuation">.</span>HOTEL_INSERT_KEY<span class="token punctuation">,</span> hotel<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token class-name">MQConstants</span><span class="token punctuation">.</span>HOTEL_EXCHANGE<span class="token punctuation">,</span> <span class="token class-name">MQConstants</span><span class="token punctuation">.</span>HOTEL_DELETE_KEY<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>消息接收方</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">insertById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 根据id查询酒店数据</span>
        <span class="token class-name">Hotel</span> hotel <span class="token operator">=</span> <span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 转换为文档类型</span>
        <span class="token class-name">HotelDoc</span> hotelDoc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">(</span>hotel<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">IndexRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>hotel<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>hotelDoc<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">XContentType</span><span class="token punctuation">.</span>JSON<span class="token punctuation">)</span><span class="token punctuation">;</span>
        client<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">DeleteRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DeleteRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">,</span> id<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        client<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HotelListener</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">HotelService</span> hotelService<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 监听酒店新增或修改的业务
     *
     * @param id 酒店id
     */</span>
    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token class-name">MqConstants</span><span class="token punctuation">.</span>HOTEL_INSERT_QUEUE<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenHotelInsertOrUpdate</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        hotelService<span class="token punctuation">.</span><span class="token function">insertById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * 监听酒店删除的业务
     *
     * @param id 酒店id
     */</span>
    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token class-name">MqConstants</span><span class="token punctuation">.</span>HOTEL_DELETE_QUEUE<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenHotelDelete</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        hotelService<span class="token punctuation">.</span><span class="token function">deleteById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<h1 id="微服务保护sentinel"><a class="markdownIt-Anchor" href="#微服务保护sentinel">#</a> 微服务保护 Sentinel</h1>
<h2 id="雪崩问题和解决方案"><a class="markdownIt-Anchor" href="#雪崩问题和解决方案">#</a> 雪崩问题和解决方案</h2>
<h3 id="雪崩问题"><a class="markdownIt-Anchor" href="#雪崩问题">#</a> 雪崩问题:</h3>
<p>微服务调用链路中的某个服务故障，引起整个链路的所有微服务都不可用</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220219184814047.png" alt="image-20220219184814047"></p>
<blockquote>
<p>这里就是服务 A 需要调用服务 D 但是服务 D 因为某种原因故障了，那么服务 A 中依赖于服务 D 的业务会被阻塞住 (一直等待调用服务 D 的结果), 阻塞的话就不会释放 tomcat 连接，如果之后服务 A 多业务次请求服务 D 都一样都被阻塞住，直到服务 A 内部的所有连接都被占用住 -&gt;Tomcat 资源耗尽，此时如果有服务调用服务 A 这个请求是不会进来的，所以可以认为服务 A 也故障了，so on…</p>
<p>也就是一个服务的故障了导致了依赖这个服务的也出现故障，微服务关系很复杂，可能之后所有的都故障了 -&gt; 雪崩</p>
</blockquote>
<h3 id="解决方式4个"><a class="markdownIt-Anchor" href="#解决方式4个">#</a> 解决方式 (4 个)</h3>
<h4 id="1-超时处理"><a class="markdownIt-Anchor" href="#1-超时处理">#</a> 1. 超时处理</h4>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220219185352968.png" alt="image-20220219185352968"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220219185507629.png" alt="image-20220219185507629"></p>
<p>服务 A 请求服务 C, 如果等待了 1 秒还没接收到请求的结果，那么立即断掉这个连接</p>
<blockquote>
<p>这种方式只是缓解了雪崩问题，因为我们设置的等待时间比如说是 1 秒，那么如果进来的请求是每秒两个，释放速度没有进入的速度快，总有一天还是会服务 A 资源还是会被耗尽，只是缓解雪崩，并没有从根本上解决问题</p>
</blockquote>
<h4 id="2-舱壁模式"><a class="markdownIt-Anchor" href="#2-舱壁模式">#</a> 2. 舱壁模式</h4>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220219185725431.png" alt="image-20220219185725431"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220219190148130.png" alt="image-20220219190148130"></p>
<p>也就是我们给每一个服务 (每一个 Tomcat 装着的服务) 都按照业务划分线程池，给每一个业务分配一个线程__池__, 那么访问一个服务 A 的业务 1, 线程池只有 10 个线程，访问一个服务 A 的业务 2, 线程池只有 10 个线程.</p>
<p>因为业务 2 调用了服务 C, 服务 C 故障了，给服务 A 的业务 2 产生了阻塞，但是最用十个线程，我们服务 A 的业务 1 依旧可以调用服务 B. 避免整个 tomcat 资源耗尽，只是阻塞部分 tomcat 的线程</p>
<blockquote>
<p>确实解决了雪崩问题，但是资源上讲还是有些浪费，因为服务 C 已经挂了，每次请求服务 A 的业务 2 来访问服务 C 还是会请求，但是已经挂了，还占用了那 10 个线程，浪费</p>
</blockquote>
<h4 id="3-熔断降级"><a class="markdownIt-Anchor" href="#3-熔断降级">#</a> 3. 熔断降级</h4>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220219190336958.png" alt="image-20220219190336958"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220219190634360.png" alt="image-20220219190634360"></p>
<p>也就是服务 A 如果调用服务 D, 然后计算异常比例 (所有请求中有几次发生阻塞 (故障)), 如果达到了某个 (我们设置的) 值，暗恶魔就会直接熔断这个服务 D, 之后要是服务 A 想要请求服务 D, 会直接被拦截，请求直接失败，1 毫秒都不等，不占用资源 (因为压根不让访问服务 D 了)</p>
<blockquote>
<p>解决雪崩比较好的一个方案</p>
</blockquote>
<h4 id="4-流量控制"><a class="markdownIt-Anchor" href="#4-流量控制">#</a> 4. 流量控制</h4>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220219190741143.png" alt="image-20220219190741143"></p>
<p>这种方式就需要用到我们的 Sentinel 了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220219191046546.png" alt="image-20220219191046546"></p>
<p>如果有多个请求到我们的一个微服务，Sentinel 按照我们给这个微服务设置的 QPS (query per second) 这个频率来释放请求，我们这个微服务就可以在可以承受的频率处理请求避免发生故障，他不产生故障就不会把故障传递给依赖于这个服务的服务了，不会出现雪崩问题</p>
<blockquote>
<p>这种方式相当于避免出现故障 (预防雪崩问题)</p>
<p>当然这不完全解决雪崩问题，<strong> 因为高并发导致服务故障可能只是其中一个，还有各种其他方式可能会导致一个服务故障 (比如说网络问题等等等), 这里只是预防了高并发引发的服务故障</strong></p>
</blockquote>
<h3 id="总结"><a class="markdownIt-Anchor" href="#总结">#</a> 总结</h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220219191339137.png" alt="image-20220219191339137"></p>
<h2 id="服务保护技术对比"><a class="markdownIt-Anchor" href="#服务保护技术对比">#</a> 服务保护技术对比</h2>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220219191636786.png" alt="image-20220219191636786"></p>
<h2 id="sentinel介绍和安装"><a class="markdownIt-Anchor" href="#sentinel介绍和安装">#</a> Sentinel 介绍和安装</h2>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220219191835890.png" alt="image-20220219191835890"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220219191941019.png" alt="image-20220219191941019"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220219192121072.png" alt="image-20220219192121072"></p>
<h2 id="微服务整合sentinel"><a class="markdownIt-Anchor" href="#微服务整合sentinel">#</a> 微服务整合 Sentinel</h2>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220219192154403.png" alt="image-20220219192154403"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220219192405649.png" alt="image-20220219192405649"></p>
<p>端点 (endpoint)-&gt; 我们的 springmvc 中任意一个 controller 接口都是一个端点，所以只需要访问一下触发了 sentinel 监控就能看到监控信息</p>
<p>访问完成后，再看我们之前开启的 sentinel 后台管理页面:</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220219192702702.png" alt="image-20220219192702702"></p>
<h2 id="限流规则"><a class="markdownIt-Anchor" href="#限流规则">#</a> 限流规则</h2>
<h3 id="快速入门"><a class="markdownIt-Anchor" href="#快速入门">#</a> 快速入门</h3>
<h4 id="簇点链路"><a class="markdownIt-Anchor" href="#簇点链路">#</a> 簇点链路</h4>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220219193030316.png" alt="image-20220219193030316"></p>
<p>所以就是一般是监控我们写的 controller 层的那些方法 (controller 里面每一个方法都是被监控的资源), 如果我们的 service 和 mapper 也想被监控就需要 sentinel 提供的一些注解来实现</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220219193521418.png" alt="image-20220219193521418"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220219193536800.png" alt="image-20220219193536800"></p>
<blockquote>
<p>针对来源就是从哪访问过来的请求需要做流控 (因为当前在设置的就是流控),default-&gt; 代表一切进来的请求都做限流</p>
<p>然后 QPS 之前说过，然后设为了 1, 也就是每秒最多放行让这个接口处理 1 个请求，超出的会被拦截并报错</p>
</blockquote>
<h4 id="案例"><a class="markdownIt-Anchor" href="#案例">#</a> 案例</h4>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220219194105503.png" alt="image-20220219194105503"></p>
<h3 id="流控模式"><a class="markdownIt-Anchor" href="#流控模式">#</a> 流控模式</h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220219194118132.png" alt="image-20220219194118132"></p>
<h4 id="关联模式"><a class="markdownIt-Anchor" href="#关联模式">#</a> 关联模式</h4>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220219194507722.png" alt="image-20220219194507722"></p>
<blockquote>
<p>也就是如果有多个修改订单的请求 (会对数据库做出更改), 超过我们设置的 QPS 值，我们希望把查询订单的请求 (也会用到数据库但是是查询，比修改 less important) 做限流，这样高并发情况下 (多请求 (高 QPS)), 修改业务先做 (更多资源来处理这个请求了), 查询业务 less important, 等修改业务做完或者做的差不多再去做.</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220219195643712.png" alt="image-20220219195643712"></p>
<p>当优先级高的资源被请求超过设置的 QPS 给优先级低的做限流</p>
<h4 id="链路模式"><a class="markdownIt-Anchor" href="#链路模式">#</a> 链路模式</h4>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220219195741499.png" alt="image-20220219195741499"></p>
<blockquote>
<p>这么设置如果从 /test1 进入到 /common 请求就不会管，所以 /test2 访问 /common 过多超过了设置的 QPS, 那么来自 /test2 访问 /common 就会被限流，而从 /test1 进入到 /common 请求就不会被限流</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220219200038311.png" alt="image-20220219200038311"></p>
<blockquote>
<p>链路理解是 controller-&gt;service-&gt;mapper 这种的，不是访问地址！</p>
</blockquote>
<p>注意我们需要让 sentinel 监控 service 层的 queryGoods 方法，默认只是监控 controller 层的那些方法:</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220219200412203.png" alt="image-20220219200412203"></p>
<blockquote>
<p>这么做之后那个 service 的方法会被监控，我们才可以做限流等操作</p>
</blockquote>
<h4 id="总结-2"><a class="markdownIt-Anchor" href="#总结-2">#</a> 总结</h4>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:%5CUsers%5Charry%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20220220044505769.png" alt="image-20220220044505769"></p>
<h3 id="流控效果"><a class="markdownIt-Anchor" href="#流控效果">#</a> 流控效果</h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220220044531166.png" alt="image-20220220044531166"></p>
<h4 id="warm-up"><a class="markdownIt-Anchor" href="#warm-up">#</a> warm up</h4>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220220044744239.png" alt="image-20220220044744239"></p>
<h4 id="排队等待"><a class="markdownIt-Anchor" href="#排队等待">#</a> 排队等待</h4>
<blockquote>
<p>所有的请求都会放入队列，如果其中有一个请求超出了我们设置的 timeout, 那么就会被拒绝并报出异常 (就像是我们之前那样 -&gt; 正常的和 warmup)</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220220045318370.png" alt="image-20220220045318370"></p>
<p>能做到流量整形的效果，波浪形的请求进来，(从这里 (这个请求队列) 出去的) 接收也会是很平缓的:</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220220045417755.png" alt="image-20220220045417755"></p>
<h4 id="总结-3"><a class="markdownIt-Anchor" href="#总结-3">#</a> 总结</h4>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220220045750204.png" alt="image-20220220045750204"></p>
<h3 id="热点参数限流"><a class="markdownIt-Anchor" href="#热点参数限流">#</a> 热点参数限流</h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220220050032962.png" alt="image-20220220050032962"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220220050329862.png" alt="image-20220220050329862"></p>
<p>但是，注意！！！</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220220050407949.png" alt="image-20220220050407949"></p>
<blockquote>
<p>所以我们需要给那些 controller 里面的那个方法加上 @SentinelResource 才可以配置这些参数限流</p>
</blockquote>
<p>比如说:</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220220050811960.png" alt="image-20220220050811960"></p>
<h2 id="隔离和降级"><a class="markdownIt-Anchor" href="#隔离和降级">#</a> 隔离和降级</h2>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220220095800152.png" alt="image-20220220095800152"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220220095839108.png" alt="image-20220220095839108"></p>
<h3 id="feignclient整合sentinel"><a class="markdownIt-Anchor" href="#feignclient整合sentinel">#</a> FeignClient 整合 Sentinel</h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220220100134202.png" alt="image-20220220100134202"></p>
<blockquote>
<p>一整合，sentinel 就会监控 feign 客户端，把他当做链路中的一个资源.</p>
<p>这样我们就可以配置各种限流，隔离，降级级别等等等</p>
</blockquote>
<blockquote>
<p>给 feign 客户端 (就那个自己写的接口！要是有什么错了该怎么怎么办) 编写失败的降级逻辑，这样要是真的触发了我们的设置的各种 (降级的) 规则，那么就会按照我们设置的失败的降级逻辑来操作，而不是直接报错 (不友好)</p>
<p><strong>可以理解为写个备用方案</strong></p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220220100856103.png" alt="image-20220220100856103"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220220100911791.png" alt="image-20220220100911791"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220220101655486.png" alt="image-20220220101655486"></p>
<h3 id="线程隔离舱壁模式"><a class="markdownIt-Anchor" href="#线程隔离舱壁模式">#</a> 线程隔离 (舱壁模式)</h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220220101958603.png" alt="image-20220220101958603"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220220102856677.png" alt="image-20220220102856677"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220220103035502.png" alt="image-20220220103035502"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220220103258199.png" alt="image-20220220103258199"></p>
<h3 id="熔断降级"><a class="markdownIt-Anchor" href="#熔断降级">#</a> 熔断降级</h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220220103523471.png" alt="image-20220220103523471"></p>
<h4 id="断路器熔断策略-慢调用"><a class="markdownIt-Anchor" href="#断路器熔断策略-慢调用">#</a> 断路器熔断策略 - 慢调用</h4>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220220103924690.png" alt="image-20220220103924690"></p>
<h4 id="断路器熔断策略-异常比例和异常数"><a class="markdownIt-Anchor" href="#断路器熔断策略-异常比例和异常数">#</a> 断路器熔断策略 - 异常比例和异常数</h4>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220220104253770.png" alt="image-20220220104253770"></p>
<ul>
<li>异常比例就是异常的比例</li>
<li>异常数就是超过给的异常数</li>
</ul>
<blockquote>
<p>这样给 feign client 设置了这些熔断降级的，只要现在有微服务使用另外一个微服务的 feign client 来调用那个微服务，如果调用符合了我们设定的熔断规则 (以及策略),<strong> 那么任何调用这个微服务的请求都会被熔断 (其他的微服务调用这个微服务请求也会被熔断)</strong></p>
</blockquote>
<h4 id="总结-4"><a class="markdownIt-Anchor" href="#总结-4">#</a> 总结</h4>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220220105059549.png" alt="image-20220220105059549"></p>
<h2 id="授权规则"><a class="markdownIt-Anchor" href="#授权规则">#</a> 授权规则</h2>
<blockquote>
<p>sentinel 也需要这个，因为要是有人直接访问我们的微服务而不是通过网关那么网关就没效果了</p>
<p>所以需要给 sentiental 也配置个授权规则，判断访问当前微服务是不是通过网关来访问的</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220220105628809.png" alt="image-20220220105628809"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220220105932402.png" alt="image-20220220105932402"></p>
<blockquote>
<p>这个 origin 的请求头里面根本没有</p>
<p><strong>需要约定好了，到时候再传过来这个就行了</strong></p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220220110218170.png" alt="image-20220220110218170"></p>
<h3 id="自定义异常结果"><a class="markdownIt-Anchor" href="#自定义异常结果">#</a> 自定义异常结果</h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220221100956069.png" alt="image-20220221100956069"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220221101026847.png" alt="image-20220221101026847"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220221101050351.png" alt="image-20220221101050351"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220221101237155.png" alt="image-20220221101237155"></p>
<h3 id="规则持久化"><a class="markdownIt-Anchor" href="#规则持久化">#</a> 规则持久化</h3>
<h4 id="规则管理模式"><a class="markdownIt-Anchor" href="#规则管理模式">#</a> 规则管理模式</h4>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220221101752188.png" alt="image-20220221101752188"></p>
<h4 id="pull模式"><a class="markdownIt-Anchor" href="#pull模式">#</a> pull 模式</h4>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220221101954317.png" alt="image-20220221101954317"></p>
<blockquote>
<p>因为是读取，要是别的微服务要用这个客户端设置的规则但是还没到时间从那个 Machine1 里面读取那个本地文件，就会发送错误 (其他机器上的本地规则缓存还是没变), 所以不推荐 pull 模式</p>
</blockquote>
<h4 id="实现push模式"><a class="markdownIt-Anchor" href="#实现push模式">#</a> 实现 push 模式</h4>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220221102228172.png" alt="image-20220221102228172"></p>
<blockquote>
<p>具体的要看 https://www.bilibili.com/video/BV1LQ4y127n4?p=146</p>
</blockquote>
<hr>
<h2 id="分布式事务seata"><a class="markdownIt-Anchor" href="#分布式事务seata">#</a> 分布式事务 seata</h2>
<h3 id="分布式事务"><a class="markdownIt-Anchor" href="#分布式事务">#</a> 分布式事务</h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220221103809407.png" alt="image-20220221103809407"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220221103903728.png" alt="image-20220221103903728"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220221104412032.png" alt="image-20220221104412032"></p>
<blockquote>
<p>每个服务都有着自己再 service 层的自己的事务，自己的部分做完了就提交给自己的数据库了</p>
<p>别的服务要是失败了这些其他服务也不知道照样提交，这样子不行，得要分布式事务</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220221104545177.png" alt="image-20220221104545177"></p>
<h3 id="cap定理"><a class="markdownIt-Anchor" href="#cap定理">#</a> CAP 定理</h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220221104856642.png" alt="image-20220221104856642"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220221104937382.png" alt="image-20220221104937382"></p>
<blockquote>
<p>这里有两个节点存的是一样的 (主从 -&gt; 备份), 然后如果其中一个节点中的数据变了，另外一个节点数据也需要变，这样用户访问哪一个都是一样的</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220221105129133.png" alt="image-20220221105129133"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220221105722893.png" alt="image-20220221105722893"></p>
<blockquote>
<p>凡是分布式系统，分区一定会出现，那么就代表必须有 P, 剩下要么是 A 要么是 C.</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220221151848284.png" alt="image-20220221151848284"></p>
<h3 id="base理论"><a class="markdownIt-Anchor" href="#base理论">#</a> BASE 理论</h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220221152300203.png" alt="image-20220221152300203"></p>
<h3 id="分布式事务模型"><a class="markdownIt-Anchor" href="#分布式事务模型">#</a> 分布式事务模型</h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220221152415977.png" alt="image-20220221152415977"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220221152501597.png" alt="image-20220221152501597"></p>
<h2 id="seata"><a class="markdownIt-Anchor" href="#seata">#</a> Seata</h2>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Harry Qu</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://harryqu1229.github.io/2022/03/26/SpringCloud/">https://harryqu1229.github.io/2022/03/26/SpringCloud/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/java/">java</a><a class="post-meta__tags" href="/tags/backend/">backend</a><a class="post-meta__tags" href="/tags/springcloud/">springcloud</a></div><div class="post_share"><div class="addthis_inline_share_toolbox"></div><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-621848f44e1c3724" async="async"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/03/25/SpringBoot/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/default-covers/car.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">My SpringBoot2 notes</div></div></a></div><div class="next-post pull-right"><a href="/2022/03/26/SpringMVC/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/default-covers/cat.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">My SpringMVC notes</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2022/03/27/springcloud%E7%B3%BB%E5%88%97%E9%9D%A2%E8%AF%95%E9%A2%98/" title="SpringCloud Interview Questions"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/default-covers/mountain.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-03-27</div><div class="title">SpringCloud Interview Questions</div></div></a></div><div><a href="/2022/02/26/SSM%E6%A1%86%E6%9E%B6%E7%9A%84%E6%95%B4%E5%90%88%E9%A1%B9%E7%9B%AE/" title="SSM combine"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/default-covers/house.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-26</div><div class="title">SSM combine</div></div></a></div><div><a href="/2022/03/23/Spring(another%20note)/" title="Spring notes"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/default-covers/car.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-03-23</div><div class="title">Spring notes</div></div></a></div><div><a href="/2022/03/24/Spring/" title="My Spring notes"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/default-covers/car.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-03-24</div><div class="title">My Spring notes</div></div></a></div><div><a href="/2022/03/26/SpringMVC/" title="My SpringMVC notes"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/default-covers/cat.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-03-26</div><div class="title">My SpringMVC notes</div></div></a></div><div><a href="/2022/03/25/SpringBoot/" title="My SpringBoot2 notes"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/default-covers/car.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-03-25</div><div class="title">My SpringBoot2 notes</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comment</span></div><div id="comment-switch"><span class="first-comment">Disqus</span><span class="switch-btn"></span><span class="second-comment">Gitalk</span></div></div><div class="comment-wrap"><div><div id="disqus_thread"></div></div><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/avatar.jpeg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Harry Qu</div><div class="author-info__description">Software Engineering Student</div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">158</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">84</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">57</div></a></div></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/HarryQu1229"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://www.linkedin.com/in/harry-qu-a0a38220a" target="_blank" title="LinkedIn"><i class="fab fa-linkedin"></i></a><a class="social-icon" href="https://github.com/HarryQu1229" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:Harryqu666@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="weixin://dl/chat?harry666ya" target="_blank" title="Wechat"><i class="fab fa-weixin"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">be healthy, stay safe</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AE%A4%E8%AF%86%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.</span> <span class="toc-text"> 认识微服务</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%95%E4%BD%93%E6%9E%B6%E6%9E%84"><span class="toc-number">1.1.</span> <span class="toc-text"> 单体架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84"><span class="toc-number">1.2.</span> <span class="toc-text"> 分布式架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.3.</span> <span class="toc-text"> 微服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#springcloud"><span class="toc-number">1.4.</span> <span class="toc-text"> SpringCloud</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E5%AE%B9%E7%9F%A5%E8%AF%86"><span class="toc-number">1.5.</span> <span class="toc-text"> 内容知识</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%80%E6%9C%AF%E6%A0%88%E5%AF%B9%E6%AF%94"><span class="toc-number">1.6.</span> <span class="toc-text"> 技术栈对比</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E6%8B%86%E5%88%86"><span class="toc-number">2.</span> <span class="toc-text"> 服务拆分</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8"><span class="toc-number">3.</span> <span class="toc-text"> 远程调用</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#eureka%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="toc-number">4.</span> <span class="toc-text"> Eureka 注册中心</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%90%AD%E5%BB%BA%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="toc-number">4.1.</span> <span class="toc-text"> 搭建注册中心</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C"><span class="toc-number">4.2.</span> <span class="toc-text"> 服务注册</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E6%8B%89%E5%8F%96"><span class="toc-number">4.3.</span> <span class="toc-text"> 服务拉取</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ribbon%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">5.</span> <span class="toc-text"> Ribbon 负载均衡</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E8%B7%9F%E8%B8%AA"><span class="toc-number">5.1.</span> <span class="toc-text"> 源码跟踪</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B%E6%80%BB%E7%BB%93"><span class="toc-number">5.2.</span> <span class="toc-text"> 流程总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AD%96%E7%95%A5"><span class="toc-number">5.3.</span> <span class="toc-text"> 负载均衡策略</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%AD%96%E7%95%A5"><span class="toc-number">5.4.</span> <span class="toc-text"> 自定义策略</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A5%A5%E9%A5%BF%E5%8A%A0%E8%BD%BD"><span class="toc-number">5.5.</span> <span class="toc-text"> 饥饿加载</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#nacos%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="toc-number">6.</span> <span class="toc-text"> Nacos 注册中心</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C-2"><span class="toc-number">6.1.</span> <span class="toc-text"> 服务注册</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E7%BA%A7%E5%AD%98%E5%82%A8%E6%A8%A1%E5%9E%8B"><span class="toc-number">6.2.</span> <span class="toc-text"> 分级存储模型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E9%9B%86%E7%BE%A4"><span class="toc-number">6.3.</span> <span class="toc-text"> 配置集群</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nacosrule"><span class="toc-number">6.4.</span> <span class="toc-text"> NacosRule</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9D%83%E9%87%8D%E9%85%8D%E7%BD%AE"><span class="toc-number">6.5.</span> <span class="toc-text"> 权重配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E9%9A%94%E7%A6%BB"><span class="toc-number">6.6.</span> <span class="toc-text"> 环境隔离</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAnamespace"><span class="toc-number">6.6.1.</span> <span class="toc-text"> 创建 namespace</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEnamespace"><span class="toc-number">6.6.2.</span> <span class="toc-text"> 配置 namespace</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%B4%E6%97%B6%E5%AE%9E%E4%BE%8B"><span class="toc-number">6.7.</span> <span class="toc-text"> 临时实例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nacos%E5%92%8Ceureka%E5%8C%BA%E5%88%AB"><span class="toc-number">6.8.</span> <span class="toc-text"> Nacos 和 Eureka 区别</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#nacos%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83"><span class="toc-number">7.</span> <span class="toc-text"> Nacos 配置中心</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E9%85%8D%E7%BD%AE"><span class="toc-number">7.1.</span> <span class="toc-text"> 创建配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8B%89%E5%8F%96%E9%85%8D%E7%BD%AE"><span class="toc-number">7.2.</span> <span class="toc-text"> 拉取配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E7%83%AD%E6%9B%B4%E6%96%B0"><span class="toc-number">7.3.</span> <span class="toc-text"> 配置热更新</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#refreshscope"><span class="toc-number">7.3.1.</span> <span class="toc-text"> @RefreshScope</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#configurationproperties"><span class="toc-number">7.3.2.</span> <span class="toc-text"> @ConfigurationProperties</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%85%B1%E4%BA%AB"><span class="toc-number">7.4.</span> <span class="toc-text"> 配置共享</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E4%BC%98%E5%85%88%E7%BA%A7"><span class="toc-number">7.5.</span> <span class="toc-text"> 配置优先级</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nacos%E9%9B%86%E7%BE%A4"><span class="toc-number">7.6.</span> <span class="toc-text"> Nacos 集群</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#feign%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8"><span class="toc-number">8.</span> <span class="toc-text"> Feign 远程调用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#feign%E4%BD%BF%E7%94%A8"><span class="toc-number">8.1.</span> <span class="toc-text"> Feign 使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E9%85%8D%E7%BD%AE"><span class="toc-number">8.2.</span> <span class="toc-text"> 自定义配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="toc-number">8.3.</span> <span class="toc-text"> 性能优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">8.4.</span> <span class="toc-text"> 最佳实践</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%A7%E6%89%BF%E6%96%B9%E5%BC%8F"><span class="toc-number">8.4.1.</span> <span class="toc-text"> 继承方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%BD%E5%8F%96%E6%96%B9%E5%BC%8F"><span class="toc-number">8.4.2.</span> <span class="toc-text"> 抽取方式</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#gateway%E7%BD%91%E5%85%B3"><span class="toc-number">9.</span> <span class="toc-text"> Gateway 网关</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%A5%E9%97%A8%E4%BD%BF%E7%94%A8"><span class="toc-number">9.1.</span> <span class="toc-text"> 入门使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="toc-number">9.2.</span> <span class="toc-text"> 流程图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%AD%E8%A8%80%E5%B7%A5%E5%8E%82"><span class="toc-number">9.3.</span> <span class="toc-text"> 断言工厂</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E5%99%A8%E5%B7%A5%E5%8E%82"><span class="toc-number">9.4.</span> <span class="toc-text"> 过滤器工厂</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">9.5.</span> <span class="toc-text"> 全局过滤器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E5%99%A8%E9%A1%BA%E5%BA%8F"><span class="toc-number">9.6.</span> <span class="toc-text"> 过滤器顺序</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98"><span class="toc-number">9.7.</span> <span class="toc-text"> 跨域问题</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#rabbitmq"><span class="toc-number">10.</span> <span class="toc-text"> RabbitMQ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E5%BC%82%E6%AD%A5%E9%80%9A%E8%AE%AF"><span class="toc-number">10.1.</span> <span class="toc-text"> 同步异步通讯</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mq%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-number">10.2.</span> <span class="toc-text"> MQ 消息队列</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%A5%E9%97%A8%E6%A1%88%E4%BE%8B"><span class="toc-number">10.3.</span> <span class="toc-text"> 入门案例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#publisher%E5%AE%9E%E7%8E%B0"><span class="toc-number">10.3.1.</span> <span class="toc-text"> publisher 实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#consumer%E5%AE%9E%E7%8E%B0"><span class="toc-number">10.3.2.</span> <span class="toc-text"> consumer 实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#springamqp"><span class="toc-number">10.4.</span> <span class="toc-text"> SpringAMQP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#basicqueue"><span class="toc-number">10.4.1.</span> <span class="toc-text"> BasicQueue</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#workqueue"><span class="toc-number">10.4.2.</span> <span class="toc-text"> WorkQueue</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85"><span class="toc-number">10.4.3.</span> <span class="toc-text"> 发布 &#x2F; 订阅</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fanout"><span class="toc-number">10.4.4.</span> <span class="toc-text"> Fanout</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#direct"><span class="toc-number">10.4.5.</span> <span class="toc-text"> Direct</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#topic"><span class="toc-number">10.4.6.</span> <span class="toc-text"> Topic</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E8%BD%AC%E6%8D%A2%E5%99%A8"><span class="toc-number">10.4.7.</span> <span class="toc-text"> 消息转换器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93%E4%B8%80%E4%B8%8B%E5%AD%90"><span class="toc-number">10.4.8.</span> <span class="toc-text"> 总结一下子:</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#elasticsearch"><span class="toc-number">11.</span> <span class="toc-text"> ELasticsearch</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95"><span class="toc-number">11.1.</span> <span class="toc-text"> 倒排索引</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E6%A1%A3%E5%92%8C%E5%AD%97%E6%AE%B5"><span class="toc-number">11.2.</span> <span class="toc-text"> 文档和字段</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E5%92%8C%E6%98%A0%E5%B0%84"><span class="toc-number">11.3.</span> <span class="toc-text"> 索引和映射</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85elasticsearch"><span class="toc-number">11.4.</span> <span class="toc-text"> 安装 Elasticsearch</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85kibana"><span class="toc-number">11.5.</span> <span class="toc-text"> 安装 kibana</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85ik%E5%88%86%E8%AF%8D%E5%99%A8"><span class="toc-number">11.6.</span> <span class="toc-text"> 安装 IK 分词器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%A9%E5%B1%95%E8%AF%8D%E8%AF%8D%E5%85%B8"><span class="toc-number">11.7.</span> <span class="toc-text"> 扩展词词典</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E5%BA%93%E6%93%8D%E4%BD%9C"><span class="toc-number">11.8.</span> <span class="toc-text"> 索引库操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#mapping%E5%B1%9E%E6%80%A7%E6%98%A0%E5%B0%84"><span class="toc-number">11.8.1.</span> <span class="toc-text"> Mapping 属性映射</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95%E5%BA%93%E5%92%8C%E6%98%A0%E5%B0%84"><span class="toc-number">11.8.2.</span> <span class="toc-text"> 创建索引库和映射</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E7%B4%A2%E5%BC%95%E5%BA%93"><span class="toc-number">11.8.3.</span> <span class="toc-text"> 修改索引库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E7%B4%A2%E5%BC%95%E5%BA%93"><span class="toc-number">11.8.4.</span> <span class="toc-text"> 删除索引库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E7%B4%A2%E5%BC%95%E5%BA%93"><span class="toc-number">11.8.5.</span> <span class="toc-text"> 查询索引库</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dsl%E6%96%87%E6%A1%A3%E6%93%8D%E4%BD%9C"><span class="toc-number">11.9.</span> <span class="toc-text"> DSL 文档操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B0%E5%A2%9E%E6%96%87%E6%A1%A3"><span class="toc-number">11.9.1.</span> <span class="toc-text"> 新增文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E6%96%87%E6%A1%A3"><span class="toc-number">11.9.2.</span> <span class="toc-text"> 修改文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%96%87%E6%A1%A3"><span class="toc-number">11.9.3.</span> <span class="toc-text"> 查询文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E6%96%87%E6%A1%A3"><span class="toc-number">11.9.4.</span> <span class="toc-text"> 删除文档</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#restclient%E6%96%87%E6%A1%A3%E6%93%8D%E4%BD%9C"><span class="toc-number">11.10.</span> <span class="toc-text"> RestClient 文档操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96restclient"><span class="toc-number">11.10.1.</span> <span class="toc-text"> 初始化 RestClient</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95%E5%BA%93"><span class="toc-number">11.10.2.</span> <span class="toc-text"> 创建索引库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E7%B4%A2%E5%BC%95%E5%BA%93-2"><span class="toc-number">11.10.3.</span> <span class="toc-text"> 删除索引库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A4%E6%96%AD%E7%B4%A2%E5%BC%95%E5%BA%93"><span class="toc-number">11.10.4.</span> <span class="toc-text"> 判断索引库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B0%E5%A2%9E%E6%96%87%E6%A1%A3-2"><span class="toc-number">11.10.5.</span> <span class="toc-text"> 新增文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%96%87%E6%A1%A3-2"><span class="toc-number">11.10.6.</span> <span class="toc-text"> 查询文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E6%96%87%E6%A1%A3-2"><span class="toc-number">11.10.7.</span> <span class="toc-text"> 删除文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E6%96%87%E6%A1%A3-2"><span class="toc-number">11.10.8.</span> <span class="toc-text"> 修改文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%B9%E9%87%8F%E5%AF%BC%E5%85%A5%E6%96%87%E6%A1%A3"><span class="toc-number">11.10.9.</span> <span class="toc-text"> 批量导入文档</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dsl%E6%96%87%E6%A1%A3%E6%9F%A5%E8%AF%A2"><span class="toc-number">11.11.</span> <span class="toc-text"> DSL 文档查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2"><span class="toc-number">11.11.1.</span> <span class="toc-text"> 全文检索</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B2%BE%E5%87%86%E6%9F%A5%E8%AF%A2"><span class="toc-number">11.11.2.</span> <span class="toc-text"> 精准查询</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#term%E6%9F%A5%E8%AF%A2"><span class="toc-number">11.11.2.1.</span> <span class="toc-text"> term 查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#range%E6%9F%A5%E8%AF%A2"><span class="toc-number">11.11.2.2.</span> <span class="toc-text"> range 查询</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%B0%E7%90%86%E5%9D%90%E6%A0%87%E6%9F%A5%E8%AF%A2"><span class="toc-number">11.11.3.</span> <span class="toc-text"> 地理坐标查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%8D%E5%90%88%E6%9F%A5%E8%AF%A2"><span class="toc-number">11.11.4.</span> <span class="toc-text"> 复合查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E6%80%A7%E7%AE%97%E5%88%86"><span class="toc-number">11.11.5.</span> <span class="toc-text"> 相关性算分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%97%E5%88%86%E5%87%BD%E6%95%B0%E6%9F%A5%E8%AF%A2"><span class="toc-number">11.11.6.</span> <span class="toc-text"> 算分函数查询</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%90%9C%E7%B4%A2%E7%BB%93%E6%9E%9C%E5%A4%84%E7%90%86"><span class="toc-number">11.12.</span> <span class="toc-text"> 搜索结果处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%92%E5%BA%8F"><span class="toc-number">11.12.1.</span> <span class="toc-text"> 排序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E9%A1%B5"><span class="toc-number">11.12.2.</span> <span class="toc-text"> 分页</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AB%98%E4%BA%AE"><span class="toc-number">11.12.3.</span> <span class="toc-text"> 高亮</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#restclient%E6%96%87%E6%A1%A3%E6%9F%A5%E8%AF%A2"><span class="toc-number">11.13.</span> <span class="toc-text"> RestClient 文档查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%91%E8%B5%B7%E6%9F%A5%E8%AF%A2%E8%AF%B7%E6%B1%82"><span class="toc-number">11.13.1.</span> <span class="toc-text"> 发起查询请求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90%E6%9F%A5%E8%AF%A2%E5%93%8D%E5%BA%94"><span class="toc-number">11.13.2.</span> <span class="toc-text"> 解析查询响应</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#match%E6%9F%A5%E8%AF%A2"><span class="toc-number">11.13.3.</span> <span class="toc-text"> match 查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B2%BE%E7%A1%AE%E6%9F%A5%E8%AF%A2"><span class="toc-number">11.13.4.</span> <span class="toc-text"> 精确查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%83%E5%B0%94%E6%9F%A5%E8%AF%A2"><span class="toc-number">11.13.5.</span> <span class="toc-text"> 布尔查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%92%E5%BA%8F-%E5%88%86%E9%A1%B5"><span class="toc-number">11.13.6.</span> <span class="toc-text"> 排序、分页</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AB%98%E4%BA%AE-2"><span class="toc-number">11.13.7.</span> <span class="toc-text"> 高亮</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%B0%E7%90%86%E5%9D%90%E6%A0%87%E6%9F%A5%E8%AF%A2-2"><span class="toc-number">11.13.8.</span> <span class="toc-text"> 地理坐标查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E6%80%A7%E5%BE%97%E5%88%86"><span class="toc-number">11.13.9.</span> <span class="toc-text"> 相关性得分</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dsl%E6%95%B0%E6%8D%AE%E8%81%9A%E5%90%88"><span class="toc-number">11.14.</span> <span class="toc-text"> DSL 数据聚合</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#bucket%E8%81%9A%E5%90%88%E8%AF%AD%E6%B3%95"><span class="toc-number">11.14.1.</span> <span class="toc-text"> Bucket 聚合语法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#metric%E8%81%9A%E5%90%88%E8%AF%AD%E6%B3%95"><span class="toc-number">11.14.2.</span> <span class="toc-text"> Metric 聚合语法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#restapi%E6%95%B0%E6%8D%AE%E8%81%9A%E5%90%88"><span class="toc-number">11.15.</span> <span class="toc-text"> RestAPI 数据聚合</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E8%A1%A5%E5%85%A8"><span class="toc-number">11.16.</span> <span class="toc-text"> 自动补全</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8B%BC%E9%9F%B3%E5%88%86%E8%AF%8D%E5%99%A8"><span class="toc-number">11.16.1.</span> <span class="toc-text"> 拼音分词器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%88%86%E8%AF%8D%E5%99%A8"><span class="toc-number">11.16.2.</span> <span class="toc-text"> 自定义分词器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E8%A1%A5%E5%85%A8%E6%9F%A5%E8%AF%A2"><span class="toc-number">11.16.3.</span> <span class="toc-text"> 自动补全查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#javaapi"><span class="toc-number">11.16.4.</span> <span class="toc-text"> JavaAPI</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5"><span class="toc-number">11.17.</span> <span class="toc-text"> 数据同步</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E8%B0%83%E7%94%A8"><span class="toc-number">11.17.1.</span> <span class="toc-text"> 同步调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E9%80%9A%E7%9F%A5"><span class="toc-number">11.17.2.</span> <span class="toc-text"> 异步通知</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%91%E5%90%ACbinlog"><span class="toc-number">11.17.3.</span> <span class="toc-text"> 监听 binlog</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%98%E7%BC%BA%E7%82%B9"><span class="toc-number">11.17.4.</span> <span class="toc-text"> 优缺点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F"><span class="toc-number">11.17.5.</span> <span class="toc-text"> 实现方式</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4sentinel"><span class="toc-number">12.</span> <span class="toc-text"> 微服务保护 Sentinel</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%AA%E5%B4%A9%E9%97%AE%E9%A2%98%E5%92%8C%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">12.1.</span> <span class="toc-text"> 雪崩问题和解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%AA%E5%B4%A9%E9%97%AE%E9%A2%98"><span class="toc-number">12.1.1.</span> <span class="toc-text"> 雪崩问题:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E5%BC%8F4%E4%B8%AA"><span class="toc-number">12.1.2.</span> <span class="toc-text"> 解决方式 (4 个)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E8%B6%85%E6%97%B6%E5%A4%84%E7%90%86"><span class="toc-number">12.1.2.1.</span> <span class="toc-text"> 1. 超时处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E8%88%B1%E5%A3%81%E6%A8%A1%E5%BC%8F"><span class="toc-number">12.1.2.2.</span> <span class="toc-text"> 2. 舱壁模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7"><span class="toc-number">12.1.2.3.</span> <span class="toc-text"> 3. 熔断降级</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6"><span class="toc-number">12.1.2.4.</span> <span class="toc-text"> 4. 流量控制</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">12.1.3.</span> <span class="toc-text"> 总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4%E6%8A%80%E6%9C%AF%E5%AF%B9%E6%AF%94"><span class="toc-number">12.2.</span> <span class="toc-text"> 服务保护技术对比</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sentinel%E4%BB%8B%E7%BB%8D%E5%92%8C%E5%AE%89%E8%A3%85"><span class="toc-number">12.3.</span> <span class="toc-text"> Sentinel 介绍和安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%95%B4%E5%90%88sentinel"><span class="toc-number">12.4.</span> <span class="toc-text"> 微服务整合 Sentinel</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%90%E6%B5%81%E8%A7%84%E5%88%99"><span class="toc-number">12.5.</span> <span class="toc-text"> 限流规则</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8"><span class="toc-number">12.5.1.</span> <span class="toc-text"> 快速入门</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B0%87%E7%82%B9%E9%93%BE%E8%B7%AF"><span class="toc-number">12.5.1.1.</span> <span class="toc-text"> 簇点链路</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B"><span class="toc-number">12.5.1.2.</span> <span class="toc-text"> 案例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%81%E6%8E%A7%E6%A8%A1%E5%BC%8F"><span class="toc-number">12.5.2.</span> <span class="toc-text"> 流控模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E8%81%94%E6%A8%A1%E5%BC%8F"><span class="toc-number">12.5.2.1.</span> <span class="toc-text"> 关联模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%93%BE%E8%B7%AF%E6%A8%A1%E5%BC%8F"><span class="toc-number">12.5.2.2.</span> <span class="toc-text"> 链路模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-2"><span class="toc-number">12.5.2.3.</span> <span class="toc-text"> 总结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%81%E6%8E%A7%E6%95%88%E6%9E%9C"><span class="toc-number">12.5.3.</span> <span class="toc-text"> 流控效果</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#warm-up"><span class="toc-number">12.5.3.1.</span> <span class="toc-text"> warm up</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%92%E9%98%9F%E7%AD%89%E5%BE%85"><span class="toc-number">12.5.3.2.</span> <span class="toc-text"> 排队等待</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-3"><span class="toc-number">12.5.3.3.</span> <span class="toc-text"> 总结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%83%AD%E7%82%B9%E5%8F%82%E6%95%B0%E9%99%90%E6%B5%81"><span class="toc-number">12.5.4.</span> <span class="toc-text"> 热点参数限流</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9A%94%E7%A6%BB%E5%92%8C%E9%99%8D%E7%BA%A7"><span class="toc-number">12.6.</span> <span class="toc-text"> 隔离和降级</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#feignclient%E6%95%B4%E5%90%88sentinel"><span class="toc-number">12.6.1.</span> <span class="toc-text"> FeignClient 整合 Sentinel</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E9%9A%94%E7%A6%BB%E8%88%B1%E5%A3%81%E6%A8%A1%E5%BC%8F"><span class="toc-number">12.6.2.</span> <span class="toc-text"> 线程隔离 (舱壁模式)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7"><span class="toc-number">12.6.3.</span> <span class="toc-text"> 熔断降级</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%AD%E8%B7%AF%E5%99%A8%E7%86%94%E6%96%AD%E7%AD%96%E7%95%A5-%E6%85%A2%E8%B0%83%E7%94%A8"><span class="toc-number">12.6.3.1.</span> <span class="toc-text"> 断路器熔断策略 - 慢调用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%AD%E8%B7%AF%E5%99%A8%E7%86%94%E6%96%AD%E7%AD%96%E7%95%A5-%E5%BC%82%E5%B8%B8%E6%AF%94%E4%BE%8B%E5%92%8C%E5%BC%82%E5%B8%B8%E6%95%B0"><span class="toc-number">12.6.3.2.</span> <span class="toc-text"> 断路器熔断策略 - 异常比例和异常数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-4"><span class="toc-number">12.6.3.3.</span> <span class="toc-text"> 总结</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%88%E6%9D%83%E8%A7%84%E5%88%99"><span class="toc-number">12.7.</span> <span class="toc-text"> 授权规则</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BC%82%E5%B8%B8%E7%BB%93%E6%9E%9C"><span class="toc-number">12.7.1.</span> <span class="toc-text"> 自定义异常结果</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%84%E5%88%99%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">12.7.2.</span> <span class="toc-text"> 规则持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%84%E5%88%99%E7%AE%A1%E7%90%86%E6%A8%A1%E5%BC%8F"><span class="toc-number">12.7.2.1.</span> <span class="toc-text"> 规则管理模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#pull%E6%A8%A1%E5%BC%8F"><span class="toc-number">12.7.2.2.</span> <span class="toc-text"> pull 模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0push%E6%A8%A1%E5%BC%8F"><span class="toc-number">12.7.2.3.</span> <span class="toc-text"> 实现 push 模式</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1seata"><span class="toc-number">12.8.</span> <span class="toc-text"> 分布式事务 seata</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="toc-number">12.8.1.</span> <span class="toc-text"> 分布式事务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cap%E5%AE%9A%E7%90%86"><span class="toc-number">12.8.2.</span> <span class="toc-text"> CAP 定理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#base%E7%90%86%E8%AE%BA"><span class="toc-number">12.8.3.</span> <span class="toc-text"> BASE 理论</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%A8%A1%E5%9E%8B"><span class="toc-number">12.8.4.</span> <span class="toc-text"> 分布式事务模型</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#seata"><span class="toc-number">12.9.</span> <span class="toc-text"> Seata</span></a></li></ol></li></ol></div></div><div class="card-widget card-map"><div class="card-content"><div class="item-headline"><i class="fa fa-globe-asia" aria-hidden="true"></i><span>Visitor Map</span></div><script id="clstr_globe" type="text/javascript" defer="defer" src="//clustrmaps.com/globe.js?d=4LA950xi3DtQgUHPlkO0mo-n_QgrcOu-1BIiVpExg7k"></script></div></div><div class="card-widget card-pixiv"><div class="card-content"><div class="item-headline"><i class="fa fa-image" aria-hidden="true"></i><span>Pixiv Top50</span><iframe src="https://cloud.mokeyjay.com/pixiv" frameborder="0" style="width:99%;height:380px;margin:0;"></iframe></div></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/07/28/Maven/" title="My Maven notes"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/default-covers/hello-world.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="My Maven notes"/></a><div class="content"><a class="title" href="/2022/07/28/Maven/" title="My Maven notes">My Maven notes</a><time datetime="2022-07-27T12:00:00.000Z" title="Created 2022-07-28 00:00:00">2022-07-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/07/25/nodejs/" title="Nodejs notes"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/default-covers/town.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Nodejs notes"/></a><div class="content"><a class="title" href="/2022/07/25/nodejs/" title="Nodejs notes">Nodejs notes</a><time datetime="2022-07-24T12:00:00.000Z" title="Created 2022-07-25 00:00:00">2022-07-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/06/12/%E7%AE%97%E6%B3%95%E7%BB%88%E6%9E%81%E6%8C%87%E5%8D%97/" title="My ultimate data structure and algorithm guide"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/default-covers/statue.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="My ultimate data structure and algorithm guide"/></a><div class="content"><a class="title" href="/2022/06/12/%E7%AE%97%E6%B3%95%E7%BB%88%E6%9E%81%E6%8C%87%E5%8D%97/" title="My ultimate data structure and algorithm guide">My ultimate data structure and algorithm guide</a><time datetime="2022-06-11T12:00:00.000Z" title="Created 2022-06-12 00:00:00">2022-06-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/06/12/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" title="Design Patterns"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/default-covers/home.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Design Patterns"/></a><div class="content"><a class="title" href="/2022/06/12/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" title="Design Patterns">Design Patterns</a><time datetime="2022-06-11T12:00:00.000Z" title="Created 2022-06-12 00:00:00">2022-06-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/06/11/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%20-%20%E5%B7%A5%E5%8E%82%E6%96%B9%E6%B3%95/" title="Design Patterns - Factory Method"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/default-covers/home.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Design Patterns - Factory Method"/></a><div class="content"><a class="title" href="/2022/06/11/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%20-%20%E5%B7%A5%E5%8E%82%E6%96%B9%E6%B3%95/" title="Design Patterns - Factory Method">Design Patterns - Factory Method</a><time datetime="2022-06-10T12:00:00.000Z" title="Created 2022-06-11 00:00:00">2022-06-11</time></div></div></div></div></div></div></main><footer id="footer" style="background: transparent"><div id="footer-wrap"><div class="copyright">&copy;2021 - 2022 By Harry Qu</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="Chat"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="Scroll To Comments"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Local search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>function loadDisqus () {
  var disqus_config = function () {
    this.page.url = 'https://harryqu1229.github.io/2022/03/26/SpringCloud/'
    this.page.identifier = '2022/03/26/SpringCloud/'
    this.page.title = 'My SpringCloud notes'
  };

  window.disqusReset = () => {
    DISQUS.reset({
      reload: true,
      config: disqus_config
    })
  }

  if (window.DISQUS) disqusReset()
  else {
    (function() { 
      var d = document, s = d.createElement('script');
      s.src = 'https://harry-study-blog.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  }
}

if ('Disqus' === 'Disqus' || !true) {
  if (true) btf.loadComment(document.getElementById('disqus_thread'), loadDisqus)
  else loadDisqus()
} else {
  function loadOtherComment () {
    loadDisqus()
  }
}
</script><script>function addGitalkSource () {
  const ele = document.createElement('link')
  ele.rel = 'stylesheet'
  ele.href= 'https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css'
  document.getElementsByTagName('head')[0].appendChild(ele)
}

function loadGitalk () {
  function initGitalk () {
    var gitalk = new Gitalk(Object.assign({
      clientID: '5df1e915e0fa867b50de',
      clientSecret: 'ce1cb793fe49078ee9d0102d3326d0d50ff6937b',
      repo: 'blog-comments-storage',
      owner: 'HarryQu1229',
      admin: ['HarryQu1229'],
      id: 'db4470283c64d5823fad786869fbf6ff',
      updateCountCallback: commentCount
    },null))

    gitalk.render('gitalk-container')
  }

  if (typeof Gitalk === 'function') initGitalk()
  else {
    addGitalkSource()
    getScript('https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js').then(initGitalk)
  }
}

function commentCount(n){
  let isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
  if (isCommentCount) {
    isCommentCount.innerHTML= n
  }
}

if ('Disqus' === 'Gitalk' || !true) {
  if (true) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
  else loadGitalk()
} else {
  function loadOtherComment () {
    loadGitalk()
  }
}</script></div><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[image]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[link]') // replace url
    content = content.replace(/<code>.*?<\/code>/gi, '[code]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getComment = () => {
    fetch('https://disqus.com/api/3.0/forums/listPosts.json?forum=harry-study-blog&related=thread&limit=6&api_key=B5XFmdGuVaYDW7OIBakffpXoKorvphwRiwONIol4puEtr8YiwYAMAk2K7QcExNLY')
      .then(response => response.json())
      .then(data => {
        const disqusArray = data.response.map(item => {
          return {
            'avatar': item.author.avatar.cache,
            'content': changeContent(item.message),
            'nick': item.author.name,
            'url': item.url,
            'date': item.createdAt
          }
        })

        saveToLocal.set('disqus-newest-comments', JSON.stringify(disqusArray), 10/(60*24))
        generateHtml(disqusArray)
      }).catch(e => {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.innerHTML= "Unable to get the data, please make sure the settings are correct."
      })
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }
        
        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick}</span><time> / ${btf.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += 'No Comment'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom.innerHTML= result
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('disqus-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><div class="aplayer no-destroy" data-id="2809513713" data-server="netease" data-type="playlist" data-autoplay="false" data-fixed="true" data-order="random" data-theme="#e9ccd3"> </div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/fireworks.min.js"></script><script id="canvas_nest" defer="defer" color="255,255,255" opacity="0.7" zIndex="-1" count="99" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script>((window.gitter = {}).chat = {}).options = {
  disableDefaultChat: true,
};
document.addEventListener('gitter-sidecar-ready', (e) => {
  const GitterChat = e.detail.Chat
  let chat

  function initGitter () {
    chat = new GitterChat({
      room: 'HarryStudyBlog/community',
      activationElement: '#chat_btn'
    });
  }

  initGitter()

  if (true) {
    document.addEventListener('pjax:complete', () => {
      chat.destroy()
      initGitter()
    })
  }

})</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async="async" defer="defer"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/gh/metowolf/MetingJS@1.2/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --><script data-pjax>
  function butterfly_footer_beautify_injector_config(){
    var parent_div_git = document.getElementById('footer-wrap');
    var item_html = '<div id="ghbdages" style="overflow:hidden;max-height:90px;height:auto;text-align:center;margin-top:10px"><div class="swiper-wrapper"><div class="swiper-slide"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" title="博客框架为Hexo_v5.4.0"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&amp;logo=hexo" alt=""/></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px" title="主题版本Butterfly_v3.8.2"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&amp;logo=bitdefender" alt=""/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" title="本站项目由Github托管"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&amp;logo=GitHub" alt=""/></a></div><div class="swiper-slide"><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" style="margin-inline:5px" title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&amp;logo=Claris" alt=""/></a></div></div></div><style>a.github-badge:hover:before {display:none}</style>';
    console.log('已挂载butterfly_footer_beautify')
    parent_div_git.insertAdjacentHTML("beforeend",item_html)
    }
  var elist = 'undefined'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_footer_beautify_injector_config();
  }
  else if (epage === cpage){
    butterfly_footer_beautify_injector_config();
  }
  </script><script defer src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.js"></script><script defer data-pjax src="https://npm.elemecdn.com/hexo-butterfly-footer-beautify/lib/swiperbdage_init.min.js"></script><!-- hexo injector body_end end --><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"position":"right","width":300,"height":450},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html>