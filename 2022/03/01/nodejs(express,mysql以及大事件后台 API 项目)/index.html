<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Nodejs notes + mysql + express + 项目 | Harry World</title><meta name="keywords" content="Nodejs,frontend"><meta name="author" content="Harry Qu"><meta name="copyright" content="Harry Qu"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="# Nodejs 基础 官网传送门 (opens new window) # #初识 Nodejs  Node.js® is a JavaScript runtime built on Chrome’s V8 JavaScript engine Node.js® 是一个基于 Chrome V8 引擎 的 JavaScript 运行时环境   基于 Express 框架 (opens new win">
<meta property="og:type" content="article">
<meta property="og:title" content="Nodejs notes + mysql + express + 项目">
<meta property="og:url" content="https://harryqu1229.github.io/2022/03/01/nodejs(express,mysql%E4%BB%A5%E5%8F%8A%E5%A4%A7%E4%BA%8B%E4%BB%B6%E5%90%8E%E5%8F%B0%20API%20%E9%A1%B9%E7%9B%AE)/index.html">
<meta property="og:site_name" content="Harry World">
<meta property="og:description" content="# Nodejs 基础 官网传送门 (opens new window) # #初识 Nodejs  Node.js® is a JavaScript runtime built on Chrome’s V8 JavaScript engine Node.js® 是一个基于 Chrome V8 引擎 的 JavaScript 运行时环境   基于 Express 框架 (opens new win">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://c.pxhere.com/photos/e5/15/watercolour_painting_technique_soluble_in_water_not_opaque_color_image_color_sketch_turquoise-1110070.jpg!d">
<meta property="article:published_time" content="2022-02-28T11:00:00.000Z">
<meta property="article:modified_time" content="2022-02-25T15:15:17.661Z">
<meta property="article:author" content="Harry Qu">
<meta property="article:tag" content="frontend">
<meta property="article:tag" content="Nodejs">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://c.pxhere.com/photos/e5/15/watercolour_painting_technique_soluble_in_water_not_opaque_color_image_color_sketch_turquoise-1110070.jpg!d"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://harryqu1229.github.io/2022/03/01/nodejs(express,mysql%E4%BB%A5%E5%8F%8A%E5%A4%A7%E4%BA%8B%E4%BB%B6%E5%90%8E%E5%8F%B0%20API%20%E9%A1%B9%E7%9B%AE)/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: undefined,
  noticeOutdate: {"limitDay":100,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"prismjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"Traditional Chinese Activated Manually","cht_to_chs":"Simplified Chinese Activated Manually","day_to_night":"Dark Mode Activated Manually","night_to_day":"Light Mode Activated Manually","bgLight":"#C78550","bgDark":"#c08eaf","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Nodejs notes + mysql + express + 项目',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-02-26 04:15:17'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><style type="text/css">.aplayer.aplayer-fixed.aplayer-narrow .aplayer-body{left:-66px!important}.aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover{left:0!important}</style><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-footer-beautify@1.0.0/lib/runtime.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-filter-gitcalendar/lib/gitcalendar.css" media="print" onload="this.media='all'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">Loading...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/6aca34ee52f40fe1b2d637474f90111e2c151939/notes-img/%E5%85%B6%E4%B8%AD%E5%8C%85%E6%8B%AC%E5%9B%BE%E7%89%87%EF%BC%9A%7B%7B%20pinTitle%20%7D%7D_m6kogp.jpeg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">171</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">89</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">60</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-graduation-cap"></i><span> Journey</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> Hobbies</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/Music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/Photos/"><i class="fa-fw fas fa-images"></i><span> Photos</span></a></li><li><a class="site-page child" href="/Videos/"><i class="fa-fw fa-regular fa-play"></i><span> Videos</span></a></li><li><a class="site-page child" href="/Movies/"><i class="fa-fw fas fa-video"></i><span> Movies</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Links</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAR8AAACvCAMAAADzNCq+AAAA+VBMVEX///8zMzNon2M+hj0uLi5rv0dZWVlzqmMrKyt1rGRxqGF2rmN3sGNtpV94sWJhm1xbmFV5tGF3tl0jIyN3d3dmn1tkZGR1t1lyuVWpqamwy65jmlhwu1FVlE72+vaqx6e+07zs8+xOkEk5OTkfHx8XFxd/f38ODg5WmkxISEgxgTAAAAB+rHrJycnl5eWcnJxYoknv7++7u7tWmU13qHPc59vo6OhPT0/Z2dmWupOysrJYpUjj7OLN3syVlZVubm4lfCOOtouGtn6HvXyZwI6wz6dop1LK38Sbx4yCwGu12alfuzSe0YxlvT6BrndTkE9UqEBFjz9ClzTcvb9iAAANQ0lEQVR4nO2da2OayhaGUUxqL27otqYNCYhGcjEmjVEaTbSp+9Ketrsnyfn/P+YAwwBzZYFmawLvhzaJMuDDmndua1BRnrbOT67O1n0Nm6x39ZqzPVn3VWyu3tUrldrRu0/rvo5Nlc+nUqk7n9d9IRsqxKdSaTZ3130pGynMp1LpHZRGzSrmUymNmqMEn8Coh+u+oA0Twac0akYUH9+oL9d9TZskhk+lclr6dCwOn/rtui9qg8ThU9te90VtkEo+cpV85Cr5yFXykavkI1fJR66Sj1wlH7lKPnKVfOQq+chV8pGr5CNXyUeuko9cJR+5Sj5ylXzkKvnIVfKRq+QjV8lHrpKPXCUfuUo+cq2Xz2T32vrXTpZLS/NZImFoeHvU7PVWk9fX+et1o72SkhTl7PAwStFYks9hzznImw/z+Sg490ry+v7++vrlS920ly9JOd926nVn+xz9thSf614zSMs7z3EZl/UmPp+zk6eAhL69ffv65YuXr/bMqrtcSd4dP6oFF3V0GNSMJficnfTCA8KyMmhy1UucsX50mPH4pNw/f//tjcfnxYvW3t5o0VmiKGW32YwuKqj5ufl8unVq8QfMlh3sGU+NPGezeZ3r8yiK9Z/3b9+GfF7t7e3po/w2FN1xJK/mTxg6QD6fHRJsFhehj0UFnOSyoR8f3v8e82ns+YR0O09Jyqcdh7prtV6PvVAIn+vIPOKjnB3YJoVL9thsBST07YOHJ8HHDyBPuWwobC7SlcpncsLD6rkIIPd1cuUITwwqIKHZ9/0P70k+DQSoldmGrpv8u5adD2sekVJdZPhOeCwqoA63IeufLR8PyedVKwTUymRDgjuehw/XPCL1TmQp+B97qSEMtqEfW1v7LJ9GGEAeIL01B9Ihmprl+FxWUsKw5ghT8C9rkBCuObcAG/q29Wt/n8sHB5AfQv+dQfDI73gWPjLziFR3PuY+FhWQakOz7z/96OHyiQLIA+TZUOrwTtRcZOeTZh6RmjVmyAE+FhUg9THrn5+/tsR84hrma2RI6ZD91KX4fMwQhvROoCzHBpL42I9fPp10PiGgVkNsQ9nuGhaXT6rxUGUkhxyXB1lDWGxD3/Z/bm3J+RA1rCWxIUBzwb00ls9kO5PD+6rjiYvz7MeiAjhbiTrfMR0ZnxYFqDWacmwo4x2PxfAZHub6hGjIMTnNRSco4Iq6EOPnr60MfDCeVqM1oivZObi5YETzOctqHlFBzq2i7OTG49kY6fPz/vEWiE+L5tNo9Mn+9Hke48Efi+QzPM3/Ab06lv9grx0ja9iie7efiU9UwxqtPtmOHea85b4oPtc5q2lYVP6DGT6D7p0J40MDaqh9crixTFRTfHaX4FM5WS0f8+4+G58wfsyi8DFNGB/KotWnyafW6zmy0jl87m6y8QlqmJmRT13qTln4eJ9QWpaUjzdWHw5lnbQmOZIL4ucOxoeoYWomPl7HS9qhgfPxnygwYWYlk5LwwXM9kk4+zWfk8TEvYHz0GFA3Cx+0miIbTYP5NCtB/+TsQDzGE/JJDtKFF8PwGY1iB0rjEwNSM/CJ5tHFszFAPol5jF1hHTlRDrinoOaaBZMMNJ/jkU/oAsgHA+rC+dSdxDqMaEIaxId8FMXwUFBH+HxqFWaS8DMvBik+fwR8RuZ+Jj66CuVTcw6JcdqQP68I4dO7ouYfvFEo5231Wy6fJmeK8SPnNAwfBOgYxsfU4/CB8Gmy68CTE04IAfhE81edhWaHP16yEVA7nfD41LmrpZwAYvkEhFAApfMJAKHwAfCp7fCu6oTzxlQ+0TvaulbVx+Fi0y1dVDDJxeHDX2zlvZHDxyd0nIGPGvIhx18cPvy7tp2LD0Jta1rVl44Wm+hHwaAJoFXyuTgOCd3D+HiAzPXxmerVUJrJ8IkmEB+Dz/EIxqdr4vBZCx8N86nqFsknkfPyKHyOb2Dx0/W0gXzCjuPq+USAunA+iNAG8SEXwFbLBxNSHzLw8QltDB/6GWar5hMQelDV/Sx8PEIbwodZuFohnz9vLkJCXoUJAuip8OmGfDgLn4/BJ3DcexgfdW18LNzAa9Vg9eTylPfwu0fg8xDweQDyUdfFR1FmA4+QFo0wPvEyN1bK5+YmCh9VvdlYPpUKfnFeNXlrk4/Hx9MD7vPtfwDxUWF8KnVOIvduvvFpLc7GTMtjWzkfHD6qegGLHygftm3hz/xB4geeFL5KPvc+HzUWMH5UIB+qb3IumDmGzR/WgUnhq+ZzkeBzDOSjmjA+RFKEMK0MOv8MSwpfNR9VpQIIwqdrAvlEYyNJPit8/QKSFL5SPvf3DwSfByAfL4CgfCoV52pyJstnzbD+Bdhaslo+ZPioKrB+eQ4E5+Mv6klfzrJ+mrq1ZLV8Hig+D0A+ahY+Kcq4vlyX73Bbrf+otL4C+YD9Z+V8UmwIzoe9ZIYPg8erYTA+6fMbj8dHakMcPqfc3NRD9jwUnx//4/D5CuPzxSaKul0iP6pOLnScQRL16o7Ihhg+tVNu/riisG0Gxcfq9zmAQHz6Gnmuy6P8fI6occgVKMFFZEM0H4deWYzFLFNTfBRr8IXlc5zOp/9lSp8LvJuJVo3N7j+EJWjybYjkw0mtT35+6kysUbkaS+htGp8vY84gUTR6SKHD/Q4MYFlcG0ryEWzNEJ6JZ+S2SleykZxP/06QQH+WPW29KdqsLe1QJgEwwXcS4wN9u0ZyzMxv6KZfKEK/SfiofVt8rozbHqS3F7jBjvkeH8ynJjEeUrENCQZ4nTFZybpiPn3GeAgJ8044Sr29QEtzyOYv5JNcEksVtiHhANi9I0Loq4DPA894SIF3TgBuL3Cf3SlxUMCn3kszHlKhDUkmCGyirefy6eqgDYSgfRjA2wuwIXp32wHUeKgz+TYknUBJ2tCI5WOm7PxKKNWGMnzrzrV8k6TXhFFhuNMDGw+p3WbzVHrTkjb05g3F5zhlWpyQfB9Y7eg2y+2Vbdfk7K4dfs77/JLhx7TNzPMuDqERGT/AnaexJBuY5VuOedct2uCd/yERuWVgG0ryGYF3LickShHNsOM8EnfXZnrn7zFkLVAl60Z8JFtOO64rqXWcipH7674Y0/cGqGv6arVZNSD06iXic/yXCIE71j1JfIlun2FbzQUiTH/5R/gso8CGugEfsfF0FnqQL6BpknaNsKGcT0zBSpj+kiUtL8Nr6xsvXjQa30TvaOtRNkWYLsBXNExImRaFaHKFenG8hdl/WZ4N9V9//Vv0Ms4kxQmlA0nzFgwTxPNZmXRZcXprsWVWM8OWGA/CMnajlFuJDZ3fOquzi7OzDX9AX5SGg/JMyN8EGhboWzyN0JZ1nEAfJOWk2VBRNK8SKeySPxZRs9B4tDH1vC0mqIoomdWAbOh5K4oRflOFbUinY6sYijxG3NUpsA0B26iC2pA1NRGd1AdFWgtsQwTHebudduQTlq2n95EjJfrW+E/W2Jh17OWfdLuZctONh1Q85Aj/MO6483lHGWecgnwacs3sneNwbK+Ng9/subKYGqZiDR7pEteq0HjAaxeBOsiG0MzQwFIWrmJaynPkM9ehxkPKHQch5P849neOml6LNn2Gzb7hfUwt17jT340UbNPyekN+/ASgnp0M/Ckzy/aP9CNm3lYGc6VrufKl+6cpDp/ObJZoiebtxdhv4caL9px4nx0dubC9fyy3uukTW3nE8ul09cBNfFltLZqG1jRdTzpMzEdpjw17kf7k1qcoDh9/ixri42rxjkfEyIzbOTt5pDt/ht7sS8YHd42QEKG4I2Dndq6nJBkf1MfRBm3DMNrTMappJh5GFJ6P/5IXL9GLVjsAhnuBheczjnrIWKgzGTpN4fkE4UMCWPi9SRv9XPJh+czjtq3k4/OhZ+MHg8E4/FPh+SyCABrYgmmdwvOZh1OpujaeGvMZjaLwfJRBnOHiDy60gZGcQi35KIvogWAhpuQIrOTjVbGBrpFjMC36Sr6ST/DbvD2o6noCE14DKvlEsmaubSyqeBkIvb3kQ8uyg6WgcDq26HyM6XTKrGoMqhG8ovMJGnX67XN/AIbmmYvOxw8VnV4z9qGU8RMgaPsoFtTbgwE8qnVF5+PqVcao7WACCA3Iis4HDS+0qoG3qMzsIElICycQC8+ng8enXu8w/Ldazh8m+j8zenknoFXOz0e2Y011jaIzKMenyf5zxxgHYy8NzXBME3NlJR8ky53bhtE2bGqJtBh8Eh2+UOLxF6HOgJ2+f4aa6XRyHYwPWit8jhk/lNAkaiI5cwbgE6Zowp638LRl4fRVnGPXTqwB8hWl+BYjSxzvPEFL7WgIIcllFqSIP2NFmwv0wQJFkyZ+s2EWcIsB3nkS/ife0V3YLSpGoqesiZolt8BbnKy2roU1h570we8o+hY521+iGE8FsYH3NplFMh6wCms8fLltAkPUwhXQeDhyF3pyx0rhjYdUB80URoMyI5wmM9vPfjQKU7g3B3lNvG+3NJ5INm7q23gwUT5bglBkOXhotu4L2jjhJis5tC+VFKpkGnjfbvFkjKvVxYYZz/8BgbFSXQmK13cAAAAASUVORK5CYII=')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Harry World</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-graduation-cap"></i><span> Journey</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> Hobbies</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/Music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/Photos/"><i class="fa-fw fas fa-images"></i><span> Photos</span></a></li><li><a class="site-page child" href="/Videos/"><i class="fa-fw fa-regular fa-play"></i><span> Videos</span></a></li><li><a class="site-page child" href="/Movies/"><i class="fa-fw fas fa-video"></i><span> Movies</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Links</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Nodejs notes + mysql + express + 项目</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2022-02-28T11:00:00.000Z" title="Created 2022-03-01 00:00:00">2022-03-01</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2022-02-25T15:15:17.661Z" title="Updated 2022-02-26 04:15:17">2022-02-26</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Frontend/">Frontend</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Frontend/nodejs/">nodejs</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word count:</span><span class="word-count">16.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading time:</span><span>62min</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Nodejs notes + mysql + express + 项目"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">Comments:</span><span class="disqus-comment-count"><a href="https://harryqu1229.github.io/2022/03/01/nodejs(express,mysql%E4%BB%A5%E5%8F%8A%E5%A4%A7%E4%BA%8B%E4%BB%B6%E5%90%8E%E5%8F%B0%20API%20%E9%A1%B9%E7%9B%AE)/#disqus_thread"></a></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="nodejs-基础"><a class="markdownIt-Anchor" href="#nodejs-基础">#</a> Nodejs 基础</h1>
<p><a target="_blank" rel="noopener" href="https://nodejs.org/en/">官网传送门 (opens new window)</a></p>
<h2 id=""><a class="markdownIt-Anchor" href="#">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/node.html#%E5%88%9D%E8%AF%86-nodejs">#</a>初识 Nodejs</h2>
<blockquote>
<p>Node.js® is a JavaScript runtime built on Chrome’s V8 JavaScript engine</p>
<p>Node.js® 是一个基于 Chrome V8 引擎 的 JavaScript 运行时环境</p>
</blockquote>
<ul>
<li>基于 <a target="_blank" rel="noopener" href="http://www.expressjs.com.cn/">Express 框架 (opens new window)</a>，可以快速构建 Web 应用</li>
<li>基于 <a target="_blank" rel="noopener" href="https://electronjs.org/">Electron 框架 (opens new window)</a>，可以构建跨平台的桌面应用</li>
<li>基于 <a target="_blank" rel="noopener" href="http://restify.com/">restify 框架 (opens new window)</a>，可以快速构建 API 接口项目</li>
<li>读写和操作数据库、创建实用的命令行工具辅助前端开发、etc…</li>
</ul>
<hr>
<h2 id="-2"><a class="markdownIt-Anchor" href="#-2">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/node.html#buffer-%E7%BC%93%E5%86%B2%E5%8C%BA">#</a>Buffer 缓冲区</h2>
<blockquote>
<p><a target="_blank" rel="noopener" href="http://nodejs.cn/api/buffer.html">Buffer 缓冲区文档 (opens new window)</a></p>
</blockquote>
<ul>
<li>Buffer 的结构与数组类似，操作方法也与数组类似</li>
<li>数组不能存储二进制文件，Buffer 是专门存储二进制数据的</li>
<li>Buffer 存储的是二进制数据，显示时以 16 进制的形式显示</li>
<li>Buffer 每一个元素范围是 00~ff，即 0<sub>255、00000000</sub>11111111</li>
<li>每一个元素占用一个字节内存</li>
<li>Buffer 是对底层内存的直接操作，因此大小一旦确定就不能修改</li>
</ul>
<p>Buffer 常用方法：</p>
<ul>
<li><code>Buffer.from(str[, encoding])</code> ：将一个字符串转换为 Buffer</li>
<li><code>Buffer.alloc(size)</code> ：创建指定大小的 Buffer</li>
<li><code>Buffer.alloUnsafe(size)</code> ：创建指定大小的 Buffer，可能包含敏感数据（分配内存时不会清除内存残留的数据）</li>
<li><code>buf.toString()</code> ：将 Buffer 数据转为字符串</li>
</ul>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">var</span> str <span class="token operator">=</span> <span class="token string">'Hello前端'</span>

<span class="token keyword">var</span> buf <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span>

<span class="token comment">// 占用内存的大小，一个汉字3字节 13</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buf<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
<span class="token comment">// 字符串的长度 7</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
<span class="token comment">// 8进制输出第一个元素 145</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">//创建一个10个字节的buffer</span>
<span class="token keyword">var</span> buf2 <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
<span class="token comment">//通过索引，来操作buf中的元素</span>
buf2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">88</span>
buf2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">255</span>
buf2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xaa</span>
buf2<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">255</span>

<span class="token keyword">var</span> buf3 <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">allocUnsafe</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buf3<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<h2 id="-3"><a class="markdownIt-Anchor" href="#-3">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/node.html#fs-%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%A8%A1%E5%9D%97">#</a>fs 文件系统模块</h2>
<ul>
<li>fs 模块中所有的操作都有两种形式可供选择：同步和异步</li>
<li>同步文件系统会阻塞程序的执行，也就是除非操作完毕，否则不会向下执行代码</li>
<li>异步文件系统不会阻塞程序的执行，而是在操作完成时，通过回调函数将结果返回</li>
<li>实际开发很少用同步方式，因此只介绍异步方式</li>
</ul>
<p>打开模式：</p>
<table>
<thead>
<tr>
<th>模式</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>r</td>
<td>读取文件，文件不存在抛异常</td>
</tr>
<tr>
<td>r+</td>
<td>读写文件，文件不存在抛异常</td>
</tr>
<tr>
<td>rs</td>
<td>同步模式下打开文件用于读取</td>
</tr>
<tr>
<td>rs+</td>
<td>同步模式下打开文件用于读写</td>
</tr>
<tr>
<td>w</td>
<td>写文件，不存在则创建，存在则覆盖原有内容</td>
</tr>
<tr>
<td>wx</td>
<td>写文件，文件存在打开失败</td>
</tr>
<tr>
<td>w+</td>
<td>读写文件，不存在创建，存在截断</td>
</tr>
<tr>
<td>wx+</td>
<td>读写，存在打开失败</td>
</tr>
<tr>
<td>a</td>
<td>追加，不存在创建</td>
</tr>
<tr>
<td>ax</td>
<td>追加，存在失败</td>
</tr>
<tr>
<td>a+</td>
<td>追加和读取，不存在创建</td>
</tr>
<tr>
<td>ax+</td>
<td>追加和读取，存在失败</td>
</tr>
</tbody>
</table>
<h3 id="-4"><a class="markdownIt-Anchor" href="#-4">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/node.html#%E8%AF%BB%E5%8F%96%E6%96%87%E4%BB%B6">#</a>读取文件</h3>
<h4 id="-5"><a class="markdownIt-Anchor" href="#-5">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/node.html#%E7%AE%80%E5%8D%95%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96">#</a>简单文件读取</h4>
<p>语法格式：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js">fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>path<span class="token punctuation">[</span><span class="token punctuation">,</span> options<span class="token punctuation">]</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li><code>path</code> ：文件路径</li>
<li><code>options</code> ：配置选项，若是字符串则指定编码格式
<ul>
<li><code>encoding</code> ：编码格式</li>
<li><code>flag</code> ：打开方式</li>
</ul>
</li>
<li><code>callback</code> ：回调函数
<ul>
<li><code>err</code> ：错误信息</li>
<li><code>data</code> ：读取的数据，如果未指定编码格式则返回一个 Buffer</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>

fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'./files/1.txt'</span><span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'failed!'</span> <span class="token operator">+</span> err<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'content:'</span> <span class="token operator">+</span> data<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>


<span class="token comment">// 复制文件内容</span>
fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">"C:/Users/笔记.mp3"</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 将data写入到文件中</span>
		fs<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span><span class="token string">"C:/Users/hello.jpg"</span><span class="token punctuation">,</span> data<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>err<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
				console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"文件写入成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-6"><a class="markdownIt-Anchor" href="#-6">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/node.html#%E6%B5%81%E5%BC%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96">#</a>流式文件读取</h4>
<ul>
<li>简单文件读取的方式会一次性读取文件内容到内存中，若文件较大，会占用过多内存影响系统性能，且读取速度慢</li>
<li>大文件适合用流式文件读取，它会分多次将文件读取到内存中</li>
</ul>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">var</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>

<span class="token comment">// 创建一个可读流</span>
<span class="token keyword">var</span> rs <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token string">'C:/Users/笔记.mp3'</span><span class="token punctuation">)</span>
<span class="token comment">// 创建一个可写流</span>
<span class="token keyword">var</span> ws <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span><span class="token string">'a.mp3'</span><span class="token punctuation">)</span>

<span class="token comment">// 监听流的开启和关闭</span>
<span class="token comment">// 这几个监听不是必须的</span>
rs<span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token string">'open'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'可读流打开了~~'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

rs<span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token string">'close'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'可读流关闭了~~'</span><span class="token punctuation">)</span>
  <span class="token comment">//数据读取完毕，关闭可写流</span>
  ws<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

ws<span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token string">'open'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'可写流打开了~~'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

ws<span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token string">'close'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'可写流关闭了~~'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

<span class="token comment">//要读取一个可读流中的数据，要为可读流绑定一个data事件，data事件绑定完毕自动开始读取数据</span>
rs<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
  <span class="token comment">//将读取到的数据写入到可写流中</span>
  ws<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>简便方式：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">var</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> rs <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token string">'C:/Users/lilichao/Desktop/笔记.mp3'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> ws <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span><span class="token string">'b.mp3'</span><span class="token punctuation">)</span>

<span class="token comment">// pipe()可以将可读流中的内容，直接输出到可写流中</span>
rs<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>ws<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-7"><a class="markdownIt-Anchor" href="#-7">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/node.html#%E5%86%99%E5%85%A5%E6%96%87%E4%BB%B6">#</a>写入文件</h3>
<h4 id="-8"><a class="markdownIt-Anchor" href="#-8">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/node.html#%E7%AE%80%E5%8D%95%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5">#</a>简单文件写入</h4>
<p>语法格式：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js">fs<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> data<span class="token punctuation">[</span><span class="token punctuation">,</span> options<span class="token punctuation">]</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li><code>file</code> ：文件路径</li>
<li><code>data</code> ：写入内容</li>
<li><code>options</code> ：配置选项，包含  <code>encoding, mode, flag</code> ；若是字符串则指定编码格式</li>
<li><code>callback</code> ：回调函数</li>
</ul>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
fs<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span><span class="token string">'./files/2.txt'</span><span class="token punctuation">,</span> <span class="token string">'Hello Nodejs'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'failed!'</span> <span class="token operator">+</span> err<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'success!'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

fs<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span><span class="token string">'C:/Users/hello.txt'</span><span class="token punctuation">,</span> <span class="token string">'通过 writeFile 写入的内容'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> flag<span class="token operator">:</span> <span class="token string">'w'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'写入成功！'</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-9"><a class="markdownIt-Anchor" href="#-9">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/node.html#%E6%B5%81%E5%BC%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5">#</a>流式文件写入</h4>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 同步、异步、简单文件的写入都不适合大文件的写入，性能较差，容易导致内存溢出</span>
<span class="token keyword">var</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>

<span class="token comment">// 创建一个可写流</span>
<span class="token keyword">var</span> ws <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span><span class="token string">'hello3.txt'</span><span class="token punctuation">)</span>

ws<span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token string">'open'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'流打开了~~'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

ws<span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token string">'close'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'流关闭了~~'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

<span class="token comment">// 通过ws向文件中输出内容</span>
ws<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'通过可写流写入文件的内容'</span><span class="token punctuation">)</span>
ws<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>
ws<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span>
ws<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">)</span>
ws<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'4'</span><span class="token punctuation">)</span>

<span class="token comment">// 关闭流</span>
ws<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-10"><a class="markdownIt-Anchor" href="#-10">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/node.html#%E8%B7%AF%E5%BE%84%E5%8A%A8%E6%80%81%E6%8B%BC%E6%8E%A5%E9%97%AE%E9%A2%98-dirname">#</a>路径动态拼接问题  <code>__dirname</code></h3>
<ul>
<li>在使用 fs 模块操作文件时，如果提供的操作路径是以  <code>./</code>  或  <code>../</code>  开头的相对路径时，容易出现路径动态拼接错误的问题</li>
<li>原因：代码在运行的时候，会以执行 node 命令时所处的目录，动态拼接出被操作文件的完整路径</li>
<li>解决方案：在使用 fs 模块操作文件时，直接提供完整的路径，从而防止路径动态拼接的问题</li>
<li><code>__dirname</code>  获取文件所处的绝对路径</li>
</ul>
<pre class="line-numbers language-js" data-language="js"><code class="language-js">fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>__dirname <span class="token operator">+</span> <span class="token string">'/files/1.txt'</span><span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token operator">...</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="-11"><a class="markdownIt-Anchor" href="#-11">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/node.html#%E5%85%B6%E5%AE%83%E6%93%8D%E4%BD%9C">#</a>其它操作</h3>
<p>验证路径是否存在：</p>
<ul>
<li><code>fs.exists(path, callback)</code></li>
<li><code>fs.existsSync(path)</code></li>
</ul>
<p>获取文件信息：</p>
<ul>
<li><code>fs.stat(path, callback)</code></li>
<li><code>fs.stat(path)</code></li>
</ul>
<p>删除文件：</p>
<ul>
<li><code>fs.unlink(path, callback)</code></li>
<li><code>fs.unlinkSync(path)</code></li>
</ul>
<p>列出文件：</p>
<ul>
<li><code>fs.readdir(path[,options], callback)</code></li>
<li><code>fs.readdirSync(path[, options])</code></li>
</ul>
<p>截断文件：</p>
<ul>
<li><code>fs.truncate(path, len, callback)</code></li>
<li><code>fs.truncateSync(path, len)</code></li>
</ul>
<p>建立目录：</p>
<ul>
<li><code>fs.mkdir(path[, mode], callback)</code></li>
<li><code>fs.mkdirSync(path[, mode])</code></li>
</ul>
<p>删除目录：</p>
<ul>
<li><code>fs.rmdir(path, callback)</code></li>
<li><code>fs.rmdirSync(path)</code></li>
</ul>
<p>重命名文件和目录：</p>
<ul>
<li><code>fs.rename(oldPath, newPath, callback)</code></li>
<li><code>fs.renameSync(oldPath, newPath)</code></li>
</ul>
<p>监视文件更改：</p>
<ul>
<li><code>fs.watchFile(filename[, options], listener)</code></li>
</ul>
<hr>
<h2 id="-12"><a class="markdownIt-Anchor" href="#-12">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/node.html#path-%E8%B7%AF%E5%BE%84%E6%A8%A1%E5%9D%97">#</a>path 路径模块</h2>
<p>path 模块是 Node.js 官方提供的、用来处理路径的模块。它提供了一系列的方法和属性，用来满足用户对路径的处理需求。</p>
<h3 id="-13"><a class="markdownIt-Anchor" href="#-13">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/node.html#%E8%B7%AF%E5%BE%84%E6%8B%BC%E6%8E%A5-path-join">#</a>路径拼接  <code>path.join()</code></h3>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>

<span class="token comment">// 注意 ../ 会抵消前面的路径</span>
<span class="token comment">// ./ 会被忽略</span>
<span class="token keyword">const</span> pathStr <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'/a'</span><span class="token punctuation">,</span> <span class="token string">'/b/c'</span><span class="token punctuation">,</span> <span class="token string">'../../'</span><span class="token punctuation">,</span> <span class="token string">'./d'</span><span class="token punctuation">,</span> <span class="token string">'e'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>pathStr<span class="token punctuation">)</span> <span class="token comment">// \a\d\e</span>

fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./files/1.txt'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> dataStr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>dataStr<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="取路径中文件名-pathbasename"><a class="markdownIt-Anchor" href="#取路径中文件名-pathbasename">#</a> 取路径中文件名  <code>path.basename()</code></h3>
<p>使用  <code>path.basename()</code>  方法，可以获取路径中的最后一部分，常通过该方法获取路径中的文件名</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js">path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span>path<span class="token punctuation">[</span><span class="token punctuation">,</span> ext<span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>path: 文件路径</li>
<li>ext: 文件扩展名</li>
</ul>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>

<span class="token comment">// 定义文件的存放路径</span>
<span class="token keyword">const</span> fpath <span class="token operator">=</span> <span class="token string">'/a/b/c/index.html'</span>

<span class="token keyword">const</span> fullName <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span>fpath<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>fullName<span class="token punctuation">)</span> <span class="token comment">// index.html</span>

<span class="token keyword">const</span> nameWithoutExt <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span>fpath<span class="token punctuation">,</span> <span class="token string">'.html'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>nameWithoutExt<span class="token punctuation">)</span> <span class="token comment">// index</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-14"><a class="markdownIt-Anchor" href="#-14">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/node.html#%E8%8E%B7%E5%8F%96%E8%B7%AF%E5%BE%84%E4%B8%AD%E6%96%87%E4%BB%B6%E6%89%A9%E5%B1%95%E5%90%8D-path-extname">#</a>获取路径中文件扩展名  <code>path.extname()</code></h3>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> fpath <span class="token operator">=</span> <span class="token string">'/a/b/c/index.html'</span>

<span class="token keyword">const</span> fext <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span>fpath<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>fext<span class="token punctuation">)</span> <span class="token comment">// .html</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<h2 id="-15"><a class="markdownIt-Anchor" href="#-15">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/node.html#http-%E6%A8%A1%E5%9D%97">#</a>http 模块</h2>
<p>http 模块是 Node.js 官方提供的、用来创建 web 服务器的模块。</p>
<h3 id="-16"><a class="markdownIt-Anchor" href="#-16">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/node.html#%E5%88%9B%E5%BB%BA%E5%9F%BA%E6%9C%AC-web-%E6%9C%8D%E5%8A%A1%E5%99%A8">#</a>创建基本 Web 服务器</h3>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>

<span class="token comment">// 创建 web 服务器实例</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 为服务器实例绑定 request 事件，监听客户端的请求</span>
server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> url <span class="token operator">=</span> req<span class="token punctuation">.</span>url
  <span class="token keyword">const</span> method <span class="token operator">=</span> req<span class="token punctuation">.</span>method
  <span class="token keyword">const</span> str <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Your request url is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>url<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">, and request method is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>method<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span>

  <span class="token comment">// 设置 Content-Type 响应头，解决中文乱码的问题</span>
  res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'text/html; charset=utf-8'</span><span class="token punctuation">)</span>
  <span class="token comment">// 向客户端响应内容</span>
  res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'server running at http://127.0.0.1:8080'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-17"><a class="markdownIt-Anchor" href="#-17">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/node.html#%E5%AE%9E%E7%8E%B0%E7%AE%80%E9%99%8B%E8%B7%AF%E7%94%B1%E6%95%88%E6%9E%9C">#</a>实现简陋路由效果</h3>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> url <span class="token operator">=</span> req<span class="token punctuation">.</span>url
  <span class="token comment">// 设置默认的响应内容为 404 Not found</span>
  <span class="token keyword">let</span> content <span class="token operator">=</span> <span class="token string">'&lt;h1>404 Not found!&lt;/h1>'</span>
  <span class="token comment">// 判断用户请求的是否为 / 或 /index.html 首页</span>
  <span class="token comment">// 判断用户请求的是否为 /about.html 关于页面</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>url <span class="token operator">===</span> <span class="token string">'/'</span> <span class="token operator">||</span> url <span class="token operator">===</span> <span class="token string">'/index.html'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    content <span class="token operator">=</span> <span class="token string">'&lt;h1>首页&lt;/h1>'</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>url <span class="token operator">===</span> <span class="token string">'/about.html'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    content <span class="token operator">=</span> <span class="token string">'&lt;h1>关于页面&lt;/h1>'</span>
  <span class="token punctuation">&#125;</span>

  res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'text/html; charset=utf-8'</span><span class="token punctuation">)</span>
  res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'server running at http://127.0.0.1'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<h2 id="-18"><a class="markdownIt-Anchor" href="#-18">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/node.html#%E6%A8%A1%E5%9D%97%E5%8C%96">#</a>模块化</h2>
<h3 id="-19"><a class="markdownIt-Anchor" href="#-19">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/node.html#%E6%A8%A1%E5%9D%97%E5%8C%96%E6%A6%82%E5%BF%B5">#</a>模块化概念</h3>
<ul>
<li>模块化是指解决一个复杂问题时，自顶向下逐层把系统划分为若干模块的过程，模块是可组合、分解和更换的单元。</li>
<li>模块化可提高代码的复用性和可维护性，实现按需加载。</li>
<li>模块化规范是对代码进行模块化拆分和组合时需要遵守的规则，如使用何种语法格式引用模块和向外暴露成员。</li>
</ul>
<h3 id="-20"><a class="markdownIt-Anchor" href="#-20">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/node.html#node-js-%E4%B8%AD%E6%A8%A1%E5%9D%97%E7%9A%84%E5%88%86%E7%B1%BB">#</a>Node.js 中模块的分类</h3>
<ul>
<li>内置模块</li>
<li>自定义模块</li>
<li>第三方模块</li>
</ul>
<h3 id="-21"><a class="markdownIt-Anchor" href="#-21">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/node.html#node-js-%E4%B8%AD%E7%9A%84%E6%A8%A1%E5%9D%97%E4%BD%9C%E7%94%A8%E5%9F%9F">#</a>Node.js 中的模块作用域</h3>
<ul>
<li>和函数作用域类似，在自定义模块中定义的变量、方法等成员，只能在当前模块内被访问，这种模块级别的访问限制，叫做模块作用域</li>
<li>防止全局变量污染</li>
</ul>
<h3 id="-22"><a class="markdownIt-Anchor" href="#-22">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/node.html#%E6%A8%A1%E5%9D%97%E4%BD%9C%E7%94%A8%E5%9F%9F%E7%9A%84%E6%88%90%E5%91%98">#</a>模块作用域的成员</h3>
<ul>
<li>自定义模块中都有一个  <code>module</code>  对象，存储了和当前模块有关的信息</li>
<li>在自定义模块中，可以使用  <code>module.exports</code>  对象，将模块内的成员共享出去，供外界使用。导入自定义模块时，得到的就是  <code>module.exports</code>  指向的对象。</li>
<li>默认情况下， <code>exports</code>  和  <code>module.exports</code>  指向同一个对象。最终共享的结果，以  <code>module.exports</code>  指向的对象为准。</li>
</ul>
<h3 id="-23"><a class="markdownIt-Anchor" href="#-23">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/node.html#commonjs-%E6%A8%A1%E5%9D%97%E5%8C%96%E8%A7%84%E8%8C%83">#</a>CommonJS 模块化规范</h3>
<ul>
<li>每个模块内部， <code>module</code>  变量代表当前模块</li>
<li><code>module</code>  变量是一个对象， <code>module.exports</code>  是对外的接口</li>
<li>加载某个模块即加载该模块的  <code>module.exports</code>  属性</li>
</ul>
<h3 id="-24"><a class="markdownIt-Anchor" href="#-24">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/node.html#%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6">#</a>模块加载机制</h3>
<p>模块第一次加载后会被缓存，即多次调用  <code>require()</code>  不会导致模块的代码被执行多次，提高模块加载效率。</p>
<h4 id="-25"><a class="markdownIt-Anchor" href="#-25">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/node.html#%E5%86%85%E7%BD%AE%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD">#</a>内置模块加载</h4>
<p>内置模块加载优先级最高。</p>
<h4 id="-26"><a class="markdownIt-Anchor" href="#-26">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/node.html#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD">#</a>自定义模块加载</h4>
<p>加载自定义模块时，路径要以  <code>./</code>  或  <code>../</code>  开头，否则会作为内置模块或第三方模块加载。</p>
<p>导入自定义模块时，若省略文件扩展名，则 Node.js 会按顺序尝试加载文件：</p>
<ul>
<li>按确切的文件名加载</li>
<li>补全  <code>.js</code>  扩展名加载</li>
<li>补全  <code>.json</code>  扩展名加载</li>
<li>补全  <code>.node</code>  扩展名加载</li>
<li>报错</li>
</ul>
<h4 id="-27"><a class="markdownIt-Anchor" href="#-27">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/node.html#%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD">#</a>第三方模块加载</h4>
<ul>
<li>若导入第三方模块， Node.js 会从<strong>当前模块的父目录</strong>开始，尝试从  <code>/node_modules</code>  文件夹中加载第三方模块。</li>
<li>如果没有找到对应的第三方模块，则移动到再<strong>上一层父目录</strong>中，进行加载，直到<strong>文件系统的根目录</strong>。</li>
</ul>
<p>例如，假设在  <code>C:\Users\bruce\project\foo.js</code>  文件里调用了  <code>require('tools')</code> ，则 Node.js 会按以下顺序查找：</p>
<ul>
<li><code>C:\Users\bruce\project\node_modules\tools</code></li>
<li><code>C:\Users\bruce\node_modules\tools</code></li>
<li><code>C:\Users\node_modules\tools</code></li>
<li><code>C:\node_modules\tools</code></li>
</ul>
<h4 id="-28"><a class="markdownIt-Anchor" href="#-28">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/node.html#%E7%9B%AE%E5%BD%95%E4%BD%9C%E4%B8%BA%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD">#</a>目录作为模块加载</h4>
<p>当把目录作为模块标识符进行加载的时候，有三种加载方式：</p>
<ul>
<li>在被加载的目录下查找  <code>package.json</code>  的文件，并寻找  <code>main</code>  属性，作为  <code>require()</code>  加载的入口</li>
<li>如果没有  <code>package.json</code>  文件，或者  <code>main</code>  入口不存在或无法解析，则 Node.js 将会试图加载目录下的  <code>index.js</code>  文件。</li>
<li>若失败则报错</li>
</ul>
<hr>
<h1 id="express"><a class="markdownIt-Anchor" href="#express">#</a> Express</h1>
<p><a target="_blank" rel="noopener" href="https://www.expressjs.com.cn/">官网传送门 (opens new window)</a></p>
<blockquote>
<p>基于 Node.js 平台，快速、开放、极简的 Web 开发框架</p>
</blockquote>
<p>Express 是用于快速创建服务器的第三方模块。</p>
<h2 id="-29"><a class="markdownIt-Anchor" href="#-29">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/express.html#express-%E5%88%9D%E4%BD%93%E9%AA%8C">#</a>Express 初体验</h2>
<h3 id="-30"><a class="markdownIt-Anchor" href="#-30">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/express.html#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8">#</a>基本使用</h3>
<p>安装 Express：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> express<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>创建服务器，监听客户端请求，并返回内容：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token comment">// 创建 web 服务器</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 监听客户端的 GET 和 POST 请求，并向客户端响应具体的内容</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/user'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> name<span class="token operator">:</span> <span class="token string">'zs'</span><span class="token punctuation">,</span> age<span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span> gender<span class="token operator">:</span> <span class="token string">'男'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/user'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'请求成功'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 通过 req.query 可以获取到客户端发送过来的查询参数</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>query<span class="token punctuation">)</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>query<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

<span class="token comment">// 这里的 :id 是一个动态的参数</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/user/:ids/:username'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// req.params 是动态匹配到的 URL 参数，默认是一个空对象</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">)</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'express server running at http://127.0.0.1'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-31"><a class="markdownIt-Anchor" href="#-31">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/express.html#%E6%89%98%E7%AE%A1%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90">#</a>托管静态资源</h3>
<ul>
<li>通过  <code>express.static()</code>  方法可创建静态资源服务器，向外开放访问静态资源。</li>
<li>Express 在指定的静态目录中查找文件，并对外提供资源的访问路径，存放静态文件的目录名不会出现在 URL 中</li>
<li>访问静态资源时，会根据托管顺序查找文件</li>
<li>可为静态资源访问路径添加前缀</li>
</ul>
<pre class="line-numbers language-js" data-language="js"><code class="language-js">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span><span class="token string">'public'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span><span class="token string">'files'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/bruce'</span><span class="token punctuation">,</span> express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span><span class="token string">'bruce'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">/*
可直接访问 public, files 目录下的静态资源
http://localhost:3000/images/bg.jpg
http://localhost:3000/css/style.css
http://localhost:3000/js/login.js

通过带有 /bruce 前缀的地址访问 bruce 目录下的文件
http://localhost:8080/bruce/images/logo.png
*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<h2 id="-32"><a class="markdownIt-Anchor" href="#-32">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/express.html#express-%E8%B7%AF%E7%94%B1">#</a>Express 路由</h2>
<p>创建路由模块：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// router.js</span>

<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token comment">// 创建路由对象</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 挂载具体路由</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/user/list'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Get user list.'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/user/add'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Add new user.'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

<span class="token comment">// 向外导出路由对象</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注册路由模块：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./router'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 注册路由模块，添加访问前缀</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/api'</span><span class="token punctuation">,</span> router<span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'http://127.0.0.1'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<h2 id="-33"><a class="markdownIt-Anchor" href="#-33">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/express.html#express-%E4%B8%AD%E9%97%B4%E4%BB%B6">#</a>Express 中间件</h2>
<ul>
<li>中间件是指流程的中间处理环节</li>
<li>服务器收到请求后，可先调用中间件进行预处理</li>
<li>中间件是一个函数，包含  <code>req, res, next</code>  三个参数， <code>next()</code>  参数把流转关系交给下一个中间件或路由</li>
</ul>
<p>中间件注意事项；</p>
<ul>
<li>在注册路由之前注册中间件（错误级别中间件除外）</li>
<li>中间件可连续调用多个</li>
<li>别忘记调用  <code>next()</code>  函数</li>
<li><code>next()</code>  函数后别写代码</li>
<li>多个中间件共享  <code>req</code> 、  <code>res</code>  对象</li>
</ul>
<h3 id="-34"><a class="markdownIt-Anchor" href="#-34">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/express.html#%E5%85%A8%E5%B1%80%E4%B8%AD%E9%97%B4%E4%BB%B6">#</a>全局中间件</h3>
<ul>
<li>通过  <code>app.use()</code>  定义的中间件为全局中间件</li>
</ul>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 定义第一个全局中间件</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'调用了第1个全局中间件'</span><span class="token punctuation">)</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token comment">// 定义第二个全局中间件</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'调用了第2个全局中间件'</span><span class="token punctuation">)</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/user'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'User page.'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'http://127.0.0.1'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-35"><a class="markdownIt-Anchor" href="#-35">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/express.html#%E5%B1%80%E9%83%A8%E4%B8%AD%E9%97%B4%E4%BB%B6">#</a>局部中间件</h3>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 定义中间件函数</span>
<span class="token keyword">const</span> <span class="token function-variable function">mw1</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'调用了第一个局部生效的中间件'</span><span class="token punctuation">)</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">const</span> <span class="token function-variable function">mw2</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'调用了第二个局部生效的中间件'</span><span class="token punctuation">)</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 两种定义局部中间件的方式</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/hello'</span><span class="token punctuation">,</span> mw2<span class="token punctuation">,</span> mw1<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'hello page.'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/about'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>mw1<span class="token punctuation">,</span> mw2<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'about page.'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/user'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'User page.'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Express server running at http://127.0.0.1'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-36"><a class="markdownIt-Anchor" href="#-36">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/express.html#%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%88%86%E7%B1%BB">#</a>中间件分类</h3>
<ol>
<li>应用级别的中间件</li>
</ol>
<ul>
<li>通过  <code>app.use()</code>  或  <code>app.get()</code>  或  <code>app.post()</code>  ，绑定到  <code>app</code>  实例上的中间件</li>
</ul>
<ol>
<li>路由级别的中间件</li>
</ol>
<ul>
<li>绑定到  <code>express.Router()</code>  实例上的中间件，叫做路由级别的中间件。用法和应用级别中间件没有区别。应用级别中间件是绑定到  <code>app</code>  实例上，路由级别中间件绑定到  <code>router</code>  实例上。</li>
</ul>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> router<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li>错误级别的中间件</li>
</ol>
<ul>
<li>用来捕获整个项目中发生的异常错误，从而防止项目异常崩溃的问题</li>
<li>错误级别中间件的处理函数中，必须有 4 个形参，形参顺序从前到后分别是  <code>(err, req, res, next)</code>  。</li>
<li>错误级别的中间件必须注册在所有路由之后</li>
</ul>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'服务器内部发生了错误！'</span><span class="token punctuation">)</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Home page.'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

<span class="token comment">// 定义错误级别的中间件，捕获整个项目的异常错误，从而防止程序的崩溃</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'发生了错误！'</span> <span class="token operator">+</span> err<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Error：'</span> <span class="token operator">+</span> err<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Express server running at http://127.0.0.1'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li>Express 内置中间件</li>
</ol>
<p>自 Express 4.16.0 版本开始，Express 内置了 3 个常用的中间件，极大的提高了 Express 项目的开发效率和体验：</p>
<ul>
<li><code>express.static</code>  快速托管静态资源的内置中间件，例如： HTML 文件、图片、CSS 样式等（无兼容性）</li>
<li><code>express.json</code>  解析 JSON 格式的请求体数据（有兼容性，仅在 4.16.0+ 版本中可用）</li>
<li><code>express.urlencoded</code>  解析 URL-encoded 格式的请求体数据（有兼容性，仅在 4.16.0+ 版本中可用）</li>
</ul>
<pre class="line-numbers language-js" data-language="js"><code class="language-js">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> extended<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<ol>
<li>第三方中间件</li>
</ol>
<hr>
<h2 id="-37"><a class="markdownIt-Anchor" href="#-37">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/express.html#cors-%E8%B7%A8%E5%9F%9F%E8%B5%84%E6%BA%90%E5%85%B1%E4%BA%AB">#</a>CORS 跨域资源共享</h2>
<h3 id="-38"><a class="markdownIt-Anchor" href="#-38">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/express.html#cors-%E4%B8%AD%E9%97%B4%E4%BB%B6%E8%A7%A3%E5%86%B3%E8%B7%A8%E5%9F%9F">#</a>cors 中间件解决跨域</h3>
<ul>
<li>安装中间件： <code>npm install cors</code></li>
<li>导入中间件： <code>const cors = require('cors')</code></li>
<li>配置中间件： <code>app.use(cors)</code></li>
</ul>
<h3 id="-39"><a class="markdownIt-Anchor" href="#-39">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/express.html#cors">#</a>CORS</h3>
<ul>
<li>CORS（Cross-Origin Resource Sharing，跨域资源共享）解决跨域，是通过 HTTP 响应头决定浏览器是否阻止前端 JS 代码跨域获取资源</li>
<li>浏览器的同源安全策略默认会阻止网页 “跨域” 获取资源。但如果接口服务器配置了 CORS 相关的 HTTP 响应头，就可解除浏览器端的跨域访问限制</li>
<li>CORS 主要在服务器端进行配置。客户端浏览器无须做任何额外的配置，即可请求开启了 CORS 的接口。</li>
<li>CORS 在浏览器中有兼容性。只有支持 XMLHttpRequest Level2 的浏览器，才能正常访问开启了 CORS 的服务端接口（例如：IE10+、Chrome4+、FireFox3.5+）。</li>
</ul>
<h3 id="-40"><a class="markdownIt-Anchor" href="#-40">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/express.html#cors-%E5%B8%B8%E8%A7%81%E5%93%8D%E5%BA%94%E5%A4%B4">#</a>CORS 常见响应头</h3>
<ul>
<li><code>Access-Control-Allow-Origin</code> ：制定了允许访问资源的外域 URL</li>
</ul>
<pre class="line-numbers language-js" data-language="js"><code class="language-js">res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Access-Control-Allow-Origin'</span><span class="token punctuation">,</span> <span class="token string">'http://bruceblog.io'</span><span class="token punctuation">)</span>
res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Access-Control-Allow-Origin'</span><span class="token punctuation">,</span> <span class="token string">'*'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<ul>
<li><code>Access-Control-Allow-Headers</code></li>
<li>默认情况下，CORS 仅支持客户端向服务器发送如下的 9 个请求头： <code>Accept、Accept-Language、Content-Language、DPR、Downlink、Save-Data、Viewport-Width、Width 、Content-Type （值仅限于 text/plain、multipart/form-data、application/x-www-form-urlencoded 三者之一）</code></li>
<li>如果客户端向服务器发送了额外的请求头信息，则需要在服务器端，通过 A <code>ccess-Control-Allow-Headers</code>  对额外的请求头进行声明，否则这次请求会失败！</li>
</ul>
<pre class="line-numbers language-js" data-language="js"><code class="language-js">res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Access-Control-Allow-Headers'</span><span class="token punctuation">,</span> <span class="token string">'Content-Type, X-Custom-Header'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li><code>Access-Control-Allow-Methods</code></li>
<li>默认情况下，CORS 仅支持客户端发起 GET、POST、HEAD 请求。如果客户端希望通过 PUT、DELETE 等方式请求服务器的资源，则需要在服务器端，通过  <code>Access-Control-Alow-Methods</code>  来指明实际请求所允许使用的 HTTP 方法</li>
</ul>
<pre class="line-numbers language-js" data-language="js"><code class="language-js">res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Access-Control-Allow-Methods'</span><span class="token punctuation">,</span> <span class="token string">'POST, GET, DELETE, HEAD'</span><span class="token punctuation">)</span>
res<span class="token punctuation">.</span><span class="token function">setHEader</span><span class="token punctuation">(</span><span class="token string">'Access-Control-Allow-Methods'</span><span class="token punctuation">,</span> <span class="token string">'*'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="-41"><a class="markdownIt-Anchor" href="#-41">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/express.html#cors-%E8%AF%B7%E6%B1%82%E5%88%86%E7%B1%BB">#</a>CORS 请求分类</h3>
<h4 id="-42"><a class="markdownIt-Anchor" href="#-42">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/express.html#%E7%AE%80%E5%8D%95%E8%AF%B7%E6%B1%82">#</a>简单请求</h4>
<ul>
<li>请求方式：GET、POST、HEAD 三者之一</li>
<li>HTTP 头部信息不超过以下几种字段：无自定义头部字段、Accept、Accept-Language、Content-Language、DPR、Downlink、Save-Data、Viewport-Width、Width 、Content-Type（只有三个值 application/x-www-formurlencoded、multipart/form-data、text/plain）</li>
</ul>
<h4 id="-43"><a class="markdownIt-Anchor" href="#-43">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/express.html#%E9%A2%84%E6%A3%80%E8%AF%B7%E6%B1%82">#</a>预检请求</h4>
<ul>
<li>请求方式为 GET、POST、HEAD 之外的请求 Method 类型</li>
<li>请求头中包含自定义头部字段</li>
<li>向服务器发送了 application/json 格式的数据</li>
</ul>
<p>在浏览器与服务器正式通信之前，浏览器会先发送 OPTION 请求进行预检，以获知服务器是否允许该实际请求，所以这一次的 OPTION 请求称为 “预检请求”。服务器成功响应预检请求后，才会发送真正的请求，并且携带真实数据</p>
<hr>
<h1 id="数据库和身份认证"><a class="markdownIt-Anchor" href="#数据库和身份认证">#</a> 数据库和身份认证</h1>
<h2 id="-44"><a class="markdownIt-Anchor" href="#-44">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/mysql.html#node-%E6%93%8D%E4%BD%9C-mysql">#</a>Node 操作 mysql</h2>
<h3 id="-45"><a class="markdownIt-Anchor" href="#-45">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/mysql.html#%E9%85%8D%E7%BD%AE-mysql-%E6%A8%A1%E5%9D%97">#</a>配置 mysql 模块</h3>
<ol>
<li>安装 mysql 模块</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> mysql<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ol>
<li>建立连接</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> mysql <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mysql'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> db <span class="token operator">=</span> mysql<span class="token punctuation">.</span><span class="token function">createPool</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  host<span class="token operator">:</span> <span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span>
  user<span class="token operator">:</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
  password<span class="token operator">:</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
  database<span class="token operator">:</span> <span class="token string">'test'</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li>测试是否正常工作</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js">db<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'select 1'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-46"><a class="markdownIt-Anchor" href="#-46">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/mysql.html#%E6%93%8D%E4%BD%9C-mysql-%E6%95%B0%E6%8D%AE%E5%BA%93">#</a>操作 mysql 数据库</h3>
<ol>
<li>查询数据</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js">db<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'select * from users'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token operator">...</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<ol>
<li>插入数据</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// ? 表示占位符</span>
<span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token string">'insert into users values(?, ?)'</span>
<span class="token comment">// 使用数组的形式为占位符指定具体的值</span>
db<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token punctuation">[</span>username<span class="token punctuation">,</span> password<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>results<span class="token punctuation">.</span>affectedRows <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'插入成功'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>向表中新增数据时，如果数据对象的每个属性和数据表的字段一一对应，则可以通过如下方式快速插入数据：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token punctuation">&#123;</span>username<span class="token operator">:</span><span class="token string">'Bruce'</span><span class="token punctuation">,</span> password<span class="token operator">:</span><span class="token string">'55520'</span><span class="token punctuation">&#125;</span>
<span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token string">'insert into users set ?'</span>
db<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> user<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token operator">...</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li>更新数据</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token string">'update users set username=?, password=? where id=?'</span>
db<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token punctuation">[</span>username<span class="token punctuation">,</span> password<span class="token punctuation">,</span> id<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token operator">...</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>快捷方式：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token punctuation">&#123;</span>id<span class="token operator">:</span><span class="token number">7</span><span class="token punctuation">,</span>username<span class="token operator">:</span><span class="token string">'Bruce'</span><span class="token punctuation">,</span>password<span class="token operator">:</span><span class="token string">'55520'</span><span class="token punctuation">&#125;</span>
<span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token string">'update users set ? where id=?'</span>
db<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token punctuation">[</span>user<span class="token punctuation">,</span> user<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token operator">...</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li>删除数据</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token string">'delete from users where id=?'</span>
db<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> id<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token operator">...</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>使用 delete 语句会真正删除数据，保险起见，使用标记删除的形式，模拟删除的动作。即在表中设置状态字段，标记当前的数据是否被删除。</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js">db<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'update users set status=1 where id=?'</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token operator">...</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<hr>
<h2 id="-47"><a class="markdownIt-Anchor" href="#-47">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/mysql.html#web-%E5%BC%80%E5%8F%91%E6%A8%A1%E5%BC%8F">#</a>Web 开发模式</h2>
<h3 id="-48"><a class="markdownIt-Anchor" href="#-48">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/mysql.html#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%B8%B2%E6%9F%93">#</a>服务端渲染</h3>
<p>服务器发送给客户端的 HTML 页面，是在服务器通过字符串的拼接动态生成的。因此客户端不需要使用 Ajax 额外请求页面的数据。</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js">app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/index.html'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token punctuation">&#123;</span> name<span class="token operator">:</span> <span class="token string">'Bruce'</span><span class="token punctuation">,</span> age<span class="token operator">:</span> <span class="token number">29</span> <span class="token punctuation">&#125;</span>
  <span class="token keyword">const</span> html <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;h1>username:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>user<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">, age:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>user<span class="token punctuation">.</span>age<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">&lt;/h1></span><span class="token template-punctuation string">`</span></span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>优点：</p>
<ul>
<li>前端耗时短。浏览器只需直接渲染页面，无需额外请求数据。</li>
<li>有利于 SEO。服务器响应的是完整的 HTML 页面内容，有利于爬虫爬取信息。</li>
</ul>
<p>缺点：</p>
<ul>
<li>占用服务器资源。服务器需要完成页面内容的拼接，若请求比较多，会对服务器造成一定访问压力。</li>
<li>不利于前后端分离，开发效率低。</li>
</ul>
<h3 id="-49"><a class="markdownIt-Anchor" href="#-49">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/mysql.html#%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB">#</a>前后端分离</h3>
<p>前后端分离的开发模式，依赖于 Ajax 技术的广泛应用。后端只负责提供 API 接口，前端使用 Ajax 调用接口。</p>
<p>优点：</p>
<ul>
<li>开发体验好。前端专业页面开发，后端专注接口开发。</li>
<li>用户体验好。页面局部刷新，无需重新请求页面。</li>
<li>减轻服务器的渲染压力。页面最终在浏览器里生成。</li>
</ul>
<p>缺点：</p>
<ul>
<li>不利于 SEO。完整的 HTML 页面在浏览器拼接完成，因此爬虫无法爬取页面的有效信息。Vue、React 等框架的 SSR（server side render）技术能解决 SEO 问题。</li>
</ul>
<h3 id="-50"><a class="markdownIt-Anchor" href="#-50">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/mysql.html#%E5%A6%82%E4%BD%95%E9%80%89%E6%8B%A9">#</a>如何选择</h3>
<ul>
<li>企业级网站，主要功能是展示，没有复杂交互，且需要良好的 SEO，可考虑服务端渲染</li>
<li>后台管理项目，交互性强，无需考虑 SEO，可使用前后端分离</li>
<li>为同时兼顾首页渲染速度和前后端分离开发效率，可采用首屏服务器端渲染 + 其他页面前后端分离的开发模式</li>
</ul>
<hr>
<h2 id="-51"><a class="markdownIt-Anchor" href="#-51">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/mysql.html#%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81">#</a>身份认证</h2>
<h3 id="-52"><a class="markdownIt-Anchor" href="#-52">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/mysql.html#session-%E8%AE%A4%E8%AF%81%E6%9C%BA%E5%88%B6">#</a>Session 认证机制</h3>
<p>服务端渲染推荐使用 Session 认证机制</p>
<h4 id="-53"><a class="markdownIt-Anchor" href="#-53">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/mysql.html#session-%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86">#</a>Session 工作原理</h4>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/Session.c66d5499.png" alt="session"></p>
<h4 id="-54"><a class="markdownIt-Anchor" href="#-54">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/mysql.html#express-%E4%B8%AD%E4%BD%BF%E7%94%A8-session-%E8%AE%A4%E8%AF%81">#</a>Express 中使用 Session 认证</h4>
<ol>
<li>安装 express-session 中间件</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> express-session<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ol>
<li>配置中间件</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> session <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express-session'</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>
  <span class="token function">session</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
    secret<span class="token operator">:</span> <span class="token string">'Bruce'</span><span class="token punctuation">,</span> <span class="token comment">// secret 的值为任意字符串</span>
    resave<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    saveUninitalized<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li>向 session 中存数据</li>
</ol>
<p>中间件配置成功后，可通过  <code>req.session</code>  访问 session 对象，存储用户信息</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js">app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/login'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>user <span class="token operator">=</span> req<span class="token punctuation">.</span>body
  req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>isLogin <span class="token operator">=</span> <span class="token boolean">true</span>

  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> status<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> msg<span class="token operator">:</span> <span class="token string">'login done'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li>从 session 取数据</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js">app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/username'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>isLogin<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> status<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> msg<span class="token operator">:</span> <span class="token string">'fail'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> status<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> msg<span class="token operator">:</span> <span class="token string">'success'</span><span class="token punctuation">,</span> username<span class="token operator">:</span> req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>user<span class="token punctuation">.</span>username <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li>清空 session</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js">app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/logout'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 清空当前客户端的session信息</span>
  req<span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> status<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> msg<span class="token operator">:</span> <span class="token string">'logout done'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-55"><a class="markdownIt-Anchor" href="#-55">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/mysql.html#jwt-%E8%AE%A4%E8%AF%81%E6%9C%BA%E5%88%B6">#</a>JWT 认证机制</h3>
<p>前后端分离推荐使用 JWT（JSON Web Token）认证机制，是目前最流行的跨域认证解决方案</p>
<h4 id="-56"><a class="markdownIt-Anchor" href="#-56">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/mysql.html#jwt-%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86">#</a>JWT 工作原理</h4>
<p>Session 认证的局限性：</p>
<ul>
<li>Session 认证机制需要配合 Cookie 才能实现。由于 Cookie 默认不支持跨域访问，所以，当涉及到前端跨域请求后端接口的时候，需要做很多额外的配置，才能实现跨域 Session 认证。</li>
<li>当前端请求后端接口不存在跨域问题的时候，推荐使用 Session 身份认证机制。</li>
<li>当前端需要跨域请求后端接口的时候，不推荐使用 Session 身份认证机制，推荐使用 JWT 认证机制</li>
</ul>
<p>JWT 工作原理图：</p>
<p>用户的信息通过 Token 字符串的形式，保存在客户端浏览器中。服务器通过还原 Token 字符串的形式来认证用户的身份。</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/JWT.6a82c41d.png" alt="JWT"></p>
<p>JWT 组成部分：</p>
<ul>
<li>Header、Payload、Signature</li>
<li>Payload 是真正的用户信息，加密后的字符串</li>
<li>Header 和 Signature 是安全性相关部分，保证 Token 安全性</li>
<li>三者使用  <code>.</code>  分隔</li>
</ul>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Header.Payload.Signature

eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MTcsInVzZXJuYW1lIjoiQnJ1Y2UiLCJwYXNzd29yZCI6IiIsIm5pY2tuYW1lIjoiaGVsbG8iLCJlbWFpbCI6InNjdXRAcXEuY29tIiwidXNlcl9waWMiOiIiLCJpYXQiOjE2NDE4NjU3MzEsImV4cCI6MTY0MTkwMTczMX0.bmqzAkNSZgD8IZxRGGyVlVwGl7EGMtWitvjGD-a5U5c<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>JWT 使用方式：</p>
<ul>
<li>客户端会把 JWT 存储在 localStorage 或 sessionStorage 中</li>
<li>此后客户端与服务端通信需要携带 JWT 进行身份认证，将 JWT 存在 HTTP 请求头 Authorization 字段中</li>
<li>加上 Bearer 前缀</li>
</ul>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">Authorization: Bearer &lt;token> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="-57"><a class="markdownIt-Anchor" href="#-57">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/mysql.html#express-%E4%BD%BF%E7%94%A8-jwt">#</a>Express 使用 JWT</h4>
<ol>
<li>安装</li>
</ol>
<ul>
<li>jsonwebtoken 用于生成 JWT 字符串</li>
<li>express-jwt 用于将 JWT 字符串解析还原成 JSON 对象</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> jsonwebtoken express-jwt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ol>
<li>定义 secret 密钥</li>
</ol>
<ul>
<li>为保证 JWT 字符串的安全性，防止其在网络传输过程中被破解，需定义用于加密和解密的 secret 密钥</li>
<li>生成 JWT 字符串时，使用密钥加密信息，得到加密好的 JWT 字符串</li>
<li>把 JWT 字符串解析还原成 JSON 对象时，使用密钥解密</li>
</ul>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> jwt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'jsonwebtoken'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> expressJWT <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express-jwt'</span><span class="token punctuation">)</span>

<span class="token comment">// 密钥为任意字符串</span>
<span class="token keyword">const</span> secretKey <span class="token operator">=</span> <span class="token string">'Bruce'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li>生成 JWT 字符串</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js">app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/login'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token operator">...</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
    status<span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
    message<span class="token operator">:</span> <span class="token string">'登录成功'</span><span class="token punctuation">,</span>
    <span class="token comment">// jwt.sign() 生成 JWT 字符串</span>
    <span class="token comment">// 参数：用户信息对象、加密密钥、配置对象-token有效期</span>
    <span class="token comment">// 尽量不保存敏感信息，因此只有用户名，没有密码</span>
    token<span class="token operator">:</span> jwt<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>username<span class="token operator">:</span> userInfo<span class="token punctuation">.</span>username<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> secretKey<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>expiresIn<span class="token operator">:</span> <span class="token string">'10h'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li>JWT 字符串还原为 JSON 对象</li>
</ol>
<ul>
<li>客户端访问有权限的接口时，需通过请求头的  <code>Authorization</code>  字段，将 Token 字符串发送到服务器进行身份认证</li>
<li>服务器可以通过 express-jwt 中间件将客户端发送过来的 Token 解析还原成 JSON 对象</li>
</ul>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// unless(&#123; path: [/^\/api\//] &#125;) 指定哪些接口无需访问权限</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">expressJWT</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> secret<span class="token operator">:</span> secretKey <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unless</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> path<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\/api\/</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">]</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<ol>
<li>获取用户信息</li>
</ol>
<ul>
<li>当 express-jwt 中间件配置成功后，即可在那些有权限的接口中，使用  <code>req.user</code>  对象，来访问从 JWT 字符串中解析出来的用户信息</li>
</ul>
<pre class="line-numbers language-js" data-language="js"><code class="language-js">app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/admin/getinfo'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>user<span class="token punctuation">)</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
    status<span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
    message<span class="token operator">:</span> <span class="token string">'获取信息成功'</span><span class="token punctuation">,</span>
    data<span class="token operator">:</span> req<span class="token punctuation">.</span>user<span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li>捕获解析 JWT 失败后产生的错误</li>
</ol>
<ul>
<li>当使用 express-jwt 解析 Token 字符串时，如果客户端发送过来的 Token 字符串过期或不合法，会产生一个解析失败的错误，影响项目的正常运行</li>
<li>通过 Express 的错误中间件，捕获这个错误并进行相关的处理</li>
</ul>
<pre class="line-numbers language-js" data-language="js"><code class="language-js">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">'UnauthorizedError'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> status<span class="token operator">:</span> <span class="token number">401</span><span class="token punctuation">,</span> message<span class="token operator">:</span> <span class="token string">'Invalid token'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> status<span class="token operator">:</span> <span class="token number">500</span><span class="token punctuation">,</span> message<span class="token operator">:</span> <span class="token string">'Unknown error'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<h1 id="大事件后台-api-项目"><a class="markdownIt-Anchor" href="#大事件后台-api-项目">#</a> 大事件后台 API 项目</h1>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.showdoc.cc/escook?page_id=3707158761215217">API 接口文档 (opens new window)</a></p>
</blockquote>
<h2 id="-58"><a class="markdownIt-Anchor" href="#-58">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_1-%E9%A1%B9%E7%9B%AE%E5%88%9D%E5%A7%8B%E5%8C%96">#</a>1. 项目初始化</h2>
<h3 id="-59"><a class="markdownIt-Anchor" href="#-59">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_1-1-%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE">#</a>1.1 创建项目</h3>
<ol>
<li>新建  <code>api_server</code>  文件夹作为项目根目录，并在项目根目录中运行如下的命令，初始化包管理配置文件：</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> init -y<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ol>
<li>运行如下的命令，安装特定版本的  <code>express</code> ：</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> i express@4.17.1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ol>
<li>在项目根目录中新建  <code>app.js</code>  作为整个项目的入口文件，并初始化如下的代码：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token comment">// 创建 express 的服务器实例</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// write your code here...</span>

<span class="token comment">// 调用 app.listen 方法，指定端口号并启动web服务器</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3007</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'api server running at http://127.0.0.1:3007'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-60"><a class="markdownIt-Anchor" href="#-60">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_1-2-%E9%85%8D%E7%BD%AE-cors-%E8%B7%A8%E5%9F%9F">#</a>1.2 配置 cors 跨域</h3>
<ol>
<li>运行如下的命令，安装  <code>cors</code>  中间件：</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> i cors@2.8.5<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ol>
<li>在  <code>app.js</code>  中导入并配置  <code>cors</code>  中间件：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> cors <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cors'</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="-61"><a class="markdownIt-Anchor" href="#-61">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_1-3-%E9%85%8D%E7%BD%AE%E8%A7%A3%E6%9E%90%E8%A1%A8%E5%8D%95%E6%95%B0%E6%8D%AE%E7%9A%84%E4%B8%AD%E9%97%B4%E4%BB%B6">#</a>1.3 配置解析表单数据的中间件</h3>
<ol>
<li>通过如下的代码，配置解析  <code>application/x-www-form-urlencoded</code>  格式的表单数据的中间件：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> extended<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="-62"><a class="markdownIt-Anchor" href="#-62">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_1-4-%E5%88%9D%E5%A7%8B%E5%8C%96%E8%B7%AF%E7%94%B1%E7%9B%B8%E5%85%B3%E7%9A%84%E6%96%87%E4%BB%B6%E5%A4%B9">#</a>1.4 初始化路由相关的文件夹</h3>
<ol>
<li>在项目根目录中，新建  <code>router</code>  文件夹，用来存放所有的 <code>路由</code> 模块</li>
</ol>
<blockquote>
<p>路由模块中，只存放客户端的请求与处理函数之间的映射关系</p>
</blockquote>
<ol>
<li>在项目根目录中，新建  <code>router_handler</code>  文件夹，用来存放所有的  <code>路由处理函数模块</code></li>
</ol>
<blockquote>
<p>路由处理函数模块中，专门负责存放每个路由对应的处理函数</p>
</blockquote>
<h3 id="-63"><a class="markdownIt-Anchor" href="#-63">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_1-5-%E5%88%9D%E5%A7%8B%E5%8C%96%E7%94%A8%E6%88%B7%E8%B7%AF%E7%94%B1%E6%A8%A1%E5%9D%97">#</a>1.5 初始化用户路由模块</h3>
<ol>
<li>在  <code>router</code>  文件夹中，新建  <code>user.js</code>  文件，作为用户的路由模块，并初始化代码：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token comment">// 创建路由对象</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 注册新用户</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/reguser'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'reguser OK'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

<span class="token comment">// 登录</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'login OK'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li>在  <code>app.js</code>  中，导入注册用户路由模块 ：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> userRouter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./router/user'</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/api'</span><span class="token punctuation">,</span> userRouter<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="-64"><a class="markdownIt-Anchor" href="#-64">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_1-6-%E6%8A%BD%E7%A6%BB%E7%94%A8%E6%88%B7%E8%B7%AF%E7%94%B1%E6%A8%A1%E5%9D%97%E4%B8%AD%E7%9A%84%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0">#</a>1.6 抽离用户路由模块中的处理函数</h3>
<blockquote>
<p>目的：为了保证  <code>路由模块</code>  的纯粹性，所有的  <code>路由处理函数</code> ，必须抽离到对应的  <code>路由处理函数模块</code>  中</p>
</blockquote>
<ol>
<li>在  <code>/router_handler/user.js</code>  中，使用  <code>exports</code>  对象，分别向外共享如下两个  <code>路由处理函数</code>  ：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">/**
 * 在这里定义和用户相关的路由处理函数，供 /router/user.js 模块进行调用
 */</span>

<span class="token comment">// 注册用户的处理函数</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">regUser</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'reguser OK'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 登录的处理函数</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">login</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'login OK'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li>将  <code>/router/user.js</code>  中的代码修改为如下结构：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 导入用户路由处理函数模块</span>
<span class="token keyword">const</span> userHandler <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../router_handler/user'</span><span class="token punctuation">)</span>

<span class="token comment">// 注册新用户</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/reguser'</span><span class="token punctuation">,</span> userHandler<span class="token punctuation">.</span>regUser<span class="token punctuation">)</span>
<span class="token comment">// 登录</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> userHandler<span class="token punctuation">.</span>login<span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<h2 id="-65"><a class="markdownIt-Anchor" href="#-65">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_2-%E7%99%BB%E5%BD%95%E6%B3%A8%E5%86%8C">#</a>2. 登录注册</h2>
<h3 id="-66"><a class="markdownIt-Anchor" href="#-66">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_2-1-%E6%96%B0%E5%BB%BA-ev-users-%E8%A1%A8">#</a>2.1 新建 ev_users 表</h3>
<ol>
<li>在  <code>test</code>  数据库中，新建  <code>ev_users</code>  表如下：</li>
</ol>
<p><img src="https://brucecai55520.gitee.io/bruceblog/assets/img/ev_users.77f8cdd3.png" alt="ev_users表结构"></p>
<h3 id="-67"><a class="markdownIt-Anchor" href="#-67">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_2-2-%E5%AE%89%E8%A3%85%E5%B9%B6%E9%85%8D%E7%BD%AE-mysql-%E6%A8%A1%E5%9D%97">#</a>2.2 安装并配置 mysql 模块</h3>
<blockquote>
<p>在 API 接口项目中，需要安装并配置  <code>mysql</code>  这个第三方模块，来连接和操作 MySQL 数据库</p>
</blockquote>
<ol>
<li>运行如下命令，安装  <code>mysql</code>  模块：</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> i mysql@2.18.1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ol>
<li>在项目根目录中新建  <code>/db/index.js</code>  文件，在此自定义模块中创建数据库的连接对象：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> mysql <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mysql'</span><span class="token punctuation">)</span>

<span class="token comment">// 创建数据库连接对象</span>
<span class="token keyword">const</span> db <span class="token operator">=</span> mysql<span class="token punctuation">.</span><span class="token function">createPool</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  host<span class="token operator">:</span> <span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span>
  user<span class="token operator">:</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
  password<span class="token operator">:</span> <span class="token string">'admin123'</span><span class="token punctuation">,</span>
  database<span class="token operator">:</span> <span class="token string">'my_db_01'</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

<span class="token comment">// 向外共享 db 数据库连接对象</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> db<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-68"><a class="markdownIt-Anchor" href="#-68">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_2-3-%E6%B3%A8%E5%86%8C">#</a>2.3 注册</h3>
<h4 id="-69"><a class="markdownIt-Anchor" href="#-69">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_2-3-0-%E5%AE%9E%E7%8E%B0%E6%AD%A5%E9%AA%A4">#</a>2.3.0 实现步骤</h4>
<ol>
<li>检测表单数据是否合法</li>
<li>检测用户名是否被占用</li>
<li>对密码进行加密处理</li>
<li>插入新用户</li>
</ol>
<h4 id="-70"><a class="markdownIt-Anchor" href="#-70">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_2-3-1-%E6%A3%80%E6%B5%8B%E8%A1%A8%E5%8D%95%E6%95%B0%E6%8D%AE%E6%98%AF%E5%90%A6%E5%90%88%E6%B3%95">#</a>2.3.1 检测表单数据是否合法</h4>
<ol>
<li>判断用户名和密码是否为空</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 接收表单数据</span>
<span class="token keyword">const</span> userinfo <span class="token operator">=</span> req<span class="token punctuation">.</span>body
<span class="token comment">// 判断数据是否合法</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>userinfo<span class="token punctuation">.</span>username <span class="token operator">||</span> <span class="token operator">!</span>userinfo<span class="token punctuation">.</span>password<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> status<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> message<span class="token operator">:</span> <span class="token string">'用户名或密码不能为空！'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-71"><a class="markdownIt-Anchor" href="#-71">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_2-3-2-%E6%A3%80%E6%B5%8B%E7%94%A8%E6%88%B7%E5%90%8D%E6%98%AF%E5%90%A6%E8%A2%AB%E5%8D%A0%E7%94%A8">#</a>2.3.2 检测用户名是否被占用</h4>
<ol>
<li>导入数据库操作模块：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> db <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../db/index'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ol>
<li>定义 SQL 语句：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">select * from ev_users where username=?</span><span class="token template-punctuation string">`</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ol>
<li>执行 SQL 语句并根据结果判断用户名是否被占用：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js">db<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token punctuation">[</span>userinfo<span class="token punctuation">.</span>username<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 执行 SQL 语句失败</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> status<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> message<span class="token operator">:</span> err<span class="token punctuation">.</span>message <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">// 用户名被占用</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>results<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> status<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> message<span class="token operator">:</span> <span class="token string">'用户名被占用，请更换其他用户名！'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">// TODO: 用户名可用，继续后续流程...</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-72"><a class="markdownIt-Anchor" href="#-72">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_2-3-3-%E5%AF%B9%E5%AF%86%E7%A0%81%E8%BF%9B%E8%A1%8C%E5%8A%A0%E5%AF%86%E5%A4%84%E7%90%86">#</a>2.3.3 对密码进行加密处理</h4>
<blockquote>
<p>为了保证密码的安全性，不建议在数据库以  <code>明文</code>  的形式保存用户密码，推荐对密码进行  <code>加密存储</code></p>
</blockquote>
<p>在当前项目中，使用  <code>bcryptjs</code>  对用户密码进行加密，优点：</p>
<ul>
<li>加密之后的密码，<strong>无法被逆向破解</strong></li>
<li>同一明文密码多次加密，得到的<strong>加密结果各不相同</strong>，保证了安全性</li>
</ul>
<ol>
<li>运行如下命令，安装指定版本的  <code>bcryptjs</code>  ：</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> i bcryptjs@2.4.3<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ol>
<li>在  <code>/router_handler/user.js</code>  中，导入  <code>bcryptjs</code>  ：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> bcrypt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'bcryptjs'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ol>
<li>在注册用户的处理函数中，确认用户名可用之后，调用  <code>bcrypt.hashSync(明文密码, 随机盐的长度)</code>  方法，对用户的密码进行加密处理：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 对用户的密码,进行 bcrype 加密，返回值是加密之后的密码字符串</span>
userinfo<span class="token punctuation">.</span>password <span class="token operator">=</span> bcrypt<span class="token punctuation">.</span><span class="token function">hashSync</span><span class="token punctuation">(</span>userinfo<span class="token punctuation">.</span>password<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h4 id="-73"><a class="markdownIt-Anchor" href="#-73">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_2-3-4-%E6%8F%92%E5%85%A5%E6%96%B0%E7%94%A8%E6%88%B7">#</a>2.3.4 插入新用户</h4>
<ol>
<li>定义插入用户的 SQL 语句：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token string">'insert into ev_users set ?'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ol>
<li>调用  <code>db.query()</code>  执行 SQL 语句，插入新用户：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js">db<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> username<span class="token operator">:</span> userinfo<span class="token punctuation">.</span>username<span class="token punctuation">,</span> password<span class="token operator">:</span> userinfo<span class="token punctuation">.</span>password <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 执行 SQL 语句失败</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> status<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> message<span class="token operator">:</span> err<span class="token punctuation">.</span>message <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  <span class="token comment">// SQL 语句执行成功，但影响行数不为 1</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>results<span class="token punctuation">.</span>affectedRows <span class="token operator">!==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> status<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> message<span class="token operator">:</span> <span class="token string">'注册用户失败，请稍后再试！'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">// 注册成功</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> status<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> message<span class="token operator">:</span> <span class="token string">'注册成功！'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-74"><a class="markdownIt-Anchor" href="#-74">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_2-4-%E4%BC%98%E5%8C%96-res-send-%E4%BB%A3%E7%A0%81">#</a>2.4 优化 res.send () 代码</h3>
<blockquote>
<p>在处理函数中，需要多次调用  <code>res.send()</code>  向客户端响应  <code>处理失败</code>  的结果，为了简化代码，可以手动封装一个 <a target="_blank" rel="noopener" href="http://res.cc">res.cc</a> () 函数</p>
</blockquote>
<ol>
<li>在  <code>app.js</code>  中，所有路由之前，声明一个全局中间件，为 res 对象挂载一个  <code>res.cc()</code>  函数 ：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 响应数据的中间件</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// status = 0 为成功； status = 1 为失败； 默认将 status 的值设置为 1，方便处理失败的情况</span>
  res<span class="token punctuation">.</span><span class="token function-variable function">cc</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> status <span class="token operator">=</span> <span class="token number">1</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
      <span class="token comment">// 状态</span>
      status<span class="token punctuation">,</span>
      <span class="token comment">// 状态描述，判断 err 是 错误对象 还是 字符串</span>
      message<span class="token operator">:</span> err <span class="token keyword">instanceof</span> <span class="token class-name">Error</span> <span class="token operator">?</span> err<span class="token punctuation">.</span>message <span class="token operator">:</span> err<span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-75"><a class="markdownIt-Anchor" href="#-75">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_2-5-%E4%BC%98%E5%8C%96%E8%A1%A8%E5%8D%95%E6%95%B0%E6%8D%AE%E9%AA%8C%E8%AF%81">#</a>2.5 优化表单数据验证</h3>
<blockquote>
<p>表单验证的原则：前端验证为辅，后端验证为主，后端<strong>永远不要相信</strong>前端提交过来的<strong>任何内容</strong></p>
</blockquote>
<p>在实际开发中，前后端都需要对表单的数据进行合法性的验证，而且，<strong>后端做为数据合法性验证的最后一个关口</strong>，在拦截非法数据方面，起到了至关重要的作用。</p>
<p>单纯的使用  <code>if...else...</code>  的形式对数据合法性进行验证，效率低下、出错率高、维护性差。因此，推荐使用<strong>第三方数据验证模块</strong>，来降低出错率、提高验证的效率与可维护性，<strong>让后端程序员把更多的精力放在核心业务逻辑的处理上</strong>。</p>
<ol>
<li>安装  <code>joi</code>  包，为表单中携带的每个数据项，定义验证规则：</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> joi<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ol>
<li>安装  <code>@escook/express-joi</code>  中间件，来实现自动对表单数据进行验证的功能：</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> i @escook/express-joi<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ol>
<li>新建  <code>/schema/user.js</code>  用户信息验证规则模块，并初始化代码如下：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> joi <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'joi'</span><span class="token punctuation">)</span>

<span class="token comment">/**
 * string() 值必须是字符串
 * alphanum() 值只能是包含 a-zA-Z0-9 的字符串
 * min(length) 最小长度
 * max(length) 最大长度
 * required() 值是必填项，不能为 undefined
 * pattern(正则表达式) 值必须符合正则表达式的规则
 */</span>

<span class="token comment">// 用户名的验证规则</span>
<span class="token keyword">const</span> username <span class="token operator">=</span> joi<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">alphanum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 密码的验证规则</span>
<span class="token keyword">const</span> password <span class="token operator">=</span> joi
  <span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">pattern</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^[\S]&#123;6,12&#125;$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 注册和登录表单的验证规则对象</span>
exports<span class="token punctuation">.</span>reg_login_schema <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 表示需要对 req.body 中的数据进行验证</span>
  body<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    username<span class="token punctuation">,</span>
    password<span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li>修改  <code>/router/user.js</code>  中的代码如下：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 导入用户路由处理函数模块</span>
<span class="token keyword">const</span> userHandler <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../router_handler/user'</span><span class="token punctuation">)</span>

<span class="token comment">// 1. 导入验证表单数据的中间件</span>
<span class="token keyword">const</span> expressJoi <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@escook/express-joi'</span><span class="token punctuation">)</span>
<span class="token comment">// 2. 导入需要的验证规则对象</span>
<span class="token keyword">const</span> <span class="token punctuation">&#123;</span> reg_login_schema <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../schema/user'</span><span class="token punctuation">)</span>

<span class="token comment">// 注册新用户</span>
<span class="token comment">// 3. 在注册新用户的路由中，声明局部中间件，对当前请求中携带的数据进行验证</span>
<span class="token comment">// 3.1 数据验证通过后，会把这次请求流转给后面的路由处理函数</span>
<span class="token comment">// 3.2 数据验证失败后，终止后续代码的执行，并抛出一个全局的 Error 错误，进入全局错误级别中间件中进行处理</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/reguser'</span><span class="token punctuation">,</span> <span class="token function">expressJoi</span><span class="token punctuation">(</span>reg_login_schema<span class="token punctuation">)</span><span class="token punctuation">,</span> userHandler<span class="token punctuation">.</span>regUser<span class="token punctuation">)</span>
<span class="token comment">// 登录</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> userHandler<span class="token punctuation">.</span>login<span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li>在  <code>app.js</code>  的全局错误级别中间件中，捕获验证失败的错误，并把验证失败的结果响应给客户端：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> joi <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'joi'</span><span class="token punctuation">)</span>

<span class="token comment">// 错误中间件</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 数据验证失败</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token keyword">instanceof</span> <span class="token class-name">joi<span class="token punctuation">.</span>ValidationError</span><span class="token punctuation">)</span> <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">cc</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
  <span class="token comment">// 未知错误</span>
  res<span class="token punctuation">.</span><span class="token function">cc</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-76"><a class="markdownIt-Anchor" href="#-76">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_2-6-%E7%99%BB%E5%BD%95">#</a>2.6 登录</h3>
<h4 id="-77"><a class="markdownIt-Anchor" href="#-77">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_2-6-0-%E5%AE%9E%E7%8E%B0%E6%AD%A5%E9%AA%A4">#</a>2.6.0 实现步骤</h4>
<ol>
<li>检测表单数据是否合法</li>
<li>根据用户名查询用户的数据</li>
<li>判断用户输入的密码是否正确</li>
<li>生成 JWT 的 Token 字符串</li>
</ol>
<h4 id="-78"><a class="markdownIt-Anchor" href="#-78">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_2-6-1-%E6%A3%80%E6%B5%8B%E7%99%BB%E5%BD%95%E8%A1%A8%E5%8D%95%E7%9A%84%E6%95%B0%E6%8D%AE%E6%98%AF%E5%90%A6%E5%90%88%E6%B3%95">#</a>2.6.1 检测登录表单的数据是否合法</h4>
<ol>
<li>将  <code>/router/user.js</code>  中  <code>登录</code>  的路由代码修改如下：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 登录的路由</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> <span class="token function">expressJoi</span><span class="token punctuation">(</span>reg_login_schema<span class="token punctuation">)</span><span class="token punctuation">,</span> userHandler<span class="token punctuation">.</span>login<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h4 id="-79"><a class="markdownIt-Anchor" href="#-79">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_2-6-2-%E6%A0%B9%E6%8D%AE%E7%94%A8%E6%88%B7%E5%90%8D%E6%9F%A5%E8%AF%A2%E7%94%A8%E6%88%B7%E7%9A%84%E6%95%B0%E6%8D%AE">#</a>2.6.2 根据用户名查询用户的数据</h4>
<ol>
<li>接收表单数据：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> userinfo <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ol>
<li>定义 SQL 语句：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">select * from ev_users where username=?</span><span class="token template-punctuation string">`</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ol>
<li>执行 SQL 语句，查询用户的数据：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js">db<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> userinfo<span class="token punctuation">.</span>username<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 执行 SQL 语句失败</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">cc</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
  <span class="token comment">// 执行 SQL 语句成功，但是查询到数据条数不等于 1</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>results<span class="token punctuation">.</span>length <span class="token operator">!==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">cc</span><span class="token punctuation">(</span><span class="token string">'登录失败！'</span><span class="token punctuation">)</span>
  <span class="token comment">// TODO：判断用户输入的登录密码是否和数据库中的密码一致</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-80"><a class="markdownIt-Anchor" href="#-80">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_2-6-3-%E5%88%A4%E6%96%AD%E7%94%A8%E6%88%B7%E8%BE%93%E5%85%A5%E7%9A%84%E5%AF%86%E7%A0%81%E6%98%AF%E5%90%A6%E6%AD%A3%E7%A1%AE">#</a>2.6.3 判断用户输入的密码是否正确</h4>
<blockquote>
<p>核心实现思路：调用  <code>bcrypt.compareSync(用户提交的密码, 数据库中的密码)</code>  方法比较密码是否一致</p>
</blockquote>
<blockquote>
<p>返回值是布尔值（true 一致、false 不一致）</p>
</blockquote>
<p>具体的实现代码如下：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 拿着用户输入的密码,和数据库中存储的密码进行对比</span>
<span class="token keyword">const</span> compareResult <span class="token operator">=</span> bcrypt<span class="token punctuation">.</span><span class="token function">compareSync</span><span class="token punctuation">(</span>userinfo<span class="token punctuation">.</span>password<span class="token punctuation">,</span> results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>password<span class="token punctuation">)</span>

<span class="token comment">// 如果对比的结果等于 false, 则证明用户输入的密码错误</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>compareResult<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">cc</span><span class="token punctuation">(</span><span class="token string">'登录失败！'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// TODO：登录成功，生成 Token 字符串</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-81"><a class="markdownIt-Anchor" href="#-81">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_2-6-4-%E7%94%9F%E6%88%90-jwt-%E7%9A%84-token-%E5%AD%97%E7%AC%A6%E4%B8%B2">#</a>2.6.4 生成 JWT 的 Token 字符串</h4>
<blockquote>
<p>核心注意点：在生成 Token 字符串的时候，一定要剔除 <strong>密码</strong> 和 <strong>头像</strong> 的值</p>
</blockquote>
<ol>
<li>通过 ES6 的高级语法，快速剔除  <code>密码</code>  和  <code>头像</code>  的值：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 剔除完毕之后，user 中只保留了用户的 id, username, nickname, email 这四个属性的值</span>
<span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token operator">...</span>results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> password<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span> user_pic<span class="token operator">:</span> <span class="token string">''</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<ol>
<li>运行如下的命令，安装生成 Token 字符串的包：</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> i jsonwebtoken@8.5.1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ol>
<li>在  <code>/router_handler/user.js</code>  模块的头部区域，导入  <code>jsonwebtoken</code>  包：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 用这个包来生成 Token 字符串</span>
<span class="token keyword">const</span> jwt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'jsonwebtoken'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<ol>
<li>创建  <code>config.js</code>  文件，并向外共享 <strong>加密</strong> 和 <strong>还原</strong> Token 的  <code>jwtSecretKey</code>  字符串：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  jwtSecretKey<span class="token operator">:</span> <span class="token string">'Bruce'</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<ol>
<li>将用户信息对象加密成 Token 字符串：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 导入配置文件</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../config'</span><span class="token punctuation">)</span>

<span class="token comment">// 生成 Token 字符串</span>
<span class="token keyword">const</span> tokenStr <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> config<span class="token punctuation">.</span>jwtSecretKey<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
  expiresIn<span class="token operator">:</span> <span class="token string">'10h'</span><span class="token punctuation">,</span> <span class="token comment">// token 有效期为 10 个小时</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li>将生成的 Token 字符串响应给客户端：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js">res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  status<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  message<span class="token operator">:</span> <span class="token string">'登录成功！'</span><span class="token punctuation">,</span>
  <span class="token comment">// 为了方便客户端使用 Token，在服务器端直接拼接上 Bearer 的前缀</span>
  token<span class="token operator">:</span> <span class="token string">'Bearer '</span> <span class="token operator">+</span> tokenStr<span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-82"><a class="markdownIt-Anchor" href="#-82">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_2-7-%E9%85%8D%E7%BD%AE%E8%A7%A3%E6%9E%90-token-%E7%9A%84%E4%B8%AD%E9%97%B4%E4%BB%B6">#</a>2.7 配置解析 Token 的中间件</h3>
<ol>
<li>运行如下的命令，安装解析 Token 的中间件：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js">npm i express<span class="token operator">-</span>jwt@<span class="token number">5.3</span><span class="token number">.3</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ol>
<li>在  <code>app.js</code>  中注册路由之前，配置解析 Token 的中间件：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 导入配置文件</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./config'</span><span class="token punctuation">)</span>

<span class="token comment">// 解析 token 的中间件</span>
<span class="token keyword">const</span> expressJWT <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express-jwt'</span><span class="token punctuation">)</span>

<span class="token comment">// 使用 .unless(&#123; path: [/^\/api\//] &#125;) 指定哪些接口不需要进行 Token 的身份认证</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">expressJWT</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> secret<span class="token operator">:</span> config<span class="token punctuation">.</span>jwtSecretKey <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unless</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> path<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\/api\/</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">]</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li>在  <code>app.js</code>  中的  <code>错误级别中间件</code>  里面，捕获并处理 Token 认证失败后的错误：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 错误中间件</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 省略其它代码...</span>

  <span class="token comment">// 捕获身份认证失败的错误</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">'UnauthorizedError'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">cc</span><span class="token punctuation">(</span><span class="token string">'身份认证失败！'</span><span class="token punctuation">)</span>

  <span class="token comment">// 未知错误...</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<h2 id="-83"><a class="markdownIt-Anchor" href="#-83">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_3-%E4%B8%AA%E4%BA%BA%E4%B8%AD%E5%BF%83">#</a>3. 个人中心</h2>
<h3 id="-84"><a class="markdownIt-Anchor" href="#-84">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_3-1-%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF">#</a>3.1 获取用户的基本信息</h3>
<h4 id="-85"><a class="markdownIt-Anchor" href="#-85">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_3-1-0-%E5%AE%9E%E7%8E%B0%E6%AD%A5%E9%AA%A4">#</a>3.1.0 实现步骤</h4>
<ol>
<li>初始化 <strong>路由</strong> 模块</li>
<li>初始化 <strong>路由处理函数</strong> 模块</li>
<li>获取用户的基本信息</li>
</ol>
<h4 id="-86"><a class="markdownIt-Anchor" href="#-86">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_3-1-1-%E5%88%9D%E5%A7%8B%E5%8C%96%E8%B7%AF%E7%94%B1%E6%A8%A1%E5%9D%97">#</a>3.1.1 初始化路由模块</h4>
<ol>
<li>创建  <code>/router/userinfo.js</code>  路由模块，并初始化如下的代码结构：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 导入 express</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token comment">// 创建路由对象</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 获取用户的基本信息</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/userinfo'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

<span class="token comment">// 向外共享路由对象</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li>在  <code>app.js</code>  中导入并使用个人中心的路由模块：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 导入并使用用户信息路由模块</span>
<span class="token keyword">const</span> userinfoRouter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./router/userinfo'</span><span class="token punctuation">)</span>
<span class="token comment">// 注意：以 /my 开头的接口，都是有权限的接口，需要进行 Token 身份认证</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/my'</span><span class="token punctuation">,</span> userinfoRouter<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-87"><a class="markdownIt-Anchor" href="#-87">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_3-1-2-%E5%88%9D%E5%A7%8B%E5%8C%96%E8%B7%AF%E7%94%B1%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0%E6%A8%A1%E5%9D%97">#</a>3.1.2 初始化路由处理函数模块</h4>
<ol>
<li>创建  <code>/router_handler/userinfo.js</code>  路由处理函数模块，并初始化如下的代码结构：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 获取用户基本信息的处理函数</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">getUserInfo</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li>修改  <code>/router/userinfo.js</code>  中的代码如下：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 导入用户信息的处理函数模块</span>
<span class="token keyword">const</span> userinfo_handler <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../router_handler/userinfo'</span><span class="token punctuation">)</span>

<span class="token comment">// 获取用户的基本信息</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/userinfo'</span><span class="token punctuation">,</span> userinfo_handler<span class="token punctuation">.</span>getUserInfo<span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-88"><a class="markdownIt-Anchor" href="#-88">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_3-1-3-%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF">#</a>3.1.3 获取用户的基本信息</h4>
<ol>
<li>在  <code>/router_handler/userinfo.js</code>  头部导入数据库操作模块：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 导入数据库操作模块</span>
<span class="token keyword">const</span> db <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../db/index'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<ol>
<li>定义 SQL 语句：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 根据用户的 id，查询用户的基本信息</span>
<span class="token comment">// 注意：为了防止用户的密码泄露，需要排除 password 字段</span>
<span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">select id, username, nickname, email, user_pic from ev_users where id=?</span><span class="token template-punctuation string">`</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<ol>
<li>调用  <code>db.query()</code>  执行 SQL 语句：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 注意：req 对象上的 user 属性，是 Token 解析成功，express-jwt 中间件帮我们挂载上去的</span>
db<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> req<span class="token punctuation">.</span>user<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 1. 执行 SQL 语句失败</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">cc</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>

  <span class="token comment">// 2. 执行 SQL 语句成功，但是查询到的数据条数不等于 1</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>results<span class="token punctuation">.</span>length <span class="token operator">!==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">cc</span><span class="token punctuation">(</span><span class="token string">'获取用户信息失败！'</span><span class="token punctuation">)</span>

  <span class="token comment">// 3. 将用户信息响应给客户端</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
    status<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    message<span class="token operator">:</span> <span class="token string">'获取用户基本信息成功！'</span><span class="token punctuation">,</span>
    data<span class="token operator">:</span> results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-89"><a class="markdownIt-Anchor" href="#-89">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_3-2-%E6%9B%B4%E6%96%B0%E7%94%A8%E6%88%B7%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF">#</a>3.2 更新用户的基本信息</h3>
<h4 id="-90"><a class="markdownIt-Anchor" href="#-90">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_3-2-0-%E5%AE%9E%E7%8E%B0%E6%AD%A5%E9%AA%A4">#</a>3.2.0 实现步骤</h4>
<ol>
<li>定义路由和处理函数</li>
<li>验证表单数据</li>
<li>实现更新用户基本信息的功能</li>
</ol>
<h4 id="-91"><a class="markdownIt-Anchor" href="#-91">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_3-2-1-%E5%AE%9A%E4%B9%89%E8%B7%AF%E7%94%B1%E5%92%8C%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0">#</a>3.2.1 定义路由和处理函数</h4>
<ol>
<li>在  <code>/router/userinfo.js</code>  模块中，新增  <code>更新用户基本信息</code>  的路由：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 更新用户的基本信息</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/userinfo'</span><span class="token punctuation">,</span> userinfo_handler<span class="token punctuation">.</span>updateUserInfo<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<ol>
<li>在  <code>/router_handler/userinfo.js</code>  模块中，定义并向外共享  <code>更新用户基本信息</code>  的路由处理函数：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 更新用户基本信息的处理函数</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">updateUserInfo</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-92"><a class="markdownIt-Anchor" href="#-92">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_3-2-2-%E9%AA%8C%E8%AF%81%E8%A1%A8%E5%8D%95%E6%95%B0%E6%8D%AE">#</a>3.2.2 验证表单数据</h4>
<ol>
<li>在  <code>/schema/user.js</code>  验证规则模块中，定义  <code>id</code> ， <code>nickname</code> ， <code>email</code>  的验证规则如下：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 定义 id, nickname, emial 的验证规则</span>
<span class="token keyword">const</span> id <span class="token operator">=</span> joi<span class="token punctuation">.</span><span class="token function">number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">integer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> nickname <span class="token operator">=</span> joi<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> email <span class="token operator">=</span> joi<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">email</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li>并使用  <code>exports</code>  向外共享如下的  <code>验证规则对象</code> ：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 验证规则对象 - 更新用户基本信息</span>
exports<span class="token punctuation">.</span>update_userinfo_schema <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  body<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    id<span class="token punctuation">,</span>
    nickname<span class="token punctuation">,</span>
    email<span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li>在  <code>/router/userinfo.js</code>  模块中，导入验证数据合法性的中间件：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 导入验证数据合法性的中间件</span>
<span class="token keyword">const</span> expressJoi <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@escook/express-joi'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<ol>
<li>在  <code>/router/userinfo.js</code>  模块中，导入需要的验证规则对象：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 导入需要的验证规则对象</span>
<span class="token keyword">const</span> <span class="token punctuation">&#123;</span> update_userinfo_schema <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../schema/user'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<ol>
<li>在  <code>/router/userinfo.js</code>  模块中，修改  <code>更新用户的基本信息</code>  的路由如下：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 更新用户的基本信息</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/userinfo'</span><span class="token punctuation">,</span> <span class="token function">expressJoi</span><span class="token punctuation">(</span>update_userinfo_schema<span class="token punctuation">)</span><span class="token punctuation">,</span> userinfo_handler<span class="token punctuation">.</span>updateUserInfo<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h4 id="-93"><a class="markdownIt-Anchor" href="#-93">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_3-2-3-%E5%AE%9E%E7%8E%B0%E6%9B%B4%E6%96%B0%E7%94%A8%E6%88%B7%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF%E7%9A%84%E5%8A%9F%E8%83%BD">#</a>3.2.3 实现更新用户基本信息的功能</h4>
<ol>
<li>定义待执行的 SQL 语句：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">update ev_users set ? where id=?</span><span class="token template-punctuation string">`</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ol>
<li>调用  <code>db.query()</code>  执行 SQL 语句并传参：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js">db<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token punctuation">[</span>req<span class="token punctuation">.</span>body<span class="token punctuation">,</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 执行 SQL 语句失败</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">cc</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>

  <span class="token comment">// 执行 SQL 语句成功，但影响行数不为 1</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>results<span class="token punctuation">.</span>affectedRows <span class="token operator">!==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">cc</span><span class="token punctuation">(</span><span class="token string">'修改用户基本信息失败！'</span><span class="token punctuation">)</span>

  <span class="token comment">// 修改用户信息成功</span>
  <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">cc</span><span class="token punctuation">(</span><span class="token string">'修改用户基本信息成功！'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-94"><a class="markdownIt-Anchor" href="#-94">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_3-3-%E9%87%8D%E7%BD%AE%E5%AF%86%E7%A0%81">#</a>3.3 重置密码</h3>
<h4 id="-95"><a class="markdownIt-Anchor" href="#-95">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_3-3-0-%E5%AE%9E%E7%8E%B0%E6%AD%A5%E9%AA%A4">#</a>3.3.0 实现步骤</h4>
<ol>
<li>定义路由和处理函数</li>
<li>验证表单数据</li>
<li>实现重置密码的功能</li>
</ol>
<h4 id="-96"><a class="markdownIt-Anchor" href="#-96">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_3-3-1-%E5%AE%9A%E4%B9%89%E8%B7%AF%E7%94%B1%E5%92%8C%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0">#</a>3.3.1 定义路由和处理函数</h4>
<ol>
<li>在  <code>/router/userinfo.js</code>  模块中，新增  <code>重置密码</code>  的路由：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 重置密码的路由</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/updatepwd'</span><span class="token punctuation">,</span> userinfo_handler<span class="token punctuation">.</span>updatePassword<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<ol>
<li>在  <code>/router_handler/userinfo.js</code>  模块中，定义并向外共享  <code>重置密码</code>  的路由处理函数：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 重置密码的处理函数</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">updatePassword</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-97"><a class="markdownIt-Anchor" href="#-97">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_3-3-2-%E9%AA%8C%E8%AF%81%E8%A1%A8%E5%8D%95%E6%95%B0%E6%8D%AE">#</a>3.3.2 验证表单数据</h4>
<blockquote>
<p>核心验证思路：旧密码与新密码，必须符合密码的验证规则，并且新密码不能与旧密码一致！</p>
</blockquote>
<ol>
<li>在  <code>/schema/user.js</code>  模块中，使用  <code>exports</code>  向外共享如下的  <code>验证规则对象</code> ：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 验证规则对象 - 重置密码</span>
exports<span class="token punctuation">.</span>update_password_schema <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  body<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 使用 password 这个规则，验证 req.body.oldPwd 的值</span>
    oldPwd<span class="token operator">:</span> password<span class="token punctuation">,</span>
    <span class="token comment">// 使用 joi.not(joi.ref('oldPwd')).concat(password) 规则，验证 req.body.newPwd 的值</span>
    <span class="token comment">// 解读：</span>
    <span class="token comment">// 1. joi.ref('oldPwd') 表示 newPwd 的值必须和 oldPwd 的值保持一致</span>
    <span class="token comment">// 2. joi.not(joi.ref('oldPwd')) 表示 newPwd 的值不能等于 oldPwd 的值</span>
    <span class="token comment">// 3. .concat() 用于合并 joi.not(joi.ref('oldPwd')) 和 password 这两条验证规则</span>
    newPwd<span class="token operator">:</span> joi<span class="token punctuation">.</span><span class="token function">not</span><span class="token punctuation">(</span>joi<span class="token punctuation">.</span><span class="token function">ref</span><span class="token punctuation">(</span><span class="token string">'oldPwd'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li>在  <code>/router/userinfo.js</code>  模块中，导入需要的验证规则对象：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 导入需要的验证规则对象</span>
<span class="token keyword">const</span> <span class="token punctuation">&#123;</span> update_userinfo_schema<span class="token punctuation">,</span> update_password_schema <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../schema/user'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<ol>
<li>并在  <code>重置密码的路由</code>  中，使用  <code>update_password_schema</code>  规则验证表单的数据，示例代码如下：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js">router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/updatepwd'</span><span class="token punctuation">,</span> <span class="token function">expressJoi</span><span class="token punctuation">(</span>update_password_schema<span class="token punctuation">)</span><span class="token punctuation">,</span> userinfo_handler<span class="token punctuation">.</span>updatePassword<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="-98"><a class="markdownIt-Anchor" href="#-98">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_3-3-3-%E5%AE%9E%E7%8E%B0%E9%87%8D%E7%BD%AE%E5%AF%86%E7%A0%81%E7%9A%84%E5%8A%9F%E8%83%BD">#</a>3.3.3 实现重置密码的功能</h4>
<ol>
<li>根据  <code>id</code>  查询用户是否存在：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 定义根据 id 查询用户数据的 SQL 语句</span>
<span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">select * from ev_users where id=?</span><span class="token template-punctuation string">`</span></span>

<span class="token comment">// 执行 SQL 语句查询用户是否存在</span>
db<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> req<span class="token punctuation">.</span>user<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 执行 SQL 语句失败</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">cc</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>

  <span class="token comment">// 检查指定 id 的用户是否存在</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>results<span class="token punctuation">.</span>length <span class="token operator">!==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">cc</span><span class="token punctuation">(</span><span class="token string">'用户不存在！'</span><span class="token punctuation">)</span>

  <span class="token comment">// TODO：判断提交的旧密码是否正确</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li>判断提交的 <strong>旧密码</strong> 是否正确：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 在头部区域导入 bcryptjs 后，</span>
<span class="token comment">// 即可使用 bcrypt.compareSync(提交的密码，数据库中的密码) 方法验证密码是否正确</span>
<span class="token comment">// compareSync() 函数的返回值为布尔值，true 表示密码正确，false 表示密码错误</span>
<span class="token keyword">const</span> bcrypt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'bcryptjs'</span><span class="token punctuation">)</span>

<span class="token comment">// 判断提交的旧密码是否正确</span>
<span class="token keyword">const</span> compareResult <span class="token operator">=</span> bcrypt<span class="token punctuation">.</span><span class="token function">compareSync</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>oldPwd<span class="token punctuation">,</span> results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>password<span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>compareResult<span class="token punctuation">)</span> <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">cc</span><span class="token punctuation">(</span><span class="token string">'原密码错误！'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li>对新密码进行  <code>bcrypt</code>  加密之后，更新到数据库中：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 定义更新用户密码的 SQL 语句</span>
<span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">update ev_users set password=? where id=?</span><span class="token template-punctuation string">`</span></span>

<span class="token comment">// 对新密码进行 bcrypt 加密处理</span>
<span class="token keyword">const</span> newPwd <span class="token operator">=</span> bcrypt<span class="token punctuation">.</span><span class="token function">hashSync</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>newPwd<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>

<span class="token comment">// 执行 SQL 语句，根据 id 更新用户的密码</span>
db<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token punctuation">[</span>newPwd<span class="token punctuation">,</span> req<span class="token punctuation">.</span>user<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// SQL 语句执行失败</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">cc</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>

  <span class="token comment">// SQL 语句执行成功，但是影响行数不等于 1</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>results<span class="token punctuation">.</span>affectedRows <span class="token operator">!==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">cc</span><span class="token punctuation">(</span><span class="token string">'更新密码失败！'</span><span class="token punctuation">)</span>

  <span class="token comment">// 更新密码成功</span>
  res<span class="token punctuation">.</span><span class="token function">cc</span><span class="token punctuation">(</span><span class="token string">'更新密码成功！'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-99"><a class="markdownIt-Anchor" href="#-99">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_3-4-%E6%9B%B4%E6%96%B0%E7%94%A8%E6%88%B7%E5%A4%B4%E5%83%8F">#</a>3.4 更新用户头像</h3>
<h4 id="-100"><a class="markdownIt-Anchor" href="#-100">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_3-4-0-%E5%AE%9E%E7%8E%B0%E6%AD%A5%E9%AA%A4">#</a>3.4.0 实现步骤</h4>
<ol>
<li>定义路由和处理函数</li>
<li>验证表单数据</li>
<li>实现更新用户头像的功能</li>
</ol>
<h4 id="-101"><a class="markdownIt-Anchor" href="#-101">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_3-4-1-%E5%AE%9A%E4%B9%89%E8%B7%AF%E7%94%B1%E5%92%8C%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0">#</a>3.4.1 定义路由和处理函数</h4>
<ol>
<li>在  <code>/router/userinfo.js</code>  模块中，新增  <code>更新用户头像</code>  的路由：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 更新用户头像的路由</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/update/avatar'</span><span class="token punctuation">,</span> userinfo_handler<span class="token punctuation">.</span>updateAvatar<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<ol>
<li>在  <code>/router_handler/userinfo.js</code>  模块中，定义并向外共享  <code>更新用户头像</code>  的路由处理函数：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 更新用户头像的处理函数</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">updateAvatar</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-102"><a class="markdownIt-Anchor" href="#-102">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_3-4-2-%E9%AA%8C%E8%AF%81%E8%A1%A8%E5%8D%95%E6%95%B0%E6%8D%AE">#</a>3.4.2 验证表单数据</h4>
<ol>
<li>在  <code>/schema/user.js</code>  验证规则模块中，定义  <code>avatar</code>  的验证规则如下：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// dataUri() 指的是如下格式的字符串数据：</span>
<span class="token comment">// data:image/png;base64,VE9PTUFOWVNFQ1JFVFM=</span>
<span class="token keyword">const</span> avatar <span class="token operator">=</span> joi<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dataUri</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<ol>
<li>并使用  <code>exports</code>  向外共享如下的  <code>验证规则对象</code> ：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 验证规则对象 - 更新头像</span>
exports<span class="token punctuation">.</span>update_avatar_schema <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  body<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    avatar<span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li>在  <code>/router/userinfo.js</code>  模块中，导入需要的验证规则对象：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">&#123;</span> update_avatar_schema <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../schema/user'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ol>
<li>在  <code>/router/userinfo.js</code>  模块中，修改  <code>更新用户头像</code>  的路由如下：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js">router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/update/avatar'</span><span class="token punctuation">,</span> <span class="token function">expressJoi</span><span class="token punctuation">(</span>update_avatar_schema<span class="token punctuation">)</span><span class="token punctuation">,</span> userinfo_handler<span class="token punctuation">.</span>updateAvatar<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="-103"><a class="markdownIt-Anchor" href="#-103">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_3-4-3-%E5%AE%9E%E7%8E%B0%E6%9B%B4%E6%96%B0%E7%94%A8%E6%88%B7%E5%A4%B4%E5%83%8F%E7%9A%84%E5%8A%9F%E8%83%BD">#</a>3.4.3 实现更新用户头像的功能</h4>
<ol>
<li>定义更新用户头像的 SQL 语句：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token string">'update ev_users set user_pic=? where id=?'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ol>
<li>调用  <code>db.query()</code>  执行 SQL 语句，更新对应用户的头像：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js">db<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token punctuation">[</span>req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>avatar<span class="token punctuation">,</span> req<span class="token punctuation">.</span>user<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 执行 SQL 语句失败</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">cc</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>

  <span class="token comment">// 执行 SQL 语句成功，但是影响行数不等于 1</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>results<span class="token punctuation">.</span>affectedRows <span class="token operator">!==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">cc</span><span class="token punctuation">(</span><span class="token string">'更新头像失败！'</span><span class="token punctuation">)</span>

  <span class="token comment">// 更新用户头像成功</span>
  <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">cc</span><span class="token punctuation">(</span><span class="token string">'更新头像成功！'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<h2 id="-104"><a class="markdownIt-Anchor" href="#-104">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_4-%E6%96%87%E7%AB%A0%E5%88%86%E7%B1%BB%E7%AE%A1%E7%90%86">#</a>4. 文章分类管理</h2>
<h3 id="-105"><a class="markdownIt-Anchor" href="#-105">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_4-1-%E6%96%B0%E5%BB%BA-ev-article-cate-%E8%A1%A8">#</a>4.1 新建 ev_article_cate 表</h3>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/ev_article_cate.f52fe7ce.png" alt="文章分类表结构"></p>
<h3 id="-106"><a class="markdownIt-Anchor" href="#-106">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_4-2-%E8%8E%B7%E5%8F%96%E6%96%87%E7%AB%A0%E5%88%86%E7%B1%BB%E5%88%97%E8%A1%A8">#</a>4.2 获取文章分类列表</h3>
<h4 id="-107"><a class="markdownIt-Anchor" href="#-107">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_4-2-0-%E5%AE%9E%E7%8E%B0%E6%AD%A5%E9%AA%A4">#</a>4.2.0 实现步骤</h4>
<ol>
<li>初始化路由模块</li>
<li>初始化路由处理函数模块</li>
<li>获取文章分类列表数据</li>
</ol>
<h4 id="-108"><a class="markdownIt-Anchor" href="#-108">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_4-2-1-%E5%88%9D%E5%A7%8B%E5%8C%96%E8%B7%AF%E7%94%B1%E6%A8%A1%E5%9D%97">#</a>4.2.1 初始化路由模块</h4>
<ol>
<li>创建  <code>/router/artcate.js</code>  路由模块，并初始化如下的代码结构：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 导入 express</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token comment">// 创建路由对象</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 获取文章分类的列表数据</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/cates'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

<span class="token comment">// 向外共享路由对象</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li>在  <code>app.js</code>  中导入并使用文章分类的路由模块：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 导入并使用文章分类路由模块</span>
<span class="token keyword">const</span> artCateRouter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./router/artcate'</span><span class="token punctuation">)</span>
<span class="token comment">// 为文章分类的路由挂载统一的访问前缀 /my/article</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/my/article'</span><span class="token punctuation">,</span> artCateRouter<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-109"><a class="markdownIt-Anchor" href="#-109">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_4-2-2-%E5%88%9D%E5%A7%8B%E5%8C%96%E8%B7%AF%E7%94%B1%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0%E6%A8%A1%E5%9D%97">#</a>4.2.2 初始化路由处理函数模块</h4>
<ol>
<li>创建  <code>/router_handler/artcate.js</code>  路由处理函数模块，并初始化如下的代码结构：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 获取文章分类列表数据的处理函数</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">getArticleCates</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li>修改  <code>/router/artcate.js</code>  中的代码如下：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 导入文章分类的路由处理函数模块</span>
<span class="token keyword">const</span> artcate_handler <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../router_handler/artcate'</span><span class="token punctuation">)</span>

<span class="token comment">// 获取文章分类的列表数据</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/cates'</span><span class="token punctuation">,</span> artcate_handler<span class="token punctuation">.</span>getArticleCates<span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-110"><a class="markdownIt-Anchor" href="#-110">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_4-2-3-%E8%8E%B7%E5%8F%96%E6%96%87%E7%AB%A0%E5%88%86%E7%B1%BB%E5%88%97%E8%A1%A8%E6%95%B0%E6%8D%AE">#</a>4.2.3 获取文章分类列表数据</h4>
<ol>
<li>在  <code>/router_handler/artcate.js</code>  头部导入数据库操作模块：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 导入数据库操作模块</span>
<span class="token keyword">const</span> db <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../db/index'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<ol>
<li>定义 SQL 语句：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 根据分类的状态，获取所有未被删除的分类列表数据</span>
<span class="token comment">// is_delete 为 0 表示没有被 标记为删除 的数据</span>
<span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token string">'select * from ev_article_cate where is_delete=0 order by id asc'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<ol>
<li>调用  <code>db.query()</code>  执行 SQL 语句：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js">db<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 1. 执行 SQL 语句失败</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">cc</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>

  <span class="token comment">// 2. 执行 SQL 语句成功</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
    status<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    message<span class="token operator">:</span> <span class="token string">'获取文章分类列表成功！'</span><span class="token punctuation">,</span>
    data<span class="token operator">:</span> results<span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-111"><a class="markdownIt-Anchor" href="#-111">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_4-3-%E6%96%B0%E5%A2%9E%E6%96%87%E7%AB%A0%E5%88%86%E7%B1%BB">#</a>4.3 新增文章分类</h3>
<h4 id="-112"><a class="markdownIt-Anchor" href="#-112">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_4-3-0-%E5%AE%9E%E7%8E%B0%E6%AD%A5%E9%AA%A4">#</a>4.3.0 实现步骤</h4>
<ol>
<li>定义路由和处理函数</li>
<li>验证表单数据</li>
<li>查询  <code>分类名称</code>  与  <code>分类别名</code>  是否被占用</li>
<li>实现新增文章分类的功能</li>
</ol>
<h4 id="-113"><a class="markdownIt-Anchor" href="#-113">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_4-3-1-%E5%AE%9A%E4%B9%89%E8%B7%AF%E7%94%B1%E5%92%8C%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0">#</a>4.3.1 定义路由和处理函数</h4>
<ol>
<li>在  <code>/router/artcate.js</code>  模块中，添加  <code>新增文章分类</code>  的路由：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 新增文章分类的路由</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/addcates'</span><span class="token punctuation">,</span> artcate_handler<span class="token punctuation">.</span>addArticleCates<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<ol>
<li>在  <code>/router_handler/artcate.js</code>  模块中，定义并向外共享  <code>新增文章分类</code>  的路由处理函数：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 新增文章分类的处理函数</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">addArticleCates</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-114"><a class="markdownIt-Anchor" href="#-114">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_4-3-2-%E9%AA%8C%E8%AF%81%E8%A1%A8%E5%8D%95%E6%95%B0%E6%8D%AE">#</a>4.3.2 验证表单数据</h4>
<ol>
<li>创建  <code>/schema/artcate.js</code>  文章分类数据验证模块，并定义如下的验证规则：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 导入定义验证规则的模块</span>
<span class="token keyword">const</span> joi <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'joi'</span><span class="token punctuation">)</span>

<span class="token comment">// 定义 分类名称 和 分类别名 的校验规则</span>
<span class="token keyword">const</span> name <span class="token operator">=</span> joi<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> alias <span class="token operator">=</span> joi<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">alphanum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 校验规则对象 - 添加分类</span>
exports<span class="token punctuation">.</span>add_cate_schema <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  body<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    name<span class="token punctuation">,</span>
    alias<span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li>在  <code>/router/artcate.js</code>  模块中，使用  <code>add_cate_schema</code>  对数据进行验证：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 导入验证数据的中间件</span>
<span class="token keyword">const</span> expressJoi <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@escook/express-joi'</span><span class="token punctuation">)</span>
<span class="token comment">// 导入文章分类的验证模块</span>
<span class="token keyword">const</span> <span class="token punctuation">&#123;</span> add_cate_schema <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../schema/artcate'</span><span class="token punctuation">)</span>

<span class="token comment">// 新增文章分类的路由</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/addcates'</span><span class="token punctuation">,</span> <span class="token function">expressJoi</span><span class="token punctuation">(</span>add_cate_schema<span class="token punctuation">)</span><span class="token punctuation">,</span> artcate_handler<span class="token punctuation">.</span>addArticleCates<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-115"><a class="markdownIt-Anchor" href="#-115">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_4-3-3-%E6%9F%A5%E8%AF%A2%E5%88%86%E7%B1%BB%E5%90%8D%E7%A7%B0%E4%B8%8E%E5%88%AB%E5%90%8D%E6%98%AF%E5%90%A6%E8%A2%AB%E5%8D%A0%E7%94%A8">#</a>4.3.3 查询分类名称与别名是否被占用</h4>
<ol>
<li>定义查重的 SQL 语句：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 定义查询 分类名称 与 分类别名 是否被占用的 SQL 语句</span>
<span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">select * from ev_article_cate where name=? or alias=?</span><span class="token template-punctuation string">`</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<ol>
<li>调用  <code>db.query()</code>  执行查重的操作：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 执行查重操作</span>
db<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token punctuation">[</span>req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>name<span class="token punctuation">,</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>alias<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 执行 SQL 语句失败</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">cc</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>

  <span class="token comment">// 判断 分类名称 和 分类别名 是否被占用</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>results<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">cc</span><span class="token punctuation">(</span><span class="token string">'分类名称与别名被占用，请更换后重试！'</span><span class="token punctuation">)</span>
  <span class="token comment">// 分别判断 分类名称 和 分类别名 是否被占用</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>results<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name <span class="token operator">===</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">cc</span><span class="token punctuation">(</span><span class="token string">'分类名称被占用，请更换后重试！'</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>results<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>alias <span class="token operator">===</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>alias<span class="token punctuation">)</span> <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">cc</span><span class="token punctuation">(</span><span class="token string">'分类别名被占用，请更换后重试！'</span><span class="token punctuation">)</span>

  <span class="token comment">// TODO：新增文章分类</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-116"><a class="markdownIt-Anchor" href="#-116">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_4-3-4-%E5%AE%9E%E7%8E%B0%E6%96%B0%E5%A2%9E%E6%96%87%E7%AB%A0%E5%88%86%E7%B1%BB%E7%9A%84%E5%8A%9F%E8%83%BD">#</a>4.3.4 实现新增文章分类的功能</h4>
<ol>
<li>定义新增文章分类的 SQL 语句：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">insert into ev_article_cate set ?</span><span class="token template-punctuation string">`</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ol>
<li>调用  <code>db.query()</code>  执行新增文章分类的 SQL 语句：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js">db<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> req<span class="token punctuation">.</span>body<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// SQL 语句执行失败</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">cc</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>

  <span class="token comment">// SQL 语句执行成功，但是影响行数不等于 1</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>results<span class="token punctuation">.</span>affectedRows <span class="token operator">!==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">cc</span><span class="token punctuation">(</span><span class="token string">'新增文章分类失败！'</span><span class="token punctuation">)</span>

  <span class="token comment">// 新增文章分类成功</span>
  res<span class="token punctuation">.</span><span class="token function">cc</span><span class="token punctuation">(</span><span class="token string">'新增文章分类成功！'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-117"><a class="markdownIt-Anchor" href="#-117">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_4-4-%E6%A0%B9%E6%8D%AE-id-%E5%88%A0%E9%99%A4%E6%96%87%E7%AB%A0%E5%88%86%E7%B1%BB">#</a>4.4 根据 Id 删除文章分类</h3>
<h4 id="-118"><a class="markdownIt-Anchor" href="#-118">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_4-4-0-%E5%AE%9E%E7%8E%B0%E6%AD%A5%E9%AA%A4">#</a>4.4.0 实现步骤</h4>
<ol>
<li>定义路由和处理函数</li>
<li>验证表单数据</li>
<li>实现删除文章分类的功能</li>
</ol>
<h4 id="-119"><a class="markdownIt-Anchor" href="#-119">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_4-4-1-%E5%AE%9A%E4%B9%89%E8%B7%AF%E7%94%B1%E5%92%8C%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0">#</a>4.4.1 定义路由和处理函数</h4>
<ol>
<li>在  <code>/router/artcate.js</code>  模块中，添加  <code>删除文章分类</code>  的路由：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 删除文章分类的路由</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/deletecate/:id'</span><span class="token punctuation">,</span> artcate_handler<span class="token punctuation">.</span>deleteCateById<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<ol>
<li>在  <code>/router_handler/artcate.js</code>  模块中，定义并向外共享  <code>删除文章分类</code>  的路由处理函数：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 删除文章分类的处理函数</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">deleteCateById</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-120"><a class="markdownIt-Anchor" href="#-120">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_4-4-2-%E9%AA%8C%E8%AF%81%E8%A1%A8%E5%8D%95%E6%95%B0%E6%8D%AE">#</a>4.4.2 验证表单数据</h4>
<ol>
<li>在  <code>/schema/artcate.js</code>  验证规则模块中，定义 id 的验证规则如下：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 定义 分类Id 的校验规则</span>
<span class="token keyword">const</span> id <span class="token operator">=</span> joi<span class="token punctuation">.</span><span class="token function">number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">integer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<ol>
<li>并使用  <code>exports</code>  向外共享如下的  <code>验证规则对象</code> ：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 校验规则对象 - 删除分类</span>
exports<span class="token punctuation">.</span>delete_cate_schema <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  params<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    id<span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li>在  <code>/router/artcate.js</code>  模块中，导入需要的验证规则对象，并在路由中使用：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 导入删除分类的验证规则对象</span>
<span class="token keyword">const</span> <span class="token punctuation">&#123;</span> delete_cate_schema <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../schema/artcate'</span><span class="token punctuation">)</span>

<span class="token comment">// 删除文章分类的路由</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/deletecate/:id'</span><span class="token punctuation">,</span> <span class="token function">expressJoi</span><span class="token punctuation">(</span>delete_cate_schema<span class="token punctuation">)</span><span class="token punctuation">,</span> artcate_handler<span class="token punctuation">.</span>deleteCateById<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-121"><a class="markdownIt-Anchor" href="#-121">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_4-4-3-%E5%AE%9E%E7%8E%B0%E5%88%A0%E9%99%A4%E6%96%87%E7%AB%A0%E5%88%86%E7%B1%BB%E7%9A%84%E5%8A%9F%E8%83%BD">#</a>4.4.3 实现删除文章分类的功能</h4>
<ol>
<li>定义删除文章分类的 SQL 语句：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">update ev_article_cate set is_delete=1 where id=?</span><span class="token template-punctuation string">`</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ol>
<li>调用  <code>db.query()</code>  执行删除文章分类的 SQL 语句：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js">db<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 执行 SQL 语句失败</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">cc</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>

  <span class="token comment">// SQL 语句执行成功，但是影响行数不等于 1</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>results<span class="token punctuation">.</span>affectedRows <span class="token operator">!==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">cc</span><span class="token punctuation">(</span><span class="token string">'删除文章分类失败！'</span><span class="token punctuation">)</span>

  <span class="token comment">// 删除文章分类成功</span>
  res<span class="token punctuation">.</span><span class="token function">cc</span><span class="token punctuation">(</span><span class="token string">'删除文章分类成功！'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-122"><a class="markdownIt-Anchor" href="#-122">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_4-5-%E6%A0%B9%E6%8D%AE-id-%E8%8E%B7%E5%8F%96%E6%96%87%E7%AB%A0%E5%88%86%E7%B1%BB%E6%95%B0%E6%8D%AE">#</a>4.5 根据 Id 获取文章分类数据</h3>
<h4 id="-123"><a class="markdownIt-Anchor" href="#-123">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_4-5-0-%E5%AE%9E%E7%8E%B0%E6%AD%A5%E9%AA%A4">#</a>4.5.0 实现步骤</h4>
<ol>
<li>定义路由和处理函数</li>
<li>验证表单数据</li>
<li>实现获取文章分类的功能</li>
</ol>
<h4 id="-124"><a class="markdownIt-Anchor" href="#-124">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_4-5-1-%E5%AE%9A%E4%B9%89%E8%B7%AF%E7%94%B1%E5%92%8C%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0">#</a>4.5.1 定义路由和处理函数</h4>
<ol>
<li>在  <code>/router/artcate.js</code>  模块中，添加  <code>根据 Id 获取文章分类</code>  的路由：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js">router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/cates/:id'</span><span class="token punctuation">,</span> artcate_handler<span class="token punctuation">.</span>getArticleById<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ol>
<li>在  <code>/router_handler/artcate.js</code>  模块中，定义并向外共享  <code>根据 Id 获取文章分类</code>  的路由处理函数：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 根据 Id 获取文章分类的处理函数</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">getArticleById</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-125"><a class="markdownIt-Anchor" href="#-125">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_4-5-2-%E9%AA%8C%E8%AF%81%E8%A1%A8%E5%8D%95%E6%95%B0%E6%8D%AE">#</a>4.5.2 验证表单数据</h4>
<ol>
<li>在  <code>/schema/artcate.js</code>  验证规则模块中，使用  <code>exports</code>  向外共享如下的  <code>验证规则对象</code> ：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 校验规则对象 - 根据 Id 获取分类</span>
exports<span class="token punctuation">.</span>get_cate_schema <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  params<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    id<span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li>在  <code>/router/artcate.js</code>  模块中，导入需要的验证规则对象，并在路由中使用：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 导入根据 Id 获取分类的验证规则对象</span>
<span class="token keyword">const</span> <span class="token punctuation">&#123;</span> get_cate_schema <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../schema/artcate'</span><span class="token punctuation">)</span>

<span class="token comment">// 根据 Id 获取文章分类的路由</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/cates/:id'</span><span class="token punctuation">,</span> <span class="token function">expressJoi</span><span class="token punctuation">(</span>get_cate_schema<span class="token punctuation">)</span><span class="token punctuation">,</span> artcate_handler<span class="token punctuation">.</span>getArticleById<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-126"><a class="markdownIt-Anchor" href="#-126">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_4-5-3-%E5%AE%9E%E7%8E%B0%E8%8E%B7%E5%8F%96%E6%96%87%E7%AB%A0%E5%88%86%E7%B1%BB%E7%9A%84%E5%8A%9F%E8%83%BD">#</a>4.5.3 实现获取文章分类的功能</h4>
<ol>
<li>定义根据 Id 获取文章分类的 SQL 语句：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">select * from ev_article_cate where id=?</span><span class="token template-punctuation string">`</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ol>
<li>调用  <code>db.query()</code>  执行 SQL 语句：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js">db<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 执行 SQL 语句失败</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">cc</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>

  <span class="token comment">// SQL 语句执行成功，但是没有查询到任何数据</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>results<span class="token punctuation">.</span>length <span class="token operator">!==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">cc</span><span class="token punctuation">(</span><span class="token string">'获取文章分类数据失败！'</span><span class="token punctuation">)</span>

  <span class="token comment">// 把数据响应给客户端</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
    status<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    message<span class="token operator">:</span> <span class="token string">'获取文章分类数据成功！'</span><span class="token punctuation">,</span>
    data<span class="token operator">:</span> results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="-127"><a class="markdownIt-Anchor" href="#-127">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_4-6-%E6%A0%B9%E6%8D%AE-id-%E6%9B%B4%E6%96%B0%E6%96%87%E7%AB%A0%E5%88%86%E7%B1%BB%E6%95%B0%E6%8D%AE">#</a>4.6 根据 Id 更新文章分类数据</h3>
<h4 id="-128"><a class="markdownIt-Anchor" href="#-128">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_4-6-0-%E5%AE%9E%E7%8E%B0%E6%AD%A5%E9%AA%A4">#</a>4.6.0 实现步骤</h4>
<ol>
<li>定义路由和处理函数</li>
<li>验证表单数据</li>
<li>查询  <code>分类名称</code>  与  <code>分类别名</code>  是否被占用</li>
<li>实现更新文章分类的功能</li>
</ol>
<h4 id="-129"><a class="markdownIt-Anchor" href="#-129">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_4-6-1-%E5%AE%9A%E4%B9%89%E8%B7%AF%E7%94%B1%E5%92%8C%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0">#</a>4.6.1 定义路由和处理函数</h4>
<ol>
<li>在  <code>/router/artcate.js</code>  模块中，添加  <code>更新文章分类</code>  的路由：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 更新文章分类的路由</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/updatecate'</span><span class="token punctuation">,</span> artcate_handler<span class="token punctuation">.</span>updateCateById<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<ol>
<li>在  <code>/router_handler/artcate.js</code>  模块中，定义并向外共享  <code>更新文章分类</code>  的路由处理函数：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 更新文章分类的处理函数</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">updateCateById</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-130"><a class="markdownIt-Anchor" href="#-130">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_4-6-2-%E9%AA%8C%E8%AF%81%E8%A1%A8%E5%8D%95%E6%95%B0%E6%8D%AE">#</a>4.6.2 验证表单数据</h4>
<ol>
<li>在  <code>/schema/artcate.js</code>  验证规则模块中，使用  <code>exports</code>  向外共享如下的  <code>验证规则对象</code> ：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 校验规则对象 - 更新分类</span>
exports<span class="token punctuation">.</span>update_cate_schema <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  body<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    Id<span class="token operator">:</span> id<span class="token punctuation">,</span>
    name<span class="token punctuation">,</span>
    alias<span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li>在  <code>/router/artcate.js</code>  模块中，导入需要的验证规则对象，并在路由中使用：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 导入更新文章分类的验证规则对象</span>
<span class="token keyword">const</span> <span class="token punctuation">&#123;</span> update_cate_schema <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../schema/artcate'</span><span class="token punctuation">)</span>

<span class="token comment">// 更新文章分类的路由</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/updatecate'</span><span class="token punctuation">,</span> <span class="token function">expressJoi</span><span class="token punctuation">(</span>update_cate_schema<span class="token punctuation">)</span><span class="token punctuation">,</span> artcate_handler<span class="token punctuation">.</span>updateCateById<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-131"><a class="markdownIt-Anchor" href="#-131">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_4-5-4-%E6%9F%A5%E8%AF%A2%E5%88%86%E7%B1%BB%E5%90%8D%E7%A7%B0%E4%B8%8E%E5%88%AB%E5%90%8D%E6%98%AF%E5%90%A6%E8%A2%AB%E5%8D%A0%E7%94%A8">#</a>4.5.4 查询分类名称与别名是否被占用</h4>
<ol>
<li>定义查重的 SQL 语句：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 定义查询 分类名称 与 分类别名 是否被占用的 SQL 语句</span>
<span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">select * from ev_article_cate where Id&lt;>? and (name=? or alias=?)</span><span class="token template-punctuation string">`</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<ol>
<li>调用  <code>db.query()</code>  执行查重的操作：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 执行查重操作</span>
db<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token punctuation">[</span>req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>Id<span class="token punctuation">,</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>name<span class="token punctuation">,</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>alias<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 执行 SQL 语句失败</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">cc</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>

  <span class="token comment">// 判断 分类名称 和 分类别名 是否被占用</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>results<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">cc</span><span class="token punctuation">(</span><span class="token string">'分类名称与别名被占用，请更换后重试！'</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>results<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name <span class="token operator">===</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">cc</span><span class="token punctuation">(</span><span class="token string">'分类名称被占用，请更换后重试！'</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>results<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>alias <span class="token operator">===</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>alias<span class="token punctuation">)</span> <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">cc</span><span class="token punctuation">(</span><span class="token string">'分类别名被占用，请更换后重试！'</span><span class="token punctuation">)</span>

  <span class="token comment">// TODO：更新文章分类</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-132"><a class="markdownIt-Anchor" href="#-132">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_4-5-5-%E5%AE%9E%E7%8E%B0%E6%9B%B4%E6%96%B0%E6%96%87%E7%AB%A0%E5%88%86%E7%B1%BB%E7%9A%84%E5%8A%9F%E8%83%BD">#</a>4.5.5 实现更新文章分类的功能</h4>
<ol>
<li>定义更新文章分类的 SQL 语句：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">update ev_article_cate set ? where Id=?</span><span class="token template-punctuation string">`</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ol>
<li>调用  <code>db.query()</code>  执行 SQL 语句：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js">db<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token punctuation">[</span>req<span class="token punctuation">.</span>body<span class="token punctuation">,</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>Id<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 执行 SQL 语句失败</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">cc</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>

  <span class="token comment">// SQL 语句执行成功，但是影响行数不等于 1</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>results<span class="token punctuation">.</span>affectedRows <span class="token operator">!==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">cc</span><span class="token punctuation">(</span><span class="token string">'更新文章分类失败！'</span><span class="token punctuation">)</span>

  <span class="token comment">// 更新文章分类成功</span>
  res<span class="token punctuation">.</span><span class="token function">cc</span><span class="token punctuation">(</span><span class="token string">'更新文章分类成功！'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<h2 id="-133"><a class="markdownIt-Anchor" href="#-133">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_5-%E6%96%87%E7%AB%A0%E7%AE%A1%E7%90%86">#</a>5. 文章管理</h2>
<h3 id="-134"><a class="markdownIt-Anchor" href="#-134">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_5-1-%E6%96%B0%E5%BB%BA-ev-articles-%E8%A1%A8">#</a>5.1 新建 ev_articles 表</h3>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/ev_articles.01220b03.png" alt="ev_articles表结构"></p>
<h3 id="-135"><a class="markdownIt-Anchor" href="#-135">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_5-2-%E5%8F%91%E5%B8%83%E6%96%B0%E6%96%87%E7%AB%A0">#</a>5.2 发布新文章</h3>
<h4 id="-136"><a class="markdownIt-Anchor" href="#-136">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_5-2-0-%E5%AE%9E%E7%8E%B0%E6%AD%A5%E9%AA%A4">#</a>5.2.0 实现步骤</h4>
<ol>
<li>初始化路由模块</li>
<li>初始化路由处理函数模块</li>
<li>使用 multer 解析表单数据</li>
<li>验证表单数据</li>
<li>实现发布文章的功能</li>
</ol>
<h4 id="-137"><a class="markdownIt-Anchor" href="#-137">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_5-2-1-%E5%88%9D%E5%A7%8B%E5%8C%96%E8%B7%AF%E7%94%B1%E6%A8%A1%E5%9D%97">#</a>5.2.1 初始化路由模块</h4>
<ol>
<li>创建  <code>/router/article.js</code>  路由模块，并初始化如下的代码结构：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 导入 express</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token comment">// 创建路由对象</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 发布新文章</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/add'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

<span class="token comment">// 向外共享路由对象</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li>在  <code>app.js</code>  中导入并使用文章的路由模块：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 导入并使用文章路由模块</span>
<span class="token keyword">const</span> articleRouter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./router/article'</span><span class="token punctuation">)</span>
<span class="token comment">// 为文章的路由挂载统一的访问前缀 /my/article</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/my/article'</span><span class="token punctuation">,</span> articleRouter<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-138"><a class="markdownIt-Anchor" href="#-138">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_5-2-2-%E5%88%9D%E5%A7%8B%E5%8C%96%E8%B7%AF%E7%94%B1%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0%E6%A8%A1%E5%9D%97">#</a>5.2.2 初始化路由处理函数模块</h4>
<ol>
<li>创建  <code>/router_handler/article.js</code>  路由处理函数模块，并初始化如下的代码结构：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 发布新文章的处理函数</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">addArticle</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li>修改  <code>/router/article.js</code>  中的代码如下：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 导入文章的路由处理函数模块</span>
<span class="token keyword">const</span> article_handler <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../router_handler/article'</span><span class="token punctuation">)</span>

<span class="token comment">// 发布新文章</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/add'</span><span class="token punctuation">,</span> article_handler<span class="token punctuation">.</span>addArticle<span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-139"><a class="markdownIt-Anchor" href="#-139">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_5-2-3-%E4%BD%BF%E7%94%A8-multer-%E8%A7%A3%E6%9E%90%E8%A1%A8%E5%8D%95%E6%95%B0%E6%8D%AE">#</a>5.2.3 使用 multer 解析表单数据</h4>
<blockquote>
<p>注意：使用  <code>express.urlencoded()</code>  中间件无法解析  <code>multipart/form-data</code>  格式的请求体数据。</p>
</blockquote>
<blockquote>
<p>当前项目，推荐使用 multer 来解析  <code>multipart/form-data</code>  格式的表单数据。<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/multer">https://www.npmjs.com/package/multer</a></p>
</blockquote>
<ol>
<li>运行如下的终端命令，在项目中安装  <code>multer</code> ：</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> i multer@1.4.2<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ol>
<li>在  <code>/router_handler/article.js</code>  模块中导入并配置  <code>multer</code> ：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 导入解析 formdata 格式表单数据的包</span>
<span class="token keyword">const</span> multer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'multer'</span><span class="token punctuation">)</span>
<span class="token comment">// 导入处理路径的核心模块</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>

<span class="token comment">// 创建 multer 的实例对象，通过 dest 属性指定文件的存放路径</span>
<span class="token keyword">const</span> upload <span class="token operator">=</span> <span class="token function">multer</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> dest<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../uploads'</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li>修改  <code>发布新文章</code>  的路由如下：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 发布新文章的路由</span>
<span class="token comment">// upload.single() 是一个局部生效的中间件，用来解析 FormData 格式的表单数据</span>
<span class="token comment">// 将文件类型的数据，解析并挂载到 req.file 属性中</span>
<span class="token comment">// 将文本类型的数据，解析并挂载到 req.body 属性中</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/add'</span><span class="token punctuation">,</span> upload<span class="token punctuation">.</span><span class="token function">single</span><span class="token punctuation">(</span><span class="token string">'cover_img'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> article_handler<span class="token punctuation">.</span>addArticle<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li>在  <code>/router_handler/article.js</code>  模块中的  <code>addArticle</code>  处理函数中，将  <code>multer</code>  解析出来的数据进行打印：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 发布新文章的处理函数</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">addArticle</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">)</span> <span class="token comment">// 文本类型的数据</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'--------分割线----------'</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>file<span class="token punctuation">)</span> <span class="token comment">// 文件类型的数据</span>

  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-140"><a class="markdownIt-Anchor" href="#-140">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_5-2-4-%E9%AA%8C%E8%AF%81%E8%A1%A8%E5%8D%95%E6%95%B0%E6%8D%AE">#</a>5.2.4 验证表单数据</h4>
<blockquote>
<p>实现思路：通过 express-joi <strong>自动验证</strong> req.body 中的文本数据；通过 if 判断<strong>手动验证</strong> req.file 中的文件数据；</p>
</blockquote>
<ol>
<li>创建  <code>/schema/article.js</code>  验证规则模块，并初始化如下的代码结构：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 导入定义验证规则的模块</span>
<span class="token keyword">const</span> joi <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'joi'</span><span class="token punctuation">)</span>

<span class="token comment">// 定义 标题、分类Id、内容、发布状态 的验证规则</span>
<span class="token keyword">const</span> title <span class="token operator">=</span> joi<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> cate_id <span class="token operator">=</span> joi<span class="token punctuation">.</span><span class="token function">number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">integer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> content <span class="token operator">=</span> joi<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">allow</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> state <span class="token operator">=</span> joi<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">valid</span><span class="token punctuation">(</span><span class="token string">'已发布'</span><span class="token punctuation">,</span> <span class="token string">'草稿'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 验证规则对象 - 发布文章</span>
exports<span class="token punctuation">.</span>add_article_schema <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  body<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    title<span class="token punctuation">,</span>
    cate_id<span class="token punctuation">,</span>
    content<span class="token punctuation">,</span>
    state<span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li>在  <code>/router/article.js</code>  模块中，导入需要的验证规则对象，并在路由中使用：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 导入验证数据的中间件</span>
<span class="token keyword">const</span> expressJoi <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@escook/express-joi'</span><span class="token punctuation">)</span>
<span class="token comment">// 导入文章的验证模块</span>
<span class="token keyword">const</span> <span class="token punctuation">&#123;</span> add_article_schema <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../schema/article'</span><span class="token punctuation">)</span>

<span class="token comment">// 发布新文章的路由</span>
<span class="token comment">// 注意：在当前的路由中，先后使用了两个中间件：</span>
<span class="token comment">//       先使用 multer 解析表单数据</span>
<span class="token comment">//       再使用 expressJoi 对解析的表单数据进行验证</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/add'</span><span class="token punctuation">,</span> upload<span class="token punctuation">.</span><span class="token function">single</span><span class="token punctuation">(</span><span class="token string">'cover_img'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">expressJoi</span><span class="token punctuation">(</span>add_article_schema<span class="token punctuation">)</span><span class="token punctuation">,</span> article_handler<span class="token punctuation">.</span>addArticle<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li>在  <code>/router_handler/article.js</code>  模块中的  <code>addArticle</code>  处理函数中，通过  <code>if</code>  判断客户端是否提交了  <code>封面图片</code> ：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 发布新文章的处理函数</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">addArticle</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 手动判断是否上传了文章封面</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>req<span class="token punctuation">.</span>file <span class="token operator">||</span> req<span class="token punctuation">.</span>file<span class="token punctuation">.</span>fieldname <span class="token operator">!==</span> <span class="token string">'cover_img'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">cc</span><span class="token punctuation">(</span><span class="token string">'文章封面是必选参数！'</span><span class="token punctuation">)</span>

  <span class="token comment">// TODO：表单数据合法，继续后面的处理流程...</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="-141"><a class="markdownIt-Anchor" href="#-141">#</a> <a target="_blank" rel="noopener" href="https://brucecai55520.gitee.io/bruceblog/notes/nodejs/ev_api_server.html#_5-2-5-%E5%AE%9E%E7%8E%B0%E5%8F%91%E5%B8%83%E6%96%87%E7%AB%A0%E7%9A%84%E5%8A%9F%E8%83%BD">#</a>5.2.5 实现发布文章的功能</h4>
<ol>
<li>整理要插入数据库的文章信息对象：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 导入处理路径的 path 核心模块</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> articleInfo <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 标题、内容、状态、所属的分类Id</span>
  <span class="token operator">...</span>req<span class="token punctuation">.</span>body<span class="token punctuation">,</span>
  <span class="token comment">// 文章封面在服务器端的存放路径</span>
  cover_img<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'/uploads'</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>file<span class="token punctuation">.</span>filename<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token comment">// 文章发布时间</span>
  pub_date<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token comment">// 文章作者的Id</span>
  author_id<span class="token operator">:</span> req<span class="token punctuation">.</span>user<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li>定义发布文章的 SQL 语句：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">insert into ev_articles set ?</span><span class="token template-punctuation string">`</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ol>
<li>调用  <code>db.query()</code>  执行发布文章的 SQL 语句：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 导入数据库操作模块</span>
<span class="token keyword">const</span> db <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../db/index'</span><span class="token punctuation">)</span>

<span class="token comment">// 执行 SQL 语句</span>
db<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> articleInfo<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 执行 SQL 语句失败</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">cc</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>

  <span class="token comment">// 执行 SQL 语句成功，但是影响行数不等于 1</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>results<span class="token punctuation">.</span>affectedRows <span class="token operator">!==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">cc</span><span class="token punctuation">(</span><span class="token string">'发布文章失败！'</span><span class="token punctuation">)</span>

  <span class="token comment">// 发布文章成功</span>
  res<span class="token punctuation">.</span><span class="token function">cc</span><span class="token punctuation">(</span><span class="token string">'发布文章成功'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li>在  <code>app.js</code>  中，使用  <code>express.static()</code>  中间件，将  <code>uploads</code>  目录中的图片托管为静态资源：</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 托管静态资源文件</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/uploads'</span><span class="token punctuation">,</span> express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span><span class="token string">'./uploads'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Harry Qu</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://harryqu1229.github.io/2022/03/01/nodejs(express,mysql%E4%BB%A5%E5%8F%8A%E5%A4%A7%E4%BA%8B%E4%BB%B6%E5%90%8E%E5%8F%B0%20API%20%E9%A1%B9%E7%9B%AE)/">https://harryqu1229.github.io/2022/03/01/nodejs(express,mysql%E4%BB%A5%E5%8F%8A%E5%A4%A7%E4%BA%8B%E4%BB%B6%E5%90%8E%E5%8F%B0%20API%20%E9%A1%B9%E7%9B%AE)/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/frontend/">frontend</a><a class="post-meta__tags" href="/tags/Nodejs/">Nodejs</a></div><div class="post_share"><div class="addthis_inline_share_toolbox"></div><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-621848f44e1c3724" async="async"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/02/25/rabbitmq/"><img class="prev-cover" src="https://w.wallhaven.cc/full/e7/wallhaven-e7p2pk.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">My Rabbitmq notes</div></div></a></div><div class="next-post pull-right"><a href="/2022/03/01/%E5%88%9D%E4%B8%AD%E7%BA%A7%E5%89%8D%E7%AB%AF%E9%9D%A2%E8%AF%95%E9%A2%98/"><img class="next-cover" src="https://w.wallhaven.cc/full/8o/wallhaven-8oply1.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">Frontend interview questions</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2022/03/01/nodejs/" title="Nodejs notes"><img class="cover" src="https://w.wallhaven.cc/full/q2/wallhaven-q2vzx5.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-03-01</div><div class="title">Nodejs notes</div></div></a></div><div><a href="/2022/02/01/JS%E6%A8%A1%E5%9D%97%E5%8C%96/" title="My Javascript modularity notes"><img class="cover" src="https://w.wallhaven.cc/full/8o/wallhaven-8oply1.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-01</div><div class="title">My Javascript modularity notes</div></div></a></div><div><a href="/2022/02/25/%E4%B8%80%E7%82%B9%E7%82%B9js%E9%9D%A2%E8%AF%95%E9%A2%98/" title="Javascript Interview Questions"><img class="cover" src="https://w.wallhaven.cc/full/e7/wallhaven-e7p2pk.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-25</div><div class="title">Javascript Interview Questions</div></div></a></div><div><a href="/2022/01/12/CSS%E9%9D%A2%E8%AF%95%E6%80%BB%E7%BB%93-YK%E8%8F%8C/" title="css Interview Questions"><img class="cover" src="https://w.wallhaven.cc/full/e7/wallhaven-e7p2pk.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-12</div><div class="title">css Interview Questions</div></div></a></div><div><a href="/2022/01/01/50%E9%81%93%E5%89%8D%E7%AB%AF%E9%9D%A2%E8%AF%95%E9%A2%98/" title="50 Frontend Interview Quesitions"><img class="cover" src="https://raw.githubusercontent.com/HarryQu1229/image-host/ca78dff38e0bfb81a8e98ad64f749e97bcc55f14/notes-img/Billfish.yWAOuM.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-01</div><div class="title">50 Frontend Interview Quesitions</div></div></a></div><div><a href="/2022/02/25/AJAX/" title="My Ajax notes"><img class="cover" src="https://c.pxhere.com/photos/e5/15/watercolour_painting_technique_soluble_in_water_not_opaque_color_image_color_sketch_turquoise-1110070.jpg!d" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-25</div><div class="title">My Ajax notes</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comment</span></div><div id="comment-switch"><span class="first-comment">Disqus</span><span class="switch-btn"></span><span class="second-comment">Gitalk</span></div></div><div class="comment-wrap"><div><div id="disqus_thread"></div></div><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/6aca34ee52f40fe1b2d637474f90111e2c151939/notes-img/%E5%85%B6%E4%B8%AD%E5%8C%85%E6%8B%AC%E5%9B%BE%E7%89%87%EF%BC%9A%7B%7B%20pinTitle%20%7D%7D_m6kogp.jpeg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Harry Qu</div><div class="author-info__description">Software Engineering Student</div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">171</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">89</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">60</div></a></div></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/HarryQu1229"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://www.linkedin.com/in/harry-qu-a0a38220a" target="_blank" title="LinkedIn"><i class="fab fa-linkedin"></i></a><a class="social-icon" href="https://github.com/HarryQu1229" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:Harryqu666@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="weixin://dl/chat?harry666ya" target="_blank" title="Wechat"><i class="fab fa-weixin"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">be healthy, stay safe</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#nodejs-%E5%9F%BA%E7%A1%80"><span class="toc-number">1.</span> <span class="toc-text"> Nodejs 基础</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">1.1.</span> <span class="toc-text"> 初识 Nodejs</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-2"><span class="toc-number">1.2.</span> <span class="toc-text"> Buffer 缓冲区</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-3"><span class="toc-number">1.3.</span> <span class="toc-text"> fs 文件系统模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-4"><span class="toc-number">1.3.1.</span> <span class="toc-text"> 读取文件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-5"><span class="toc-number">1.3.1.1.</span> <span class="toc-text"> 简单文件读取</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-6"><span class="toc-number">1.3.1.2.</span> <span class="toc-text"> 流式文件读取</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-7"><span class="toc-number">1.3.2.</span> <span class="toc-text"> 写入文件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-8"><span class="toc-number">1.3.2.1.</span> <span class="toc-text"> 简单文件写入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-9"><span class="toc-number">1.3.2.2.</span> <span class="toc-text"> 流式文件写入</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-10"><span class="toc-number">1.3.3.</span> <span class="toc-text"> 路径动态拼接问题  __dirname</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-11"><span class="toc-number">1.3.4.</span> <span class="toc-text"> 其它操作</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-12"><span class="toc-number">1.4.</span> <span class="toc-text"> path 路径模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-13"><span class="toc-number">1.4.1.</span> <span class="toc-text"> 路径拼接  path.join()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%96%E8%B7%AF%E5%BE%84%E4%B8%AD%E6%96%87%E4%BB%B6%E5%90%8D-pathbasename"><span class="toc-number">1.4.2.</span> <span class="toc-text"> 取路径中文件名  path.basename()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-14"><span class="toc-number">1.4.3.</span> <span class="toc-text"> 获取路径中文件扩展名  path.extname()</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-15"><span class="toc-number">1.5.</span> <span class="toc-text"> http 模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-16"><span class="toc-number">1.5.1.</span> <span class="toc-text"> 创建基本 Web 服务器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-17"><span class="toc-number">1.5.2.</span> <span class="toc-text"> 实现简陋路由效果</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-18"><span class="toc-number">1.6.</span> <span class="toc-text"> 模块化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-19"><span class="toc-number">1.6.1.</span> <span class="toc-text"> 模块化概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-20"><span class="toc-number">1.6.2.</span> <span class="toc-text"> Node.js 中模块的分类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-21"><span class="toc-number">1.6.3.</span> <span class="toc-text"> Node.js 中的模块作用域</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-22"><span class="toc-number">1.6.4.</span> <span class="toc-text"> 模块作用域的成员</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-23"><span class="toc-number">1.6.5.</span> <span class="toc-text"> CommonJS 模块化规范</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-24"><span class="toc-number">1.6.6.</span> <span class="toc-text"> 模块加载机制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-25"><span class="toc-number">1.6.6.1.</span> <span class="toc-text"> 内置模块加载</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-26"><span class="toc-number">1.6.6.2.</span> <span class="toc-text"> 自定义模块加载</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-27"><span class="toc-number">1.6.6.3.</span> <span class="toc-text"> 第三方模块加载</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-28"><span class="toc-number">1.6.6.4.</span> <span class="toc-text"> 目录作为模块加载</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#express"><span class="toc-number">2.</span> <span class="toc-text"> Express</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-29"><span class="toc-number">2.1.</span> <span class="toc-text"> Express 初体验</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-30"><span class="toc-number">2.1.1.</span> <span class="toc-text"> 基本使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-31"><span class="toc-number">2.1.2.</span> <span class="toc-text"> 托管静态资源</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-32"><span class="toc-number">2.2.</span> <span class="toc-text"> Express 路由</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-33"><span class="toc-number">2.3.</span> <span class="toc-text"> Express 中间件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-34"><span class="toc-number">2.3.1.</span> <span class="toc-text"> 全局中间件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-35"><span class="toc-number">2.3.2.</span> <span class="toc-text"> 局部中间件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-36"><span class="toc-number">2.3.3.</span> <span class="toc-text"> 中间件分类</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-37"><span class="toc-number">2.4.</span> <span class="toc-text"> CORS 跨域资源共享</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-38"><span class="toc-number">2.4.1.</span> <span class="toc-text"> cors 中间件解决跨域</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-39"><span class="toc-number">2.4.2.</span> <span class="toc-text"> CORS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-40"><span class="toc-number">2.4.3.</span> <span class="toc-text"> CORS 常见响应头</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-41"><span class="toc-number">2.4.4.</span> <span class="toc-text"> CORS 请求分类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-42"><span class="toc-number">2.4.4.1.</span> <span class="toc-text"> 简单请求</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-43"><span class="toc-number">2.4.4.2.</span> <span class="toc-text"> 预检请求</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E5%92%8C%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81"><span class="toc-number">3.</span> <span class="toc-text"> 数据库和身份认证</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-44"><span class="toc-number">3.1.</span> <span class="toc-text"> Node 操作 mysql</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-45"><span class="toc-number">3.1.1.</span> <span class="toc-text"> 配置 mysql 模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-46"><span class="toc-number">3.1.2.</span> <span class="toc-text"> 操作 mysql 数据库</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-47"><span class="toc-number">3.2.</span> <span class="toc-text"> Web 开发模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-48"><span class="toc-number">3.2.1.</span> <span class="toc-text"> 服务端渲染</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-49"><span class="toc-number">3.2.2.</span> <span class="toc-text"> 前后端分离</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-50"><span class="toc-number">3.2.3.</span> <span class="toc-text"> 如何选择</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-51"><span class="toc-number">3.3.</span> <span class="toc-text"> 身份认证</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-52"><span class="toc-number">3.3.1.</span> <span class="toc-text"> Session 认证机制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-53"><span class="toc-number">3.3.1.1.</span> <span class="toc-text"> Session 工作原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-54"><span class="toc-number">3.3.1.2.</span> <span class="toc-text"> Express 中使用 Session 认证</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-55"><span class="toc-number">3.3.2.</span> <span class="toc-text"> JWT 认证机制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-56"><span class="toc-number">3.3.2.1.</span> <span class="toc-text"> JWT 工作原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-57"><span class="toc-number">3.3.2.2.</span> <span class="toc-text"> Express 使用 JWT</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A4%A7%E4%BA%8B%E4%BB%B6%E5%90%8E%E5%8F%B0-api-%E9%A1%B9%E7%9B%AE"><span class="toc-number">4.</span> <span class="toc-text"> 大事件后台 API 项目</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#-58"><span class="toc-number">4.1.</span> <span class="toc-text"> 1. 项目初始化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-59"><span class="toc-number">4.1.1.</span> <span class="toc-text"> 1.1 创建项目</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-60"><span class="toc-number">4.1.2.</span> <span class="toc-text"> 1.2 配置 cors 跨域</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-61"><span class="toc-number">4.1.3.</span> <span class="toc-text"> 1.3 配置解析表单数据的中间件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-62"><span class="toc-number">4.1.4.</span> <span class="toc-text"> 1.4 初始化路由相关的文件夹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-63"><span class="toc-number">4.1.5.</span> <span class="toc-text"> 1.5 初始化用户路由模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-64"><span class="toc-number">4.1.6.</span> <span class="toc-text"> 1.6 抽离用户路由模块中的处理函数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-65"><span class="toc-number">4.2.</span> <span class="toc-text"> 2. 登录注册</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-66"><span class="toc-number">4.2.1.</span> <span class="toc-text"> 2.1 新建 ev_users 表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-67"><span class="toc-number">4.2.2.</span> <span class="toc-text"> 2.2 安装并配置 mysql 模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-68"><span class="toc-number">4.2.3.</span> <span class="toc-text"> 2.3 注册</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-69"><span class="toc-number">4.2.3.1.</span> <span class="toc-text"> 2.3.0 实现步骤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-70"><span class="toc-number">4.2.3.2.</span> <span class="toc-text"> 2.3.1 检测表单数据是否合法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-71"><span class="toc-number">4.2.3.3.</span> <span class="toc-text"> 2.3.2 检测用户名是否被占用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-72"><span class="toc-number">4.2.3.4.</span> <span class="toc-text"> 2.3.3 对密码进行加密处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-73"><span class="toc-number">4.2.3.5.</span> <span class="toc-text"> 2.3.4 插入新用户</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-74"><span class="toc-number">4.2.4.</span> <span class="toc-text"> 2.4 优化 res.send () 代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-75"><span class="toc-number">4.2.5.</span> <span class="toc-text"> 2.5 优化表单数据验证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-76"><span class="toc-number">4.2.6.</span> <span class="toc-text"> 2.6 登录</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-77"><span class="toc-number">4.2.6.1.</span> <span class="toc-text"> 2.6.0 实现步骤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-78"><span class="toc-number">4.2.6.2.</span> <span class="toc-text"> 2.6.1 检测登录表单的数据是否合法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-79"><span class="toc-number">4.2.6.3.</span> <span class="toc-text"> 2.6.2 根据用户名查询用户的数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-80"><span class="toc-number">4.2.6.4.</span> <span class="toc-text"> 2.6.3 判断用户输入的密码是否正确</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-81"><span class="toc-number">4.2.6.5.</span> <span class="toc-text"> 2.6.4 生成 JWT 的 Token 字符串</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-82"><span class="toc-number">4.2.7.</span> <span class="toc-text"> 2.7 配置解析 Token 的中间件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-83"><span class="toc-number">4.3.</span> <span class="toc-text"> 3. 个人中心</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-84"><span class="toc-number">4.3.1.</span> <span class="toc-text"> 3.1 获取用户的基本信息</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-85"><span class="toc-number">4.3.1.1.</span> <span class="toc-text"> 3.1.0 实现步骤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-86"><span class="toc-number">4.3.1.2.</span> <span class="toc-text"> 3.1.1 初始化路由模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-87"><span class="toc-number">4.3.1.3.</span> <span class="toc-text"> 3.1.2 初始化路由处理函数模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-88"><span class="toc-number">4.3.1.4.</span> <span class="toc-text"> 3.1.3 获取用户的基本信息</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-89"><span class="toc-number">4.3.2.</span> <span class="toc-text"> 3.2 更新用户的基本信息</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-90"><span class="toc-number">4.3.2.1.</span> <span class="toc-text"> 3.2.0 实现步骤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-91"><span class="toc-number">4.3.2.2.</span> <span class="toc-text"> 3.2.1 定义路由和处理函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-92"><span class="toc-number">4.3.2.3.</span> <span class="toc-text"> 3.2.2 验证表单数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-93"><span class="toc-number">4.3.2.4.</span> <span class="toc-text"> 3.2.3 实现更新用户基本信息的功能</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-94"><span class="toc-number">4.3.3.</span> <span class="toc-text"> 3.3 重置密码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-95"><span class="toc-number">4.3.3.1.</span> <span class="toc-text"> 3.3.0 实现步骤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-96"><span class="toc-number">4.3.3.2.</span> <span class="toc-text"> 3.3.1 定义路由和处理函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-97"><span class="toc-number">4.3.3.3.</span> <span class="toc-text"> 3.3.2 验证表单数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-98"><span class="toc-number">4.3.3.4.</span> <span class="toc-text"> 3.3.3 实现重置密码的功能</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-99"><span class="toc-number">4.3.4.</span> <span class="toc-text"> 3.4 更新用户头像</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-100"><span class="toc-number">4.3.4.1.</span> <span class="toc-text"> 3.4.0 实现步骤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-101"><span class="toc-number">4.3.4.2.</span> <span class="toc-text"> 3.4.1 定义路由和处理函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-102"><span class="toc-number">4.3.4.3.</span> <span class="toc-text"> 3.4.2 验证表单数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-103"><span class="toc-number">4.3.4.4.</span> <span class="toc-text"> 3.4.3 实现更新用户头像的功能</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-104"><span class="toc-number">4.4.</span> <span class="toc-text"> 4. 文章分类管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-105"><span class="toc-number">4.4.1.</span> <span class="toc-text"> 4.1 新建 ev_article_cate 表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-106"><span class="toc-number">4.4.2.</span> <span class="toc-text"> 4.2 获取文章分类列表</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-107"><span class="toc-number">4.4.2.1.</span> <span class="toc-text"> 4.2.0 实现步骤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-108"><span class="toc-number">4.4.2.2.</span> <span class="toc-text"> 4.2.1 初始化路由模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-109"><span class="toc-number">4.4.2.3.</span> <span class="toc-text"> 4.2.2 初始化路由处理函数模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-110"><span class="toc-number">4.4.2.4.</span> <span class="toc-text"> 4.2.3 获取文章分类列表数据</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-111"><span class="toc-number">4.4.3.</span> <span class="toc-text"> 4.3 新增文章分类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-112"><span class="toc-number">4.4.3.1.</span> <span class="toc-text"> 4.3.0 实现步骤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-113"><span class="toc-number">4.4.3.2.</span> <span class="toc-text"> 4.3.1 定义路由和处理函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-114"><span class="toc-number">4.4.3.3.</span> <span class="toc-text"> 4.3.2 验证表单数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-115"><span class="toc-number">4.4.3.4.</span> <span class="toc-text"> 4.3.3 查询分类名称与别名是否被占用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-116"><span class="toc-number">4.4.3.5.</span> <span class="toc-text"> 4.3.4 实现新增文章分类的功能</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-117"><span class="toc-number">4.4.4.</span> <span class="toc-text"> 4.4 根据 Id 删除文章分类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-118"><span class="toc-number">4.4.4.1.</span> <span class="toc-text"> 4.4.0 实现步骤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-119"><span class="toc-number">4.4.4.2.</span> <span class="toc-text"> 4.4.1 定义路由和处理函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-120"><span class="toc-number">4.4.4.3.</span> <span class="toc-text"> 4.4.2 验证表单数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-121"><span class="toc-number">4.4.4.4.</span> <span class="toc-text"> 4.4.3 实现删除文章分类的功能</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-122"><span class="toc-number">4.4.5.</span> <span class="toc-text"> 4.5 根据 Id 获取文章分类数据</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-123"><span class="toc-number">4.4.5.1.</span> <span class="toc-text"> 4.5.0 实现步骤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-124"><span class="toc-number">4.4.5.2.</span> <span class="toc-text"> 4.5.1 定义路由和处理函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-125"><span class="toc-number">4.4.5.3.</span> <span class="toc-text"> 4.5.2 验证表单数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-126"><span class="toc-number">4.4.5.4.</span> <span class="toc-text"> 4.5.3 实现获取文章分类的功能</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-127"><span class="toc-number">4.4.6.</span> <span class="toc-text"> 4.6 根据 Id 更新文章分类数据</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-128"><span class="toc-number">4.4.6.1.</span> <span class="toc-text"> 4.6.0 实现步骤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-129"><span class="toc-number">4.4.6.2.</span> <span class="toc-text"> 4.6.1 定义路由和处理函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-130"><span class="toc-number">4.4.6.3.</span> <span class="toc-text"> 4.6.2 验证表单数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-131"><span class="toc-number">4.4.6.4.</span> <span class="toc-text"> 4.5.4 查询分类名称与别名是否被占用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-132"><span class="toc-number">4.4.6.5.</span> <span class="toc-text"> 4.5.5 实现更新文章分类的功能</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-133"><span class="toc-number">4.5.</span> <span class="toc-text"> 5. 文章管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#-134"><span class="toc-number">4.5.1.</span> <span class="toc-text"> 5.1 新建 ev_articles 表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-135"><span class="toc-number">4.5.2.</span> <span class="toc-text"> 5.2 发布新文章</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-136"><span class="toc-number">4.5.2.1.</span> <span class="toc-text"> 5.2.0 实现步骤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-137"><span class="toc-number">4.5.2.2.</span> <span class="toc-text"> 5.2.1 初始化路由模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-138"><span class="toc-number">4.5.2.3.</span> <span class="toc-text"> 5.2.2 初始化路由处理函数模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-139"><span class="toc-number">4.5.2.4.</span> <span class="toc-text"> 5.2.3 使用 multer 解析表单数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-140"><span class="toc-number">4.5.2.5.</span> <span class="toc-text"> 5.2.4 验证表单数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-141"><span class="toc-number">4.5.2.6.</span> <span class="toc-text"> 5.2.5 实现发布文章的功能</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-map"><div class="card-content"><div class="item-headline"><i class="fa fa-globe-asia" aria-hidden="true"></i><span>Visitor Map</span></div><script id="clstr_globe" type="text/javascript" defer="defer" src="//clustrmaps.com/globe.js?d=4LA950xi3DtQgUHPlkO0mo-n_QgrcOu-1BIiVpExg7k"></script></div></div><div class="card-widget card-pixiv"><div class="card-content"><div class="item-headline"><i class="fa fa-image" aria-hidden="true"></i><span>Pixiv Top50</span><iframe src="https://cloud.mokeyjay.com/pixiv" frameborder="0" style="width:99%;height:380px;margin:0;"></iframe></div></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/04/02/linux%E5%B0%8F%E7%AC%94%E8%AE%B0/" title="Linux easy notes"><img src="https://w.wallhaven.cc/full/wq/wallhaven-wqvov7.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux easy notes"/></a><div class="content"><a class="title" href="/2022/04/02/linux%E5%B0%8F%E7%AC%94%E8%AE%B0/" title="Linux easy notes">Linux easy notes</a><time datetime="2022-04-01T11:00:00.000Z" title="Created 2022-04-02 00:00:00">2022-04-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/04/02/linux%E7%9A%84%E4%B8%80%E4%BA%9B%E5%91%BD%E4%BB%A4/" title="Linux commands"><img src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux commands"/></a><div class="content"><a class="title" href="/2022/04/02/linux%E7%9A%84%E4%B8%80%E4%BA%9B%E5%91%BD%E4%BB%A4/" title="Linux commands">Linux commands</a><time datetime="2022-04-01T11:00:00.000Z" title="Created 2022-04-02 00:00:00">2022-04-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/04/02/Linux/" title="Linux notes"><img src="https://w.wallhaven.cc/full/v9/wallhaven-v9v9o5.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux notes"/></a><div class="content"><a class="title" href="/2022/04/02/Linux/" title="Linux notes">Linux notes</a><time datetime="2022-04-01T11:00:00.000Z" title="Created 2022-04-02 00:00:00">2022-04-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/03/01/nodejs/" title="Nodejs notes"><img src="https://w.wallhaven.cc/full/q2/wallhaven-q2vzx5.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Nodejs notes"/></a><div class="content"><a class="title" href="/2022/03/01/nodejs/" title="Nodejs notes">Nodejs notes</a><time datetime="2022-02-28T11:00:00.000Z" title="Created 2022-03-01 00:00:00">2022-03-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/03/01/%E5%88%9D%E4%B8%AD%E7%BA%A7%E5%89%8D%E7%AB%AF%E9%9D%A2%E8%AF%95%E9%A2%98/" title="Frontend interview questions"><img src="https://w.wallhaven.cc/full/8o/wallhaven-8oply1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Frontend interview questions"/></a><div class="content"><a class="title" href="/2022/03/01/%E5%88%9D%E4%B8%AD%E7%BA%A7%E5%89%8D%E7%AB%AF%E9%9D%A2%E8%AF%95%E9%A2%98/" title="Frontend interview questions">Frontend interview questions</a><time datetime="2022-02-28T11:00:00.000Z" title="Created 2022-03-01 00:00:00">2022-03-01</time></div></div></div></div></div></div></main><footer id="footer" style="background: transparent"><div id="footer-wrap"><div class="copyright">&copy;2021 - 2022 By Harry Qu</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="Chat"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="Scroll To Comments"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Local search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>function loadDisqus () {
  var disqus_config = function () {
    this.page.url = 'https://harryqu1229.github.io/2022/03/01/nodejs(express,mysql%E4%BB%A5%E5%8F%8A%E5%A4%A7%E4%BA%8B%E4%BB%B6%E5%90%8E%E5%8F%B0%20API%20%E9%A1%B9%E7%9B%AE)/'
    this.page.identifier = '2022/03/01/nodejs(express,mysql以及大事件后台 API 项目)/'
    this.page.title = 'Nodejs notes + mysql + express + 项目'
  };

  window.disqusReset = () => {
    DISQUS.reset({
      reload: true,
      config: disqus_config
    })
  }

  if (window.DISQUS) disqusReset()
  else {
    (function() { 
      var d = document, s = d.createElement('script');
      s.src = 'https://harry-study-blog.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  }
}

if ('Disqus' === 'Disqus' || !false) {
  if (false) btf.loadComment(document.getElementById('disqus_thread'), loadDisqus)
  else loadDisqus()
} else {
  function loadOtherComment () {
    loadDisqus()
  }
}
</script><script>if (window.DISQUSWIDGETS === undefined) {
  var d = document, s = d.createElement('script');
  s.src = 'https://harry-study-blog.disqus.com/count.js';
  s.id = 'dsq-count-scr';
  (d.head || d.body).appendChild(s);
} else {
  DISQUSWIDGETS.getCount({reset: true});
}</script><script>function addGitalkSource () {
  const ele = document.createElement('link')
  ele.rel = 'stylesheet'
  ele.href= 'https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css'
  document.getElementsByTagName('head')[0].appendChild(ele)
}

function loadGitalk () {
  function initGitalk () {
    var gitalk = new Gitalk(Object.assign({
      clientID: '5df1e915e0fa867b50de',
      clientSecret: 'ce1cb793fe49078ee9d0102d3326d0d50ff6937b',
      repo: 'blog-comments-storage',
      owner: 'HarryQu1229',
      admin: ['HarryQu1229'],
      id: 'd0cb94b66fe9f7cacc1dd6f559a16209',
      updateCountCallback: commentCount
    },null))

    gitalk.render('gitalk-container')
  }

  if (typeof Gitalk === 'function') initGitalk()
  else {
    addGitalkSource()
    getScript('https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js').then(initGitalk)
  }
}

function commentCount(n){
  let isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
  if (isCommentCount) {
    isCommentCount.innerHTML= n
  }
}

if ('Disqus' === 'Gitalk' || !false) {
  if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
  else loadGitalk()
} else {
  function loadOtherComment () {
    loadGitalk()
  }
}</script></div><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[image]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[link]') // replace url
    content = content.replace(/<code>.*?<\/code>/gi, '[code]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getComment = () => {
    fetch('https://disqus.com/api/3.0/forums/listPosts.json?forum=harry-study-blog&related=thread&limit=6&api_key=B5XFmdGuVaYDW7OIBakffpXoKorvphwRiwONIol4puEtr8YiwYAMAk2K7QcExNLY')
      .then(response => response.json())
      .then(data => {
        const disqusArray = data.response.map(item => {
          return {
            'avatar': item.author.avatar.cache,
            'content': changeContent(item.message),
            'nick': item.author.name,
            'url': item.url,
            'date': item.createdAt
          }
        })

        saveToLocal.set('disqus-newest-comments', JSON.stringify(disqusArray), 10/(60*24))
        generateHtml(disqusArray)
      }).catch(e => {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.innerHTML= "Unable to get the data, please make sure the settings are correct."
      })
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }
        
        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick}</span><time> / ${btf.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += 'No Comment'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom.innerHTML= result
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('disqus-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><div class="aplayer no-destroy" data-id="2809513713" data-server="netease" data-type="playlist" data-autoplay="false" data-fixed="true" data-order="random" data-theme="#e9ccd3"> </div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/fireworks.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script>((window.gitter = {}).chat = {}).options = {
  disableDefaultChat: true,
};
document.addEventListener('gitter-sidecar-ready', (e) => {
  const GitterChat = e.detail.Chat
  let chat

  function initGitter () {
    chat = new GitterChat({
      room: 'HarryStudyBlog/community',
      activationElement: '#chat_btn'
    });
  }

  initGitter()

  if (true) {
    document.addEventListener('pjax:complete', () => {
      chat.destroy()
      initGitter()
    })
  }

})</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async="async" defer="defer"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/gh/metowolf/MetingJS@1.2/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --><script data-pjax>
  function butterfly_footer_beautify_injector_config(){
    var parent_div_git = document.getElementById('footer-wrap');
    var item_html = '<div id="workboard"></div><div id="ghbdages" style="overflow:hidden;max-height:90px;height:auto;text-align:center;margin-top:10px"><div class="swiper-wrapper"><div class="swiper-slide"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" title="博客框架为Hexo_v5.4.0"><img src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&amp;logo=hexo" alt=""/></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px" title="主题版本Butterfly_v3.8.2"><img src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&amp;logo=bitdefender" alt=""/></a><a class="github-badge" target="_blank" href="https://www.jsdelivr.com/" style="margin-inline:5px" title="本站使用JsDelivr为静态资源提供CDN加速"><img src="https://img.shields.io/badge/CDN-jsDelivr-orange?style=flat&amp;logo=jsDelivr" alt=""/></a></div><div class="swiper-slide"><a class="github-badge" target="_blank" href="https://vercel.com/" style="margin-inline:5px" title="本站采用双线部署，默认线路托管于Vercel"><img src="https://img.shields.io/badge/Hosted-Vercel-brightgreen?style=flat&amp;logo=Vercel" alt=""/></a><a class="github-badge" target="_blank" href="https://vercel.com/" style="margin-inline:5px" title="本站采用双线部署，联通线路托管于Coding"><img src="https://img.shields.io/badge/Hosted-Coding-0cedbe?style=flat&amp;logo=Codio" alt=""/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" title="本站项目由Github托管"><img src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&amp;logo=GitHub" alt=""/></a></div><div class="swiper-slide"><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" style="margin-inline:5px" title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"><img src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&amp;logo=Claris" alt=""/></a></div></div></div><style>a.github-badge:hover:before {display:none}</style>';
    console.log('已挂载butterfly_footer_beautify')
    parent_div_git.insertAdjacentHTML("beforeend",item_html)
    }
  var elist = 'undefined'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_footer_beautify_injector_config();
  }
  else if (epage === cpage){
    butterfly_footer_beautify_injector_config();
  }
  </script><script async src="/js/footer-beautify-runtime.js"></script><script defer src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.js"></script><script defer data-pjax src="https://npm.elemecdn.com/hexo-butterfly-footer-beautify/lib/swiperbdage_init.min.js"></script><script data-pjax src="https://npm.elemecdn.com/hexo-filter-gitcalendar/lib/gitcalendar.js"></script><script data-pjax>
  function gitcalendar_injector_config(){
      var parent_div_git = document.getElementById('recent-posts');
      var item_html = '<div class="recent-post-item" style="width:100%;height:auto;padding:10px;"><style>#git_container{min-height: 280px}@media screen and (max-width:650px) {#git_container{min-height: 0px}}</style><div id="git_loading" style="width:10%;height:100%;margin:0 auto;display: block;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 50 50" style="enable-background:new 0 0 50 50" xml:space="preserve"><path fill="#d0d0d0" d="M25.251,6.461c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615V6.461z" transform="rotate(275.098 25 25)"><animatetransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"></animatetransform></path></svg><style>#git_container{display: none;}</style></div><div id="git_container"></div></div>';
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
      console.log('已挂载gitcalendar')
      }

    if( document.getElementById('recent-posts') && (location.pathname ==='/'|| '/' ==='all')){
        gitcalendar_injector_config()
        GitCalendarInit("https://gitcalendar.akilar.top/api?HarryQu1229",['#ebedf0', '#fdcdec', '#fc9bd9', '#fa6ac5', '#f838b2', '#f5089f', '#c4067e', '#92055e', '#540336', '#48022f', '#30021f'],'HarryQu1229')
    }
  </script><!-- hexo injector body_end end --><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"position":"right","width":300,"height":450},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html>