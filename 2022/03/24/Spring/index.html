<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>My Spring notes | Harry World</title><meta name="keywords" content="backend,spring,java"><meta name="author" content="Harry Qu"><meta name="copyright" content="Harry Qu"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="# 一、Spring 框架概述   Spring 是轻量级的开源的 JavaEE 框架。   Spring 可以解决企业应用开发的复杂   Spring 有两个核心部分：IOC 和 Aop （1）IOC：控制反转，把创建对象过程交给 Spring 进行管理 （2）Aop：面向切面，不修改源代码进行功能增强   Spring 特点 ： （1）方便解耦，简化开发 （2）Aop 编程支持 （3）方便程序">
<meta property="og:type" content="article">
<meta property="og:title" content="My Spring notes">
<meta property="og:url" content="https://harryqu1229.github.io/2022/03/24/Spring/index.html">
<meta property="og:site_name" content="Harry World">
<meta property="og:description" content="# 一、Spring 框架概述   Spring 是轻量级的开源的 JavaEE 框架。   Spring 可以解决企业应用开发的复杂   Spring 有两个核心部分：IOC 和 Aop （1）IOC：控制反转，把创建对象过程交给 Spring 进行管理 （2）Aop：面向切面，不修改源代码进行功能增强   Spring 特点 ： （1）方便解耦，简化开发 （2）Aop 编程支持 （3）方便程序">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://w.wallhaven.cc/full/k7/wallhaven-k7v9yq.png">
<meta property="article:published_time" content="2022-03-23T11:00:00.000Z">
<meta property="article:modified_time" content="2022-06-12T01:14:05.022Z">
<meta property="article:author" content="Harry Qu">
<meta property="article:tag" content="java">
<meta property="article:tag" content="backend">
<meta property="article:tag" content="spring">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://w.wallhaven.cc/full/k7/wallhaven-k7v9yq.png"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://harryqu1229.github.io/2022/03/24/Spring/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: undefined,
  noticeOutdate: {"limitDay":100,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"prismjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"Traditional Chinese Activated Manually","cht_to_chs":"Simplified Chinese Activated Manually","day_to_night":"Dark Mode Activated Manually","night_to_day":"Light Mode Activated Manually","bgLight":"#C78550","bgDark":"#c08eaf","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'My Spring notes',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-06-12 13:14:05'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><style type="text/css">.aplayer.aplayer-fixed.aplayer-narrow .aplayer-body{left:-66px!important}.aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover{left:0!important}</style><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-footer-beautify@1.0.0/lib/runtime.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-filter-gitcalendar/lib/gitcalendar.css" media="print" onload="this.media='all'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">Loading...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/6aca34ee52f40fe1b2d637474f90111e2c151939/notes-img/%E5%85%B6%E4%B8%AD%E5%8C%85%E6%8B%AC%E5%9B%BE%E7%89%87%EF%BC%9A%7B%7B%20pinTitle%20%7D%7D_m6kogp.jpeg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">158</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">84</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">57</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-graduation-cap"></i><span> Journey</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> Hobbies</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/Music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/Photos/"><i class="fa-fw fas fa-images"></i><span> Photos</span></a></li><li><a class="site-page child" href="/Videos/"><i class="fa-fw fa-regular fa-play"></i><span> Videos</span></a></li><li><a class="site-page child" href="/Movies/"><i class="fa-fw fas fa-video"></i><span> Movies</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Links</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAT4AAACfCAMAAABX0UX9AAAAflBMVEX///9ssz5grihqsjtnsTViryzv9utosTdksDHX6c54uFH8/fuy1aDr8+dhrilerSS+26+YyH31+fLm8eBvtEKEvmLD3rXh7tqOw3CkzY3Q5cW82qzc69Ss0pj5/PfJ4b2RxHSdyoSoz5J+u1p1t0yhzImJwGhRqABZqxd9u1dz6HoFAAAITklEQVR4nO2aaZequhKGIYMJg0QRUEHB+er//4M3A1NodXefw1nSe9XzoVtjCPBSqapUcBwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABgcpReuEzT8zm9bbPVpy/mlxFkqaCEMSxhhAt8AgW/TXyinLl9MEFn79OX9UsoKHG/wtBtrn+eZ+Oe7oovf9GTmT/oE/G0gNFCdVgeRj3fKcJYxKMO+UHyiL1QT4IOjrNKyagn9LHr0nzUIT9Hdn8tnoSfg2R+HPVmD9JTiL8kMGXirXpyAovQyY9jnnKWCLEfc8DP4f1JPZcfZFbDxj3rejbueJ9iRvGf1Lupfue/ZK6NzONN1NCgpe5XFB++0ElSvMpYGr+HatlW6dPjyzgu+1+bD/EsDvr9gsDu0XxtO5Wl1d+0zVdtdtN++Nrtc5Tv1cMobecs/np0HPqMUna55uae1hd6Vj4t3l8oEuRctLcaEn5VHZaYX+SIwYHrtDm+EV+dYH28EM4e+9genCKEkpMacX4R7k615llVTEfAPX9nedGll66kX5xfiLj2m5hQsldW5TKXSCPNorqd83qxsrtjV2TOVTDsMl8uOqiLI3nEhstDZFIuCNb90aIdvKDN4ELa/4PID7J15YXZejG8kE8RPFup6YtmhIqDta7aD9dtW9Q7gOPAmakYzp1TL5TXjjOUT4ldr8bUhUmbIzk6lv/RPO2eoUyRDJuoG0RsHfVNyPXjwtkudpPJt6vB3JWiyQkjIuwfQm8wR4aZn054CBLC2FqUOzOlZxLKv4xTbp4M1fqF8gv2TZBS9qlXHVI+/aRSaVmM1RGsTqY3RlHCdR0jCtUZkJQvjxdFORnr2/TDLqNkE1a71ax82nd+sb+f5bH8uAqCVXFGjN1XRj5XihHdijy7GgGFMloln6vnJ0XKO/blk+0cb443050d1NgLbXuEbSsvW1LpEtxaPifcxfuppFBlz/PJKJG/8sm6PYjsNml87FZ/WR/OlVPL57KLub9ySbXvCmr51Mz2Kx0dLPlcE9zLo74aUTYBjR7N9czP5mgtn7PLnz/dD7DrHAxJdq/7rfVf1yqRzKVW5GR1M/Jhv224KkH4opUvavpb8tHGqR7UXKDyOgp93LUdJ2WdfBOiaK3PuKgXBJX+97AmzVy5PmwpauSjveXYRcqEz418vFW7Lx9rE0oTejLzM+75iphPUr5rE3jp9l230Ii0sQucWj4e9gTU8pH+UDo0RXHt+zqz7MvHK6tZGmuM7GYZ9ckU5VvWkYMc3vWK61+XdsKw1SbB6S1rFNTyRX0noJ2rbNHyUVunRr5o3Tar2Svl2ynRad+wV2iK8tWBV3v316T1/S0rqzlIjO0yLm5GWC0ftca6mLqoka/7pS8f6nzC0sinbBYn1sn4hOXjbxOpovFNA/mcMkW19TKkl15aPnttd8Z6Guq8r7dotuTrVKnly6RY+GGNk+Dpykff9fH+11z17cvmTp6KencOC6/xfZb1PTr5WC/t/oZ8dpbJpmh9OlNwybtC8vreLKMc/0m6OlukZm2Ko5mRT1h1UNfopOTrx5T38nnK97H+Y4jFFOU7kkHo+8IadZOIPy8Qx5mv07S9kY/3l8areq36M/lWwo4o0szpFOULuTu8UBtPdAEwvr/spuo2Mr0zvs/v/bBVPs91fiifriRYc+KMpyifniVvLisUoktDct/+sT+5TJpbp83tbDdmpHT4oXw6H+2devGH6/wQ8dvLKjdU9FK9pb01to/cbtITvXio17xt0W7FlNGoGsoP5dOyu7yZFVk97tTkM5OCPl/tVoSInlcMhNVtdXcx9Stjgiei17+1fC7d7GT7fK83oXRK/kP5nKVepVD9jtLuUK/MpyefWZs/2wRay6Qu6mcqGbd+3+k1G6XpdX9NuDEyU++Tzo5RmmCk4xLmqkDyU/lKXX12CSIJjZjMobWPntzeZqwerFrTD9jdBCOJ9bT5YFt7g+paOtG3Sq9N2rzWRlfvfjKqsx0tX1dBaeQL8NNVh2TevO1livgeHy7jpoFOXZAdeldhEjEs7GzwdB8++yqhbbEVC1WxMYmLdHlNJQLTi3kEaj+vr78qtYq1SQt7iaIKGXX5aua3+888mZtMcLS7Hg1TdupiapxvE0SwdGv2EiO/X4eHysYNjzghnCJfhxgjX+AEW0qlUXLkNm6hZJTzuD8cidQarrgT0SuVzQWnbhPRswtSg0dkb/J7thnhfsdG5whko655lp8eEZVTkaDLIJP2EHo6c8pdFu7Dqp7ljXyyPQ+3p6IXa8pFYQ2wqzeevL11plmxMLVkreFKDl6oLZc8GubjUyHQyQV3w6UrlHSYUHochuJCoO9sz3Ty/VuOdx52NflKh14+mSJ9H09I15xyrmTEBCXbL4WB3YOS27NDh4wmXy5dCheHxW4Wz9bZmQ6y8UkRIjd24os0PP4Iv1QFVoWPME6+9eRHlU/vdiIa1Vvu/FsP8BPo5UTBcRpWWVEssqrKPc/Lqyzc3lz1IgHm30tYx5u8qRi8pR5NVj0Z4xy9cMCEG6iBc8LM3uw3N1YDmWsM6nT/FO8mOKkzF+mO2RTDRst8lb1+14W43872qztCb/Y7f0RcHf1ICCTo4zqZtzJekN1fveWH0eYHszHejfv2UzmLJxlvh8xu6OlLppy8qaUCHZ6PhhaIeXT6FQ9/EnhLnTjX0jEuLgWI9xOC/JQyoaCXZTG58tqvICjLMpjO+68AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/Ff8HON5nz0oJk18AAAAASUVORK5CYII=')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Harry World</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-graduation-cap"></i><span> Journey</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> Hobbies</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/Music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/Photos/"><i class="fa-fw fas fa-images"></i><span> Photos</span></a></li><li><a class="site-page child" href="/Videos/"><i class="fa-fw fa-regular fa-play"></i><span> Videos</span></a></li><li><a class="site-page child" href="/Movies/"><i class="fa-fw fas fa-video"></i><span> Movies</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Links</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">My Spring notes</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2022-03-23T11:00:00.000Z" title="Created 2022-03-24 00:00:00">2022-03-24</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2022-06-12T01:14:05.022Z" title="Updated 2022-06-12 13:14:05">2022-06-12</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Backend/">Backend</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Backend/java/">java</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word count:</span><span class="word-count">19.5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading time:</span><span>71min</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="My Spring notes"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">Comments:</span><span class="disqus-comment-count"><a href="https://harryqu1229.github.io/2022/03/24/Spring/#disqus_thread"></a></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="一-spring框架概述"><a class="markdownIt-Anchor" href="#一-spring框架概述">#</a> 一、Spring 框架概述</h1>
<ol>
<li>
<p>Spring 是轻量级的开源的 JavaEE 框架。</p>
</li>
<li>
<p>Spring 可以解决企业应用开发的复杂</p>
</li>
<li>
<p>Spring 有两个核心部分：IOC 和 <a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=Aop&amp;spm=1001.2101.3001.7020">Aop</a></p>
<p>（1）IOC：控制反转，把创建对象过程交给 Spring 进行管理</p>
<p>（2）Aop：面向切面，不修改源代码进行功能增强</p>
</li>
<li>
<p>Spring 特点 ：</p>
<p>（1）方便解耦，简化开发</p>
<p>（2）Aop 编程支持</p>
<p>（3）方便程序测试</p>
<p>（4）方便和其他框架进行整合</p>
<p>（5）方便进行事务操作</p>
<p>（6）降低 API 开发难度</p>
</li>
</ol>
<hr>
<h1 id="二-ioc容器"><a class="markdownIt-Anchor" href="#二-ioc容器">#</a> 二、IOC 容器</h1>
<h2 id="1-ioc概念和原理"><a class="markdownIt-Anchor" href="#1-ioc概念和原理">#</a> 1. IOC 概念和原理</h2>
<p>（1）概念：</p>
<ul>
<li><strong>控制反转</strong>，把_对象创建_和_对象的调用_过程交给 spring 进行管理。</li>
<li>目的：<strong>降低耦合度。</strong></li>
<li>底层原理：<strong>xml，反射，工厂模式</strong></li>
</ul>
<h3 id="原理讲解"><a class="markdownIt-Anchor" href="#原理讲解">#</a> 原理讲解:</h3>
<p>一个类里面要用到另外一个类里面的方法，我们原始方式只能 new 然后调用，这么做这两个类的耦合度太高了</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220203203101819.png" alt="image-20220203203101819"></p>
<p>所以我们可以试着用工厂模式 (<strong>不是真正的工厂模式，而是说的简单了些</strong>) 稍微解决这个耦合度</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220203203341037.png" alt="image-20220203203341037"></p>
<p>这里我们创建了个工厂类，而我们需要 userDao 的对象调用方法时，就调用这个工厂类的方法返回一个这个 userDao 对象</p>
<blockquote>
<p>但是这么做耦合度还是有，并没有降到最低</p>
</blockquote>
<p><strong>所以我们使用 ioc (包含 xml 解析，工厂模式，反射)</strong></p>
<blockquote>
<p>基本概念就是还是工厂类，只不过那个工厂类里面不再是 new UserDao 然后返回了，而是通过<mark>解析我们一开始在 xml</mark> 配置好的 bean 对象然后获取到他的 class=&quot;XXX&quot; 的 XXX 这个值，这个 XXX 就是我们 userDao (比如说) 的__包名加类名__</p>
</blockquote>
<blockquote>
<p>有了__包名加类名__我们就可以通过反射获取到这个对象，并且存储下来在这个工厂类 (的实现类) 里面，以后别的地方要是要用就直接管我们这个工厂类 (的实现类) 要想要的对象就行了</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220203205046206.png" alt="image-20220203205046206"></p>
<p>Spring 提供 IOC 容器两种实现方式（两个接口）</p>
<ul>
<li>
<p><strong>BeanFactory</strong>：Spring 内部使用的接口，不提倡开发人员使用。</p>
<blockquote>
<p>特点：加载配置文件时不会创建 xml 里面配置的那些对象，获取对象时才会创建对象。</p>
</blockquote>
</li>
<li>
<p><strong>ApplicationContext:</strong> BeanFactory 的子接口，提供了更多更强大的功能，<strong>一般由开发人员使用</strong>。</p>
<blockquote>
<p>特点：加载配置文件时会把配置文件里的对象进行创建。</p>
<blockquote>
<p>这么做的好处就是服务器启动用这个就会创建好所有对象，之后用户使用起来速度就会快，而不能用户使用的时候再创建，毕竟可以慢自己 不能慢用户姥爷</p>
<p>所以一般都是用__ApplicationContext__</p>
</blockquote>
</blockquote>
</li>
</ul>
<blockquote>
<p>（1）BeanFactory：是 Spring 里面最底层的接口，包含了各种 Bean 的定义，读取 bean 配置文档，管理 bean 的加载、实例化，控制 bean 的生命周期，维护 bean 之间的依赖关系。ApplicationContext 接口作为 BeanFactory 的派生，除了提供 BeanFactory 所具有的功能外，还提供了更完整的框架功能：</p>
<p>​		①继承 MessageSource，因此支持国际化。</p>
<p>​		②统一的资源文件访问方式。</p>
<p>​		③提供在监听器中注册 bean 的事件。</p>
<p>​		④同时加载多个配置文件。</p>
<p>​		⑤载入多个（有继承关系）上下文 ，使得每一个上下文都专注于一个特定的层次，比如应用的 web 层。</p>
<p>（2）①BeanFactroy 采用的是<em><strong>延迟加载 (懒加载) 形式来注入 Bean</strong></em> 的，即只有在使用到某个 Bean 时 (调用 getBean ())，才对该 Bean 进行加载实例化。这样，我们就不能发现一些存在的 Spring 的配置问题。如果 Bean 的某一个属性没有注入，BeanFacotry 加载后，直至第一次使用调用 getBean 方法才会抛出异常。</p>
<p>​      ②ApplicationContext，它是在容器启动时，一次性创建了所有的 Bean。这样，在容器启动时，我们就可以发现 Spring 中存在的配置错误，这样有利于检查所依赖属性是否注入。 ApplicationContext 启动后预载入所有的单实例 Bean，通过预载入单实例 bean , 确保当你需要的时候，你就不用等待，因为它们已经创建好了。它还可以为 Bean 配置 lazy-init=true 来让 Bean 延迟实例化；</p>
<p>​     ③相对于基本的 BeanFactory，ApplicationContext 唯一的不足是占用内存空间。当应用程序配置 Bean 较多时，程序启动较慢。</p>
<p>（3）BeanFactory 通常以编程的方式被创建，ApplicationContext 还能以声明的方式创建，如使用 ContextLoader。</p>
<p>（4）BeanFactory 和 ApplicationContext 都支持 BeanPostProcessor、BeanFactoryPostProcessor 的使用，但两者之间的区别是：BeanFactory 需要手动注册，而 ApplicationContext 则是自动注册。</p>
</blockquote>
<ul>
<li>
<p>ApplicationContext 两个常用实现类：</p>
<ul>
<li>FileSystemXmlApplicationContext：<strong>绝对路径，从盘符开始算起</strong></li>
<li>ClassPathXmlApplicationContext：<strong>相对路径，从 src 开始算起</strong></li>
</ul>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/20210720000922.png" alt=""></p>
</li>
</ul>
<blockquote>
<ul>
<li>什么是 Bean 管理？
<ul>
<li>Bean 管理是指两个操作：<strong>Spring 创建对象</strong> 和 <strong>Spring 注入属性</strong></li>
<li>Bean 管理有两种操作方式：基于 xml 配置文件方式实现 和 基于注解方式实现</li>
</ul>
</li>
</ul>
</blockquote>
<hr>
<h2 id="2-ioc操作bean管理基于xml"><a class="markdownIt-Anchor" href="#2-ioc操作bean管理基于xml">#</a> 2. IOC 操作 Bean 管理（基于 xml）</h2>
<h3 id="xml实现bean管理"><a class="markdownIt-Anchor" href="#xml实现bean管理">#</a> xml 实现 Bean 管理：</h3>
<h4 id="1基于xml方式创建对象"><a class="markdownIt-Anchor" href="#1基于xml方式创建对象">#</a> （1）基于 xml 方式创建对象：</h4>
<blockquote>
<p>如果使用 maven, 创建完一个普通项目后，在 main 和 test 里面分别加上一个名叫 resources 的 directories, 记得右键选择 mark as… 对应的</p>
<p><strong>然后在 main 下面的 resources 里面再新建一个 xml 文件，用 bean 标签写上这个对象</strong></p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/20210719101725.png" alt=""></p>
<ul>
<li>
<p>在 Spring 配置文件中使用 bean 标签来创建对象</p>
</li>
<li>
<p>bean 标签有很多属性，常用属性：</p>
<ul>
<li><mark>id：唯一标识</mark></li>
<li><mark>class：类路径 (那个类的包名和类名)</mark></li>
</ul>
</li>
<li>
<p><strong>创建对象时，默认执行无参构造函数</strong>⭐️</p>
<p><mark>这是因为拿反射做出来这个类的对象，所以会默认执行无参的，所以那个类里面记得写个无参的构造函数</mark></p>
</li>
</ul>
<h4 id="2基于xml方式注入属性"><a class="markdownIt-Anchor" href="#2基于xml方式注入属性">#</a> （2）基于 xml 方式注入属性：</h4>
<h5 id="第一种方法使用set方法进行注入"><a class="markdownIt-Anchor" href="#第一种方法使用set方法进行注入">#</a> 第一种方法：使用 set 方法进行注入：</h5>
<p>首先先为类的属性提供 set 方法：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> userName<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> userAge<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setUserName</span><span class="token punctuation">(</span><span class="token class-name">String</span> userName<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>userName <span class="token operator">=</span> userName<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setUserAge</span><span class="token punctuation">(</span><span class="token class-name">String</span> userAge<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>userAge <span class="token operator">=</span> userAge<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getUserName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> userName<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getUserAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> userAge<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后在 xml 配置文件中通过 property 标签进行属性注入</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token comment">&lt;!--配置User对象--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>user<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.oymn.spring5.User<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>userName<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>haha<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>userAge<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>18<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这样就完成了</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 获取上下文对象, 传进去的参数就是我们的那个配置文件(maven默认会从resources里面去找,所以不需要其他路径信息)</span>
<span class="token class-name">ApplicationContext</span> applicationContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathXmlApplicationContext</span><span class="token punctuation">(</span><span class="token string">"bean1.xml"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 获取到保存在ioc容器(之前在xml文件)中配置的对象, 注意这个第二个参数"User.class"可以不传, 这里传了的话返回的就是这个类而不是Object</span>
<span class="token class-name">User</span> user <span class="token operator">=</span> applicationContext<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUserName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"     "</span> <span class="token operator">+</span> user<span class="token punctuation">.</span><span class="token function">getUserAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<ul>
<li><code>ApplicationContext对象.getBean(你在xml文件写的那个bean的id值[,转换成什么类型])</code> , 这样就能获取到我们在 xml 文件里面配置的 com.oymn.spring5.User__的实例化对象__, 返回的和这个实例化对象也是 com.oymn.spring5.User 这个类型的，因为我们传了第二个参数</li>
<li>我们就通过 spring 获取到了一个类的实例化对象，然后就可以调用这个对象的各种方法</li>
</ul>
</blockquote>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220205114819118.png" alt="image-20220205114819118"></p>
<h5 id="第二种方法使用有参构造函数进行注入"><a class="markdownIt-Anchor" href="#第二种方法使用有参构造函数进行注入">#</a> 第二种方法：使用有参构造函数进行注入</h5>
<p>首先提供有参构造方法</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> userName<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> userAge<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token class-name">String</span> userName<span class="token punctuation">,</span> <span class="token class-name">String</span> userAge<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>userName <span class="token operator">=</span> userName<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>userAge <span class="token operator">=</span> userAge<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后再 xml 配置文件中通过 constructor-arg 标签进行属性注入</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token comment">&lt;!--配置User对象--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>user<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.oymn.spring5.User<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>constructor-arg</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>userName<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>haha<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>constructor-arg</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>constructor-arg</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>userAge<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>18<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>constructor-arg</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="第三种方法p名称空间注入了解即可"><a class="markdownIt-Anchor" href="#第三种方法p名称空间注入了解即可">#</a> 第三种方法：p 名称空间注入（了解即可）</h5>
<p>首先在 xml 配置文件中添加 p 名称空间，并且在 bean 标签中进行操作</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/20210719104230.png" alt=""></p>
<p>然后提供 set 方法</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> userName<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> userAge<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setUserName</span><span class="token punctuation">(</span><span class="token class-name">String</span> userName<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>userName <span class="token operator">=</span> userName<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setUserAge</span><span class="token punctuation">(</span><span class="token class-name">String</span> userAge<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>userAge <span class="token operator">=</span> userAge<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="3xml注入其他属性"><a class="markdownIt-Anchor" href="#3xml注入其他属性">#</a> （3）xml 注入其他属性</h4>
<h5 id="null值"><a class="markdownIt-Anchor" href="#null值">#</a> null 值</h5>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>配置<span class="token class-name">User</span>对象<span class="token operator">--</span><span class="token operator">></span>
<span class="token operator">&lt;</span>bean id<span class="token operator">=</span><span class="token string">"user"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"com.oymn.spring5.User"</span><span class="token operator">></span>
    <span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">"userName"</span><span class="token operator">></span> <span class="token operator">&lt;</span><span class="token keyword">null</span><span class="token operator">/</span><span class="token operator">></span> <span class="token operator">&lt;</span><span class="token operator">/</span>property<span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>bean<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="属性值包含特殊符号"><a class="markdownIt-Anchor" href="#属性值包含特殊符号">#</a> 属性值包含特殊符号</h5>
<p>假设现在 userName 属性需要赋值为 &lt;haha&gt;</p>
<p>如果像上面那样直接在 value 中声明的话会报错，因为包含特殊符号 &lt;&gt;</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/20210720003501.png" alt=""></p>
<p>需要通过  <code>&lt;![CDATA[值]]&gt;</code>  来表示</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/20210720003720.png" alt=""></p>
<h5 id="注入属性外部bean"><a class="markdownIt-Anchor" href="#注入属性外部bean">#</a> 注入属性 —— 外部 bean</h5>
<p>有两个类：UserService 和 UserDaoImpl，其中 UserDaoImpl 实现 UserDao 接口</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token class-name">UserDao</span> userDao<span class="token punctuation">;</span>   <span class="token comment">//注意需要这个成员,并且需要constructor里面设置或者setter设置.这样才可以注入依赖</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setUserDao</span><span class="token punctuation">(</span><span class="token class-name">UserDao</span> userDao<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>userDao <span class="token operator">=</span> userDao<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"add"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过 ref 来指定创建 userDaoImpl</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>userDaoImpl<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.oymn.spring5.UserDaoImpl<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>userService<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.oymn.spring5.UserService<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>userDao<span class="token punctuation">"</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>userDaoImpl<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span> //是ref不是value!!!
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220205131841290.png" alt="image-20220205131841290"></p>
<h5 id="注入属性内部bean"><a class="markdownIt-Anchor" href="#注入属性内部bean">#</a> 注入属性 —— 内部 bean</h5>
<p>不通过 ref 属性，而是通过嵌套一个 bean 标签实现</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token comment">&lt;!--内部 bean--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>emp<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.atguigu.spring5.bean.Emp<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
     <span class="token comment">&lt;!--设置两个普通属性--></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ename<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>lucy<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>gender<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>女<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
     <span class="token comment">&lt;!--设置对象类型属性--></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dept<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dept<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.atguigu.spring5.bean.Dept<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        	 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dname<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>安保部<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="注入属性级联赋值"><a class="markdownIt-Anchor" href="#注入属性级联赋值">#</a> 注入属性 —— 级联赋值</h5>
<p><strong>写法一：也就是上面所说的外部 bean，通过 ref 属性来获取外部 bean</strong></p>
<p>写法二：emp 类中有 ename 和 dept 两个属性，其中 dept 有 dname 属性，<strong>写法二需要 emp 提供 dept 属性的 get 方法</strong>。</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token comment">&lt;!--级联赋值--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>emp<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.atguigu.spring5.bean.Emp<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token comment">&lt;!--设置两个普通属性--></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ename<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>lucy<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>gender<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>女<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
    <span class="token comment">&lt;!--写法一--></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dept<span class="token punctuation">"</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dept<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
    <span class="token comment">&lt;!--写法二(感觉没必要)--></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dept.dname<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>技术部<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span> //这个需要Emp类里面的dept属性有get															   方法
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dept<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.atguigu.spring5.bean.Dept<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dname<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>财务部<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>对于第二种写法的说明:</p>
<p>用 set 可以仅仅修改被直接 set 的成员，但不能修改这个成员的内部属性</p>
<p>但如果 xml get 到那个属性，就会得到一个默认值 &quot;对象&quot;, 若该对象某属性也可以被 set 注入，该属性就会被按照我们 xml 设置的所被 set 到想要的值</p>
</blockquote>
<h5 id="注入集合属性数组listmap"><a class="markdownIt-Anchor" href="#注入集合属性数组listmap">#</a> 注入集合属性（数组，List，Map）</h5>
<p>假设有一个 Stu 类</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Stu</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> courses<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> list<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">></span></span> map<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> set<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setCourses</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> courses<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>courses <span class="token operator">=</span> courses<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setList</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> list<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>list <span class="token operator">=</span> list<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setMap</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> map<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>map <span class="token operator">=</span> map<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setSet</span><span class="token punctuation">(</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> set<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>set <span class="token operator">=</span> set<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在 xml 配置文件中对这些集合属性进行注入</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stu<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.oymn.spring5.Stu<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token comment">&lt;!--数组类型属性注入--></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>courses<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>array</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>java课程<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>数据库课程<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>array</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
    <span class="token comment">&lt;!--List类型属性注入--></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>list<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>list</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>张三<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>李四<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>list</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
    <span class="token comment">&lt;!--Map类型属性注入--></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>map<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>map</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>JAVA<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>java<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>entry</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>PHP<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>php<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>entry</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>map</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
    <span class="token comment">&lt;!--Set类型属性注入--></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>set<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>set</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>Mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>Redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>set</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong><mark>上面的集合值都是字符串，如果是对象的话，如下：</mark></strong></p>
<p>写法： 集合 + 外部 bean</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token comment">&lt;!--创建多个 course 对象--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>course1<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.atguigu.spring5.collectiontype.Course<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>cname<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Spring5 框架<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>course2<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.atguigu.spring5.collectiontype.Course<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>cname<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>MyBatis 框架<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span>

<span class="token comment">&lt;!--注入 list 集合类型，值是对象--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>courseList<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>list</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ref</span> <span class="token attr-name">bean</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>course1<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ref</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ref</span> <span class="token attr-name">bean</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>course2<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ref</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>list</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="把集合注入部分提取出来"><a class="markdownIt-Anchor" href="#把集合注入部分提取出来">#</a> 把集合注入部分提取出来</h5>
<p>使用 util 标签，这样不同的 bean 都可以使用相同的集合注入部分了。</p>
<p>(其实就是县创建出来那个 list 或者什么什么结合，然后就把他看做是之前那种 bean 的一个对象，直接 ref 外部 bean 方式注入完事)</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token comment">&lt;!--将集合注入部分提取出来--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">util:</span>list</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>booklist<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>易筋经<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>九阳神功<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">util:</span>list</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>book<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.oymn.spring5.Book<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>list<span class="token punctuation">"</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>booklist<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="factorybean"><a class="markdownIt-Anchor" href="#factorybean">#</a> FactoryBean</h5>
<p>Spring 有两种 Bean，一种是普通 Bean，另一种是工厂 Bean（FactoryBean）</p>
<ul>
<li>普通 bean:</li>
</ul>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220205140611570.png" alt="image-20220205140611570"> 普通 bean 就是我们上面做的那些都是</p>
<ul>
<li>工厂 bean:</li>
</ul>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220205140631061.png" alt="image-20220205140631061"></p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220205140732517.png" alt="image-20220205140732517"></p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220205141546112.png" alt="image-20220205141546112"></p>
<p>然后你在别的地方用 ApplicationContext (的实现类) 然后 getBean (‘myBean	’,Course.class) 获取到的就是 Course 对象而不是 MyBean 对象</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220205142003379.png" alt="image-20220205142003379"></p>
<p>(myBean 还是要写的因为在 xml 里面给这个 bean 的 id 就是 myBean)</p>
<blockquote>
<p>通过 factorybean 来配置 bean 的实例，但是实际返回的是实例确实是 factorybean 的 getobject () 方法返回的实例</p>
</blockquote>
<hr>
<h3 id="bean的作用域"><a class="markdownIt-Anchor" href="#bean的作用域">#</a> Bean 的作用域：</h3>
<blockquote>
<p><strong>在 Spring 中，默认情况下 bean 是单实例对象</strong></p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/cff49fe976e9ebcd0d52128b40f1c074.png" alt=""></p>
<p>执行结果是相同的：</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/20210719113122.png" alt=""></p>
<blockquote>
<p><strong>通过 bean 标签的 scope 属性 来设置单实例还是多实例。</strong></p>
</blockquote>
<p><strong>Scope 属性值：</strong></p>
<ul>
<li><strong>singleton:</strong> <mark>默认值</mark>，表示单实例对象。<strong>加载配置文件时就会创建单实例对象。</strong></li>
<li><strong>prototype:</strong> 表示多实例对象。<mark>不是在加载配置文件时创建对象</mark>，在<strong>调用 getBean 方法时创建多实例对象。</strong></li>
</ul>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/20210719113500.png" alt=""></p>
<p>执行结果不同了：</p>
<p><img src="https://gitee.com/oymn/img_upload/raw/master/img/20210719113518.png" alt=""></p>
<p>所以就是你每次 getBean 这个 User 类的对象，获取的都是这个类的不同实例化对象</p>
<hr>
<h3 id="bean的生命周期"><a class="markdownIt-Anchor" href="#bean的生命周期">#</a> Bean 的生命周期：</h3>
<ol>
<li><strong>bean 的生命周期：</strong></li>
</ol>
<p>（1）通过构造器创建 bean 实例（无参数构造）</p>
<p>（2）为 bean 的属性设置值和对其他 bean 引用（调用 set 方法）</p>
<p>（3）把 bean 实例传递 bean 后置处理器的方法 postProcessBeforeInitialization</p>
<p>（4）调用 bean 的初始化的方法（需要进行配置初始化的方法）</p>
<p>（5）把 bean 实例传递 bean 后置处理器的方法 postProcessAfterInitialization</p>
<p>（6）bean 可以使用了（对象获取到了）</p>
<p>（7）当容器关闭时候，调用 bean 的销毁的方法（需要进行配置销毁的方法）</p>
<ol start="2">
<li><strong>演示 bean 的生命周期</strong></li>
</ol>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Orders</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> orderName<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Orders</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"第一步：执行无参构造方法创建bean实例"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setOrderName</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderName<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>orderName <span class="token operator">=</span> orderName<span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"第二步：调用set方法设置属性值"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//初始化方法</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"第四步：执行初始化方法"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//销毁方法</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">destroyMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"第七步：执行销毁方法"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//实现后置处理器，需要实现BeanPostProcessor接口</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyBeanPost</span> <span class="token keyword">implements</span> <span class="token class-name">BeanPostProcessor</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">postProcessBeforeInitialization</span><span class="token punctuation">(</span><span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"第三步：将bean实例传递给bean后置处理器的postProcessBeforeInitialization方法"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">postProcessAfterInitialization</span><span class="token punctuation">(</span><span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"第五步：将bean实例传递给bean后置处理器的postProcessAfterInitialization方法"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>orders<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.oymn.spring5.Orders<span class="token punctuation">"</span></span> <span class="token attr-name">init-method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>initMethod<span class="token punctuation">"</span></span> <span class="token attr-name">destroy-method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>destroyMethod<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>orderName<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hahah<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span>

<span class="token comment">&lt;!--配置bean后置处理器，这样配置后整个xml里面的bean用的都是这个后置处理器--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>myBeanPost<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.oymn.spring5.MyBeanPost<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testOrders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

    <span class="token class-name">ClassPathXmlApplicationContext</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathXmlApplicationContext</span><span class="token punctuation">(</span><span class="token string">"bean1.xml"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Orders</span> orders <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">"orders"</span><span class="token punctuation">,</span> <span class="token class-name">Orders</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"第六步：获取bean实例对象"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>orders<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//手动让bean实例销毁</span>
    context<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>注意要是 <code>ApplicationContext context = new ClassPathXmlApplicationContext(&quot;bean1.xml&quot;);</code>  的话，那么在关闭的时候需要把 context 强转成 ClassPathXmlApplicationContext 类型的引用，这是因为 ApplicationContext 这个接口貌似没有声明这个 close 方法</p>
</blockquote>
<p>执行结果：</p>
<p><img src="https://gitee.com/oymn/img_upload/raw/master/img/20210720122628.png" alt=""></p>
<hr>
<h3 id="xml自动装配"><a class="markdownIt-Anchor" href="#xml自动装配">#</a> xml 自动装配：</h3>
<ul>
<li>根据指定的装配规则（属性名称或者属性类型），Spring 自动将匹配的属性值进行注入</li>
<li>根据属性名称自动装配：要求__emp 中属性 (成员) 的名称 dept 和 bean 标签的 id 值 dept__一样，才能识别</li>
</ul>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token comment">&lt;!--指定autowire属性值为byName--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>emp<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.oymn.spring5.Emp<span class="token punctuation">"</span></span> <span class="token attr-name">autowire</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>byName<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dept<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.oymn.spring5.Dept<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>根据属性类型自动装配：要求同一个 xml 文件中不能有两个相同类型的 bean，否则无法识别是哪一个</li>
</ul>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token comment">&lt;!--指定autowire属性值为byType--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>emp<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.oymn.spring5.Emp<span class="token punctuation">"</span></span> <span class="token attr-name">autowire</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>byType<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dept<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.oymn.spring5.Dept<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>这种方式就不用我们在里面手动写 property 标签什么的了</p>
<p>(当然那个对应的 type 或者 name 的那个对象 bean 在 xml 里写好了)</p>
</blockquote>
<hr>
<h3 id="通过外部属性文件来操作bean"><a class="markdownIt-Anchor" href="#通过外部属性文件来操作bean">#</a> 通过外部属性文件来操作 bean：</h3>
<p>例如配置数据库信息：</p>
<ol>
<li>
<p>导入德鲁伊连接池 jar 包</p>
</li>
<li>
<p>创建外部属性文件，properties 格式文件，写数据库信息</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/20210731004522.png" alt=""></p>
</li>
<li>
<p>引入 context 名称空间，并通过 context 标签引入外部属性文件，使用 “${}” 来获取文件中对应的值</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/5a95d9954406da48288cfd27172e5f6d.png" alt=""></p>
</li>
</ol>
<hr>
<h2 id="3-ioc操作bean管理基于注解"><a class="markdownIt-Anchor" href="#3-ioc操作bean管理基于注解">#</a> 3. IOC 操作 Bean 管理（基于注解）</h2>
<ul>
<li>
<p>格式：@注解名称（属性名 = 属性值，属性名 = 属性值，……）</p>
</li>
<li>
<p>注解可以作用在类，属性，方法。</p>
</li>
<li>
<p>使用注解的目的：简化 xml 配置</p>
</li>
</ul>
<h3 id="1基于注解创建对象"><a class="markdownIt-Anchor" href="#1基于注解创建对象">#</a> （1）基于注解创建对象：</h3>
<p>spring 提供了四种创建对象的注解：</p>
<ul>
<li>@Component</li>
<li>@Service：一般用于 Service 层</li>
<li>@Controller：一般用于 web 层</li>
<li>@Repository：一般用于 Dao 层</li>
</ul>
<blockquote>
<p>其实哪里都可以用随便的只不过推荐比如说 dao 层用 @Repository</p>
<p>注意是给实现类 (那个可以被实例化而且你想放入 IOC 容器帮你管理的，别把这个给了注解！！！(注解又实例化不了) 虽然那个属性的类型可能是接口类型的但我们想注入的是实现那个接口的实现类)</p>
</blockquote>
<p>流程：</p>
<ol>
<li>
<p>引入依赖：</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/20210731144620.png" alt=""></p>
</li>
<li>
<p>开启组件扫描：<strong>扫描 base-package 包下所有有注解的类并为其创建对象</strong></p>
<p>如果有多个包可以放他们的父亲包，或者都写下来中间拿逗号分开</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">context:</span>component-scan</span> <span class="token attr-name">base-package</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.oymn<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">context:</span>component-scan</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<blockquote>
<p>这里就是 (靠反射) 扫描看你这个包哪个类上面有那些注解，然后 (靠反射) 创造那个带有注解的那个类的对象，根据注解创造对象</p>
</blockquote>
</li>
<li>
<p>com.oymn.spring5.Service 有一个 stuService 类</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//这里通过@Component注解来创建对象,括号中value的值等同于之前xml创建对象使用的id,为了后面使用时通过id来获取对象</span>

<span class="token comment">//括号中的内容也可以省略,默认是类名并且首字母小写!!!!!!!! </span>

<span class="token comment">//可以用其他三个注解</span>
<span class="token annotation punctuation">@Component</span><span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token string">"stuService"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StuService</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"addService"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>那个注解后面的值或者是默认的其实就是之前我们给 id 写的那个</p>
<p>所以之后要是 getBean, 里面第一个参数就是 &quot;stuService&quot; 来获取 StuService 类的对象</p>
</blockquote>
</li>
<li>
<p>这样就可以通过 getBean 方法来获取 stuService 对象了</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">ClassPathXmlApplicationContext</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathXmlApplicationContext</span><span class="token punctuation">(</span><span class="token string">"bean4.xml"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">StuService</span> stuService <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">"stuService"</span><span class="token punctuation">,</span> <span class="token class-name">StuService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>stuService<span class="token punctuation">)</span><span class="token punctuation">;</span>
stuService<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ol>
<p><strong>开启组件扫描的细节配置：</strong></p>
<blockquote>
<p><strong>1. use-default-fileters 设置为 false 表示不使用默认过滤器，通过 include-filter 来设置只扫描 com.oymn 包下的所有 @Controller 修饰的类。</strong></p>
</blockquote>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">context:</span>component-scan</span> <span class="token attr-name">base-package</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.oymn<span class="token punctuation">"</span></span> <span class="token attr-name">use-default-filters</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">context:</span>include-filter</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>annotation<span class="token punctuation">"</span></span> <span class="token attr-name">expression</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.springframework.stereotype.Controller<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">context:</span>component-scan</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<ol start="2">
<li>use-default-fileters 没有设置为 false (代表没有关掉默认的 filter),exclude-filter 设置哪些注解不被扫描，例子中为 @Controller 修饰的类不被扫描</li>
</ol>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">context:</span>component-scan</span> <span class="token attr-name">base-package</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.oymn<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">context:</span>exclude-filter</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>annotation<span class="token punctuation">"</span></span> <span class="token attr-name">expression</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.springframework.stereotype.Controller<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">context:</span>component-scan</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<hr>
<h3 id="2基于注解进行属性注入"><a class="markdownIt-Anchor" href="#2基于注解进行属性注入">#</a> （2）基于注解进行属性注入：</h3>
<ul>
<li>
<p><strong> <code>@Autowired</code> </strong>：根据__属性类型__自动装配 (注入依赖)</p>
<p>创建 StuDao 接口和 StuDaoImpl 实现类，为 StuDaoImpl 添加创建对象注解</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">StuDao</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Repository</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StuDaoImpl</span> <span class="token keyword">implements</span> <span class="token class-name">StuDao</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"StuDaoImpl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>StuService 类中添加 StuDao 属性，为其添加 @Autowire 注解，spring 会自动为 stuDao 属性创建 StuDaoImpl 对象</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span><span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token string">"stuService"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StuService</span> <span class="token punctuation">&#123;</span>
    
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">public</span> <span class="token class-name">StuDao</span> stuDao<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"addService"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stuDao<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token class-name">ClassPathXmlApplicationContext</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathXmlApplicationContext</span><span class="token punctuation">(</span><span class="token string">"bean4.xml"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">StuService</span> stuService <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">"stuService"</span><span class="token punctuation">,</span> <span class="token class-name">StuService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>stuService<span class="token punctuation">)</span><span class="token punctuation">;</span>
    stuService<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<ul>
<li>
<p>上面 StuDaoImpl 通过 <code>@Repository</code>  注解交给 IOC 容器管理创建对象</p>
</li>
<li>
<p>StuService 通过 <code>@Component(value=&quot;stuService&quot;)</code>  注解交给 IOC 容器管理创建对象</p>
</li>
<li>
<p>然后 StuService 里面的属性 <code>public StuDao stuDao;</code>  上面又通过 <code>@Autowired</code>  注解让根据数据类型自动装配 (注入依赖)</p>
</li>
<li>
<p>所以这个属性的数据类型就是 StuDao, 就会给 IOC 容器创建的 StuService 类的对象的身上的 stuDao 属性都装配 IOC 容器中生成 (上面) 的 StuDaoImpl 类的那个对象 (<strong>这里不是很清楚是不是通过找对应的 id 才找到那个对象还是直接用这个属性的名字反射还是啥的</strong>)</p>
</li>
</ul>
<p><mark>注意！这个 StuDao 是接口，真正注入给 StuService 类的对象的身上的 stuDao 属性的值是我们之前通过 <code>@Repository</code>  注解交给 IOC 容器管理创建的 StuDaoImpl 对象</mark></p>
<p>如果设置为了多例模式可能会不太一样…</p>
</blockquote>
<p>测试结果：</p>
<p><img src="https://gitee.com/oymn/img_upload/raw/master/img/20210731164052.png" alt=""></p>
</li>
<li>
<p><strong> <code>@Qualifier</code> </strong>：根据__属性名__称自动装配</p>
<p>当遇到一个接口有很多实现类时，只通过 @Autowire 是无法完成自动装配的，所以需要再使用 @Qualifier 通过名称来锁定某个类</p>
<blockquote>
<p>比如说上面的 StuDao 类型的 stuDao, 这个 StuDao 是个接口，然后实现类有 StuDaoImpl 和 StuDaoImpl2 都用 <code>@Repository</code>  注解交给 IOC 容器管理创建对象.</p>
<p>要是我们使用 <code>@Autowired</code>  按照属性类型就不知道是注入 StuDaoImpl 对象还是 StuDaoImpl2 对象</p>
<p>所以这时候可以把用 **<mark> 结合</mark> <code>@Autowired</code>  和 <code>@Qualifier(value=&quot;stuDaoImpl&quot;)</code> <mark> 这俩一块使用</mark> ** 注解然后传值想要给这个属性注入的是哪个对象就行了</p>
<p>(会去 IOC 容器中保管的__id 为 stuDaoImpl (所以小写没关系，因为之前给这个类的注解 @Repository 没传值，默认就是第一个字母小写的，所以能对上那个 id)__的那个类的对象)</p>
</blockquote>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span><span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token string">"stuService"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StuService</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token string">"stuDaoImpl"</span><span class="token punctuation">)</span>  <span class="token comment">//这样就能显式指定stuDaoImpl这个实现类</span>
    <span class="token keyword">public</span> <span class="token class-name">StuDao</span> stuDao<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"addService"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stuDao<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>这里 <code>@Autowired</code>  代表去找 StuDao 接口类型的实现类到的对象，然后我们需要加上 <code>@Qualifier(value=&quot;stuDaoImpl&quot;)</code>  代表找的是 stuDaoImpl 这个实现类的对象，而不是别的实现类的对象</p>
</blockquote>
</li>
<li>
<p><strong> <code>@Resource</code> </strong>：可以根据类型注入，也可以根据名称注入</p>
<p>这个注解本身是 javax (java 的) 扩展包，不是属于 Spring 的，不建议用这个 (JDK11 版本及以上完全移除了 javax 扩展，因此不能使用 @Resource 注解)</p>
<blockquote>
<p>注意！！！！@Resource 默认应该是按照属性名来注入，按照属性类型注入要写 <code>@Resource（type=UserDaoImpl.class）</code></p>
</blockquote>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span><span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token string">"stuService"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StuService</span> <span class="token punctuation">&#123;</span>
    
    <span class="token comment">//@Resource   //根据名称进行注入</span>
    <span class="token annotation punctuation">@Resource</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"stuDaoImpl"</span><span class="token punctuation">)</span>  <span class="token comment">//根据名称进行注入</span>
    <span class="token keyword">public</span> <span class="token class-name">StuDao</span> stuDao<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"addService"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stuDao<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p><strong> <code>@Value</code> </strong>：注入普通类型属性，<mark> 上面那三个都是针对于注入的是个对象且由 IOC 容器保管</mark></p>
<p>一般都是开发中会用到 @value 去动态读取服务器端口号，或者是配置环境是生产环境还是上线环境等等</p>
<p>下面示范的是直接写死的</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"abc"</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
</ul>
<blockquote>
<p>注意上面注解后面括号里给的值，一般都是小字母开头 (有的时候不给默认的也是小字母开头), 没有影响，这还是因为能找到匹配的 id 值 (或者其他…)</p>
<p>注意用注解方式注入依赖就不需要给那些属性设置 setter 也可以注入了</p>
</blockquote>
<hr>
<h3 id="3完全注解开发"><a class="markdownIt-Anchor" href="#3完全注解开发">#</a> （3）完全注解开发：</h3>
<p>创建配置类，替代 xml 配置文件</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>    <span class="token comment">//表明为一个配置类</span>
<span class="token annotation punctuation">@ComponentScan</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token string">"com.oymn"</span><span class="token punctuation">)</span>   <span class="token comment">//开启组件扫描</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpringConfig</span> <span class="token punctuation">&#123;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>测试类：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token comment">//创建AnnotationConfigApplicationContext对象(不再是之前那个ClassPathXmlApplicationContext对象了)</span>
    <span class="token class-name">AnnotationConfigApplicationContext</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AnnotationConfigApplicationContext</span><span class="token punctuation">(</span><span class="token class-name">SpringConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//加载那个配置类</span>
    <span class="token class-name">StuService</span> stuService <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">"stuService"</span><span class="token punctuation">,</span> <span class="token class-name">StuService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>stuService<span class="token punctuation">)</span><span class="token punctuation">;</span>
    stuService<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<h1 id="三-aop"><a class="markdownIt-Anchor" href="#三-aop">#</a> 三、AOP</h1>
<h2 id="先说说静态代理和动态代理"><a class="markdownIt-Anchor" href="#先说说静态代理和动态代理">#</a> 先说说静态代理和动态代理</h2>
<h3 id="静态代理"><a class="markdownIt-Anchor" href="#静态代理">#</a> 静态代理</h3>
<ul>
<li>首先有个接口，这个接口有方法</li>
<li>然后有个类 (代理类) 实现这个接口，并且这个代理类有成员类型就是这个接口</li>
</ul>
<p>接口:</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220205231621588.png" alt="image-20220205231621588"></p>
<p>代理类:</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220205231717926.png" alt="image-20220205231717926"></p>
<blockquote>
<p>注意这里的代理类是用他那个 (接口类型的) 成员，来调用同一个方法，也就是接口的那一个方法</p>
</blockquote>
<p>被代理类:</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220205231854453.png" alt="image-20220205231854453"></p>
<p>接着我们可以创建个类用来测试上面的:</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220205232017372.png" alt="image-20220205232017372"></p>
<p>结果为:</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220205232200507.png" alt="image-20220205232200507"></p>
<blockquote>
<ul>
<li>这里我们先是实例化了一个被代理对象</li>
<li>接着我们把这个实例化对象作为参数传进我们代理对象的构造函数里面</li>
<li>因为代理对象有一个 (接口类型的) 成员接收到了这个传进来的被代理实例化对象</li>
<li>接着我们用哪个创造出来的代理实例化对象的 produceCloth 方法</li>
<li>这个代理实例化对象的 produceCloth 方法实现方式其实就是调用了他那个 (接收到传进去被代理实例化对象的) 成员的实现方法</li>
<li>因为这两个类都实现了同一个接口所以实现的方法都是一样的</li>
</ul>
<p><strong>静态代理就是编译期间就已经确定了代理类和被代理类是什么类.</strong></p>
</blockquote>
<p><strong>静态代理作用:</strong></p>
<p>某个对象提供一个代理，代理角色固定，以控制对这个对象的访问。 代理类和委托类有共同的父类或父接口，这样在任何使用委托类对象的地方都可以用代理对象替代。代理类负责请求的预处理、过滤、将请求分派给委托类处理、以及委托类执行完请求后的后续处理。</p>
<p>我们那个被代理对象存在意义就是调用里面实现接口的方法，要是有时候因为种种原因我们不想直接调用里面的实现方法，我们可以通过上面说的方式创造他的代理类，然后因为实现同一接口，我们只需要调用这个创建出来的代理类的对象实现那个接口的方法，然后在这个代理类的实现方法里面可能会有各种判断啊等等等，然后在合适的时候调用我们之前传给他的那个被代理类的实例化对象对应的方法，可能在这之前或者在这之后还会调用自己的一些其他方法，而这些逻辑我们又不想直接写在我们的被代理类里面实现的那个方法里，会太乱</p>
<p><mark>但是要是我们需要动态的决定代理类和对应的动态代理是什么类，因为我们可能会有很多接口，所以会有很多对应的代理类和被代理类，难不成我们要像静态代理的方式一个一个都写出来？当然不，我们可以通过反射来实现</mark></p>
<blockquote>
<p>注意我们一般那些接口和实现类都会有，所以我们需要创建的是那个实现类的代理类</p>
</blockquote>
<h3 id="动态代理"><a class="markdownIt-Anchor" href="#动态代理">#</a> 动态代理:</h3>
<p>接口:</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220205233910946.png" alt="image-20220205233910946"></p>
<p>被代理类:</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220205234127406.png" alt="image-20220205234127406"></p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220206001448480.png" alt="image-20220206001448480"></p>
<p>解决问题 1 和问题 2, 我们需要两个类:</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220205235409194.png" alt="image-20220205235409194"></p>
<blockquote>
<p><span class="spoiler" title="..."><span class="spoiler" title="..."><span class="spoiler" title="..."><span class="spoiler" title="..."><span class="spoiler" title="..."><a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220205235546404.png">image-20220205235546404</a></span></span></span></span></span>!!!</p>
<p>这行代码应该在上面的类里面，也就是调用了 handler 变量存的对象的 bind 方法，并把那个要实现的被代理类的实例对象传了过去</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220206011535591.png" alt="image-20220206011535591"></p>
<p>测试到底什么样:</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220206011657733.png" alt="image-20220206011657733"></p>
<p>结果:</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220206011420226.png" alt="image-20220206011420226"></p>
<p><img src="C:%5CUsers%5Charry%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20220206011345146.png" alt="image-20220206011345146"></p>
<blockquote>
<blockquote>
<p>这里的逻辑:</p>
<ul>
<li>首先比如说我们有个实现类 A 这个实现类实现了接口 B, 接口 B 有方法 x 和方法 y, 所以 A 有方法 x 和 y 的实现</li>
<li>现在我们有个实现类 A 的实例化对象，然后想生成这个实现类 A 的实例化对象的代理类对象</li>
<li>我们可以把实现类 A 的实例化对象传进我们弄的代理工厂的 static 方法 getProxyInstance 里面</li>
<li>在这个方法里面先是实例化了我们创建的一个类 <code>MyInvocationHandler</code> , 这个类实现了 <code>InvocationHandler接口</code> 然后实现了这个接口的 <code>invoke</code>  方法</li>
<li>我们接着给那个 handler (看上面图) 调用 bind 方法把实现类 A 的实例化对象传了过去</li>
<li>接着在我们的我们弄的代理工厂的 static 方法 getProxyInstance 里面，我们调用了 java 内部的静态方法 <code>Proxy.newProxyInstance</code>  并把那个实现类 A 实例对象的加载器 和 实现类 A 实现的接口 B 和 我们上面 <code>MyInvocationHandler</code>  的实例化对象，并把这个整个方法的返回值返回出去，说明这个返回值就是我们想要的代理类对象</li>
<li>其实这个时候实现类 A 对应的代理类对象就创建好了，就是这个返回值 (上面我们用 &quot;proxyInstance&quot; 变量接收了，但类型还是 Human 接口的)</li>
<li>这里我们就已经创建出来那个实现类 A 对应的代理类对象了，我们所要做的操作只是把那个实现类传进我们做的静态方法即可然后接收返回值即可</li>
<li>接着我们调用接口 B 里面的任意方法，比如说方法 x, 这个就会调用那个 MyInvocationHandler 类的里面的 invoke 方法–&gt;__每当调用代理类 (对象) 的方法 (也就是我们接口 B)，这个调用就会打包传递给 invacation handler 的 invoke 方法__而这里我们创建的 <code>MyInvocationHandler</code>  实现了 InvocationHandler 接口，所以调用的时候会调用他实现的 invoke 方法 (<mark>这里我认为是传的第三个参数 (那个变量为 &quot;handler&quot; 的 MyInvocationHandler 实例化对象), 在 java 内部通过反射调用他的 invoke 方法</mark>)</li>
<li>而在那个 MyInvocationHandler 类里面首先有个 bind 方法接收到了传进来的那个实现类 A 的实例化对象
<ul>
<li>注意这里 MyInvocationHandler 类的实例化对象已经创建出来了 (“handler”), 所以哪个 bind 方法是已经把那个实现类 A 的实例化对象传给了 handler 对象的 obj 成员了，而且之后都是 in context of that “handler” instance</li>
</ul>
</li>
<li>然后在这个 handler ( <code>MyInvocationHandler</code>  类的实例化对象) 调用 invoke 方法里面参数 java 内部给传的三个参数分别是通过 <code>Proxy.newProxyInstance</code>  创造出来的对应实现类 A 的实例化对象的代理类对象，接口 B 被调用的方法 (这里说的就是那个方法 x) 和方法的参数 (if any)</li>
<li>然后在这个 invoke 方法里面你可以像静态代理一样做各种操作判断，然后最后<img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220206005817917.png" alt="image-20220206005817917"> 其实就是 invoke (跟我们当前所在的 invoke 不是一回事) 那个传进来的方法也就是方法 x, 然后用谁 invoke 呢？当然是那个对于 handler 来说有的成员 obj 存的就是通过 bind 获取到的那个实现类 A 的实例对象，然后紧跟参数.
<ul>
<li>这跟静态代理的概念一样，在代理类里面有个成员存的是被代理对象，也就是那个实现类 A 的实例对象 (不管怎么样传进来的), 然后里面做一对操作 (属于代理类里面做的各种判断等等等), 然后在你觉得合适的时候调用那真正被代理对象的实现的对应的方法，只不过这里是用到反射实现的</li>
</ul>
</li>
</ul>
<blockquote>
<p>所以从始至终我们只需要传进去一个我们想要对应代理类对象的一个被代理对象 (实现类，实现了任何接口)(<strong>这个可以是任何！<span class="spoiler" title="..."><span class="spoiler" title="..."> 只要是实现了某个接口的都行</span></span>！(动态代理的好处)</strong>), 然后我们就获得一个对应的代理类的实例对象，我们就可以拿接口类型的变量接收他</p>
<p>然后我们就可以拿那个变量来调用接口里面的任何的方法，都会通过那个代理类对象我们设置的逻辑或者等等等操作，然后照样执行被代理类的对应的实现方法</p>
</blockquote>
<p>这可比静态代理好多了，静态代理我们还需要每个被代理类创建一个对应的代理类.</p>
</blockquote>
</blockquote>
<p>现在有另外一个接口和实现这个接口的类:</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220206011948091.png" alt="image-20220206011948091"></p>
<p>直接通过我们创建的那两个类，把那个实现类对象一放进去就能获得对应的代理类对象了</p>
<blockquote>
<p>提醒一声，invoke 方法第一个参接收 Object 类型的</p>
<ul>
<li>如果实例方法 -&gt; 需要传进去你想用哪个对象来 invoke 这个方法，直接传那个对象作为第一参数就行</li>
<li>如果静态方法 -&gt; 一般是那个 <code>类.class</code>  作为第一参数，一般都这么做，指明是哪个类的静态方法，其实好像传 null 也行，因为你那个 Method 类型的方法就是从你通过反射从那个类的 Class 对象获取到的，也知道你是哪个类的静态方法</li>
</ul>
<p>都可以反正接收类型是 Object, 传什么都会自动向上转型的</p>
</blockquote>
<blockquote>
<p>动态代理和静态代理的区别：静态代理通常只代理一个类，动态代理是代理一个接口下的多个实现类。</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220206012250786.png" alt="image-20220206012250786"></p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220206012321336.png" alt="image-20220206012321336"></p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220206012459199.png" alt="image-20220206012459199"></p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220206012525766.png" alt="image-20220206012525766"></p>
<blockquote>
<p>这样就不需要在__每一个需要那个通用方法的地方去调用这个方法__-&gt; 要是有 100 个方法都会用到这个通用方法，那全部 100 个就都要加上调用这个通用方法？</p>
</blockquote>
<p>我们完全可以就是把这些通用方法放进代理类里面的 invoke 方法里面，然后每次我们有个实现类，想要调用里面的 x 方法，然后 x 方法需要用到通用方法，我们就可以动态地获取到这个实现类的代理类对象，然后再用这个代理类对象调用 x 方法，然后这个代理类就会执行那个通用方法，然后再执行实现类里面对应的实现方法里面属于他自己的独特方法</p>
<p>这时候我们又有个实现类里面方法 (或者是同一个实现类另外一个方法) 也需要这个通用代码，一样操作 -&gt; 获取他的代理类对象然后调用那个方法 -&gt; 通用代码执行 -&gt; 独有方法执行 -&gt; 通用代码执行 -&gt; 返回值 (如果有)</p>
<h2 id="1-底层原理"><a class="markdownIt-Anchor" href="#1-底层原理">#</a> 1. 底层原理</h2>
<ul>
<li><strong>面向切面编程</strong>，利用 AOP 可以对<mark>业务逻辑的各个部分进行隔离</mark>，从而使得<strong>业务逻辑各部分之间的耦合度降低</strong>，提高程序的可重用性，同时提高了开发的效率。通俗来说就是<strong>在不修改代码的情况下添加新的功能。</strong></li>
</ul>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220206120905208.png" alt="image-20220206120905208"></p>
<ul>
<li>
<p>底层通过<mark>动态代理</mark>来实现：</p>
<ul>
<li>第一种：<strong>有接口的情况</strong>，使用 JDK 动态代理：<strong>创建接口实现类的代理对象</strong>。</li>
<li>第二种：<strong>无接口的情况</strong>，使用 CGLIB 动态代理：<strong>创建当前类子类 (如果有接口的话我们想增强的就是那个实现类，要是没接口我们就是想增强这个当前类，然后我们动态代理产出一个他子类的代理对象 (他子类不需要被创建！！！)) 的代理对象</strong>。(<strong><mark>无接口的情况也可以让一个类 (的子类) 有着他的代理类</mark></strong>)</li>
</ul>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220206121538185.png" alt="image-20220206121538185"></p>
<p><strong>JDK 动态代理举例：</strong></p>
<ul>
<li>通过 java.lang.reflect.<strong>Proxy 类</strong> 的 <strong>newProxyInstance 方法</strong> 创建代理类。</li>
</ul>
<p>newProxyInstance 方法：</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/a0b3bb5dc1d12993ac3caf4b890b3820.png" alt=""></p>
<blockquote>
<p>参数一：类加载器</p>
<p>参数二：所增强方法所在的类，这个类实现的接口，支持多个接口</p>
<p>参数三：实现 InvocationHandle 接口，重写 invoke 方法来添加新的功能</p>
</blockquote>
<p>代码举例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserDao</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">multi</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserDaoImpl</span> <span class="token keyword">implements</span> <span class="token class-name">UserDao</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> a<span class="token operator">+</span>b<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">multi</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> a<span class="token operator">*</span>b<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

        <span class="token comment">//所需代理的类实现的接口，支持多个接口</span>
        <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> interfaces <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token class-name">UserDao</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
		
        <span class="token class-name">UserDao</span> userDao <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserDaoImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
		<span class="token comment">//调用newProxyInstance方法来创建代理类</span>
        <span class="token class-name">UserDao</span> userDaoProxy <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">UserDao</span><span class="token punctuation">)</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span><span class="token class-name">Main</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> interfaces<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">UserDaoProxy</span><span class="token punctuation">(</span>userDao<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
        <span class="token keyword">int</span> result <span class="token operator">=</span> userDaoProxy<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//创建内部类，实现InvocationHandler接口，重写invoke方法，添加新功能</span>
    <span class="token keyword">class</span> <span class="token class-name">UserDaoProxy</span> <span class="token keyword">implements</span> <span class="token class-name">InvocationHandler</span> <span class="token punctuation">&#123;</span>

        <span class="token class-name">Object</span> obj<span class="token punctuation">;</span>
		<span class="token comment">//通过有参构造函数将所需代理的类传过来</span>
        <span class="token keyword">public</span> <span class="token class-name">UserDaoProxy</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>obj <span class="token operator">=</span> obj<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> proxy<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span>

            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"进入"</span> <span class="token operator">+</span> method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"方法，这是新增的代码，参数有"</span> <span class="token operator">+</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
			<span class="token comment">//执行原有的代码</span>
            <span class="token class-name">Object</span> invoke <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"方法原先的内容执行完了"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token keyword">return</span> invoke<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>运行结果：</p>
<p><img src="https://gitee.com/oymn/img_upload/raw/master/img/20210801005210.png" alt=""></p>
<hr>
<h2 id="2-基于aspectj实现aop操作"><a class="markdownIt-Anchor" href="#2-基于aspectj实现aop操作">#</a> 2. 基于 AspectJ 实现 AOP 操作</h2>
<p><strong>（1）AOP 相关术语：</strong></p>
<ul>
<li><strong>连接点</strong>：类中__所有可以被增强__的方法，都被称为连接点。</li>
<li><strong>切入点 (PointCut)</strong>：类中__实际被增强__的方法，称为切入点。</li>
<li><strong>通知</strong>：增强的那一部分逻辑代码。通知有多种类型：
<ul>
<li>前置通知：增强部分代码在原代码前面。</li>
<li>后置通知：增强部分代码在原代码后面。</li>
<li>环绕通知：增强部分代码既有在原代码前面，也有在原代码后面。</li>
<li>异常通知：原代码发生异常后才会执行。</li>
<li>最终通知：类似与 finally 那一部分</li>
</ul>
</li>
<li><strong>切面</strong>：指把通知应用到切入点这一个动作。</li>
</ul>
<p><strong>（2）基于 AspectJ 实现 AOP 有两种方式：</strong></p>
<ul>
<li>基于 xml 配置文件</li>
<li>基于注解方法</li>
</ul>
<blockquote>
<p>在使用 spring 框架配置 AOP 的时候，不管是通过 XML 配置文件还是注解的方式都需要定义 pointcut&quot;切入点&quot;</p>
<p>例如定义切入点表达式  execution (* com.sample.service.impl…<em>.</em>(…))</p>
</blockquote>
<p><strong>（3）切入点表达式</strong></p>
<ul>
<li>语法：execution（[权限修饰符] [返回类型] [类全路径] [方法名称] [参数列表]）</li>
</ul>
<blockquote>
<p><mark>其中：返回类型模式、方法名模式、参数模式是必选项，其他的可以不写。</mark></p>
</blockquote>
<ul>
<li>
<p>举例 1：对 com.atguigu.dao.BookDao 类里面的 add 进行增强</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token function">execution</span><span class="token punctuation">(</span><span class="token operator">*</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>auguigu<span class="token punctuation">.</span>dao<span class="token punctuation">.</span></span>BookDao</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>举例 2：对 com.atguigu.dao.BookDao 类里面的所有的方法进行增强</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token function">execution</span><span class="token punctuation">(</span><span class="token operator">*</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>dao<span class="token punctuation">.</span></span>BookDao</span><span class="token punctuation">.</span>*<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p>举例 3：对 com.atguigu.dao 包里面所有类，类里面所有方法进行增强</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token function">execution</span><span class="token punctuation">(</span><span class="token operator">*</span> com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>dao<span class="token punctuation">.</span>*<span class="token punctuation">.</span>* <span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<h3 id="1基于注解方式"><a class="markdownIt-Anchor" href="#1基于注解方式">#</a> （1）基于注解方式</h3>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"User.add()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Aspect</span>   <span class="token comment">//使用Aspect注解</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserProxy</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//前置通知</span>
    <span class="token annotation punctuation">@Before</span><span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token string">"execution(* com.oymn.spring5.User.add(..))"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">before</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"UserProxy.before()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">//后置通知</span>
    <span class="token annotation punctuation">@AfterReturning</span><span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token string">"execution(* com.oymn.spring5.User.add(..))"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterReturning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"UserProxy.afterReturning()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">//最终通知</span>
    <span class="token annotation punctuation">@After</span><span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token string">"execution(* com.oymn.spring5.User.add(..))"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token class-name">After</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"UserProxy.After()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//异常通知</span>
    <span class="token annotation punctuation">@AfterThrowing</span><span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token string">"execution(* com.oymn.spring5.User.add(..))"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token class-name">AfterThrowing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"UserProxy.AfterThrowing()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//环绕通知</span>
    <span class="token annotation punctuation">@Around</span><span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token string">"execution(* com.oymn.spring5.User.add(..))"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token class-name">Around</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> proceedingJoinPoint<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span><span class="token punctuation">&#123;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"UserProxy.Around()   _1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//调用proceed方法执行原先部分的代码</span>
        proceedingJoinPoint<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">//这个比较特殊!!!!!!!</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"UserProxy.Around()   _2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>配置 xml 文件：</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token comment">&lt;!--开启组件扫描--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">context:</span>component-scan</span> <span class="token attr-name">base-package</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.oymn<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">context:</span>component-scan</span><span class="token punctuation">></span></span>
<span class="token comment">&lt;!--开启AspectJ生成代理对象--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>aspectj-autoproxy</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">aop:</span>aspectj-autoproxy</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>测试类：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token class-name">ClassPathXmlApplicationContext</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathXmlApplicationContext</span><span class="token punctuation">(</span><span class="token string">"bean1.xml"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">User</span> user <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>运行结果：</p>
<p><img src="https://gitee.com/oymn/img_upload/raw/master/img/20210801210024.png" alt=""></p>
<p>运行结果中没有出现异常通知，在 add 方法中添加 <code>int i = 1/0;</code></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"User.add()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<ul>
<li>
<p>上面就是我们有个被增强类 (没有实现任何接口) 里面的 add 方法想要通过代理方式增强</p>
</li>
<li>
<p>我们也有一个代理类 (我们自己创建好的)</p>
</li>
<li>
<p>然后我们 xml 里面开启注解扫描 (命名空间啥啥啥的，或者用配置类也可以)</p>
</li>
<li>
<p>接着我们把被增强类和增强类 (也就是代理类) 上面放注解 @Component 让 Spring IOC 容器帮忙管理这两个类的对象</p>
</li>
<li>
<p>我们把 <code>@Aspect</code>  注解放到我们创建的增强类 (也就是代理类) 上面</p>
</li>
<li>
<p>然后我们在 xml 里面配置开启 AspectJ 生成代理对象，这个就会扫描到我们增强类上面的 <code>@Aspect</code>  注解，就让 Spring 知道那是个代理类</p>
</li>
<li>
<p>然后<img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220206183119949.png" alt="image-20220206183119949">, 比如说:</p>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220206183302075.png" alt="image-20220206183302075"></p>
<ul>
<li>这里我们就是给我们代理类里面写的方法给了个 @Before 注解且传了个切入点表达式</li>
<li>这个切入点表达式那个类的那个方法 (可能是好多个类的好多个方法), 反正任何匹配的方法再执行前 (因为这里是 @Before 注解) 都会触发这个代理类里面的被 @Before 注解的方法，这个代理类的这个方法执行完了就会去执行原本你要执行的那个方法里面的东西</li>
<li>所以上方我们只需要直接 getBean 那个被增强类的实例化对象然后调用里面的 add 方法，Spring 会帮我们查看他管理的代理类里面有没有方法的切入面表达式跟我们 add 方法匹配，如果有就会按照那个注解的通知类型，在对应的时候调用那个被注解的代理类里面的那个方法</li>
<li>可能助理类里面多个方法的注解 (<strong>不同通知，比如说 @Before 一个，@After 一个等等等</strong>) 的切入表达式都跟我们 add 方法匹配，那么那些方法都会在他们的注解的通知类型对应的时机触发对应的被注解的方法</li>
</ul>
</blockquote>
<p>运行结果：从这里也可以看到，<strong>但出现异常时，After 最终通知有执行，而 AfterReturning (有结果才通知) 后置通知并没有执行</strong>。</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/20210801210304.png" alt=""></p>
<blockquote>
<p>@AfterThrowing 注解的方法只有在那个被增强类的方法抛出异常才会执行</p>
</blockquote>
<p>对于上面的例子，有很多通知的切入点都是相同的方法，因此，可以将<strong>该切入点进行抽取：通过 @Pointcut 注解</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Pointcut</span><span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token string">"execution(* com.oymn.spring5.User.add(..))"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">pointDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    
<span class="token punctuation">&#125;</span>

<span class="token comment">//前置通知</span>
<span class="token annotation punctuation">@Before</span><span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token string">"pointDemo()"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">before</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"UserProxy.before()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>就是写个方法上面给个 @Pointcut 注解并且赋值那个切入点表达式</p>
<p>然后之后注解要需要这个切面点表达式就直接拿那个方法调用当做是切入点表达式就 OK</p>
</blockquote>
<p><strong>设置增强类优先级：</strong></p>
<blockquote>
<p>当有多个增强类 (每个类里面有一个或多个方法有着注解，注解的切入点表达式跟) 对我们被增强类的同一方法进行增强 (匹配) 时，可以通过 ** <code>@Order（数字值）</code> ** 来设置增强类的优先级，<strong>数字越小优先级越高。</strong></p>
<p>注意那些增强方法都会执行，只是顺序问题</p>
</blockquote>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Aspect</span>
<span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PersonProxy</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>完全注解开发</strong> ：</p>
<p>可以通过配置类来彻底摆脱 xml 配置文件：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@ComponentScan</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token string">"com.oymn.spring5"</span><span class="token punctuation">)</span>
<span class="token comment">//@EnableAspectJAutoProxy注解相当于上面xml文件中配置的 &lt;aop:aspectj-autoproxy>&lt;/aop:aspectj-autoproxy></span>
<span class="token annotation punctuation">@EnableAspectJAutoProxy</span><span class="token punctuation">(</span>proxyTargetClass <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>  
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Config</span> <span class="token punctuation">&#123;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="2基于xml方式"><a class="markdownIt-Anchor" href="#2基于xml方式">#</a> （2）基于 xml 方式</h3>
<p>这种方式开发中不怎么用，了解即可。</p>
<p>创建 Book 和 BookProxy 类</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Book</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">buy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"buy()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BookProxy</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">before</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"before()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>配置 xml 文件：</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token comment">&lt;!--创建对象--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>book<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.oymn.spring5.Book<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>bookProxy<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.oymn.spring5.BookProxy<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>config</span><span class="token punctuation">></span></span>
    <span class="token comment">&lt;!--切入点--></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>pointcut</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>p<span class="token punctuation">"</span></span> <span class="token attr-name">expression</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>execution(* com.oymn.spring5.Book.buy(..))<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
    <span class="token comment">&lt;!--配置切面--></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>aspect</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>bookProxy<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>before</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>before<span class="token punctuation">"</span></span> <span class="token attr-name">pointcut-ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>p<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>  <span class="token comment">&lt;!--将bookProxy中的before方法配置为切入点的前置通知--></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">aop:</span>aspect</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">aop:</span>config</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<h1 id="从别处拿来的关于aop笔记"><a class="markdownIt-Anchor" href="#从别处拿来的关于aop笔记">#</a> 从别处拿来的关于 AOP 笔记</h1>
<h2 id="面向切面的基本原理"><a class="markdownIt-Anchor" href="#面向切面的基本原理">#</a> 面向切面的基本原理</h2>
<p><strong>什么是面向切面编程</strong></p>
<blockquote>
<p>横切关注点：影响应用多处的功能（安全、事务、日志）</p>
</blockquote>
<p><strong>切面：</strong></p>
<blockquote>
<p>横切关注点被模块化为特殊的类，这些类称为切面</p>
</blockquote>
<p><strong>优点：</strong></p>
<blockquote>
<p>每个关注点现在都集中于一处，而不是分散到多处代码中<br>
服务模块更简洁，服务模块只需关注核心代码。</p>
</blockquote>
<p><strong>AOP 术语</strong></p>
<ul>
<li><strong>通知：</strong>
<ul>
<li>定义：切面也需要完成工作。在 AOP 术语中，切面的工作被称为通知。</li>
<li>工作内容：通知定义了切面是什么以及何时使用。除了描述切面要完成的工作，通知还解决何时执行这个工作。</li>
<li>Spring 切面可应用的 5 种通知类型：</li>
</ul>
</li>
</ul>
<blockquote>
<ol>
<li>Before—— 在方法调用之前调用通知</li>
<li>After—— 在方法完成之后调用通知，无论方法执行成功与否</li>
<li>After-returning—— 在方法执行成功之后调用通知</li>
<li>After-throwing—— 在方法抛出异常后进行通知</li>
<li>Around—— 通知包裹了被通知的方法，在被通知的方法调用之前和调用之后执行自定义的行为</li>
</ol>
</blockquote>
<ul>
<li><strong>连接点：</strong>
<ul>
<li>定义：连接点是一个应用执行过程中能够插入一个切面的点。</li>
<li>连接点可以是调用方法时、抛出异常时、甚至修改字段时、</li>
<li>切面代码可以利用这些点插入到应用的正规流程中</li>
<li>程序执行过程中能够应用通知的所有点。</li>
</ul>
</li>
<li><strong>切点：</strong>
<ul>
<li>定义：如果通知定义了 “什么” 和 “何时”。那么切点就定义了 “何处”。切点会匹配通知所要织入的一个或者多个连接点。</li>
<li>通常使用明确的类或者方法来指定这些切点。</li>
<li>作用：定义通知被应用的位置（在哪些连接点）</li>
</ul>
</li>
<li><strong>切面：</strong>
<ul>
<li>定义：切面是通知和切点的集合，通知和切点共同定义了切面的全部功能 —— 它是什么，在何时何处完成其功能。</li>
</ul>
</li>
<li><strong>引入：</strong>
<ul>
<li>引入允许我们向现有的类中添加方法或属性</li>
</ul>
</li>
<li><strong>织入：</strong>
<ul>
<li>织入是将切面应用到目标对象来创建的代理对象过程。</li>
<li>切面在指定的连接点被织入到目标对象中，在目标对象的生命周期中有多个点可以织入</li>
</ul>
</li>
</ul>
<blockquote>
<ol>
<li>编译期 —— 切面在目标类编译时期被织入，这种方式需要特殊编译器。AspectJ 的织入编译器就是以这种方式织入切面。</li>
<li>类加载期 —— 切面在类加载到</li>
<li>JVM ，这种方式需要特殊的类加载器，他可以在目标类被引入应用之前增强该目标类的字节码。AspectJ5 的 LTW 就支持这种织入方式</li>
<li>运行期 —— 切面在应用运行期间的某个时刻被织入。一般情况下，在织入切面时候，AOP 容器会为目标对象动态的创建代理对象。Spring AOP 就是以这种方式织入切面。</li>
</ol>
</blockquote>
<h2 id="spring-对-aop-的支持"><a class="markdownIt-Anchor" href="#spring-对-aop-的支持">#</a> Spring 对 <a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=AOP&amp;spm=1001.2101.3001.7020">AOP</a> 的支持</h2>
<ul>
<li>并不是所有的 AOP 框架都是一样的，他们在连接点模型上可能有强弱之分。
<ul>
<li>有些允许对字段修饰符级别应用通知</li>
<li>有些支持方法调用连接点</li>
</ul>
</li>
<li>Spring 提供的 4 种各具特色的 AOP 支持</li>
</ul>
<blockquote>
<ol>
<li>基于代理的经典 AOP；</li>
<li>@AspectJ 注解驱动的切面；</li>
<li>纯 POJO 切面；</li>
<li>注入式 AspectJ 切面； Spring</li>
</ol>
</blockquote>
<ul>
<li>
<p>在运行期间通知对象</p>
<ul>
<li>
<p>通过在代理类中织入包裹切面，Spring 在运行期间将切面织入到 Spring 管理的 Bean 中。<br>
代理类封装了目标类，并拦截被通知的方法调用，再将调用转发给真正的目标 Bean<br>
<img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/20160505123413155" alt=""></p>
<p>当拦截到方法调用时，在调用目标 Bean 方法之前，代理会执行切面逻辑。<br>
当真正应用需要被代理的 Bean 时，Spring 才创建代理对象。如果使用 ApplicationContext，在 ApplicationContext 从 BeanFactory 中加载所有 Bean 时，Spring 创建代理对象，因为 Spring 在运行时候创建代理对象，所以我们不需要特殊的编译器来织入 Spring AOP 的切面。</p>
</li>
</ul>
</li>
<li>
<p>Spring 支持方法创建连接点</p>
<ul>
<li>因为 Spring 基于动态代理，所以 Spring 只支持方法连接点。</li>
<li>Spring 缺失对字段连接点的支持，无法让我们更加细粒度的通知，例如拦截对象字段的修改</li>
<li>Spring 缺失对构造器连接点支持，我发在 Bean 创建时候进行通知。</li>
</ul>
</li>
</ul>
<h2 id="使用切点选择连接点"><a class="markdownIt-Anchor" href="#使用切点选择连接点">#</a> 使用切点选择连接点</h2>
<ul>
<li>切点用于准确定位，确定在什么地方应用切面通知。</li>
<li>Spring 定义切点
<ul>
<li>在 Spring AOP 中，需要使用 AspectJ 的切点表达式来定义切点。</li>
</ul>
</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">AspectJ 指示器</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">arg ()</td>
<td style="text-align:center">限制连接点的指定参数为指定类型的执行方法</td>
</tr>
<tr>
<td style="text-align:center">@args ()</td>
<td style="text-align:center">限制连接点匹配参数由指定注解标注的执行方法</td>
</tr>
<tr>
<td style="text-align:center">execution ()</td>
<td style="text-align:center">用于匹配连接点的执行方法</td>
</tr>
<tr>
<td style="text-align:center">this ()</td>
<td style="text-align:center">限制连接点匹配 AOP 代理的 Bean 引用为指定类型的类</td>
</tr>
<tr>
<td style="text-align:center">target ()</td>
<td style="text-align:center">限制连接点匹配特定的执行对象，这些对象对应的类要具备指定类型注解</td>
</tr>
<tr>
<td style="text-align:center">within()</td>
<td style="text-align:center">限制连接点匹配指定类型</td>
</tr>
<tr>
<td style="text-align:center">@within()</td>
<td style="text-align:center">限制连接点匹配指定注释所标注的类型（当使用 Spring AOP 时，方法定义在由指定的注解所标注的类里）</td>
</tr>
<tr>
<td style="text-align:center">@annotation</td>
<td style="text-align:center">限制匹配带有指定注释的连接点</td>
</tr>
</tbody>
</table>
<p>1. 创建自己的切点<br>
<img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/20160505125002742" alt=""></p>
<p>- execution () 指示器选择 Instrument 的 play () 方法。<br>
方法表达式是以 * 号开头，标识了我们不关心的方法返回值的类型。<br>
* 后我们指定了权限定类名和方法名。<br>
对于方法的参数列表，使用（…）标识切点选择任意的 play ( ) 方法，无论入参是什么。<br>
- 假设我们需要匹配切点仅匹配 com.Springinaction.springidol 包。可以使用 within（）<br>
<img src="https://img-blog.csdn.net/20160505125257446" alt=""></p>
<p>注意 &amp;&amp; 是将 execution () 和 within () 连接起来，形成的 and 关系。同理也可以使用 || 或关系、！非关系<br>
 - 创建 Spring 的 bean ( ) 指示器<br>
 Spring 2.5 引入一个新的 bean ( ) 指示器，该指示器允许我们在切点表达式中使用 Bean ID 来标识 Bean<br>
bean ( ) 使用 Bean ID 或 Bean 名称作为参数来限制切点只匹配特定 Bean。<br>
如下，我们希望执行 Instrument 的 play ( ) 方法时候应用通知，但限定 Bean 的 ID 为 eddie<br>
<img src="https://img-blog.csdn.net/20160505125416233" alt=""></p>
<p>还可以使用非操作作为除了指定 ID 的 Bean 以外的其他 Bean 应用通知<br>
<img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/20160505125431108" alt=""></p>
<p>在此场景下，切面会通知被编织到所有 ID 不为 eddie 的 Bean 中</p>
<h2 id="在-xml-中声明切面"><a class="markdownIt-Anchor" href="#在-xml-中声明切面">#</a> 在 XML 中声明切面</h2>
<p>Spring 的 AOP 配置元素简化了基于 POJO 切面声明</p>
<table>
<thead>
<tr>
<th style="text-align:center">AOP 配置元素</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">aop : advisor</td>
<td style="text-align:center">定义 AOP 通知器</td>
</tr>
<tr>
<td style="text-align:center">aop : after</td>
<td style="text-align:center">定义 AOP 后置通知（不管被通知方法是否执行成功）</td>
</tr>
<tr>
<td style="text-align:center">aop : after-returing</td>
<td style="text-align:center">定义 AOP after-returing 通知</td>
</tr>
<tr>
<td style="text-align:center">aop : after-throwing</td>
<td style="text-align:center">定义 AOP after-throwing 通知</td>
</tr>
<tr>
<td style="text-align:center">aop : around</td>
<td style="text-align:center">定义 AOP 环绕通知</td>
</tr>
<tr>
<td style="text-align:center">aop : aspect</td>
<td style="text-align:center">定义切面</td>
</tr>
<tr>
<td style="text-align:center">aop : aspectj-autoproxy</td>
<td style="text-align:center">启动 @AspectJ 注解驱动的切面</td>
</tr>
<tr>
<td style="text-align:center">aop : before</td>
<td style="text-align:center">定义 AOP 前置通知</td>
</tr>
<tr>
<td style="text-align:center">aop : config</td>
<td style="text-align:center">顶层的 AOP 配置元素，大多数 aop : * 元素必须包含在 元素内</td>
</tr>
<tr>
<td style="text-align:center">aop : declare-parents</td>
<td style="text-align:center">为被通知的对象引入额外接口，并透明的实现</td>
</tr>
<tr>
<td style="text-align:center">aop : pointcut</td>
<td style="text-align:center">定义切点</td>
</tr>
</tbody>
</table>
<hr>
<h1 id="四-jdbctemplate"><a class="markdownIt-Anchor" href="#四-jdbctemplate">#</a> 四、JdbcTemplate</h1>
<ul>
<li>Spring 对 JDBC 进行封装，使用 JdbcTemplate 方便对数据库的操作。</li>
</ul>
<p>（1）增删改操作：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">int</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">String</span> sql<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>（2）查询：返回某个值</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">T</span> <span class="token function">queryForObject</span><span class="token punctuation">(</span><span class="token class-name">String</span> sql<span class="token punctuation">,</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> requiredType<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>（3）查询：返回某个对象</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">T</span> <span class="token function">queryForObject</span><span class="token punctuation">(</span><span class="token class-name">String</span> sql<span class="token punctuation">,</span><span class="token class-name">RowMapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> rowMapper<span class="token punctuation">,</span><span class="token class-name">Object</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>（4）查询：返回集合</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">String</span> sql<span class="token punctuation">,</span><span class="token class-name">RowMapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> rowMapper<span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>（5）批量增删改：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">batchUpdate</span><span class="token punctuation">(</span><span class="token class-name">String</span> sql<span class="token punctuation">,</span><span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> batchArgs<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>举例：</p>
<ol>
<li>
<p>引入相关 jar 包</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/20210801231107.png" alt=""></p>
</li>
<li>
<p>配置数据库连接池；配置 JdbcTemplate 对象</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">context:</span>component-scan</span> <span class="token attr-name">base-package</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.oymn<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">context:</span>component-scan</span><span class="token punctuation">></span></span>

<span class="token comment">&lt;!--配置数据库连接池 --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dataSource<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.alibaba.druid.pool.DruidDataSource<span class="token punctuation">"</span></span> <span class="token attr-name">destroy-method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>close<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>url<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>jdbc:mysql://localhost:3306/book<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>root<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>000000<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>driverClassName<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.mysql.jdbc.Driver<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span>

<span class="token comment">&lt;!--创建JdbcTemplate对象--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>jdbcTemplate<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.springframework.jdbc.core.JdbcTemplate<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token comment">&lt;!--注入数据库连接池--></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dataSource<span class="token punctuation">"</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dataSource<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>创建 Service 类和 Dao 类，在 Dao 类中注入 JdbcTemplate 对象</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">BookDao</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Book</span> book<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//添加图书</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">Book</span> book<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//修改图书</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//删除图书</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">queryCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//查询数量</span>

    <span class="token keyword">public</span> <span class="token class-name">Book</span> <span class="token function">queryBookById</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//查询某本书</span>

    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Book</span><span class="token punctuation">></span></span> <span class="token function">queryBooks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//查询所有书</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">batchAddBook</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> books<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//批量添加图书</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">batchUpdateBook</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> books<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//批量修改图书</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">batchDeleteBook</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//批量删除图书</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Repository</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BookDaoImpl</span> <span class="token keyword">implements</span> <span class="token class-name">BookDao</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">JdbcTemplate</span> jdbcTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Book</span> book<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">"insert into t_book set name=?,price=?"</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args <span class="token operator">=</span> <span class="token punctuation">&#123;</span>book<span class="token punctuation">.</span><span class="token function">getBookName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>book<span class="token punctuation">.</span><span class="token function">getBookPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> update <span class="token operator">=</span> jdbcTemplate<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>update<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">Book</span> book<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">"update t_book set name=?,price=? where id=?"</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args <span class="token operator">=</span> <span class="token punctuation">&#123;</span>book<span class="token punctuation">.</span><span class="token function">getBookName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>book<span class="token punctuation">.</span><span class="token function">getBookPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>book<span class="token punctuation">.</span><span class="token function">getBookId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> update <span class="token operator">=</span> jdbcTemplate<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>update<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">"delete from t_book where id=?"</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> update <span class="token operator">=</span> jdbcTemplate<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>update<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">queryCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">"select count(*) from t_book"</span><span class="token punctuation">;</span>
        <span class="token class-name">Integer</span> count <span class="token operator">=</span> jdbcTemplate<span class="token punctuation">.</span><span class="token function">queryForObject</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> count<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Book</span> <span class="token function">queryBookById</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">"select id bookId,name bookName,price bookPrice from t_book where id=?"</span><span class="token punctuation">;</span>
        <span class="token class-name">Book</span> book <span class="token operator">=</span> jdbcTemplate<span class="token punctuation">.</span><span class="token function">queryForObject</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">BeanPropertyRowMapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Book</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token class-name">Book</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> book<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Book</span><span class="token punctuation">></span></span> <span class="token function">queryBooks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">"select id bookId,name bookName,price bookPrice from t_book"</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Book</span><span class="token punctuation">></span></span> bookList <span class="token operator">=</span> jdbcTemplate<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">BeanPropertyRowMapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Book</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token class-name">Book</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> bookList<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">batchAddBook</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> books<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">"insert into t_book set id=?,name=?,price=?"</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ints <span class="token operator">=</span> jdbcTemplate<span class="token punctuation">.</span><span class="token function">batchUpdate</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> books<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>ints<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">batchUpdateBook</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> books<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">"update t_book set name=?,price=? where id=?"</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ints <span class="token operator">=</span> jdbcTemplate<span class="token punctuation">.</span><span class="token function">batchUpdate</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> books<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>ints<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">batchDeleteBook</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">"delete from t_book where id=?"</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ints <span class="token operator">=</span> jdbcTemplate<span class="token punctuation">.</span><span class="token function">batchUpdate</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>ints<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BookService</span> <span class="token punctuation">&#123;</span>
    
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">BookDao</span> bookDao<span class="token punctuation">;</span>
    <span class="token comment">//添加图书</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Book</span> book<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        bookDao<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>book<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//修改图书</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">Book</span> book<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        bookDao<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>book<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//删除图书</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        bookDao<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//查询数量</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">queryCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> bookDao<span class="token punctuation">.</span><span class="token function">queryCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//查询图书</span>
    <span class="token keyword">public</span> <span class="token class-name">Book</span> <span class="token function">queryBookById</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> bookDao<span class="token punctuation">.</span><span class="token function">queryBookById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//查询所有图书</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Book</span><span class="token punctuation">></span></span> <span class="token function">queryBooks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> bookDao<span class="token punctuation">.</span><span class="token function">queryBooks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//批量添加图书</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">batchAddBook</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> books<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        bookDao<span class="token punctuation">.</span><span class="token function">batchAddBook</span><span class="token punctuation">(</span>books<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//批量修改图书</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">batchUpdateBook</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> books<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        bookDao<span class="token punctuation">.</span><span class="token function">batchUpdateBook</span><span class="token punctuation">(</span>books<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//批量删除图书</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">batchDeleteBook</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> args<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        bookDao<span class="token punctuation">.</span><span class="token function">batchDeleteBook</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ol>
<hr>
<h1 id="五-事务管理"><a class="markdownIt-Anchor" href="#五-事务管理">#</a> 五、事务管理</h1>
<ul>
<li>
<p>事务是数据库操作最基本单位，要么都成功，要么都失败。</p>
</li>
<li>
<p>典型场景：转账</p>
</li>
<li>
<p><strong>事务四个特性 ACID：原子性，一致性，隔离性，持久性。</strong></p>
</li>
<li>
<p>Spring 事务管理有两种方式：编程式事务管理 和 声明式事务管理，<strong>一般使用声明式事务管理，底层使用 AOP 原理。</strong></p>
</li>
<li>
<p>声明式事务管理有两种方式：基于 xml 配置方式 和 基于注解方式，<strong>一般使用注解方式。</strong></p>
</li>
<li>
<p>Spring 事务管理提供了一个接口，叫做<strong>事务管理器</strong>，<mark>这个接口针对不同的框架提供不同的实现类</mark>。</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/20210802191449.png" alt=""></p>
<p>对于使用 JdbcTemplate 进行数据库交互，则使用 DataSourceTransactionManager 实现类，如果整合 Hibernate 框架则使用 HibernateTransactionManager 实现类，具体情况具体使用。</p>
</li>
</ul>
<h3 id="1注解实现声明式事务管理"><a class="markdownIt-Anchor" href="#1注解实现声明式事务管理">#</a> （1）注解实现声明式事务管理：</h3>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token comment">&lt;!-- 数据库连接池 --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dataSource<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.alibaba.druid.pool.DruidDataSource<span class="token punctuation">"</span></span>
      <span class="token attr-name">destroy-method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>close<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>url<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>jdbc:mysql://localhost:3306/book<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>root<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>000000<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>driverClassName<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.mysql.jdbc.Driver<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span>

<span class="token comment">&lt;!--创建JdbcTemplate对象--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>jdbcTemplate<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.springframework.jdbc.core.JdbcTemplate<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token comment">&lt;!--注入数据库连接池--></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dataSource<span class="token punctuation">"</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dataSource<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span>

<span class="token comment">&lt;!--创建事务管理器--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>transactionManager<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.springframework.jdbc.datasource.DataSourceTransactionManager<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dataSource<span class="token punctuation">"</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dataSource<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span> // 需要上面的数据库连接池对象的注入
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span>

<span class="token comment">&lt;!--开启事务注解--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">tx:</span>annotation-driven</span> <span class="token attr-name">transaction-manager</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>transactionManager<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">tx:</span>annotation-driven</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在 service 类上面或者 service 类的方法上面添加事务注解 @Transactional</p>
<ul>
<li>如果把 @Transactional 添加在类上面，这个类里面所有方法都添加事务。</li>
<li>如果只是添加在方法上面，则只为这个方法添加事务。</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Transactional</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">&#123;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>然后就行了，很方便！！！</p>
<p>这个样子比如 userService 层有方法是调用 dao 层两个方法第二个 dao 层方法抛出异常，那么就会帮我们回滚</p>
<p>我们只需要上面 (xml) 配置好然后用给个注解完事！！！</p>
<p><mark>一般事务管理都是放到 service 层的</mark></p>
</blockquote>
<p><strong>声明式事务管理的参数配置：</strong></p>
<ol>
<li>
<p><strong>propagation</strong>：事务传播行为，总共有 7 种</p>
<blockquote>
<p>就比如说一个事务 (被 @Transaction 注解标注的方法) 里面还调用了另外一个方法，这另外一个方法可能也是事务 (被 @Transaction 注解标注的方法) 可能不是，反正就是不同事务之间的交集该怎么处理把应该</p>
<p><strong>具体讲解看下方！</strong></p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/image-20220206235430148.png" alt="image-20220206235430148"></p>
</li>
<li>
<p><strong>isolation</strong>：事务隔离级别</p>
<p>有三个读问题：脏读，不可重复读，虚读（幻读）。</p>
<p>设置隔离级别，解决读问题：</p>
<table>
<thead>
<tr>
<th style="text-align:right"></th>
<th style="text-align:center">脏读</th>
<th style="text-align:center">不可重复读</th>
<th style="text-align:center">虚读</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right">EAD UNCOMMITED（读未提交）</td>
<td style="text-align:center">有</td>
<td style="text-align:center">有</td>
<td style="text-align:center">有</td>
</tr>
<tr>
<td style="text-align:right">READ COMMITED（读已提交）</td>
<td style="text-align:center">无</td>
<td style="text-align:center">有</td>
<td style="text-align:center">有</td>
</tr>
<tr>
<td style="text-align:right">EPEATABLE READ（可重复读）</td>
<td style="text-align:center">无</td>
<td style="text-align:center">无</td>
<td style="text-align:center">有</td>
</tr>
<tr>
<td style="text-align:right">SERIALIZABLE（串行化）</td>
<td style="text-align:center">无</td>
<td style="text-align:center">无</td>
<td style="text-align:center">无</td>
</tr>
</tbody>
</table>
</li>
<li>
<p><strong>timeout</strong>：超时时间</p>
</li>
</ol>
<ul>
<li>事务需要在一定时间内进行提交，超过时间后回滚。</li>
<li>默认值是 - 1，设置时间以秒为单位。</li>
</ul>
<ol start="4">
<li><strong>readOnly</strong>：是否只读</li>
</ol>
<ul>
<li>默认值为 false，表示可以查询，也可以增删改。</li>
<li>设置为 true，只能查询。</li>
</ul>
<ol start="5">
<li><strong>rollbackFor</strong>：回滚，设置出现哪些异常进行事务回滚。</li>
<li><strong>noRollbackFor</strong>：不回滚，设置出现哪些异常不进行事务回滚。</li>
</ol>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>propagation <span class="token operator">=</span> <span class="token class-name">Propagation</span><span class="token punctuation">.</span>REQUIRED<span class="token punctuation">,</span>isolation <span class="token operator">=</span> <span class="token class-name">Isolation</span><span class="token punctuation">.</span>READ_COMMITTED<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccountService</span> <span class="token punctuation">&#123;</span>
   
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>完全注解实现声明式事务管理：</strong></p>
<p>配置类：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>  <span class="token comment">//配置类</span>
<span class="token annotation punctuation">@ComponentScan</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token string">"com.oymn.spring5"</span><span class="token punctuation">)</span>  <span class="token comment">//开启组件扫描</span>
<span class="token annotation punctuation">@EnableTransactionManagement</span>  <span class="token comment">//开启事务</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Config</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">//创建数据库连接池</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">DruidDataSource</span> <span class="token function">getDruidDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">DruidDataSource</span> druidDataSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DruidDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        druidDataSource<span class="token punctuation">.</span><span class="token function">setDriverClassName</span><span class="token punctuation">(</span><span class="token string">"com.mysql.jdbc.Driver"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        druidDataSource<span class="token punctuation">.</span><span class="token function">setUrl</span><span class="token punctuation">(</span><span class="token string">"jdbc:mysql://localhost:3306/book"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        druidDataSource<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        druidDataSource<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">"000000"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> druidDataSource<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//创建JdbcTemplate对象</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">JdbcTemplate</span> <span class="token function">getJdbcTemplate</span><span class="token punctuation">(</span><span class="token class-name">DataSource</span> dataSource<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">JdbcTemplate</span> jdbcTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JdbcTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jdbcTemplate<span class="token punctuation">.</span><span class="token function">setDataSource</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> jdbcTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//创建事务管理器</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">DataSourceTransactionManager</span> <span class="token function">getDataSourceTransactionManager</span><span class="token punctuation">(</span><span class="token class-name">DataSource</span> dataSource<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">DataSourceTransactionManager</span> transactionManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataSourceTransactionManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        transactionManager<span class="token punctuation">.</span><span class="token function">setDataSource</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> transactionManager<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccountService</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">AccountDao</span> accountDao<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">accountMoney</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        accountDao<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//int i=1/0;   //用来模拟转账失败</span>
        accountDao<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="2xml实现声明式事务管理"><a class="markdownIt-Anchor" href="#2xml实现声明式事务管理">#</a> （2）xml 实现声明式事务管理：</h3>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml">`<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">context:</span>component-scan</span> <span class="token attr-name">base-package</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.oymn<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">context:</span>component-scan</span><span class="token punctuation">></span></span>

<span class="token comment">&lt;!-- 数据库连接池 --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dataSource<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.alibaba.druid.pool.DruidDataSource<span class="token punctuation">"</span></span>
      <span class="token attr-name">destroy-method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>close<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>url<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>jdbc:mysql://localhost:3306/book<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>root<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>000000<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>driverClassName<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.mysql.jdbc.Driver<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span>

<span class="token comment">&lt;!--创建JdbcTemplate对象--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>jdbcTemplate<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.springframework.jdbc.core.JdbcTemplate<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token comment">&lt;!--注入数据库连接池--></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dataSource<span class="token punctuation">"</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dataSource<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span>

<span class="token comment">&lt;!--创建事务管理器--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>transactionManager<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.springframework.jdbc.datasource.DataSourceTransactionManager<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dataSource<span class="token punctuation">"</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dataSource<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span>

<span class="token comment">&lt;!--配置事务通知--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">tx:</span>advice</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>txadvice<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token comment">&lt;!--配置事务参数--></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">tx:</span>attributes</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">tx:</span>method</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>accountMoney<span class="token punctuation">"</span></span> <span class="token attr-name">propagation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>REQUIRED<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">tx:</span>attributes</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">tx:</span>advice</span><span class="token punctuation">></span></span>

<span class="token comment">&lt;!--配置切入点和切面--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>config</span><span class="token punctuation">></span></span>
    <span class="token comment">&lt;!--配置切入点--></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>pointcut</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>pt<span class="token punctuation">"</span></span> <span class="token attr-name">expression</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>execution(* com.oymn.spring5.Service.*.*(..))<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
    <span class="token comment">&lt;!--配置切面--></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>advisor</span> <span class="token attr-name">advice-ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>txadvice<span class="token punctuation">"</span></span> <span class="token attr-name">pointcut-ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>pt<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">aop:</span>config</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<h1 id="事务传播行为说明白"><a class="markdownIt-Anchor" href="#事务传播行为说明白">#</a> 事务传播行为说明白</h1>
<h2 id="1-什么是事务传播行为"><a class="markdownIt-Anchor" href="#1-什么是事务传播行为">#</a> 1. 什么是事务传播行为？</h2>
<p>事务传播行为用来描述由某一个事务传播行为修饰的方法被嵌套进另一个方法的时事务如何传播。</p>
<p>用伪代码说明：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">methodA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
   <span class="token function">methodB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">//doSomething</span>
<span class="token punctuation">&#125;</span>

<span class="token annotation punctuation">@Transaction</span><span class="token punctuation">(</span><span class="token class-name">Propagation</span><span class="token operator">=</span>XXX<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">methodB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
   <span class="token comment">//doSomething</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>代码中 <code>methodA()</code>  方法嵌套调用了 <code>methodB()</code>  方法，<strong> <code>methodB()</code>  的事务传播行为由 <code>@Transaction(Propagation=XXX)</code>  设置决定</strong>。这里需要注意的是 <code>methodA()</code>  并没有开启事务，某一个事务传播行为修饰的方法并不是必须要在开启事务的外围方法中调用。</p>
<h2 id="2-spring中七种事务传播行为"><a class="markdownIt-Anchor" href="#2-spring中七种事务传播行为">#</a> 2. Spring 中七种事务传播行为</h2>
<table>
<thead>
<tr>
<th>事务传播行为类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>PROPAGATION_REQUIRED</td>
<td>如果当前没有事务，就新建一个事务，如果已经存在一个事务中，加入到这个事务中。这是最常见的选择。</td>
</tr>
<tr>
<td>PROPAGATION_SUPPORTS</td>
<td>支持当前事务，如果当前没有事务，就以非事务方式执行。</td>
</tr>
<tr>
<td>PROPAGATION_MANDATORY</td>
<td>使用当前的事务，如果当前没有事务，就抛出异常。</td>
</tr>
<tr>
<td>PROPAGATION_REQUIRES_NEW</td>
<td>新建事务，如果当前存在事务，把当前事务挂起。</td>
</tr>
<tr>
<td>PROPAGATION_NOT_SUPPORTED</td>
<td>以非事务方式执行操作，如果当前存在事务，就把当前事务挂起。</td>
</tr>
<tr>
<td>PROPAGATION_NEVER</td>
<td>以非事务方式执行，如果当前存在事务，则抛出异常。</td>
</tr>
<tr>
<td>PROPAGATION_NESTED</td>
<td>如果当前存在事务，则在嵌套事务内执行。如果当前没有事务，则执行与 PROPAGATION_REQUIRED 类似的操作。</td>
</tr>
</tbody>
</table>
<p>定义非常简单，也很好理解，下面我们就进入代码测试部分，验证我们的理解是否正确。</p>
<h1 id="代码验证"><a class="markdownIt-Anchor" href="#代码验证">#</a> 代码验证</h1>
<p>文中代码以传统三层结构中两层呈现，即 Service 和 Dao 层，由 Spring 负责依赖注入和注解式事务管理，DAO 层由 Mybatis 实现，你也可以使用任何喜欢的方式，例如，Hibernate,JPA,JDBCTemplate 等。数据库使用的是 MySQL 数据库，你也可以使用任何支持事务的数据库，并不会影响验证结果。</p>
<p>首先我们在数据库中创建两张表：</p>
<p><strong>user1</strong></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>user1<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">INTEGER</span> <span class="token keyword">UNSIGNED</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>user2</strong></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>user2<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">INTEGER</span> <span class="token keyword">UNSIGNED</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后编写相应的 Bean 和 DAO 层代码：</p>
<p><strong>User1</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User1</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
   <span class="token comment">//get和set方法省略...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>User2</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User2</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
   <span class="token comment">//get和set方法省略...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>User1Mapper</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">User1Mapper</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> <span class="token function">insert</span><span class="token punctuation">(</span><span class="token class-name">User1</span> <span class="token keyword">record</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">User1</span> <span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//其他方法省略...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>User2Mapper</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">User2Mapper</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> <span class="token function">insert</span><span class="token punctuation">(</span><span class="token class-name">User2</span> <span class="token keyword">record</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">User2</span> <span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//其他方法省略...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最后也是具体验证的代码由 service 层实现，下面我们分情况列举。</p>
<h2 id="1propagation_required"><a class="markdownIt-Anchor" href="#1propagation_required">#</a> 1.PROPAGATION_REQUIRED</h2>
<p>我们为 User1Service 和 User2Service 相应方法加上 <code>Propagation.REQUIRED</code>  属性。</p>
<p><strong>User1Service 方法：</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User1ServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">User1Service</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//省略其他...</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>propagation <span class="token operator">=</span> <span class="token class-name">Propagation</span><span class="token punctuation">.</span>REQUIRED<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addRequired</span><span class="token punctuation">(</span><span class="token class-name">User1</span> user<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        user1Mapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>User2Service 方法：</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User2ServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">User2Service</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//省略其他...</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>propagation <span class="token operator">=</span> <span class="token class-name">Propagation</span><span class="token punctuation">.</span>REQUIRED<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addRequired</span><span class="token punctuation">(</span><span class="token class-name">User2</span> user<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        user2Mapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>propagation <span class="token operator">=</span> <span class="token class-name">Propagation</span><span class="token punctuation">.</span>REQUIRED<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addRequiredException</span><span class="token punctuation">(</span><span class="token class-name">User2</span> user<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        user2Mapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="11-场景一"><a class="markdownIt-Anchor" href="#11-场景一">#</a> 1.1 场景一</h3>
<p>此场景外围方法没有开启事务。</p>
<p><strong>验证方法 1：</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">notransaction_exception_required_required</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token class-name">User1</span> user1<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">User1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user1<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"张三"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user1Service<span class="token punctuation">.</span><span class="token function">addRequired</span><span class="token punctuation">(</span>user1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token class-name">User2</span> user2<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">User2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user2<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"李四"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user2Service<span class="token punctuation">.</span><span class="token function">addRequired</span><span class="token punctuation">(</span>user2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>验证方法 2：</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">notransaction_required_required_exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token class-name">User1</span> user1<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">User1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user1<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"张三"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user1Service<span class="token punctuation">.</span><span class="token function">addRequired</span><span class="token punctuation">(</span>user1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token class-name">User2</span> user2<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">User2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user2<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"李四"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user2Service<span class="token punctuation">.</span><span class="token function">addRequiredException</span><span class="token punctuation">(</span>user2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>分别执行验证方法，结果：</p>
<table>
<thead>
<tr>
<th>验证方法序号</th>
<th>数据库结果</th>
<th>结果分析</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>“张三”、“李四” 均插入。</td>
<td>外围方法未开启事务，插入 “张三”、“李四” 方法在自己的事务中独立运行，外围方法异常不影响内部插入 “张三”、“李四” 方法独立的事务。</td>
</tr>
<tr>
<td>2</td>
<td>“张三” 插入，“李四” 未插入。</td>
<td>外围方法没有事务，插入 “张三”、“李四” 方法都在自己的事务中独立运行，所以插入 “李四” 方法抛出异常只会回滚插入 “李四” 方法，插入 “张三” 方法不受影响。</td>
</tr>
</tbody>
</table>
<p><strong>结论：通过这两个方法我们证明了在外围方法未开启事务的情况下 <code>Propagation.REQUIRED</code>  修饰的内部方法会新开启自己的事务，且开启的事务相互独立，互不干扰。</strong></p>
<h3 id="12-场景二"><a class="markdownIt-Anchor" href="#12-场景二">#</a> 1.2 场景二</h3>
<p>外围方法开启事务，这个是使用率比较高的场景。</p>
<p><strong>验证方法 1：</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
 <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>propagation <span class="token operator">=</span> <span class="token class-name">Propagation</span><span class="token punctuation">.</span>REQUIRED<span class="token punctuation">)</span>
 <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">transaction_exception_required_required</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
     <span class="token class-name">User1</span> user1<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">User1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     user1<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"张三"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     user1Service<span class="token punctuation">.</span><span class="token function">addRequired</span><span class="token punctuation">(</span>user1<span class="token punctuation">)</span><span class="token punctuation">;</span>
     
     <span class="token class-name">User2</span> user2<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">User2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     user2<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"李四"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     user2Service<span class="token punctuation">.</span><span class="token function">addRequired</span><span class="token punctuation">(</span>user2<span class="token punctuation">)</span><span class="token punctuation">;</span>
     
     <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>验证方法 2：</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>propagation <span class="token operator">=</span> <span class="token class-name">Propagation</span><span class="token punctuation">.</span>REQUIRED<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">transaction_required_required_exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token class-name">User1</span> user1<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">User1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user1<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"张三"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user1Service<span class="token punctuation">.</span><span class="token function">addRequired</span><span class="token punctuation">(</span>user1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token class-name">User2</span> user2<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">User2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user2<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"李四"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user2Service<span class="token punctuation">.</span><span class="token function">addRequiredException</span><span class="token punctuation">(</span>user2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>验证方法 3：</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Transactional</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">transaction_required_required_exception_try</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token class-name">User1</span> user1<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">User1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user1<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"张三"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user1Service<span class="token punctuation">.</span><span class="token function">addRequired</span><span class="token punctuation">(</span>user1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token class-name">User2</span> user2<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">User2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user2<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"李四"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        user2Service<span class="token punctuation">.</span><span class="token function">addRequiredException</span><span class="token punctuation">(</span>user2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"方法回滚"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>分别执行验证方法，结果：</p>
<table>
<thead>
<tr>
<th>验证方法序号</th>
<th>数据库结果</th>
<th>结果分析</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>“张三”、“李四” 均未插入。</td>
<td>外围方法开启事务，内部方法加入外围方法事务，外围方法回滚，内部方法也要回滚。</td>
</tr>
<tr>
<td>2</td>
<td>“张三”、“李四” 均未插入。</td>
<td>外围方法开启事务，内部方法加入外围方法事务，内部方法抛出异常回滚，外围方法感知异常致使整体事务回滚。</td>
</tr>
<tr>
<td>3</td>
<td>“张三”、“李四” 均未插入。</td>
<td>外围方法开启事务，内部方法加入外围方法事务，<strong>内部方法抛出异常回滚，即使方法被 catch 不被外围方法感知，整个事务依然回滚。</strong>⭐️</td>
</tr>
</tbody>
</table>
<p><strong>结论：以上试验结果我们证明在外围方法开启事务的情况下 <code>Propagation.REQUIRED</code>  修饰的内部方法会加入到外围方法的事务中，所有 <code>Propagation.REQUIRED</code>  修饰的内部方法和外围方法均属于同一事务，只要一个方法回滚，整个事务均回滚。</strong></p>
<h2 id="2propagation_requires_new"><a class="markdownIt-Anchor" href="#2propagation_requires_new">#</a> 2.PROPAGATION_REQUIRES_NEW</h2>
<p>我们为 User1Service 和 User2Service 相应方法加上 <code>Propagation.REQUIRES_NEW</code>  属性。<br>
<strong>User1Service 方法：</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User1ServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">User1Service</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//省略其他...</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>propagation <span class="token operator">=</span> <span class="token class-name">Propagation</span><span class="token punctuation">.</span>REQUIRES_NEW<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addRequiresNew</span><span class="token punctuation">(</span><span class="token class-name">User1</span> user<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        user1Mapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>propagation <span class="token operator">=</span> <span class="token class-name">Propagation</span><span class="token punctuation">.</span>REQUIRED<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addRequired</span><span class="token punctuation">(</span><span class="token class-name">User1</span> user<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        user1Mapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>User2Service 方法：</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User2ServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">User2Service</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//省略其他...</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>propagation <span class="token operator">=</span> <span class="token class-name">Propagation</span><span class="token punctuation">.</span>REQUIRES_NEW<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addRequiresNew</span><span class="token punctuation">(</span><span class="token class-name">User2</span> user<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        user2Mapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>propagation <span class="token operator">=</span> <span class="token class-name">Propagation</span><span class="token punctuation">.</span>REQUIRES_NEW<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addRequiresNewException</span><span class="token punctuation">(</span><span class="token class-name">User2</span> user<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        user2Mapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="21-场景一"><a class="markdownIt-Anchor" href="#21-场景一">#</a> 2.1 场景一</h3>
<p>外围方法没有开启事务。</p>
<p><strong>验证方法 1：</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">notransaction_exception_requiresNew_requiresNew</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token class-name">User1</span> user1<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">User1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user1<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"张三"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user1Service<span class="token punctuation">.</span><span class="token function">addRequiresNew</span><span class="token punctuation">(</span>user1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token class-name">User2</span> user2<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">User2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user2<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"李四"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user2Service<span class="token punctuation">.</span><span class="token function">addRequiresNew</span><span class="token punctuation">(</span>user2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>验证方法 2：</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">notransaction_requiresNew_requiresNew_exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token class-name">User1</span> user1<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">User1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user1<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"张三"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user1Service<span class="token punctuation">.</span><span class="token function">addRequiresNew</span><span class="token punctuation">(</span>user1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token class-name">User2</span> user2<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">User2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user2<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"李四"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user2Service<span class="token punctuation">.</span><span class="token function">addRequiresNewException</span><span class="token punctuation">(</span>user2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>分别执行验证方法，结果：</p>
<table>
<thead>
<tr>
<th>验证方法序号</th>
<th>数据库结果</th>
<th>结果分析</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>“张三” 插入，“李四” 插入。</td>
<td>外围方法没有事务，插入 “张三”、“李四” 方法都在自己的事务中独立运行，外围方法抛出异常回滚不会影响内部方法。</td>
</tr>
<tr>
<td>2</td>
<td>“张三” 插入，“李四” 未插入</td>
<td>外围方法没有开启事务，插入 “张三” 方法和插入 “李四” 方法分别开启自己的事务，插入 “李四” 方法抛出异常回滚，其他事务不受影响。</td>
</tr>
</tbody>
</table>
<p><strong>结论：通过这两个方法我们证明了在外围方法未开启事务的情况下 <code>Propagation.REQUIRES_NEW</code>  修饰的内部方法会新开启自己的事务，且开启的事务相互独立，互不干扰。</strong></p>
<h3 id="22-场景二"><a class="markdownIt-Anchor" href="#22-场景二">#</a> 2.2 场景二</h3>
<p>外围方法开启事务。</p>
<p><strong>验证方法 1：</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>propagation <span class="token operator">=</span> <span class="token class-name">Propagation</span><span class="token punctuation">.</span>REQUIRED<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">transaction_exception_required_requiresNew_requiresNew</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token class-name">User1</span> user1<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">User1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user1<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"张三"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user1Service<span class="token punctuation">.</span><span class="token function">addRequired</span><span class="token punctuation">(</span>user1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token class-name">User2</span> user2<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">User2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user2<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"李四"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user2Service<span class="token punctuation">.</span><span class="token function">addRequiresNew</span><span class="token punctuation">(</span>user2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token class-name">User2</span> user3<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">User2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user3<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"王五"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user2Service<span class="token punctuation">.</span><span class="token function">addRequiresNew</span><span class="token punctuation">(</span>user3<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>验证方法 2：</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>propagation <span class="token operator">=</span> <span class="token class-name">Propagation</span><span class="token punctuation">.</span>REQUIRED<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">transaction_required_requiresNew_requiresNew_exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token class-name">User1</span> user1<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">User1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user1<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"张三"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user1Service<span class="token punctuation">.</span><span class="token function">addRequired</span><span class="token punctuation">(</span>user1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token class-name">User2</span> user2<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">User2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user2<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"李四"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user2Service<span class="token punctuation">.</span><span class="token function">addRequiresNew</span><span class="token punctuation">(</span>user2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token class-name">User2</span> user3<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">User2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user3<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"王五"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user2Service<span class="token punctuation">.</span><span class="token function">addRequiresNewException</span><span class="token punctuation">(</span>user3<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>验证方法 3：</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>propagation <span class="token operator">=</span> <span class="token class-name">Propagation</span><span class="token punctuation">.</span>REQUIRED<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">transaction_required_requiresNew_requiresNew_exception_try</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token class-name">User1</span> user1<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">User1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user1<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"张三"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user1Service<span class="token punctuation">.</span><span class="token function">addRequired</span><span class="token punctuation">(</span>user1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token class-name">User2</span> user2<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">User2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user2<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"李四"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user2Service<span class="token punctuation">.</span><span class="token function">addRequiresNew</span><span class="token punctuation">(</span>user2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">User2</span> user3<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">User2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user3<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"王五"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        user2Service<span class="token punctuation">.</span><span class="token function">addRequiresNewException</span><span class="token punctuation">(</span>user3<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"回滚"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>分别执行验证方法，结果：</p>
<table>
<thead>
<tr>
<th>验证方法序号</th>
<th>数据库结果</th>
<th>结果分析</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>“张三” 未插入，“李四” 插入，“王五” 插入。</td>
<td>外围方法开启事务，插入 “张三” 方法和外围方法一个事务，插入 “李四” 方法、插入 “王五” 方法分别在独立的新建事务中，外围方法抛出异常只回滚和外围方法同一事务的方法，故插入 “张三” 的方法回滚。</td>
</tr>
<tr>
<td>2</td>
<td>“张三” 未插入，“李四” 插入，“王五” 未插入。</td>
<td>外围方法开启事务，插入 “张三” 方法和外围方法一个事务，插入 “李四” 方法、插入 “王五” 方法分别在独立的新建事务中。插入 “王五” 方法抛出异常，首先插入 “王五” 方法的事务被回滚，异常继续抛出被外围方法感知，外围方法事务亦被回滚，故插入 “张三” 方法也被回滚。</td>
</tr>
<tr>
<td>3</td>
<td>“张三” 插入，“李四” 插入，“王五” 未插入。</td>
<td>外围方法开启事务，插入 “张三” 方法和外围方法一个事务，插入 “李四” 方法、插入 “王五” 方法分别在独立的新建事务中。插入 “王五” 方法抛出异常，首先插入 “王五” 方法的事务被回滚，异常被 catch 不会被外围方法感知，外围方法事务不回滚，故插入 “张三” 方法插入成功。</td>
</tr>
</tbody>
</table>
<p><strong>结论：在外围方法开启事务的情况下 <code>Propagation.REQUIRES_NEW</code>  修饰的内部方法依然会单独开启独立事务，且与外部方法事务也独立，内部方法之间、内部方法和外部方法事务均相互独立，互不干扰。</strong></p>
<h2 id="3propagation_nested"><a class="markdownIt-Anchor" href="#3propagation_nested">#</a> 3.PROPAGATION_NESTED</h2>
<p>我们为 User1Service 和 User2Service 相应方法加上 <code>Propagation.NESTED</code>  属性。<br>
<strong>User1Service 方法：</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User1ServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">User1Service</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//省略其他...</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>propagation <span class="token operator">=</span> <span class="token class-name">Propagation</span><span class="token punctuation">.</span>NESTED<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addNested</span><span class="token punctuation">(</span><span class="token class-name">User1</span> user<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        user1Mapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>User2Service 方法：</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User2ServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">User2Service</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//省略其他...</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>propagation <span class="token operator">=</span> <span class="token class-name">Propagation</span><span class="token punctuation">.</span>NESTED<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addNested</span><span class="token punctuation">(</span><span class="token class-name">User2</span> user<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        user2Mapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>propagation <span class="token operator">=</span> <span class="token class-name">Propagation</span><span class="token punctuation">.</span>NESTED<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addNestedException</span><span class="token punctuation">(</span><span class="token class-name">User2</span> user<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        user2Mapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="31-场景一"><a class="markdownIt-Anchor" href="#31-场景一">#</a> 3.1 场景一</h3>
<p>此场景外围方法没有开启事务。</p>
<p><strong>验证方法 1：</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">notransaction_exception_nested_nested</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token class-name">User1</span> user1<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">User1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user1<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"张三"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user1Service<span class="token punctuation">.</span><span class="token function">addNested</span><span class="token punctuation">(</span>user1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token class-name">User2</span> user2<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">User2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user2<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"李四"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user2Service<span class="token punctuation">.</span><span class="token function">addNested</span><span class="token punctuation">(</span>user2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>验证方法 2：</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">notransaction_nested_nested_exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token class-name">User1</span> user1<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">User1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user1<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"张三"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user1Service<span class="token punctuation">.</span><span class="token function">addNested</span><span class="token punctuation">(</span>user1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token class-name">User2</span> user2<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">User2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user2<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"李四"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user2Service<span class="token punctuation">.</span><span class="token function">addNestedException</span><span class="token punctuation">(</span>user2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>分别执行验证方法，结果：</p>
<table>
<thead>
<tr>
<th>验证方法序号</th>
<th>数据库结果</th>
<th>结果分析</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>“张三”、“李四” 均插入。</td>
<td>外围方法未开启事务，插入 “张三”、“李四” 方法在自己的事务中独立运行，外围方法异常不影响内部插入 “张三”、“李四” 方法独立的事务。</td>
</tr>
<tr>
<td>2</td>
<td>“张三” 插入，“李四” 未插入。</td>
<td>外围方法没有事务，插入 “张三”、“李四” 方法都在自己的事务中独立运行，所以插入 “李四” 方法抛出异常只会回滚插入 “李四” 方法，插入 “张三” 方法不受影响。</td>
</tr>
</tbody>
</table>
<p><strong>结论：通过这两个方法我们证明了在外围方法未开启事务的情况下 <code>Propagation.NESTED</code>  和 <code>Propagation.REQUIRED</code>  作用相同，修饰的内部方法都会新开启自己的事务，且开启的事务相互独立，互不干扰。</strong></p>
<h3 id="32-场景二"><a class="markdownIt-Anchor" href="#32-场景二">#</a> 3.2 场景二</h3>
<p>外围方法开启事务。</p>
<p><strong>验证方法 1：</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Transactional</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">transaction_exception_nested_nested</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token class-name">User1</span> user1<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">User1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user1<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"张三"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user1Service<span class="token punctuation">.</span><span class="token function">addNested</span><span class="token punctuation">(</span>user1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token class-name">User2</span> user2<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">User2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user2<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"李四"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user2Service<span class="token punctuation">.</span><span class="token function">addNested</span><span class="token punctuation">(</span>user2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>验证方法 2：</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Transactional</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">transaction_nested_nested_exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token class-name">User1</span> user1<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">User1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user1<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"张三"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user1Service<span class="token punctuation">.</span><span class="token function">addNested</span><span class="token punctuation">(</span>user1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token class-name">User2</span> user2<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">User2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user2<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"李四"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user2Service<span class="token punctuation">.</span><span class="token function">addNestedException</span><span class="token punctuation">(</span>user2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>验证方法 3：</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Transactional</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">transaction_nested_nested_exception_try</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token class-name">User1</span> user1<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">User1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user1<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"张三"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user1Service<span class="token punctuation">.</span><span class="token function">addNested</span><span class="token punctuation">(</span>user1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token class-name">User2</span> user2<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">User2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user2<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"李四"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        user2Service<span class="token punctuation">.</span><span class="token function">addNestedException</span><span class="token punctuation">(</span>user2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"方法回滚"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>分别执行验证方法，结果：</p>
<table>
<thead>
<tr>
<th>验证方法序号</th>
<th>数据库结果</th>
<th>结果分析</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>“张三”、“李四” 均未插入。</td>
<td>外围方法开启事务，内部事务为外围事务的子事务，外围方法回滚，内部方法也要回滚。</td>
</tr>
<tr>
<td>2</td>
<td>“张三”、“李四” 均未插入。</td>
<td>外围方法开启事务，内部事务为外围事务的子事务，内部方法抛出异常回滚，且外围方法感知异常致使整体事务回滚。</td>
</tr>
<tr>
<td>3</td>
<td>“张三” 插入、“李四” 未插入。</td>
<td>外围方法开启事务，内部事务为外围事务的子事务，插入 “李四” 内部方法抛出异常，可以单独对子事务回滚。</td>
</tr>
</tbody>
</table>
<p><strong>结论：以上试验结果我们证明在外围方法开启事务的情况下 <code>Propagation.NESTED</code>  修饰的内部方法属于外部事务的子事务，外围主事务回滚，子事务一定回滚，而内部子事务可以单独回滚而不影响外围主事务和其他子事务</strong></p>
<h2 id="4-requiredrequires_newnested异同"><a class="markdownIt-Anchor" href="#4-requiredrequires_newnested异同">#</a> 4. REQUIRED,REQUIRES_NEW,NESTED 异同</h2>
<p>由 “1.2 场景二” 和 “3.2 场景二” 对比，我们可知：<br>
<strong>NESTED 和 REQUIRED 修饰的内部方法都属于外围方法事务，如果外围方法抛出异常，这两种方法的事务都会被回滚。但是 REQUIRED 是加入外围方法事务，所以和外围事务同属于一个事务，一旦 REQUIRED 事务抛出异常被回滚，外围方法事务也将被回滚。而 NESTED 是外围方法的子事务，有单独的保存点，所以 NESTED 方法抛出异常被回滚，不会影响到外围方法的事务。</strong></p>
<p>由 “2.2 场景二” 和 “3.2 场景二” 对比，我们可知：<br>
<strong>NESTED 和 REQUIRES_NEW 都可以做到内部方法事务回滚而不影响外围方法事务。但是因为 NESTED 是嵌套事务，所以外围方法回滚之后，作为外围方法事务的子事务也会被回滚。而 REQUIRES_NEW 是通过开启新的事务实现的，内部事务和外围事务是两个事务，外围事务回滚不会影响内部事务。</strong></p>
<h2 id="5-其他事务传播行为"><a class="markdownIt-Anchor" href="#5-其他事务传播行为">#</a> 5. 其他事务传播行为</h2>
<p>鉴于文章篇幅问题，其他事务传播行为的测试就不在此一一描述了，感兴趣的读者可以去源码中自己寻找相应测试代码和结果解释。传送门：<a target="_blank" rel="noopener" href="https://link.segmentfault.com/?enc=iH7K3m0wrmsar5nlvOjuHA%3D%3D.3Yh17qMPp8uSbhLtwukBwVeQTf%2FBzHAB1A7AfVgpYsf5SwpHyDyImcng%2FbgbxBIg">https://github.com/TmTse/tran…</a></p>
<h1 id="模拟用例"><a class="markdownIt-Anchor" href="#模拟用例">#</a> 模拟用例</h1>
<p>介绍了这么多事务传播行为，我们在实际工作中如何应用呢？下面我来举一个示例：</p>
<p>假设我们有一个注册的方法，方法中调用添加积分的方法，如果我们希望添加积分不会影响注册流程（即添加积分执行失败回滚不能使注册方法也回滚），我们会这样写：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">UserService</span> <span class="token punctuation">&#123;</span>
     
     <span class="token annotation punctuation">@Transactional</span>
     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                
         <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
             membershipPointService<span class="token punctuation">.</span><span class="token function">addPoint</span><span class="token punctuation">(</span><span class="token class-name">Point</span> point<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//省略...</span>
         <span class="token punctuation">&#125;</span>
         <span class="token comment">//省略...</span>
     <span class="token punctuation">&#125;</span>
     <span class="token comment">//省略...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们还规定注册失败要影响 <code>addPoint()</code>  方法（注册方法回滚添加积分方法也需要回滚），那么 <code>addPoint()</code>  方法就需要这样实现：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MembershipPointServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">MembershipPointService</span><span class="token punctuation">&#123;</span>
     
     <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>propagation <span class="token operator">=</span> <span class="token class-name">Propagation</span><span class="token punctuation">.</span>NESTED<span class="token punctuation">)</span>
     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addPoint</span><span class="token punctuation">(</span><span class="token class-name">Point</span> point<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                
         <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
             recordService<span class="token punctuation">.</span><span class="token function">addRecord</span><span class="token punctuation">(</span><span class="token class-name">Record</span> <span class="token keyword">record</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//省略...</span>
         <span class="token punctuation">&#125;</span>
         <span class="token comment">//省略...</span>
     <span class="token punctuation">&#125;</span>
     <span class="token comment">//省略...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们注意到了在 <code>addPoint()</code>  中还调用了 <code>addRecord()</code>  方法，这个方法用来记录日志。他的实现如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RecordServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">RecordService</span><span class="token punctuation">&#123;</span>
     
     <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>propagation <span class="token operator">=</span> <span class="token class-name">Propagation</span><span class="token punctuation">.</span>NOT_SUPPORTED<span class="token punctuation">)</span>
     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addRecord</span><span class="token punctuation">(</span><span class="token class-name">Record</span> <span class="token keyword">record</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                
        
         <span class="token comment">//省略...</span>
     <span class="token punctuation">&#125;</span>
     <span class="token comment">//省略...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们注意到 <code>addRecord()</code>  方法中 <code>propagation = Propagation.NOT_SUPPORTED</code> ，因为对于日志无所谓精确，可以多一条也可以少一条，所以 <code>addRecord()</code>  方法本身和外围 <code>addPoint()</code>  方法抛出异常都不会使 <code>addRecord()</code>  方法回滚，并且 <code>addRecord()</code>  方法抛出异常也不会影响外围 <code>addPoint()</code>  方法的执行。</p>
<p>通过这个例子相信大家对事务传播行为的使用有了更加直观的认识，通过各种属性的组合确实能让我们的业务实现更加灵活多样。</p>
<hr>
<h1 id="六-spring5新特性"><a class="markdownIt-Anchor" href="#六-spring5新特性">#</a> 六、Spring5 新特性</h1>
<h4 id="1-自带了日志封装"><a class="markdownIt-Anchor" href="#1-自带了日志封装">#</a> 1. 自带了日志封装</h4>
<ul>
<li>Spring5 移除了 Log4jConfigListener，官方建议使用 Log4j2</li>
</ul>
<p>Spring5 整合 Log4j2：</p>
<p>第一步：引入 jar 包</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/20210807143733.png" alt=""></p>
<p>第二步：创建 log4j2.xml 配置文件</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span>
<span class="token comment">&lt;!--日志级别以及优先级排序: OFF > FATAL > ERROR > WARN > INFO > DEBUG > TRACE > ALL --></span>
<span class="token comment">&lt;!--Configuration后面的status用于设置log4j2自身内部的信息输出，可以不设置，当设置成trace时，可以看到log4j2内部各种详细输出--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span> <span class="token attr-name">status</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>INFO<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token comment">&lt;!--先定义所有的appender--></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appenders</span><span class="token punctuation">></span></span>
        <span class="token comment">&lt;!--输出日志信息到控制台--></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>console</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Console<span class="token punctuation">"</span></span> <span class="token attr-name">target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>SYSTEM_OUT<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
            <span class="token comment">&lt;!--控制日志输出的格式--></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PatternLayout</span> <span class="token attr-name">pattern</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%t] %-5level %logger&#123;36&#125; - %msg%n<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>console</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>appenders</span><span class="token punctuation">></span></span>
    <span class="token comment">&lt;!--然后定义logger，只有定义了logger并引入的appender，appender才会生效--></span>
    <span class="token comment">&lt;!--root：用于指定项目的根日志，如果没有单独指定Logger，则会使用root作为默认的日志输出--></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>loggers</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>root</span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>info<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender-ref</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Console<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>root</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>loggers</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="2-nullable注解"><a class="markdownIt-Anchor" href="#2-nullable注解">#</a> 2. @Nullable 注解</h4>
<p>@Nullable 注解可以用在方法上，属性上，参数上，表示方法返回值可以为空，属性可以为空，参数可以为空。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Nullable</span>     <span class="token comment">//表示方法返回值可以为空</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Nullable</span>     <span class="token comment">//表示参数可以为空</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setId</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token keyword">int</span> <span class="token class-name">Id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Nullable</span>     <span class="token comment">//表示属性可以为空</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> id<span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="3-支持函数式风格编程"><a class="markdownIt-Anchor" href="#3-支持函数式风格编程">#</a> 3. 支持函数式风格编程</h4>
<p>这是因为 java8 新增了 lamda 表达式</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//1 创建 GenericApplicationContext 对象</span>
    <span class="token class-name">GenericApplicationContext</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GenericApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//2 调用 context 的方法对象注册</span>
    context<span class="token punctuation">.</span><span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    context<span class="token punctuation">.</span><span class="token function">registerBean</span><span class="token punctuation">(</span><span class="token string">"user1"</span><span class="token punctuation">,</span><span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//3 获取在 spring 注册的对象</span>
    <span class="token comment">// User user = (User)context.getBean("com.atguigu.spring5.test.User");</span>
    <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">)</span>context<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">"user1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="4-支持整合junit5"><a class="markdownIt-Anchor" href="#4-支持整合junit5">#</a> 4. 支持整合 JUnit5</h4>
<p>（1）整合 JUnit4：</p>
<p>第一步：引入 jar 包</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/20210807181007.png" alt=""></p>
<p>第二步：创建测试类，使用注解方式完成</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringJUnit4ClassRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token comment">//单元测试框架</span>
<span class="token annotation punctuation">@ContextConfiguration</span><span class="token punctuation">(</span><span class="token string">"classpath:bean4.xml"</span><span class="token punctuation">)</span> <span class="token comment">//加载配置文件</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JUnitTest</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">public</span> <span class="token class-name">User</span> user<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>bean4.xml：</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">context:</span>component-scan</span> <span class="token attr-name">base-package</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.oymn<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">context:</span>component-scan</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>通过使用 @ContextConfiguration 注解，测试方法中就不用每次都通过 context 来获取对象了，比较方便。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">ApplicationContext</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathXmlApplicationContext</span><span class="token punctuation">(</span><span class="token string">"bean2.xml"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">BookService</span> bookService <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">"bookService"</span><span class="token punctuation">,</span><span class="token class-name">BookService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>（2）整合 JUnit5：</p>
<p><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/main/notes-img/20210807212941.png" alt=""></p>
<h4 id="5-webflux"><a class="markdownIt-Anchor" href="#5-webflux">#</a> 5. Webflux</h4>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Harry Qu</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://harryqu1229.github.io/2022/03/24/Spring/">https://harryqu1229.github.io/2022/03/24/Spring/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/java/">java</a><a class="post-meta__tags" href="/tags/backend/">backend</a><a class="post-meta__tags" href="/tags/spring/">spring</a></div><div class="post_share"><div class="addthis_inline_share_toolbox"></div><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-621848f44e1c3724" async="async"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/03/24/springboot%E9%BB%91%E9%A9%AC/"><img class="prev-cover" src="https://w.wallhaven.cc/full/8o/wallhaven-8o6rmo.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">SpringBoot2 notes 黑马</div></div></a></div><div class="next-post pull-right"><a href="/2022/03/25/SpringBoot/"><img class="next-cover" src="https://raw.githubusercontent.com/HarryQu1229/image-host/9575054fd0f7d407d7b7d5343dfc530a06ed4104/notes-img/cat.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">My SpringBoot2 notes</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2022/02/26/SSM%E6%A1%86%E6%9E%B6%E7%9A%84%E6%95%B4%E5%90%88%E9%A1%B9%E7%9B%AE/" title="SSM combine"><img class="cover" src="https://w.wallhaven.cc/full/3z/wallhaven-3zgdd3.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-26</div><div class="title">SSM combine</div></div></a></div><div><a href="/2022/03/23/Spring(another%20note)/" title="Spring notes"><img class="cover" src="https://w.wallhaven.cc/full/28/wallhaven-28wymm.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-03-23</div><div class="title">Spring notes</div></div></a></div><div><a href="/2022/02/26/ssm,ssm%E6%95%B4%E5%90%88,springboot/" title="SSM + SpringBoot"><img class="cover" src="https://w.wallhaven.cc/full/q2/wallhaven-q257x7.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-26</div><div class="title">SSM + SpringBoot</div></div></a></div><div><a href="/2022/03/26/SpringMVC/" title="My SpringMVC notes"><img class="cover" src="https://w.wallhaven.cc/full/8o/wallhaven-8o6rmo.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-03-26</div><div class="title">My SpringMVC notes</div></div></a></div><div><a href="/2022/03/25/SpringBoot/" title="My SpringBoot2 notes"><img class="cover" src="https://raw.githubusercontent.com/HarryQu1229/image-host/9575054fd0f7d407d7b7d5343dfc530a06ed4104/notes-img/cat.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-03-25</div><div class="title">My SpringBoot2 notes</div></div></a></div><div><a href="/2022/03/26/SpringCloud/" title="My SpringCloud notes"><img class="cover" src="https://w.wallhaven.cc/full/72/wallhaven-72myve.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-03-26</div><div class="title">My SpringCloud notes</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comment</span></div><div id="comment-switch"><span class="first-comment">Disqus</span><span class="switch-btn"></span><span class="second-comment">Gitalk</span></div></div><div class="comment-wrap"><div><div id="disqus_thread"></div></div><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/6aca34ee52f40fe1b2d637474f90111e2c151939/notes-img/%E5%85%B6%E4%B8%AD%E5%8C%85%E6%8B%AC%E5%9B%BE%E7%89%87%EF%BC%9A%7B%7B%20pinTitle%20%7D%7D_m6kogp.jpeg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Harry Qu</div><div class="author-info__description">Software Engineering Student</div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">158</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">84</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">57</div></a></div></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/HarryQu1229"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://www.linkedin.com/in/harry-qu-a0a38220a" target="_blank" title="LinkedIn"><i class="fab fa-linkedin"></i></a><a class="social-icon" href="https://github.com/HarryQu1229" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:Harryqu666@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="weixin://dl/chat?harry666ya" target="_blank" title="Wechat"><i class="fab fa-weixin"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">be healthy, stay safe</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80-spring%E6%A1%86%E6%9E%B6%E6%A6%82%E8%BF%B0"><span class="toc-number">1.</span> <span class="toc-text"> 一、Spring 框架概述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C-ioc%E5%AE%B9%E5%99%A8"><span class="toc-number">2.</span> <span class="toc-text"> 二、IOC 容器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-ioc%E6%A6%82%E5%BF%B5%E5%92%8C%E5%8E%9F%E7%90%86"><span class="toc-number">2.1.</span> <span class="toc-text"> 1. IOC 概念和原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86%E8%AE%B2%E8%A7%A3"><span class="toc-number">2.1.1.</span> <span class="toc-text"> 原理讲解:</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-ioc%E6%93%8D%E4%BD%9Cbean%E7%AE%A1%E7%90%86%E5%9F%BA%E4%BA%8Exml"><span class="toc-number">2.2.</span> <span class="toc-text"> 2. IOC 操作 Bean 管理（基于 xml）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#xml%E5%AE%9E%E7%8E%B0bean%E7%AE%A1%E7%90%86"><span class="toc-number">2.2.1.</span> <span class="toc-text"> xml 实现 Bean 管理：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E5%9F%BA%E4%BA%8Exml%E6%96%B9%E5%BC%8F%E5%88%9B%E5%BB%BA%E5%AF%B9%E8%B1%A1"><span class="toc-number">2.2.1.1.</span> <span class="toc-text"> （1）基于 xml 方式创建对象：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E5%9F%BA%E4%BA%8Exml%E6%96%B9%E5%BC%8F%E6%B3%A8%E5%85%A5%E5%B1%9E%E6%80%A7"><span class="toc-number">2.2.1.2.</span> <span class="toc-text"> （2）基于 xml 方式注入属性：</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E7%A7%8D%E6%96%B9%E6%B3%95%E4%BD%BF%E7%94%A8set%E6%96%B9%E6%B3%95%E8%BF%9B%E8%A1%8C%E6%B3%A8%E5%85%A5"><span class="toc-number">2.2.1.2.1.</span> <span class="toc-text"> 第一种方法：使用 set 方法进行注入：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E7%A7%8D%E6%96%B9%E6%B3%95%E4%BD%BF%E7%94%A8%E6%9C%89%E5%8F%82%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%E8%BF%9B%E8%A1%8C%E6%B3%A8%E5%85%A5"><span class="toc-number">2.2.1.2.2.</span> <span class="toc-text"> 第二种方法：使用有参构造函数进行注入</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E7%A7%8D%E6%96%B9%E6%B3%95p%E5%90%8D%E7%A7%B0%E7%A9%BA%E9%97%B4%E6%B3%A8%E5%85%A5%E4%BA%86%E8%A7%A3%E5%8D%B3%E5%8F%AF"><span class="toc-number">2.2.1.2.3.</span> <span class="toc-text"> 第三种方法：p 名称空间注入（了解即可）</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3xml%E6%B3%A8%E5%85%A5%E5%85%B6%E4%BB%96%E5%B1%9E%E6%80%A7"><span class="toc-number">2.2.1.3.</span> <span class="toc-text"> （3）xml 注入其他属性</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#null%E5%80%BC"><span class="toc-number">2.2.1.3.1.</span> <span class="toc-text"> null 值</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B1%9E%E6%80%A7%E5%80%BC%E5%8C%85%E5%90%AB%E7%89%B9%E6%AE%8A%E7%AC%A6%E5%8F%B7"><span class="toc-number">2.2.1.3.2.</span> <span class="toc-text"> 属性值包含特殊符号</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B3%A8%E5%85%A5%E5%B1%9E%E6%80%A7%E5%A4%96%E9%83%A8bean"><span class="toc-number">2.2.1.3.3.</span> <span class="toc-text"> 注入属性 —— 外部 bean</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B3%A8%E5%85%A5%E5%B1%9E%E6%80%A7%E5%86%85%E9%83%A8bean"><span class="toc-number">2.2.1.3.4.</span> <span class="toc-text"> 注入属性 —— 内部 bean</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B3%A8%E5%85%A5%E5%B1%9E%E6%80%A7%E7%BA%A7%E8%81%94%E8%B5%8B%E5%80%BC"><span class="toc-number">2.2.1.3.5.</span> <span class="toc-text"> 注入属性 —— 级联赋值</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B3%A8%E5%85%A5%E9%9B%86%E5%90%88%E5%B1%9E%E6%80%A7%E6%95%B0%E7%BB%84listmap"><span class="toc-number">2.2.1.3.6.</span> <span class="toc-text"> 注入集合属性（数组，List，Map）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8A%8A%E9%9B%86%E5%90%88%E6%B3%A8%E5%85%A5%E9%83%A8%E5%88%86%E6%8F%90%E5%8F%96%E5%87%BA%E6%9D%A5"><span class="toc-number">2.2.1.3.7.</span> <span class="toc-text"> 把集合注入部分提取出来</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#factorybean"><span class="toc-number">2.2.1.3.8.</span> <span class="toc-text"> FactoryBean</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#bean%E7%9A%84%E4%BD%9C%E7%94%A8%E5%9F%9F"><span class="toc-number">2.2.2.</span> <span class="toc-text"> Bean 的作用域：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#bean%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-number">2.2.3.</span> <span class="toc-text"> Bean 的生命周期：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#xml%E8%87%AA%E5%8A%A8%E8%A3%85%E9%85%8D"><span class="toc-number">2.2.4.</span> <span class="toc-text"> xml 自动装配：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E5%A4%96%E9%83%A8%E5%B1%9E%E6%80%A7%E6%96%87%E4%BB%B6%E6%9D%A5%E6%93%8D%E4%BD%9Cbean"><span class="toc-number">2.2.5.</span> <span class="toc-text"> 通过外部属性文件来操作 bean：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-ioc%E6%93%8D%E4%BD%9Cbean%E7%AE%A1%E7%90%86%E5%9F%BA%E4%BA%8E%E6%B3%A8%E8%A7%A3"><span class="toc-number">2.3.</span> <span class="toc-text"> 3. IOC 操作 Bean 管理（基于注解）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E5%9F%BA%E4%BA%8E%E6%B3%A8%E8%A7%A3%E5%88%9B%E5%BB%BA%E5%AF%B9%E8%B1%A1"><span class="toc-number">2.3.1.</span> <span class="toc-text"> （1）基于注解创建对象：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E5%9F%BA%E4%BA%8E%E6%B3%A8%E8%A7%A3%E8%BF%9B%E8%A1%8C%E5%B1%9E%E6%80%A7%E6%B3%A8%E5%85%A5"><span class="toc-number">2.3.2.</span> <span class="toc-text"> （2）基于注解进行属性注入：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E5%AE%8C%E5%85%A8%E6%B3%A8%E8%A7%A3%E5%BC%80%E5%8F%91"><span class="toc-number">2.3.3.</span> <span class="toc-text"> （3）完全注解开发：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89-aop"><span class="toc-number">3.</span> <span class="toc-text"> 三、AOP</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%88%E8%AF%B4%E8%AF%B4%E9%9D%99%E6%80%81%E4%BB%A3%E7%90%86%E5%92%8C%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86"><span class="toc-number">3.1.</span> <span class="toc-text"> 先说说静态代理和动态代理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E4%BB%A3%E7%90%86"><span class="toc-number">3.1.1.</span> <span class="toc-text"> 静态代理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86"><span class="toc-number">3.1.2.</span> <span class="toc-text"> 动态代理:</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86"><span class="toc-number">3.2.</span> <span class="toc-text"> 1. 底层原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%9F%BA%E4%BA%8Easpectj%E5%AE%9E%E7%8E%B0aop%E6%93%8D%E4%BD%9C"><span class="toc-number">3.3.</span> <span class="toc-text"> 2. 基于 AspectJ 实现 AOP 操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E5%9F%BA%E4%BA%8E%E6%B3%A8%E8%A7%A3%E6%96%B9%E5%BC%8F"><span class="toc-number">3.3.1.</span> <span class="toc-text"> （1）基于注解方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E5%9F%BA%E4%BA%8Exml%E6%96%B9%E5%BC%8F"><span class="toc-number">3.3.2.</span> <span class="toc-text"> （2）基于 xml 方式</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%8E%E5%88%AB%E5%A4%84%E6%8B%BF%E6%9D%A5%E7%9A%84%E5%85%B3%E4%BA%8Eaop%E7%AC%94%E8%AE%B0"><span class="toc-number">4.</span> <span class="toc-text"> 从别处拿来的关于 AOP 笔记</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%A2%E5%90%91%E5%88%87%E9%9D%A2%E7%9A%84%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86"><span class="toc-number">4.1.</span> <span class="toc-text"> 面向切面的基本原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#spring-%E5%AF%B9-aop-%E7%9A%84%E6%94%AF%E6%8C%81"><span class="toc-number">4.2.</span> <span class="toc-text"> Spring 对 AOP 的支持</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%88%87%E7%82%B9%E9%80%89%E6%8B%A9%E8%BF%9E%E6%8E%A5%E7%82%B9"><span class="toc-number">4.3.</span> <span class="toc-text"> 使用切点选择连接点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%A8-xml-%E4%B8%AD%E5%A3%B0%E6%98%8E%E5%88%87%E9%9D%A2"><span class="toc-number">4.4.</span> <span class="toc-text"> 在 XML 中声明切面</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B-jdbctemplate"><span class="toc-number">5.</span> <span class="toc-text"> 四、JdbcTemplate</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%94-%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86"><span class="toc-number">6.</span> <span class="toc-text"> 五、事务管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E6%B3%A8%E8%A7%A3%E5%AE%9E%E7%8E%B0%E5%A3%B0%E6%98%8E%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86"><span class="toc-number">6.0.1.</span> <span class="toc-text"> （1）注解实现声明式事务管理：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2xml%E5%AE%9E%E7%8E%B0%E5%A3%B0%E6%98%8E%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86"><span class="toc-number">6.0.2.</span> <span class="toc-text"> （2）xml 实现声明式事务管理：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E4%BC%A0%E6%92%AD%E8%A1%8C%E4%B8%BA%E8%AF%B4%E6%98%8E%E7%99%BD"><span class="toc-number">7.</span> <span class="toc-text"> 事务传播行为说明白</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E4%BB%80%E4%B9%88%E6%98%AF%E4%BA%8B%E5%8A%A1%E4%BC%A0%E6%92%AD%E8%A1%8C%E4%B8%BA"><span class="toc-number">7.1.</span> <span class="toc-text"> 1. 什么是事务传播行为？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-spring%E4%B8%AD%E4%B8%83%E7%A7%8D%E4%BA%8B%E5%8A%A1%E4%BC%A0%E6%92%AD%E8%A1%8C%E4%B8%BA"><span class="toc-number">7.2.</span> <span class="toc-text"> 2. Spring 中七种事务传播行为</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E9%AA%8C%E8%AF%81"><span class="toc-number">8.</span> <span class="toc-text"> 代码验证</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1propagation_required"><span class="toc-number">8.1.</span> <span class="toc-text"> 1.PROPAGATION_REQUIRED</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#11-%E5%9C%BA%E6%99%AF%E4%B8%80"><span class="toc-number">8.1.1.</span> <span class="toc-text"> 1.1 场景一</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-%E5%9C%BA%E6%99%AF%E4%BA%8C"><span class="toc-number">8.1.2.</span> <span class="toc-text"> 1.2 场景二</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2propagation_requires_new"><span class="toc-number">8.2.</span> <span class="toc-text"> 2.PROPAGATION_REQUIRES_NEW</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#21-%E5%9C%BA%E6%99%AF%E4%B8%80"><span class="toc-number">8.2.1.</span> <span class="toc-text"> 2.1 场景一</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#22-%E5%9C%BA%E6%99%AF%E4%BA%8C"><span class="toc-number">8.2.2.</span> <span class="toc-text"> 2.2 场景二</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3propagation_nested"><span class="toc-number">8.3.</span> <span class="toc-text"> 3.PROPAGATION_NESTED</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#31-%E5%9C%BA%E6%99%AF%E4%B8%80"><span class="toc-number">8.3.1.</span> <span class="toc-text"> 3.1 场景一</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#32-%E5%9C%BA%E6%99%AF%E4%BA%8C"><span class="toc-number">8.3.2.</span> <span class="toc-text"> 3.2 场景二</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-requiredrequires_newnested%E5%BC%82%E5%90%8C"><span class="toc-number">8.4.</span> <span class="toc-text"> 4. REQUIRED,REQUIRES_NEW,NESTED 异同</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E5%85%B6%E4%BB%96%E4%BA%8B%E5%8A%A1%E4%BC%A0%E6%92%AD%E8%A1%8C%E4%B8%BA"><span class="toc-number">8.5.</span> <span class="toc-text"> 5. 其他事务传播行为</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A8%A1%E6%8B%9F%E7%94%A8%E4%BE%8B"><span class="toc-number">9.</span> <span class="toc-text"> 模拟用例</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AD-spring5%E6%96%B0%E7%89%B9%E6%80%A7"><span class="toc-number">10.</span> <span class="toc-text"> 六、Spring5 新特性</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E8%87%AA%E5%B8%A6%E4%BA%86%E6%97%A5%E5%BF%97%E5%B0%81%E8%A3%85"><span class="toc-number">10.0.0.1.</span> <span class="toc-text"> 1. 自带了日志封装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-nullable%E6%B3%A8%E8%A7%A3"><span class="toc-number">10.0.0.2.</span> <span class="toc-text"> 2. @Nullable 注解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E6%94%AF%E6%8C%81%E5%87%BD%E6%95%B0%E5%BC%8F%E9%A3%8E%E6%A0%BC%E7%BC%96%E7%A8%8B"><span class="toc-number">10.0.0.3.</span> <span class="toc-text"> 3. 支持函数式风格编程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E6%94%AF%E6%8C%81%E6%95%B4%E5%90%88junit5"><span class="toc-number">10.0.0.4.</span> <span class="toc-text"> 4. 支持整合 JUnit5</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-webflux"><span class="toc-number">10.0.0.5.</span> <span class="toc-text"> 5. Webflux</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-map"><div class="card-content"><div class="item-headline"><i class="fa fa-globe-asia" aria-hidden="true"></i><span>Visitor Map</span></div><script id="clstr_globe" type="text/javascript" defer="defer" src="//clustrmaps.com/globe.js?d=4LA950xi3DtQgUHPlkO0mo-n_QgrcOu-1BIiVpExg7k"></script></div></div><div class="card-widget card-pixiv"><div class="card-content"><div class="item-headline"><i class="fa fa-image" aria-hidden="true"></i><span>Pixiv Top50</span><iframe src="https://cloud.mokeyjay.com/pixiv" frameborder="0" style="width:99%;height:380px;margin:0;"></iframe></div></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/12/06/%E7%AE%97%E6%B3%95%E7%BB%88%E6%9E%81%E6%8C%87%E5%8D%97/" title="My ultimate data structure and algorithm guide"><img src="https://c.pxhere.com/photos/e5/15/watercolour_painting_technique_soluble_in_water_not_opaque_color_image_color_sketch_turquoise-1110070.jpg!d" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="My ultimate data structure and algorithm guide"/></a><div class="content"><a class="title" href="/2022/12/06/%E7%AE%97%E6%B3%95%E7%BB%88%E6%9E%81%E6%8C%87%E5%8D%97/" title="My ultimate data structure and algorithm guide">My ultimate data structure and algorithm guide</a><time datetime="2022-12-05T11:00:00.000Z" title="Created 2022-12-06 00:00:00">2022-12-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/08/27/HTML5%E4%B8%8ECSS3%E9%AB%98%E9%98%B6/" title="My HTML5 and CSS3 notes"><img src="https://w.wallhaven.cc/full/8o/wallhaven-8o6rmo.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="My HTML5 and CSS3 notes"/></a><div class="content"><a class="title" href="/2022/08/27/HTML5%E4%B8%8ECSS3%E9%AB%98%E9%98%B6/" title="My HTML5 and CSS3 notes">My HTML5 and CSS3 notes</a><time datetime="2022-08-26T12:00:00.000Z" title="Created 2022-08-27 00:00:00">2022-08-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/08/11/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E6%80%9D%E6%83%B3/" title="Object Orientated Programming"><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/ca78dff38e0bfb81a8e98ad64f749e97bcc55f14/notes-img/Billfish.yWAOuM.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Object Orientated Programming"/></a><div class="content"><a class="title" href="/2022/08/11/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E6%80%9D%E6%83%B3/" title="Object Orientated Programming">Object Orientated Programming</a><time datetime="2022-08-10T12:00:00.000Z" title="Created 2022-08-11 00:00:00">2022-08-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/06/12/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" title="Design Patterns"><img src="https://w.wallhaven.cc/full/q2/wallhaven-q2vzx5.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Design Patterns"/></a><div class="content"><a class="title" href="/2022/06/12/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" title="Design Patterns">Design Patterns</a><time datetime="2022-06-11T12:00:00.000Z" title="Created 2022-06-12 00:00:00">2022-06-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/06/11/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%20-%20%E5%91%BD%E4%BB%A4/" title="Design Patterns - Command"><img src="https://raw.githubusercontent.com/HarryQu1229/image-host/18bbc356ddf5fcd5544ddb91bb7b35a99ebfef25/notes-img/download%20(1).png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Design Patterns - Command"/></a><div class="content"><a class="title" href="/2022/06/11/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%20-%20%E5%91%BD%E4%BB%A4/" title="Design Patterns - Command">Design Patterns - Command</a><time datetime="2022-06-10T12:00:00.000Z" title="Created 2022-06-11 00:00:00">2022-06-11</time></div></div></div></div></div></div></main><footer id="footer" style="background: transparent"><div id="footer-wrap"><div class="copyright">&copy;2021 - 2022 By Harry Qu</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="Chat"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="Scroll To Comments"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Local search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>function loadDisqus () {
  var disqus_config = function () {
    this.page.url = 'https://harryqu1229.github.io/2022/03/24/Spring/'
    this.page.identifier = '2022/03/24/Spring/'
    this.page.title = 'My Spring notes'
  };

  window.disqusReset = () => {
    DISQUS.reset({
      reload: true,
      config: disqus_config
    })
  }

  if (window.DISQUS) disqusReset()
  else {
    (function() { 
      var d = document, s = d.createElement('script');
      s.src = 'https://harry-study-blog.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  }
}

if ('Disqus' === 'Disqus' || !false) {
  if (false) btf.loadComment(document.getElementById('disqus_thread'), loadDisqus)
  else loadDisqus()
} else {
  function loadOtherComment () {
    loadDisqus()
  }
}
</script><script>if (window.DISQUSWIDGETS === undefined) {
  var d = document, s = d.createElement('script');
  s.src = 'https://harry-study-blog.disqus.com/count.js';
  s.id = 'dsq-count-scr';
  (d.head || d.body).appendChild(s);
} else {
  DISQUSWIDGETS.getCount({reset: true});
}</script><script>function addGitalkSource () {
  const ele = document.createElement('link')
  ele.rel = 'stylesheet'
  ele.href= 'https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css'
  document.getElementsByTagName('head')[0].appendChild(ele)
}

function loadGitalk () {
  function initGitalk () {
    var gitalk = new Gitalk(Object.assign({
      clientID: '5df1e915e0fa867b50de',
      clientSecret: 'ce1cb793fe49078ee9d0102d3326d0d50ff6937b',
      repo: 'blog-comments-storage',
      owner: 'HarryQu1229',
      admin: ['HarryQu1229'],
      id: 'fb99db46c4392d43caf74b4b9218ff3a',
      updateCountCallback: commentCount
    },null))

    gitalk.render('gitalk-container')
  }

  if (typeof Gitalk === 'function') initGitalk()
  else {
    addGitalkSource()
    getScript('https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js').then(initGitalk)
  }
}

function commentCount(n){
  let isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
  if (isCommentCount) {
    isCommentCount.innerHTML= n
  }
}

if ('Disqus' === 'Gitalk' || !false) {
  if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
  else loadGitalk()
} else {
  function loadOtherComment () {
    loadGitalk()
  }
}</script></div><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[image]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[link]') // replace url
    content = content.replace(/<code>.*?<\/code>/gi, '[code]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getComment = () => {
    fetch('https://disqus.com/api/3.0/forums/listPosts.json?forum=harry-study-blog&related=thread&limit=6&api_key=B5XFmdGuVaYDW7OIBakffpXoKorvphwRiwONIol4puEtr8YiwYAMAk2K7QcExNLY')
      .then(response => response.json())
      .then(data => {
        const disqusArray = data.response.map(item => {
          return {
            'avatar': item.author.avatar.cache,
            'content': changeContent(item.message),
            'nick': item.author.name,
            'url': item.url,
            'date': item.createdAt
          }
        })

        saveToLocal.set('disqus-newest-comments', JSON.stringify(disqusArray), 10/(60*24))
        generateHtml(disqusArray)
      }).catch(e => {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.innerHTML= "Unable to get the data, please make sure the settings are correct."
      })
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }
        
        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick}</span><time> / ${btf.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += 'No Comment'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom.innerHTML= result
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('disqus-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><div class="aplayer no-destroy" data-id="2809513713" data-server="netease" data-type="playlist" data-autoplay="false" data-fixed="true" data-order="random" data-theme="#e9ccd3"> </div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/fireworks.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script>((window.gitter = {}).chat = {}).options = {
  disableDefaultChat: true,
};
document.addEventListener('gitter-sidecar-ready', (e) => {
  const GitterChat = e.detail.Chat
  let chat

  function initGitter () {
    chat = new GitterChat({
      room: 'HarryStudyBlog/community',
      activationElement: '#chat_btn'
    });
  }

  initGitter()

  if (true) {
    document.addEventListener('pjax:complete', () => {
      chat.destroy()
      initGitter()
    })
  }

})</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async="async" defer="defer"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/gh/metowolf/MetingJS@1.2/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --><script data-pjax>
  function butterfly_footer_beautify_injector_config(){
    var parent_div_git = document.getElementById('footer-wrap');
    var item_html = '<div id="workboard"></div><div id="ghbdages" style="overflow:hidden;max-height:90px;height:auto;text-align:center;margin-top:10px"><div class="swiper-wrapper"><div class="swiper-slide"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" title="博客框架为Hexo_v5.4.0"><img src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&amp;logo=hexo" alt=""/></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px" title="主题版本Butterfly_v3.8.2"><img src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&amp;logo=bitdefender" alt=""/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" title="本站项目由Github托管"><img src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&amp;logo=GitHub" alt=""/></a></div><div class="swiper-slide"><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" style="margin-inline:5px" title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"><img src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&amp;logo=Claris" alt=""/></a></div></div></div><style>a.github-badge:hover:before {display:none}</style>';
    console.log('已挂载butterfly_footer_beautify')
    parent_div_git.insertAdjacentHTML("beforeend",item_html)
    }
  var elist = 'undefined'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_footer_beautify_injector_config();
  }
  else if (epage === cpage){
    butterfly_footer_beautify_injector_config();
  }
  </script><script async src="/js/footer-beautify-runtime.js"></script><script defer src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.js"></script><script defer data-pjax src="https://npm.elemecdn.com/hexo-butterfly-footer-beautify/lib/swiperbdage_init.min.js"></script><script data-pjax src="https://npm.elemecdn.com/hexo-filter-gitcalendar/lib/gitcalendar.js"></script><script data-pjax>
  function gitcalendar_injector_config(){
      var parent_div_git = document.getElementById('recent-posts');
      var item_html = '<div class="recent-post-item" style="width:100%;height:auto;padding:10px;"><style>#git_container{min-height: 280px}@media screen and (max-width:650px) {#git_container{min-height: 0px}}</style><div id="git_loading" style="width:10%;height:100%;margin:0 auto;display: block;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 50 50" style="enable-background:new 0 0 50 50" xml:space="preserve"><path fill="#d0d0d0" d="M25.251,6.461c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615V6.461z" transform="rotate(275.098 25 25)"><animatetransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"></animatetransform></path></svg><style>#git_container{display: none;}</style></div><div id="git_container"></div></div>';
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
      console.log('已挂载gitcalendar')
      }

    if( document.getElementById('recent-posts') && (location.pathname ==='/'|| '/' ==='all')){
        gitcalendar_injector_config()
        GitCalendarInit("https://gitcalendar.akilar.top/api?HarryQu1229",['#ebedf0', '#fdcdec', '#fc9bd9', '#fa6ac5', '#f838b2', '#f5089f', '#c4067e', '#92055e', '#540336', '#48022f', '#30021f'],'HarryQu1229')
    }
  </script><!-- hexo injector body_end end --><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"position":"right","width":300,"height":450},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html>